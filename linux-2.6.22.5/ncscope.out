cscope 15 /classes/ece391/linux-2.6.22.5               0000000000
	@Documentation/DocBook/procfs_example.c

46 
	~<löux/moduÀ.h
>

47 
	~<löux/kî√l.h
>

48 
	~<löux/öô.h
>

49 
	~<löux/¥oc_fs.h
>

50 
	~<löux/jiffõs.h
>

51 
	~<asm/uac˚ss.h
>

54 
	#MODULE_VERS
 "1.0"

	)

55 
	#MODULE_NAME
 "¥ocfs_exam∂e"

	)

57 
	#FOOBAR_LEN
 8

	)

59 
	sfb_d©a_t
 {

60 
	m«me
[
FOOBAR_LEN
 + 1];

61 
	mvÆue
[
FOOBAR_LEN
 + 1];

65 
¥oc_dú_íåy
 *
	gexam∂e_dú
, *
	gfoo_fûe
,

66 *
	gb¨_fûe
, *
	gjiffõs_fûe
, *
	gsymlök
;

69 
fb_d©a_t
 
	gfoo_d©a
, 
	gb¨_d©a
;

72 
	$¥oc_ªad_jiffõs
(*
∑ge
, **
°¨t
,

73 
off_t
 
off
, 
cou¡
,

74 *
eof
, *
d©a
)

76 
Àn
;

78 
Àn
 = 
	`•rötf
(
∑ge
, "jiffies = %ld\n",

79 
jiffõs
);

81  
Àn
;

82 
	}
}

85 
	$¥oc_ªad_foob¨
(*
∑ge
, **
°¨t
,

86 
off_t
 
off
, 
cou¡
,

87 *
eof
, *
d©a
)

89 
Àn
;

90 
fb_d©a_t
 *
fb_d©a
 = (fb_d©a_à*)
d©a
;

93 
Àn
 = 
	`•rötf
(
∑ge
, "%s = '%s'\n",

94 
fb_d©a
->
«me
, fb_d©a->
vÆue
);

96  
Àn
;

97 
	}
}

100 
	$¥oc_wrôe_foob¨
(
fûe
 *file,

101 c⁄° *
buf„r
,

102 
cou¡
,

103 *
d©a
)

105 
Àn
;

106 
fb_d©a_t
 *
fb_d©a
 = (fb_d©a_à*)
d©a
;

108 if(
cou¡
 > 
FOOBAR_LEN
)

109 
Àn
 = 
FOOBAR_LEN
;

111 
Àn
 = 
cou¡
;

113 if(
	`c›y_‰om_u£r
(
fb_d©a
->
vÆue
, 
buf„r
, 
Àn
))

114  -
EFAULT
;

116 
fb_d©a
->
vÆue
[
Àn
] = '\0';

118  
Àn
;

119 
	}
}

122 
__öô
 
	$öô_¥ocfs_exam∂e
()

124 
rv
 = 0;

127 
exam∂e_dú
 = 
	`¥oc_mkdú
(
MODULE_NAME
, 
NULL
);

128 if(
exam∂e_dú
 =
NULL
) {

129 
rv
 = -
ENOMEM
;

130 
out
;

133 
exam∂e_dú
->
ow√r
 = 
THIS_MODULE
;

136 
jiffõs_fûe
 = 
	`¸óã_¥oc_ªad_íåy
("jiffies",

137 0444, 
exam∂e_dú
,

138 
¥oc_ªad_jiffõs
,

139 
NULL
);

140 if(
jiffõs_fûe
 =
NULL
) {

141 
rv
 = -
ENOMEM
;

142 
no_jiffõs
;

145 
jiffõs_fûe
->
ow√r
 = 
THIS_MODULE
;

150 
foo_fûe
 = 
	`¸óã_¥oc_íåy
("foo", 0644, 
exam∂e_dú
);

151 if(
foo_fûe
 =
NULL
) {

152 
rv
 = -
ENOMEM
;

153 
no_foo
;

156 
	`°r˝y
(
foo_d©a
.
«me
, "foo");

157 
	`°r˝y
(
foo_d©a
.
vÆue
, "foo");

158 
foo_fûe
->
d©a
 = &
foo_d©a
;

159 
foo_fûe
->
ªad_¥oc
 = 
¥oc_ªad_foob¨
;

160 
foo_fûe
->
wrôe_¥oc
 = 
¥oc_wrôe_foob¨
;

161 
foo_fûe
->
ow√r
 = 
THIS_MODULE
;

163 
b¨_fûe
 = 
	`¸óã_¥oc_íåy
("b¨", 0644, 
exam∂e_dú
);

164 if(
b¨_fûe
 =
NULL
) {

165 
rv
 = -
ENOMEM
;

166 
no_b¨
;

169 
	`°r˝y
(
b¨_d©a
.
«me
, "bar");

170 
	`°r˝y
(
b¨_d©a
.
vÆue
, "bar");

171 
b¨_fûe
->
d©a
 = &
b¨_d©a
;

172 
b¨_fûe
->
ªad_¥oc
 = 
¥oc_ªad_foob¨
;

173 
b¨_fûe
->
wrôe_¥oc
 = 
¥oc_wrôe_foob¨
;

174 
b¨_fûe
->
ow√r
 = 
THIS_MODULE
;

177 
symlök
 = 
	`¥oc_symlök
("jiffõs_too", 
exam∂e_dú
,

179 if(
symlök
 =
NULL
) {

180 
rv
 = -
ENOMEM
;

181 
no_symlök
;

184 
symlök
->
ow√r
 = 
THIS_MODULE
;

187 
	`¥ötk
(
KERN_INFO
 "%s %s initialised\n",

188 
MODULE_NAME
, 
MODULE_VERS
);

191 
no_symlök
:

192 
	`ªmove_¥oc_íåy
("ây", 
exam∂e_dú
);

193 
no_ây
:

194 
	`ªmove_¥oc_íåy
("b¨", 
exam∂e_dú
);

195 
no_b¨
:

196 
	`ªmove_¥oc_íåy
("foo", 
exam∂e_dú
);

197 
no_foo
:

198 
	`ªmove_¥oc_íåy
("jiffõs", 
exam∂e_dú
);

199 
no_jiffõs
:

200 
	`ªmove_¥oc_íåy
(
MODULE_NAME
, 
NULL
);

201 
out
:

202  
rv
;

203 
	}
}

206 
__exô
 
	$˛ónup_¥ocfs_exam∂e
()

208 
	`ªmove_¥oc_íåy
("jiffõs_too", 
exam∂e_dú
);

209 
	`ªmove_¥oc_íåy
("ây", 
exam∂e_dú
);

210 
	`ªmove_¥oc_íåy
("b¨", 
exam∂e_dú
);

211 
	`ªmove_¥oc_íåy
("foo", 
exam∂e_dú
);

212 
	`ªmove_¥oc_íåy
("jiffõs", 
exam∂e_dú
);

213 
	`ªmove_¥oc_íåy
(
MODULE_NAME
, 
NULL
);

215 
	`¥ötk
(
KERN_INFO
 "%s %sÑemoved\n",

216 
MODULE_NAME
, 
MODULE_VERS
);

217 
	}
}

220 
moduÀ_öô
(
öô_¥ocfs_exam∂e
);

221 
moduÀ_exô
(
˛ónup_¥ocfs_exam∂e
);

223 
MODULE_AUTHOR
("Erik Mouw");

224 
MODULE_DESCRIPTION
("procfsÉxamples");

	@Documentation/accounting/getdelays.c

14 
	~<°dio.h
>

15 
	~<°dlib.h
>

16 
	~<î∫o.h
>

17 
	~<uni°d.h
>

18 
	~<pﬁl.h
>

19 
	~<°rög.h
>

20 
	~<f˙é.h
>

21 
	~<sys/ty≥s.h
>

22 
	~<sys/°©.h
>

23 
	~<sys/sockë.h
>

24 
	~<sys/ty≥s.h
>

25 
	~<sig«l.h
>

27 
	~<löux/gíëlök.h
>

28 
	~<löux/èsk°©s.h
>

35 
	#GENLMSG_DATA
(
glh
Ë((*)(
	`NLMSG_DATA
(glhË+ 
GENL_HDRLEN
))

	)

36 
	#GENLMSG_PAYLOAD
(
glh
Ë(
	`NLMSG_PAYLOAD
(glh, 0Ë- 
GENL_HDRLEN
)

	)

37 
	#NLA_DATA
(
«
Ë((*)((*)“aË+ 
NLA_HDRLEN
))

	)

38 
	#NLA_PAYLOAD
(
Àn
Ë÷í - 
NLA_HDRLEN
)

	)

40 
	#îr
(
code
, 
fmt
, 
¨g
...) \

42 
	`Ârötf
(
°dîr
, 
fmt
, ##
¨g
); \

43 
	`exô
(
code
); \

44 } 0)

	)

46 
	gd⁄e
;

47 
	grcvbufsz
;

48 
	g«me
[100];

49 
	gdbg
;

50 
	g¥öt_dñays
;

51 
	g¥öt_io_accou¡ög
;

52 
__u64
 
	g°ime
, 
	gutime
;

54 
	#PRINTF
(
fmt
, 
¨g
...) { \

55 i‡(
dbg
) { \

56 
	`¥ötf
(
fmt
, ##
¨g
); \

58 }

	)

61 
	#MAX_MSG_SIZE
 1024

	)

63 
	#MAX_CPUS
 32

	)

65 
	smsgãm∂©e
 {

66 
∆msghdr
 
	mn
;

67 
gílmsghdr
 
	mg
;

68 
	mbuf
[
MAX_MSG_SIZE
];

71 
	g˝umask
[100+6*
MAX_CPUS
];

73 
	$ußge
()

75 
	`Ârötf
(
°dîr
, "getdelays [-dilv] [-wÜogfile] [-r bufsize] "

77 
	`Ârötf
(
°dîr
, " -d:Örint delayacct stats\n");

78 
	`Ârötf
(
°dîr
, " -i:Örint IOáccounting (works only with -p)\n");

79 
	`Ârötf
(
°dîr
, " -l:Üisten forever\n");

80 
	`Ârötf
(
°dîr
, " -v: debug on\n");

81 
	}
}

86 
	$¸óã_∆_sockë
(
¥Ÿocﬁ
)

88 
fd
;

89 
sockaddr_∆
 
loˇl
;

91 
fd
 = 
	`sockë
(
AF_NETLINK
, 
SOCK_RAW
, 
¥Ÿocﬁ
);

92 i‡(
fd
 < 0)

95 i‡(
rcvbufsz
)

96 i‡(
	`£tsock›t
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
,

97 &
rcvbufsz
, (rcvbufsz)) < 0) {

98 
	`Ârötf
(
°dîr
, "UnableÅo set socketÑcv buf size "

100 
rcvbufsz
);

104 
	`mem£t
(&
loˇl
, 0, (local));

105 
loˇl
.
∆_Ámûy
 = 
AF_NETLINK
;

107 i‡(
	`böd
(
fd
, (
sockaddr
 *Ë&
loˇl
, (local)) < 0)

108 
îr‹
;

110  
fd
;

111 
îr‹
:

112 
	`˛o£
(
fd
);

114 
	}
}

117 
	$£nd_cmd
(
sd
, 
__u16
 
∆msg_ty≥
, 
__u32
 
∆msg_pid
,

118 
__u8
 
gíl_cmd
, 
__u16
 
∆a_ty≥
,

119 *
∆a_d©a
, 
∆a_Àn
)

121 
∆©å
 *
«
;

122 
sockaddr_∆
 
∆addr
;

123 
r
, 
buÊí
;

124 *
buf
;

126 
msgãm∂©e
 
msg
;

128 
msg
.
n
.
∆msg_Àn
 = 
	`NLMSG_LENGTH
(
GENL_HDRLEN
);

129 
msg
.
n
.
∆msg_ty≥
 =Çlmsg_type;

130 
msg
.
n
.
∆msg_Êags
 = 
NLM_F_REQUEST
;

131 
msg
.
n
.
∆msg_£q
 = 0;

132 
msg
.
n
.
∆msg_pid
 =Çlmsg_pid;

133 
msg
.
g
.
cmd
 = 
gíl_cmd
;

134 
msg
.
g
.
vîsi⁄
 = 0x1;

135 
«
 = (
∆©å
 *Ë
	`GENLMSG_DATA
(&
msg
);

136 
«
->
∆a_ty≥
 =Çla_type;

137 
«
->
∆a_Àn
 =Çœ_À¿+ 1 + 
NLA_HDRLEN
;

138 
	`mem˝y
(
	`NLA_DATA
(
«
), 
∆a_d©a
, 
∆a_Àn
);

139 
msg
.
n
.
∆msg_Àn
 +
	`NLMSG_ALIGN
(
«
->
∆a_Àn
);

141 
buf
 = (*Ë&
msg
;

142 
buÊí
 = 
msg
.
n
.
∆msg_Àn
 ;

143 
	`mem£t
(&
∆addr
, 0, (nladdr));

144 
∆addr
.
∆_Ámûy
 = 
AF_NETLINK
;

145 (
r
 = 
	`£ndto
(
sd
, 
buf
, 
buÊí
, 0, (
sockaddr
 *Ë&
∆addr
,

146 (
∆addr
))Ë< 
buÊí
) {

147 i‡(
r
 > 0) {

148 
buf
 +
r
;

149 
buÊí
 -
r
;

150 } i‡(
î∫o
 !
EAGAIN
)

154 
	}
}

161 
	$gë_Ámûy_id
(
sd
)

164 
∆msghdr
 
n
;

165 
gílmsghdr
 
g
;

166 
buf
[256];

167 } 
™s
;

169 
id
, 
rc
;

170 
∆©å
 *
«
;

171 
ªp_Àn
;

173 
	`°r˝y
(
«me
, 
TASKSTATS_GENL_NAME
);

174 
rc
 = 
	`£nd_cmd
(
sd
, 
GENL_ID_CTRL
, 
	`gëpid
(), 
CTRL_CMD_GETFAMILY
,

175 
CTRL_ATTR_FAMILY_NAME
, (*)
«me
,

176 
	`°æí
(
TASKSTATS_GENL_NAME
)+1);

178 
ªp_Àn
 = 
	`ªcv
(
sd
, &
™s
, (ans), 0);

179 i‡(
™s
.
n
.
∆msg_ty≥
 =
NLMSG_ERROR
 ||

180 (
ªp_Àn
 < 0Ë|| !
	`NLMSG_OK
((&
™s
.
n
),Ñep_len))

183 
«
 = (
∆©å
 *Ë
	`GENLMSG_DATA
(&
™s
);

184 
«
 = (
∆©å
 *Ë((*Ë« + 
	`NLA_ALIGN
“a->
∆a_Àn
));

185 i‡(
«
->
∆a_ty≥
 =
CTRL_ATTR_FAMILY_ID
) {

186 
id
 = *(
__u16
 *Ë
	`NLA_DATA
(
«
);

188  
id
;

189 
	}
}

191 
	$¥öt_dñayac˘
(
èsk°©s
 *
t
)

193 
	`¥ötf
("\n\nCPU %15s%15s%15s%15s\n"

200 
t
->
˝u_cou¡
,Å->
˝u_run_ªÆ_tŸÆ
,Å->
˝u_run_vútuÆ_tŸÆ
,

201 
t
->
˝u_dñay_tŸÆ
,

203 
t
->
blkio_cou¡
,Å->
blkio_dñay_tŸÆ
,

204 "cou¡", "dñayÅŸÆ", 
t
->
sw≠ö_cou¡
,Å->
sw≠ö_dñay_tŸÆ
);

205 
	}
}

207 
	$¥öt_iﬂc˘
(
èsk°©s
 *
t
)

209 
	`¥ötf
("%s:Ñead=%llu, write=%llu, cancelled_write=%llu\n",

210 
t
->
ac_comm
,

211 ()
t
->
ªad_byãs
,

212 ()
t
->
wrôe_byãs
,

213 ()
t
->
ˇn˚Œed_wrôe_byãs
);

214 
	}
}

216 
	$maö
(
¨gc
, *
¨gv
[])

218 
c
, 
rc
, 
ªp_Àn
, 
aggr_Àn
, 
Àn2
, 
cmd_ty≥
;

219 
__u16
 
id
;

220 
__u32
 
mypid
;

222 
∆©å
 *
«
;

223 
∆_sd
 = -1;

224 
Àn
 = 0;

225 
pid_t
 
tid
 = 0;

226 
pid_t
 
πid
 = 0;

228 
fd
 = 0;

229 
cou¡
 = 0;

230 
wrôe_fûe
 = 0;

231 
mask£t
 = 0;

232 *
logfûe
 = 
NULL
;

233 
lo›
 = 0;

235 
msgãm∂©e
 
msg
;

238 
c
 = 
	`gë›t
(
¨gc
, 
¨gv
, "diw:r:m:t:p:vl");

239 i‡(
c
 < 0)

242 
c
) {

244 
	`¥ötf
("print delayacct stats ON\n");

245 
¥öt_dñays
 = 1;

248 
	`¥ötf
("printing IOáccounting\n");

249 
¥öt_io_accou¡ög
 = 1;

252 
logfûe
 = 
	`°rdup
(
›èrg
);

253 
	`¥ötf
("wrôêtÿfûê%s\n", 
logfûe
);

254 
wrôe_fûe
 = 1;

257 
rcvbufsz
 = 
	`©oi
(
›èrg
);

258 
	`¥ötf
("ª˚ivêbu‡sizê%d\n", 
rcvbufsz
);

259 i‡(
rcvbufsz
 < 0)

260 
	`îr
(1, "InvalidÑcv buf size\n");

263 
	`°∫˝y
(
˝umask
, 
›èrg
, (cpumask));

264 
mask£t
 = 1;

265 
	`¥ötf
("˝umask %†mask£à%d\n", 
˝umask
, 
mask£t
);

268 
tid
 = 
	`©oi
(
›èrg
);

269 i‡(!
tid
)

270 
	`îr
(1, "InvalidÅgid\n");

271 
cmd_ty≥
 = 
TASKSTATS_CMD_ATTR_TGID
;

274 
tid
 = 
	`©oi
(
›èrg
);

275 i‡(!
tid
)

276 
	`îr
(1, "InvalidÖid\n");

277 
cmd_ty≥
 = 
TASKSTATS_CMD_ATTR_PID
;

280 
	`¥ötf
("debug on\n");

281 
dbg
 = 1;

284 
	`¥ötf
("listen forever\n");

285 
lo›
 = 1;

288 
	`ußge
();

289 
	`exô
(-1);

293 i‡(
wrôe_fûe
) {

294 
fd
 = 
	`›í
(
logfûe
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
,

295 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

296 i‡(
fd
 == -1) {

297 
	`≥º‹
("Cannot open output file\n");

298 
	`exô
(1);

302 i‡((
∆_sd
 = 
	`¸óã_∆_sockë
(
NETLINK_GENERIC
)) < 0)

303 
	`îr
(1, "error creating Netlink socket\n");

306 
mypid
 = 
	`gëpid
();

307 
id
 = 
	`gë_Ámûy_id
(
∆_sd
);

308 i‡(!
id
) {

309 
	`Ârötf
(
°dîr
, "Eº‹ gëtög famûy id,Éºnÿ%d\n", 
î∫o
);

310 
îr
;

312 
	`PRINTF
("Ámûy id %d\n", 
id
);

314 i‡(
mask£t
) {

315 
rc
 = 
	`£nd_cmd
(
∆_sd
, 
id
, 
mypid
, 
TASKSTATS_CMD_GET
,

316 
TASKSTATS_CMD_ATTR_REGISTER_CPUMASK
,

317 &
˝umask
, 
	`°æí
(cpumask) + 1);

318 
	`PRINTF
("Síàªgi°î cpumask,ÑëvÆ %d\n", 
rc
);

319 i‡(
rc
 < 0) {

320 
	`Ârötf
(
°dîr
, "error sendingÑegister cpumask\n");

321 
îr
;

325 i‡(
tid
) {

326 
rc
 = 
	`£nd_cmd
(
∆_sd
, 
id
, 
mypid
, 
TASKSTATS_CMD_GET
,

327 
cmd_ty≥
, &
tid
, (
__u32
));

328 
	`PRINTF
("Síàpid/tgid,ÑëvÆ %d\n", 
rc
);

329 i‡(
rc
 < 0) {

330 
	`Ârötf
(
°dîr
, "error sendingÅid/tgid cmd\n");

331 
d⁄e
;

336 
i
;

338 
ªp_Àn
 = 
	`ªcv
(
∆_sd
, &
msg
, (msg), 0);

339 
	`PRINTF
("ª˚ived %d byãs\n", 
ªp_Àn
);

341 i‡(
ªp_Àn
 < 0) {

342 
	`Ârötf
(
°dîr
, "nonfatalÑeplyÉrror:Érrno %d\n",

343 
î∫o
);

346 i‡(
msg
.
n
.
∆msg_ty≥
 =
NLMSG_ERROR
 ||

347 !
	`NLMSG_OK
((&
msg
.
n
), 
ªp_Àn
)) {

348 
∆msgîr
 *
îr
 = 
	`NLMSG_DATA
(&
msg
);

349 
	`Ârötf
(
°dîr
, "fatalÑeplyÉrror,Érrno %d\n",

350 
îr
->
îr‹
);

351 
d⁄e
;

354 
	`PRINTF
("nlmsghdr size=%d,Çlmsg_len=%d,Ñep_len=%d\n",

355 (
∆msghdr
), 
msg
.
n
.
∆msg_Àn
, 
ªp_Àn
);

358 
ªp_Àn
 = 
	`GENLMSG_PAYLOAD
(&
msg
.
n
);

360 
«
 = (
∆©å
 *Ë
	`GENLMSG_DATA
(&
msg
);

361 
Àn
 = 0;

362 
i
 = 0;

363 
Àn
 < 
ªp_Àn
) {

364 
Àn
 +
	`NLA_ALIGN
(
«
->
∆a_Àn
);

365 
«
->
∆a_ty≥
) {

366 
TASKSTATS_TYPE_AGGR_TGID
:

368 
TASKSTATS_TYPE_AGGR_PID
:

369 
aggr_Àn
 = 
	`NLA_PAYLOAD
(
«
->
∆a_Àn
);

370 
Àn2
 = 0;

372 
«
 = (
∆©å
 *Ë
	`NLA_DATA
(na);

373 
d⁄e
 = 0;

374 
Àn2
 < 
aggr_Àn
) {

375 
«
->
∆a_ty≥
) {

376 
TASKSTATS_TYPE_PID
:

377 
πid
 = *(*Ë
	`NLA_DATA
(
«
);

378 i‡(
¥öt_dñays
)

379 
	`¥ötf
("PID\t%d\n", 
πid
);

381 
TASKSTATS_TYPE_TGID
:

382 
πid
 = *(*Ë
	`NLA_DATA
(
«
);

383 i‡(
¥öt_dñays
)

384 
	`¥ötf
("TGID\t%d\n", 
πid
);

386 
TASKSTATS_TYPE_STATS
:

387 
cou¡
++;

388 i‡(
¥öt_dñays
)

389 
	`¥öt_dñayac˘
((
èsk°©s
 *Ë
	`NLA_DATA
(
«
));

390 i‡(
¥öt_io_accou¡ög
)

391 
	`¥öt_iﬂc˘
((
èsk°©s
 *Ë
	`NLA_DATA
(
«
));

392 i‡(
fd
) {

393 i‡(
	`wrôe
(
fd
, 
	`NLA_DATA
(
«
),Ça->
∆a_Àn
) < 0) {

394 
	`îr
(1,"writeÉrror\n");

397 i‡(!
lo›
)

398 
d⁄e
;

401 
	`Ârötf
(
°dîr
, "UnknownÇested"

403 
«
->
∆a_ty≥
);

406 
Àn2
 +
	`NLA_ALIGN
(
«
->
∆a_Àn
);

407 
«
 = (
∆©å
 *Ë((*Ë« + 
Àn2
);

412 
	`Ârötf
(
°dîr
, "UnknownÇla_type %d\n",

413 
«
->
∆a_ty≥
);

416 
«
 = (
∆©å
 *Ë(
	`GENLMSG_DATA
(&
msg
Ë+ 
Àn
);

418 } 
lo›
);

419 
d⁄e
:

420 i‡(
mask£t
) {

421 
rc
 = 
	`£nd_cmd
(
∆_sd
, 
id
, 
mypid
, 
TASKSTATS_CMD_GET
,

422 
TASKSTATS_CMD_ATTR_DEREGISTER_CPUMASK
,

423 &
˝umask
, 
	`°æí
(cpumask) + 1);

424 
	`¥ötf
("Síàdîegi°î mask,ÑëvÆ %d\n", 
rc
);

425 i‡(
rc
 < 0)

426 
	`îr
(
rc
, "error sending deregister cpumask\n");

428 
îr
:

429 
	`˛o£
(
∆_sd
);

430 i‡(
fd
)

431 
	`˛o£
(
fd
);

433 
	}
}

	@Documentation/auxdisplay/cfag12864b-example.c

31 
	~<°rög.h
>

32 
	~<f˙é.h
>

33 
	~<uni°d.h
>

34 
	~<sys/ty≥s.h
>

35 
	~<sys/°©.h
>

36 
	~<sys/mm™.h
>

38 
	#CFAG12864B_WIDTH
 (128)

	)

39 
	#CFAG12864B_HEIGHT
 (64)

	)

40 
	#CFAG12864B_SIZE
 (128 * 64 / 8)

	)

41 
	#CFAG12864B_BPB
 (8)

	)

42 
	#CFAG12864B_ADDRESS
(
x
, 
y
Ë((yË* 
CFAG12864B_WIDTH
 / \

43 
CFAG12864B_BPB
 + (
x
Ë/ CFAG12864B_BPB)

	)

44 
	#CFAG12864B_BIT
(
n
Ë(((Ë1Ë<< (n))

	)

46 #unde‡
CFAG12864B_DOCHECK


47 #ifde‡
CFAG12864B_DOCHECK


48 
	#CFAG12864B_CHECK
(
x
, 
y
Ë((xË< 
CFAG12864B_WIDTH
 && \

49 (
y
Ë< 
CFAG12864B_HEIGHT
)

	)

51 
	#CFAG12864B_CHECK
(
x
, 
y
Ë(1)

	)

54 
	gcÁg12864b_fd
;

55 * 
	gcÁg12864b_mem
;

56 
	gcÁg12864b_buf„r
[
CFAG12864B_SIZE
];

65 
	$cÁg12864b_öô
(*
∑th
)

67 
cÁg12864b_fd
 = 
	`›í
(
∑th
, 
O_RDWR
);

68 i‡(
cÁg12864b_fd
 == -1)

71 
cÁg12864b_mem
 = 
	`mm≠
(0, 
CFAG12864B_SIZE
, 
PROT_READ
 | 
PROT_WRITE
,

72 
MAP_SHARED
, 
cÁg12864b_fd
, 0);

73 i‡(
cÁg12864b_mem
 =
MAP_FAILED
) {

74 
	`˛o£
(
cÁg12864b_fd
);

79 
	}
}

84 
	$cÁg12864b_exô
()

86 
	`munm≠
(
cÁg12864b_mem
, 
CFAG12864B_SIZE
);

87 
	`˛o£
(
cÁg12864b_fd
);

88 
	}
}

93 
	$cÁg12864b_£t
(
x
, 
y
)

95 i‡(
	`CFAG12864B_CHECK
(
x
, 
y
))

96 
cÁg12864b_buf„r
[
	`CFAG12864B_ADDRESS
(
x
, 
y
)] |=

97 
	`CFAG12864B_BIT
(
x
 % 
CFAG12864B_BPB
);

98 
	}
}

103 
	$cÁg12864b_un£t
(
x
, 
y
)

105 i‡(
	`CFAG12864B_CHECK
(
x
, 
y
))

106 
cÁg12864b_buf„r
[
	`CFAG12864B_ADDRESS
(
x
, 
y
)] &=

107 ~
	`CFAG12864B_BIT
(
x
 % 
CFAG12864B_BPB
);

108 
	}
}

116 
	$cÁg12864b_is£t
(
x
, 
y
)

118 i‡(
	`CFAG12864B_CHECK
(
x
, 
y
))

119 i‡(
cÁg12864b_buf„r
[
	`CFAG12864B_ADDRESS
(
x
, 
y
)] &

120 
	`CFAG12864B_BIT
(
x
 % 
CFAG12864B_BPB
))

124 
	}
}

129 
	$cÁg12864b_nŸ
(
x
, 
y
)

131 i‡(
	`cÁg12864b_is£t
(
x
, 
y
))

132 
	`cÁg12864b_un£t
(
x
, 
y
);

134 
	`cÁg12864b_£t
(
x
, 
y
);

135 
	}
}

140 
	$cÁg12864b_fûl
()

142 
i
;

144 
i
 = 0; i < 
CFAG12864B_SIZE
; i++)

145 
cÁg12864b_buf„r
[
i
] = 0xFF;

146 
	}
}

151 
	$cÁg12864b_˛ór
()

153 
i
;

155 
i
 = 0; i < 
CFAG12864B_SIZE
; i++)

156 
cÁg12864b_buf„r
[
i
] = 0;

157 
	}
}

165 
	$cÁg12864b_f‹m©
(* 
m©rix
)

167 
i
, 
j
, 
n
;

169 
i
 = 0; i < 
CFAG12864B_HEIGHT
; i++)

170 
j
 = 0; j < 
CFAG12864B_WIDTH
 / 
CFAG12864B_BPB
; j++) {

171 
cÁg12864b_buf„r
[
i
 * 
CFAG12864B_WIDTH
 / 
CFAG12864B_BPB
 +

172 
j
] = 0;

173 
n
 = 0;Ç < 
CFAG12864B_BPB
;Ç++)

174 i‡(
m©rix
[
i
 * 
CFAG12864B_WIDTH
 +

175 
j
 * 
CFAG12864B_BPB
 + 
n
])

176 
cÁg12864b_buf„r
[
i
 * 
CFAG12864B_WIDTH
 /

177 
CFAG12864B_BPB
 + 
j
] |=

178 
	`CFAG12864B_BIT
(
n
);

180 
	}
}

185 
	$cÁg12864b_blô
()

187 
	`mem˝y
(
cÁg12864b_mem
, 
cÁg12864b_buf„r
, 
CFAG12864B_SIZE
);

188 
	}
}

196 
	~<°dio.h
>

197 
	~<°rög.h
>

199 
	#EXAMPLES
 6

	)

201 
	$exam∂e
(
n
)

203 
i
, 
j
;

204 
m©rix
[
CFAG12864B_WIDTH
 * 
CFAG12864B_HEIGHT
];

206 i‡(
n
 > 
EXAMPLES
)

209 
	`¥ötf
("Exam∂ê%i/%ò- ", 
n
, 
EXAMPLES
);

211 
n
) {

213 
	`¥ötf
("DrawÖoints setting bits");

214 
	`cÁg12864b_˛ór
();

215 
i
 = 0; i < 
CFAG12864B_WIDTH
; i += 2)

216 
j
 = 0; j < 
CFAG12864B_HEIGHT
; j += 2)

217 
	`cÁg12864b_£t
(
i
, 
j
);

221 
	`¥ötf
("ClearÅhe LCD");

222 
	`cÁg12864b_˛ór
();

226 
	`¥ötf
("DrawÑows formattingá [128*64] matrix");

227 
	`mem£t
(
m©rix
, 0, 
CFAG12864B_WIDTH
 * 
CFAG12864B_HEIGHT
);

228 
i
 = 0; i < 
CFAG12864B_WIDTH
; i++)

229 
j
 = 0; j < 
CFAG12864B_HEIGHT
; j += 2)

230 
m©rix
[
j
 * 
CFAG12864B_WIDTH
 + 
i
] = 1;

231 
	`cÁg12864b_f‹m©
(
m©rix
);

235 
	`¥ötf
("FillÅheÜcd");

236 
	`cÁg12864b_fûl
();

240 
	`¥ötf
("Draw columns unsetting bits");

241 
i
 = 0; i < 
CFAG12864B_WIDTH
; i += 2)

242 
j
 = 0; j < 
CFAG12864B_HEIGHT
; j++)

243 
	`cÁg12864b_un£t
(
i
, 
j
);

247 
	`¥ötf
("DoÇegativeÇot-ingáll bits");

248 
i
 = 0; i < 
CFAG12864B_WIDTH
; i++)

249 
j
 = 0; j < 
CFAG12864B_HEIGHT
; j ++)

250 
	`cÁg12864b_nŸ
(
i
, 
j
);

254 
	`puts
(" - [Press Enter]");

255 
	}
}

257 
	$maö
(
¨gc
, *
¨gv
[])

259 
n
;

261 i‡(
¨gc
 != 2) {

262 
	`¥ötf
(

264 "UsuÆly: /dev/fb0, /dev/fb1...\n", 
¨gv
[0]);

268 i‡(
	`cÁg12864b_öô
(
¨gv
[1])) {

269 
	`¥ötf
("C™'àöô %†fbdev\n", 
¨gv
[1]);

273 
n
 = 1;Ç <
EXAMPLES
;Ç++) {

274 
	`exam∂e
(
n
);

275 
	`cÁg12864b_blô
();

276 
	`gëch¨
() != '\n');

279 
	`cÁg12864b_exô
();

282 
	}
}

	@Documentation/connector/cn_test.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/moduÀ∑øm.h
>

25 
	~<löux/skbuff.h
>

26 
	~<löux/timî.h
>

28 
	~<löux/c⁄√˘‹.h
>

30 
cb_id
 
	g˙_ã°_id
 = { 0x123, 0x456 };

31 
	g˙_ã°_«me
[] = "cn_test";

32 
sock
 *
	g∆s
;

33 
timî_li°
 
	g˙_ã°_timî
;

35 
	$˙_ã°_ˇŒback
(*
d©a
)

37 
˙_msg
 *
msg
 = (˙_msg *)
d©a
;

39 
	`¥ötk
("%s: %lu: idx=%x, val=%x, seq=%u,áck=%u,Üen=%d: %s.\n",

40 
__func__
, 
jiffõs
, 
msg
->
id
.
idx
, msg->id.
vÆ
,

41 
msg
->
£q
, msg->
ack
, msg->
Àn
, (*)msg->
d©a
);

42 
	}
}

44 
	$˙_ã°_w™t_nŸify
()

46 
˙_˘l_msg
 *
˘l
;

47 
˙_nŸify_ªq
 *
ªq
;

48 
˙_msg
 *
msg
 = 
NULL
;

49 
size
, 
size0
;

50 
sk_buff
 *
skb
;

51 
∆msghdr
 *
∆h
;

52 
u32
 
group
 = 1;

54 
size0
 = (*
msg
Ë+ (*
˘l
Ë+ 3 * (*
ªq
);

56 
size
 = 
	`NLMSG_SPACE
(
size0
);

58 
skb
 = 
	`Æloc_skb
(
size
, 
GFP_ATOMIC
);

59 i‡(!
skb
) {

60 
	`¥ötk
(
KERN_ERR
 "FailedÅoállocateÇew skb with size=%u.\n",

61 
size
);

63  -
ENOMEM
;

66 
∆h
 = 
	`NLMSG_PUT
(
skb
, 0, 0x123, 
NLMSG_DONE
, 
size
 - (*nlh));

68 
msg
 = (
˙_msg
 *)
	`NLMSG_DATA
(
∆h
);

70 
	`mem£t
(
msg
, 0, 
size0
);

72 
msg
->
id
.
idx
 = -1;

73 
msg
->
id
.
vÆ
 = -1;

74 
msg
->
£q
 = 0x123;

75 
msg
->
ack
 = 0x345;

76 
msg
->
Àn
 = 
size0
 - (*msg);

78 
˘l
 = (
˙_˘l_msg
 *)(
msg
 + 1);

80 
˘l
->
idx_nŸify_num
 = 1;

81 
˘l
->
vÆ_nŸify_num
 = 2;

82 
˘l
->
group
 = group;

83 
˘l
->
Àn
 = 
msg
->len - (*ctl);

85 
ªq
 = (
˙_nŸify_ªq
 *)(
˘l
 + 1);

90 
ªq
->
fú°
 = 
˙_ã°_id
.
idx
;

91 
ªq
->
ønge
 = 10;

96 
ªq
++;

97 
ªq
->
fú°
 = 
˙_ã°_id
.
vÆ
;

98 
ªq
->
ønge
 = 10;

103 
ªq
++;

104 
ªq
->
fú°
 = 
˙_ã°_id
.
vÆ
 + 20;

105 
ªq
->
ønge
 = 10;

107 
	`NETLINK_CB
(
skb
).
d°_group
 = 
˘l
->
group
;

109 
	`√éök_uniˇ°
(
∆s
, 
skb
, 0, 0);

111 
	`¥ötk
(
KERN_INFO
 "Reque° wa†£¡. Group=0x%x.\n", 
˘l
->
group
);

115 
∆msg_Áûuª
:

116 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿ£nd %u.%u\n", 
msg
->
£q
, msg->
ack
);

117 
	`k‰ì_skb
(
skb
);

118  -
EINVAL
;

119 
	}
}

121 
u32
 
	g˙_ã°_timî_cou¡î
;

122 
	$˙_ã°_timî_func
(
__d©a
)

124 
˙_msg
 *
m
;

125 
d©a
[32];

127 
m
 = 
	`kmÆloc
((*mË+ (
d©a
), 
GFP_ATOMIC
);

128 i‡(
m
) {

129 
	`mem£t
(
m
, 0, (*mË+ (
d©a
));

131 
	`mem˝y
(&
m
->
id
, &
˙_ã°_id
, (m->id));

132 
m
->
£q
 = 
˙_ã°_timî_cou¡î
;

133 
m
->
Àn
 = (
d©a
);

135 
m
->
Àn
 =

136 
	`s˙¥ötf
(
d©a
, (data), "counter = %u",

137 
˙_ã°_timî_cou¡î
) + 1;

139 
	`mem˝y
(
m
 + 1, 
d©a
, m->
Àn
);

141 
	`˙_√éök_£nd
(
m
, 0, 
	`gÂ_™y
());

142 
	`k‰ì
(
m
);

145 
˙_ã°_timî_cou¡î
++;

147 
	`mod_timî
(&
˙_ã°_timî
, 
jiffõs
 + 
HZ
);

148 
	}
}

150 
	$˙_ã°_öô
()

152 
îr
;

154 
îr
 = 
	`˙_add_ˇŒback
(&
˙_ã°_id
, 
˙_ã°_«me
, 
˙_ã°_ˇŒback
);

155 i‡(
îr
)

156 
îr_out
;

157 
˙_ã°_id
.
vÆ
++;

158 
îr
 = 
	`˙_add_ˇŒback
(&
˙_ã°_id
, 
˙_ã°_«me
, 
˙_ã°_ˇŒback
);

159 i‡(
îr
) {

160 
	`˙_dñ_ˇŒback
(&
˙_ã°_id
);

161 
îr_out
;

164 
	`öô_timî
(&
˙_ã°_timî
);

165 
˙_ã°_timî
.
fun˘i⁄
 = 
˙_ã°_timî_func
;

166 
˙_ã°_timî
.
expúes
 = 
jiffõs
 + 
HZ
;

167 
˙_ã°_timî
.
d©a
 = 0;

168 
	`add_timî
(&
˙_ã°_timî
);

172 
îr_out
:

173 i‡(
∆s
 &&Çls->
sk_sockë
)

174 
	`sock_ªÀa£
(
∆s
->
sk_sockë
);

176  
îr
;

177 
	}
}

179 
	$˙_ã°_föi
()

181 
	`dñ_timî_sync
(&
˙_ã°_timî
);

182 
	`˙_dñ_ˇŒback
(&
˙_ã°_id
);

183 
˙_ã°_id
.
vÆ
--;

184 
	`˙_dñ_ˇŒback
(&
˙_ã°_id
);

185 i‡(
∆s
 &&Çls->
sk_sockë
)

186 
	`sock_ªÀa£
(
∆s
->
sk_sockë
);

187 
	}
}

189 
moduÀ_öô
(
˙_ã°_öô
);

190 
moduÀ_exô
(
˙_ã°_föi
);

192 
MODULE_LICENSE
("GPL");

193 
MODULE_AUTHOR
("Evgeniy Polyakov <johnpol@2ka.mipt.ru>");

194 
MODULE_DESCRIPTION
("Connector'sÅest module");

	@Documentation/connector/ucon.c

22 
	~<asm/ty≥s.h
>

24 
	~<sys/ty≥s.h
>

25 
	~<sys/sockë.h
>

26 
	~<sys/pﬁl.h
>

28 
	~<löux/√éök.h
>

29 
	~<löux/π√éök.h
>

31 
	~<¨∑/öë.h
>

33 
	~<°dio.h
>

34 
	~<°dlib.h
>

35 
	~<uni°d.h
>

36 
	~<°rög.h
>

37 
	~<î∫o.h
>

38 
	~<time.h
>

40 
	~<löux/c⁄√˘‹.h
>

42 
	#DEBUG


	)

43 
	#NETLINK_CONNECTOR
 11

	)

45 #ifde‡
DEBUG


46 
	#ulog
(
f
, 
a
...Ë
	`Ârötf
(
°dout
, f, ##a)

	)

48 
	#ulog
(
f
, 
a
...Ëdÿ{} 0)

	)

51 
	g√ed_exô
;

52 
__u32
 
	g£q
;

54 
	$√éök_£nd
(
s
, 
˙_msg
 *
msg
)

56 
∆msghdr
 *
∆h
;

57 
size
;

58 
îr
;

59 
buf
[128];

60 
˙_msg
 *
m
;

62 
size
 = 
	`NLMSG_SPACE
((
˙_msg
Ë+ 
msg
->
Àn
);

64 
∆h
 = (
∆msghdr
 *)
buf
;

65 
∆h
->
∆msg_£q
 = 
£q
++;

66 
∆h
->
∆msg_pid
 = 
	`gëpid
();

67 
∆h
->
∆msg_ty≥
 = 
NLMSG_DONE
;

68 
∆h
->
∆msg_Àn
 = 
	`NLMSG_LENGTH
(
size
 - (*nlh));

69 
∆h
->
∆msg_Êags
 = 0;

71 
m
 = 
	`NLMSG_DATA
(
∆h
);

73 
	`ulog
("%s: [%08x.%08x]Üen=%u, seq=%u,áck=%u.\n",

74 
__func__
, 
msg
->
id
.
idx
, msg->id.
vÆ
, msg->
Àn
, msg->
£q
, msg->
ack
);

76 
	`mem˝y
(
m
, 
msg
, (*mË+ msg->
Àn
);

78 
îr
 = 
	`£nd
(
s
, 
∆h
, 
size
, 0);

79 i‡(
îr
 == -1)

80 
	`ulog
("FailedÅo send: %s [%d].\n",

81 
	`°ªº‹
(
î∫o
),Érrno);

83  
îr
;

84 
	}
}

86 
	$maö
(
¨gc
, *
¨gv
[])

88 
s
;

89 
buf
[1024];

90 
Àn
;

91 
∆msghdr
 *
ª∂y
;

92 
sockaddr_∆
 
l_loˇl
;

93 
˙_msg
 *
d©a
;

94 
FILE
 *
out
;

95 
time_t
 
tm
;

96 
pﬁlfd
 
pfd
;

98 i‡(
¨gc
 < 2)

99 
out
 = 
°dout
;

101 
out
 = 
	`f›í
(
¨gv
[1], "a+");

102 i‡(!
out
) {

103 
	`ulog
("UnableÅo open %s for writing: %s\n",

104 
¨gv
[1], 
	`°ªº‹
(
î∫o
));

105 
out
 = 
°dout
;

109 
	`mem£t
(
buf
, 0, (buf));

111 
s
 = 
	`sockë
(
PF_NETLINK
, 
SOCK_DGRAM
, 
NETLINK_CONNECTOR
);

112 i‡(
s
 == -1) {

113 
	`≥º‹
("socket");

117 
l_loˇl
.
∆_Ámûy
 = 
AF_NETLINK
;

118 
l_loˇl
.
∆_groups
 = 0x123;

119 
l_loˇl
.
∆_pid
 = 0;

121 i‡(
	`böd
(
s
, (
sockaddr
 *)&
l_loˇl
, (
sockaddr_∆
)) == -1) {

122 
	`≥º‹
("bind");

123 
	`˛o£
(
s
);

129 
⁄
 = 0x57;

130 
	`£tsock›t
(
s
, 
SOL_NETLINK
, 
NETLINK_ADD_MEMBERSHIP
, &
⁄
, (on));

134 
i
, 
j
;

136 
	`mem£t
(
buf
, 0, (buf));

138 
d©a
 = (
˙_msg
 *)
buf
;

140 
d©a
->
id
.
idx
 = 0x123;

141 
d©a
->
id
.
vÆ
 = 0x456;

142 
d©a
->
£q
 = seq++;

143 
d©a
->
ack
 = 0;

144 
d©a
->
Àn
 = 0;

146 
j
=0; j<10; ++j) {

147 
i
=0; i<1000; ++i) {

148 
Àn
 = 
	`√éök_£nd
(
s
, 
d©a
);

151 
	`ulog
("%d mesßge†havêbì¿£¡Åÿ%08x.%08x.\n", 
i
, 
d©a
->
id
.
idx
, d©a->id.
vÆ
);

158 
pfd
.
fd
 = 
s
;

160 !
√ed_exô
) {

161 
pfd
.
evíts
 = 
POLLIN
;

162 
pfd
.
ªvíts
 = 0;

163 
	`pﬁl
(&
pfd
, 1, -1)) {

165 
√ed_exô
 = 1;

168 i‡(
î∫o
 !
EINTR
) {

169 
√ed_exô
 = 1;

174 i‡(
√ed_exô
)

177 
	`mem£t
(
buf
, 0, (buf));

178 
Àn
 = 
	`ªcv
(
s
, 
buf
, (buf), 0);

179 i‡(
Àn
 == -1) {

180 
	`≥º‹
("recv buf");

181 
	`˛o£
(
s
);

184 
ª∂y
 = (
∆msghdr
 *)
buf
;

186 
ª∂y
->
∆msg_ty≥
) {

187 
NLMSG_ERROR
:

188 
	`Ârötf
(
out
, "Error messageÑeceived.\n");

189 
	`fÊush
(
out
);

191 
NLMSG_DONE
:

192 
d©a
 = (
˙_msg
 *)
	`NLMSG_DATA
(
ª∂y
);

194 
	`time
(&
tm
);

195 
	`Ârötf
(
out
, "%.24s : [%x.%x] [%08u.%08u].\n",

196 
	`˘ime
(&
tm
), 
d©a
->
id
.
idx
, d©a->id.
vÆ
, d©a->
£q
, d©a->
ack
);

197 
	`fÊush
(
out
);

204 
	`˛o£
(
s
);

206 
	}
}

	@Documentation/filesystems/configfs/configfs_example.c

28 
	~<löux/öô.h
>

29 
	~<löux/moduÀ.h
>

30 
	~<löux/¶ab.h
>

32 
	~<löux/c⁄figfs.h
>

48 
	schûdÀss
 {

49 
c⁄figfs_subsy°em
 
	msubsys
;

50 
	mshowme
;

51 
	m°‹eme
;

54 
	schûdÀss_©åibuã
 {

55 
c⁄figfs_©åibuã
 
	m©å
;

56 
ssize_t
 (*
show
)(
	mchûdÀss
 *, *);

57 
ssize_t
 (*
°‹e
)(
	mchûdÀss
 *, c⁄° *, 
	msize_t
);

60 
ölöe
 
chûdÀss
 *
	$to_chûdÀss
(
c⁄fig_ôem
 *
ôem
)

62  
ôem
 ? 
	`c⁄èöî_of
(
	`to_c⁄figfs_subsy°em
(
	`to_c⁄fig_group
(ôem)), 
chûdÀss
, 
subsys
Ë: 
NULL
;

63 
	}
}

65 
ssize_t
 
	$chûdÀss_showme_ªad
(
chûdÀss
 *childless,

66 *
∑ge
)

68 
ssize_t
 
pos
;

70 
pos
 = 
	`•rötf
(
∑ge
, "%d\n", 
chûdÀss
->
showme
);

71 
chûdÀss
->
showme
++;

73  
pos
;

74 
	}
}

76 
ssize_t
 
	$chûdÀss_°‹eme_ªad
(
chûdÀss
 *childless,

77 *
∑ge
)

79  
	`•rötf
(
∑ge
, "%d\n", 
chûdÀss
->
°‹eme
);

80 
	}
}

82 
ssize_t
 
	$chûdÀss_°‹eme_wrôe
(
chûdÀss
 *childless,

83 c⁄° *
∑ge
,

84 
size_t
 
cou¡
)

86 
tmp
;

87 *
p
 = (*Ë
∑ge
;

89 
tmp
 = 
	`sim∂e_°πoul
(
p
, &p, 10);

90 i‡(!
p
 || (*p && (*p != '\n')))

91  -
EINVAL
;

93 i‡(
tmp
 > 
INT_MAX
)

94  -
ERANGE
;

96 
chûdÀss
->
°‹eme
 = 
tmp
;

98  
cou¡
;

99 
	}
}

101 
ssize_t
 
	$chûdÀss_des¸ùti⁄_ªad
(
chûdÀss
 *childless,

102 *
∑ge
)

104  
	`•rötf
(
∑ge
,

111 
	}
}

113 
chûdÀss_©åibuã
 
	gchûdÀss_©å_showme
 = {

114 .
©å
 = { .
ˇ_ow√r
 = 
THIS_MODULE
, .
	gˇ_«me
 = "showme", .
	gˇ_mode
 = 
S_IRUGO
 },

115 .
	gshow
 = 
chûdÀss_showme_ªad
,

117 
chûdÀss_©åibuã
 
	gchûdÀss_©å_°‹eme
 = {

118 .
©å
 = { .
ˇ_ow√r
 = 
THIS_MODULE
, .
	gˇ_«me
 = "°‹eme", .
	gˇ_mode
 = 
S_IRUGO
 | 
S_IWUSR
 },

119 .
	gshow
 = 
chûdÀss_°‹eme_ªad
,

120 .
	g°‹e
 = 
chûdÀss_°‹eme_wrôe
,

122 
chûdÀss_©åibuã
 
	gchûdÀss_©å_des¸ùti⁄
 = {

123 .
©å
 = { .
ˇ_ow√r
 = 
THIS_MODULE
, .
	gˇ_«me
 = "des¸ùti⁄", .
	gˇ_mode
 = 
S_IRUGO
 },

124 .
	gshow
 = 
chûdÀss_des¸ùti⁄_ªad
,

127 
c⁄figfs_©åibuã
 *
	gchûdÀss_©ås
[] = {

128 &
chûdÀss_©å_showme
.
©å
,

129 &
chûdÀss_©å_°‹eme
.
©å
,

130 &
chûdÀss_©å_des¸ùti⁄
.
©å
,

131 
NULL
,

134 
ssize_t
 
	$chûdÀss_©å_show
(
c⁄fig_ôem
 *
ôem
,

135 
c⁄figfs_©åibuã
 *
©å
,

136 *
∑ge
)

138 
chûdÀss
 *chûdÀs†
	`to_chûdÀss
(
ôem
);

139 
chûdÀss_©åibuã
 *
chûdÀss_©å
 =

140 
	`c⁄èöî_of
(
©å
, 
chûdÀss_©åibuã
,áttr);

141 
ssize_t
 
ªt
 = 0;

143 i‡(
chûdÀss_©å
->
show
)

144 
ªt
 = 
chûdÀss_©å
->
	`show
(
chûdÀss
, 
∑ge
);

145  
ªt
;

146 
	}
}

148 
ssize_t
 
	$chûdÀss_©å_°‹e
(
c⁄fig_ôem
 *
ôem
,

149 
c⁄figfs_©åibuã
 *
©å
,

150 c⁄° *
∑ge
, 
size_t
 
cou¡
)

152 
chûdÀss
 *chûdÀs†
	`to_chûdÀss
(
ôem
);

153 
chûdÀss_©åibuã
 *
chûdÀss_©å
 =

154 
	`c⁄èöî_of
(
©å
, 
chûdÀss_©åibuã
,áttr);

155 
ssize_t
 
ªt
 = -
EINVAL
;

157 i‡(
chûdÀss_©å
->
°‹e
)

158 
ªt
 = 
chûdÀss_©å
->
	`°‹e
(
chûdÀss
, 
∑ge
, 
cou¡
);

159  
ªt
;

160 
	}
}

162 
c⁄figfs_ôem_›î©i⁄s
 
	gchûdÀss_ôem_›s
 = {

163 .
show_©åibuã
 = 
chûdÀss_©å_show
,

164 .
	g°‹e_©åibuã
 = 
chûdÀss_©å_°‹e
,

167 
c⁄fig_ôem_ty≥
 
	gchûdÀss_ty≥
 = {

168 .
˘_ôem_›s
 = &
chûdÀss_ôem_›s
,

169 .
	g˘_©ås
 = 
chûdÀss_©ås
,

170 .
	g˘_ow√r
 = 
THIS_MODULE
,

173 
chûdÀss
 
	gchûdÀss_subsys
 = {

174 .
subsys
 = {

175 .
su_group
 = {

176 .
cg_ôem
 = {

177 .
ci_«mebuf
 = "01-childless",

178 .
	gci_ty≥
 = &
chûdÀss_ty≥
,

196 
	ssim∂e_chûd
 {

197 
c⁄fig_ôem
 
	môem
;

198 
	m°‹eme
;

201 
ölöe
 
sim∂e_chûd
 *
	$to_sim∂e_chûd
(
c⁄fig_ôem
 *
ôem
)

203  
ôem
 ? 
	`c⁄èöî_of
(ôem, 
sim∂e_chûd
, iãmË: 
NULL
;

204 
	}
}

206 
c⁄figfs_©åibuã
 
	gsim∂e_chûd_©å_°‹eme
 = {

207 .
ˇ_ow√r
 = 
THIS_MODULE
,

208 .
	gˇ_«me
 = "storeme",

209 .
	gˇ_mode
 = 
S_IRUGO
 | 
S_IWUSR
,

212 
c⁄figfs_©åibuã
 *
	gsim∂e_chûd_©ås
[] = {

213 &
sim∂e_chûd_©å_°‹eme
,

214 
NULL
,

217 
ssize_t
 
	$sim∂e_chûd_©å_show
(
c⁄fig_ôem
 *
ôem
,

218 
c⁄figfs_©åibuã
 *
©å
,

219 *
∑ge
)

221 
ssize_t
 
cou¡
;

222 
sim∂e_chûd
 *sim∂e_chûd = 
	`to_sim∂e_chûd
(
ôem
);

224 
cou¡
 = 
	`•rötf
(
∑ge
, "%d\n", 
sim∂e_chûd
->
°‹eme
);

226  
cou¡
;

227 
	}
}

229 
ssize_t
 
	$sim∂e_chûd_©å_°‹e
(
c⁄fig_ôem
 *
ôem
,

230 
c⁄figfs_©åibuã
 *
©å
,

231 c⁄° *
∑ge
, 
size_t
 
cou¡
)

233 
sim∂e_chûd
 *sim∂e_chûd = 
	`to_sim∂e_chûd
(
ôem
);

234 
tmp
;

235 *
p
 = (*Ë
∑ge
;

237 
tmp
 = 
	`sim∂e_°πoul
(
p
, &p, 10);

238 i‡(!
p
 || (*p && (*p != '\n')))

239  -
EINVAL
;

241 i‡(
tmp
 > 
INT_MAX
)

242  -
ERANGE
;

244 
sim∂e_chûd
->
°‹eme
 = 
tmp
;

246  
cou¡
;

247 
	}
}

249 
	$sim∂e_chûd_ªÀa£
(
c⁄fig_ôem
 *
ôem
)

251 
	`k‰ì
(
	`to_sim∂e_chûd
(
ôem
));

252 
	}
}

254 
c⁄figfs_ôem_›î©i⁄s
 
	gsim∂e_chûd_ôem_›s
 = {

255 .
ªÀa£
 = 
sim∂e_chûd_ªÀa£
,

256 .
	gshow_©åibuã
 = 
sim∂e_chûd_©å_show
,

257 .
	g°‹e_©åibuã
 = 
sim∂e_chûd_©å_°‹e
,

260 
c⁄fig_ôem_ty≥
 
	gsim∂e_chûd_ty≥
 = {

261 .
˘_ôem_›s
 = &
sim∂e_chûd_ôem_›s
,

262 .
	g˘_©ås
 = 
sim∂e_chûd_©ås
,

263 .
	g˘_ow√r
 = 
THIS_MODULE
,

267 
	ssim∂e_chûdªn
 {

268 
c⁄fig_group
 
	mgroup
;

271 
ölöe
 
sim∂e_chûdªn
 *
	$to_sim∂e_chûdªn
(
c⁄fig_ôem
 *
ôem
)

273  
ôem
 ? 
	`c⁄èöî_of
(
	`to_c⁄fig_group
(ôem), 
sim∂e_chûdªn
, 
group
Ë: 
NULL
;

274 
	}
}

276 
c⁄fig_ôem
 *
	$sim∂e_chûdªn_make_ôem
(
c⁄fig_group
 *
group
, c⁄° *
«me
)

278 
sim∂e_chûd
 *simple_child;

280 
sim∂e_chûd
 = 
	`kmÆloc
((sim∂e_chûd), 
GFP_KERNEL
);

281 i‡(!
sim∂e_chûd
)

282  
NULL
;

284 
	`mem£t
(
sim∂e_chûd
, 0, (simple_child));

286 
	`c⁄fig_ôem_öô_ty≥_«me
(&
sim∂e_chûd
->
ôem
, 
«me
,

287 &
sim∂e_chûd_ty≥
);

289 
sim∂e_chûd
->
°‹eme
 = 0;

291  &
sim∂e_chûd
->
ôem
;

292 
	}
}

294 
c⁄figfs_©åibuã
 
	gsim∂e_chûdªn_©å_des¸ùti⁄
 = {

295 .
ˇ_ow√r
 = 
THIS_MODULE
,

296 .
	gˇ_«me
 = "description",

297 .
	gˇ_mode
 = 
S_IRUGO
,

300 
c⁄figfs_©åibuã
 *
	gsim∂e_chûdªn_©ås
[] = {

301 &
sim∂e_chûdªn_©å_des¸ùti⁄
,

302 
NULL
,

305 
ssize_t
 
	$sim∂e_chûdªn_©å_show
(
c⁄fig_ôem
 *
ôem
,

306 
c⁄figfs_©åibuã
 *
©å
,

307 *
∑ge
)

309  
	`•rötf
(
∑ge
,

314 
	}
}

316 
	$sim∂e_chûdªn_ªÀa£
(
c⁄fig_ôem
 *
ôem
)

318 
	`k‰ì
(
	`to_sim∂e_chûdªn
(
ôem
));

319 
	}
}

321 
c⁄figfs_ôem_›î©i⁄s
 
	gsim∂e_chûdªn_ôem_›s
 = {

322 .
ªÀa£
 = 
sim∂e_chûdªn_ªÀa£
,

323 .
	gshow_©åibuã
 = 
sim∂e_chûdªn_©å_show
,

330 
c⁄figfs_group_›î©i⁄s
 
	gsim∂e_chûdªn_group_›s
 = {

331 .
make_ôem
 = 
sim∂e_chûdªn_make_ôem
,

334 
c⁄fig_ôem_ty≥
 
	gsim∂e_chûdªn_ty≥
 = {

335 .
˘_ôem_›s
 = &
sim∂e_chûdªn_ôem_›s
,

336 .
	g˘_group_›s
 = &
sim∂e_chûdªn_group_›s
,

337 .
	g˘_©ås
 = 
sim∂e_chûdªn_©ås
,

338 .
	g˘_ow√r
 = 
THIS_MODULE
,

341 
c⁄figfs_subsy°em
 
	gsim∂e_chûdªn_subsys
 = {

342 .
su_group
 = {

343 .
cg_ôem
 = {

344 .
ci_«mebuf
 = "02-simple-children",

345 .
	gci_ty≥
 = &
sim∂e_chûdªn_ty≥
,

363 
c⁄fig_group
 *
	$group_chûdªn_make_group
(
c⁄fig_group
 *
group
, c⁄° *
«me
)

365 
sim∂e_chûdªn
 *simple_children;

367 
sim∂e_chûdªn
 = 
	`kmÆloc
((simple_children),

368 
GFP_KERNEL
);

369 i‡(!
sim∂e_chûdªn
)

370  
NULL
;

372 
	`mem£t
(
sim∂e_chûdªn
, 0, (simple_children));

374 
	`c⁄fig_group_öô_ty≥_«me
(&
sim∂e_chûdªn
->
group
, 
«me
,

375 &
sim∂e_chûdªn_ty≥
);

377  &
sim∂e_chûdªn
->
group
;

378 
	}
}

380 
c⁄figfs_©åibuã
 
	ggroup_chûdªn_©å_des¸ùti⁄
 = {

381 .
ˇ_ow√r
 = 
THIS_MODULE
,

382 .
	gˇ_«me
 = "description",

383 .
	gˇ_mode
 = 
S_IRUGO
,

386 
c⁄figfs_©åibuã
 *
	ggroup_chûdªn_©ås
[] = {

387 &
group_chûdªn_©å_des¸ùti⁄
,

388 
NULL
,

391 
ssize_t
 
	$group_chûdªn_©å_show
(
c⁄fig_ôem
 *
ôem
,

392 
c⁄figfs_©åibuã
 *
©å
,

393 *
∑ge
)

395  
	`•rötf
(
∑ge
,

400 
	}
}

402 
c⁄figfs_ôem_›î©i⁄s
 
	ggroup_chûdªn_ôem_›s
 = {

403 .
show_©åibuã
 = 
group_chûdªn_©å_show
,

410 
c⁄figfs_group_›î©i⁄s
 
	ggroup_chûdªn_group_›s
 = {

411 .
make_group
 = 
group_chûdªn_make_group
,

414 
c⁄fig_ôem_ty≥
 
	ggroup_chûdªn_ty≥
 = {

415 .
˘_ôem_›s
 = &
group_chûdªn_ôem_›s
,

416 .
	g˘_group_›s
 = &
group_chûdªn_group_›s
,

417 .
	g˘_©ås
 = 
group_chûdªn_©ås
,

418 .
	g˘_ow√r
 = 
THIS_MODULE
,

421 
c⁄figfs_subsy°em
 
	ggroup_chûdªn_subsys
 = {

422 .
su_group
 = {

423 .
cg_ôem
 = {

424 .
ci_«mebuf
 = "03-group-children",

425 .
	gci_ty≥
 = &
group_chûdªn_ty≥
,

439 
c⁄figfs_subsy°em
 *
	gexam∂e_subsys
[] = {

440 &
chûdÀss_subsys
.
subsys
,

441 &
sim∂e_chûdªn_subsys
,

442 &
group_chûdªn_subsys
,

443 
NULL
,

446 
__öô
 
	$c⁄figfs_exam∂e_öô
()

448 
ªt
;

449 
i
;

450 
c⁄figfs_subsy°em
 *
subsys
;

452 
i
 = 0; 
exam∂e_subsys
[i]; i++) {

453 
subsys
 = 
exam∂e_subsys
[
i
];

455 
	`c⁄fig_group_öô
(&
subsys
->
su_group
);

456 
	`öô_MUTEX
(&
subsys
->
su_£m
);

457 
ªt
 = 
	`c⁄figfs_ªgi°î_subsy°em
(
subsys
);

458 i‡(
ªt
) {

459 
	`¥ötk
(
KERN_ERR
 "Error %d whileÑegistering subsystem %s\n",

460 
ªt
,

461 
subsys
->
su_group
.
cg_ôem
.
ci_«mebuf
);

462 
out_uƒegi°î
;

468 
out_uƒegi°î
:

469 ; 
i
 >= 0; i--) {

470 
	`c⁄figfs_uƒegi°î_subsy°em
(
exam∂e_subsys
[
i
]);

473  
ªt
;

474 
	}
}

476 
__exô
 
	$c⁄figfs_exam∂e_exô
()

478 
i
;

480 
i
 = 0; 
exam∂e_subsys
[i]; i++) {

481 
	`c⁄figfs_uƒegi°î_subsy°em
(
exam∂e_subsys
[
i
]);

483 
	}
}

485 
moduÀ_öô
(
c⁄figfs_exam∂e_öô
);

486 
moduÀ_exô
(
c⁄figfs_exam∂e_exô
);

487 
MODULE_LICENSE
("GPL");

	@Documentation/firmware_class/firmware_sample_driver.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/°rög.h
>

16 
	~"löux/fúmw¨e.h
"

18 
devi˚
 
	ggho°_devi˚
 = {

19 .
bus_id
 = "ghost0",

23 
	$ßm∂e_fúmw¨e_lﬂd
(*
fúmw¨e
, 
size
)

25 
u8
 
buf
[
size
+1];

26 
	`mem˝y
(
buf
, 
fúmw¨e
, 
size
);

27 
buf
[
size
] = '\0';

28 
	`¥ötk
(
KERN_INFO
 "fúmw¨e_ßm∂e_drivî: fúmw¨e: %s\n", 
buf
);

29 
	}
}

31 
	$ßm∂e_¥obe_deÁu…
()

34 c⁄° 
fúmw¨e
 *
fw_íåy
;

35 
	`¥ötk
(
KERN_INFO
 "firmware_sample_driver:á ghost device got inserted :)\n");

37 if(
	`ªque°_fúmw¨e
(&
fw_íåy
, "ßm∂e_drivî_fw", &
gho°_devi˚
)!=0)

39 
	`¥ötk
(
KERN_ERR


44 
	`ßm∂e_fúmw¨e_lﬂd
(
fw_íåy
->
d©a
, fw_íåy->
size
);

46 
	`ªÀa£_fúmw¨e
(
fw_íåy
);

49 
	}
}

50 
	$ßm∂e_¥obe_•ecific
()

57 
	`¥ötk
(
KERN_INFO
 "firmware_sample_driver:á ghost device got inserted :)\n");

59 if(
	`ªque°_fúmw¨e
(
NULL
, "ßm∂e_drivî_fw", &
gho°_devi˚
)!=0)

61 
	`¥ötk
(
KERN_ERR


70 
	}
}

71 
	$ßm∂e_¥obe_async_c⁄t
(c⁄° 
fúmw¨e
 *
fw
, *
c⁄ãxt
)

73 if(!
fw
){

74 
	`¥ötk
(
KERN_ERR


79 
	`¥ötk
(
KERN_INFO
 "firmware_sample_driver: deviceÖointer \"%s\"\n",

80 (*)
c⁄ãxt
);

81 
	`ßm∂e_fúmw¨e_lﬂd
(
fw
->
d©a
, fw->
size
);

82 
	}
}

83 
	$ßm∂e_¥obe_async
()

86 
îr‹
;

87 
îr‹
 = 
	`ªque°_fúmw¨e_nowaô
 (
THIS_MODULE
, 
FW_ACTION_NOHOTPLUG
,

88 "ßm∂e_drivî_fw", &
gho°_devi˚
,

90 
ßm∂e_¥obe_async_c⁄t
);

91 if(
îr‹
){

92 
	`¥ötk
(
KERN_ERR


96 
	}
}

98 
	$ßm∂e_öô
()

100 
	`devi˚_öôülize
(&
gho°_devi˚
);

103 
	`ßm∂e_¥obe_•ecific
();

104 
	`ßm∂e_¥obe_deÁu…
();

105 
	`ßm∂e_¥obe_async
();

107 
	}
}

108 
__exô
 
	$ßm∂e_exô
()

110 
	}
}

112 
moduÀ_öô
 (
ßm∂e_öô
);

113 
moduÀ_exô
 (
ßm∂e_exô
);

115 
MODULE_LICENSE
("GPL");

	@Documentation/firmware_class/firmware_sample_firmware_class.c

13 
	~<löux/devi˚.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/timî.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/°rög.h
>

19 
	~<löux/fúmw¨e.h
>

22 
MODULE_AUTHOR
("Manuel Estrada Sainz");

23 
MODULE_DESCRIPTION
("Hackish sample for using firmware class directly");

24 
MODULE_LICENSE
("GPL");

26 
ölöe
 
˛ass_devi˚
 *
	$to_˛ass_dev
(
kobje˘
 *
obj
)

28  
	`c⁄èöî_of
(
obj
,
˛ass_devi˚
,
kobj
);

29 
	}
}

30 
ölöe


31 
˛ass_devi˚_©åibuã
 *
	$to_˛ass_dev_©å
(
©åibuã
 *
_©å
)

33  
	`c⁄èöî_of
(
_©å
,
˛ass_devi˚_©åibuã
,
©å
);

34 
	}
}

36 
sysfs_¸óã_bö_fûe
(
kobje˘
 * 
kobj
, 
bö_©åibuã
 * 
©å
);

37 
sysfs_ªmove_bö_fûe
(
kobje˘
 * 
kobj
, 
bö_©åibuã
 * 
©å
);

39 
	sfúmw¨e_¥iv
 {

40 
	mfw_id
[
FIRMWARE_NAME_MAX
];

41 
s32
 
	mlﬂdög
:2;

42 
u32
 
	mab‹t
:1;

45 
˛ass
 
fúmw¨e_˛ass
;

47 
ssize_t
 
	$fúmw¨e_lﬂdög_show
(
˛ass_devi˚
 *
˛ass_dev
, *
buf
)

49 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

50  
	`•rötf
(
buf
, "%d\n", 
fw_¥iv
->
lﬂdög
);

51 
	}
}

52 
ssize_t
 
	$fúmw¨e_lﬂdög_°‹e
(
˛ass_devi˚
 *
˛ass_dev
,

53 c⁄° *
buf
, 
size_t
 
cou¡
)

55 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

56 
¥ev_lﬂdög
 = 
fw_¥iv
->
lﬂdög
;

58 
fw_¥iv
->
lﬂdög
 = 
	`sim∂e_°πﬁ
(
buf
, 
NULL
, 10);

60 
fw_¥iv
->
lﬂdög
){

68 if(
¥ev_lﬂdög
==1){

75  
cou¡
;

76 
	}
}

77 
CLASS_DEVICE_ATTR
(
lﬂdög
, 0644,

78 
fúmw¨e_lﬂdög_show
, 
fúmw¨e_lﬂdög_°‹e
);

80 
ssize_t
 
	$fúmw¨e_d©a_ªad
(
kobje˘
 *
kobj
,

81 *
buf„r
, 
loff_t
 
off£t
, 
size_t
 
cou¡
)

83 
˛ass_devi˚
 *
˛ass_dev
 = 
	`to_˛ass_dev
(
kobj
);

84 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

88  
cou¡
;

89 
	}
}

90 
ssize_t
 
	$fúmw¨e_d©a_wrôe
(
kobje˘
 *
kobj
,

91 *
buf„r
, 
loff_t
 
off£t
, 
size_t
 
cou¡
)

93 
˛ass_devi˚
 *
˛ass_dev
 = 
	`to_˛ass_dev
(
kobj
);

94 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

98  
cou¡
;

99 
	}
}

100 
bö_©åibuã
 
	gfúmw¨e_©å_d©a
 = {

101 .
©å
 = {.
«me
 = "d©a", .
	gmode
 = 0644},

102 .
	gsize
 = 0,

103 .
	gªad
 = 
fúmw¨e_d©a_ªad
,

104 .
	gwrôe
 = 
fúmw¨e_d©a_wrôe
,

106 
	$fw_£tup_˛ass_devi˚
(
˛ass_devi˚
 *
˛ass_dev
,

107 c⁄° *
fw_«me
,

108 
devi˚
 *device)

110 
ªtvÆ
 = 0;

111 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`kmÆloc
((firmware_priv),

112 
GFP_KERNEL
);

114 if(!
fw_¥iv
){

115 
ªtvÆ
 = -
ENOMEM
;

116 
out
;

118 
	`mem£t
(
fw_¥iv
, 0, (*fw_priv));

119 
	`mem£t
(
˛ass_dev
, 0, (*class_dev));

121 
	`°∫˝y
(
fw_¥iv
->
fw_id
, 
fw_«me
, 
FIRMWARE_NAME_MAX
);

122 
fw_¥iv
->
fw_id
[
FIRMWARE_NAME_MAX
-1] = '\0';

124 
	`°∫˝y
(
˛ass_dev
->
˛ass_id
, 
devi˚
->
bus_id
, 
BUS_ID_SIZE
);

125 
˛ass_dev
->
˛ass_id
[
BUS_ID_SIZE
-1] = '\0';

126 
˛ass_dev
->
dev
 = 
devi˚
;

128 
˛ass_dev
->
˛ass
 = &
fúmw¨e_˛ass
,

129 
	`˛ass_£t_devd©a
(
˛ass_dev
, 
fw_¥iv
);

130 
ªtvÆ
 = 
	`˛ass_devi˚_ªgi°î
(
˛ass_dev
);

131 i‡(
ªtvÆ
){

132 
	`¥ötk
(
KERN_ERR
 "%s: class_device_register failed\n",

133 
__FUNCTION__
);

134 
îr‹_‰ì_fw_¥iv
;

137 
ªtvÆ
 = 
	`sysfs_¸óã_bö_fûe
(&
˛ass_dev
->
kobj
, &
fúmw¨e_©å_d©a
);

138 i‡(
ªtvÆ
){

139 
	`¥ötk
(
KERN_ERR
 "%s: sysfs_create_bin_file failed\n",

140 
__FUNCTION__
);

141 
îr‹_uƒeg_˛ass_dev
;

144 
ªtvÆ
 = 
	`˛ass_devi˚_¸óã_fûe
(
˛ass_dev
,

145 &
˛ass_devi˚_©å_lﬂdög
);

146 i‡(
ªtvÆ
){

147 
	`¥ötk
(
KERN_ERR
 "%s: class_device_create_file failed\n",

148 
__FUNCTION__
);

149 
îr‹_ªmove_d©a
;

152 
out
;

154 
îr‹_ªmove_d©a
:

155 
	`sysfs_ªmove_bö_fûe
(&
˛ass_dev
->
kobj
, &
fúmw¨e_©å_d©a
);

156 
îr‹_uƒeg_˛ass_dev
:

157 
	`˛ass_devi˚_uƒegi°î
(
˛ass_dev
);

158 
îr‹_‰ì_fw_¥iv
:

159 
	`k‰ì
(
fw_¥iv
);

160 
out
:

161  
ªtvÆ
;

162 
	}
}

163 
	$fw_ªmove_˛ass_devi˚
(
˛ass_devi˚
 *
˛ass_dev
)

165 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

167 
	`˛ass_devi˚_ªmove_fûe
(
˛ass_dev
, &
˛ass_devi˚_©å_lﬂdög
);

168 
	`sysfs_ªmove_bö_fûe
(&
˛ass_dev
->
kobj
, &
fúmw¨e_©å_d©a
);

169 
	`˛ass_devi˚_uƒegi°î
(
˛ass_dev
);

170 
	}
}

172 
˛ass_devi˚
 *
	g˛ass_dev
;

174 
devi˚
 
	gmy_devi˚
 = {

175 .
bus_id
 = "my_dev0",

178 
__öô
 
	$fúmw¨e_ßm∂e_öô
()

180 
îr‹
;

182 
	`devi˚_öôülize
(&
my_devi˚
);

183 
˛ass_dev
 = 
	`kmÆloc
((
˛ass_devi˚
), 
GFP_KERNEL
);

184 if(!
˛ass_dev
)

185  -
ENOMEM
;

187 
îr‹
 = 
	`fw_£tup_˛ass_devi˚
(
˛ass_dev
, "my_firmware_image",

188 &
my_devi˚
);

189 if(
îr‹
){

190 
	`k‰ì
(
˛ass_dev
);

191  
îr‹
;

195 
	}
}

196 
__exô
 
	$fúmw¨e_ßm∂e_exô
()

198 
fúmw¨e_¥iv
 *
fw_¥iv
 = 
	`˛ass_gë_devd©a
(
˛ass_dev
);

199 
	`fw_ªmove_˛ass_devi˚
(
˛ass_dev
);

200 
	`k‰ì
(
fw_¥iv
);

201 
	`k‰ì
(
˛ass_dev
);

202 
	}
}

203 
moduÀ_öô
(
fúmw¨e_ßm∂e_öô
);

204 
moduÀ_exô
(
fúmw¨e_ßm∂e_exô
);

	@Documentation/ia64/aliasing-test.c

12 
	~<°dlib.h
>

13 
	~<°dio.h
>

14 
	~<sys/ty≥s.h
>

15 
	~<dúít.h
>

16 
	~<f˙é.h
>

17 
	~<‚m©ch.h
>

18 
	~<°rög.h
>

19 
	~<sys/mm™.h
>

20 
	~<sys/°©.h
>

21 
	~<uni°d.h
>

23 
	gsum
;

25 
	$m≠_mem
(*
∑th
, 
off_t
 
off£t
, 
size_t
 
Àngth
, 
touch
)

27 
fd
, 
rc
;

28 *
addr
;

29 *
c
;

31 
fd
 = 
	`›í
(
∑th
, 
O_RDWR
);

32 i‡(
fd
 == -1) {

33 
	`≥º‹
(
∑th
);

37 
addr
 = 
	`mm≠
(
NULL
, 
Àngth
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
fd
, 
off£t
);

38 i‡(
addr
 =
MAP_FAILED
)

41 i‡(
touch
) {

42 
c
 = (*Ë
addr
;

43 
c
 < (*Ë(
off£t
 + 
Àngth
))

44 
sum
 +*
c
++;

47 
rc
 = 
	`munm≠
(
addr
, 
Àngth
);

48 i‡(
rc
 == -1) {

49 
	`≥º‹
("munmap");

53 
	`˛o£
(
fd
);

55 
	}
}

57 
	$sˇn_sysfs
(*
∑th
, *
fûe
, 
off_t
 
off£t
, 
size_t
 
Àngth
, 
touch
)

59 
dúít
 **
«mñi°
;

60 *
«me
, *
∑th2
;

61 
i
, 
n
, 
r
, 
rc
, 
ªsu…
 = 0;

62 
°©
 
buf
;

64 
n
 = 
	`sˇndú
(
∑th
, &
«mñi°
, 0, 
Æphas‹t
);

65 i‡(
n
 < 0) {

66 
	`≥º‹
("scandir");

70 
i
 = 0; i < 
n
; i++) {

71 
«me
 = 
«mñi°
[
i
]->
d_«me
;

73 i‡(
	`‚m©ch
(".", 
«me
, 0) == 0)

74 
skù
;

75 i‡(
	`‚m©ch
("..", 
«me
, 0) == 0)

76 
skù
;

78 
∑th2
 = 
	`mÆloc
(
	`°æí
(
∑th
Ë+ såÀn(
«me
) + 3);

79 
	`°r˝y
(
∑th2
, 
∑th
);

80 
	`°rˇt
(
∑th2
, "/");

81 
	`°rˇt
(
∑th2
, 
«me
);

83 i‡(
	`‚m©ch
(
fûe
, 
«me
, 0) == 0) {

84 
rc
 = 
	`m≠_mem
(
∑th2
, 
off£t
, 
Àngth
, 
touch
);

85 i‡(
rc
 == 0)

86 
	`Ârötf
(
°dîr
, "PASS: %†0x%lx-0x%lx i†%s\n", 
∑th2
, 
off£t
, off£à+ 
Àngth
, 
touch
 ? "readable" : "mappable");

87 i‡(
rc
 > 0)

88 
	`Ârötf
(
°dîr
, "PASS: %†0x%lx-0x%lxÇŸ m≠∑bÀ\n", 
∑th2
, 
off£t
, off£à+ 
Àngth
);

90 
	`Ârötf
(
°dîr
, "FAIL: %†0x%lx-0x%lxÇŸác˚ssibÀ\n", 
∑th2
, 
off£t
, off£à+ 
Àngth
);

91  
rc
;

94 
r
 = 
	`l°©
(
∑th2
, &
buf
);

95 i‡(
r
 =0 && 
	`S_ISDIR
(
buf
.
°_mode
)) {

96 
rc
 = 
	`sˇn_sysfs
(
∑th2
, 
fûe
, 
off£t
, 
Àngth
, 
touch
);

97 i‡(
rc
 < 0)

98  
rc
;

102 
ªsu…
 |
rc
;

103 
	`‰ì
(
∑th2
);

105 
skù
:

106 
	`‰ì
(
«mñi°
[
i
]);

108 
	`‰ì
(
«mñi°
);

109  
rc
;

110 
	}
}

112 
	gbuf
[1024];

114 
	$ªad_rom
(*
∑th
)

116 
fd
, 
rc
;

117 
size_t
 
size
 = 0;

119 
fd
 = 
	`›í
(
∑th
, 
O_RDWR
);

120 i‡(
fd
 == -1) {

121 
	`≥º‹
(
∑th
);

125 
rc
 = 
	`wrôe
(
fd
, "1", 2);

126 i‡(
rc
 <= 0) {

127 
	`≥º‹
("write");

132 
rc
 = 
	`ªad
(
fd
, 
buf
, (buf));

133 i‡(
rc
 > 0)

134 
size
 +
rc
;

135 } 
rc
 > 0);

137 
	`˛o£
(
fd
);

138  
size
;

139 
	}
}

141 
	$sˇn_rom
(*
∑th
, *
fûe
)

143 
dúít
 **
«mñi°
;

144 *
«me
, *
∑th2
;

145 
i
, 
n
, 
r
, 
rc
, 
ªsu…
 = 0;

146 
°©
 
buf
;

148 
n
 = 
	`sˇndú
(
∑th
, &
«mñi°
, 0, 
Æphas‹t
);

149 i‡(
n
 < 0) {

150 
	`≥º‹
("scandir");

154 
i
 = 0; i < 
n
; i++) {

155 
«me
 = 
«mñi°
[
i
]->
d_«me
;

157 i‡(
	`‚m©ch
(".", 
«me
, 0) == 0)

158 
skù
;

159 i‡(
	`‚m©ch
("..", 
«me
, 0) == 0)

160 
skù
;

162 
∑th2
 = 
	`mÆloc
(
	`°æí
(
∑th
Ë+ såÀn(
«me
) + 3);

163 
	`°r˝y
(
∑th2
, 
∑th
);

164 
	`°rˇt
(
∑th2
, "/");

165 
	`°rˇt
(
∑th2
, 
«me
);

167 i‡(
	`‚m©ch
(
fûe
, 
«me
, 0) == 0) {

168 
rc
 = 
	`ªad_rom
(
∑th2
);

175 i‡(
rc
 > 0)

176 
	`Ârötf
(
°dîr
, "PASS: %†ªad %ld byãs\n", 
∑th2
, 
rc
);

178 
	`Ârötf
(
°dîr
, "PASS: %†nŸÑódabÀ\n", 
∑th2
);

179  
rc
;

182 
r
 = 
	`l°©
(
∑th2
, &
buf
);

183 i‡(
r
 =0 && 
	`S_ISDIR
(
buf
.
°_mode
)) {

184 
rc
 = 
	`sˇn_rom
(
∑th2
, 
fûe
);

185 i‡(
rc
 < 0)

186  
rc
;

190 
ªsu…
 |
rc
;

191 
	`‰ì
(
∑th2
);

193 
skù
:

194 
	`‰ì
(
«mñi°
[
i
]);

196 
	`‰ì
(
«mñi°
);

197  
rc
;

198 
	}
}

200 
	$maö
()

202 
rc
;

204 i‡(
	`m≠_mem
("/dev/mem", 0, 0xA0000, 1) == 0)

205 
	`Ârötf
(
°dîr
, "PASS: /dev/mem 0x0-0xa0000 isÑeadable\n");

207 
	`Ârötf
(
°dîr
, "FAIL: /dev/mem 0x0-0xa0000Çotáccessible\n");

216 i‡(
	`m≠_mem
("/dev/mem", 0xA0000, 0x20000, 0) == 0)

217 
	`Ârötf
(
°dîr
, "PASS: /dev/mem 0xa0000-0xc0000 is mappable\n");

219 
	`Ârötf
(
°dîr
, "FAIL: /dev/mem 0xa0000-0xc0000Çotáccessible\n");

221 i‡(
	`m≠_mem
("/dev/mem", 0xC0000, 0x40000, 1) == 0)

222 
	`Ârötf
(
°dîr
, "PASS: /dev/mem 0xc0000-0x100000 isÑeadable\n");

224 
	`Ârötf
(
°dîr
, "FAIL: /dev/mem 0xc0000-0x100000Çotáccessible\n");

233 
rc
 = 
	`m≠_mem
("/dev/mem", 0, 1024*1024, 0);

234 i‡(
rc
 == 0)

235 
	`Ârötf
(
°dîr
, "PASS: /dev/mem 0x0-0x100000 is mappable\n");

236 i‡(
rc
 > 0)

237 
	`Ârötf
(
°dîr
, "PASS: /dev/mem 0x0-0x100000Çot mappable\n");

239 
	`Ârötf
(
°dîr
, "FAIL: /dev/mem 0x0-0x100000Çotáccessible\n");

241 
	`sˇn_sysfs
("/sys/class/pci_bus", "legacy_mem", 0, 0xA0000, 1);

242 
	`sˇn_sysfs
("/sys/class/pci_bus", "legacy_mem", 0xA0000, 0x20000, 0);

243 
	`sˇn_sysfs
("/sys/class/pci_bus", "legacy_mem", 0xC0000, 0x40000, 1);

244 
	`sˇn_sysfs
("/sys/class/pci_bus", "legacy_mem", 0, 1024*1024, 0);

246 
	`sˇn_rom
("/sys/devices", "rom");

247 
	}
}

	@Documentation/networking/ifenslave.c

97 
	#APP_VERSION
 "1.1.0"

	)

98 
	#APP_RELDATE
 "De˚mbî 1, 2003"

	)

99 
	#APP_NAME
 "i„n¶ave"

	)

101 *
	gvîsi⁄
 =

102 
APP_NAME
 ".c:v" 
APP_VERSION
 " (" 
APP_RELDATE
 ")\n"

108 c⁄° *
	gußge_msg
 =

114 c⁄° *
	ghñp_msg
 =

150 
	~<uni°d.h
>

151 
	~<°dlib.h
>

152 
	~<°dio.h
>

153 
	~<˘y≥.h
>

154 
	~<°rög.h
>

155 
	~<î∫o.h
>

156 
	~<f˙é.h
>

157 
	~<gë›t.h
>

158 
	~<sys/ty≥s.h
>

159 
	~<sys/sockë.h
>

160 
	~<sys/io˘l.h
>

161 
	~<löux/if.h
>

162 
	~<√t/if_¨p.h
>

163 
	~<löux/if_ëhî.h
>

164 
	~<löux/if_b⁄dög.h
>

165 
	~<löux/sockios.h
>

167 
	tu64
;

168 
__uöt32_t
 
	tu32
;

169 
__uöt16_t
 
	tu16
;

170 
__uöt8_t
 
	tu8
;

171 
	~<löux/ëhtoﬁ.h
>

173 
›ti⁄
 
	gl⁄g›ts
[] = {

188 
	g›t_a
 = 0,

189 
	g›t_c
 = 0,

190 
	g›t_d
 = 0,

191 
	g›t_f
 = 0,

192 
	g›t_h
 = 0,

193 
	g›t_u
 = 0,

194 
	g›t_v
 = 0,

195 
	g›t_V
 = 0;

197 
	gskfd
 = -1;

198 
	gabi_vî
 = 0;

199 
	ghwaddr_£t
 = 0;

200 
	gßved_î∫o
;

202 
i‰eq
 
	gma°î_mtu
, 
	gma°î_Êags
, 
	gma°î_hwaddr
;

203 
i‰eq
 
	g¶ave_mtu
, 
	g¶ave_Êags
, 
	g¶ave_hwaddr
;

205 
	sdev_i‰
 {

206 
i‰eq
 *
	mªq_i‰
;

207 *
	mªq_«me
;

208 
	mªq_ty≥
;

211 
dev_i‰
 
	gma°î_i‰a
[] = {

212 {&
ma°î_mtu
, "SIOCGIFMTU", 
SIOCGIFMTU
},

213 {&
ma°î_Êags
, "SIOCGIFFLAGS", 
SIOCGIFFLAGS
},

214 {&
ma°î_hwaddr
, "SIOCGIFHWADDR", 
SIOCGIFHWADDR
},

215 {
NULL
, "", 0}

218 
dev_i‰
 
	g¶ave_i‰a
[] = {

219 {&
¶ave_mtu
, "SIOCGIFMTU", 
SIOCGIFMTU
},

220 {&
¶ave_Êags
, "SIOCGIFFLAGS", 
SIOCGIFFLAGS
},

221 {&
¶ave_hwaddr
, "SIOCGIFHWADDR", 
SIOCGIFHWADDR
},

222 {
NULL
, "", 0}

225 
if_¥öt
(*
i‚ame
);

226 
gë_drv_öfo
(*
ma°î_i‚ame
);

227 
gë_if_£âögs
(*
i‚ame
, 
dev_i‰
 
i‰a
[]);

228 
gë_¶ave_Êags
(*
¶ave_i‚ame
);

229 
£t_ma°î_hwaddr
(*
ma°î_i‚ame
, 
sockaddr
 *
hwaddr
);

230 
£t_¶ave_hwaddr
(*
¶ave_i‚ame
, 
sockaddr
 *
hwaddr
);

231 
£t_¶ave_mtu
(*
¶ave_i‚ame
, 
mtu
);

232 
£t_if_Êags
(*
i‚ame
, 
Êags
);

233 
£t_if_up
(*
i‚ame
, 
Êags
);

234 
£t_if_down
(*
i‚ame
, 
Êags
);

235 
˛ór_if_addr
(*
i‚ame
);

236 
£t_if_addr
(*
ma°î_i‚ame
, *
¶ave_i‚ame
);

237 
ch™ge_a˘ive
(*
ma°î_i‚ame
, *
¶ave_i‚ame
);

238 
í¶ave
(*
ma°î_i‚ame
, *
¶ave_i‚ame
);

239 
ªÀa£
(*
ma°î_i‚ame
, *
¶ave_i‚ame
);

240 
	#v_¥öt
(
fmt
, 
¨gs
...) \

241 i‡(
›t_v
) \

242 
	`Ârötf
(
°dîr
, 
fmt
, ## 
¨gs
 )

	)

244 
	$maö
(
¨gc
, *
¨gv
[])

246 **
•p
, *
ma°î_i‚ame
, *
¶ave_i‚ame
;

247 
c
, 
i
, 
rv
;

248 
ªs
 = 0;

249 
ex˛usive
 = 0;

251 (
c
 = 
	`gë›t_l⁄g
(
¨gc
, 
¨gv
, "acdfhuvV", 
l⁄g›ts
, 0)Ë!
EOF
) {

252 
c
) {

253 'a': 
›t_a
++; 
ex˛usive
++; ;

254 'c': 
›t_c
++; 
ex˛usive
++; ;

255 'd': 
›t_d
++; 
ex˛usive
++; ;

256 'f': 
›t_f
++; 
ex˛usive
++; ;

257 'h': 
›t_h
++; 
ex˛usive
++; ;

258 'u': 
›t_u
++; 
ex˛usive
++; ;

259 'v': 
›t_v
++; ;

260 'V': 
›t_V
++; 
ex˛usive
++; ;

263 
	`Ârötf
(
°dîr
, 
ußge_msg
);

264 
ªs
 = 2;

265 
out
;

270 i‡(
ex˛usive
 > 1) {

271 
	`Ârötf
(
°dîr
, 
ußge_msg
);

272 
ªs
 = 2;

273 
out
;

276 i‡(
›t_v
 || 
›t_V
) {

277 
	`¥ötf
(
vîsi⁄
);

278 i‡(
›t_V
) {

279 
ªs
 = 0;

280 
out
;

284 i‡(
›t_u
) {

285 
	`¥ötf
(
ußge_msg
);

286 
ªs
 = 0;

287 
out
;

290 i‡(
›t_h
) {

291 
	`¥ötf
(
ußge_msg
);

292 
	`¥ötf
(
hñp_msg
);

293 
ªs
 = 0;

294 
out
;

298 i‡((
skfd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

299 
	`≥º‹
("socket");

300 
ªs
 = 1;

301 
out
;

304 i‡(
›t_a
) {

305 i‡(
›töd
 =
¨gc
) {

308 
	`if_¥öt
((*)
NULL
);

309 
out
;

312 
	`Ârötf
(
°dîr
, 
ußge_msg
);

313 
ªs
 = 2;

314 
out
;

319 
•p
 = 
¨gv
 + 
›töd
;

320 
ma°î_i‚ame
 = *
•p
++;

322 i‡(
ma°î_i‚ame
 =
NULL
) {

323 
	`Ârötf
(
°dîr
, 
ußge_msg
);

324 
ªs
 = 2;

325 
out
;

329 
ªs
 = 
	`gë_drv_öfo
(
ma°î_i‚ame
);

330 i‡(
ªs
) {

331 
	`Ârötf
(
°dîr
,

334 
ma°î_i‚ame
);

335 
out
;

338 
¶ave_i‚ame
 = *
•p
++;

340 i‡(
¶ave_i‚ame
 =
NULL
) {

341 i‡(
›t_d
 || 
›t_c
) {

342 
	`Ârötf
(
°dîr
, 
ußge_msg
);

343 
ªs
 = 2;

344 
out
;

350 
	`if_¥öt
(
ma°î_i‚ame
);

351 
out
;

354 
ªs
 = 
	`gë_if_£âögs
(
ma°î_i‚ame
, 
ma°î_i‰a
);

355 i‡(
ªs
) {

357 
	`Ârötf
(
°dîr
,

360 
ma°î_i‚ame
, 
	`°ªº‹
(
ªs
));

361 
out
;

367 i‡(!(
ma°î_Êags
.
i‰_Êags
 & 
IFF_MASTER
)) {

368 
	`Ârötf
(
°dîr
,

371 
ma°î_i‚ame
);

372 
ªs
 = 1;

373 
out
;

377 i‡(!(
ma°î_Êags
.
i‰_Êags
 & 
IFF_UP
)) {

378 
	`Ârötf
(
°dîr
,

381 
ma°î_i‚ame
);

382 
ªs
 = 1;

383 
out
;

387 i‡(!
›t_c
 && !
›t_d
) {

388 
ß_Ámûy_t
 
ma°î_Ámûy
 = 
ma°î_hwaddr
.
i‰_hwaddr
.
ß_Ámûy
;

389 *
hwaddr
 =

390 (*)
ma°î_hwaddr
.
i‰_hwaddr
.
ß_d©a
;

393 i‡(
ma°î_Ámûy
 !1 && !
›t_f
) {

394 
	`Ârötf
(
°dîr
,

401 
ma°î_i‚ame
);

402 
ªs
 = 1;

403 
out
;

407 
i
 = 0; i < 6; i++) {

408 i‡(
hwaddr
[
i
] != 0) {

409 
hwaddr_£t
 = 1;

414 i‡(
hwaddr_£t
) {

415 
	`v_¥öt
("current hardwareáddress of master '%s' "

418 
ma°î_i‚ame
,

419 
hwaddr
[0], hwaddr[1],

420 
hwaddr
[2], hwaddr[3],

421 
hwaddr
[4], hwaddr[5],

422 
ma°î_Ámûy
);

427 i‡(
›t_c
) {

429 
ªs
 = 
	`gë_¶ave_Êags
(
¶ave_i‚ame
);

430 i‡(
ªs
) {

431 
	`Ârötf
(
°dîr
,

434 
¶ave_i‚ame
);

435 
out
;

437 
ªs
 = 
	`ch™ge_a˘ive
(
ma°î_i‚ame
, 
¶ave_i‚ame
);

438 i‡(
ªs
) {

439 
	`Ârötf
(
°dîr
,

442 
ma°î_i‚ame
, 
¶ave_i‚ame
);

447 i‡(
›t_d
) {

449 
rv
 = 
	`gë_¶ave_Êags
(
¶ave_i‚ame
);

450 i‡(
rv
) {

453 
	`Ârötf
(
°dîr
,

456 
¶ave_i‚ame
);

457 
ªs
 = 
rv
;

460 
rv
 = 
	`ªÀa£
(
ma°î_i‚ame
, 
¶ave_i‚ame
);

461 i‡(
rv
) {

462 
	`Ârötf
(
°dîr
,

465 
ma°î_i‚ame
, 
¶ave_i‚ame
);

466 
ªs
 = 
rv
;

470 
rv
 = 
	`gë_if_£âögs
(
¶ave_i‚ame
, 
¶ave_i‰a
);

471 i‡(
rv
) {

474 
	`Ârötf
(
°dîr
,

478 
¶ave_i‚ame
, 
	`°ªº‹
(
rv
));

479 
ªs
 = 
rv
;

482 
rv
 = 
	`í¶ave
(
ma°î_i‚ame
, 
¶ave_i‚ame
);

483 i‡(
rv
) {

484 
	`Ârötf
(
°dîr
,

487 
ma°î_i‚ame
, 
¶ave_i‚ame
);

488 
ªs
 = 
rv
;

491 } (
¶ave_i‚ame
 = *
•p
++Ë!
NULL
);

494 
out
:

495 i‡(
skfd
 >= 0) {

496 
	`˛o£
(
skfd
);

499  
ªs
;

500 
	}
}

502 
	gmif_Êags
;

505 
	$if_gëc⁄fig
(*
i‚ame
)

507 
i‰eq
 
i‰
;

508 
mëric
, 
mtu
;

509 
sockaddr
 
d°addr
, 
brﬂdaddr
, 
√tmask
;

510 *
hwaddr
;

512 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

513 i‡(
	`io˘l
(
skfd
, 
SIOCGIFFLAGS
, &
i‰
) < 0)

515 
mif_Êags
 = 
i‰
.
i‰_Êags
;

516 
	`¥ötf
("TheÑesult of SIOCGIFFLAGS on %s is %x.\n",

517 
i‚ame
, 
i‰
.
i‰_Êags
);

519 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

520 i‡(
	`io˘l
(
skfd
, 
SIOCGIFADDR
, &
i‰
) < 0)

522 
	`¥ötf
("TheÑesult of SIOCGIFADDR is %2.2x.%2.2x.%2.2x.%2.2x.\n",

523 
i‰
.
i‰_addr
.
ß_d©a
[0], ifr.ifr_addr.sa_data[1],

524 
i‰
.
i‰_addr
.
ß_d©a
[2], ifr.ifr_addr.sa_data[3]);

526 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

527 i‡(
	`io˘l
(
skfd
, 
SIOCGIFHWADDR
, &
i‰
) < 0)

531 
hwaddr
 = (*)
i‰
.
i‰_hwaddr
.
ß_d©a
;

532 
	`¥ötf
("TheÑesult of SIOCGIFHWADDR isÅype %d "

534 
i‰
.
i‰_hwaddr
.
ß_Ámûy
, 
hwaddr
[0], hwaddr[1],

535 
hwaddr
[2], hwaddr[3], hwaddr[4], hwaddr[5]);

537 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

538 i‡(
	`io˘l
(
skfd
, 
SIOCGIFMETRIC
, &
i‰
) < 0) {

539 
mëric
 = 0;

541 
mëric
 = 
i‰
.
i‰_mëric
;

543 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

544 i‡(
	`io˘l
(
skfd
, 
SIOCGIFMTU
, &
i‰
) < 0)

545 
mtu
 = 0;

547 
mtu
 = 
i‰
.
i‰_mtu
;

549 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

550 i‡(
	`io˘l
(
skfd
, 
SIOCGIFDSTADDR
, &
i‰
) < 0) {

551 
	`mem£t
(&
d°addr
, 0, (
sockaddr
));

553 
d°addr
 = 
i‰
.
i‰_d°addr
;

555 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

556 i‡(
	`io˘l
(
skfd
, 
SIOCGIFBRDADDR
, &
i‰
) < 0) {

557 
	`mem£t
(&
brﬂdaddr
, 0, (
sockaddr
));

559 
brﬂdaddr
 = 
i‰
.
i‰_brﬂdaddr
;

561 
	`°r˝y
(
i‰
.
i‰_«me
, 
i‚ame
);

562 i‡(
	`io˘l
(
skfd
, 
SIOCGIFNETMASK
, &
i‰
) < 0) {

563 
	`mem£t
(&
√tmask
, 0, (
sockaddr
));

565 
√tmask
 = 
i‰
.
i‰_√tmask
;

568 
	}
}

570 
	$if_¥öt
(*
i‚ame
)

572 
buff
[1024];

573 
ifc⁄f
 
ifc
;

574 
i‰eq
 *
i‰
;

575 
i
;

577 i‡(
i‚ame
 =(*)
NULL
) {

578 
ifc
.
ifc_Àn
 = (
buff
);

579 
ifc
.
ifc_buf
 = 
buff
;

580 i‡(
	`io˘l
(
skfd
, 
SIOCGIFCONF
, &
ifc
) < 0) {

581 
	`≥º‹
("SIOCGIFCONF failed");

585 
i‰
 = 
ifc
.
ifc_ªq
;

586 
i
 = 
ifc
.
ifc_Àn
 / (
i‰eq
); --ò>0; 
i‰
++) {

587 i‡(
	`if_gëc⁄fig
(
i‰
->
i‰_«me
) < 0) {

588 
	`Ârötf
(
°dîr
,

590 
i‰
->
i‰_«me
);

594 i‡(((
mif_Êags
 & 
IFF_UP
Ë=0Ë&& !
›t_a
) ;

598 i‡(
	`if_gëc⁄fig
(
i‚ame
) < 0) {

599 
	`Ârötf
(
°dîr
,

600 "%s: unknow¿öãrÁ˚.\n", 
i‚ame
);

603 
	}
}

605 
	$gë_drv_öfo
(*
ma°î_i‚ame
)

607 
i‰eq
 
i‰
;

608 
ëhtoﬁ_drvöfo
 
öfo
;

609 *
íd±r
;

611 
	`mem£t
(&
i‰
, 0, (ifr));

612 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

613 
i‰
.
i‰_d©a
 = (
ˇddr_t
)&
öfo
;

615 
öfo
.
cmd
 = 
ETHTOOL_GDRVINFO
;

616 
	`°∫˝y
(
öfo
.
drivî
, "ifenslave", 32);

617 
	`¢¥ötf
(
öfo
.
fw_vîsi⁄
, 32, "%d", 
BOND_ABI_VERSION
);

619 i‡(
	`io˘l
(
skfd
, 
SIOCETHTOOL
, &
i‰
) < 0) {

620 i‡(
î∫o
 =
EOPNOTSUPP
) {

621 
out
;

624 
ßved_î∫o
 = 
î∫o
;

625 
	`v_¥öt
("Master '%s': Error: get bonding info failed %s\n",

626 
ma°î_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

630 
abi_vî
 = 
	`°πoul
(
öfo
.
fw_vîsi⁄
, &
íd±r
, 0);

631 i‡(*
íd±r
) {

632 
	`v_¥öt
("Master '%s': Error: got invalid stringásán ABI "

634 
ma°î_i‚ame
);

638 
out
:

639 
	`v_¥öt
("ABI vî i†%d\n", 
abi_vî
);

642 
	}
}

644 
	$ch™ge_a˘ive
(*
ma°î_i‚ame
, *
¶ave_i‚ame
)

646 
i‰eq
 
i‰
;

647 
ªs
 = 0;

649 i‡(!(
¶ave_Êags
.
i‰_Êags
 & 
IFF_SLAVE
)) {

650 
	`Ârötf
(
°dîr
,

653 
¶ave_i‚ame
);

657 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

658 
	`°∫˝y
(
i‰
.
i‰_¶ave
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

659 i‡((
	`io˘l
(
skfd
, 
SIOCBONDCHANGEACTIVE
, &
i‰
) < 0) &&

660 (
	`io˘l
(
skfd
, 
BOND_CHANGE_ACTIVE_OLD
, &
i‰
) < 0)) {

661 
ßved_î∫o
 = 
î∫o
;

662 
	`v_¥öt
("Master '%s': Error: SIOCBONDCHANGEACTIVE failed: "

664 
ma°î_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

665 
ªs
 = 1;

668  
ªs
;

669 
	}
}

671 
	$í¶ave
(*
ma°î_i‚ame
, *
¶ave_i‚ame
)

673 
i‰eq
 
i‰
;

674 
ªs
 = 0;

676 i‡(
¶ave_Êags
.
i‰_Êags
 & 
IFF_SLAVE
) {

677 
	`Ârötf
(
°dîr
,

680 
¶ave_i‚ame
);

684 
ªs
 = 
	`£t_if_down
(
¶ave_i‚ame
, 
¶ave_Êags
.
i‰_Êags
);

685 i‡(
ªs
) {

686 
	`Ârötf
(
°dîr
,

688 
¶ave_i‚ame
);

689  
ªs
;

692 i‡(
abi_vî
 < 2) {

696 
	`£t_if_addr
(
ma°î_i‚ame
, 
¶ave_i‚ame
);

698 
ªs
 = 
	`˛ór_if_addr
(
¶ave_i‚ame
);

699 i‡(
ªs
) {

700 
	`Ârötf
(
°dîr
,

702 
¶ave_i‚ame
);

703  
ªs
;

707 i‡(
ma°î_mtu
.
i‰_mtu
 !
¶ave_mtu
.ifr_mtu) {

708 
ªs
 = 
	`£t_¶ave_mtu
(
¶ave_i‚ame
, 
ma°î_mtu
.
i‰_mtu
);

709 i‡(
ªs
) {

710 
	`Ârötf
(
°dîr
,

712 
¶ave_i‚ame
);

713  
ªs
;

717 i‡(
hwaddr_£t
) {

721 i‡(
abi_vî
 < 1) {

726 
ªs
 = 
	`£t_¶ave_hwaddr
(
¶ave_i‚ame
,

727 &(
ma°î_hwaddr
.
i‰_hwaddr
));

728 i‡(
ªs
) {

729 
	`Ârötf
(
°dîr
,

732 
¶ave_i‚ame
);

733 
undo_mtu
;

739 
ªs
 = 
	`£t_if_up
(
¶ave_i‚ame
, 
¶ave_Êags
.
i‰_Êags
);

740 i‡(
ªs
) {

741 
	`Ârötf
(
°dîr
,

744 
¶ave_i‚ame
);

745 
undo_¶ave_mac
;

757 i‡(
abi_vî
 < 1) {

761 
ªs
 = 
	`£t_if_down
(
ma°î_i‚ame
, 
ma°î_Êags
.
i‰_Êags
);

762 i‡(
ªs
) {

763 
	`Ârötf
(
°dîr
,

766 
ma°î_i‚ame
);

767 
undo_mtu
;

771 
ªs
 = 
	`£t_ma°î_hwaddr
(
ma°î_i‚ame
,

772 &(
¶ave_hwaddr
.
i‰_hwaddr
));

773 i‡(
ªs
) {

774 
	`Ârötf
(
°dîr
,

777 
ma°î_i‚ame
);

778 
undo_mtu
;

781 i‡(
abi_vî
 < 1) {

785 
ªs
 = 
	`£t_if_up
(
ma°î_i‚ame
, 
ma°î_Êags
.
i‰_Êags
);

786 i‡(
ªs
) {

787 
	`Ârötf
(
°dîr
,

790 
ma°î_i‚ame
);

791 
undo_ma°î_mac
;

795 
hwaddr_£t
 = 1;

799 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

800 
	`°∫˝y
(
i‰
.
i‰_¶ave
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

801 i‡((
	`io˘l
(
skfd
, 
SIOCBONDENSLAVE
, &
i‰
) < 0) &&

802 (
	`io˘l
(
skfd
, 
BOND_ENSLAVE_OLD
, &
i‰
) < 0)) {

803 
ßved_î∫o
 = 
î∫o
;

804 
	`v_¥öt
("Master '%s': Error: SIOCBONDENSLAVE failed: %s\n",

805 
ma°î_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

806 
ªs
 = 1;

809 i‡(
ªs
) {

810 
undo_ma°î_mac
;

816 
undo_ma°î_mac
:

817 
	`£t_ma°î_hwaddr
(
ma°î_i‚ame
, &(
ma°î_hwaddr
.
i‰_hwaddr
));

818 
hwaddr_£t
 = 0;

819 
undo_mtu
;

820 
undo_¶ave_mac
:

821 
	`£t_¶ave_hwaddr
(
¶ave_i‚ame
, &(
¶ave_hwaddr
.
i‰_hwaddr
));

822 
undo_mtu
:

823 
	`£t_¶ave_mtu
(
¶ave_i‚ame
, 
¶ave_mtu
.
i‰_mtu
);

824  
ªs
;

825 
	}
}

827 
	$ªÀa£
(*
ma°î_i‚ame
, *
¶ave_i‚ame
)

829 
i‰eq
 
i‰
;

830 
ªs
 = 0;

832 i‡(!(
¶ave_Êags
.
i‰_Êags
 & 
IFF_SLAVE
)) {

833 
	`Ârötf
(
°dîr
,

836 
¶ave_i‚ame
);

840 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

841 
	`°∫˝y
(
i‰
.
i‰_¶ave
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

842 i‡((
	`io˘l
(
skfd
, 
SIOCBONDRELEASE
, &
i‰
) < 0) &&

843 (
	`io˘l
(
skfd
, 
BOND_RELEASE_OLD
, &
i‰
) < 0)) {

844 
ßved_î∫o
 = 
î∫o
;

845 
	`v_¥öt
("Master '%s': Error: SIOCBONDRELEASE failed: %s\n",

846 
ma°î_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

848 } i‡(
abi_vî
 < 1) {

852 
ªs
 = 
	`£t_if_down
(
¶ave_i‚ame
, 
¶ave_Êags
.
i‰_Êags
);

853 i‡(
ªs
) {

854 
	`Ârötf
(
°dîr
,

857 
¶ave_i‚ame
);

862 
	`£t_¶ave_mtu
(
¶ave_i‚ame
, 1500);

864  
ªs
;

865 
	}
}

867 
	$gë_if_£âögs
(*
i‚ame
, 
dev_i‰
 
i‰a
[])

869 
i
;

870 
ªs
 = 0;

872 
i
 = 0; 
i‰a
[i].
ªq_i‰
; i++) {

873 
	`°∫˝y
(
i‰a
[
i
].
ªq_i‰
->
i‰_«me
, 
i‚ame
, 
IFNAMSIZ
);

874 
ªs
 = 
	`io˘l
(
skfd
, 
i‰a
[
i
].
ªq_ty≥
, i‰a[i].
ªq_i‰
);

875 i‡(
ªs
 < 0) {

876 
ßved_î∫o
 = 
î∫o
;

877 
	`v_¥öt
("Interface '%s': Error: %s failed: %s\n",

878 
i‚ame
, 
i‰a
[
i
].
ªq_«me
,

879 
	`°ªº‹
(
ßved_î∫o
));

881  
ßved_î∫o
;

886 
	}
}

888 
	$gë_¶ave_Êags
(*
¶ave_i‚ame
)

890 
ªs
 = 0;

892 
	`°∫˝y
(
¶ave_Êags
.
i‰_«me
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

893 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCGIFFLAGS
, &
¶ave_Êags
);

894 i‡(
ªs
 < 0) {

895 
ßved_î∫o
 = 
î∫o
;

896 
	`v_¥öt
("Slave '%s': Error: SIOCGIFFLAGS failed: %s\n",

897 
¶ave_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

899 
	`v_¥öt
("Slave %s: flags %04X.\n",

900 
¶ave_i‚ame
, 
¶ave_Êags
.
i‰_Êags
);

903  
ªs
;

904 
	}
}

906 
	$£t_ma°î_hwaddr
(*
ma°î_i‚ame
, 
sockaddr
 *
hwaddr
)

908 *
addr
 = (*)
hwaddr
->
ß_d©a
;

909 
i‰eq
 
i‰
;

910 
ªs
 = 0;

912 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

913 
	`mem˝y
(&(
i‰
.
i‰_hwaddr
), 
hwaddr
, (
sockaddr
));

914 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCSIFHWADDR
, &
i‰
);

915 i‡(
ªs
 < 0) {

916 
ßved_î∫o
 = 
î∫o
;

917 
	`v_¥öt
("Master '%s': Error: SIOCSIFHWADDR failed: %s\n",

918 
ma°î_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

919  
ªs
;

921 
	`v_¥öt
("Master '%s': hardwareáddress setÅo "

923 
ma°î_i‚ame
, 
addr
[0],áddr[1],áddr[2],

924 
addr
[3],áddr[4],áddr[5]);

927  
ªs
;

928 
	}
}

930 
	$£t_¶ave_hwaddr
(*
¶ave_i‚ame
, 
sockaddr
 *
hwaddr
)

932 *
addr
 = (*)
hwaddr
->
ß_d©a
;

933 
i‰eq
 
i‰
;

934 
ªs
 = 0;

936 
	`°∫˝y
(
i‰
.
i‰_«me
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

937 
	`mem˝y
(&(
i‰
.
i‰_hwaddr
), 
hwaddr
, (
sockaddr
));

938 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCSIFHWADDR
, &
i‰
);

939 i‡(
ªs
 < 0) {

940 
ßved_î∫o
 = 
î∫o
;

942 
	`v_¥öt
("Slave '%s': Error: SIOCSIFHWADDR failed: %s\n",

943 
¶ave_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

945 i‡(
ßved_î∫o
 =
EBUSY
) {

946 
	`v_¥öt
(" The device is busy: it must be idle "

948 } i‡(
ßved_î∫o
 =
EOPNOTSUPP
) {

949 
	`v_¥öt
(" The device doesÇot support setting "

953 } i‡(
ßved_î∫o
 =
EINVAL
) {

954 
	`v_¥öt
(" The device'sáddressÅype doesÇot match "

957  
ªs
;

959 
	`v_¥öt
("Slave '%s': hardwareáddress setÅo "

961 
¶ave_i‚ame
, 
addr
[0],áddr[1],áddr[2],

962 
addr
[3],áddr[4],áddr[5]);

965  
ªs
;

966 
	}
}

968 
	$£t_¶ave_mtu
(*
¶ave_i‚ame
, 
mtu
)

970 
i‰eq
 
i‰
;

971 
ªs
 = 0;

973 
i‰
.
i‰_mtu
 = 
mtu
;

974 
	`°∫˝y
(
i‰
.
i‰_«me
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

976 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCSIFMTU
, &
i‰
);

977 i‡(
ªs
 < 0) {

978 
ßved_î∫o
 = 
î∫o
;

979 
	`v_¥öt
("Slave '%s': Error: SIOCSIFMTU failed: %s\n",

980 
¶ave_i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

982 
	`v_¥öt
("Sœvê'%s': MTU sëÅÿ%d.\n", 
¶ave_i‚ame
, 
mtu
);

985  
ªs
;

986 
	}
}

988 
	$£t_if_Êags
(*
i‚ame
, 
Êags
)

990 
i‰eq
 
i‰
;

991 
ªs
 = 0;

993 
i‰
.
i‰_Êags
 = 
Êags
;

994 
	`°∫˝y
(
i‰
.
i‰_«me
, 
i‚ame
, 
IFNAMSIZ
);

996 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCSIFFLAGS
, &
i‰
);

997 i‡(
ªs
 < 0) {

998 
ßved_î∫o
 = 
î∫o
;

999 
	`v_¥öt
("Interface '%s': Error: SIOCSIFFLAGS failed: %s\n",

1000 
i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

1002 
	`v_¥öt
("I¡îÁ˚ '%s': fœg†£àtÿ%04X.\n", 
i‚ame
, 
Êags
);

1005  
ªs
;

1006 
	}
}

1008 
	$£t_if_up
(*
i‚ame
, 
Êags
)

1010  
	`£t_if_Êags
(
i‚ame
, 
Êags
 | 
IFF_UP
);

1011 
	}
}

1013 
	$£t_if_down
(*
i‚ame
, 
Êags
)

1015  
	`£t_if_Êags
(
i‚ame
, 
Êags
 & ~
IFF_UP
);

1016 
	}
}

1018 
	$˛ór_if_addr
(*
i‚ame
)

1020 
i‰eq
 
i‰
;

1021 
ªs
 = 0;

1023 
	`°∫˝y
(
i‰
.
i‰_«me
, 
i‚ame
, 
IFNAMSIZ
);

1024 
i‰
.
i‰_addr
.
ß_Ámûy
 = 
AF_INET
;

1025 
	`mem£t
(
i‰
.
i‰_addr
.
ß_d©a
, 0, (ifr.ifr_addr.sa_data));

1027 
ªs
 = 
	`io˘l
(
skfd
, 
SIOCSIFADDR
, &
i‰
);

1028 i‡(
ªs
 < 0) {

1029 
ßved_î∫o
 = 
î∫o
;

1030 
	`v_¥öt
("Interface '%s': Error: SIOCSIFADDR failed: %s\n",

1031 
i‚ame
, 
	`°ªº‹
(
ßved_î∫o
));

1033 
	`v_¥öt
("I¡îÁ˚ '%s':áddªs†˛óªd\n", 
i‚ame
);

1036  
ªs
;

1037 
	}
}

1039 
	$£t_if_addr
(*
ma°î_i‚ame
, *
¶ave_i‚ame
)

1041 
i‰eq
 
i‰
;

1042 
ªs
;

1043 *
ùaddr
;

1044 
i
;

1046 *
ªq_«me
;

1047 *
desc
;

1048 
g_io˘l
;

1049 
s_io˘l
;

1050 } 
i‰a
[] = {

1051 {"IFADDR", "addr", 
SIOCGIFADDR
, 
SIOCSIFADDR
},

1052 {"DSTADDR", "de°ö©i⁄áddr", 
SIOCGIFDSTADDR
, 
SIOCSIFDSTADDR
},

1053 {"BRDADDR", "brﬂdˇ°áddr", 
SIOCGIFBRDADDR
, 
SIOCSIFBRDADDR
},

1054 {"NETMASK", "√tmask", 
SIOCGIFNETMASK
, 
SIOCSIFNETMASK
},

1055 {
NULL
, NULL, 0, 0},

1058 
i
 = 0; 
i‰a
[i].
ªq_«me
; i++) {

1059 
	`°∫˝y
(
i‰
.
i‰_«me
, 
ma°î_i‚ame
, 
IFNAMSIZ
);

1060 
ªs
 = 
	`io˘l
(
skfd
, 
i‰a
[
i
].
g_io˘l
, &
i‰
);

1061 i‡(
ªs
 < 0) {

1062 
ßved_î∫o
 = 
î∫o
;

1064 
	`v_¥öt
("Interface '%s': Error: SIOCG%s failed: %s\n",

1065 
ma°î_i‚ame
, 
i‰a
[
i
].
ªq_«me
,

1066 
	`°ªº‹
(
ßved_î∫o
));

1068 
i‰
.
i‰_addr
.
ß_Ámûy
 = 
AF_INET
;

1069 
	`mem£t
(
i‰
.
i‰_addr
.
ß_d©a
, 0,

1070 (
i‰
.
i‰_addr
.
ß_d©a
));

1073 
	`°∫˝y
(
i‰
.
i‰_«me
, 
¶ave_i‚ame
, 
IFNAMSIZ
);

1074 
ªs
 = 
	`io˘l
(
skfd
, 
i‰a
[
i
].
s_io˘l
, &
i‰
);

1075 i‡(
ªs
 < 0) {

1076 
ßved_î∫o
 = 
î∫o
;

1078 
	`v_¥öt
("Interface '%s': Error: SIOCS%s failed: %s\n",

1079 
¶ave_i‚ame
, 
i‰a
[
i
].
ªq_«me
,

1080 
	`°ªº‹
(
ßved_î∫o
));

1084 
ùaddr
 = 
i‰
.
i‰_addr
.
ß_d©a
;

1085 
	`v_¥öt
("Interface '%s': set IP %sÅo %d.%d.%d.%d\n",

1086 
¶ave_i‚ame
, 
i‰a
[
i
].
desc
,

1087 
ùaddr
[0], ipaddr[1], ipaddr[2], ipaddr[3]);

1091 
	}
}

	@Documentation/pcmcia/crc32hash.c

6 
	~<°rög.h
>

7 
	~<°dio.h
>

8 
	~<˘y≥.h
>

9 
	~<°dlib.h
>

11 
	$¸c32
(c⁄° *
p
, 
Àn
)

13 
i
;

14 
¸c
 = 0;

15 
Àn
--) {

16 
¸c
 ^*
p
++;

17 
i
 = 0; i < 8; i++)

18 
¸c
 = (crc >> 1) ^ ((crc & 1) ? 0xedb88320 : 0);

20  
¸c
;

21 
	}
}

23 
	$maö
(
¨gc
, **
¨gv
) {

24 
ªsu…
;

25 i‡(
¨gc
 != 2) {

26 
	`¥ötf
("no stringÖassedásárgument\n");

29 
ªsu…
 = 
	`¸c32
(
¨gv
[1], 
	`°æí
(argv[1]));

30 
	`¥ötf
("0x%x\n", 
ªsu…
);

32 
	}
}

	@Documentation/video4linux/v4lgrab.c

16 
	~<uni°d.h
>

17 
	~<sys/ty≥s.h
>

18 
	~<sys/°©.h
>

19 
	~<f˙é.h
>

20 
	~<°dio.h
>

21 
	~<sys/io˘l.h
>

22 
	~<°dlib.h
>

24 
	~<löux/ty≥s.h
>

25 
	~<löux/videodev.h
>

27 
	#FILE
 "/dev/video0"

	)

31 
	#READ_VIDEO_PIXEL
(
buf
, 
f‹m©
, 
dïth
, 
r
, 
g
, 
b
) \

33 
f‹m©
) \

35 
VIDEO_PALETTE_GREY
: \

36 
dïth
) \

41 (
r
Ë(
g
Ë(
b
Ë(*
buf
++ << 8);\

45 (
r
Ë(
g
Ë(
b
) = \

46 *((*Ë
buf
); \

47 
buf
 += 2; \

53 
VIDEO_PALETTE_RGB565
: \

55 
tmp
 = *(*)
buf
; \

56 (
r
Ë
tmp
&0xF800; \

57 (
g
Ë(
tmp
<<5)&0xFC00; \

58 (
b
Ë(
tmp
<<11)&0xF800; \

59 
buf
 += 2; \

63 
VIDEO_PALETTE_RGB555
: \

64 (
r
Ë(
buf
[0]&0xF8)<<8; \

65 (
g
Ë((
buf
[0] << 5 | buf[1] >> 3)&0xF8)<<8; \

66 (
b
Ë((
buf
[1] << 2 ) & 0xF8)<<8; \

67 
buf
 += 2; \

70 
VIDEO_PALETTE_RGB24
: \

71 (
r
Ë
buf
[0] << 8; (
g
) = buf[1] << 8; \

72 (
b
Ë
buf
[2] << 8; \

73 
buf
 += 3; \

77 
	`Ârötf
(
°dîr
, \

79 
f‹m©
); \

81 }

	)

83 
	$gë_brighäess_adj
(*
image
, 
size
, *
brighäess
) {

84 
i
, 
tŸ
 = 0;

85 
i
=0;i<
size
*3;i++)

86 
tŸ
 +
image
[
i
];

87 *
brighäess
 = (128 - 
tŸ
/(
size
*3))/3;

88  !((
tŸ
/(
size
*3)) >= 126 && (tot/(size*3)) <= 130);

89 
	}
}

91 
	$maö
(
¨gc
, ** 
¨gv
)

93 
fd
 = 
	`›í
(
FILE
, 
O_RDONLY
), 
f
;

94 
video_ˇ∑bûôy
 
ˇp
;

95 
video_wödow
 
wö
;

96 
video_pi˘uª
 
vpic
;

98 *
buf„r
, *
§c
;

99 
bµ
 = 24, 
r
, 
g
, 
b
;

100 
i
, 
§c_dïth
;

102 i‡(
fd
 < 0) {

103 
	`≥º‹
(
FILE
);

104 
	`exô
(1);

107 i‡(
	`io˘l
(
fd
, 
VIDIOCGCAP
, &
ˇp
) < 0) {

108 
	`≥º‹
("VIDIOGCAP");

109 
	`Ârötf
(
°dîr
, "(" 
FILE
 "Çotá video4linux device?)\n");

110 
	`˛o£
(
fd
);

111 
	`exô
(1);

114 i‡(
	`io˘l
(
fd
, 
VIDIOCGWIN
, &
wö
) < 0) {

115 
	`≥º‹
("VIDIOCGWIN");

116 
	`˛o£
(
fd
);

117 
	`exô
(1);

120 i‡(
	`io˘l
(
fd
, 
VIDIOCGPICT
, &
vpic
) < 0) {

121 
	`≥º‹
("VIDIOCGPICT");

122 
	`˛o£
(
fd
);

123 
	`exô
(1);

126 i‡(
ˇp
.
ty≥
 & 
VID_TYPE_MONOCHROME
) {

127 
vpic
.
dïth
=8;

128 
vpic
.
∑Àâe
=
VIDEO_PALETTE_GREY
;

129 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
) < 0) {

130 
vpic
.
dïth
=6;

131 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
) < 0) {

132 
vpic
.
dïth
=4;

133 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
) < 0) {

134 
	`Ârötf
(
°dîr
, "UnableÅo findá supported capture format.\n");

135 
	`˛o£
(
fd
);

136 
	`exô
(1);

141 
vpic
.
dïth
=24;

142 
vpic
.
∑Àâe
=
VIDEO_PALETTE_RGB24
;

144 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
) < 0) {

145 
vpic
.
∑Àâe
=
VIDEO_PALETTE_RGB565
;

146 
vpic
.
dïth
=16;

148 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
)==-1) {

149 
vpic
.
∑Àâe
=
VIDEO_PALETTE_RGB555
;

150 
vpic
.
dïth
=15;

152 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
)==-1) {

153 
	`Ârötf
(
°dîr
, "UnableÅo findá supported capture format.\n");

160 
buf„r
 = 
	`mÆloc
(
wö
.
width
 * wö.
height
 * 
bµ
);

161 i‡(!
buf„r
) {

162 
	`Ârötf
(
°dîr
, "Out of memory.\n");

163 
	`exô
(1);

167 
√wbright
;

168 
	`ªad
(
fd
, 
buf„r
, 
wö
.
width
 * wö.
height
 * 
bµ
);

169 
f
 = 
	`gë_brighäess_adj
(
buf„r
, 
wö
.
width
 * wö.
height
, &
√wbright
);

170 i‡(
f
) {

171 
vpic
.
brighäess
 +(
√wbright
 << 8);

172 if(
	`io˘l
(
fd
, 
VIDIOCSPICT
, &
vpic
)==-1) {

173 
	`≥º‹
("VIDIOSPICT");

177 } 
f
);

179 
	`Ârötf
(
°dout
, "P6\n%d %d 255\n", 
wö
.
width
, wö.
height
);

181 
§c
 = 
buf„r
;

183 
i
 = 0; i < 
wö
.
width
 * wö.
height
; i++) {

184 
	`READ_VIDEO_PIXEL
(
§c
, 
vpic
.
∑Àâe
, 
§c_dïth
, 
r
, 
g
, 
b
);

185 
	`Âutc
(
r
>>8, 
°dout
);

186 
	`Âutc
(
g
>>8, 
°dout
);

187 
	`Âutc
(
b
>>8, 
°dout
);

190 
	`˛o£
(
fd
);

192 
	}
}

	@Documentation/vm/slabinfo.c

10 
	~<°dio.h
>

11 
	~<°dlib.h
>

12 
	~<sys/ty≥s.h
>

13 
	~<dúít.h
>

14 
	~<°rög.h
>

15 
	~<uni°d.h
>

16 
	~<°d¨g.h
>

17 
	~<gë›t.h
>

18 
	~<ªgex.h
>

19 
	~<î∫o.h
>

21 
	#MAX_SLABS
 500

	)

22 
	#MAX_ALIASES
 500

	)

23 
	#MAX_NODES
 1024

	)

25 
	s¶aböfo
 {

26 *
	m«me
;

27 
	mÆüs
;

28 
	mªfs
;

29 
	mÆü£s
, 
	mÆign
, 
	mˇche_dma
, 
	m˝u_¶abs
, 
	mde°roy_by_rcu
;

30 
	mhwˇche_Æign
, 
	mobje˘_size
, 
	mobjs_≥r_¶ab
;

31 
	mßnôy_checks
, 
	m¶ab_size
, 
	m°‹e_u£r
, 
	måa˚
;

32 
	m‹dî
, 
	mpois⁄
, 
	mª˛aim_accou¡
, 
	mªd_z⁄e
;

33 
	m∑πül
, 
	mobje˘s
, 
	m¶abs
;

34 
	mnuma
[
MAX_NODES
];

35 
	mnuma_∑πül
[
MAX_NODES
];

36 } 
	g¶aböfo
[
MAX_SLABS
];

38 
	sÆüsöfo
 {

39 *
	m«me
;

40 *
	mªf
;

41 
¶aböfo
 *
	m¶ab
;

42 } 
	gÆüsöfo
[
MAX_ALIASES
];

44 
	g¶abs
 = 0;

45 
	ga˘uÆ_¶abs
 = 0;

46 
	gÆü£s
 = 0;

47 
	gÆüs_èrgës
 = 0;

48 
	ghighe°_node
 = 0;

50 
	gbuf„r
[4096];

52 
	gshow_em±y
 = 0;

53 
	gshow_ªp‹t
 = 0;

54 
	gshow_Æüs
 = 0;

55 
	gshow_¶ab
 = 0;

56 
	gskù_zîo
 = 1;

57 
	gshow_numa
 = 0;

58 
	gshow_åack
 = 0;

59 
	gshow_fú°_Æüs
 = 0;

60 
	gvÆid©e
 = 0;

61 
	gshrök
 = 0;

62 
	gshow_övîãd
 = 0;

63 
	gshow_sögÀ_ªf
 = 0;

64 
	gshow_tŸÆs
 = 0;

65 
	gs‹t_size
 = 0;

66 
	g£t_debug
 = 0;

67 
	gshow_›s
 = 0;

70 
	gßnôy
 = 0;

71 
	gªdz⁄e
 = 0;

72 
	gpois⁄
 = 0;

73 
	gåackög
 = 0;

74 
	gåacög
 = 0;

76 
	g∑ge_size
;

78 
ªgex_t
 
	g∑âîn
;

80 
	$Áèl
(c⁄° *
x
, ...)

82 
va_li°
 
≠
;

84 
	`va_°¨t
(
≠
, 
x
);

85 
	`vÂrötf
(
°dîr
, 
x
, 
≠
);

86 
	`va_íd
(
≠
);

87 
	`exô
(1);

88 
	}
}

90 
	$ußge
()

92 
	`¥ötf
("slabinfo 5/7/2007. (c) 2007 sgi. clameter@sgi.com\n\n"

120 
	}
}

122 
	$ªad_obj
(*
«me
)

124 
FILE
 *
f
 = 
	`f›í
(
«me
, "r");

126 i‡(!
f
)

127 
buf„r
[0] = 0;

129 i‡(!
	`fgës
(
buf„r
,(buf„r), 
f
))

130 
buf„r
[0] = 0;

131 
	`f˛o£
(
f
);

132 i‡(
buf„r
[
	`°æí
(buffer)] == '\n')

133 
buf„r
[
	`°æí
(buffer)] = 0;

135  
	`°æí
(
buf„r
);

136 
	}
}

142 
	$gë_obj
(*
«me
)

144 i‡(!
	`ªad_obj
(
«me
))

147  
	`©ﬁ
(
buf„r
);

148 
	}
}

150 
	$gë_obj_™d_°r
(*
«me
, **
x
)

152 
ªsu…
 = 0;

153 *
p
;

155 *
x
 = 
NULL
;

157 i‡(!
	`ªad_obj
(
«me
)) {

158 
x
 = 
NULL
;

161 
ªsu…
 = 
	`°πoul
(
buf„r
, &
p
, 10);

162 *
p
 == ' ')

163 
p
++;

164 i‡(*
p
)

165 *
x
 = 
	`°rdup
(
p
);

166  
ªsu…
;

167 
	}
}

169 
	$£t_obj
(
¶aböfo
 *
s
, *
«me
, 
n
)

171 
x
[100];

172 
FILE
 *
f
;

174 
	`•rötf
(
x
, "%s/%s", 
s
->
«me
,Çame);

175 
f
 = 
	`f›í
(
x
, "w");

176 i‡(!
f
)

177 
	`Áèl
("C™nŸ wrôêtÿ%s\n", 
x
);

179 
	`Ârötf
(
f
, "%d\n", 
n
);

180 
	`f˛o£
(
f
);

181 
	}
}

183 
	$ªad_¶ab_obj
(
¶aböfo
 *
s
, *
«me
)

185 
x
[100];

186 
FILE
 *
f
;

187 
l
;

189 
	`•rötf
(
x
, "%s/%s", 
s
->
«me
,Çame);

190 
f
 = 
	`f›í
(
x
, "r");

191 i‡(!
f
) {

192 
buf„r
[0] = 0;

193 
l
 = 0;

195 
l
 = 
	`‰ód
(
buf„r
, 1, (buf„r), 
f
);

196 
buf„r
[
l
] = 0;

197 
	`f˛o£
(
f
);

199  
l
;

200 
	}
}

206 
	$°‹e_size
(*
buf„r
, 
vÆue
)

208 
divis‹
 = 1;

209 
åaûî
 = 0;

210 
n
;

212 i‡(
vÆue
 > 1000000000UL) {

213 
divis‹
 = 100000000UL;

214 
åaûî
 = 'G';

215 } i‡(
vÆue
 > 1000000UL) {

216 
divis‹
 = 100000UL;

217 
åaûî
 = 'M';

218 } i‡(
vÆue
 > 1000UL) {

219 
divis‹
 = 100;

220 
åaûî
 = 'K';

223 
vÆue
 /
divis‹
;

224 
n
 = 
	`•rötf
(
buf„r
, "%ld",
vÆue
);

225 i‡(
åaûî
) {

226 
buf„r
[
n
] = 
åaûî
;

227 
n
++;

228 
buf„r
[
n
] = 0;

230 i‡(
divis‹
 != 1) {

231 
	`memmove
(
buf„r
 + 
n
 - 2, buffer +Ç - 3, 4);

232 
buf„r
[
n
-2] = '.';

233 
n
++;

235  
n
;

236 
	}
}

238 
	$decode_numa_li°
(*
numa
, *
t
)

240 
node
;

241 
ƒ
;

243 
	`mem£t
(
numa
, 0, 
MAX_NODES
 * ());

245 i‡(!
t
)

248 *
t
 == 'N') {

249 
t
++;

250 
node
 = 
	`°πoul
(
t
, &t, 10);

251 i‡(*
t
 == '=') {

252 
t
++;

253 
ƒ
 = 
	`°πoul
(
t
, &t, 10);

254 
numa
[
node
] = 
ƒ
;

255 i‡(
node
 > 
highe°_node
)

256 
highe°_node
 = 
node
;

258 *
t
 == ' ')

259 
t
++;

261 
	}
}

263 
	$¶ab_vÆid©e
(
¶aböfo
 *
s
)

265 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

268 
	`£t_obj
(
s
, "validate", 1);

269 
	}
}

271 
	$¶ab_shrök
(
¶aböfo
 *
s
)

273 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

276 
	`£t_obj
(
s
, "shrink", 1);

277 
	}
}

279 
	glöe
 = 0;

281 
	$fú°_löe
()

283 
	`¥ötf
("Name Objects Objsize Space "

285 
	}
}

290 
Æüsöfo
 *
	$föd_⁄e_Æüs
(
¶aböfo
 *
föd
)

292 
Æüsöfo
 *
a
;

293 
Æüsöfo
 *
be°
 = 
NULL
;

295 
a
 = 
Æüsöfo
;®<álüsöfÿ+ 
Æü£s
;á++) {

296 i‡(
a
->
¶ab
 =
föd
 &&

297 (!
be°
 || 
	`°æí
(be°->
«me
Ë< såÀn(
a
->name))) {

298 
be°
 = 
a
;

299 i‡(
	`°∫cmp
(
a
->
«me
,"kmall", 5) == 0)

300  
be°
;

303  
be°
;

304 
	}
}

306 
	$¶ab_size
(
¶aböfo
 *
s
)

308  
s
->
¶abs
 * (
∑ge_size
 << s->
‹dî
);

309 
	}
}

311 
	$¶ab_numa
(
¶aböfo
 *
s
, 
mode
)

313 
node
;

315 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

318 i‡(!
highe°_node
) {

319 
	`¥ötf
("\n%s: NÿNUMA inf‹m©i⁄ávaûabÀ.\n", 
s
->
«me
);

323 i‡(
skù_zîo
 && !
s
->
¶abs
)

326 i‡(!
löe
) {

327 
	`¥ötf
("\n%-21s:", 
mode
 ? "NUMAÇodes" : "Slab");

328 
node
 = 0;Çodê<
highe°_node
;Çode++)

329 
	`¥ötf
(" %4d", 
node
);

330 
	`¥ötf
("\n----------------------");

331 
node
 = 0;Çodê<
highe°_node
;Çode++)

332 
	`¥ötf
("-----");

333 
	`¥ötf
("\n");

335 
	`¥ötf
("%-21†", 
mode
 ? "AŒ sœbs" : 
s
->
«me
);

336 
node
 = 0;Çodê<
highe°_node
;Çode++) {

337 
b
[20];

339 
	`°‹e_size
(
b
, 
s
->
numa
[
node
]);

340 
	`¥ötf
(" %4s", 
b
);

342 
	`¥ötf
("\n");

343 i‡(
mode
) {

344 
	`¥ötf
("%-21s ", "Partial slabs");

345 
node
 = 0;Çodê<
highe°_node
;Çode++) {

346 
b
[20];

348 
	`°‹e_size
(
b
, 
s
->
numa_∑πül
[
node
]);

349 
	`¥ötf
(" %4s", 
b
);

351 
	`¥ötf
("\n");

353 
löe
++;

354 
	}
}

356 
	$show_åackög
(
¶aböfo
 *
s
)

358 
	`¥ötf
("\n%s: Kî√»obje˘áŒoˇti⁄\n", 
s
->
«me
);

359 
	`¥ötf
("-----------------------------------------------------------------------\n");

360 i‡(
	`ªad_¶ab_obj
(
s
, "alloc_calls"))

361 
	`¥ötf
(
buf„r
);

363 
	`¥ötf
("No Data\n");

365 
	`¥ötf
("\n%s: Kî√»obje˘ fªeög\n", 
s
->
«me
);

366 
	`¥ötf
("------------------------------------------------------------------------\n");

367 i‡(
	`ªad_¶ab_obj
(
s
, "free_calls"))

368 
	`¥ötf
(
buf„r
);

370 
	`¥ötf
("No Data\n");

372 
	}
}

374 
	$›s
(
¶aböfo
 *
s
)

376 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

379 i‡(
	`ªad_¶ab_obj
(
s
, "ops")) {

380 
	`¥ötf
("\n%s: kmem_ˇchê›î©i⁄s\n", 
s
->
«me
);

381 
	`¥ötf
("--------------------------------------------\n");

382 
	`¥ötf
(
buf„r
);

384 
	`¥ötf
("\n%†ha†nÿkmem_ˇchê›î©i⁄s\n", 
s
->
«me
);

385 
	}
}

387 c⁄° *
	$⁄off
(
x
)

389 i‡(
x
)

392 
	}
}

394 
	$ªp‹t
(
¶aböfo
 *
s
)

396 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

399 
	`¥ötf
("\nSlabcache: %-20s Aliases: %2d Order : %2d Objects: %d\n",

400 
s
->
«me
, s->
Æü£s
, s->
‹dî
, s->
obje˘s
);

401 i‡(
s
->
hwˇche_Æign
)

402 
	`¥ötf
("** Hardware cachelineáligned\n");

403 i‡(
s
->
ˇche_dma
)

404 
	`¥ötf
("** Memory isállocated iná special DMA zone\n");

405 i‡(
s
->
de°roy_by_rcu
)

406 
	`¥ötf
("** Slabsáre destroyed via RCU\n");

407 i‡(
s
->
ª˛aim_accou¡
)

408 
	`¥ötf
("** Reclaimáccountingáctive\n");

410 
	`¥ötf
("\nSizes (bytes) Slabs Debug Memory\n");

411 
	`¥ötf
("------------------------------------------------------------------------\n");

412 
	`¥ötf
("Object : %7d Total : %7ld Sanity Checks : %s Total: %7ld\n",

413 
s
->
obje˘_size
, s->
¶abs
, 
	`⁄off
(s->
ßnôy_checks
),

414 
s
->
¶abs
 * (
∑ge_size
 << s->
‹dî
));

415 
	`¥ötf
("SlabObj: %7d Full : %7ld Redzoning : %s Used : %7ld\n",

416 
s
->
¶ab_size
, s->
¶abs
 - s->
∑πül
 - s->
˝u_¶abs
,

417 
	`⁄off
(
s
->
ªd_z⁄e
), s->
obje˘s
 * s->
obje˘_size
);

418 
	`¥ötf
("SlabSiz: %7d Partial: %7ld Poisoning : %s Loss : %7ld\n",

419 
∑ge_size
 << 
s
->
‹dî
, s->
∑πül
, 
	`⁄off
(s->
pois⁄
),

420 
s
->
¶abs
 * (
∑ge_size
 << s->
‹dî
Ë- s->
obje˘s
 * s->
obje˘_size
);

421 
	`¥ötf
("Loss : %7d CpuSlab: %7d Tracking : %s Lalig: %7ld\n",

422 
s
->
¶ab_size
 - s->
obje˘_size
, s->
˝u_¶abs
, 
	`⁄off
(s->
°‹e_u£r
),

423 (
s
->
¶ab_size
 - s->
obje˘_size
Ë* s->
obje˘s
);

424 
	`¥ötf
("Align : %7d Objects: %7d Tracing : %s Lpadd: %7ld\n",

425 
s
->
Æign
, s->
objs_≥r_¶ab
, 
	`⁄off
(s->
åa˚
),

426 ((
∑ge_size
 << 
s
->
‹dî
Ë- s->
objs_≥r_¶ab
 * s->
¶ab_size
) *

427 
s
->
¶abs
);

429 
	`›s
(
s
);

430 
	`show_åackög
(
s
);

431 
	`¶ab_numa
(
s
, 1);

432 
	}
}

434 
	$¶abˇche
(
¶aböfo
 *
s
)

436 
size_°r
[20];

437 
di°_°r
[40];

438 
Êags
[20];

439 *
p
 = 
Êags
;

441 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

444 i‡(
a˘uÆ_¶abs
 == 1) {

445 
	`ªp‹t
(
s
);

449 i‡(
skù_zîo
 && !
show_em±y
 && !
s
->
¶abs
)

452 i‡(
show_em±y
 && 
s
->
¶abs
)

455 
	`°‹e_size
(
size_°r
, 
	`¶ab_size
(
s
));

456 
	`•rötf
(
di°_°r
,"%lu/%lu/%d", 
s
->
¶abs
, s->
∑πül
, s->
˝u_¶abs
);

458 i‡(!
löe
++)

459 
	`fú°_löe
();

461 i‡(
s
->
Æü£s
)

462 *
p
++ = '*';

463 i‡(
s
->
ˇche_dma
)

464 *
p
++ = 'd';

465 i‡(
s
->
hwˇche_Æign
)

466 *
p
++ = 'A';

467 i‡(
s
->
pois⁄
)

468 *
p
++ = 'P';

469 i‡(
s
->
ª˛aim_accou¡
)

470 *
p
++ = 'a';

471 i‡(
s
->
ªd_z⁄e
)

472 *
p
++ = 'Z';

473 i‡(
s
->
ßnôy_checks
)

474 *
p
++ = 'F';

475 i‡(
s
->
°‹e_u£r
)

476 *
p
++ = 'U';

477 i‡(
s
->
åa˚
)

478 *
p
++ = 'T';

480 *
p
 = 0;

481 
	`¥ötf
("%-21s %8ld %7d %8s %14s %4d %1d %3ld %3ld %s\n",

482 
s
->
«me
, s->
obje˘s
, s->
obje˘_size
, 
size_°r
, 
di°_°r
,

483 
s
->
objs_≥r_¶ab
, s->
‹dî
,

484 
s
->
¶abs
 ? (s->
∑πül
 * 100) / s->slabs : 100,

485 
s
->
¶abs
 ? (s->
obje˘s
 * s->
obje˘_size
 * 100) /

486 (
s
->
¶abs
 * (
∑ge_size
 << s->
‹dî
)) : 100,

487 
Êags
);

488 
	}
}

493 
	$debug_›t_sˇn
(*
›t
)

495 i‡(!
›t
 || !›t[0] || 
	`°rcmp
(opt, "-") == 0)

498 i‡(
	`°rˇ£cmp
(
›t
, "a") == 0) {

499 
ßnôy
 = 1;

500 
pois⁄
 = 1;

501 
ªdz⁄e
 = 1;

502 
åackög
 = 1;

506  ; *
›t
; opt++)

507 *
›t
) {

509 i‡(
ßnôy
)

511 
ßnôy
 = 1;

514 i‡(
pois⁄
)

516 
pois⁄
 = 1;

520 i‡(
ªdz⁄e
)

522 
ªdz⁄e
 = 1;

526 i‡(
åackög
)

528 
åackög
 = 1;

532 i‡(
åacög
)

534 
åacög
 = 1;

540 
	}
}

542 
	$¶ab_em±y
(
¶aböfo
 *
s
)

544 i‡(
s
->
obje˘s
 > 0)

551 i‡(
s
->
¶abs
 != 0)

552 
	`£t_obj
(
s
, "shrink", 1);

555 
	}
}

557 
	$¶ab_debug
(
¶aböfo
 *
s
)

559 i‡(
	`°rcmp
(
s
->
«me
, "*") == 0)

562 i‡(
ßnôy
 && !
s
->
ßnôy_checks
) {

563 
	`£t_obj
(
s
, "sanity", 1);

565 i‡(!
ßnôy
 && 
s
->
ßnôy_checks
) {

566 i‡(
	`¶ab_em±y
(
s
))

567 
	`£t_obj
(
s
, "sanity", 0);

569 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸ dißbÀ s™ôy checks\n", 
s
->
«me
);

571 i‡(
ªdz⁄e
 && !
s
->
ªd_z⁄e
) {

572 i‡(
	`¶ab_em±y
(
s
))

573 
	`£t_obj
(
s
, "red_zone", 1);

575 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸÉ«bÀÑedz⁄ög\n", 
s
->
«me
);

577 i‡(!
ªdz⁄e
 && 
s
->
ªd_z⁄e
) {

578 i‡(
	`¶ab_em±y
(
s
))

579 
	`£t_obj
(
s
, "red_zone", 0);

581 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸ dißbÀÑedz⁄ög\n", 
s
->
«me
);

583 i‡(
pois⁄
 && !
s
->poison) {

584 i‡(
	`¶ab_em±y
(
s
))

585 
	`£t_obj
(
s
, "poison", 1);

587 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸÉ«bÀÖois⁄ög\n", 
s
->
«me
);

589 i‡(!
pois⁄
 && 
s
->poison) {

590 i‡(
	`¶ab_em±y
(
s
))

591 
	`£t_obj
(
s
, "poison", 0);

593 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸ dißbÀÖois⁄ög\n", 
s
->
«me
);

595 i‡(
åackög
 && !
s
->
°‹e_u£r
) {

596 i‡(
	`¶ab_em±y
(
s
))

597 
	`£t_obj
(
s
, "store_user", 1);

599 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸÉ«bÀÅøckög\n", 
s
->
«me
);

601 i‡(!
åackög
 && 
s
->
°‹e_u£r
) {

602 i‡(
	`¶ab_em±y
(
s
))

603 
	`£t_obj
(
s
, "store_user", 0);

605 
	`Ârötf
(
°dîr
, "%†nŸÉm±y c™nŸ dißbÀÅøckög\n", 
s
->
«me
);

607 i‡(
åacög
 && !
s
->
åa˚
) {

608 i‡(
¶abs
 == 1)

609 
	`£t_obj
(
s
, "trace", 1);

611 
	`Ârötf
(
°dîr
, "%†ˇ¿⁄lyÉ«bÀÅø˚ f‹ o√ sœbáà®time\n", 
s
->
«me
);

613 i‡(!
åacög
 && 
s
->
åa˚
)

614 
	`£t_obj
(
s
, "trace", 1);

615 
	}
}

617 
	$tŸÆs
()

619 
¶aböfo
 *
s
;

621 
u£d_¶abs
 = 0;

622 
b1
[20], 
b2
[20], 
b3
[20], 
b4
[20];

623 
max
 = 1ULL << 63;

626 
mö_objsize
 = 
max
, 
max_objsize
 = 0, 
avg_objsize
;

629 
mö_∑πül
 = 
max
, 
max_∑πül
 = 0,

630 
avg_∑πül
, 
tŸÆ_∑πül
 = 0;

633 
mö_¶abs
 = 
max
, 
max_¶abs
 = 0,

634 
avg_¶abs
, 
tŸÆ_¶abs
 = 0;

637 
mö_size
 = 
max
, 
max_size
 = 0,

638 
avg_size
, 
tŸÆ_size
 = 0;

641 
mö_u£d
 = 
max
, 
max_u£d
 = 0,

642 
avg_u£d
, 
tŸÆ_u£d
 = 0;

645 
mö_wa°e
 = 
max
, 
max_wa°e
 = 0,

646 
avg_wa°e
, 
tŸÆ_wa°e
 = 0;

648 
mö_obje˘s
 = 
max
, 
max_obje˘s
 = 0,

649 
avg_obje˘s
, 
tŸÆ_obje˘s
 = 0;

651 
mö_objwa°e
 = 
max
,

652 
max_objwa°e
 = 0, 
avg_objwa°e
,

653 
tŸÆ_objwa°e
 = 0;

656 
mö_memobj
 = 
max
,

657 
max_memobj
 = 0, 
avg_memobj
,

658 
tŸÆ_objsize
 = 0;

661 
mö_µ¨t
 = 100, 
max_µ¨t
 = 0,

662 
avg_µ¨t
, 
tŸÆ_µ¨t
 = 0;

665 
mö_∑πobj
 = 
max
, 
max_∑πobj
 = 0,

666 
avg_∑πobj
, 
tŸÆ_∑πobj
 = 0;

669 
mö_µ¨tobj
 = 100, 
max_µ¨tobj
 = 0,

670 
avg_µ¨tobj
, 
tŸÆ_µ¨tobj
 = 0;

673 
s
 = 
¶aböfo
; s < sœböfÿ+ 
¶abs
; s++) {

674 
size
;

675 
u£d
;

676 
wa°ed
;

677 
objwa°e
;

678 
obje˘s_ö_∑πül_¶abs
;

679 
≥r˚¡age_∑πül_¶abs
;

680 
≥r˚¡age_∑πül_objs
;

682 i‡(!
s
->
¶abs
 || !s->
obje˘s
)

685 
u£d_¶abs
++;

687 
size
 = 
	`¶ab_size
(
s
);

688 
u£d
 = 
s
->
obje˘s
 * s->
obje˘_size
;

689 
wa°ed
 = 
size
 - 
u£d
;

690 
objwa°e
 = 
s
->
¶ab_size
 - s->
obje˘_size
;

692 
obje˘s_ö_∑πül_¶abs
 = 
s
->
obje˘s
 -

693 (
s
->
¶abs
 - s->
∑πül
 - s ->
˝u_¶abs
) *

694 
s
->
objs_≥r_¶ab
;

696 i‡(
obje˘s_ö_∑πül_¶abs
 < 0)

697 
obje˘s_ö_∑πül_¶abs
 = 0;

699 
≥r˚¡age_∑πül_¶abs
 = 
s
->
∑πül
 * 100 / s->
¶abs
;

700 i‡(
≥r˚¡age_∑πül_¶abs
 > 100)

701 
≥r˚¡age_∑πül_¶abs
 = 100;

703 
≥r˚¡age_∑πül_objs
 = 
obje˘s_ö_∑πül_¶abs
 * 100

704 / 
s
->
obje˘s
;

706 i‡(
≥r˚¡age_∑πül_objs
 > 100)

707 
≥r˚¡age_∑πül_objs
 = 100;

709 i‡(
s
->
obje˘_size
 < 
mö_objsize
)

710 
mö_objsize
 = 
s
->
obje˘_size
;

711 i‡(
s
->
∑πül
 < 
mö_∑πül
)

712 
mö_∑πül
 = 
s
->
∑πül
;

713 i‡(
s
->
¶abs
 < 
mö_¶abs
)

714 
mö_¶abs
 = 
s
->
¶abs
;

715 i‡(
size
 < 
mö_size
)

716 
mö_size
 = 
size
;

717 i‡(
wa°ed
 < 
mö_wa°e
)

718 
mö_wa°e
 = 
wa°ed
;

719 i‡(
objwa°e
 < 
mö_objwa°e
)

720 
mö_objwa°e
 = 
objwa°e
;

721 i‡(
s
->
obje˘s
 < 
mö_obje˘s
)

722 
mö_obje˘s
 = 
s
->
obje˘s
;

723 i‡(
u£d
 < 
mö_u£d
)

724 
mö_u£d
 = 
u£d
;

725 i‡(
obje˘s_ö_∑πül_¶abs
 < 
mö_∑πobj
)

726 
mö_∑πobj
 = 
obje˘s_ö_∑πül_¶abs
;

727 i‡(
≥r˚¡age_∑πül_¶abs
 < 
mö_µ¨t
)

728 
mö_µ¨t
 = 
≥r˚¡age_∑πül_¶abs
;

729 i‡(
≥r˚¡age_∑πül_objs
 < 
mö_µ¨tobj
)

730 
mö_µ¨tobj
 = 
≥r˚¡age_∑πül_objs
;

731 i‡(
s
->
¶ab_size
 < 
mö_memobj
)

732 
mö_memobj
 = 
s
->
¶ab_size
;

734 i‡(
s
->
obje˘_size
 > 
max_objsize
)

735 
max_objsize
 = 
s
->
obje˘_size
;

736 i‡(
s
->
∑πül
 > 
max_∑πül
)

737 
max_∑πül
 = 
s
->
∑πül
;

738 i‡(
s
->
¶abs
 > 
max_¶abs
)

739 
max_¶abs
 = 
s
->
¶abs
;

740 i‡(
size
 > 
max_size
)

741 
max_size
 = 
size
;

742 i‡(
wa°ed
 > 
max_wa°e
)

743 
max_wa°e
 = 
wa°ed
;

744 i‡(
objwa°e
 > 
max_objwa°e
)

745 
max_objwa°e
 = 
objwa°e
;

746 i‡(
s
->
obje˘s
 > 
max_obje˘s
)

747 
max_obje˘s
 = 
s
->
obje˘s
;

748 i‡(
u£d
 > 
max_u£d
)

749 
max_u£d
 = 
u£d
;

750 i‡(
obje˘s_ö_∑πül_¶abs
 > 
max_∑πobj
)

751 
max_∑πobj
 = 
obje˘s_ö_∑πül_¶abs
;

752 i‡(
≥r˚¡age_∑πül_¶abs
 > 
max_µ¨t
)

753 
max_µ¨t
 = 
≥r˚¡age_∑πül_¶abs
;

754 i‡(
≥r˚¡age_∑πül_objs
 > 
max_µ¨tobj
)

755 
max_µ¨tobj
 = 
≥r˚¡age_∑πül_objs
;

756 i‡(
s
->
¶ab_size
 > 
max_memobj
)

757 
max_memobj
 = 
s
->
¶ab_size
;

759 
tŸÆ_∑πül
 +
s
->
∑πül
;

760 
tŸÆ_¶abs
 +
s
->
¶abs
;

761 
tŸÆ_size
 +
size
;

762 
tŸÆ_wa°e
 +
wa°ed
;

764 
tŸÆ_obje˘s
 +
s
->
obje˘s
;

765 
tŸÆ_u£d
 +
u£d
;

766 
tŸÆ_∑πobj
 +
obje˘s_ö_∑πül_¶abs
;

767 
tŸÆ_µ¨t
 +
≥r˚¡age_∑πül_¶abs
;

768 
tŸÆ_µ¨tobj
 +
≥r˚¡age_∑πül_objs
;

770 
tŸÆ_objwa°e
 +
s
->
obje˘s
 * 
objwa°e
;

771 
tŸÆ_objsize
 +
s
->
obje˘s
 * s->
¶ab_size
;

774 i‡(!
tŸÆ_obje˘s
) {

775 
	`¥ötf
("No objects\n");

778 i‡(!
u£d_¶abs
) {

779 
	`¥ötf
("No slabs\n");

784 
avg_∑πül
 = 
tŸÆ_∑πül
 / 
u£d_¶abs
;

785 
avg_¶abs
 = 
tŸÆ_¶abs
 / 
u£d_¶abs
;

786 
avg_size
 = 
tŸÆ_size
 / 
u£d_¶abs
;

787 
avg_wa°e
 = 
tŸÆ_wa°e
 / 
u£d_¶abs
;

789 
avg_obje˘s
 = 
tŸÆ_obje˘s
 / 
u£d_¶abs
;

790 
avg_u£d
 = 
tŸÆ_u£d
 / 
u£d_¶abs
;

791 
avg_∑πobj
 = 
tŸÆ_∑πobj
 / 
u£d_¶abs
;

792 
avg_µ¨t
 = 
tŸÆ_µ¨t
 / 
u£d_¶abs
;

793 
avg_µ¨tobj
 = 
tŸÆ_µ¨tobj
 / 
u£d_¶abs
;

796 
avg_objsize
 = 
tŸÆ_u£d
 / 
tŸÆ_obje˘s
;

797 
avg_objwa°e
 = 
tŸÆ_objwa°e
 / 
tŸÆ_obje˘s
;

798 
avg_∑πobj
 = 
tŸÆ_∑πobj
 * 100 / 
tŸÆ_obje˘s
;

799 
avg_memobj
 = 
tŸÆ_objsize
 / 
tŸÆ_obje˘s
;

801 
	`¥ötf
("Slabcache Totals\n");

802 
	`¥ötf
("----------------\n");

803 
	`¥ötf
("Slabcaches : %3d Aliases : %3d->%-3d Active: %3d\n",

804 
¶abs
, 
Æü£s
, 
Æüs_èrgës
, 
u£d_¶abs
);

806 
	`°‹e_size
(
b1
, 
tŸÆ_size
);°‹e_size(
b2
, 
tŸÆ_wa°e
);

807 
	`°‹e_size
(
b3
, 
tŸÆ_wa°e
 * 100 / 
tŸÆ_u£d
);

808 
	`¥ötf
("Mem‹y u£d: %6† # Los† : %6† MR©io:%6s%%\n", 
b1
, 
b2
, 
b3
);

810 
	`°‹e_size
(
b1
, 
tŸÆ_obje˘s
);°‹e_size(
b2
, 
tŸÆ_∑πobj
);

811 
	`°‹e_size
(
b3
, 
tŸÆ_∑πobj
 * 100 / 
tŸÆ_obje˘s
);

812 
	`¥ötf
("# Obje˘† : %6† # P¨tObj: %6† OR©io:%6s%%\n", 
b1
, 
b2
, 
b3
);

814 
	`¥ötf
("\n");

815 
	`¥ötf
("Per Cache Average Min Max Total\n");

816 
	`¥ötf
("---------------------------------------------------------\n");

818 
	`°‹e_size
(
b1
, 
avg_obje˘s
);°‹e_size(
b2
, 
mö_obje˘s
);

819 
	`°‹e_size
(
b3
, 
max_obje˘s
);°‹e_size(
b4
, 
tŸÆ_obje˘s
);

820 
	`¥ötf
("#Objects %10s %10s %10s %10s\n",

821 
b1
, 
b2
, 
b3
, 
b4
);

823 
	`°‹e_size
(
b1
, 
avg_¶abs
);°‹e_size(
b2
, 
mö_¶abs
);

824 
	`°‹e_size
(
b3
, 
max_¶abs
);°‹e_size(
b4
, 
tŸÆ_¶abs
);

825 
	`¥ötf
("#Slabs %10s %10s %10s %10s\n",

826 
b1
, 
b2
, 
b3
, 
b4
);

828 
	`°‹e_size
(
b1
, 
avg_∑πül
);°‹e_size(
b2
, 
mö_∑πül
);

829 
	`°‹e_size
(
b3
, 
max_∑πül
);°‹e_size(
b4
, 
tŸÆ_∑πül
);

830 
	`¥ötf
("#PartSlab %10s %10s %10s %10s\n",

831 
b1
, 
b2
, 
b3
, 
b4
);

832 
	`°‹e_size
(
b1
, 
avg_µ¨t
);°‹e_size(
b2
, 
mö_µ¨t
);

833 
	`°‹e_size
(
b3
, 
max_µ¨t
);

834 
	`°‹e_size
(
b4
, 
tŸÆ_∑πül
 * 100 / 
tŸÆ_¶abs
);

835 
	`¥ötf
("%%PartSlab%10s%% %10s%% %10s%% %10s%%\n",

836 
b1
, 
b2
, 
b3
, 
b4
);

838 
	`°‹e_size
(
b1
, 
avg_∑πobj
);°‹e_size(
b2
, 
mö_∑πobj
);

839 
	`°‹e_size
(
b3
, 
max_∑πobj
);

840 
	`°‹e_size
(
b4
, 
tŸÆ_∑πobj
);

841 
	`¥ötf
("PartObjs %10s %10s %10s %10s\n",

842 
b1
, 
b2
, 
b3
, 
b4
);

844 
	`°‹e_size
(
b1
, 
avg_µ¨tobj
);°‹e_size(
b2
, 
mö_µ¨tobj
);

845 
	`°‹e_size
(
b3
, 
max_µ¨tobj
);

846 
	`°‹e_size
(
b4
, 
tŸÆ_∑πobj
 * 100 / 
tŸÆ_obje˘s
);

847 
	`¥ötf
("%% PartObj%10s%% %10s%% %10s%% %10s%%\n",

848 
b1
, 
b2
, 
b3
, 
b4
);

850 
	`°‹e_size
(
b1
, 
avg_size
);°‹e_size(
b2
, 
mö_size
);

851 
	`°‹e_size
(
b3
, 
max_size
);°‹e_size(
b4
, 
tŸÆ_size
);

852 
	`¥ötf
("Memory %10s %10s %10s %10s\n",

853 
b1
, 
b2
, 
b3
, 
b4
);

855 
	`°‹e_size
(
b1
, 
avg_u£d
);°‹e_size(
b2
, 
mö_u£d
);

856 
	`°‹e_size
(
b3
, 
max_u£d
);°‹e_size(
b4
, 
tŸÆ_u£d
);

857 
	`¥ötf
("Used %10s %10s %10s %10s\n",

858 
b1
, 
b2
, 
b3
, 
b4
);

860 
	`°‹e_size
(
b1
, 
avg_wa°e
);°‹e_size(
b2
, 
mö_wa°e
);

861 
	`°‹e_size
(
b3
, 
max_wa°e
);°‹e_size(
b4
, 
tŸÆ_wa°e
);

862 
	`¥ötf
("Loss %10s %10s %10s %10s\n",

863 
b1
, 
b2
, 
b3
, 
b4
);

865 
	`¥ötf
("\n");

866 
	`¥ötf
("Per Object Average Min Max\n");

867 
	`¥ötf
("---------------------------------------------\n");

869 
	`°‹e_size
(
b1
, 
avg_memobj
);°‹e_size(
b2
, 
mö_memobj
);

870 
	`°‹e_size
(
b3
, 
max_memobj
);

871 
	`¥ötf
("Memory %10s %10s %10s\n",

872 
b1
, 
b2
, 
b3
);

873 
	`°‹e_size
(
b1
, 
avg_objsize
);°‹e_size(
b2
, 
mö_objsize
);

874 
	`°‹e_size
(
b3
, 
max_objsize
);

875 
	`¥ötf
("User %10s %10s %10s\n",

876 
b1
, 
b2
, 
b3
);

878 
	`°‹e_size
(
b1
, 
avg_objwa°e
);°‹e_size(
b2
, 
mö_objwa°e
);

879 
	`°‹e_size
(
b3
, 
max_objwa°e
);

880 
	`¥ötf
("Loss %10s %10s %10s\n",

881 
b1
, 
b2
, 
b3
);

882 
	}
}

884 
	$s‹t_¶abs
()

886 
¶aböfo
 *
s1
,*
s2
;

888 
s1
 = 
¶aböfo
; s1 < sœböfÿ+ 
¶abs
; s1++) {

889 
s2
 = 
s1
 + 1; s2 < 
¶aböfo
 + 
¶abs
; s2++) {

890 
ªsu…
;

892 i‡(
s‹t_size
)

893 
ªsu…
 = 
	`¶ab_size
(
s1
Ë< sœb_size(
s2
);

895 
ªsu…
 = 
	`°rˇ£cmp
(
s1
->
«me
, 
s2
->name);

897 i‡(
show_övîãd
)

898 
ªsu…
 = -result;

900 i‡(
ªsu…
 > 0) {

901 
¶aböfo
 
t
;

903 
	`mem˝y
(&
t
, 
s1
, (
¶aböfo
));

904 
	`mem˝y
(
s1
, 
s2
, (
¶aböfo
));

905 
	`mem˝y
(
s2
, &
t
, (
¶aböfo
));

909 
	}
}

911 
	$s‹t_Æü£s
()

913 
Æüsöfo
 *
a1
,*
a2
;

915 
a1
 = 
Æüsöfo
;á1 <álüsöfÿ+ 
Æü£s
;á1++) {

916 
a2
 = 
a1
 + 1;á2 < 
Æüsöfo
 + 
Æü£s
;á2++) {

917 *
n1
, *
n2
;

919 
n1
 = 
a1
->
«me
;

920 
n2
 = 
a2
->
«me
;

921 i‡(
show_Æüs
 && !
show_övîãd
) {

922 
n1
 = 
a1
->
ªf
;

923 
n2
 = 
a2
->
ªf
;

925 i‡(
	`°rˇ£cmp
(
n1
, 
n2
) > 0) {

926 
Æüsöfo
 
t
;

928 
	`mem˝y
(&
t
, 
a1
, (
Æüsöfo
));

929 
	`mem˝y
(
a1
, 
a2
, (
Æüsöfo
));

930 
	`mem˝y
(
a2
, &
t
, (
Æüsöfo
));

934 
	}
}

936 
	$lök_¶abs
()

938 
Æüsöfo
 *
a
;

939 
¶aböfo
 *
s
;

941 
a
 = 
Æüsöfo
;á <álüsöfÿ+ 
Æü£s
;á++) {

943 
s
 = 
¶aböfo
; s < sœböfÿ+ 
¶abs
; s++)

944 i‡(
	`°rcmp
(
a
->
ªf
, 
s
->
«me
) == 0) {

945 
a
->
¶ab
 = 
s
;

946 
s
->
ªfs
++;

949 i‡(
s
 =
¶aböfo
 + 
¶abs
)

950 
	`Áèl
("Uƒesﬁvedálü†%s\n", 
a
->
ªf
);

952 
	}
}

954 
	$Æüs
()

956 
Æüsöfo
 *
a
;

957 *
a˘ive
 = 
NULL
;

959 
	`s‹t_Æü£s
();

960 
	`lök_¶abs
();

962 
a
 = 
Æüsöfo
;á <álüsöfÿ+ 
Æü£s
;á++) {

964 i‡(!
show_sögÀ_ªf
 && 
a
->
¶ab
->
ªfs
 == 1)

967 i‡(!
show_övîãd
) {

968 i‡(
a˘ive
) {

969 i‡(
	`°rcmp
(
a
->
¶ab
->
«me
, 
a˘ive
) == 0) {

970 
	`¥ötf
(" %s", 
a
->
«me
);

974 
	`¥ötf
("\n%-12†<- %s", 
a
->
¶ab
->
«me
,á->name);

975 
a˘ive
 = 
a
->
¶ab
->
«me
;

978 
	`¥ötf
("%-20†-> %s\n", 
a
->
«me
,á->
¶ab
->name);

980 i‡(
a˘ive
)

981 
	`¥ötf
("\n");

982 
	}
}

985 
	$ª«me_¶abs
()

987 
¶aböfo
 *
s
;

988 
Æüsöfo
 *
a
;

990 
s
 = 
¶aböfo
; s < sœböfÿ+ 
¶abs
; s++) {

991 i‡(*
s
->
«me
 != ':')

994 i‡(
s
->
ªfs
 > 1 && !
show_fú°_Æüs
)

997 
a
 = 
	`föd_⁄e_Æüs
(
s
);

999 i‡(
a
)

1000 
s
->
«me
 = 
a
->name;

1002 
s
->
«me
 = "*";

1003 
a˘uÆ_¶abs
--;

1006 
	}
}

1008 
	$¶ab_mism©ch
(*
¶ab
)

1010  
	`ªgexec
(&
∑âîn
, 
¶ab
, 0, 
NULL
, 0);

1011 
	}
}

1013 
	$ªad_¶ab_dú
()

1015 
DIR
 *
dú
;

1016 
dúít
 *
de
;

1017 
¶aböfo
 *
¶ab
 = slabinfo;

1018 
Æüsöfo
 *
Æüs
 =áliasinfo;

1019 *
p
;

1020 *
t
;

1021 
cou¡
;

1023 i‡(
	`chdú
("/sys/slab"))

1024 
	`Áèl
("SYSFS support for SLUBÇotáctive\n");

1026 
dú
 = 
	`›ídú
(".");

1027 (
de
 = 
	`ªaddú
(
dú
))) {

1028 i‡(
de
->
d_«me
[0] == '.' ||

1029 (
de
->
d_«me
[0] !':' && 
	`¶ab_mism©ch
(de->d_name)))

1031 
de
->
d_ty≥
) {

1032 
DT_LNK
:

1033 
Æüs
->
«me
 = 
	`°rdup
(
de
->
d_«me
);

1034 
cou¡
 = 
	`ªadlök
(
de
->
d_«me
, 
buf„r
, (buffer));

1036 i‡(
cou¡
 < 0)

1037 
	`Áèl
("C™nŸÑód symlök %s\n", 
de
->
d_«me
);

1039 
buf„r
[
cou¡
] = 0;

1040 
p
 = 
buf„r
 + 
cou¡
;

1041 
p
 > 
buf„r
 &&Ö[-1] != '/')

1042 
p
--;

1043 
Æüs
->
ªf
 = 
	`°rdup
(
p
);

1044 
Æüs
++;

1046 
DT_DIR
:

1047 i‡(
	`chdú
(
de
->
d_«me
))

1048 
	`Áèl
("U«bÀÅÿac˚s†¶ab %s\n", 
¶ab
->
«me
);

1049 
¶ab
->
«me
 = 
	`°rdup
(
de
->
d_«me
);

1050 
¶ab
->
Æüs
 = 0;

1051 
¶ab
->
ªfs
 = 0;

1052 
¶ab
->
Æü£s
 = 
	`gë_obj
("aliases");

1053 
¶ab
->
Æign
 = 
	`gë_obj
("align");

1054 
¶ab
->
ˇche_dma
 = 
	`gë_obj
("cache_dma");

1055 
¶ab
->
˝u_¶abs
 = 
	`gë_obj
("cpu_slabs");

1056 
¶ab
->
de°roy_by_rcu
 = 
	`gë_obj
("destroy_by_rcu");

1057 
¶ab
->
hwˇche_Æign
 = 
	`gë_obj
("hwcache_align");

1058 
¶ab
->
obje˘_size
 = 
	`gë_obj
("object_size");

1059 
¶ab
->
obje˘s
 = 
	`gë_obj
("objects");

1060 
¶ab
->
objs_≥r_¶ab
 = 
	`gë_obj
("objs_per_slab");

1061 
¶ab
->
‹dî
 = 
	`gë_obj
("order");

1062 
¶ab
->
∑πül
 = 
	`gë_obj
("partial");

1063 
¶ab
->
∑πül
 = 
	`gë_obj_™d_°r
("∑πül", &
t
);

1064 
	`decode_numa_li°
(
¶ab
->
numa_∑πül
, 
t
);

1065 
¶ab
->
pois⁄
 = 
	`gë_obj
("poison");

1066 
¶ab
->
ª˛aim_accou¡
 = 
	`gë_obj
("reclaim_account");

1067 
¶ab
->
ªd_z⁄e
 = 
	`gë_obj
("red_zone");

1068 
¶ab
->
ßnôy_checks
 = 
	`gë_obj
("sanity_checks");

1069 
¶ab
->
¶ab_size
 = 
	`gë_obj
("slab_size");

1070 
¶ab
->
¶abs
 = 
	`gë_obj_™d_°r
("¶abs", &
t
);

1071 
	`decode_numa_li°
(
¶ab
->
numa
, 
t
);

1072 
¶ab
->
°‹e_u£r
 = 
	`gë_obj
("store_user");

1073 
¶ab
->
åa˚
 = 
	`gë_obj
("trace");

1074 
	`chdú
("..");

1075 i‡(
¶ab
->
«me
[0] == ':')

1076 
Æüs_èrgës
++;

1077 
¶ab
++;

1080 
	`Áèl
("Unknow¿fûêty≥ %lx\n", 
de
->
d_ty≥
);

1083 
	`˛o£dú
(
dú
);

1084 
¶abs
 = 
¶ab
 - 
¶aböfo
;

1085 
a˘uÆ_¶abs
 = 
¶abs
;

1086 
Æü£s
 = 
Æüs
 - 
Æüsöfo
;

1087 i‡(
¶abs
 > 
MAX_SLABS
)

1088 
	`Áèl
("Too many slabs\n");

1089 i‡(
Æü£s
 > 
MAX_ALIASES
)

1090 
	`Áèl
("Too manyáliases\n");

1091 
	}
}

1093 
	$ouçut_¶abs
()

1095 
¶aböfo
 *
¶ab
;

1097 
¶ab
 = 
¶aböfo
; sœb < sœböfÿ+ 
¶abs
; slab++) {

1099 i‡(
¶ab
->
Æüs
)

1103 i‡(
show_numa
)

1104 
	`¶ab_numa
(
¶ab
, 0);

1105 i‡(
show_åack
)

1106 
	`show_åackög
(
¶ab
);

1107 i‡(
vÆid©e
)

1108 
	`¶ab_vÆid©e
(
¶ab
);

1109 i‡(
shrök
)

1110 
	`¶ab_shrök
(
¶ab
);

1111 i‡(
£t_debug
)

1112 
	`¶ab_debug
(
¶ab
);

1113 i‡(
show_›s
)

1114 
	`›s
(
¶ab
);

1115 i‡(
show_¶ab
)

1116 
	`¶abˇche
(
¶ab
);

1117 i‡(
show_ªp‹t
)

1118 
	`ªp‹t
(
¶ab
);

1120 
	}
}

1122 
›ti⁄
 
	g›ts
[] = {

1123 { "Æü£s", 0, 
NULL
, 'a' },

1124 { "debug", 2, 
NULL
, 'd' },

1125 { "em±y", 0, 
NULL
, 'e' },

1126 { "fú°-Æüs", 0, 
NULL
, 'f' },

1127 { "hñp", 0, 
NULL
, 'h' },

1128 { "övîãd", 0, 
NULL
, 'i'},

1129 { "numa", 0, 
NULL
, 'n' },

1130 { "›s", 0, 
NULL
, 'o' },

1131 { "ªp‹t", 0, 
NULL
, 'r' },

1132 { "shrök", 0, 
NULL
, 's' },

1133 { "¶abs", 0, 
NULL
, 'l' },

1134 { "åack", 0, 
NULL
, 't'},

1135 { "vÆid©e", 0, 
NULL
, 'v' },

1136 { "zîo", 0, 
NULL
, 'z' },

1137 { "1ªf", 0, 
NULL
, '1'},

1138 { 
NULL
, 0, NULL, 0 }

1141 
	$maö
(
¨gc
, *
¨gv
[])

1143 
c
;

1144 
îr
;

1145 *
∑âîn_sour˚
;

1147 
∑ge_size
 = 
	`gë∑gesize
();

1149 (
c
 = 
	`gë›t_l⁄g
(
¨gc
, 
¨gv
, "ad::efhil1noprstvzTS",

1150 
›ts
, 
NULL
)) != -1)

1151 
c
) {

1153 
show_sögÀ_ªf
 = 1;

1156 
show_Æüs
 = 1;

1159 
£t_debug
 = 1;

1160 i‡(!
	`debug_›t_sˇn
(
›èrg
))

1161 
	`Áèl
("InvÆid debug o±i⁄ '%s'\n", 
›èrg
);

1164 
show_em±y
 = 1;

1167 
show_fú°_Æüs
 = 1;

1170 
	`ußge
();

1173 
show_övîãd
 = 1;

1176 
show_numa
 = 1;

1179 
show_›s
 = 1;

1182 
show_ªp‹t
 = 1;

1185 
shrök
 = 1;

1188 
show_¶ab
 = 1;

1191 
show_åack
 = 1;

1194 
vÆid©e
 = 1;

1197 
skù_zîo
 = 0;

1200 
show_tŸÆs
 = 1;

1203 
s‹t_size
 = 1;

1207 
	`Áèl
("%s: InvÆid o±i⁄ '%c'\n", 
¨gv
[0], 
›t›t
);

1211 i‡(!
show_¶ab
 && !
show_Æüs
 && !
show_åack
 && !
show_ªp‹t


1212 && !
vÆid©e
 && !
shrök
 && !
£t_debug
 && !
show_›s
)

1213 
show_¶ab
 = 1;

1215 i‡(
¨gc
 > 
›töd
)

1216 
∑âîn_sour˚
 = 
¨gv
[
›töd
];

1218 
∑âîn_sour˚
 = ".*";

1220 
îr
 = 
	`ªgcomp
(&
∑âîn
, 
∑âîn_sour˚
, 
REG_ICASE
|
REG_NOSUB
);

1221 i‡(
îr
)

1222 
	`Áèl
("%s: InvalidÖattern '%s' code %d\n",

1223 
¨gv
[0], 
∑âîn_sour˚
, 
îr
);

1224 
	`ªad_¶ab_dú
();

1225 i‡(
show_Æüs
)

1226 
	`Æüs
();

1228 i‡(
show_tŸÆs
)

1229 
	`tŸÆs
();

1231 
	`lök_¶abs
();

1232 
	`ª«me_¶abs
();

1233 
	`s‹t_¶abs
();

1234 
	`ouçut_¶abs
();

1237 
	}
}

	@Documentation/watchdog/src/watchdog-simple.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<uni°d.h
>

4 
	~<f˙é.h
>

6 
	$maö
(
¨gc
, c⁄° *
¨gv
[]) {

7 
fd
 = 
	`›í
("/dev/w©chdog", 
O_WRONLY
);

8 i‡(
fd
 == -1) {

9 
	`≥º‹
("watchdog");

10 
	`exô
(1);

13 
	`wrôe
(
fd
, "\0", 1);

14 
	`fsync
(
fd
);

15 
	`¶ìp
(10);

17 
	}
}

	@Documentation/watchdog/src/watchdog-test.c

5 
	~<°dio.h
>

6 
	~<°dlib.h
>

7 
	~<°rög.h
>

8 
	~<uni°d.h
>

9 
	~<f˙é.h
>

10 
	~<sys/io˘l.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/w©chdog.h
>

14 
	gfd
;

21 
	$kìp_Æive
()

23 
dummy
;

25 
	`io˘l
(
fd
, 
WDIOC_KEEPALIVE
, &
dummy
);

26 
	}
}

32 
	$maö
(
¨gc
, *
¨gv
[])

34 
fd
 = 
	`›í
("/dev/w©chdog", 
O_WRONLY
);

36 i‡(
fd
 == -1) {

37 
	`Ârötf
(
°dîr
, "Watchdog deviceÇotÉnabled.\n");

38 
	`fÊush
(
°dîr
);

39 
	`exô
(-1);

42 i‡(
¨gc
 > 1) {

43 i‡(!
	`°∫ˇ£cmp
(
¨gv
[1], "-d", 2)) {

44 
	`io˘l
(
fd
, 
WDIOC_SETOPTIONS
, 
WDIOS_DISABLECARD
);

45 
	`Ârötf
(
°dîr
, "Watchdog card disabled.\n");

46 
	`fÊush
(
°dîr
);

47 
	`exô
(0);

48 } i‡(!
	`°∫ˇ£cmp
(
¨gv
[1], "-e", 2)) {

49 
	`io˘l
(
fd
, 
WDIOC_SETOPTIONS
, 
WDIOS_ENABLECARD
);

50 
	`Ârötf
(
°dîr
, "Watchdog cardÉnabled.\n");

51 
	`fÊush
(
°dîr
);

52 
	`exô
(0);

54 
	`Ârötf
(
°dîr
, "-dÅo disable, -eÅoÉnable.\n");

55 
	`Ârötf
(
°dîr
, "run by itselfÅoÅickÅhe card.\n");

56 
	`fÊush
(
°dîr
);

57 
	`exô
(0);

60 
	`Ârötf
(
°dîr
, "Watchdog Ticking Away!\n");

61 
	`fÊush
(
°dîr
);

65 
	`kìp_Æive
();

66 
	`¶ìp
(1);

68 
	}
}

	@arch/alpha/boot/bootp.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/ut§ñó£.h
>

13 
	~<löux/mm.h
>

15 
	~<asm/sy°em.h
>

16 
	~<asm/c⁄sﬁe.h
>

17 
	~<asm/hwΩb.h
>

18 
	~<asm/pgèbÀ.h
>

19 
	~<asm/io.h
>

21 
	~<°d¨g.h
>

23 
	~"ksize.h
"

25 
swôch_to_osf_∑l
(
ƒ
,

26 
pcb_°ru˘
 * 
pcb_va
, pcb_°ru˘ * 
pcb_∑
,

27 *
v±b
);

29 
move_°ack
(
√w_°ack
);

31 
hwΩb_°ru˘
 *
	ghwΩb
 = 
INIT_HWRPB
;

32 
pcb_°ru˘
 
	gpcb_va
[1];

40 
ölöe
 *

41 
	$föd_∑
(*
v±b
, *
±r
)

43 
addªss
 = (Ë
±r
;

44 
ªsu…
;

46 
ªsu…
 = 
v±b
[
addªss
 >> 13];

47 
ªsu…
 >>= 32;

48 
ªsu…
 <<= 13;

49 
ªsu…
 |
addªss
 & 0x1fff;

50  (*Ë
ªsu…
;

51 
	}
}

64 
	#VPTB
 ((*Ë0x200000000)

	)

65 
	#L1
 ((*Ë0x200802000)

	)

68 
	$∑l_öô
()

70 
i
, 
ªv
;

71 
≥r˝u_°ru˘
 * 
≥r˝u
;

72 
pcb_°ru˘
 * 
pcb_∑
;

75 
pcb_va
->
k•
 = 0;

76 
pcb_va
->
u•
 = 0;

77 
pcb_va
->
±br
 = 
L1
[1] >> 32;

78 
pcb_va
->
a¢
 = 0;

79 
pcb_va
->
pcc
 = 0;

80 
pcb_va
->
unique
 = 0;

81 
pcb_va
->
Êags
 = 1;

82 
pcb_va
->
ªs1
 = 0;

83 
pcb_va
->
ªs2
 = 0;

84 
pcb_∑
 = 
	`föd_∑
(
VPTB
, 
pcb_va
);

93 
	`§m_¥ötk
("SwitchingÅo OSF PAL-code .. ");

95 
i
 = 
	`swôch_to_osf_∑l
(2, 
pcb_va
, 
pcb_∑
, 
VPTB
);

96 i‡(
i
) {

97 
	`§m_¥ötk
("Áûed, codê%ld\n", 
i
);

98 
	`__hÆt
();

101 
≥r˝u
 = (
≥r˝u_°ru˘
 *)

102 (
INIT_HWRPB
->
¥o˚ss‹_off£t
 + () INIT_HWRPB);

103 
ªv
 = 
≥r˝u
->
∑l_ªvisi⁄
 =Öî˝u->
∑lcode_avaû
[2];

105 
	`§m_¥ötk
("Ok (ªv %lx)\n", 
ªv
);

107 
	`tbü
();

108 
	}
}

110 
ölöe
 

111 
	$lﬂd
(
d°
, 
§c
, 
cou¡
)

113 
	`mem˝y
((*)
d°
, (*)
§c
, 
cou¡
);

114 
	}
}

119 
ölöe
 

120 
	$runkî√l
()

122 
__asm__
 
	`__vﬁ©ûe__
(

126 : "r" (
START_ADDR
));

127 
	}
}

129 
_íd
;

130 
	#KERNEL_ORIGIN
 \

131 (((()&
_íd
Ë+ 511Ë& ~511)

	)

134 
	$°¨t_kî√l
()

148 
nbyãs
;

149 
ívvÆ
[256] 
	`__©åibuã__
((
	`Æig√d
(8)));

150 
öôrd_°¨t
;

152 
	`§m_¥ötk
("Löux/AXP boŸ∞lﬂdî f‹ Löux " 
UTS_RELEASE
 "\n");

153 i‡(
INIT_HWRPB
->
∑gesize
 != 8192) {

154 
	`§m_¥ötk
("Expected 8kBÖages, got %ldkB\n",

155 
INIT_HWRPB
->
∑gesize
 >> 10);

158 i‡(
INIT_HWRPB
->
v±b
 !(Ë
VPTB
) {

159 
	`§m_¥ötk
("Expected vptbát %p, got %p\n",

160 
VPTB
, (*)
INIT_HWRPB
->
v±b
);

163 
	`∑l_öô
();

167 
öôrd_°¨t
 = ((
START_ADDR
 + 5*
KERNEL_SIZE
 + 
PAGE_SIZE
) |

168 (
PAGE_SIZE
-1)) + 1;

169 #ifde‡
INITRD_IMAGE_SIZE


170 
	`§m_¥ötk
("InôrdÖosôi⁄edáà%#lx\n", 
öôrd_°¨t
);

177 
	`move_°ack
(
öôrd_°¨t
 - 
PAGE_SIZE
);

179 
nbyãs
 = 
	`ˇŒback_gëív
(
ENV_BOOTED_OSFLAGS
, 
ívvÆ
, (envval));

180 i‡(
nbyãs
 < 0 ||Çbyã†>(
ívvÆ
)) {

181 
nbyãs
 = 0;

183 
ívvÆ
[
nbyãs
] = '\0';

184 
	`§m_¥ötk
("LﬂdögÅhêkî√l...'%s'\n", 
ívvÆ
);

200 #ifde‡
INITRD_IMAGE_SIZE


201 
	`lﬂd
(
öôrd_°¨t
, 
KERNEL_ORIGIN
+
KERNEL_SIZE
, 
INITRD_IMAGE_SIZE
);

203 
	`lﬂd
(
START_ADDR
+(4*
KERNEL_SIZE
), 
KERNEL_ORIGIN
, KERNEL_SIZE);

204 
	`lﬂd
(
START_ADDR
, START_ADDR+(4*
KERNEL_SIZE
), KERNEL_SIZE);

206 
	`mem£t
((*)
ZERO_PGE
, 0, 
PAGE_SIZE
);

207 
	`°r˝y
((*)
ZERO_PGE
, 
ívvÆ
);

208 #ifde‡
INITRD_IMAGE_SIZE


209 ((*)(
ZERO_PGE
+256))[0] = 
öôrd_°¨t
;

210 ((*)(
ZERO_PGE
+256))[1] = 
INITRD_IMAGE_SIZE
;

213 
	`runkî√l
();

214 
	}
}

	@arch/alpha/boot/bootpz.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/°rög.h
>

14 
	~<löux/ut§ñó£.h
>

15 
	~<löux/mm.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/c⁄sﬁe.h
>

19 
	~<asm/hwΩb.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/io.h
>

23 
	~<°d¨g.h
>

25 
	~"kzsize.h
"

28 
	#MALLOC_AREA_SIZE
 0x200000

	)

40 #unde‡
DEBUG_CHECK_RANGE


41 #unde‡
DEBUG_ADDRESSES


42 #unde‡
DEBUG_LAST_STEPS


44 
swôch_to_osf_∑l
(
ƒ
,

45 
pcb_°ru˘
 * 
pcb_va
, pcb_°ru˘ * 
pcb_∑
,

46 *
v±b
);

48 
decom¥ess_kî√l
(* 
de°ö©i⁄
, *
sour˚
,

49 
size_t
 
ksize
, size_à
kzsize
);

51 
move_°ack
(
√w_°ack
);

53 
hwΩb_°ru˘
 *
	ghwΩb
 = 
INIT_HWRPB
;

54 
pcb_°ru˘
 
	gpcb_va
[1];

61 
	#VPTB
 ((*Ë0x200000000)

	)

63 
ölöe
 

64 
	$föd_∑
(
addªss
)

66 
ªsu…
;

68 
ªsu…
 = 
VPTB
[
addªss
 >> 13];

69 
ªsu…
 >>= 32;

70 
ªsu…
 <<= 13;

71 
ªsu…
 |
addªss
 & 0x1fff;

72  
ªsu…
;

73 
	}
}

76 
	$check_ønge
(
v°¨t
, 
víd
,

77 
k°¨t
, 
kíd
)

79 
vaddr
, 
kaddr
;

81 #ifde‡
DEBUG_CHECK_RANGE


82 
	`§m_¥ötk
("check_range: V[0x%lx:0x%lx] K[0x%lx:0x%lx]\n",

83 
v°¨t
, 
víd
, 
k°¨t
, 
kíd
);

86 
vaddr
 = 
v°¨t
; vadd∏<
víd
; vadd∏+
PAGE_SIZE
)

88 
kaddr
 = (
	`föd_∑
(
vaddr
Ë| 
PAGE_OFFSET
);

89 i‡(
kaddr
 >
k°¨t
 && kadd∏<
kíd
)

91 #ifde‡
DEBUG_CHECK_RANGE


92 
	`§m_¥ötk
("OVERLAP: vaddr 0x%lx kaddr 0x%lx"

94 
vaddr
, 
kaddr
, 
k°¨t
, 
kíd
);

100 
	}
}

113 
	#L1
 ((*Ë0x200802000)

	)

116 
	$∑l_öô
()

118 
i
, 
ªv
;

119 
≥r˝u_°ru˘
 * 
≥r˝u
;

120 
pcb_°ru˘
 * 
pcb_∑
;

123 
pcb_va
->
k•
 = 0;

124 
pcb_va
->
u•
 = 0;

125 
pcb_va
->
±br
 = 
L1
[1] >> 32;

126 
pcb_va
->
a¢
 = 0;

127 
pcb_va
->
pcc
 = 0;

128 
pcb_va
->
unique
 = 0;

129 
pcb_va
->
Êags
 = 1;

130 
pcb_va
->
ªs1
 = 0;

131 
pcb_va
->
ªs2
 = 0;

132 
pcb_∑
 = (
pcb_°ru˘
 *)
	`föd_∑
(()
pcb_va
);

141 
	`§m_¥ötk
("SwitchingÅo OSF PAL-code... ");

143 
i
 = 
	`swôch_to_osf_∑l
(2, 
pcb_va
, 
pcb_∑
, 
VPTB
);

144 i‡(
i
) {

145 
	`§m_¥ötk
("Áûed, codê%ld\n", 
i
);

146 
	`__hÆt
();

149 
≥r˝u
 = (
≥r˝u_°ru˘
 *)

150 (
INIT_HWRPB
->
¥o˚ss‹_off£t
 + () INIT_HWRPB);

151 
ªv
 = 
≥r˝u
->
∑l_ªvisi⁄
 =Öî˝u->
∑lcode_avaû
[2];

153 
	`§m_¥ötk
("OK (ªv %lx)\n", 
ªv
);

155 
	`tbü
();

156 
	}
}

161 
ölöe
 

162 
	$runkî√l
()

164 
__asm__
 
	`__vﬁ©ûe__
(

168 : "r" (
START_ADDR
));

169 
	}
}

173 
	gSP_⁄_íåy
;

178 
_íd
;

179 
	#KERNEL_ORIGIN
 \

180 (((()&
_íd
Ë+ 511Ë& ~511)

	)

183 
	#NEXT_PAGE
(
a
Ë((◊Ë| (
PAGE_SIZE
 - 1)Ë+ 1)

	)

185 #ifde‡
INITRD_IMAGE_SIZE


186 
	#REAL_INITRD_SIZE
 
INITRD_IMAGE_SIZE


	)

188 
	#REAL_INITRD_SIZE
 0

	)

218 
	#V_BOOT_IMAGE_START
 
BOOT_ADDR


	)

219 
	#V_BOOT_IMAGE_END
 
SP_⁄_íåy


	)

222 
	#V_BOOTSTRAPPER_START
 
BOOT_ADDR


	)

223 
	#V_BOOTSTRAPPER_END
 
KERNEL_ORIGIN


	)

229 
	#V_DATA_START
 
KERNEL_ORIGIN


	)

230 
	#V_INITRD_START
 (
KERNEL_ORIGIN
 + 
KERNEL_Z_SIZE
)

	)

231 
	#V_INTRD_END
 (
V_INITRD_START
 + 
REAL_INITRD_SIZE
)

	)

232 
	#V_DATA_END
 
V_BOOT_IMAGE_END


	)

240 
	#K_KERNEL_DATA_START
 
ZERO_PGE


	)

241 
	#K_KERNEL_IMAGE_START
 
START_ADDR


	)

242 
	#K_KERNEL_IMAGE_END
 (
START_ADDR
 + 
KERNEL_SIZE
)

	)

252 
	#K_COPY_IMAGE_START
 
	`NEXT_PAGE
(
K_KERNEL_IMAGE_END
)

	)

254 
	#K_INITRD_START
 \

255 
	`NEXT_PAGE
(
K_COPY_IMAGE_START
 + 
KERNEL_SIZE
 + 
PAGE_SIZE
)

	)

256 
	#K_COPY_IMAGE_END
 \

257 (
K_INITRD_START
 + 
REAL_INITRD_SIZE
 + 
MALLOC_AREA_SIZE
)

	)

258 
	#K_COPY_IMAGE_SIZE
 \

259 
	`NEXT_PAGE
(
K_COPY_IMAGE_END
 - 
K_COPY_IMAGE_START
)

	)

262 
	$°¨t_kî√l
()

264 
mu°_move
 = 0;

271 
uncom¥es£d_image_°¨t
 = 
K_KERNEL_IMAGE_START
;

272 
uncom¥es£d_image_íd
 = 
K_KERNEL_IMAGE_END
;

274 
öôrd_image_°¨t
 = 
K_INITRD_START
;

288 
nbyãs
;

289 
ívvÆ
[256] 
	`__©åibuã__
((
	`Æig√d
(8)));

290 
asm_•
 
	`asm
("30");

292 
SP_⁄_íåy
 = 
asm_•
;

294 
	`§m_¥ötk
("Löux/AÕh®BOOTPZ Lﬂdî f‹ Löux " 
UTS_RELEASE
 "\n");

297 i‡(
INIT_HWRPB
->
∑gesize
 != 8192) {

298 
	`§m_¥ötk
("Expected 8kBÖages, got %ldkB\n",

299 
INIT_HWRPB
->
∑gesize
 >> 10);

302 i‡(
INIT_HWRPB
->
v±b
 !(Ë
VPTB
) {

303 
	`§m_¥ötk
("Expected vptbát %p, got %p\n",

304 
VPTB
, (*)
INIT_HWRPB
->
v±b
);

309 
	`∑l_öô
();

312 
nbyãs
 = 
	`ˇŒback_gëív
(
ENV_BOOTED_OSFLAGS
, 
ívvÆ
, (envval));

313 i‡(
nbyãs
 < 0 ||Çbyã†>(
ívvÆ
)) {

314 
nbyãs
 = 0;

316 
ívvÆ
[
nbyãs
] = '\0';

318 #ifde‡
DEBUG_ADDRESSES


319 
	`§m_¥ötk
("START_ADDR 0x%lx\n", 
START_ADDR
);

320 
	`§m_¥ötk
("KERNEL_ORIGIN 0x%lx\n", 
KERNEL_ORIGIN
);

321 
	`§m_¥ötk
("KERNEL_SIZE 0x%x\n", 
KERNEL_SIZE
);

322 
	`§m_¥ötk
("KERNEL_Z_SIZE 0x%x\n", 
KERNEL_Z_SIZE
);

348 i‡(
	`check_ønge
(
V_BOOTSTRAPPER_START
, 
V_BOOTSTRAPPER_END
,

349 
K_KERNEL_DATA_START
, 
K_KERNEL_IMAGE_END
))

351 
	`§m_¥ötk
("FATAL ERROR: overlap of bootstrapper code\n");

352 
	`__hÆt
();

361 i‡(
	`check_ønge
(
V_DATA_START
, 
V_DATA_END
,

362 
K_KERNEL_IMAGE_START
, 
K_COPY_IMAGE_END
))

364 #ifde‡
DEBUG_ADDRESSES


365 
	`§m_¥ötk
("OVERLAP: cannot decompress inÖlace\n");

367 
uncom¥es£d_image_°¨t
 = 
K_COPY_IMAGE_START
;

368 
uncom¥es£d_image_íd
 = 
K_COPY_IMAGE_END
;

369 
mu°_move
 = 1;

377 
	`check_ønge
(
V_DATA_START
, 
V_DATA_END
,

378 
uncom¥es£d_image_°¨t
,

379 
uncom¥es£d_image_íd
))

382 
uncom¥es£d_image_°¨t
 +
K_COPY_IMAGE_SIZE
;

383 
uncom¥es£d_image_íd
 +
K_COPY_IMAGE_SIZE
;

384 
öôrd_image_°¨t
 +
K_COPY_IMAGE_SIZE
;

387 
uncom¥es£d_image_°¨t
 +
PAGE_SIZE
;

388 
uncom¥es£d_image_íd
 +
PAGE_SIZE
;

389 
öôrd_image_°¨t
 +
PAGE_SIZE
;

394 
	`§m_¥ötk
("SèπögÅÿlﬂdÅhêkî√»wôhárg†'%s'\n", 
ívvÆ
);

396 #ifde‡
DEBUG_ADDRESSES


397 
	`§m_¥ötk
("DecompressingÅhe kernel...\n"

399 
V_DATA_START
,

400 
uncom¥es£d_image_°¨t
,

401 
KERNEL_SIZE
);

403 
	`decom¥ess_kî√l
((*)
uncom¥es£d_image_°¨t
,

404 (*)
V_DATA_START
,

405 
KERNEL_SIZE
, 
KERNEL_Z_SIZE
);

411 #ifde‡
INITRD_IMAGE_SIZE


414 #ifde‡
DEBUG_ADDRESSES


415 
	`§m_¥ötk
("MovingÅhe INITRD image...\n"

417 
V_INITRD_START
,

418 
öôrd_image_°¨t
,

419 
INITRD_IMAGE_SIZE
);

421 
	`mem˝y
((*)
öôrd_image_°¨t
, (*)
V_INITRD_START
,

422 
INITRD_IMAGE_SIZE
);

429 i‡(
mu°_move
) {

430 #ifde‡
DEBUG_ADDRESSES


431 
	`§m_¥ötk
("MovingÅhe uncompressed kernel...\n"

433 
uncom¥es£d_image_°¨t
,

434 
K_KERNEL_IMAGE_START
,

435 ()
KERNEL_SIZE
);

441 
	`move_°ack
(
öôrd_image_°¨t
 - 
PAGE_SIZE
);

443 
	`mem˝y
((*)
K_KERNEL_IMAGE_START
,

444 (*)
uncom¥es£d_image_°¨t
, 
KERNEL_SIZE
);

448 #ifde‡
DEBUG_LAST_STEPS


449 
	`§m_¥ötk
("Preparing ZERO_PGE...\n");

451 
	`mem£t
((*)
ZERO_PGE
, 0, 
PAGE_SIZE
);

452 
	`°r˝y
((*)
ZERO_PGE
, 
ívvÆ
);

454 #ifde‡
INITRD_IMAGE_SIZE


456 #ifde‡
DEBUG_LAST_STEPS


457 
	`§m_¥ötk
("Preparing INITRD info...\n");

460 ((*)(
ZERO_PGE
+256))[0] = 
öôrd_image_°¨t
;

461 ((*)(
ZERO_PGE
+256))[1] = 
INITRD_IMAGE_SIZE
;

465 #ifde‡
DEBUG_LAST_STEPS


466 
	`§m_¥ötk
("Doing 'runkernel()'...\n");

468 
	`runkî√l
();

469 
	}
}

472 *
	$__kmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

474  (*)
NULL
;

475 
	}
}

	@arch/alpha/boot/main.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/°rög.h
>

10 
	~<löux/ut§ñó£.h
>

11 
	~<löux/mm.h
>

13 
	~<asm/sy°em.h
>

14 
	~<asm/c⁄sﬁe.h
>

15 
	~<asm/hwΩb.h
>

16 
	~<asm/pgèbÀ.h
>

18 
	~<°d¨g.h
>

20 
	~"ksize.h
"

22 
v•rötf
(*, c⁄° *, 
va_li°
);

23 
swôch_to_osf_∑l
(
ƒ
,

24 
pcb_°ru˘
 * 
pcb_va
, pcb_°ru˘ * 
pcb_∑
,

25 *
v±b
);

26 
hwΩb_°ru˘
 *
	ghwΩb
 = 
INIT_HWRPB
;

27 
pcb_°ru˘
 
	gpcb_va
[1];

35 
ölöe
 *

36 
	$föd_∑
(*
v±b
, *
±r
)

38 
addªss
 = (Ë
±r
;

39 
ªsu…
;

41 
ªsu…
 = 
v±b
[
addªss
 >> 13];

42 
ªsu…
 >>= 32;

43 
ªsu…
 <<= 13;

44 
ªsu…
 |
addªss
 & 0x1fff;

45  (*Ë
ªsu…
;

46 
	}
}

59 
	#VPTB
 ((*Ë0x200000000)

	)

60 
	#L1
 ((*Ë0x200802000)

	)

63 
	$∑l_öô
()

65 
i
, 
ªv
;

66 
≥r˝u_°ru˘
 * 
≥r˝u
;

67 
pcb_°ru˘
 * 
pcb_∑
;

70 
pcb_va
->
k•
 = 0;

71 
pcb_va
->
u•
 = 0;

72 
pcb_va
->
±br
 = 
L1
[1] >> 32;

73 
pcb_va
->
a¢
 = 0;

74 
pcb_va
->
pcc
 = 0;

75 
pcb_va
->
unique
 = 0;

76 
pcb_va
->
Êags
 = 1;

77 
pcb_va
->
ªs1
 = 0;

78 
pcb_va
->
ªs2
 = 0;

79 
pcb_∑
 = 
	`föd_∑
(
VPTB
, 
pcb_va
);

88 
	`§m_¥ötk
("SwitchingÅo OSF PAL-code .. ");

90 
i
 = 
	`swôch_to_osf_∑l
(2, 
pcb_va
, 
pcb_∑
, 
VPTB
);

91 i‡(
i
) {

92 
	`§m_¥ötk
("Áûed, codê%ld\n", 
i
);

93 
	`__hÆt
();

96 
≥r˝u
 = (
≥r˝u_°ru˘
 *)

97 (
INIT_HWRPB
->
¥o˚ss‹_off£t
 + () INIT_HWRPB);

98 
ªv
 = 
≥r˝u
->
∑l_ªvisi⁄
 =Öî˝u->
∑lcode_avaû
[2];

100 
	`§m_¥ötk
("Ok (ªv %lx)\n", 
ªv
);

102 
	`tbü
();

103 
	}
}

105 
ölöe
 
	$›íboŸ
()

107 
boŸdev
[256];

108 
ªsu…
;

110 
ªsu…
 = 
	`ˇŒback_gëív
(
ENV_BOOTED_DEV
, 
boŸdev
, 255);

111 i‡(
ªsu…
 < 0)

112  
ªsu…
;

113  
	`ˇŒback_›í
(
boŸdev
, 
ªsu…
 & 255);

114 
	}
}

116 
ölöe
 
	$˛o£
(
dev
)

118  
	`ˇŒback_˛o£
(
dev
);

119 
	}
}

121 
ölöe
 
	$lﬂd
(
dev
, 
addr
, 
cou¡
)

123 
boŸfûe
[256];

124 
_íd
;

125 
ªsu…
, 
boŸ_size
 = &
_íd
 - (*Ë
BOOT_ADDR
;

127 
ªsu…
 = 
	`ˇŒback_gëív
(
ENV_BOOTED_FILE
, 
boŸfûe
, 255);

128 i‡(
ªsu…
 < 0)

129  
ªsu…
;

130 
ªsu…
 &= 255;

131 
boŸfûe
[
ªsu…
] = '\0';

132 i‡(
ªsu…
)

133 
	`§m_¥ötk
("Boot file specification (%s)Çot implemented\n",

134 
boŸfûe
);

135  
	`ˇŒback_ªad
(
dev
, 
cou¡
, 
addr
, 
boŸ_size
/512 + 1);

136 
	}
}

141 
	$runkî√l
()

143 
__asm__
 
	`__vﬁ©ûe__
(

148 : "r" (
START_ADDR
),

149 "r" (
PAGE_SIZE
 + 
INIT_STACK
));

150 
	}
}

152 
	$°¨t_kî√l
()

154 
i
;

155 
dev
;

156 
nbyãs
;

157 
ívvÆ
[256];

159 
	`§m_¥ötk
("Löux/AXP boŸlﬂdî f‹ Löux " 
UTS_RELEASE
 "\n");

160 i‡(
INIT_HWRPB
->
∑gesize
 != 8192) {

161 
	`§m_¥ötk
("Ex≥˘ed 8kBÖages, gŸ %ldkB\n", 
INIT_HWRPB
->
∑gesize
 >> 10);

164 
	`∑l_öô
();

165 
dev
 = 
	`›íboŸ
();

166 i‡(
dev
 < 0) {

167 
	`§m_¥ötk
("U«bÀÅÿ›í boŸ devi˚: %016lx\n", 
dev
);

170 
dev
 &= 0xffffffff;

171 
	`§m_¥ötk
("Loading vmlinux ...");

172 
i
 = 
	`lﬂd
(
dev
, 
START_ADDR
, 
KERNEL_SIZE
);

173 
	`˛o£
(
dev
);

174 i‡(
i
 !
KERNEL_SIZE
) {

175 
	`§m_¥ötk
("Faûed (%lx)\n", 
i
);

179 
nbyãs
 = 
	`ˇŒback_gëív
(
ENV_BOOTED_OSFLAGS
, 
ívvÆ
, (envval));

180 i‡(
nbyãs
 < 0) {

181 
nbyãs
 = 0;

183 
ívvÆ
[
nbyãs
] = '\0';

184 
	`°r˝y
((*)
ZERO_PGE
, 
ívvÆ
);

186 
	`§m_¥ötk
(" Ok\nNow bootingÅhe kernel\n");

187 
	`runkî√l
();

188 
i
 = 0 ; i < 0x100000000 ; i++)

190 
	`__hÆt
();

191 
	}
}

	@arch/alpha/boot/misc.c

21 
	~<löux/kî√l.h
>

23 
	~<asm/uac˚ss.h
>

25 
	#memzîo
(
s
,
n
Ë
	`mem£t
 ((s),0,“))

	)

26 
	#puts
 
§m_¥ötk


	)

27 
	$§m_¥ötk
(const *, ...)

28 
	`__©åibuã__
 ((
	`f‹m©
 (
¥ötf
, 1, 2)));

33 
	#OF
(
¨gs
Ë
	)
args

34 
	#STATIC
 

	)

36 
	tuch
;

37 
	tush
;

38 
	tulg
;

40 
	#WSIZE
 0x8000

	)

43 
uch
 *
öbuf
;

44 
uch
 *
wödow
;

46 
ösize
;

47 
ö±r
;

48 
out˙t
;

51 
	#ASCII_FLAG
 0x01

	)

52 
	#CONTINUATION
 0x02

	)

53 
	#EXTRA_FIELD
 0x04

	)

54 
	#ORIG_NAME
 0x08

	)

55 
	#COMMENT
 0x10

	)

56 
	#ENCRYPTED
 0x20

	)

57 
	#RESERVED
 0xC0

	)

59 
	#gë_byã
(Ë(
ö±r
 < 
ösize
 ? 
öbuf
[ö±r++] : 
	`fûl_öbuf
())

	)

62 #ifde‡
DEBUG


63 
	#As£π
(
c⁄d
,
msg
Ë{if(!(c⁄d)Ë
	`îr‹
(msg);
	}

	)
}

64 
	#Tø˚
(
x
Ë
Ârötf
 
	)
x

65 
	#Tø˚v
(
x
Ë{i‡(
vîbo£
Ë
Ârötf
 x ;}

	)

66 
	#Tø˚vv
(
x
Ë{i‡(
vîbo£
>1Ë
Ârötf
 x ;}

	)

67 
	#Tø˚c
(
c
,
x
Ë{i‡(
vîbo£
 && (c)Ë
Ârötf
 x ;}

	)

68 
	#Tø˚cv
(
c
,
x
Ë{i‡(
vîbo£
>1 && (c)Ë
Ârötf
 x ;}

	)

70 
	#As£π
(
c⁄d
,
msg
)

	)

71 
	#Tø˚
(
x
)

	)

72 
	#Tø˚v
(
x
)

	)

73 
	#Tø˚vv
(
x
)

	)

74 
	#Tø˚c
(
c
,
x
)

	)

75 
	#Tø˚cv
(
c
,
x
)

	)

78 
fûl_öbuf
();

79 
Êush_wödow
();

80 
îr‹
(*
m
);

81 
gzù_m¨k
(**);

82 
gzù_ªÀa£
(**);

84 *
	göput_d©a
;

85 
	göput_d©a_size
;

87 
uch
 *
	gouçut_d©a
;

88 
ulg
 
	gouçut_±r
;

89 
ulg
 
	gbyãs_out
;

91 *
mÆloc
(
size
);

92 
‰ì
(*
whîe
);

93 
îr‹
(*
m
);

94 
gzù_m¨k
(**);

95 
gzù_ªÀa£
(**);

97 
íd
;

98 
ulg
 
	g‰ì_mem_±r
;

99 
ulg
 
	g‰ì_mem_±r_íd
;

101 
	#HEAP_SIZE
 0x3000

	)

103 
	~"../../../lib/öÊ©e.c
"

105 *
	$mÆloc
(
size
)

107 *
p
;

109 i‡(
size
 <0Ë
	`îr‹
("MallocÉrror");

110 i‡(
‰ì_mem_±r
 <0Ë
	`îr‹
("MemoryÉrror");

112 
‰ì_mem_±r
 = (free_mem_ptr + 3) & ~3;

114 
p
 = (*)
‰ì_mem_±r
;

115 
‰ì_mem_±r
 +
size
;

117 i‡(
‰ì_mem_±r
 >
‰ì_mem_±r_íd
)

118 
	`îr‹
("Out of memory");

119  
p
;

120 
	}
}

122 
	$‰ì
(*
whîe
)

124 
	}
}

126 
	$gzù_m¨k
(**
±r
)

128 *
±r
 = (*Ë
‰ì_mem_±r
;

129 
	}
}

131 
	$gzù_ªÀa£
(**
±r
)

133 
‰ì_mem_±r
 = (Ë*
±r
;

134 
	}
}

140 
	$fûl_öbuf
()

142 i‡(
ösize
 != 0)

143 
	`îr‹
("ran out of input data");

145 
öbuf
 = 
öput_d©a
;

146 
ösize
 = 
öput_d©a_size
;

148 
ö±r
 = 1;

149  
öbuf
[0];

150 
	}
}

156 
	$Êush_wödow
()

158 
ulg
 
c
 = 
¸c
;

159 
n
;

160 
uch
 *
ö
, *
out
, 
ch
;

162 
ö
 = 
wödow
;

163 
out
 = &
ouçut_d©a
[
ouçut_±r
];

164 
n
 = 0;Ç < 
out˙t
;Ç++) {

165 
ch
 = *
out
++ = *
ö
++;

166 
c
 = 
¸c_32_èb
[(()¯^ 
ch
) & 0xff] ^ (c >> 8);

168 
¸c
 = 
c
;

169 
byãs_out
 +(
ulg
)
out˙t
;

170 
ouçut_±r
 +(
ulg
)
out˙t
;

171 
out˙t
 = 0;

173 
	}
}

175 
	$îr‹
(*
x
)

177 
	`puts
("\n\n");

178 
	`puts
(
x
);

179 
	`puts
("\n\n -- System halted");

182 
	}
}

185 
	$decom¥ess_kî√l
(*
ouçut_°¨t
,

186 *
öput_°¨t
,

187 
size_t
 
ksize
,

188 
size_t
 
kzsize
)

190 
ouçut_d©a
 = (
uch
 *)
ouçut_°¨t
;

191 
öput_d©a
 = (
uch
 *)
öput_°¨t
;

192 
öput_d©a_size
 = 
kzsize
;

195 
‰ì_mem_±r
 = (
ulg
)
ouçut_°¨t
 + 
ksize
;

196 
‰ì_mem_±r_íd
 = (
ulg
)
ouçut_°¨t
 + 
ksize
 + 0x200000;

200 
wödow
 = 
	`mÆloc
(
WSIZE
);

202 
	`make¸c
();

204 
	`gunzù
();

206  
ouçut_±r
;

207 
	}
}

	@arch/alpha/boot/tools/mkbb.c

12 
	~<f˙é.h
>

13 
	~<uni°d.h
>

14 
	~<°dio.h
>

19 #i‚de‡
MAXPARTITIONS


20 
	#MAXPARTITIONS
 8

	)

23 #i‚de‡
u8


24 
	#u8
 

	)

27 #i‚de‡
u16


28 
	#u16
 

	)

31 #i‚de‡
u32


32 
	#u32
 

	)

35 
	sdiskœbñ
 {

36 
u32
 
	md_magic
;

37 
u16
 
	md_ty≥
, 
	md_subty≥
;

38 
u8
 
	md_ty≥«me
[16];

39 
u8
 
	md_∑ck«me
[16];

40 
u32
 
	md_£csize
;

41 
u32
 
	md_n£˘‹s
;

42 
u32
 
	md_¡øcks
;

43 
u32
 
	md_ncylödîs
;

44 
u32
 
	md_£˝îcyl
;

45 
u32
 
	md_£˝πunô
;

46 
u16
 
	md_•¨e•îåack
;

47 
u16
 
	md_•¨e•îcyl
;

48 
u32
 
	md_acylödîs
;

49 
u16
 
	md_Ωm
, 
	md_öãæóve
, 
	md_åackskew
, 
	md_cylskew
;

50 
u32
 
	md_hódswôch
, 
	md_åk£ek
, 
	md_Êags
;

51 
u32
 
	md_drived©a
[5];

52 
u32
 
	md_•¨e
[5];

53 
u32
 
	md_magic2
;

54 
u16
 
	md_checksum
;

55 
u16
 
	md_≈¨tôi⁄s
;

56 
u32
 
	md_bbsize
, 
	md_sbsize
;

57 
	sd_∑πôi⁄
 {

58 
u32
 
	mp_size
;

59 
u32
 
	mp_off£t
;

60 
u32
 
	mp_fsize
;

61 
u8
 
	mp_f°y≥
;

62 
u8
 
	mp_‰ag
;

63 
u16
 
	mp_˝g
;

64 } 
	md_∑πôi⁄s
[
MAXPARTITIONS
];

68 
	u__boŸblock
 {

70 
	m__∑d1
[64];

71 
diskœbñ
 
	m__œbñ
;

72 } 
	m__u1
;

74 
	m__∑d2
[63];

75 
	m__checksum
;

76 } 
	m__u2
;

77 
	mboŸblock_byãs
[512];

78 
	mboŸblock_quadw‹ds
[64];

79 } 
	tboŸblock
;

81 
	#boŸblock_œbñ
 
__u1
.
__œbñ


	)

82 
	#boŸblock_checksum
 
__u2
.
__checksum


	)

84 
	$maö
(
¨gc
, ** 
¨gv
)

86 
boŸblock
 
boŸblock_‰om_disk
;

87 
boŸblock
 
boŸlﬂdî_image
;

88 
dev
, 
fd
;

89 
i
;

90 
ƒód
;

93 if(
¨gc
 != 3) {

94 
	`Ârötf
(
°dîr
, "Ußge: %†devi˚ÜxboŸ\n", 
¨gv
[0]);

95 
	`exô
(0);

99 
dev
 = 
	`›í
(
¨gv
[1], 
O_RDWR
);

100 if(
dev
 < 0) {

101 
	`≥º‹
(
¨gv
[1]);

102 
	`exô
(0);

106 
fd
 = 
	`›í
(
¨gv
[2], 
O_RDONLY
);

107 if(
fd
 < 0) {

108 
	`≥º‹
(
¨gv
[2]);

109 
	`˛o£
(
dev
);

110 
	`exô
(0);

114 
ƒód
 = 
	`ªad
(
fd
, &
boŸlﬂdî_image
, (
boŸblock
));

115 if(
ƒód
 !(
boŸblock
)) {

116 
	`≥º‹
("lxbootÑead");

117 
	`Ârötf
(
°dîr
, "ex≥˘ed %d, gŸ %d\n", (
boŸblock
), 
ƒód
);

118 
	`exô
(0);

122 
ƒód
 = 
	`ªad
(
dev
, &
boŸblock_‰om_disk
, (
boŸblock
));

123 if(
ƒód
 !(
boŸblock
)) {

124 
	`≥º‹
("bootblockÑead");

125 
	`Ârötf
(
°dîr
, "ex≥˘ed %d, gŸ %d\n", (
boŸblock
), 
ƒód
);

126 
	`exô
(0);

130 
boŸlﬂdî_image
.
boŸblock_œbñ
 = 
boŸblock_‰om_disk
.bootblock_label;

133 
boŸlﬂdî_image
.
boŸblock_checksum
 = 0;

134 
i
 = 0; i < 63; i++) {

135 
boŸlﬂdî_image
.
boŸblock_checksum
 +=

136 
boŸlﬂdî_image
.
boŸblock_quadw‹ds
[
i
];

140 
	`l£ek
(
dev
, 0L, 
SEEK_SET
);

141 if(
	`wrôe
(
dev
, &
boŸlﬂdî_image
, (
boŸblock
)) != (bootblock)) {

142 
	`≥º‹
("bootblock write");

143 
	`exô
(0);

146 
	`˛o£
(
fd
);

147 
	`˛o£
(
dev
);

148 
	`exô
(0);

149 
	}
}

	@arch/alpha/boot/tools/objstrip.c

16 
	~<°dio.h
>

17 
	~<°rög.h
>

18 
	~<°dlib.h
>

19 
	~<uni°d.h
>

21 
	~<sys/f˙é.h
>

22 
	~<sys/°©.h
>

23 
	~<sys/ty≥s.h
>

25 
	~<löux/a.out.h
>

26 
	~<löux/coff.h
>

27 
	~<löux/∑øm.h
>

28 #ifde‡
__ELF__


29 
	~<löux/ñf.h
>

33 
	#BLOCK_SIZE
 512

	)

35 c⁄° * 
	g¥og_«me
;

39 
	$ußge
 ()

41 
	`Ârötf
(
°dîr
,

43 " %†[-vb] fûê[£c⁄d¨y]\n", 
¥og_«me
,Örog_name);

44 
	`exô
(1);

45 
	}
}

49 
	$maö
 (
¨gc
, *
¨gv
[])

51 
size_t
 
nwrôãn
, 
toc›y
, 
n
, 
mem_size
, 
fû_size
, 
∑d
 = 0;

52 
fd
, 
ofd
, 
i
, 
j
, 
vîbo£
 = 0, 
¥im¨y
 = 0;

53 
buf
[8192], *
ö«me
;

54 
exec
 * 
aout
;

55 
off£t
;

56 #ifde‡
__ELF__


57 
ñfhdr
 *
ñf
;

58 
ñf_phdr
 *elf_phdr;

59 
e_íåy
;

62 
¥og_«me
 = 
¨gv
[0];

64 
i
 = 1; i < 
¨gc
 && 
¨gv
[i][0] == '-'; ++i) {

65 
j
 = 1; 
¨gv
[
i
][j]; ++j) {

66 
¨gv
[
i
][
j
]) {

68 
vîbo£
 = ~verbose;

72 
∑d
 = 
BLOCK_SIZE
;

76 
¥im¨y
 = 1;

82 i‡(
i
 >
¨gc
) {

83 
	`ußge
();

85 
ö«me
 = 
¨gv
[
i
++];

87 
fd
 = 
	`›í
(
ö«me
, 
O_RDONLY
);

88 i‡(
fd
 == -1) {

89 
	`≥º‹
("open");

90 
	`exô
(1);

93 
ofd
 = 1;

94 i‡(
i
 < 
¨gc
) {

95 
ofd
 = 
	`›í
(
¨gv
[
i
++], 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0666);

96 i‡(
fd
 == -1) {

97 
	`≥º‹
("open");

98 
	`exô
(1);

102 i‡(
¥im¨y
) {

105 
bb
[64], 
sum
 = 0;

106 
°©
 
°
;

107 
off_t
 
size
;

108 
i
;

110 i‡(
ofd
 == 1) {

111 
	`ußge
();

114 i‡(
	`f°©
(
fd
, &
°
) == -1) {

115 
	`≥º‹
("fstat");

116 
	`exô
(1);

119 
size
 = (
°
.
°_size
 + 
BLOCK_SIZE
 - 1) & ~(BLOCK_SIZE - 1);

120 
	`mem£t
(
bb
, 0, (bb));

121 
	`°r˝y
((*Ë
bb
, "Linux SRM bootblock");

122 
bb
[60] = 
size
 / 
BLOCK_SIZE
;

123 
bb
[61] = 1;

124 
bb
[62] = 0;

125 
i
 = 0; i < 63; ++i) {

126 
sum
 +
bb
[
i
];

128 
bb
[63] = 
sum
;

129 i‡(
	`wrôe
(
ofd
, 
bb
, (bb)) != (bb)) {

130 
	`≥º‹
("boot-block write");

131 
	`exô
(1);

133 
	`¥ötf
("%lu\n", 
size
);

139 i‡(
	`ªad
(
fd
, 
buf
, (buf)) < 0) {

140 
	`≥º‹
("read");

141 
	`exô
(1);

144 #ifde‡
__ELF__


145 
ñf
 = (
ñfhdr
 *Ë
buf
;

147 i‡(
ñf
->
e_idít
[0] =0x7‡&& 
	`°∫cmp
(elf->e_ident + 1, "ELF", 3) == 0) {

148 i‡(
ñf
->
e_ty≥
 !
ET_EXEC
) {

149 
	`Ârötf
(
°dîr
, "%s: %s isÇotán ELFÉxecutable\n",

150 
¥og_«me
, 
ö«me
);

151 
	`exô
(1);

153 i‡(!
	`ñf_check_¨ch
(
ñf
)) {

154 
	`Ârötf
(
°dîr
, "%s: isÇot forÅhisÖrocessor (e_machine=%d)\n",

155 
¥og_«me
, 
ñf
->
e_machöe
);

156 
	`exô
(1);

158 i‡(
ñf
->
e_phnum
 != 1) {

159 
	`Ârötf
(
°dîr
,

161 
¥og_«me
, 
ñf
->
e_phnum
);

164 
e_íåy
 = 
ñf
->e_entry;

166 
	`l£ek
(
fd
, 
ñf
->
e_phoff
, 
SEEK_SET
);

167 i‡(
	`ªad
(
fd
, 
buf
, (*
ñf_phdr
)) != (*elf_phdr)) {

168 
	`≥º‹
("read");

169 
	`exô
(1);

172 
ñf_phdr
 = (ñf_phd∏*Ë
buf
;

173 
off£t
 = 
ñf_phdr
->
p_off£t
;

174 
mem_size
 = 
ñf_phdr
->
p_memsz
;

175 
fû_size
 = 
ñf_phdr
->
p_fûesz
;

178 i‡(
ñf_phdr
->
p_vaddr
 < 
e_íåy
) {

179 
dñè
 = 
e_íåy
 - 
ñf_phdr
->
p_vaddr
;

180 
off£t
 +
dñè
;

181 
mem_size
 -
dñè
;

182 
fû_size
 -
dñè
;

183 
ñf_phdr
->
p_vaddr
 +
dñè
;

186 i‡(
vîbo£
) {

187 
	`Ârötf
(
°dîr
, "%s:Éxtracting %#016lx-%#016lx (at %lx)\n",

188 
¥og_«me
, (Ë
ñf_phdr
->
p_vaddr
,

189 
ñf_phdr
->
p_vaddr
 + 
fû_size
, 
off£t
);

194 
aout
 = (
exec
 *Ë
buf
;

196 i‡(!(
aout
->
fh
.
f_Êags
 & 
COFF_F_EXEC
)) {

197 
	`Ârötf
(
°dîr
, "%s: %s isÇot inÉxecutable format\n",

198 
¥og_«me
, 
ö«me
);

199 
	`exô
(1);

202 i‡(
aout
->
fh
.
f_›thdr
 !◊out->
ah
)) {

203 
	`Ârötf
(
°dîr
, "%s: %s has unexpected optional header size\n",

204 
¥og_«me
, 
ö«me
);

205 
	`exô
(1);

208 i‡(
	`N_MAGIC
(*
aout
Ë!
OMAGIC
) {

209 
	`Ârötf
(
°dîr
, "%s: %s isÇotán OMAGIC file\n",

210 
¥og_«me
, 
ö«me
);

211 
	`exô
(1);

213 
off£t
 = 
	`N_TXTOFF
(*
aout
);

214 
fû_size
 = 
aout
->
ah
.
tsize
 +áout->ah.
dsize
;

215 
mem_size
 = 
fû_size
 + 
aout
->
ah
.
bsize
;

217 i‡(
vîbo£
) {

218 
	`Ârötf
(
°dîr
, "%s:Éxtracting %#016lx-%#016lx (at %lx)\n",

219 
¥og_«me
, 
aout
->
ah
.
ãxt_°¨t
,

220 
aout
->
ah
.
ãxt_°¨t
 + 
fû_size
, 
off£t
);

224 i‡(
	`l£ek
(
fd
, 
off£t
, 
SEEK_SET
) != offset) {

225 
	`≥º‹
("lseek");

226 
	`exô
(1);

229 i‡(
vîbo£
) {

230 
	`Ârötf
(
°dîr
, "%s: copying %lu byte from %s\n",

231 
¥og_«me
, (Ë
fû_size
, 
ö«me
);

234 
toc›y
 = 
fû_size
;

235 
toc›y
 > 0) {

236 
n
 = 
toc›y
;

237 i‡(
n
 > (
buf
)) {

238 
n
 = (
buf
);

240 
toc›y
 -
n
;

241 i‡((
size_t
Ë
	`ªad
(
fd
, 
buf
, 
n
) !=Ç) {

242 
	`≥º‹
("read");

243 
	`exô
(1);

246 
nwrôãn
 = 
	`wrôe
(
ofd
, 
buf
, 
n
);

247 i‡((
ssize_t
Ë
nwrôãn
 == -1) {

248 
	`≥º‹
("write");

249 
	`exô
(1);

251 
n
 -
nwrôãn
;

252 } 
n
 > 0);

255 i‡(
∑d
) {

256 
mem_size
 = ((mem_sizê+ 
∑d
 - 1) /Öad) *Öad;

259 
toc›y
 = 
mem_size
 - 
fû_size
;

260 i‡(
toc›y
 > 0) {

261 
	`Ârötf
(
°dîr
,

263 
¥og_«me
, 
∑d
, (Ë
toc›y
);

265 
	`mem£t
(
buf
, 0x00, (buf));

267 
n
 = 
toc›y
;

268 i‡(
n
 > (
buf
)) {

269 
n
 = (
buf
);

271 
nwrôãn
 = 
	`wrôe
(
ofd
, 
buf
, 
n
);

272 i‡((
ssize_t
Ë
nwrôãn
 == -1) {

273 
	`≥º‹
("write");

274 
	`exô
(1);

276 
toc›y
 -
nwrôãn
;

277 } 
toc›y
 > 0);

280 
	}
}

	@arch/alpha/kernel/alpha_ksyms.c

8 
	~<löux/moduÀ.h
>

9 
	~<asm/c⁄sﬁe.h
>

10 
	~<asm/uac˚ss.h
>

11 
	~<asm/checksum.h
>

12 
	~<asm/Âu.h
>

13 
	~<asm/machvec.h
>

15 
	~<löux/sysˇŒs.h
>

18 
__divl
 ();

19 
__ªml
 ();

20 
__divq
 ();

21 
__ªmq
 ();

22 
__divlu
 ();

23 
__ªmlu
 ();

24 
__divqu
 ();

25 
__ªmqu
 ();

27 
EXPORT_SYMBOL
(
Æpha_mv
);

28 
EXPORT_SYMBOL
(
ˇŒback_gëív
);

29 
EXPORT_SYMBOL
(
ˇŒback_£ãnv
);

30 
EXPORT_SYMBOL
(
ˇŒback_ßve_ív
);

33 
EXPORT_SYMBOL
(
°rˇt
);

34 
EXPORT_SYMBOL
(
°r˝y
);

35 
EXPORT_SYMBOL
(
°æí
);

36 
EXPORT_SYMBOL
(
°∫˝y
);

37 
EXPORT_SYMBOL
(
°∫ˇt
);

38 
EXPORT_SYMBOL
(
°rchr
);

39 
EXPORT_SYMBOL
(
°ºchr
);

40 
EXPORT_SYMBOL
(
memmove
);

41 
EXPORT_SYMBOL
(
__mem˝y
);

42 
EXPORT_SYMBOL
(
__mem£t
);

43 
EXPORT_SYMBOL
(
__mem£tw
);

44 
EXPORT_SYMBOL
(
__c⁄°™t_c_mem£t
);

45 
EXPORT_SYMBOL
(
c›y_∑ge
);

46 
EXPORT_SYMBOL
(
˛ór_∑ge
);

48 
EXPORT_SYMBOL
(
Æpha_ªad_Â_ªg
);

49 
EXPORT_SYMBOL
(
Æpha_ªad_Â_ªg_s
);

50 
EXPORT_SYMBOL
(
Æpha_wrôe_Â_ªg
);

51 
EXPORT_SYMBOL
(
Æpha_wrôe_Â_ªg_s
);

54 
EXPORT_SYMBOL
(
kî√l_thªad
);

55 
EXPORT_SYMBOL
(
kî√l_execve
);

58 
EXPORT_SYMBOL
(
csum_t˝udp_magic
);

59 
EXPORT_SYMBOL
(
ù_compuã_csum
);

60 
EXPORT_SYMBOL
(
ù_Á°_csum
);

61 
EXPORT_SYMBOL
(
csum_∑πül_c›y_nocheck
);

62 
EXPORT_SYMBOL
(
csum_∑πül_c›y_‰om_u£r
);

63 
EXPORT_SYMBOL
(
csum_ùv6_magic
);

65 #ifde‡
CONFIG_MATHEMU_MODULE


66 (*
Æpha_Â_emul_im¥eci£
)(
±_ªgs
 *, );

67 (*
Æpha_Â_emul
Ë(
pc
);

68 
	`EXPORT_SYMBOL
(
Æpha_Â_emul_im¥eci£
);

69 
	`EXPORT_SYMBOL
(
Æpha_Â_emul
);

75 
	`EXPORT_SYMBOL
(
__c›y_u£r
);

76 
	`EXPORT_SYMBOL
(
__do_˛ór_u£r
);

77 
	`EXPORT_SYMBOL
(
__°∫˝y_‰om_u£r
);

78 
	`EXPORT_SYMBOL
(
__°∫Àn_u£r
);

81 
	`EXPORT_SYMBOL
(
__down_Áûed
);

82 
	`EXPORT_SYMBOL
(
__down_Áûed_öãºu±ibÀ
);

83 
	`EXPORT_SYMBOL
(
__up_wakeup
);

84 
	`EXPORT_SYMBOL
(
down
);

85 
	`EXPORT_SYMBOL
(
down_öãºu±ibÀ
);

86 
	`EXPORT_SYMBOL
(
down_åylock
);

87 
	`EXPORT_SYMBOL
(
up
);

93 #ifde‡
CONFIG_SMP


94 
	`EXPORT_SYMBOL
(
_©omic_dec_™d_lock
);

104 #unde‡
mem˝y


105 #unde‡
mem£t


106 
	`EXPORT_SYMBOL
(
__divl
);

107 
	`EXPORT_SYMBOL
(
__divlu
);

108 
	`EXPORT_SYMBOL
(
__divq
);

109 
	`EXPORT_SYMBOL
(
__divqu
);

110 
	`EXPORT_SYMBOL
(
__ªml
);

111 
	`EXPORT_SYMBOL
(
__ªmlu
);

112 
	`EXPORT_SYMBOL
(
__ªmq
);

113 
	`EXPORT_SYMBOL
(
__ªmqu
);

114 
	`EXPORT_SYMBOL
(
mem˝y
);

115 
	`EXPORT_SYMBOL
(
mem£t
);

116 
	`EXPORT_SYMBOL
(
memchr
);

	@arch/alpha/kernel/asm-offsets.c

7 
	~<löux/ty≥s.h
>

8 
	~<löux/°ddef.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/±ø˚.h
>

11 
	~<asm/io.h
>

13 
	#DEFINE
(
sym
, 
vÆ
) \

14 
asm
 vﬁ©ûe("\n->" #sym " %0 " #vÆ : : "i" (
vÆ
))

	)

16 
	#BLANK
(Ë
asm
 vﬁ©ûe("\n->" : : )

	)

18 
	$foo
()

20 
	`DEFINE
(
TI_TASK
, 
	`off£tof
(
thªad_öfo
, 
èsk
));

21 
	`DEFINE
(
TI_FLAGS
, 
	`off£tof
(
thªad_öfo
, 
Êags
));

22 
	`DEFINE
(
TI_CPU
, 
	`off£tof
(
thªad_öfo
, 
˝u
));

23 
	`BLANK
();

25 
	`DEFINE
(
TASK_BLOCKED
, 
	`off£tof
(
èsk_°ru˘
, 
blocked
));

26 
	`DEFINE
(
TASK_UID
, 
	`off£tof
(
èsk_°ru˘
, 
uid
));

27 
	`DEFINE
(
TASK_EUID
, 
	`off£tof
(
èsk_°ru˘
, 
euid
));

28 
	`DEFINE
(
TASK_GID
, 
	`off£tof
(
èsk_°ru˘
, 
gid
));

29 
	`DEFINE
(
TASK_EGID
, 
	`off£tof
(
èsk_°ru˘
, 
egid
));

30 
	`DEFINE
(
TASK_REAL_PARENT
, 
	`off£tof
(
èsk_°ru˘
, 
ªÆ_∑ª¡
));

31 
	`DEFINE
(
TASK_GROUP_LEADER
, 
	`off£tof
(
èsk_°ru˘
, 
group_Àadî
));

32 
	`DEFINE
(
TASK_TGID
, 
	`off£tof
(
èsk_°ru˘
, 
tgid
));

33 
	`BLANK
();

35 
	`DEFINE
(
SIZEOF_PT_REGS
, (
±_ªgs
));

36 
	`DEFINE
(
PT_PTRACED
, PT_PTRACED);

37 
	`DEFINE
(
CLONE_VM
, CLONE_VM);

38 
	`DEFINE
(
CLONE_UNTRACED
, CLONE_UNTRACED);

39 
	`DEFINE
(
SIGCHLD
, SIGCHLD);

40 
	`BLANK
();

42 
	`DEFINE
(
HAE_CACHE
, 
	`off£tof
(
Æpha_machöe_ve˘‹
, 
h´_ˇche
));

43 
	`DEFINE
(
HAE_REG
, 
	`off£tof
(
Æpha_machöe_ve˘‹
, 
h´_ªgi°î
));

44 
	}
}

	@arch/alpha/kernel/console.c

8 
	~<löux/pci.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/ây.h
>

11 
	~<löux/c⁄sﬁe.h
>

12 
	~<löux/vt.h
>

13 
	~<asm/vga.h
>

14 
	~<asm/machvec.h
>

16 
	~"pci_im∂.h
"

18 #ifde‡
CONFIG_VGA_HOSE


20 
pci_c⁄åﬁÀr
 *
	gpci_vga_ho£
;

21 
ªsour˚
 
	gÆpha_vga
 = {

22 .
«me
 = "alpha-vga+",

23 .
	g°¨t
 = 0x3C0,

24 .
	gíd
 = 0x3DF

27 
pci_c⁄åﬁÀr
 * 
__öô


28 
	$deÁu…_vga_ho£_£À˘
(
pci_c⁄åﬁÀr
 *
h1
, pci_c⁄åﬁÀ∏*
h2
)

30 i‡(
h2
->
ödex
 < 
h1
->index)

31  
h2
;

33  
h1
;

34 
	}
}

36 
__öô


37 
loˇã_™d_öô_vga
(*(*
£l_func
)(*, *))

39 
pci_c⁄åﬁÀr
 *
	gho£
 = 
NULL
;

40 
pci_dev
 *
	gdev
 = 
NULL
;

43 i‡(!
	g£l_func
Ë£l_fun¯(*)
deÁu…_vga_ho£_£À˘
;

46 
	gdev
=
NULL
; (dev=
pci_gë_˛ass
(
PCI_CLASS_DISPLAY_VGA
 << 8, 
dev
));) {

47 i‡(!
	gho£
)

48 
	gho£
 = 
dev
->
sysd©a
;

50 
	gho£
 = 
£l_func
(
ho£
, 
dev
->
sysd©a
);

54 i‡(!
	gho£
 || (
	gc⁄swôchp
 =&
vga_c⁄
 && 
pci_vga_ho£
 =
ho£
))

58 
	gÆpha_vga
.
	g°¨t
 +
ho£
->
io_•a˚
->
°¨t
;

59 
	gÆpha_vga
.
	gíd
 +
ho£
->
io_•a˚
->
°¨t
;

60 
ªque°_ªsour˚
(
ho£
->
io_•a˚
, &
Æpha_vga
);

63 
	gpci_vga_ho£
 = 
ho£
;

64 
èke_ovî_c⁄sﬁe
(&
vga_c⁄
, 0, 
MAX_NR_CONSOLES
-1, 1);

67 
__öô


68 
	$föd_c⁄sﬁe_vga_ho£
()

70 
u64
 *
pu64
 = (u64 *)((u64)
hwΩb
 + hwΩb->
˘bt_off£t
);

72 i‡(
pu64
[7] == 3) {

73 
pci_c⁄åﬁÀr
 *
ho£
;

74 
h
 = (
pu64
[30] >> 24) & 0xff;

80 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
) {

81 i‡(
ho£
->
ödex
 =
h
) ;

84 i‡(
ho£
) {

85 
	`¥ötk
("C⁄sﬁêgøphic†⁄ ho£ %d\n", 
h
);

86 
pci_vga_ho£
 = 
ho£
;

89 
	}
}

	@arch/alpha/kernel/core_apecs.c

13 
	#__EXTERN_INLINE
 
ölöe


	)

14 
	~<asm/io.h
>

15 
	~<asm/c‹e_≠ecs.h
>

16 #unde‡
__EXTERN_INLINE


18 
	~<löux/ty≥s.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/öô.h
>

22 
	~<asm/±ø˚.h
>

23 
	~<asm/smp.h
>

25 
	~"¥Ÿo.h
"

26 
	~"pci_im∂.h
"

38 
	#DEBUG_CONFIG
 0

	)

40 #i‡
DEBUG_CONFIG


41 
	#DBGC
(
¨gs
Ë
¥ötk
 
	)
args

43 
	#DBGC
(
¨gs
)

	)

46 
	#vuù
 vﬁ©ûê*

	)

91 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

92 *
pci_addr
, *
ty≥1
)

94 
addr
;

95 
u8
 
bus
 = 
pbus
->
numbî
;

97 
	`DBGC
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x,"

99 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

101 i‡(
bus
 == 0) {

102 
devi˚
 = 
devi˚_‚
 >> 3;

106 i‡(
devi˚
 > 20) {

107 
	`DBGC
(("mk_conf_addr: device (%d) > 20,Ñeturning -1\n",

108 
devi˚
));

112 *
ty≥1
 = 0;

113 
addr
 = (
devi˚_‚
 << 8Ë| (
whîe
);

116 *
ty≥1
 = 1;

117 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| (
whîe
);

119 *
pci_addr
 = 
addr
;

120 
	`DBGC
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

122 
	}
}

125 
	$c⁄f_ªad
(
addr
, 
ty≥1
)

127 
Êags
;

128 
°©0
, 
vÆue
;

129 
haxr2
 = 0;

131 
	`loˇl_úq_ßve
(
Êags
);

133 
	`DBGC
(("c⁄f_ªad◊ddr=0x%lx,Åy≥1=%d)\n", 
addr
, 
ty≥1
));

136 
°©0
 = *(
vuù
)
APECS_IOC_DCSR
;

137 *(
vuù
)
APECS_IOC_DCSR
 = 
°©0
;

138 
	`mb
();

139 
	`DBGC
(("c⁄f_ªad: APECS DCSR wa†0x%x\n", 
°©0
));

142 i‡(
ty≥1
) {

143 
haxr2
 = *(
vuù
)
APECS_IOC_HAXR2
;

144 
	`mb
();

145 *(
vuù
)
APECS_IOC_HAXR2
 = 
haxr2
 | 1;

146 
	`DBGC
(("conf_read: TYPE1áccess\n"));

149 
	`døöa
();

150 
	`mcheck_ex≥˘ed
(0) = 1;

151 
	`mcheck_èkí
(0) = 0;

152 
	`mb
();

157 
asm
 vﬁ©ûe("ld»%0,%1; mb; mb" : "Ù"(
vÆue
Ë: "m"(*(
vuù
)
addr
)

160 i‡(
	`mcheck_èkí
(0)) {

161 
	`mcheck_èkí
(0) = 0;

162 
vÆue
 = 0xffffffffU;

163 
	`mb
();

165 
	`mcheck_ex≥˘ed
(0) = 0;

166 
	`mb
();

175 
	`døöa
();

178 
°©0
 = *(
vuù
)
APECS_IOC_DCSR
;

179 
	`DBGC
(("c⁄f_ªad: APECS DCSRá·îÑód 0x%x\n", 
°©0
));

182 i‡(
°©0
 & 0xffe0U) {

184 i‡(!(
°©0
 & 0x0800)) {

185 
	`¥ötk
("≠ecs.c:c⁄f_ªad: gŸ sèt0=%x\n", 
°©0
);

189 *(
vuù
)
APECS_IOC_DCSR
 = 
°©0
;

190 
	`mb
();

191 
	`wrm˚s
(0x7);

192 
vÆue
 = 0xffffffff;

197 i‡(
ty≥1
) {

198 *(
vuù
)
APECS_IOC_HAXR2
 = 
haxr2
 & ~1;

199 
	`mb
();

201 
	`loˇl_úq_ª°‹e
(
Êags
);

203  
vÆue
;

204 
	}
}

207 
	$c⁄f_wrôe
(
addr
, 
vÆue
, 
ty≥1
)

209 
Êags
;

210 
°©0
;

211 
haxr2
 = 0;

213 
	`loˇl_úq_ßve
(
Êags
);

216 
°©0
 = *(
vuù
)
APECS_IOC_DCSR
;

217 *(
vuù
)
APECS_IOC_DCSR
 = 
°©0
;

218 
	`mb
();

221 i‡(
ty≥1
) {

222 
haxr2
 = *(
vuù
)
APECS_IOC_HAXR2
;

223 
	`mb
();

224 *(
vuù
)
APECS_IOC_HAXR2
 = 
haxr2
 | 1;

227 
	`døöa
();

228 
	`mcheck_ex≥˘ed
(0) = 1;

229 
	`mb
();

232 *(
vuù
)
addr
 = 
vÆue
;

233 
	`mb
();

234 
	`mb
();

235 
	`mcheck_ex≥˘ed
(0) = 0;

236 
	`mb
();

245 
	`døöa
();

248 
°©0
 = *(
vuù
)
APECS_IOC_DCSR
;

251 i‡(
°©0
 & 0xffe0U) {

253 i‡(!(
°©0
 & 0x0800)) {

254 
	`¥ötk
("≠ecs.c:c⁄f_wrôe: gŸ sèt0=%x\n", 
°©0
);

258 *(
vuù
)
APECS_IOC_DCSR
 = 
°©0
;

259 
	`mb
();

260 
	`wrm˚s
(0x7);

265 i‡(
ty≥1
) {

266 *(
vuù
)
APECS_IOC_HAXR2
 = 
haxr2
 & ~1;

267 
	`mb
();

269 
	`loˇl_úq_ª°‹e
(
Êags
);

270 
	}
}

273 
	$≠ecs_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

274 
size
, 
u32
 *
vÆue
)

276 
addr
, 
pci_addr
;

277 
ty≥1
;

278 
mask
;

279 
shi·
;

281 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

282  
PCIBIOS_DEVICE_NOT_FOUND
;

284 
mask
 = (
size
 - 1) * 8;

285 
shi·
 = (
whîe
 & 3) * 8;

286 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
APECS_CONF
;

287 *
vÆue
 = 
	`c⁄f_ªad
(
addr
, 
ty≥1
Ë>> (
shi·
);

288  
PCIBIOS_SUCCESSFUL
;

289 
	}
}

292 
	$≠ecs_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

293 
size
, 
u32
 
vÆue
)

295 
addr
, 
pci_addr
;

296 
ty≥1
;

297 
mask
;

299 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

300  
PCIBIOS_DEVICE_NOT_FOUND
;

302 
mask
 = (
size
 - 1) * 8;

303 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
APECS_CONF
;

304 
	`c⁄f_wrôe
(
addr
, 
vÆue
 << ((
whîe
 & 3Ë* 8), 
ty≥1
);

305  
PCIBIOS_SUCCESSFUL
;

306 
	}
}

308 
pci_›s
 
	g≠ecs_pci_›s
 =

310 .
ªad
 = 
≠ecs_ªad_c⁄fig
,

311 .
	gwrôe
 = 
≠ecs_wrôe_c⁄fig
,

315 
	$≠ecs_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

317 
	`wmb
();

318 *(
vù
)
APECS_IOC_TBIA
 = 0;

319 
	`mb
();

320 
	}
}

322 
__öô


323 
	$≠ecs_öô_¨ch
()

325 
pci_c⁄åﬁÀr
 *
ho£
;

331 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

332 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

333 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

334 
ho£
->
ödex
 = 0;

336 
ho£
->
•¨£_mem_ba£
 = 
APECS_SPARSE_MEM
 - 
IDENT_ADDR
;

337 
ho£
->
dí£_mem_ba£
 = 
APECS_DENSE_MEM
 - 
IDENT_ADDR
;

338 
ho£
->
•¨£_io_ba£
 = 
APECS_IO
 - 
IDENT_ADDR
;

339 
ho£
->
dí£_io_ba£
 = 0;

347 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

348 
ho£
->
sg_pci
 = 
NULL
;

349 
__dúe˘_m≠_ba£
 = 0x40000000;

350 
__dúe˘_m≠_size
 = 0x40000000;

352 *(
vuù
)
APECS_IOC_PB1R
 = 
__dúe˘_m≠_ba£
 | 0x00080000;

353 *(
vuù
)
APECS_IOC_PM1R
 = (
__dúe˘_m≠_size
 - 1) & 0xfff00000U;

354 *(
vuù
)
APECS_IOC_TB1R
 = 0;

356 *(
vuù
)
APECS_IOC_PB2R
 = 
ho£
->
sg_iß
->
dma_ba£
 | 0x000c0000;

357 *(
vuù
)
APECS_IOC_PM2R
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

358 *(
vuù
)
APECS_IOC_TB2R
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
) >> 1;

360 
	`≠ecs_pci_tbi
(
ho£
, 0, -1);

368 *(
vuù
)
APECS_IOC_HAXR2
 = 0;

369 
	`mb
();

370 
	}
}

373 
	$≠ecs_pci_˛r_îr
()

375 
jd
;

377 
jd
 = *(
vuù
)
APECS_IOC_DCSR
;

378 i‡(
jd
 & 0xffe0L) {

379 *(
vuù
)
APECS_IOC_SEAR
;

380 *(
vuù
)
APECS_IOC_DCSR
 = 
jd
 | 0xffe1L;

381 
	`mb
();

382 *(
vuù
)
APECS_IOC_DCSR
;

384 *(
vuù
)
APECS_IOC_TBIA
 = ()APECS_IOC_TBIA;

385 
	`mb
();

386 *(
vuù
)
APECS_IOC_TBIA
;

387 
	}
}

390 
	$≠ecs_machöe_check
(
ve˘‹
, 
œ_±r
)

392 
ñ_comm⁄
 *
mchk_hódî
;

393 
ñ_≠ecs_¥ocd©a
 *
mchk_¥ocd©a
;

394 
ñ_≠ecs_sysd©a_mcheck
 *
mchk_sysd©a
;

396 
mchk_hódî
 = (
ñ_comm⁄
 *)
œ_±r
;

398 
mchk_¥ocd©a
 = (
ñ_≠ecs_¥ocd©a
 *)

399 (
œ_±r
 + 
mchk_hódî
->
¥oc_off£t


400 - (
mchk_¥ocd©a
->
∑…emp
));

402 
mchk_sysd©a
 = (
ñ_≠ecs_sysd©a_mcheck
 *)

403 (
œ_±r
 + 
mchk_hódî
->
sys_off£t
);

407 
	`mb
();

408 
	`mb
();

409 
	`døöa
();

410 
	`≠ecs_pci_˛r_îr
();

411 
	`wrm˚s
(0x7);

412 
	`mb
();

414 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "APECS",

415 (
	`mcheck_ex≥˘ed
(0)

416 && (
mchk_sysd©a
->
ïic_dc§
 & 0x0c00UL)));

417 
	}
}

	@arch/alpha/kernel/core_cia.c

14 
	#__EXTERN_INLINE
 
ölöe


	)

15 
	~<asm/io.h
>

16 
	~<asm/c‹e_cü.h
>

17 #unde‡
__EXTERN_INLINE


19 
	~<löux/ty≥s.h
>

20 
	~<löux/pci.h
>

21 
	~<löux/sched.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/boŸmem.h
>

25 
	~<asm/±ø˚.h
>

27 
	~"¥Ÿo.h
"

28 
	~"pci_im∂.h
"

37 
	#DEBUG_CONFIG
 0

	)

38 #i‡
DEBUG_CONFIG


39 
	#DBGC
(
¨gs
Ë
¥ötk
 
	)
args

41 
	#DBGC
(
¨gs
)

	)

44 
	#vù
 vﬁ©ûê*

	)

88 
	$mk_c⁄f_addr
(
pci_bus
 *
bus_dev
, 
devi˚_‚
, 
whîe
,

89 *
pci_addr
, *
ty≥1
)

91 
u8
 
bus
 = 
bus_dev
->
numbî
;

93 *
ty≥1
 = (
bus
 != 0);

94 *
pci_addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

96 
	`DBGC
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x,"

98 
bus
, 
devi˚_‚
, 
whîe
, *
pci_addr
));

101 
	}
}

104 
	$c⁄f_ªad
(
addr
, 
ty≥1
)

106 
Êags
;

107 
°©0
, 
vÆue
;

108 
cü_cfg
 = 0;

110 
	`DBGC
(("c⁄f_ªad◊ddr=0x%lx,Åy≥1=%dË", 
addr
, 
ty≥1
));

111 
	`loˇl_úq_ßve
(
Êags
);

114 
°©0
 = *(
vù
)
CIA_IOC_CIA_ERR
;

115 *(
vù
)
CIA_IOC_CIA_ERR
 = 
°©0
;

116 
	`mb
();

117 *(
vù
)
CIA_IOC_CIA_ERR
;

120 i‡(
ty≥1
) {

121 
cü_cfg
 = *(
vù
)
CIA_IOC_CFG
;

122 *(
vù
)
CIA_IOC_CFG
 = (
cü_cfg
 & ~3) | 1;

123 
	`mb
();

124 *(
vù
)
CIA_IOC_CFG
;

127 
	`mb
();

128 
	`døöa
();

129 
	`mcheck_ex≥˘ed
(0) = 1;

130 
	`mcheck_èkí
(0) = 0;

131 
	`mb
();

134 
vÆue
 = *(
vù
)
addr
;

135 
	`mb
();

136 
	`mb
();

137 i‡(
	`mcheck_èkí
(0)) {

138 
	`mcheck_èkí
(0) = 0;

139 
vÆue
 = 0xffffffff;

140 
	`mb
();

142 
	`mcheck_ex≥˘ed
(0) = 0;

143 
	`mb
();

146 i‡(
ty≥1
) {

147 *(
vù
)
CIA_IOC_CFG
 = 
cü_cfg
;

148 
	`mb
();

149 *(
vù
)
CIA_IOC_CFG
;

152 
	`loˇl_úq_ª°‹e
(
Êags
);

153 
	`DBGC
(("done\n"));

155  
vÆue
;

156 
	}
}

159 
	$c⁄f_wrôe
(
addr
, 
vÆue
, 
ty≥1
)

161 
Êags
;

162 
°©0
, 
cü_cfg
 = 0;

164 
	`DBGC
(("c⁄f_wrôe◊ddr=0x%lx,Åy≥1=%dË", 
addr
, 
ty≥1
));

165 
	`loˇl_úq_ßve
(
Êags
);

168 
°©0
 = *(
vù
)
CIA_IOC_CIA_ERR
;

169 *(
vù
)
CIA_IOC_CIA_ERR
 = 
°©0
;

170 
	`mb
();

171 *(
vù
)
CIA_IOC_CIA_ERR
;

174 i‡(
ty≥1
) {

175 
cü_cfg
 = *(
vù
)
CIA_IOC_CFG
;

176 *(
vù
)
CIA_IOC_CFG
 = (
cü_cfg
 & ~3) | 1;

177 
	`mb
();

178 *(
vù
)
CIA_IOC_CFG
;

181 
	`mb
();

182 
	`døöa
();

183 
	`mcheck_ex≥˘ed
(0) = 1;

184 
	`mcheck_èkí
(0) = 0;

185 
	`mb
();

188 *(
vù
)
addr
 = 
vÆue
;

189 
	`mb
();

190 *(
vù
)
addr
;

192 
	`mcheck_ex≥˘ed
(0) = 0;

193 
	`mb
();

196 i‡(
ty≥1
) {

197 *(
vù
)
CIA_IOC_CFG
 = 
cü_cfg
;

198 
	`mb
();

199 *(
vù
)
CIA_IOC_CFG
;

202 
	`loˇl_úq_ª°‹e
(
Êags
);

203 
	`DBGC
(("done\n"));

204 
	}
}

207 
	$cü_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
,

208 
u32
 *
vÆue
)

210 
addr
, 
pci_addr
;

211 
mask
;

212 
ty≥1
;

213 
shi·
;

215 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

216  
PCIBIOS_DEVICE_NOT_FOUND
;

218 
mask
 = (
size
 - 1) * 8;

219 
shi·
 = (
whîe
 & 3) * 8;

220 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
CIA_CONF
;

221 *
vÆue
 = 
	`c⁄f_ªad
(
addr
, 
ty≥1
Ë>> (
shi·
);

222  
PCIBIOS_SUCCESSFUL
;

223 
	}
}

226 
	$cü_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
,

227 
u32
 
vÆue
)

229 
addr
, 
pci_addr
;

230 
mask
;

231 
ty≥1
;

233 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

234  
PCIBIOS_DEVICE_NOT_FOUND
;

236 
mask
 = (
size
 - 1) * 8;

237 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
CIA_CONF
;

238 
	`c⁄f_wrôe
(
addr
, 
vÆue
 << ((
whîe
 & 3Ë* 8), 
ty≥1
);

239  
PCIBIOS_SUCCESSFUL
;

240 
	}
}

242 
pci_›s
 
	gcü_pci_›s
 =

244 .
ªad
 = 
cü_ªad_c⁄fig
,

245 .
	gwrôe
 = 
cü_wrôe_c⁄fig
,

255 
	$cü_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

257 
	`wmb
();

258 *(
vù
)
CIA_IOC_PCI_TBIA
 = 3;

259 
	`mb
();

260 *(
vù
)
CIA_IOC_PCI_TBIA
;

261 
	}
}

277 
	#CIA_BROKEN_TBIA_BASE
 0x30000000

	)

278 
	#CIA_BROKEN_TBIA_SIZE
 1024

	)

282 
	$cü_pci_tbi_åy2
(
pci_c⁄åﬁÀr
 *
ho£
,

283 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

285 
__iomem
 *
bus_addr
;

286 
˘æ
;

289 
	`mb
();

290 
˘æ
 = *(
vù
)
CIA_IOC_CIA_CTRL
;

291 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
˘æ
 | 
CIA_CTRL_PCI_LOOP_EN
;

292 
	`mb
();

293 *(
vù
)
CIA_IOC_CIA_CTRL
;

294 
	`mb
();

308 
bus_addr
 = 
	`cü_i‹em≠
(
CIA_BROKEN_TBIA_BASE
, 32768 * 4);

310 
	`cü_ªadl
(
bus_addr
 + 0x00000);

311 
	`cü_ªadl
(
bus_addr
 + 0x08000);

312 
	`cü_ªadl
(
bus_addr
 + 0x10000);

313 
	`cü_ªadl
(
bus_addr
 + 0x18000);

315 
	`cü_iounm≠
(
bus_addr
);

318 
	`mb
();

319 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
˘æ
;

320 
	`mb
();

321 *(
vù
)
CIA_IOC_CIA_CTRL
;

322 
	`mb
();

323 
	}
}

325 
ölöe
 

326 
	$cü_¥ï¨e_tbü_w‹k¨ound
(
wödow
)

328 *
µã
, 
±e
;

329 
i
;

332 
µã
 = 
	`__Æloc_boŸmem
(
CIA_BROKEN_TBIA_SIZE
, 32768, 0);

333 
±e
 = (
	`vút_to_phys
(
µã
Ë>> (
PAGE_SHIFT
 - 1)) | 1;

335 
i
 = 0; i < 
CIA_BROKEN_TBIA_SIZE
 / (); ++i)

336 
µã
[
i
] = 
±e
;

338 *(
vù
)
	`CIA_IOC_PCI_Wn_BASE
(
wödow
Ë
CIA_BROKEN_TBIA_BASE
 | 3;

339 *(
vù
)
	`CIA_IOC_PCI_Wn_MASK
(
wödow
)

340 (
CIA_BROKEN_TBIA_SIZE
*1024 - 1) & 0xfff00000;

341 *(
vù
)
	`CIA_IOC_PCI_Tn_BASE
(
wödow
Ë
	`vút_to_phys
(
µã
) >> 2;

342 
	}
}

344 
__öô


345 
	$vîify_tb_›î©i⁄
()

347 
∑ge
[
PAGE_SIZE
/4]

348 
	`__©åibuã__
((
	`Æig√d
(
PAGE_SIZE
)))

349 
__öôd©a
 = { 0 };

351 
pci_iommu_¨ía
 *
¨ía
 = 
pci_iß_ho£
->
sg_iß
;

352 
˘æ
, 
addr0
, 
èg0
, 
±e0
, 
d©a0
;

353 
ãmp
, 
u£_tbü_åy2
 = 0;

354 
__iomem
 *
bus_addr
;

357 i‡(
pci_iß_ho£
->
dí£_io_ba£
)

358 
u£_tbü_åy2
 = 1;

361 
	`mb
();

362 
˘æ
 = *(
vù
)
CIA_IOC_CIA_CTRL
;

363 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
˘æ
 | 
CIA_CTRL_PCI_LOOP_EN
;

364 
	`mb
();

365 *(
vù
)
CIA_IOC_CIA_CTRL
;

366 
	`mb
();

370 
addr0
 = 
¨ía
->
dma_ba£
;

371 
èg0
 = 
addr0
 | 1;

372 
±e0
 = (
	`vút_to_phys
(
∑ge
Ë>> (
PAGE_SHIFT
 - 1)) | 1;

374 *(
vù
)
	`CIA_IOC_TB_TAGn
(0Ë
èg0
;

375 *(
vù
)
	`CIA_IOC_TB_TAGn
(1) = 0;

376 *(
vù
)
	`CIA_IOC_TB_TAGn
(2) = 0;

377 *(
vù
)
	`CIA_IOC_TB_TAGn
(3) = 0;

378 *(
vù
)
	`CIA_IOC_TB_TAGn
(4) = 0;

379 *(
vù
)
	`CIA_IOC_TB_TAGn
(5) = 0;

380 *(
vù
)
	`CIA_IOC_TB_TAGn
(6) = 0;

381 *(
vù
)
	`CIA_IOC_TB_TAGn
(7) = 0;

382 *(
vù
)
	`CIA_IOC_TBn_PAGEm
(0,0Ë
±e0
;

383 *(
vù
)
	`CIA_IOC_TBn_PAGEm
(0,1) = 0;

384 *(
vù
)
	`CIA_IOC_TBn_PAGEm
(0,2) = 0;

385 *(
vù
)
	`CIA_IOC_TBn_PAGEm
(0,3) = 0;

386 
	`mb
();

389 
bus_addr
 = 
	`cü_i‹em≠
(
addr0
, 8*
PAGE_SIZE
);

399 
ãmp
 = *(
vù
)
	`CIA_IOC_TB_TAGn
(0);

400 i‡(
ãmp
 !
èg0
) {

401 
	`¥ötk
("pci: failedÅbÑegister updateÅest "

402 "—ag0 %#x !%#x)\n", 
ãmp
, 
èg0
);

403 
Áûed
;

405 
ãmp
 = *(
vù
)
	`CIA_IOC_TB_TAGn
(1);

406 i‡(
ãmp
 != 0) {

407 
	`¥ötk
("pci: failedÅbÑegister updateÅest "

408 "—ag1 %#x !0)\n", 
ãmp
);

409 
Áûed
;

411 
ãmp
 = *(
vù
)
	`CIA_IOC_TBn_PAGEm
(0,0);

412 i‡(
ãmp
 !
±e0
) {

413 
	`¥ötk
("pci: failedÅbÑegister updateÅest "

414 "’ã0 %#x !%#x)\n", 
ãmp
, 
±e0
);

415 
Áûed
;

417 
	`¥ötk
("pci:ÖassedÅbÑegister updateÅest\n");

421 
d©a0
 = 0xdeadbeef;

422 
∑ge
[0] = 
d©a0
;

423 
	`mcheck_ex≥˘ed
(0) = 1;

424 
	`mcheck_èkí
(0) = 0;

425 
	`mb
();

426 
ãmp
 = 
	`cü_ªadl
(
bus_addr
);

427 
	`mb
();

428 
	`mcheck_ex≥˘ed
(0) = 0;

429 
	`mb
();

430 i‡(
	`mcheck_èkí
(0)) {

431 
	`¥ötk
("pci: failed sgÜoopback i/oÑeadÅest (mcheck)\n");

432 
Áûed
;

434 i‡(
ãmp
 !
d©a0
) {

435 
	`¥ötk
("pci: failed sgÜoopback i/oÑeadÅest "

436 "(%#x !%#x)\n", 
ãmp
, 
d©a0
);

437 
Áûed
;

439 
	`¥ötk
("pci:Öassed sgÜoopback i/oÑeadÅest\n");

443 i‡(! 
u£_tbü_åy2
) {

444 
	`cü_pci_tbi
(
¨ía
->
ho£
, 0, -1);

445 
ãmp
 = *(
vù
)
	`CIA_IOC_TB_TAGn
(0);

446 i‡(
ãmp
 & 1) {

447 
u£_tbü_åy2
 = 1;

448 
	`¥ötk
("pci: failedÅbiaÅest; workaroundávailable\n");

450 
	`¥ötk
("pci:ÖassedÅbiaÅest\n");

457 
d©a0
 = 0x5adda15e;

458 
∑ge
[0] = 
d©a0
;

459 
¨ía
->
±es
[4] = 
±e0
;

460 
	`mcheck_ex≥˘ed
(0) = 1;

461 
	`mcheck_èkí
(0) = 0;

462 
	`mb
();

463 
ãmp
 = 
	`cü_ªadl
(
bus_addr
 + 4*
PAGE_SIZE
);

464 
	`mb
();

465 
	`mcheck_ex≥˘ed
(0) = 0;

466 
	`mb
();

467 i‡(
	`mcheck_èkí
(0)) {

468 
	`¥ötk
("pci: failedÖte write cache snoopÅest (mcheck)\n");

469 
Áûed
;

471 i‡(
ãmp
 !
d©a0
) {

472 
	`¥ötk
("pci: failedÖte write cache snoopÅest "

473 "(%#x !%#x)\n", 
ãmp
, 
d©a0
);

474 
Áûed
;

476 
	`¥ötk
("pci:ÖassedÖte write cache snoopÅest\n");

481 
d©a0
 = 0xabcdef12;

482 
∑ge
[0] = 
d©a0
;

483 
¨ía
->
±es
[5] = 
±e0
;

484 
	`mcheck_ex≥˘ed
(0) = 1;

485 
	`mcheck_èkí
(0) = 0;

486 
	`mb
();

487 
ãmp
 = 
	`cü_ªadl
(
bus_addr
 + 5*
PAGE_SIZE
);

488 
	`mb
();

489 
	`mcheck_ex≥˘ed
(0) = 0;

490 
	`mb
();

491 i‡(
	`mcheck_èkí
(0)) {

492 
	`¥ötk
("pci: failed validÅag invalidÖteÑeloadÅest "

496 
¨ía
->
Æign_íåy
 = 4;

497 } i‡(
ãmp
 !
d©a0
) {

498 
	`¥ötk
("pci: failed validÅag invalidÖteÑeloadÅest "

499 "(%#x !%#x)\n", 
ãmp
, 
d©a0
);

500 
Áûed
;

502 
	`¥ötk
("pci:Öassed validÅag invalidÖteÑeloadÅest\n");

508 
	`mcheck_ex≥˘ed
(0) = 1;

509 
	`mcheck_èkí
(0) = 0;

510 
	`mb
();

511 
ãmp
 = 
	`cü_ªadl
(
bus_addr
 + 6*
PAGE_SIZE
);

512 
	`mb
();

513 
	`mcheck_ex≥˘ed
(0) = 0;

514 
	`mb
();

515 
	`¥ötk
("pci: %sÖci machine checkÅest\n",

516 
	`mcheck_èkí
(0) ? "passed" : "failed");

519 
¨ía
->
±es
[4] = 0;

520 
¨ía
->
±es
[5] = 0;

522 i‡(
u£_tbü_åy2
) {

523 
Æpha_mv
.
mv_pci_tbi
 = 
cü_pci_tbi_åy2
;

526 
	`wmb
();

527 *(
vù
)
	`CIA_IOC_TB_TAGn
(0) = 2;

528 *(
vù
)
	`CIA_IOC_TB_TAGn
(1) = 2;

529 *(
vù
)
	`CIA_IOC_TB_TAGn
(2) = 2;

530 *(
vù
)
	`CIA_IOC_TB_TAGn
(3) = 2;

532 
	`¥ötk
("pci:Åbia workaroundÉnabled\n");

534 
Æpha_mv
.
	`mv_pci_tbi
(
¨ía
->
ho£
, 0, -1);

536 
exô
:

538 
	`cü_iounm≠
(
bus_addr
);

541 
	`mb
();

542 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
˘æ
;

543 
	`mb
();

544 *(
vù
)
CIA_IOC_CIA_CTRL
;

545 
	`mb
();

548 
Áûed
:

549 
	`¥ötk
("pci: disabling sgÅranslation window\n");

550 *(
vù
)
CIA_IOC_PCI_W0_BASE
 = 0;

551 *(
vù
)
CIA_IOC_PCI_W1_BASE
 = 0;

552 
pci_iß_ho£
->
sg_iß
 = 
NULL
;

553 
Æpha_mv
.
mv_pci_tbi
 = 
NULL
;

554 
exô
;

555 
	}
}

557 #i‡
deföed
(
ALPHA_RESTORE_SRM_SETUP
)

561 
	mh´_mem
;

562 
	mh´_io
;

563 
	mpci_dac_off£t
;

564 
	mîr_mask
;

565 
	mcü_˘æ
;

566 
	mcü_˙fg
;

568 
	mw_ba£
;

569 
	mw_mask
;

570 
	mt_ba£
;

571 } 
	mwödow
[4];

572 } 
ßved_c⁄fig
 
__©åibuã
((
comm⁄
));

575 
	$cü_ßve_§m_£âögs
(
is_pyxis
)

577 
i
;

580 
ßved_c⁄fig
.
îr_mask
 = *(
vù
)
CIA_IOC_ERR_MASK
;

581 
ßved_c⁄fig
.
cü_˘æ
 = *(
vù
)
CIA_IOC_CIA_CTRL
;

582 
ßved_c⁄fig
.
h´_mem
 = *(
vù
)
CIA_IOC_HAE_MEM
;

583 
ßved_c⁄fig
.
h´_io
 = *(
vù
)
CIA_IOC_HAE_IO
;

584 
ßved_c⁄fig
.
pci_dac_off£t
 = *(
vù
)
CIA_IOC_PCI_W_DAC
;

586 i‡(
is_pyxis
)

587 
ßved_c⁄fig
.
cü_˙fg
 = *(
vù
)
CIA_IOC_CIA_CNFG
;

589 
ßved_c⁄fig
.
cü_˙fg
 = 0;

592 
i
 = 0; i < 4; i++) {

593 
ßved_c⁄fig
.
wödow
[
i
].
w_ba£
 = *(
vù
)
	`CIA_IOC_PCI_Wn_BASE
(i);

594 
ßved_c⁄fig
.
wödow
[
i
].
w_mask
 = *(
vù
)
	`CIA_IOC_PCI_Wn_MASK
(i);

595 
ßved_c⁄fig
.
wödow
[
i
].
t_ba£
 = *(
vù
)
	`CIA_IOC_PCI_Tn_BASE
(i);

597 
	`mb
();

598 
	}
}

601 
	$cü_ª°‹e_§m_£âögs
()

603 
i
;

605 
i
 = 0; i < 4; i++) {

606 *(
vù
)
	`CIA_IOC_PCI_Wn_BASE
(
i
Ë
ßved_c⁄fig
.
wödow
[i].
w_ba£
;

607 *(
vù
)
	`CIA_IOC_PCI_Wn_MASK
(
i
Ë
ßved_c⁄fig
.
wödow
[i].
w_mask
;

608 *(
vù
)
	`CIA_IOC_PCI_Tn_BASE
(
i
Ë
ßved_c⁄fig
.
wödow
[i].
t_ba£
;

611 *(
vù
)
CIA_IOC_HAE_MEM
 = 
ßved_c⁄fig
.
h´_mem
;

612 *(
vù
)
CIA_IOC_HAE_IO
 = 
ßved_c⁄fig
.
h´_io
;

613 *(
vù
)
CIA_IOC_PCI_W_DAC
 = 
ßved_c⁄fig
.
pci_dac_off£t
;

614 *(
vù
)
CIA_IOC_ERR_MASK
 = 
ßved_c⁄fig
.
îr_mask
;

615 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
ßved_c⁄fig
.
cü_˘æ
;

617 i‡(
ßved_c⁄fig
.
cü_˙fg
)

618 *(
vù
)
CIA_IOC_CIA_CNFG
 = 
ßved_c⁄fig
.
cü_˙fg
;

620 
	`mb
();

621 
	}
}

623 
	#cü_ßve_§m_£âögs
(
p
Ëdÿ{} 0)

	)

624 
	#cü_ª°‹e_§m_£âögs
(Ëdÿ{} 0)

	)

628 
__öô


629 
	$do_öô_¨ch
(
is_pyxis
)

631 
pci_c⁄åﬁÀr
 *
ho£
;

632 
ãmp
, 
cü_ªv
, 
tbü_wödow
;

634 
cü_ªv
 = *(
vù
)
CIA_IOC_CIA_REV
 & 
CIA_REV_MASK
;

635 
	`¥ötk
("pci: ciaÑevision %d%s\n",

636 
cü_ªv
, 
is_pyxis
 ? " (pyxis)" : "");

638 i‡(
Æpha_usög_§m
)

639 
	`cü_ßve_§m_£âögs
(
is_pyxis
);

642 
ãmp
 = *(
vù
)
CIA_IOC_ERR_MASK
;

643 
ãmp
 &~(
CIA_ERR_CPU_PE
 | 
CIA_ERR_MEM_NEM
 | 
CIA_ERR_PA_PTE_INV


644 | 
CIA_ERR_RCVD_MAS_ABT
 | 
CIA_ERR_RCVD_TAR_ABT
);

645 *(
vù
)
CIA_IOC_ERR_MASK
 = 
ãmp
;

648 
ãmp
 = *(
vù
)
CIA_IOC_CIA_ERR
;

649 *(
vù
)
CIA_IOC_CIA_ERR
 = 
ãmp
;

652 
ãmp
 = *(
vù
)
CIA_IOC_CIA_CTRL
;

653 
ãmp
 |
CIA_CTRL_FILL_ERR_EN
 | 
CIA_CTRL_MCHK_ERR_EN
;

654 *(
vù
)
CIA_IOC_CIA_CTRL
 = 
ãmp
;

659 *(
vù
)
CIA_IOC_CFG
 = 0;

662 *(
vù
)
CIA_IOC_HAE_MEM
 = 0;

663 *(
vù
)
CIA_IOC_HAE_IO
 = 0;

668 i‡(
is_pyxis
) {

669 
ãmp
 = *(
vù
)
CIA_IOC_CIA_CNFG
;

670 
ãmp
 |
CIA_CNFG_IOA_BWEN
 | 
CIA_CNFG_PCI_MWEN
;

671 *(
vù
)
CIA_IOC_CIA_CNFG
 = 
ãmp
;

675 
	`mb
();

676 *(
vù
)
CIA_IOC_CIA_REV
;

682 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

683 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

684 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

685 
ho£
->
ödex
 = 0;

687 i‡(! 
is_pyxis
) {

688 
ªsour˚
 *
h´_mem
 = 
	`Æloc_ªsour˚
();

689 
ho£
->
mem_•a˚
 = 
h´_mem
;

691 
h´_mem
->
°¨t
 = 0;

692 
h´_mem
->
íd
 = 
CIA_MEM_R1_MASK
;

693 
h´_mem
->
«me
 = 
pci_h´0_«me
;

694 
h´_mem
->
Êags
 = 
IORESOURCE_MEM
;

696 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
h´_mem
) < 0)

697 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest HAE_MEM\n");

699 
ho£
->
•¨£_mem_ba£
 = 
CIA_SPARSE_MEM
 - 
IDENT_ADDR
;

700 
ho£
->
dí£_mem_ba£
 = 
CIA_DENSE_MEM
 - 
IDENT_ADDR
;

701 
ho£
->
•¨£_io_ba£
 = 
CIA_IO
 - 
IDENT_ADDR
;

702 
ho£
->
dí£_io_ba£
 = 0;

704 
ho£
->
•¨£_mem_ba£
 = 0;

705 
ho£
->
dí£_mem_ba£
 = 
CIA_BW_MEM
 - 
IDENT_ADDR
;

706 
ho£
->
•¨£_io_ba£
 = 0;

707 
ho£
->
dí£_io_ba£
 = 
CIA_BW_IO
 - 
IDENT_ADDR
;

724 
ho£
->
sg_pci
 = 
NULL
;

725 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 32768);

727 
__dúe˘_m≠_ba£
 = 0x80000000;

728 
__dúe˘_m≠_size
 = 0x80000000;

730 *(
vù
)
CIA_IOC_PCI_W0_BASE
 = 
ho£
->
sg_iß
->
dma_ba£
 | 3;

731 *(
vù
)
CIA_IOC_PCI_W0_MASK
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

732 *(
vù
)
CIA_IOC_PCI_T0_BASE
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
) >> 2;

734 *(
vù
)
CIA_IOC_PCI_W2_BASE
 = 
__dúe˘_m≠_ba£
 | 1;

735 *(
vù
)
CIA_IOC_PCI_W2_MASK
 = (
__dúe˘_m≠_size
 - 1) & 0xfff00000;

736 *(
vù
)
CIA_IOC_PCI_T2_BASE
 = 0 >> 2;

752 
tbü_wödow
 = 1;

753 i‡(
is_pyxis
) {

754 *(
vù
)
CIA_IOC_PCI_W3_BASE
 = 0;

755 } i‡(
cü_ªv
 == 1) {

756 *(
vù
)
CIA_IOC_PCI_W1_BASE
 = 0;

757 
tbü_wödow
 = 3;

758 } i‡(
max_low_p‚
 > (0x100000000UL >> 
PAGE_SHIFT
)) {

759 *(
vù
)
CIA_IOC_PCI_W3_BASE
 = 0;

761 *(
vù
)
CIA_IOC_PCI_W3_BASE
 = 0x00000000 | 1 | 8;

762 *(
vù
)
CIA_IOC_PCI_W3_MASK
 = 0xfff00000;

763 *(
vù
)
CIA_IOC_PCI_T3_BASE
 = 0 >> 2;

765 
Æpha_mv
.
pci_dac_off£t
 = 0x200000000UL;

766 *(
vù
)
CIA_IOC_PCI_W_DAC
 = 
Æpha_mv
.
pci_dac_off£t
 >> 32;

770 
	`cü_¥ï¨e_tbü_w‹k¨ound
(
tbü_wödow
);

771 
	}
}

773 
__öô


774 
	$cü_öô_¨ch
()

776 
	`do_öô_¨ch
(0);

777 
	}
}

779 
__öô


780 
	$pyxis_öô_¨ch
()

790 
cc0
, 
cc1
;

791 
pyxis_cc
;

793 
__asm__
 
	`__vﬁ©ûe__
 ("Ωc¯%0" : "Ù"(
cc0
));

794 
pyxis_cc
 = *(
vuÕ
)
PYXIS_RT_COUNT
;

795 dÿ{ } *(
vuÕ
)
PYXIS_RT_COUNT
 - 
pyxis_cc
 < 4096);

796 
__asm__
 
	`__vﬁ©ûe__
 ("Ωc¯%0" : "Ù"(
cc1
));

797 
cc1
 -
cc0
;

798 
hwΩb
->
cy˛e_‰eq
 = ((
cc1
 >> 11) * 100000000UL) / 3;

799 
	`hwΩb_upd©e_checksum
(
hwΩb
);

801 
	`do_öô_¨ch
(1);

802 
	}
}

805 
	$cü_kûl_¨ch
(
mode
)

807 i‡(
Æpha_usög_§m
)

808 
	`cü_ª°‹e_§m_£âögs
();

809 
	}
}

811 
__öô


812 
	$cü_öô_pci
()

815 
	`vîify_tb_›î©i⁄
();

816 
	`comm⁄_öô_pci
();

817 
	}
}

819 
ölöe
 

820 
	$cü_pci_˛r_îr
()

822 
jd
;

824 
jd
 = *(
vù
)
CIA_IOC_CIA_ERR
;

825 *(
vù
)
CIA_IOC_CIA_ERR
 = 
jd
;

826 
	`mb
();

827 *(
vù
)
CIA_IOC_CIA_ERR
;

828 
	}
}

830 #ifde‡
CONFIG_VERBOSE_MCHECK


832 
	$cü_decode_pci_îr‹
(
ñ_CIA_sysd©a_mcheck
 *
cü
, c⁄° *
msg
)

834 c⁄° * c⁄° 
pci_cmd_desc
[16] = {

843 i‡(
cü
->
cü_îr
 & (
CIA_ERR_COR_ERR


844 | 
CIA_ERR_UN_COR_ERR


845 | 
CIA_ERR_MEM_NEM


846 | 
CIA_ERR_PA_PTE_INV
)) {

847 c⁄° * c⁄° 
wödow_desc
[6] = {

852 c⁄° *
wödow
;

853 c⁄° *
cmd
;

854 
addr
, 
tmp
;

855 
lock
, 
dac
;

857 
cmd
 = 
pci_cmd_desc
[
cü
->
pci_îr0
 & 0x7];

858 
lock
 = (
cü
->
pci_îr0
 >> 4) & 1;

859 
dac
 = (
cü
->
pci_îr0
 >> 5) & 1;

861 
tmp
 = (
cü
->
pci_îr0
 >> 8) & 0x1F;

862 
tmp
 = 
	`ffs
(tmp);

863 
wödow
 = 
wödow_desc
[
tmp
];

865 
addr
 = 
cü
->
pci_îr1
;

866 i‡(
dac
) {

867 
tmp
 = *(
vù
)
CIA_IOC_PCI_W_DAC
 & 0xFFUL;

868 
addr
 |
tmp
 << 32;

871 
	`¥ötk
(
KERN_CRIT
 "CIA machöêcheck: %s\n", 
msg
);

872 
	`¥ötk
(
KERN_CRIT
 " DMA comm™d: %s\n", 
cmd
);

873 
	`¥ötk
(
KERN_CRIT
 " PCIáddªss: %#010lx\n", 
addr
);

874 
	`¥ötk
(
KERN_CRIT
 " %s, Lock: %d, DAC: %d\n",

875 
wödow
, 
lock
, 
dac
);

876 } i‡(
cü
->
cü_îr
 & (
CIA_ERR_PERR


877 | 
CIA_ERR_PCI_ADDR_PE


878 | 
CIA_ERR_RCVD_MAS_ABT


879 | 
CIA_ERR_RCVD_TAR_ABT


880 | 
CIA_ERR_IOA_TIMEOUT
)) {

881 c⁄° * c⁄° 
ma°î_°_desc
[16] = {

890 c⁄° * c⁄° 
èrgë_°_desc
[16] = {

899 c⁄° *
cmd
;

900 c⁄° *
ma°î
, *
èrgë
;

901 
addr
, 
tmp
;

902 
dac
;

904 
ma°î
 = 
ma°î_°_desc
[(
cü
->
pci_îr0
 >> 16) & 0xF];

905 
èrgë
 = 
èrgë_°_desc
[(
cü
->
pci_îr0
 >> 20) & 0xF];

906 
cmd
 = 
pci_cmd_desc
[(
cü
->
pci_îr0
 >> 24) & 0xF];

907 
dac
 = (
cü
->
pci_îr0
 >> 28) & 1;

909 
addr
 = 
cü
->
pci_îr2
;

910 i‡(
dac
) {

911 
tmp
 = *(vﬁ©ûê*)
CIA_IOC_PCI_W_DAC
 & 0xFFUL;

912 
addr
 |
tmp
 << 32;

915 
	`¥ötk
(
KERN_CRIT
 "CIA machöêcheck: %s\n", 
msg
);

916 
	`¥ötk
(
KERN_CRIT
 " PCI comm™d: %s\n", 
cmd
);

917 
	`¥ötk
(
KERN_CRIT
 " Master state: %s, Target state: %s\n",

918 
ma°î
, 
èrgë
);

919 
	`¥ötk
(
KERN_CRIT
 " PCIáddress: %#010lx, DAC: %d\n",

920 
addr
, 
dac
);

922 
	`¥ötk
(
KERN_CRIT
 "CIA machöêcheck: %s\n", 
msg
);

923 
	`¥ötk
(
KERN_CRIT
 " Unknown PCIÉrror\n");

924 
	`¥ötk
(
KERN_CRIT
 " PCI_ERR0 = %#08lx", 
cü
->
pci_îr0
);

925 
	`¥ötk
(
KERN_CRIT
 " PCI_ERR1 = %#08lx", 
cü
->
pci_îr1
);

926 
	`¥ötk
(
KERN_CRIT
 " PCI_ERR2 = %#08lx", 
cü
->
pci_îr2
);

928 
	}
}

931 
	$cü_decode_mem_îr‹
(
ñ_CIA_sysd©a_mcheck
 *
cü
, c⁄° *
msg
)

933 
mem_p‹t_addr
;

934 
mem_p‹t_mask
;

935 c⁄° *
mem_p‹t_cmd
;

936 c⁄° *
£q_°©e
;

937 c⁄° *
£t_£À˘
;

938 
tmp
;

941 i‡((
cü
->
mem_îr1
 >> 20) & 1)

942 
	`cü_decode_pci_îr‹
(
cü
, 
msg
);

944 
	`¥ötk
(
KERN_CRIT
 "CIA machöêcheck: %s\n", 
msg
);

946 
mem_p‹t_addr
 = 
cü
->
mem_îr0
 & 0xfffffff0;

947 
mem_p‹t_addr
 |(
cü
->
mem_îr1
 & 0x83UL) << 32;

949 
mem_p‹t_mask
 = (
cü
->
mem_îr1
 >> 12) & 0xF;

951 
tmp
 = (
cü
->
mem_îr1
 >> 8) & 0xF;

952 
tmp
 |((
cü
->
mem_îr1
 >> 20) & 1) << 4;

953 i‡((
tmp
 & 0x1E) == 0x06)

954 
mem_p‹t_cmd
 = "WRITE BLOCK or WRITE BLOCK LOCK";

955 i‡((
tmp
 & 0x1C) == 0x08)

956 
mem_p‹t_cmd
 = "READ MISS or READ MISS MODIFY";

957 i‡(
tmp
 == 0x1C)

958 
mem_p‹t_cmd
 = "BC VICTIM";

959 i‡((
tmp
 & 0x1E) == 0x0E)

960 
mem_p‹t_cmd
 = "READ MISS MODIFY";

961 i‡((
tmp
 & 0x1C) == 0x18)

962 
mem_p‹t_cmd
 = "DMA READ or DMA READ MODIFY";

963 i‡((
tmp
 & 0x1E) == 0x12)

964 
mem_p‹t_cmd
 = "DMA WRITE";

966 
mem_p‹t_cmd
 = "Unknown";

968 
tmp
 = (
cü
->
mem_îr1
 >> 16) & 0xF;

969 
tmp
) {

971 
£q_°©e
 = "Idle";

974 
£q_°©e
 = "DMA READ or DMA WRITE";

977 
£q_°©e
 = "READ MISS (or READ MISS MODIFY) with victim";

980 
£q_°©e
 = "READ MISS (or READ MISS MODIFY) withÇo victim";

983 
£q_°©e
 = "Refresh";

986 
£q_°©e
 = "Idle, waiting for DMAÖendingÑead";

989 
£q_°©e
 = "Idle,ÑasÖrecharge";

992 
£q_°©e
 = "Unknown";

996 
tmp
 = (
cü
->
mem_îr1
 >> 24) & 0x1F;

997 
tmp
) {

998 0x00: 
£t_£À˘
 = "Set 0 selected"; ;

999 0x01: 
£t_£À˘
 = "Set 1 selected"; ;

1000 0x02: 
£t_£À˘
 = "Set 2 selected"; ;

1001 0x03: 
£t_£À˘
 = "Set 3 selected"; ;

1002 0x04: 
£t_£À˘
 = "Set 4 selected"; ;

1003 0x05: 
£t_£À˘
 = "Set 5 selected"; ;

1004 0x06: 
£t_£À˘
 = "Set 6 selected"; ;

1005 0x07: 
£t_£À˘
 = "Set 7 selected"; ;

1006 0x08: 
£t_£À˘
 = "Set 8 selected"; ;

1007 0x09: 
£t_£À˘
 = "Set 9 selected"; ;

1008 0x0A: 
£t_£À˘
 = "Set A selected"; ;

1009 0x0B: 
£t_£À˘
 = "Set B selected"; ;

1010 0x0C: 
£t_£À˘
 = "Set C selected"; ;

1011 0x0D: 
£t_£À˘
 = "Set D selected"; ;

1012 0x0E: 
£t_£À˘
 = "Set E selected"; ;

1013 0x0F: 
£t_£À˘
 = "Set F selected"; ;

1014 0x10: 
£t_£À˘
 = "No set selected"; ;

1015 0x1F: 
£t_£À˘
 = "Refresh cycle"; ;

1016 : 
£t_£À˘
 = "Unknown"; ;

1019 
	`¥ötk
(
KERN_CRIT
 " Mem‹yÖ‹àcomm™d: %s\n", 
mem_p‹t_cmd
);

1020 
	`¥ötk
(
KERN_CRIT
 " MemoryÖortáddress: %#010lx, mask: %#lx\n",

1021 
mem_p‹t_addr
, 
mem_p‹t_mask
);

1022 
	`¥ötk
(
KERN_CRIT
 " Mem‹y sequí˚∏°©e: %s\n", 
£q_°©e
);

1023 
	`¥ötk
(
KERN_CRIT
 " Mem‹y së: %s\n", 
£t_£À˘
);

1024 
	}
}

1027 
	$cü_decode_ecc_îr‹
(
ñ_CIA_sysd©a_mcheck
 *
cü
, c⁄° *
msg
)

1029 
syn
;

1030 
i
;

1031 c⁄° *
fmt
;

1033 
	`cü_decode_mem_îr‹
(
cü
, 
msg
);

1035 
syn
 = 
cü
->
cü_syn
 & 0xff;

1036 i‡(
syn
 == (syn & -syn)) {

1037 
fmt
 = 
KERN_CRIT
 " ECC syndrome %#x -- check bit %d\n";

1038 
i
 = 
	`ffs
(
syn
) - 1;

1040 c⁄° 
d©a_bô
[64] = {

1059 
i
 = 0; i < 64; ++i)

1060 i‡(
d©a_bô
[
i
] =
syn
)

1063 i‡(
i
 < 64)

1064 
fmt
 = 
KERN_CRIT
 " ECC syndrome %#x -- data bit %d\n";

1066 
fmt
 = 
KERN_CRIT
 " ECC syndrome %#x -- unknown bit\n";

1069 
	`¥ötk
 (
fmt
, 
syn
, 
i
);

1070 
	}
}

1073 
	$cü_decode_∑rôy_îr‹
(
ñ_CIA_sysd©a_mcheck
 *
cü
)

1075 c⁄° * c⁄° 
cmd_desc
[16] = {

1083 
addr
;

1084 
mask
;

1085 c⁄° *
cmd
;

1086 
∑r
;

1088 
addr
 = 
cü
->
˝u_îr0
 & 0xfffffff0;

1089 
addr
 |(
cü
->
˝u_îr1
 & 0x83UL) << 32;

1090 
cmd
 = 
cmd_desc
[(
cü
->
˝u_îr1
 >> 8) & 0xF];

1091 
mask
 = (
cü
->
˝u_îr1
 >> 12) & 0xF;

1092 
∑r
 = (
cü
->
˝u_îr1
 >> 21) & 1;

1094 
	`¥ötk
(
KERN_CRIT
 "CIA machine check: System busÖarityÉrror\n");

1095 
	`¥ötk
(
KERN_CRIT
 " Comm™d: %s, P¨ôy bô: %d\n", 
cmd
, 
∑r
);

1096 
	`¥ötk
(
KERN_CRIT
 " Addªss: %#010lx, Mask: %#lx\n", 
addr
, 
mask
);

1097 
	}
}

1102 
	$cü_decode_mchk
(
œ_±r
)

1104 
ñ_comm⁄
 *
com
;

1105 
ñ_CIA_sysd©a_mcheck
 *
cü
;

1107 
com
 = (*)
œ_±r
;

1108 
cü
 = (*)(
œ_±r
 + 
com
->
sys_off£t
);

1110 i‡((
cü
->
cü_îr
 & 
CIA_ERR_VALID
) == 0)

1113 #ifde‡
CONFIG_VERBOSE_MCHECK


1114 i‡(!
Æpha_vîbo£_mcheck
)

1117 
	`ffs
(
cü
->
cü_îr
 & 0xfff) - 1) {

1119 
	`cü_decode_ecc_îr‹
(
cü
, "Corrected ECCÉrror");

1122 
	`cü_decode_ecc_îr‹
(
cü
, "Uncorrected ECCÉrror");

1125 
	`cü_decode_∑rôy_îr‹
(
cü
);

1128 
	`cü_decode_mem_îr‹
(
cü
, "AccessÅoÇonexistent memory");

1131 
	`cü_decode_pci_îr‹
(
cü
, "PCI bus systemÉrror");

1134 
	`cü_decode_pci_îr‹
(
cü
, "PCI dataÖarityÉrror");

1137 
	`cü_decode_pci_îr‹
(
cü
, "PCIáddressÖarityÉrror");

1140 
	`cü_decode_pci_îr‹
(
cü
, "PCI masterábort");

1143 
	`cü_decode_pci_îr‹
(
cü
, "PCIÅargetábort");

1146 
	`cü_decode_pci_îr‹
(
cü
, "PCI invalid PTE");

1149 
	`cü_decode_mem_îr‹
(
cü
, "WriteÅo flash ROMáttempted");

1152 
	`cü_decode_pci_îr‹
(
cü
, "I/OÅimeout");

1156 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_CORR_ERR
)

1157 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1159 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_UN_CORR_ERR
)

1160 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1162 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_CPU_PE
)

1163 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1165 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_MEM_NEM
)

1166 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1168 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_PERR
)

1169 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1171 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_PCI_ADDR_PE
)

1172 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1174 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_RCVD_MAS_ABT
)

1175 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1177 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_RCVD_TAR_ABT
)

1178 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1180 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_PA_PTE_INV
)

1181 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1183 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_FROM_WRT_ERR
)

1184 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1186 i‡(
cü
->
cü_îr
 & 
CIA_ERR_LOST_IOA_TIMEOUT
)

1187 
	`¥ötk
(
KERN_CRIT
 "CIAÜost machine check: "

1192 
	}
}

1195 
	$cü_machöe_check
(
ve˘‹
, 
œ_±r
)

1197 
ex≥˘ed
;

1200 
	`mb
();

1201 
	`mb
();

1202 
	`døöa
();

1203 
	`cü_pci_˛r_îr
();

1204 
	`wrm˚s
(
	`rdm˚s
());

1205 
	`mb
();

1207 
ex≥˘ed
 = 
	`mcheck_ex≥˘ed
(0);

1208 i‡(!
ex≥˘ed
 && 
ve˘‹
 == 0x660)

1209 
ex≥˘ed
 = 
	`cü_decode_mchk
(
œ_±r
);

1210 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "CIA", 
ex≥˘ed
);

1211 
	}
}

	@arch/alpha/kernel/core_irongate.c

12 
	#__EXTERN_INLINE
 
ölöe


	)

13 
	~<asm/io.h
>

14 
	~<asm/c‹e_ú⁄g©e.h
>

15 #unde‡
__EXTERN_INLINE


17 
	~<löux/ty≥s.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öôrd.h
>

22 
	~<löux/boŸmem.h
>

24 
	~<asm/±ø˚.h
>

25 
	~<asm/pci.h
>

26 
	~<asm/ˇcheÊush.h
>

27 
	~<asm/ébÊush.h
>

29 
	~"¥Ÿo.h
"

30 
	~"pci_im∂.h
"

36 
	#DEBUG_CONFIG
 0

	)

38 #i‡
DEBUG_CONFIG


39 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

41 
	#DBG_CFG
(
¨gs
)

	)

44 
igc§32
 *
	gIr⁄ECC
;

82 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

83 *
pci_addr
, *
ty≥1
)

85 
addr
;

86 
u8
 
bus
 = 
pbus
->
numbî
;

88 
	`DBG_CFG
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, "

90 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

92 *
ty≥1
 = (
bus
 != 0);

94 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

95 
addr
 |
IRONGATE_CONF
;

97 *
pci_addr
 = 
addr
;

98 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

100 
	}
}

103 
	$ú⁄g©e_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

104 
size
, 
u32
 *
vÆue
)

106 
addr
;

107 
ty≥1
;

109 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

110  
PCIBIOS_DEVICE_NOT_FOUND
;

112 
size
) {

114 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

117 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

120 *
vÆue
 = *(
vuù
)
addr
;

124  
PCIBIOS_SUCCESSFUL
;

125 
	}
}

128 
	$ú⁄g©e_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

129 
size
, 
u32
 
vÆue
)

131 
addr
;

132 
ty≥1
;

134 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

135  
PCIBIOS_DEVICE_NOT_FOUND
;

137 
size
) {

139 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

140 
	`mb
();

141 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

144 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

145 
	`mb
();

146 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

149 *(
vuù
)
addr
 = 
vÆue
;

150 
	`mb
();

151 *(
vuù
)
addr
;

155  
PCIBIOS_SUCCESSFUL
;

156 
	}
}

158 
pci_›s
 
	gú⁄g©e_pci_›s
 =

160 .
ªad
 = 
ú⁄g©e_ªad_c⁄fig
,

161 .
	gwrôe
 = 
ú⁄g©e_wrôe_c⁄fig
,

165 
	$ú⁄g©e_pci_˛r_îr
()

167 
nmi_˘l
=0;

168 
IRONGATE_jd
;

170 
agaö
:

171 
IRONGATE_jd
 = 
IRONGATE0
->
°©_cmd
;

172 
	`¥ötk
("Ir⁄ sèt_cmd %x\n", 
IRONGATE_jd
);

173 
IRONGATE0
->
°©_cmd
 = 
IRONGATE_jd
;

174 
	`mb
();

175 
IRONGATE_jd
 = 
IRONGATE0
->
°©_cmd
;

177 
IRONGATE_jd
 = *
Ir⁄ECC
;

178 
	`¥ötk
("Ir⁄ ECC %x\n", 
IRONGATE_jd
);

179 *
Ir⁄ECC
 = 
IRONGATE_jd
;

180 
	`mb
();

181 
IRONGATE_jd
 = *
Ir⁄ECC
;

184 
nmi_˘l
 = 
	`öb
(0x61);

185 
nmi_˘l
 |= 0x0c;

186 
	`outb
(
nmi_˘l
, 0x61);

187 
nmi_˘l
 &= ~0x0c;

188 
	`outb
(
nmi_˘l
, 0x61);

190 
IRONGATE_jd
 = *
Ir⁄ECC
;

191 i‡(
IRONGATE_jd
 & 0x300Ë
agaö
;

194 
	}
}

196 
	#IRONGATE_3GB
 0xc0000000UL

	)

201 
__öô


202 
	$Æbac‹e_öô_¨ch
()

204 
memt›
 = 
max_low_p‚
 << 
PAGE_SHIFT
;

205 
pci_mem
 = (
memt›
 + 0x1000000UL) & ~0xffffffUL;

206 
≥r˝u_°ru˘
 *
˝u
;

207 
∑l_ªv
, 
∑l_v¨
;

209 
˝u
 = (
≥r˝u_°ru˘
*)((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

210 
∑l_ªv
 = 
˝u
->
∑l_ªvisi⁄
 & 0xffff;

211 
∑l_v¨
 = (
˝u
->
∑l_ªvisi⁄
 >> 16) & 0xff;

217 i‡(
Æpha_usög_§m
 &&

218 (
∑l_ªv
 < 0x13ê|| (∑l_ªv =0x13ê&& 
∑l_v¨
 < 2)))

219 
	`¥ötk
(
KERN_WARNING
 "WARNING! UpgradeÅo SRM A5.6-19 "

222 i‡(
pci_mem
 > 
IRONGATE_3GB
)

223 
pci_mem
 = 
IRONGATE_3GB
;

224 
IRONGATE0
->
pci_mem
 =Öci_mem;

225 
Æpha_mv
.
mö_mem_addªss
 = 
pci_mem
;

226 i‡(
memt›
 > 
pci_mem
) {

227 #ifde‡
CONFIG_BLK_DEV_INITRD


228 
öôrd_°¨t
, 
öôrd_íd
;

229 *
	`move_öôrd
();

232 i‡(
öôrd_íd
 && 
	`__∑
(öôrd_ídË> 
pci_mem
) {

233 
size
;

235 
size
 = 
öôrd_íd
 - 
öôrd_°¨t
;

236 
	`‰ì_boŸmem_node
(
	`NODE_DATA
(0), 
	`__∑
(
öôrd_°¨t
),

237 
	`PAGE_ALIGN
(
size
));

238 i‡(!
	`move_öôrd
(
pci_mem
))

239 
	`¥ötk
("irongate_init_arch: initrdÅoo big "

241 
size
 / 1024);

244 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(0), 
pci_mem
, 
memt›
 -Öci_mem);

245 
	`¥ötk
("irongate_init_arch:ÅemporarilyÑeserving "

246 "ªgi⁄ %08lx-%08lx f‹ PCI\n", 
pci_mem
, 
memt›
 - 1);

248 
	}
}

250 
__öô


251 
	$ú⁄g©e_£tup_agp
()

255 
IRONGATE0
->
agpva
 = IRONGATE0->agpva & ~0xf;

256 
Æpha_agpg¨t_size
 = 0;

257 
	}
}

259 
__öô


260 
	$ú⁄g©e_öô_¨ch
()

262 
pci_c⁄åﬁÀr
 *
ho£
;

263 
amd761
 = (
IRONGATE0
->
dev_víd‹
 >> 16) > 0x7006;

265 
Ir⁄ECC
 = 
amd761
 ? &
IRONGATE0
->
bac§54_eccms761
 : &IRONGATE0->
dømms
;

267 
	`ú⁄g©e_pci_˛r_îr
();

269 i‡(
amd761
)

270 
	`Æbac‹e_öô_¨ch
();

272 
	`ú⁄g©e_£tup_agp
();

278 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

279 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

280 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

281 
ho£
->
ödex
 = 0;

287 
ho£
->
•¨£_mem_ba£
 = 0;

288 
ho£
->
•¨£_io_ba£
 = 0;

289 
ho£
->
dí£_mem_ba£


290 (
IRONGATE_MEM
 & 0xffffffffffUL) | 0x80000000000UL;

291 
ho£
->
dí£_io_ba£


292 (
IRONGATE_IO
 & 0xffffffffffUL) | 0x80000000000UL;

294 
ho£
->
sg_iß
 = ho£->
sg_pci
 = 
NULL
;

295 
__dúe˘_m≠_ba£
 = 0;

296 
__dúe˘_m≠_size
 = 0xffffffff;

297 
	}
}

302 
	~<löux/vmÆloc.h
>

303 
	~<löux/agp_backíd.h
>

304 
	~<löux/agpg¨t.h
>

305 
	~<asm/pgÆloc.h
>

307 
	#GET_PAGE_DIR_OFF
(
addr
Ë◊dd∏>> 22)

	)

308 
	#GET_PAGE_DIR_IDX
(
addr
Ë(
	`GET_PAGE_DIR_OFF
◊ddr))

	)

310 
	#GET_GATT_OFF
(
addr
Ë(◊dd∏& 0x003ff000Ë>> 12)

	)

311 
	#GET_GATT
(
addr
Ë(
g©t_∑ges
[
	`GET_PAGE_DIR_IDX
◊ddr)])

	)

313 
__iomem
 *

314 
	$ú⁄g©e_i‹em≠
(
addr
, 
size
)

316 
vm_°ru˘
 *
¨ó
;

317 
vaddr
;

318 
baddr
, 
œ°
;

319 
u32
 *
mmio_ªgs
, *
g©t_∑ges
, *
cur_g©t
, 
±e
;

320 
g¨t_bus_addr
;

322 i‡(!
Æpha_agpg¨t_size
)

323  (
__iomem
 *)(
addr
 + 
IRONGATE_MEM
);

325 
g¨t_bus_addr
 = ()
IRONGATE0
->
b¨0
 &

326 
PCI_BASE_ADDRESS_MEM_MASK
;

335 i‡(
addr
 >
g¨t_bus_addr
 &&ádd∏+ 
size
 - 1 <

336 
g¨t_bus_addr
 + 
Æpha_agpg¨t_size
)

342  (
__iomem
 *)(
addr
 + 
IRONGATE_MEM
);

345 
mmio_ªgs
 = (
u32
 *)((()
IRONGATE0
->
b¨1
 &

346 
PCI_BASE_ADDRESS_MEM_MASK
Ë+ 
IRONGATE_MEM
);

348 
g©t_∑ges
 = (
u32
 *)(
	`phys_to_vút
(
mmio_ªgs
[1]));

353 i‡(
addr
 & ~
PAGE_MASK
) {

354 
	`¥ötk
("AGP ioremap failed...áddrÇotÖageáligned (0x%lx)\n",

355 
addr
);

356  (
__iomem
 *)(
addr
 + 
IRONGATE_MEM
);

358 
œ°
 = 
addr
 + 
size
 - 1;

359 
size
 = 
	`PAGE_ALIGN
(
œ°
Ë- 
addr
;

362 
	`¥ötk
("ú⁄g©e_i‹em≠(0x%lx, 0x%lx)\n", 
addr
, 
size
);

363 
	`¥ötk
("ú⁄g©e_i‹em≠: g¨t_bus_add∏ 0x%lx\n", 
g¨t_bus_addr
);

364 
	`¥ötk
("ú⁄g©e_i‹em≠: g¨t_≠î_sizê0x%lx\n", 
g¨t_≠î_size
);

365 
	`¥ötk
("ú⁄g©e_i‹em≠: mmio_ªg† %p\n", 
mmio_ªgs
);

366 
	`¥ötk
("ú⁄g©e_i‹em≠: g©t_∑ge† %p\n", 
g©t_∑ges
);

368 
baddr
 = 
addr
; badd∏<
œ°
; badd∏+
PAGE_SIZE
)

370 
cur_g©t
 = 
	`phys_to_vút
(
	`GET_GATT
(
baddr
) & ~1);

371 
±e
 = 
cur_g©t
[
	`GET_GATT_OFF
(
baddr
)] & ~1;

372 
	`¥ötk
("irongate_ioremap: cur_gatt %pÖte 0x%x\n",

373 
cur_g©t
, 
±e
);

380 
¨ó
 = 
	`gë_vm_¨ó
(
size
, 
VM_IOREMAP
);

381 i‡(!
¨ó
Ë 
NULL
;

383 
baddr
 = 
addr
, 
vaddr
 = ()
¨ó
->addr;

384 
baddr
 <
œ°
;

385 
baddr
 +
PAGE_SIZE
, 
vaddr
 += PAGE_SIZE)

387 
cur_g©t
 = 
	`phys_to_vút
(
	`GET_GATT
(
baddr
) & ~1);

388 
±e
 = 
cur_g©t
[
	`GET_GATT_OFF
(
baddr
)] & ~1;

390 i‡(
	`__Æpha_ªm≠_¨ó_∑ges
(
vaddr
,

391 
±e
, 
PAGE_SIZE
, 0)) {

392 
	`¥ötk
("AGP ioremap: FAILEDÅo map...\n");

393 
	`v‰ì
(
¨ó
->
addr
);

394  
NULL
;

398 
	`Êush_éb_Æl
();

400 
vaddr
 = ()
¨ó
->
addr
 + (add∏& ~
PAGE_MASK
);

402 
	`¥ötk
("irongate_ioremap(0x%lx, 0x%lx)Ñeturning 0x%lx\n",

403 
addr
, 
size
, 
vaddr
);

405  (
__iomem
 *)
vaddr
;

406 
	}
}

407 
EXPORT_SYMBOL
(
ú⁄g©e_i‹em≠
);

410 
	$ú⁄g©e_iounm≠
(vﬁ©ûê
__iomem
 *
xaddr
)

412 
addr
 = (Ë
xaddr
;

413 i‡((()
addr
 >> 41) == -2)

415 i‡(
addr
)

416  
	`v‰ì
((*)(
PAGE_MASK
 & 
addr
));

417 
	}
}

418 
EXPORT_SYMBOL
(
ú⁄g©e_iounm≠
);

	@arch/alpha/kernel/core_lca.c

11 
	#__EXTERN_INLINE
 
ölöe


	)

12 
	~<asm/io.h
>

13 
	~<asm/c‹e_lˇ.h
>

14 #unde‡
__EXTERN_INLINE


16 
	~<löux/ty≥s.h
>

17 
	~<löux/pci.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/ây.h
>

21 
	~<asm/±ø˚.h
>

22 
	~<asm/úq_ªgs.h
>

23 
	~<asm/smp.h
>

25 
	~"¥Ÿo.h
"

26 
	~"pci_im∂.h
"

37 
	#MCHK_K_TPERR
 0x0080

	)

38 
	#MCHK_K_TCPERR
 0x0082

	)

39 
	#MCHK_K_HERR
 0x0084

	)

40 
	#MCHK_K_ECC_C
 0x0086

	)

41 
	#MCHK_K_ECC_NC
 0x0088

	)

42 
	#MCHK_K_UNKNOWN
 0x008A

	)

43 
	#MCHK_K_CACKSOFT
 0x008C

	)

44 
	#MCHK_K_BUGCHECK
 0x008E

	)

45 
	#MCHK_K_OS_BUGCHECK
 0x0090

	)

46 
	#MCHK_K_DCPERR
 0x0092

	)

47 
	#MCHK_K_ICPERR
 0x0094

	)

53 
	#MCHK_K_SIO_SERR
 0x204

	)

54 
	#MCHK_K_SIO_IOCHK
 0x206

	)

55 
	#MCHK_K_DCSR
 0x208

	)

101 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

102 *
pci_addr
)

104 
addr
;

105 
u8
 
bus
 = 
pbus
->
numbî
;

107 i‡(
bus
 == 0) {

108 
devi˚
 = 
devi˚_‚
 >> 3;

109 
func
 = 
devi˚_‚
 & 0x7;

113 i‡(
devi˚
 > 12) {

117 *(
vuÕ
)
LCA_IOC_CONF
 = 0;

118 
addr
 = (1 << (11 + 
devi˚
)Ë| (
func
 << 8Ë| 
whîe
;

121 *(
vuÕ
)
LCA_IOC_CONF
 = 1;

122 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

124 *
pci_addr
 = 
addr
;

126 
	}
}

129 
	$c⁄f_ªad
(
addr
)

131 
Êags
, 
code
, 
°©0
;

132 
vÆue
;

134 
	`loˇl_úq_ßve
(
Êags
);

137 
°©0
 = *(
vuÕ
)
LCA_IOC_STAT0
;

138 *(
vuÕ
)
LCA_IOC_STAT0
 = 
°©0
;

139 
	`mb
();

142 
vÆue
 = *(
vuù
)
addr
;

143 
	`døöa
();

145 
°©0
 = *(
vuÕ
)
LCA_IOC_STAT0
;

146 i‡(
°©0
 & 
LCA_IOC_STAT0_ERR
) {

147 
code
 = ((
°©0
 >> 
LCA_IOC_STAT0_CODE_SHIFT
)

148 & 
LCA_IOC_STAT0_CODE_MASK
);

149 i‡(
code
 != 1) {

150 
	`¥ötk
("lˇ.c:c⁄f_ªad: gŸ sèt0=%lx\n", 
°©0
);

154 *(
vuÕ
)
LCA_IOC_STAT0
 = 
°©0
;

155 
	`mb
();

158 
	`wrm˚s
(0x7);

160 
vÆue
 = 0xffffffff;

162 
	`loˇl_úq_ª°‹e
(
Êags
);

163  
vÆue
;

164 
	}
}

167 
	$c⁄f_wrôe
(
addr
, 
vÆue
)

169 
Êags
, 
code
, 
°©0
;

171 
	`loˇl_úq_ßve
(
Êags
);

174 
°©0
 = *(
vuÕ
)
LCA_IOC_STAT0
;

175 *(
vuÕ
)
LCA_IOC_STAT0
 = 
°©0
;

176 
	`mb
();

179 *(
vuù
)
addr
 = 
vÆue
;

180 
	`døöa
();

182 
°©0
 = *(
vuÕ
)
LCA_IOC_STAT0
;

183 i‡(
°©0
 & 
LCA_IOC_STAT0_ERR
) {

184 
code
 = ((
°©0
 >> 
LCA_IOC_STAT0_CODE_SHIFT
)

185 & 
LCA_IOC_STAT0_CODE_MASK
);

186 i‡(
code
 != 1) {

187 
	`¥ötk
("lˇ.c:c⁄f_wrôe: gŸ sèt0=%lx\n", 
°©0
);

191 *(
vuÕ
)
LCA_IOC_STAT0
 = 
°©0
;

192 
	`mb
();

195 
	`wrm˚s
(0x7);

197 
	`loˇl_úq_ª°‹e
(
Êags
);

198 
	}
}

201 
	$lˇ_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

202 
size
, 
u32
 *
vÆue
)

204 
addr
, 
pci_addr
;

205 
mask
;

206 
shi·
;

208 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
))

209  
PCIBIOS_DEVICE_NOT_FOUND
;

211 
shi·
 = (
whîe
 & 3) * 8;

212 
mask
 = (
size
 - 1) * 8;

213 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
LCA_CONF
;

214 *
vÆue
 = 
	`c⁄f_ªad
(
addr
Ë>> (
shi·
);

215  
PCIBIOS_SUCCESSFUL
;

216 
	}
}

219 
	$lˇ_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
,

220 
u32
 
vÆue
)

222 
addr
, 
pci_addr
;

223 
mask
;

225 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
))

226  
PCIBIOS_DEVICE_NOT_FOUND
;

228 
mask
 = (
size
 - 1) * 8;

229 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
LCA_CONF
;

230 
	`c⁄f_wrôe
(
addr
, 
vÆue
 << ((
whîe
 & 3) * 8));

231  
PCIBIOS_SUCCESSFUL
;

232 
	}
}

234 
pci_›s
 
	glˇ_pci_›s
 =

236 .
ªad
 = 
lˇ_ªad_c⁄fig
,

237 .
	gwrôe
 = 
lˇ_wrôe_c⁄fig
,

241 
	$lˇ_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

243 
	`wmb
();

244 *(
vuÕ
)
LCA_IOC_TBIA
 = 0;

245 
	`mb
();

246 
	}
}

248 
__öô


249 
	$lˇ_öô_¨ch
()

251 
pci_c⁄åﬁÀr
 *
ho£
;

257 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

258 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

259 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

260 
ho£
->
ödex
 = 0;

262 
ho£
->
•¨£_mem_ba£
 = 
LCA_SPARSE_MEM
 - 
IDENT_ADDR
;

263 
ho£
->
dí£_mem_ba£
 = 
LCA_DENSE_MEM
 - 
IDENT_ADDR
;

264 
ho£
->
•¨£_io_ba£
 = 
LCA_IO
 - 
IDENT_ADDR
;

265 
ho£
->
dí£_io_ba£
 = 0;

277 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

278 
ho£
->
sg_pci
 = 
NULL
;

279 
__dúe˘_m≠_ba£
 = 0x40000000;

280 
__dúe˘_m≠_size
 = 0x40000000;

282 *(
vuÕ
)
LCA_IOC_W_BASE0
 = 
ho£
->
sg_iß
->
dma_ba£
 | (3UL << 32);

283 *(
vuÕ
)
LCA_IOC_W_MASK0
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

284 *(
vuÕ
)
LCA_IOC_T_BASE0
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
);

286 *(
vuÕ
)
LCA_IOC_W_BASE1
 = 
__dúe˘_m≠_ba£
 | (2UL << 32);

287 *(
vuÕ
)
LCA_IOC_W_MASK1
 = (
__dúe˘_m≠_size
 - 1) & 0xfff00000;

288 *(
vuÕ
)
LCA_IOC_T_BASE1
 = 0;

290 *(
vuÕ
)
LCA_IOC_TB_ENA
 = 0x80;

292 
	`lˇ_pci_tbi
(
ho£
, 0, -1);

299 *(
vuÕ
)
LCA_IOC_PAR_DIS
 = 1UL<<5;

307 i‡(
Æpha_usög_§m
)

308 
§m_h´
 = 0x80000000UL;

309 
	}
}

317 
	#ESR_EAV
 (1UL<< 0Ë

	)

318 
	#ESR_CEE
 (1UL<< 1Ë

	)

319 
	#ESR_UEE
 (1UL<< 2Ë

	)

320 
	#ESR_WRE
 (1UL<< 3Ë

	)

321 
	#ESR_SOR
 (1UL<< 4Ë

	)

322 
	#ESR_CTE
 (1UL<< 7Ë

	)

323 
	#ESR_MSE
 (1UL<< 9Ë

	)

324 
	#ESR_MHE
 (1UL<<10Ë

	)

325 
	#ESR_NXM
 (1UL<<12Ë

	)

327 
	#IOC_ERR
 ( 1<<4Ë

	)

328 
	#IOC_CMD_SHIFT
 0

	)

329 
	#IOC_CMD
 (0xf<<
IOC_CMD_SHIFT
)

	)

330 
	#IOC_CODE_SHIFT
 8

	)

331 
	#IOC_CODE
 (0xf<<
IOC_CODE_SHIFT
)

	)

332 
	#IOC_LOST
 ( 1<<5)

	)

333 
	#IOC_P_NBR
 ((
__u32
Ë~((1<<13Ë- 1))

	)

336 
	$mem_îr‹
(
e§
, 
ór
)

338 
	`¥ötk
(" %s %sÉrrorÅo %s occurredátáddress %x\n",

339 ((
e§
 & 
ESR_CEE
) ? "Correctable" :

340 (
e§
 & 
ESR_UEE
) ? "Uncorrectable" : "A"),

341 (
e§
 & 
ESR_WRE
) ? "write" : "read",

342 (
e§
 & 
ESR_SOR
) ? "memory" : "b-cache",

343 (Ë(
ór
 & 0x1ffffff8));

344 i‡(
e§
 & 
ESR_CTE
) {

345 
	`¥ötk
(" A b-cacheÅagÖarityÉrror was detected.\n");

347 i‡(
e§
 & 
ESR_MSE
) {

348 
	`¥ötk
(" Several other correctableÉrrors occurred.\n");

350 i‡(
e§
 & 
ESR_MHE
) {

351 
	`¥ötk
(" Several other uncorrectableÉrrors occurred.\n");

353 i‡(
e§
 & 
ESR_NXM
) {

354 
	`¥ötk
(" AttemptedÅoáccessÇon-existent memory.\n");

356 
	}
}

359 
	$ioc_îr‹
(
__u32
 
°©0
, __u32 
°©1
)

361 c⁄° * c⁄° 
pci_cmd
[] = {

368 c⁄° * c⁄° 
îr_«me
[] = {

373 
code
 = (
°©0
 & 
IOC_CODE
Ë>> 
IOC_CODE_SHIFT
;

374 
cmd
 = (
°©0
 & 
IOC_CMD
Ë>> 
IOC_CMD_SHIFT
;

376 
	`¥ötk
(" %s initiated PCI %s cycleÅoáddress %x"

378 
code
 > 3 ? "PCI" : "CPU", 
pci_cmd
[
cmd
], 
°©1
, 
îr_«me
[code]);

380 i‡(
code
 == 5 || code == 6) {

381 
	`¥ötk
(" (Error occurredát PCI memoryáddress %x.)\n",

382 (
°©0
 & ~
IOC_P_NBR
));

384 i‡(
°©0
 & 
IOC_LOST
) {

385 
	`¥ötk
(" Other PCIÉrrors occurred simultaneously.\n");

387 
	}
}

390 
	$lˇ_machöe_check
(
ve˘‹
, 
œ_±r
)

392 c⁄° * 
ªas⁄
;

393 
ñ_lˇ
 
ñ
;

395 
ñ
.
c
 = (
ñ_comm⁄
 *Ë
œ_±r
;

397 
	`wrm˚s
(
	`rdm˚s
());

399 
	`¥ötk
(
KERN_CRIT
 "LCA machine check: vector=%#lxÖc=%#lx code=%#x\n",

400 
ve˘‹
, 
	`gë_úq_ªgs
()->
pc
, (Ë
ñ
.
c
->
code
);

409 (Ë
ñ
.
c
->
code
) {

410 
MCHK_K_TPERR
: 
ªas⁄
 = "tagÖarityÉrror"; ;

411 
MCHK_K_TCPERR
: 
ªas⁄
 = "tag controlÖarityÉrror"; ;

412 
MCHK_K_HERR
: 
ªas⁄
 = "accessÅoÇon-existent memory"; ;

413 
MCHK_K_ECC_C
: 
ªas⁄
 = "correctable ECCÉrror"; ;

414 
MCHK_K_ECC_NC
: 
ªas⁄
 = "non-correctable ECCÉrror"; ;

415 
MCHK_K_CACKSOFT
: 
ªas⁄
 = "MCHK_K_CACKSOFT"; ;

416 
MCHK_K_BUGCHECK
: 
ªas⁄
 = "illegalÉxception in PAL mode"; ;

417 
MCHK_K_OS_BUGCHECK
: 
ªas⁄
 = "callsys in kernel mode"; ;

418 
MCHK_K_DCPERR
: 
ªas⁄
 = "d-cacheÖarityÉrror"; ;

419 
MCHK_K_ICPERR
: 
ªas⁄
 = "i-cacheÖarityÉrror"; ;

420 
MCHK_K_SIO_SERR
: 
ªas⁄
 = "SIO SERR occurred on PCI bus"; ;

421 
MCHK_K_SIO_IOCHK
: 
ªas⁄
 = "SIO IOCHK occurred on ISA bus"; ;

422 
MCHK_K_DCSR
: 
ªas⁄
 = "MCHK_K_DCSR"; ;

423 
MCHK_K_UNKNOWN
:

424 : 
ªas⁄
 = "unknown"; ;

427 
ñ
.
c
->
size
) {

428 (
ñ_lˇ_mcheck_sh‹t
):

429 
	`¥ötk
(
KERN_CRIT


431 
ªas⁄
, 
ñ
.
c
->
ªåy
 ? ",Ñetryable" : "",

432 
ñ
.
s
->
dc_°©
);

433 i‡(
ñ
.
s
->
e§
 & 
ESR_EAV
) {

434 
	`mem_îr‹
(
ñ
.
s
->
e§
,Él.s->
ór
);

436 i‡(
ñ
.
s
->
ioc_°©0
 & 
IOC_ERR
) {

437 
	`ioc_îr‹
(
ñ
.
s
->
ioc_°©0
,Él.s->
ioc_°©1
);

441 (
ñ_lˇ_mcheck_l⁄g
):

442 
	`¥ötk
(
KERN_CRIT
 " Reason: %s (long frame%s):\n",

443 
ªas⁄
, 
ñ
.
c
->
ªåy
 ? ",Ñetryable" : "");

444 
	`¥ötk
(
KERN_CRIT


446 
ñ
.
l
->
±
[0],Él.l->
exc_addr
,Él.l->
dc_°©
);

447 
	`¥ötk
(
KERN_CRIT
 " c¨: %#lx\n", 
ñ
.
l
->
ˇr
);

448 i‡(
ñ
.
l
->
e§
 & 
ESR_EAV
) {

449 
	`mem_îr‹
(
ñ
.
l
->
e§
,Él.l->
ór
);

451 i‡(
ñ
.
l
->
ioc_°©0
 & 
IOC_ERR
) {

452 
	`ioc_îr‹
(
ñ
.
l
->
ioc_°©0
,Él.l->
ioc_°©1
);

457 
	`¥ötk
(
KERN_CRIT
 " Unknow¿îr‹log sizê%d\n", 
ñ
.
c
->
size
);

461 #ifde‡
CONFIG_VERBOSE_MCHECK


462 i‡(
Æpha_vîbo£_mcheck
 > 1) {

463 * 
±r
 = (*Ë
œ_±r
;

464 
i
;

465 
i
 = 0; i < 
ñ
.
c
->
size
 / (); i += 2) {

466 
	`¥ötk
(
KERN_CRIT
 " +%8lx %016lx %016lx\n",

467 
i
*(), 
±r
[i],Ötr[i+1]);

471 
	}
}

479 
	$lˇ_˛ock_¥öt
()

481 
pmr_ªg
;

483 
pmr_ªg
 = 
LCA_READ_PMR
;

485 
	`¥ötk
("Status of clock control:\n");

486 
	`¥ötk
("\tPrim¨y clock divis‹\t0x%lx\n", 
	`LCA_GET_PRIMARY
(
pmr_ªg
));

487 
	`¥ötk
("\tOvîridê˛ock divis‹\t0x%lx\n", 
	`LCA_GET_OVERRIDE
(
pmr_ªg
));

488 
	`¥ötk
("\tInterrupt override is %s\n",

489 (
pmr_ªg
 & 
LCA_PMR_INTO
) ? "on" : "off");

490 
	`¥ötk
("\tDMA override is %s\n",

491 (
pmr_ªg
 & 
LCA_PMR_DMAO
) ? "on" : "off");

493 
	}
}

496 
	$lˇ_gë_˛ock
()

498 
pmr_ªg
;

500 
pmr_ªg
 = 
LCA_READ_PMR
;

501 (
	`LCA_GET_PRIMARY
(
pmr_ªg
));

503 
	}
}

506 
	$lˇ_˛ock_fiddÀ
(
divis‹
)

508 
pmr_ªg
;

510 
pmr_ªg
 = 
LCA_READ_PMR
;

511 
	`LCA_SET_PRIMARY_CLOCK
(
pmr_ªg
, 
divis‹
);

513 
	`LCA_WRITE_PMR
(
pmr_ªg
);

514 
	`mb
();

515 
	}
}

	@arch/alpha/kernel/core_marvel.c

7 
	#__EXTERN_INLINE
 
ölöe


	)

8 
	~<asm/io.h
>

9 
	~<asm/c‹e_m¨vñ.h
>

10 #unde‡
__EXTERN_INLINE


12 
	~<löux/ty≥s.h
>

13 
	~<löux/pci.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/vmÆloc.h
>

17 
	~<löux/mc146818πc.h
>

18 
	~<löux/πc.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/boŸmem.h
>

22 
	~<asm/±ø˚.h
>

23 
	~<asm/smp.h
>

24 
	~<asm/g˘.h
>

25 
	~<asm/pgÆloc.h
>

26 
	~<asm/ébÊush.h
>

27 
	~<asm/πc.h
>

28 
	~<asm/vga.h
>

30 
	~"¥Ÿo.h
"

31 
	~"pci_im∂.h
"

37 
	#DEBUG_CONFIG
 0

	)

39 #i‡
DEBUG_CONFIG


40 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

42 
	#DBG_CFG
(
¨gs
)

	)

49 
io7
 *
	gio7_hód
 = 
NULL
;

55 
__©åibuã__
 ((
unu£d
))

56 
	$ªad_ev7_c§
(
≥
, 
off£t
)

58 
ev7_c§
 *
ev7c§
 = 
	`EV7_CSR_KERN
(
≥
, 
off£t
);

59 
q
;

61 
	`mb
();

62 
q
 = 
ev7c§
->
c§
;

63 
	`mb
();

65  
q
;

66 
	}
}

68 
__©åibuã__
 ((
unu£d
))

69 
	$wrôe_ev7_c§
(
≥
, 
off£t
, 
q
)

71 
ev7_c§
 *
ev7c§
 = 
	`EV7_CSR_KERN
(
≥
, 
off£t
);

73 
	`mb
();

74 
ev7c§
->
c§
 = 
q
;

75 
	`mb
();

76 
	}
}

78 * 
__öô


79 
	$mk_ªsour˚_«me
(
≥
, 
p‹t
, *
°r
)

81 
tmp
[80];

82 *
«me
;

84 
	`•rötf
(
tmp
, "PCI %†PE %d PORT %d", 
°r
, 
≥
, 
p‹t
);

85 
«me
 = 
	`Æloc_boŸmem
(
	`°æí
(
tmp
) + 1);

86 
	`°r˝y
(
«me
, 
tmp
);

88  
«me
;

89 
	}
}

91 
ölöe
 
io7
 *

92 
	$m¨vñ_√xt_io7
(
io7
 *
¥ev
)

94  (
¥ev
 ?Öªv->
√xt
 : 
io7_hód
);

95 
	}
}

97 
io7
 *

98 
	$m¨vñ_föd_io7
(
≥
)

100 
io7
 *io7;

102 
io7
 = 
io7_hód
; io7 && io7->
≥
 !≥; io7 = io7->
√xt
)

105  
io7
;

106 
	}
}

108 
io7
 * 
__öô


109 
	$Æloc_io7
(
≥
)

111 
io7
 *io7;

112 
io7
 *
ö•
;

113 
h
;

115 i‡(
	`m¨vñ_föd_io7
(
≥
)) {

116 
	`¥ötk
(
KERN_WARNING
 "IO7áàPE %dáÃódyáŒoˇãd!\n", 
≥
);

117  
NULL
;

120 
io7
 = 
	`Æloc_boŸmem
((*io7));

121 
io7
->
≥
 =Öe;

122 
	`•ö_lock_öô
(&
io7
->
úq_lock
);

124 
h
 = 0; h < 4; h++) {

125 
io7
->
p‹ts
[
h
].io7 = io7;

126 
io7
->
p‹ts
[
h
].
p‹t
 = h;

127 
io7
->
p‹ts
[
h
].
íabÀd
 = 0;

133 i‡(
NULL
 =
io7_hód
)

134 
io7_hód
 = 
io7
;

135 i‡(
io7_hód
->
≥
 > 
io7
->pe) {

136 
io7
->
√xt
 = 
io7_hód
;

137 
io7_hód
 = 
io7
;

139 
ö•
 = 
io7_hód
; in•; in• = in•->
√xt
) {

140 i‡(
ö•
->
≥
 =
io7
->pe) {

141 
	`¥ötk
(
KERN_ERR
 "Too many IO7sát PE %d\n",

142 
io7
->
≥
);

143  
NULL
;

146 i‡(
NULL
 =
ö•
->
√xt
 ||

147 
ö•
->
√xt
->
≥
 > 
io7
->pe) {

148 
io7
->
√xt
 = 
ö•
->next;

149 
ö•
->
√xt
 = 
io7
;

154 i‡(
NULL
 =
ö•
) {

155 
	`¥ötk
(
KERN_WARNING
 "FailedÅo insert IO7át PE %d "

156 " -áddögáàhód o‡li°\n", 
io7
->
≥
);

157 
io7
->
√xt
 = 
io7_hód
;

158 
io7_hód
 = 
io7
;

162  
io7
;

163 
	}
}

166 
	$io7_˛ór_îr‹s
(
io7
 *io7)

168 
io7_p‹t7_c§s
 *
p7c§s
;

169 
io7_i›‹t_c§s
 *
c§s
;

170 
p‹t
;

176 
p‹t
 = 0;Öort < 4;Öort++) {

177 
c§s
 = 
	`IO7_CSRS_KERN
(
io7
->
≥
, 
p‹t
);

179 
c§s
->
POx_ERR_SUM
.
c§
 = -1UL;

180 
c§s
->
POx_TLB_ERR
.
c§
 = -1UL;

181 
c§s
->
POx_SPL_COMPLT
.
c§
 = -1UL;

182 
c§s
->
POx_TRANS_SUM
.
c§
 = -1UL;

188 
p7c§s
 = 
	`IO7_PORT7_CSRS_KERN
(
io7
->
≥
);

190 
p7c§s
->
PO7_ERROR_SUM
.
c§
 = -1UL;

191 
p7c§s
->
PO7_UNCRR_SYM
.
c§
 = -1UL;

192 
p7c§s
->
PO7_CRRCT_SYM
.
c§
 = -1UL;

193 
	}
}

199 
__öô


200 
	$io7_öô_ho£
(
io7
 *io7, 
p‹t
)

202 
ho£_ödex
 = 0;

204 
pci_c⁄åﬁÀr
 *
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

205 
io7_p‹t
 *io7_p‹à&
io7
->
p‹ts
[
p‹t
];

206 
io7_i›‹t_c§s
 *
c§s
 = 
	`IO7_CSRS_KERN
(
io7
->
≥
, 
p‹t
);

207 
i
;

209 
ho£
->
ödex
 = 
ho£_ödex
++;

219 i‡(
ho£
->
ödex
 == 0)

220 
pci_iß_ho£
 = 
ho£
;

222 
io7_p‹t
->
c§s
 = csrs;

223 
io7_p‹t
->
ho£
 = hose;

224 
ho£
->
sysd©a
 = 
io7_p‹t
;

226 
ho£
->
io_•a˚
 = 
	`Æloc_ªsour˚
();

227 
ho£
->
mem_•a˚
 = 
	`Æloc_ªsour˚
();

233 
ho£
->
•¨£_mem_ba£
 = ho£->
•¨£_io_ba£
 = 0;

234 
ho£
->
dí£_mem_ba£
 = 
	`IO7_MEM_PHYS
(
io7
->
≥
, 
p‹t
);

235 
ho£
->
dí£_io_ba£
 = 
	`IO7_IO_PHYS
(
io7
->
≥
, 
p‹t
);

240 
ho£
->
c⁄fig_•a˚_ba£
 = ()
	`IO7_CONF_KERN
(
io7
->
≥
, 
p‹t
);

242 
ho£
->
io_•a˚
->
°¨t
 = ()
	`IO7_IO_KERN
(
io7
->
≥
, 
p‹t
);

243 
ho£
->
io_•a˚
->
íd
 = ho£->io_•a˚->
°¨t
 + 
IO7_IO_SPACE
 - 1;

244 
ho£
->
io_•a˚
->
«me
 = 
	`mk_ªsour˚_«me
(
io7
->
≥
, 
p‹t
, "IO");

245 
ho£
->
io_•a˚
->
Êags
 = 
IORESOURCE_IO
;

247 
ho£
->
mem_•a˚
->
°¨t
 = ()
	`IO7_MEM_KERN
(
io7
->
≥
, 
p‹t
);

248 
ho£
->
mem_•a˚
->
íd
 = ho£->mem_•a˚->
°¨t
 + 
IO7_MEM_SPACE
 - 1;

249 
ho£
->
mem_•a˚
->
«me
 = 
	`mk_ªsour˚_«me
(
io7
->
≥
, 
p‹t
, "MEM");

250 
ho£
->
mem_•a˚
->
Êags
 = 
IORESOURCE_MEM
;

252 i‡(
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
ho£
->
io_•a˚
) < 0)

253 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest IO on hose %d\n",

254 
ho£
->
ödex
);

255 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
ho£
->
mem_•a˚
) < 0)

256 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest MEM on hose %d\n",

257 
ho£
->
ödex
);

262 
i
 = 0; i < 4; i++) {

263 
io7_p‹t
->
ßved_wba£
[
i
] = 
c§s
->
POx_WBASE
[i].
c§
;

264 
io7_p‹t
->
ßved_wmask
[
i
] = 
c§s
->
POx_WMASK
[i].
c§
;

265 
io7_p‹t
->
ßved_tba£
[
i
] = 
c§s
->
POx_TBASE
[i].
c§
;

280 
	`m¨vñ_pci_tbi
(
ho£
, 0, -1);

285 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w_node
(
	`m¨vñ_˝uid_to_nid
(
io7
->
≥
),

286 
ho£
, 0x00800000, 0x00800000, 0);

287 
ho£
->
sg_iß
->
Æign_íåy
 = 8;

288 
c§s
->
POx_WBASE
[0].
c§
 =

289 
ho£
->
sg_iß
->
dma_ba£
 | 
wba£_m_ía
 | 
wba£_m_sg
;

290 
c§s
->
POx_WMASK
[0].
c§
 = (
ho£
->
sg_iß
->
size
 - 1Ë& 
wba£_m_addr
;

291 
c§s
->
POx_TBASE
[0].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
);

296 
c§s
->
POx_WBASE
[1].
c§
 = 
__dúe˘_m≠_ba£
 | 
wba£_m_ía
;

297 
c§s
->
POx_WMASK
[1].
c§
 = (
__dúe˘_m≠_size
 - 1Ë& 
wba£_m_addr
;

298 
c§s
->
POx_TBASE
[1].
c§
 = 0;

303 
ho£
->
sg_pci
 = 
	`iommu_¨ía_√w_node
(
	`m¨vñ_˝uid_to_nid
(
io7
->
≥
),

304 
ho£
, 0xc0000000, 0x40000000, 0);

305 
ho£
->
sg_pci
->
Æign_íåy
 = 8;

306 
c§s
->
POx_WBASE
[2].
c§
 =

307 
ho£
->
sg_pci
->
dma_ba£
 | 
wba£_m_ía
 | 
wba£_m_sg
;

308 
c§s
->
POx_WMASK
[2].
c§
 = (
ho£
->
sg_pci
->
size
 - 1Ë& 
wba£_m_addr
;

309 
c§s
->
POx_TBASE
[2].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_pci
->
±es
);

314 
c§s
->
POx_WBASE
[3].
c§
 = 0;

319 
c§s
->
POx_CTRL
.
c§
 &= ~(1UL << 61);

322 
	`¥ötk
("FIXME: disabling masteráborts\n");

323 
c§s
->
POx_MSK_HEI
.
c§
 &= ~(3UL << 14);

328 
	`m¨vñ_pci_tbi
(
ho£
, 0, -1);

329 
	}
}

331 
__öô


332 
	$m¨vñ_öô_io7
(
io7
 *io7)

334 
i
;

336 
	`¥ötk
("Inôülizög IO7áàPID %d\n", 
io7
->
≥
);

341 
io7
->
c§s
 = 
	`IO7_PORT7_CSRS_KERN
(io7->
≥
);

346 
i
 = 0; i < 
IO7_NUM_PORTS
; i++) {

347 
io7_i›‹t_c§s
 *
c§s
 = 
	`IO7_CSRS_KERN
(
io7
->
≥
, 
i
);

348 i‡(
c§s
->
POx_CACHE_CTL
.
c§
 == 8) {

349 
io7
->
p‹ts
[
i
].
íabÀd
 = 1;

350 
	`io7_öô_ho£
(
io7
, 
i
);

353 
	}
}

356 
	$m¨vñ_io7_¥e£¡
(
g˘6_node
 *
node
)

358 
≥
;

360 i‡(
node
->
ty≥
 !
GCT_TYPE_HOSE
 ||

361 
node
->
subty≥
 !
GCT_SUBTYPE_IO_PORT_MODULE
)

364 
≥
 = (
node
->
id
 >> 8) & 0xff;

365 
	`¥ötk
("Foundá¿IO7áàPID %d\n", 
≥
);

367 
	`Æloc_io7
(
≥
);

368 
	}
}

370 
__öô


371 
	$m¨vñ_föd_c⁄sﬁe_vga_ho£
()

373 
u64
 *
pu64
 = (u64 *)((u64)
hwΩb
 + hwΩb->
˘bt_off£t
);

375 i‡(
pu64
[7] == 3) {

376 
pci_c⁄åﬁÀr
 *
ho£
 = 
NULL
;

377 
h
 = (
pu64
[30] >> 24) & 0xff;

378 
io7
 *io7;

379 
pid
, 
p‹t
;

386 
	`¥ötk
("c⁄sﬁêgøphic†i†⁄ ho£ %d (c⁄sﬁe)\n", 
h
);

396 
pid
 = 
h
 >> 2;

397 
p‹t
 = 
h
 & 3;

398 i‡((
io7
 = 
	`m¨vñ_föd_io7
(
pid
)))

399 
ho£
 = 
io7
->
p‹ts
[
p‹t
].hose;

401 i‡(
ho£
) {

402 
	`¥ötk
("C⁄sﬁêgøphic†⁄ ho£ %d\n", 
ho£
->
ödex
);

403 
pci_vga_ho£
 = 
ho£
;

406 
	}
}

408 
g˘6_£¨ch_°ru˘
 
	gg˘_w™ãd_node_li°
[] = {

409 { 
GCT_TYPE_HOSE
, 
GCT_SUBTYPE_IO_PORT_MODULE
, 
m¨vñ_io7_¥e£¡
 },

410 { 0, 0, 
NULL
 }

418 
__öô


419 
	$m¨vñ_•ecify_io7
(*
°r
)

421 
pid
;

422 
io7
 *io7;

423 *
pch¨
;

426 
pid
 = 
	`sim∂e_°πoul
(
°r
, &
pch¨
, 0);

427 i‡(
pch¨
 !
°r
) {

428 
	`¥ötk
("U£r-•ecifõd IO7áàPID %lu\n", 
pid
);

429 
io7
 = 
	`Æloc_io7
(
pid
);

430 i‡(
io7
Ë
	`m¨vñ_öô_io7
(io7);

433 i‡(
pch¨
 =
°r
)Öchar++;

434 
°r
 = 
pch¨
;

435 } *
°r
);

438 
	}
}

439 
__£tup
("io7=", 
m¨vñ_•ecify_io7
);

441 
__öô


442 
	$m¨vñ_öô_¨ch
()

444 
io7
 *io7;

447 
i›‹t_ªsour˚
.
íd
 = ~0UL;

450 
__dúe˘_m≠_ba£
 = 0x80000000;

451 
__dúe˘_m≠_size
 = 0x40000000;

454 
	`g˘6_föd_nodes
(
	`GCT_NODE_PTR
(0), 
g˘_w™ãd_node_li°
);

457 
io7
 = 
NULL
; NULL !(io7 = 
	`m¨vñ_√xt_io7
(io7)); )

458 
	`m¨vñ_öô_io7
(
io7
);

461 
	`m¨vñ_föd_c⁄sﬁe_vga_ho£
();

462 
	}
}

465 
	$m¨vñ_kûl_¨ch
(
mode
)

467 
	}
}

497 
ölöe
 

498 
	$buûd_c⁄f_addr
(
pci_c⁄åﬁÀr
 *
ho£
, 
u8
 
bus
,

499 
dev‚
, 
whîe
)

501  (
ho£
->
c⁄fig_•a˚_ba£
 | (
bus
 << 16Ë| (
dev‚
 << 8Ë| 
whîe
);

502 
	}
}

505 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
dev‚
, 
whîe
)

507 
pci_c⁄åﬁÀr
 *
ho£
 = 
pbus
->
sysd©a
;

508 
io7_p‹t
 *io7_port;

509 
addr
 = 0;

510 
u8
 
bus
 = 
pbus
->
numbî
;

512 i‡(!
ho£
)

513  
addr
;

516 
io7_p‹t
 = 
ho£
->
sysd©a
;

517 i‡(!
io7_p‹t
->
íabÀd
)

518  
addr
;

520 i‡(!
pbus
->
∑ª¡
) {

522 i‡(
dev‚
 >
	`PCI_DEVFN
(21, 0))

523  
addr
;

524 
bus
 = 0;

527 
addr
 = 
	`buûd_c⁄f_addr
(
ho£
, 
bus
, 
dev‚
, 
whîe
);

529 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

530  
addr
;

531 
	}
}

534 
	$m¨vñ_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

535 
size
, 
u32
 *
vÆue
)

537 
addr
;

539 i‡(0 =(
addr
 = 
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
)))

540  
PCIBIOS_DEVICE_NOT_FOUND
;

542 
size
) {

544 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

547 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

550 *
vÆue
 = *(
vuù
)
addr
;

553  
PCIBIOS_FUNC_NOT_SUPPORTED
;

556  
PCIBIOS_SUCCESSFUL
;

557 
	}
}

560 
	$m¨vñ_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

561 
size
, 
u32
 
vÆue
)

563 
addr
;

565 i‡(0 =(
addr
 = 
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
)))

566  
PCIBIOS_DEVICE_NOT_FOUND
;

568 
size
) {

570 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

571 
	`mb
();

572 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

575 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

576 
	`mb
();

577 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

580 *(
vuù
)
addr
 = 
vÆue
;

581 
	`mb
();

582 *(
vuù
)
addr
;

585  
PCIBIOS_FUNC_NOT_SUPPORTED
;

588  
PCIBIOS_SUCCESSFUL
;

589 
	}
}

591 
pci_›s
 
	gm¨vñ_pci_›s
 =

593 .
ªad
 = 
m¨vñ_ªad_c⁄fig
,

594 .
	gwrôe
 = 
m¨vñ_wrôe_c⁄fig
,

602 
	$m¨vñ_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

604 
io7_i›‹t_c§s
 *
c§s
 = ((
io7_p‹t
 *)
ho£
->
sysd©a
)->csrs;

606 
	`wmb
();

607 
c§s
->
POx_SG_TBIA
.
c§
 = 0;

608 
	`mb
();

609 
c§s
->
POx_SG_TBIA
.
c§
;

610 
	}
}

617 
	sm¨vñ_πc_ac˚ss_öfo
 {

618 
	mfun˘i⁄
;

619 
	mödex
;

620 
	md©a
;

624 
	$__m¨vñ_ac˚ss_πc
(*
öfo
)

626 
m¨vñ_πc_ac˚ss_öfo
 *
πc_ac˚ss
 = 
öfo
;

628 
__r0
 
	`__asm__
("$0");

629 
__r16
 
	`__asm__
("$16"Ë
πc_ac˚ss
->
fun˘i⁄
;

630 
__r17
 
	`__asm__
("$17"Ë
πc_ac˚ss
->
ödex
;

631 
__r18
 
	`__asm__
("$18"Ë
πc_ac˚ss
->
d©a
;

633 
__asm__
 
	`__vﬁ©ûe__
(

635 : "Ù"(
__r16
), "Ù"(
__r17
), "Ù"(
__r18
), "Ù"(
__r0
)

636 : "i"(
PAL_c£rve
), "0"(
__r16
), "1"(
__r17
), "2"(
__r18
)

639 
πc_ac˚ss
->
d©a
 = 
__r0
;

640 
	}
}

642 
u8


643 
	$__m¨vñ_πc_io
(
u8
 
b
, 
addr
, 
wrôe
)

645 
u8
 
ödex
 = 0;

647 
m¨vñ_πc_ac˚ss_öfo
 
πc_ac˚ss
;

648 
u8
 
ªt
 = 0;

650 
addr
) {

652 i‡(
wrôe
Ë
ödex
 = 
b
;

653 
ªt
 = 
ödex
;

657 
πc_ac˚ss
.
ödex
 = index;

658 
πc_ac˚ss
.
d©a
 = 
	`BCD_TO_BIN
(
b
);

659 
πc_ac˚ss
.
fun˘i⁄
 = 0x48 + !
wrôe
;

661 #ifde‡
CONFIG_SMP


662 i‡(
	`smp_¥o˚ss‹_id
(Ë!
boŸ_˝uid
)

663 
	`smp_ˇŒ_fun˘i⁄_⁄_˝u
(
__m¨vñ_ac˚ss_πc
,

664 &
πc_ac˚ss
, 1, 1,

665 
	`˝umask_of_˝u
(
boŸ_˝uid
));

667 
	`__m¨vñ_ac˚ss_πc
(&
πc_ac˚ss
);

669 
	`__m¨vñ_ac˚ss_πc
(&
πc_ac˚ss
);

671 
ªt
 = 
	`BIN_TO_BCD
(
πc_ac˚ss
.
d©a
);

675 
	`¥ötk
(
KERN_WARNING
 "IŒegÆ RTCÖ‹à%lx\n", 
addr
);

679  
ªt
;

680 
	}
}

686 
__iomem
 *

687 
	$m¨vñ_i‹em≠
(
addr
, 
size
)

689 
pci_c⁄åﬁÀr
 *
ho£
;

690 
baddr
, 
œ°
;

691 
vm_°ru˘
 *
¨ó
;

692 
vaddr
;

693 *
±es
;

694 
p‚
;

699 
	`FIXUP_MEMADDR_VGA
(
addr
);

704 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
) {

705 i‡((
addr
 >> 32Ë=(
ho£
->
mem_•a˚
->
°¨t
 >> 32))

708 i‡(!
ho£
)

709  
NULL
;

714 
baddr
 = 
addr
 - 
ho£
->
mem_•a˚
->
°¨t
;

715 
œ°
 = 
baddr
 + 
size
 - 1;

720 i‡((
baddr
 >
__dúe˘_m≠_ba£
) &&

721 ((
baddr
 + 
size
 - 1Ë< 
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
)) {

722 
addr
 = 
IDENT_ADDR
 | (
baddr
 - 
__dúe˘_m≠_ba£
);

723  (
__iomem
 *Ë
addr
;

729 i‡(
ho£
->
sg_pci
 &&

730 
baddr
 >()
ho£
->
sg_pci
->
dma_ba£
 &&

731 
œ°
 < ()
ho£
->
sg_pci
->
dma_ba£
 + ho£->sg_pci->
size
) {

736 
baddr
 -
ho£
->
sg_pci
->
dma_ba£
;

737 
œ°
 -
ho£
->
sg_pci
->
dma_ba£
;

738 
baddr
 &
PAGE_MASK
;

739 
size
 = 
	`PAGE_ALIGN
(
œ°
Ë- 
baddr
;

744 
¨ó
 = 
	`gë_vm_¨ó
(
size
, 
VM_IOREMAP
);

745 i‡(!
¨ó
)

746  
NULL
;

748 
±es
 = 
ho£
->
sg_pci
->ptes;

749 
vaddr
 = ()
¨ó
->
addr
;

750 
baddr
 <
œ°
;

751 
baddr
 +
PAGE_SIZE
, 
vaddr
 += PAGE_SIZE) {

752 
p‚
 = 
±es
[
baddr
 >> 
PAGE_SHIFT
];

753 i‡(!(
p‚
 & 1)) {

754 
	`¥ötk
("ioremap failed...ÖteÇot valid...\n");

755 
	`v‰ì
(
¨ó
->
addr
);

756  
NULL
;

758 
p‚
 >>= 1;

760 i‡(
	`__Æpha_ªm≠_¨ó_∑ges
(
vaddr
,

761 
p‚
 << 
PAGE_SHIFT
,

762 
PAGE_SIZE
, 0)) {

763 
	`¥ötk
("FAILEDÅo map...\n");

764 
	`v‰ì
(
¨ó
->
addr
);

765  
NULL
;

769 
	`Êush_éb_Æl
();

771 
vaddr
 = ()
¨ó
->
addr
 + (add∏& ~
PAGE_MASK
);

773  (
__iomem
 *Ë
vaddr
;

777 
vaddr
 = 
baddr
 + 
ho£
->
mem_•a˚
->
°¨t
;

778  (
__iomem
 *Ë
vaddr
;

779 
	}
}

782 
	$m¨vñ_iounm≠
(vﬁ©ûê
__iomem
 *
xaddr
)

784 
addr
 = (Ë
xaddr
;

785 i‡(
addr
 >
VMALLOC_START
)

786 
	`v‰ì
((*)(
PAGE_MASK
 & 
addr
));

787 
	}
}

790 
	$m¨vñ_is_mmio
(c⁄° vﬁ©ûê
__iomem
 *
xaddr
)

792 
addr
 = (Ë
xaddr
;

794 i‡(
addr
 >
VMALLOC_START
)

797  (
addr
 & 0xFF000000UL) == 0;

798 
	}
}

800 
	#__m¨vñ_is_p‹t_kbd
(
a
Ë((◊Ë=0x60Ë|| (◊Ë=0x64))

	)

801 
	#__m¨vñ_is_p‹t_πc
(
a
Ë((◊Ë=0x70Ë|| (◊Ë=0x71))

	)

803 
__iomem
 *
	$m¨vñ_i›‹tm≠
 (
addr
)

805 
	`FIXUP_IOADDR_VGA
(
addr
);

806  (
__iomem
 *)
addr
;

807 
	}
}

810 
	$m¨vñ_i‹ód8
(
__iomem
 *
xaddr
)

812 
addr
 = (Ë
xaddr
;

813 i‡(
	`__m¨vñ_is_p‹t_kbd
(
addr
))

815 i‡(
	`__m¨vñ_is_p‹t_πc
(
addr
))

816  
	`__m¨vñ_πc_io
(0, 
addr
, 0);

817 i‡(
	`m¨vñ_is_iﬂddr
(
addr
))

818  
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

825 
	}
}

828 
	$m¨vñ_iowrôe8
(
u8
 
b
, 
__iomem
 *
xaddr
)

830 
addr
 = (Ë
xaddr
;

831 i‡(
	`__m¨vñ_is_p‹t_kbd
(
addr
))

833 i‡(
	`__m¨vñ_is_p‹t_πc
(
addr
))

834 
	`__m¨vñ_πc_io
(
b
, 
addr
, 1);

835 i‡(
	`m¨vñ_is_iﬂddr
(
addr
))

836 
	`__kî√l_°b
(
b
, *(
vu˝
)
addr
);

837 
	}
}

839 #i‚de‡
CONFIG_ALPHA_GENERIC


840 
EXPORT_SYMBOL
(
m¨vñ_i‹em≠
);

841 
EXPORT_SYMBOL
(
m¨vñ_iounm≠
);

842 
EXPORT_SYMBOL
(
m¨vñ_is_mmio
);

843 
EXPORT_SYMBOL
(
m¨vñ_i›‹tm≠
);

844 
EXPORT_SYMBOL
(
m¨vñ_i‹ód8
);

845 
EXPORT_SYMBOL
(
m¨vñ_iowrôe8
);

857 
	$m¨vñ_∑_to_nid
(
∑
)

859 
˝uid
;

861 i‡((
∑
 >> 43) & 1)

862 
˝uid
 = (~(
∑
 >> 35) & 0xff);

864 
˝uid
 = ((
∑
 >> 34) & 0x3) | ((pa >> (37 - 2)) & (0x1f << 2));

866  
	`m¨vñ_˝uid_to_nid
(
˝uid
);

867 
	}
}

870 
	$m¨vñ_˝uid_to_nid
(
˝uid
)

872  
˝uid
;

873 
	}
}

876 
	$m¨vñ_node_mem_°¨t
(
nid
)

878 
∑
;

880 
∑
 = (
nid
 & 0x3) | ((nid & (0x1f << 2)) << 1);

881 
∑
 <<= 34;

883  
∑
;

884 
	}
}

887 
	$m¨vñ_node_mem_size
(
nid
)

890 
	}
}

896 
	~<löux/agp_backíd.h
>

897 
	~<asm/agp_backíd.h
>

898 
	~<löux/¶ab.h
>

899 
	~<löux/dñay.h
>

901 
	sm¨vñ_agp_≠îtuª
 {

902 
pci_iommu_¨ía
 *
	m¨ía
;

903 
	mpg_°¨t
;

904 
	mpg_cou¡
;

908 
	$m¨vñ_agp_£tup
(
Æpha_agp_öfo
 *
agp
)

910 
m¨vñ_agp_≠îtuª
 *
≠î
;

912 i‡(!
Æpha_agpg¨t_size
)

913  -
ENOMEM
;

915 
≠î
 = 
	`kmÆloc
((*≠î), 
GFP_KERNEL
);

916 i‡(
≠î
 =
NULL
Ë -
ENOMEM
;

918 
≠î
->
¨ía
 = 
agp
->
ho£
->
sg_pci
;

919 
≠î
->
pg_cou¡
 = 
Æpha_agpg¨t_size
 / 
PAGE_SIZE
;

920 
≠î
->
pg_°¨t
 = 
	`iommu_ª£rve
◊≥r->
¨ía
,á≥r->
pg_cou¡
,

921 
≠î
->
pg_cou¡
 - 1);

923 i‡(
≠î
->
pg_°¨t
 < 0) {

924 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑeserve AGP memory\n");

925 
	`k‰ì
(
≠î
);

926  -
ENOMEM
;

929 
agp
->
≠îtuª
.
bus_ba£
 =

930 
≠î
->
¨ía
->
dma_ba£
 +á≥r->
pg_°¨t
 * 
PAGE_SIZE
;

931 
agp
->
≠îtuª
.
size
 = 
≠î
->
pg_cou¡
 * 
PAGE_SIZE
;

932 
agp
->
≠îtuª
.
sysd©a
 = 
≠î
;

935 
	}
}

938 
	$m¨vñ_agp_˛ónup
(
Æpha_agp_öfo
 *
agp
)

940 
m¨vñ_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

941 
°©us
;

943 
°©us
 = 
	`iommu_ªÀa£
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,á≥r->
pg_cou¡
);

944 i‡(
°©us
 =-
EBUSY
) {

945 
	`¥ötk
(
KERN_WARNING


947 
	`iommu_unböd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,á≥r->
pg_cou¡
);

948 
°©us
 = 
	`iommu_ªÀa£
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,

949 
≠î
->
pg_cou¡
);

951 i‡(
°©us
 < 0)

952 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑelease AGP memory\n");

954 
	`k‰ì
(
≠î
);

955 
	`k‰ì
(
agp
);

956 
	}
}

959 
	$m¨vñ_agp_c⁄figuª
(
Æpha_agp_öfo
 *
agp
)

961 
io7_i›‹t_c§s
 *
c§s
 = ((
io7_p‹t
 *)
agp
->
ho£
->
sysd©a
)->csrs;

962 
io7
 *io7 = ((
io7_p‹t
 *)
agp
->
ho£
->
sysd©a
)->io7;

963 
√w_øã
 = 0;

964 
agp_∂l
;

971 
agp_∂l
 = 
io7
->
c§s
->
POx_RST
[
IO7_AGP_PORT
].
c§
;

972 
	`IO7_PLL_RNGB
(
agp_∂l
)) {

978 i‡(
agp
->
mode
.
bôs
.
øã
 != 2)

979 
√w_øã
 = 2;

987 i‡(
agp
->
mode
.
bôs
.
øã
 == 2)

988 
√w_øã
 = 1;

996 
	`¥ötk
("%s: unknown PLL setting RNGB=%lx (PLL6_CTL=%016lx)\n",

997 
__FUNCTION__
, 
	`IO7_PLL_RNGB
(
agp_∂l
),ágp_pll);

1004 i‡(
√w_øã
) {

1005 
	`¥ötk
("Requested AGP Rate %dXÇot compatible "

1007 
agp
->
mode
.
bôs
.
øã
,

1008 
√w_øã
);

1010 
agp
->
mode
.
bôs
.
øã
 = 
√w_øã
;

1013 
	`¥ötk
("Enabling AGP on hose %d: %dX%s RQ %d\n",

1014 
agp
->
ho£
->
ödex
,ágp->
mode
.
bôs
.
øã
,

1015 
agp
->
mode
.
bôs
.
sba
 ? " - SBA" : "",ágp->mode.bôs.
rq
);

1017 
c§s
->
AGP_CMD
.
c§
 = 
agp
->
mode
.
lw
;

1020 
	}
}

1023 
	$m¨vñ_agp_böd_mem‹y
(
Æpha_agp_öfo
 *
agp
, 
off_t
 
pg_°¨t
, 
agp_mem‹y
 *
mem
)

1025 
m¨vñ_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

1026  
	`iommu_böd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
 +Ög_start,

1027 
mem
->
∑ge_cou¡
, mem->
mem‹y
);

1028 
	}
}

1031 
	$m¨vñ_agp_unböd_mem‹y
(
Æpha_agp_öfo
 *
agp
, 
off_t
 
pg_°¨t
, 
agp_mem‹y
 *
mem
)

1033 
m¨vñ_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

1034  
	`iommu_unböd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
 +Ög_start,

1035 
mem
->
∑ge_cou¡
);

1036 
	}
}

1039 
	$m¨vñ_agp_å™¶©e
(
Æpha_agp_öfo
 *
agp
, 
dma_addr_t
 
addr
)

1041 
m¨vñ_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

1042 
baddr
 = 
addr
 - 
≠î
->
¨ía
->
dma_ba£
;

1043 
±e
;

1045 i‡(
addr
 < 
agp
->
≠îtuª
.
bus_ba£
 ||

1046 
addr
 >
agp
->
≠îtuª
.
bus_ba£
 +ágp->≠îtuª.
size
) {

1047 
	`¥ötk
("%s:ádd∏ouào‡ønge\n", 
__FUNCTION__
);

1048  -
EINVAL
;

1051 
±e
 = 
≠î
->
¨ía
->
±es
[
baddr
 >> 
PAGE_SHIFT
];

1052 i‡(!(
±e
 & 1)) {

1053 
	`¥ötk
("%s:ÖãÇŸ vÆid\n", 
__FUNCTION__
);

1054  -
EINVAL
;

1056  (
±e
 >> 1Ë<< 
PAGE_SHIFT
;

1057 
	}
}

1059 
Æpha_agp_›s
 
	gm¨vñ_agp_›s
 =

1061 .
£tup
 = 
m¨vñ_agp_£tup
,

1062 .
	g˛ónup
 = 
m¨vñ_agp_˛ónup
,

1063 .
	gc⁄figuª
 = 
m¨vñ_agp_c⁄figuª
,

1064 .
	gböd
 = 
m¨vñ_agp_böd_mem‹y
,

1065 .
	gunböd
 = 
m¨vñ_agp_unböd_mem‹y
,

1066 .
	gå™¶©e
 = 
m¨vñ_agp_å™¶©e


1069 
Æpha_agp_öfo
 *

1070 
	$m¨vñ_agp_öfo
()

1072 
pci_c⁄åﬁÀr
 *
ho£
;

1073 
io7_i›‹t_c§s
 *
c§s
;

1074 
Æpha_agp_öfo
 *
agp
;

1075 
io7
 *io7;

1083 
ho£
 = 
NULL
;

1084 
io7
 = 
NULL
; (io7 = 
	`m¨vñ_√xt_io7
(io7)) != NULL; ) {

1085 
pci_c⁄åﬁÀr
 *
h
;

1086 
vuù
 
addr
;

1088 i‡(!
io7
->
p‹ts
[
IO7_AGP_PORT
].
íabÀd
)

1091 
h
 = 
io7
->
p‹ts
[
IO7_AGP_PORT
].
ho£
;

1092 
addr
 = (
vuù
)
	`buûd_c⁄f_addr
(
h
, 0, 
	`PCI_DEVFN
(5, 0), 0);

1094 i‡(*
addr
 != 0xffffffffu) {

1095 
ho£
 = 
h
;

1100 i‡(!
ho£
 || !ho£->
sg_pci
)

1101  
NULL
;

1103 
	`¥ötk
("MARVEL - usög ho£ %dá†AGP\n", 
ho£
->
ödex
);

1108 
c§s
 = ((
io7_p‹t
 *)
ho£
->
sysd©a
)->csrs;

1113 
agp
 = 
	`kmÆloc
((*agp), 
GFP_KERNEL
);

1118 
agp
->
ho£
 = hose;

1119 
agp
->
¥iv©e
 = 
NULL
;

1120 
agp
->
›s
 = &
m¨vñ_agp_›s
;

1125 
agp
->
≠îtuª
.
bus_ba£
 = 0;

1126 
agp
->
≠îtuª
.
size
 = 0;

1127 
agp
->
≠îtuª
.
sysd©a
 = 
NULL
;

1136 
agp
->
ˇ∑bûôy
.
lw
 = 
c§s
->
AGP_STAT
.
c§
;

1137 
agp
->
ˇ∑bûôy
.
bôs
.
rq
 = 0xf;

1142 
agp
->
mode
.
lw
 = 
c§s
->
AGP_CMD
.
c§
;

1144  
agp
;

1145 
	}
}

	@arch/alpha/kernel/core_mcpcia.c

9 
	#__EXTERN_INLINE
 
ölöe


	)

10 
	~<asm/io.h
>

11 
	~<asm/c‹e_m˝cü.h
>

12 #unde‡
__EXTERN_INLINE


14 
	~<löux/ty≥s.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/dñay.h
>

20 
	~<asm/±ø˚.h
>

22 
	~"¥Ÿo.h
"

23 
	~"pci_im∂.h
"

35 
	#DEBUG_CFG
 0

	)

37 #i‡
DEBUG_CFG


38 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

40 
	#DBG_CFG
(
¨gs
)

	)

86 
	$c⁄f_ªad
(
addr
, 
ty≥1
,

87 
pci_c⁄åﬁÀr
 *
ho£
)

89 
Êags
;

90 
mid
 = 
	`MCPCIA_HOSE2MID
(
ho£
->
ödex
);

91 
°©0
, 
vÆue
, 
ãmp
, 
˝u
;

93 
˝u
 = 
	`smp_¥o˚ss‹_id
();

95 
	`loˇl_úq_ßve
(
Êags
);

97 
	`DBG_CFG
(("conf_read(addr=0x%lx,Åype1=%d, hose=%d)\n",

98 
addr
, 
ty≥1
, 
mid
));

101 
°©0
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

102 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
Ë
°©0
;

103 
	`mb
();

104 
ãmp
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

105 
	`DBG_CFG
(("c⁄f_ªad: MCPCIA_CAP_ERR(%dËwa†0x%x\n", 
mid
, 
°©0
));

107 
	`mb
();

108 
	`døöa
();

109 
	`mcheck_ex≥˘ed
(
˝u
) = 1;

110 
	`mcheck_èkí
(
˝u
) = 0;

111 
	`mcheck_exåa
(
˝u
Ë
mid
;

112 
	`mb
();

115 
vÆue
 = *((
vuù
)
addr
);

116 
	`mb
();

117 
	`mb
();

119 i‡(
	`mcheck_èkí
(
˝u
)) {

120 
	`mcheck_èkí
(
˝u
) = 0;

121 
vÆue
 = 0xffffffffU;

122 
	`mb
();

124 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

125 
	`mb
();

127 
	`DBG_CFG
(("conf_read(): finished\n"));

129 
	`loˇl_úq_ª°‹e
(
Êags
);

130  
vÆue
;

131 
	}
}

134 
	$c⁄f_wrôe
(
addr
, 
vÆue
, 
ty≥1
,

135 
pci_c⁄åﬁÀr
 *
ho£
)

137 
Êags
;

138 
mid
 = 
	`MCPCIA_HOSE2MID
(
ho£
->
ödex
);

139 
°©0
, 
ãmp
, 
˝u
;

141 
˝u
 = 
	`smp_¥o˚ss‹_id
();

143 
	`loˇl_úq_ßve
(
Êags
);

146 
°©0
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

147 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
Ë
°©0
; 
	`mb
();

148 
ãmp
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

149 
	`DBG_CFG
(("c⁄f_wrôe: MCPCIA CAP_ERR(%dËwa†0x%x\n", 
mid
, 
°©0
));

151 
	`døöa
();

152 
	`mcheck_ex≥˘ed
(
˝u
) = 1;

153 
	`mcheck_exåa
(
˝u
Ë
mid
;

154 
	`mb
();

157 *((
vuù
)
addr
Ë
vÆue
;

158 
	`mb
();

159 
	`mb
();

160 
ãmp
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

161 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

162 
	`mb
();

164 
	`DBG_CFG
(("conf_write(): finished\n"));

165 
	`loˇl_úq_ª°‹e
(
Êags
);

166 
	}
}

169 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
dev‚
, 
whîe
,

170 
pci_c⁄åﬁÀr
 *
ho£
, *
pci_addr
,

171 *
ty≥1
)

173 
u8
 
bus
 = 
pbus
->
numbî
;

174 
addr
;

176 
	`DBG_CFG
(("mk_conf_addr(bus=%d,devfn=0x%x,hose=%d,where=0x%x,"

178 
bus
, 
dev‚
, 
ho£
->
ödex
, 
whîe
, 
pci_addr
, 
ty≥1
));

181 *
ty≥1
 = 1;

183 i‡(!
pbus
->
∑ª¡
)

184 
bus
 = 0;

185 
addr
 = (
bus
 << 16Ë| (
dev‚
 << 8Ë| (
whîe
);

186 
addr
 <<= 5;

187 
addr
 |
ho£
->
c⁄fig_•a˚_ba£
;

189 *
pci_addr
 = 
addr
;

190 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

192 
	}
}

195 
	$m˝cü_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

196 
size
, 
u32
 *
vÆue
)

198 
pci_c⁄åﬁÀr
 *
ho£
 = 
bus
->
sysd©a
;

199 
addr
, 
w
;

200 
ty≥1
;

202 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, 
ho£
, &
addr
, &
ty≥1
))

203  
PCIBIOS_DEVICE_NOT_FOUND
;

205 
addr
 |(
size
 - 1) * 8;

206 
w
 = 
	`c⁄f_ªad
(
addr
, 
ty≥1
, 
ho£
);

207 
size
) {

209 *
vÆue
 = 
	`__kî√l_extbl
(
w
, 
whîe
 & 3);

212 *
vÆue
 = 
	`__kî√l_extwl
(
w
, 
whîe
 & 3);

215 *
vÆue
 = 
w
;

218  
PCIBIOS_SUCCESSFUL
;

219 
	}
}

222 
	$m˝cü_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

223 
size
, 
u32
 
vÆue
)

225 
pci_c⁄åﬁÀr
 *
ho£
 = 
bus
->
sysd©a
;

226 
addr
;

227 
ty≥1
;

229 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, 
ho£
, &
addr
, &
ty≥1
))

230  
PCIBIOS_DEVICE_NOT_FOUND
;

232 
addr
 |(
size
 - 1) * 8;

233 
vÆue
 = 
	`__kî√l_ösql
(vÆue, 
whîe
 & 3);

234 
	`c⁄f_wrôe
(
addr
, 
vÆue
, 
ty≥1
, 
ho£
);

235  
PCIBIOS_SUCCESSFUL
;

236 
	}
}

238 
pci_›s
 
	gm˝cü_pci_›s
 =

240 .
ªad
 = 
m˝cü_ªad_c⁄fig
,

241 .
	gwrôe
 = 
m˝cü_wrôe_c⁄fig
,

245 
	$m˝cü_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

247 
	`wmb
();

248 *(
vuù
)
	`MCPCIA_SG_TBIA
(
	`MCPCIA_HOSE2MID
(
ho£
->
ödex
)) = 0;

249 
	`mb
();

250 
	}
}

252 
__öô


253 
	$m˝cü_¥obe_ho£
(
h
)

255 
˝u
 = 
	`smp_¥o˚ss‹_id
();

256 
mid
 = 
	`MCPCIA_HOSE2MID
(
h
);

257 
pci_ªv
;

261 
	`mb
();

262 
	`mb
();

263 
	`døöa
();

264 
	`wrm˚s
(7);

266 
	`mcheck_ex≥˘ed
(
˝u
) = 2;

267 
	`mcheck_èkí
(
˝u
) = 0;

268 
	`mcheck_exåa
(
˝u
Ë
mid
;

269 
	`mb
();

272 
pci_ªv
 = *(
vuù
)
	`MCPCIA_REV
(
mid
);

274 
	`mb
();

275 
	`mb
();

276 i‡(
	`mcheck_èkí
(
˝u
)) {

277 
	`mcheck_èkí
(
˝u
) = 0;

278 
pci_ªv
 = 0xffffffff;

279 
	`mb
();

281 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

282 
	`mb
();

284  (
pci_ªv
 >> 16Ë=
PCI_CLASS_BRIDGE_HOST
;

285 
	}
}

287 
__öô


288 
	$m˝cü_√w_ho£
(
h
)

290 
pci_c⁄åﬁÀr
 *
ho£
;

291 
ªsour˚
 *
io
, *
mem
, *
h´_mem
;

292 
mid
 = 
	`MCPCIA_HOSE2MID
(
h
);

294 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

295 i‡(
h
 == 0)

296 
pci_iß_ho£
 = 
ho£
;

297 
io
 = 
	`Æloc_ªsour˚
();

298 
mem
 = 
	`Æloc_ªsour˚
();

299 
h´_mem
 = 
	`Æloc_ªsour˚
();

301 
ho£
->
io_•a˚
 = 
io
;

302 
ho£
->
mem_•a˚
 = 
h´_mem
;

303 
ho£
->
•¨£_mem_ba£
 = 
	`MCPCIA_SPARSE
(
mid
Ë- 
IDENT_ADDR
;

304 
ho£
->
dí£_mem_ba£
 = 
	`MCPCIA_DENSE
(
mid
Ë- 
IDENT_ADDR
;

305 
ho£
->
•¨£_io_ba£
 = 
	`MCPCIA_IO
(
mid
Ë- 
IDENT_ADDR
;

306 
ho£
->
dí£_io_ba£
 = 0;

307 
ho£
->
c⁄fig_•a˚_ba£
 = 
	`MCPCIA_CONF
(
mid
);

308 
ho£
->
ödex
 = 
h
;

310 
io
->
°¨t
 = 
	`MCPCIA_IO
(
mid
Ë- 
MCPCIA_IO_BIAS
;

311 
io
->
íd
 = io->
°¨t
 + 0xffff;

312 
io
->
«me
 = 
pci_io_«mes
[
h
];

313 
io
->
Êags
 = 
IORESOURCE_IO
;

315 
mem
->
°¨t
 = 
	`MCPCIA_DENSE
(
mid
Ë- 
MCPCIA_MEM_BIAS
;

316 
mem
->
íd
 = mem->
°¨t
 + 0xffffffff;

317 
mem
->
«me
 = 
pci_mem_«mes
[
h
];

318 
mem
->
Êags
 = 
IORESOURCE_MEM
;

320 
h´_mem
->
°¨t
 = 
mem
->start;

321 
h´_mem
->
íd
 = 
mem
->
°¨t
 + 
MCPCIA_MEM_MASK
;

322 
h´_mem
->
«me
 = 
pci_h´0_«me
;

323 
h´_mem
->
Êags
 = 
IORESOURCE_MEM
;

325 i‡(
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
io
) < 0)

326 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° IO o¿ho£ %d\n", 
h
);

327 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
mem
) < 0)

328 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° MEM o¿ho£ %d\n", 
h
);

329 i‡(
	`ªque°_ªsour˚
(
mem
, 
h´_mem
) < 0)

330 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° HAE_MEM o¿ho£ %d\n", 
h
);

331 
	}
}

334 
	$m˝cü_pci_˛r_îr
(
mid
)

336 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

337 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
) = 0xffffffff;

338 
	`mb
();

339 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

340 
	}
}

342 
__öô


343 
	$m˝cü_°¨tup_ho£
(
pci_c⁄åﬁÀr
 *
ho£
)

345 
mid
 = 
	`MCPCIA_HOSE2MID
(
ho£
->
ödex
);

346 
tmp
;

348 
	`m˝cü_pci_˛r_îr
(
mid
);

353 
tmp
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

354 
tmp
 |= 0x0006;

355 *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
Ë
tmp
;

356 
	`mb
();

357 
tmp
 = *(
vuù
)
	`MCPCIA_CAP_ERR
(
mid
);

366 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

367 
ho£
->
sg_pci
 = 
	`iommu_¨ía_√w
(hose, 0x40000000,

368 
	`size_f‹_mem‹y
(0x40000000), 0);

370 
__dúe˘_m≠_ba£
 = 0x80000000;

371 
__dúe˘_m≠_size
 = 0x80000000;

373 *(
vuù
)
	`MCPCIA_W0_BASE
(
mid
Ë
ho£
->
sg_iß
->
dma_ba£
 | 3;

374 *(
vuù
)
	`MCPCIA_W0_MASK
(
mid
Ë(
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

375 *(
vuù
)
	`MCPCIA_T0_BASE
(
mid
Ë
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
) >> 8;

377 *(
vuù
)
	`MCPCIA_W1_BASE
(
mid
Ë
ho£
->
sg_pci
->
dma_ba£
 | 3;

378 *(
vuù
)
	`MCPCIA_W1_MASK
(
mid
Ë(
ho£
->
sg_pci
->
size
 - 1) & 0xfff00000;

379 *(
vuù
)
	`MCPCIA_T1_BASE
(
mid
Ë
	`vút_to_phys
(
ho£
->
sg_pci
->
±es
) >> 8;

381 *(
vuù
)
	`MCPCIA_W2_BASE
(
mid
Ë
__dúe˘_m≠_ba£
 | 1;

382 *(
vuù
)
	`MCPCIA_W2_MASK
(
mid
Ë(
__dúe˘_m≠_size
 - 1) & 0xfff00000;

383 *(
vuù
)
	`MCPCIA_T2_BASE
(
mid
) = 0;

385 *(
vuù
)
	`MCPCIA_W3_BASE
(
mid
) = 0x0;

387 
	`m˝cü_pci_tbi
(
ho£
, 0, -1);

389 *(
vuù
)
	`MCPCIA_HBASE
(
mid
) = 0x0;

390 
	`mb
();

392 *(
vuù
)
	`MCPCIA_HAE_MEM
(
mid
) = 0U;

393 
	`mb
();

394 *(
vuù
)
	`MCPCIA_HAE_MEM
(
mid
);

395 *(
vuù
)
	`MCPCIA_HAE_IO
(
mid
) = 0;

396 
	`mb
();

397 *(
vuù
)
	`MCPCIA_HAE_IO
(
mid
);

398 
	}
}

400 
__öô


401 
	$m˝cü_öô_¨ch
()

404 
i›‹t_ªsour˚
.
íd
 = ~0UL;

411 
	`m˝cü_√w_ho£
(0);

412 
	}
}

417 
__öô


418 
	$m˝cü_öô_ho£s
()

420 
pci_c⁄åﬁÀr
 *
ho£
;

421 
ho£_cou¡
;

422 
h
;

425 
ho£_cou¡
 = 0;

426 
h
 = 0; h < 
MCPCIA_MAX_HOSES
; ++h) {

427 i‡(
	`m˝cü_¥obe_ho£
(
h
)) {

428 i‡(
h
 != 0)

429 
	`m˝cü_√w_ho£
(
h
);

430 
ho£_cou¡
++;

434 
	`¥ötk
("m˝cü_öô_ho£s: found %d ho£s\n", 
ho£_cou¡
);

437 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

438 
	`m˝cü_°¨tup_ho£
(
ho£
);

439 
	}
}

442 
	$m˝cü_¥öt_unc‹ª˘abÀ
(
ñ_MCPCIA_unc‹ª˘ed_‰ame_mcheck
 *
logout
)

444 
ñ_comm⁄_EV5_unc‹ª˘abÀ_mcheck
 *
‰ame
;

445 
i
;

447 
‰ame
 = &
logout
->
¥ocd©a
;

450 
i
 = 0; i < 24; i += 2) {

451 
	`¥ötk
("Öaltmp[%d-%d] = %16lx %16lx\n",

452 
i
, i+1, 
‰ame
->
∑…emp
[i], frame->paltemp[i+1]);

454 
i
 = 0; i < 8; i += 2) {

455 
	`¥ötk
(" shadow[%d-%d] = %16lx %16lx\n",

456 
i
, i+1, 
‰ame
->
shadow
[i],

457 
‰ame
->
shadow
[
i
+1]);

459 
	`¥ötk
(" Addr ofÉxcepting instruction = %16lx\n",

460 
‰ame
->
exc_addr
);

461 
	`¥ötk
(" Summary ofárithmeticÅraps = %16lx\n",

462 
‰ame
->
exc_sum
);

463 
	`¥ötk
(" Exception mask = %16lx\n",

464 
‰ame
->
exc_mask
);

465 
	`¥ötk
(" Baseáddress for PALcode = %16lx\n",

466 
‰ame
->
∑l_ba£
);

467 
	`¥ötk
(" Interrupt Status Reg = %16lx\n",

468 
‰ame
->
i§
);

469 
	`¥ötk
(" CURRENT SETUP OF EV5 IBOX = %16lx\n",

470 
‰ame
->
ic§
);

471 
	`¥ötk
(" I-CACHE Reg %sÖarityÉrror = %16lx\n",

472 (
‰ame
->
ic_≥º_°©
 & 0x800L) ?

474 
‰ame
->
ic_≥º_°©
);

475 
	`¥ötk
(" D-CACHEÉrror Reg = %16lx\n",

476 
‰ame
->
dc_≥º_°©
);

477 i‡(
‰ame
->
dc_≥º_°©
 & 0x2) {

478 
‰ame
->
dc_≥º_°©
 & 0x03c) {

480 
	`¥ötk
(" DataÉrror in bank 1\n");

483 
	`¥ötk
(" DataÉrror in bank 0\n");

486 
	`¥ötk
(" TagÉrror in bank 1\n");

489 
	`¥ötk
(" TagÉrror in bank 0\n");

493 
	`¥ötk
(" Effective VA = %16lx\n",

494 
‰ame
->
va
);

495 
	`¥ötk
(" Reason for D-stream = %16lx\n",

496 
‰ame
->
mm_°©
);

497 
	`¥ötk
(" EV5 SCacheáddress = %16lx\n",

498 
‰ame
->
sc_addr
);

499 
	`¥ötk
(" EV5 SCache TAG/DataÖarity = %16lx\n",

500 
‰ame
->
sc_°©
);

501 
	`¥ötk
(" EV5 BC_TAG_ADDR = %16lx\n",

502 
‰ame
->
bc_èg_addr
);

503 
	`¥ötk
(" EV5 EI_ADDR: Physáddr of Xfer = %16lx\n",

504 
‰ame
->
ei_addr
);

505 
	`¥ötk
(" Fill Syndrome = %16lx\n",

506 
‰ame
->
fûl_syndrome
);

507 
	`¥ötk
(" EI_STATÑeg = %16lx\n",

508 
‰ame
->
ei_°©
);

509 
	`¥ötk
(" LD_LOCK = %16lx\n",

510 
‰ame
->
ld_lock
);

511 
	}
}

514 
	$m˝cü_¥öt_sy°em_¨ó
(
œ_±r
)

516 
ñ_comm⁄
 *
‰ame
;

517 
pci_c⁄åﬁÀr
 *
ho£
;

519 
	sIOD_sub∑ckë
 {

520 
ba£
;

521 
whﬂmi
;

522 
rsvd1
;

523 
pci_ªv
;

524 
ˇp_˘æ
;

525 
h´_mem
;

526 
h´_io
;

527 
öt_˘l
;

528 
öt_ªg
;

529 
öt_mask0
;

530 
öt_mask1
;

531 
mc_îr0
;

532 
mc_îr1
;

533 
ˇp_îr
;

534 
rsvd2
;

535 
pci_îr1
;

536 
md∑_°©
;

537 
md∑_syn
;

538 
mdpb_°©
;

539 
mdpb_syn
;

540 
rsvd3
;

541 
rsvd4
;

542 
rsvd5
;

543 } *
iodµ
;

545 
‰ame
 = (
ñ_comm⁄
 *)
œ_±r
;

546 
iodµ
 = (
IOD_sub∑ckë
 *Ë(
œ_±r
 + 
‰ame
->
sys_off£t
);

548 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
, 
iodµ
++) {

550 
	`¥ötk
("IOD %d Register Subpacket - Bridge Base Address %16lx\n",

551 
ho£
->
ödex
, 
iodµ
->
ba£
);

552 
	`¥ötk
(" WHOAMI = %8x\n", 
iodµ
->
whﬂmi
);

553 
	`¥ötk
(" PCI_REV = %8x\n", 
iodµ
->
pci_ªv
);

554 
	`¥ötk
(" CAP_CTRL = %8x\n", 
iodµ
->
ˇp_˘æ
);

555 
	`¥ötk
(" HAE_MEM = %8x\n", 
iodµ
->
h´_mem
);

556 
	`¥ötk
(" HAE_IO = %8x\n", 
iodµ
->
h´_io
);

557 
	`¥ötk
(" INT_CTL = %8x\n", 
iodµ
->
öt_˘l
);

558 
	`¥ötk
(" INT_REG = %8x\n", 
iodµ
->
öt_ªg
);

559 
	`¥ötk
(" INT_MASK0 = %8x\n", 
iodµ
->
öt_mask0
);

560 
	`¥ötk
(" INT_MASK1 = %8x\n", 
iodµ
->
öt_mask1
);

561 
	`¥ötk
(" MC_ERR0 = %8x\n", 
iodµ
->
mc_îr0
);

562 
	`¥ötk
(" MC_ERR1 = %8x\n", 
iodµ
->
mc_îr1
);

563 
	`¥ötk
(" CAP_ERR = %8x\n", 
iodµ
->
ˇp_îr
);

564 
	`¥ötk
(" PCI_ERR1 = %8x\n", 
iodµ
->
pci_îr1
);

565 
	`¥ötk
(" MDPA_STAT = %8x\n", 
iodµ
->
md∑_°©
);

566 
	`¥ötk
(" MDPA_SYN = %8x\n", 
iodµ
->
md∑_syn
);

567 
	`¥ötk
(" MDPB_STAT = %8x\n", 
iodµ
->
mdpb_°©
);

568 
	`¥ötk
(" MDPB_SYN = %8x\n", 
iodµ
->
mdpb_syn
);

570 
	}
}

573 
	$m˝cü_machöe_check
(
ve˘‹
, 
œ_±r
)

575 
ñ_comm⁄
 *
mchk_hódî
;

576 
ñ_MCPCIA_unc‹ª˘ed_‰ame_mcheck
 *
mchk_logout
;

577 
˝u
 = 
	`smp_¥o˚ss‹_id
();

578 
ex≥˘ed
;

580 
mchk_hódî
 = (
ñ_comm⁄
 *)
œ_±r
;

581 
mchk_logout
 = (
ñ_MCPCIA_unc‹ª˘ed_‰ame_mcheck
 *)
œ_±r
;

582 
ex≥˘ed
 = 
	`mcheck_ex≥˘ed
(
˝u
);

584 
	`mb
();

585 
	`mb
();

586 
	`døöa
();

588 
ex≥˘ed
) {

593 
pci_c⁄åﬁÀr
 *
ho£
;

594 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

595 
	`m˝cü_pci_˛r_îr
(
	`MCPCIA_HOSE2MID
(
ho£
->
ödex
));

599 
	`m˝cü_pci_˛r_îr
(
	`mcheck_exåa
(
˝u
));

607 
	`wrm˚s
(0x7);

608 
	`mb
();

610 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "MCPCIA", 
ex≥˘ed
 != 0);

611 i‡(!
ex≥˘ed
 && 
ve˘‹
 != 0x620 && vector != 0x630) {

612 
	`m˝cü_¥öt_unc‹ª˘abÀ
(
mchk_logout
);

613 
	`m˝cü_¥öt_sy°em_¨ó
(
œ_±r
);

615 
	}
}

	@arch/alpha/kernel/core_polaris.c

7 
	#__EXTERN_INLINE
 
ölöe


	)

8 
	~<asm/io.h
>

9 
	~<asm/c‹e_pﬁ¨is.h
>

10 #unde‡
__EXTERN_INLINE


12 
	~<löux/ty≥s.h
>

13 
	~<löux/pci.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/öô.h
>

17 
	~<asm/±ø˚.h
>

19 
	~"¥Ÿo.h
"

20 
	~"pci_im∂.h
"

26 
	#DEBUG_CONFIG
 0

	)

28 #i‡
DEBUG_CONFIG


29 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

31 
	#DBG_CFG
(
¨gs
)

	)

66 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

67 *
pci_addr
, 
u8
 *
ty≥1
)

69 
u8
 
bus
 = 
pbus
->
numbî
;

71 *
ty≥1
 = (
bus
 == 0) ? 0 : 1;

72 *
pci_addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| (
whîe
) |

73 
POLARIS_DENSE_CONFIG_BASE
;

75 
	`DBG_CFG
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x,"

77 
bus
, 
devi˚_‚
, 
whîe
, *
pci_addr
));

80 
	}
}

83 
	$pﬁ¨is_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

84 
size
, 
u32
 *
vÆue
)

86 
addr
;

87 
ty≥1
;

89 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

90  
PCIBIOS_DEVICE_NOT_FOUND
;

92 
size
) {

94 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

97 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

100 *
vÆue
 = *(
vuù
)
addr
;

104  
PCIBIOS_SUCCESSFUL
;

105 
	}
}

109 
	$pﬁ¨is_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

110 
size
, 
u32
 
vÆue
)

112 
addr
;

113 
ty≥1
;

115 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

116  
PCIBIOS_DEVICE_NOT_FOUND
;

118 
size
) {

120 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

121 
	`mb
();

122 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

125 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

126 
	`mb
();

127 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

130 *(
vuù
)
addr
 = 
vÆue
;

131 
	`mb
();

132 *(
vuù
)
addr
;

136  
PCIBIOS_SUCCESSFUL
;

137 
	}
}

139 
pci_›s
 
	gpﬁ¨is_pci_›s
 =

141 .
ªad
 = 
pﬁ¨is_ªad_c⁄fig
,

142 .
	gwrôe
 = 
pﬁ¨is_wrôe_c⁄fig
,

145 
__öô


146 
	$pﬁ¨is_öô_¨ch
()

148 
pci_c⁄åﬁÀr
 *
ho£
;

155 
	`¥ötk
("polaris_init_arch():Årusting firmware for setup\n");

162 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

163 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

164 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

165 
ho£
->
ödex
 = 0;

167 
ho£
->
•¨£_mem_ba£
 = 0;

168 
ho£
->
dí£_mem_ba£
 = 
POLARIS_DENSE_MEM_BASE
 - 
IDENT_ADDR
;

169 
ho£
->
•¨£_io_ba£
 = 0;

170 
ho£
->
dí£_io_ba£
 = 
POLARIS_DENSE_IO_BASE
 - 
IDENT_ADDR
;

172 
ho£
->
sg_iß
 = ho£->
sg_pci
 = 
NULL
;

175 
__dúe˘_m≠_ba£
 = 0x80000000;

176 
__dúe˘_m≠_size
 = 0x80000000;

177 
	}
}

179 
ölöe
 

180 
	$pﬁ¨is_pci_˛r_îr
()

182 *(
vu•
)
POLARIS_W_STATUS
;

184 *(
vu•
)
POLARIS_W_STATUS
 = 0x7800;

185 
	`mb
();

186 *(
vu•
)
POLARIS_W_STATUS
;

187 
	}
}

190 
	$pﬁ¨is_machöe_check
(
ve˘‹
, 
œ_±r
)

193 
	`mb
();

194 
	`mb
();

195 
	`døöa
();

196 
	`pﬁ¨is_pci_˛r_îr
();

197 
	`wrm˚s
(0x7);

198 
	`mb
();

200 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "POLARIS",

201 
	`mcheck_ex≥˘ed
(0));

202 
	}
}

	@arch/alpha/kernel/core_t2.c

12 
	#__EXTERN_INLINE


	)

13 
	~<asm/io.h
>

14 
	~<asm/c‹e_t2.h
>

15 #unde‡
__EXTERN_INLINE


17 
	~<löux/ty≥s.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/öô.h
>

22 
	~<asm/±ø˚.h
>

23 
	~<asm/dñay.h
>

25 
	~"¥Ÿo.h
"

26 
	~"pci_im∂.h
"

29 
	#DEBUG_PRINT_INITIAL_SETTINGS
 0

	)

32 
	#DEBUG_PRINT_FINAL_SETTINGS
 0

	)

45 
	#T2_DIRECTMAP_2G
 1

	)

47 #i‡
T2_DIRECTMAP_2G


48 
	#T2_DIRECTMAP_START
 0x80000000UL

	)

49 
	#T2_DIRECTMAP_LENGTH
 0x80000000UL

	)

51 
	#T2_DIRECTMAP_START
 0x40000000UL

	)

52 
	#T2_DIRECTMAP_LENGTH
 0x40000000UL

	)

56 
	#T2_ISA_SG_START
 0x00800000UL

	)

57 
	#T2_ISA_SG_LENGTH
 0x00800000UL

	)

69 
	#DEBUG_CONFIG
 0

	)

71 #i‡
DEBUG_CONFIG


72 
	#DBG
(
¨gs
Ë
¥ötk
 
	)
args

74 
	#DBG
(
¨gs
)

	)

77 vﬁ©ûê
	gt2_mcheck_™y_ex≥˘ed
;

78 vﬁ©ûê
	gt2_mcheck_œ°_èkí
;

85 
	mwba£
;

86 
	mwmask
;

87 
	mtba£
;

88 } 
	mwödow
[2];

89 
	mh´_1
;

90 
	mh´_2
;

91 
	mh´_3
;

92 
	mh´_4
;

93 
	mhba£
;

94 } 
t2_ßved_c⁄fig
 
__©åibuã
((
comm⁄
));

139 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

140 *
pci_addr
, *
ty≥1
)

142 
addr
;

143 
u8
 
bus
 = 
pbus
->
numbî
;

145 
	`DBG
(("mk_conf_addr(bus=%d, dfn=0x%x, where=0x%x,"

147 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

149 i‡(
bus
 == 0) {

150 
devi˚
 = 
devi˚_‚
 >> 3;

154 i‡(
devi˚
 > 8) {

155 
	`DBG
(("mk_conf_addr: device (%d)>20,Ñeturning -1\n",

156 
devi˚
));

160 *
ty≥1
 = 0;

161 
addr
 = (0x0800L << 
devi˚
Ë| ((
devi˚_‚
 & 7Ë<< 8Ë| (
whîe
);

164 *
ty≥1
 = 1;

165 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| (
whîe
);

167 *
pci_addr
 = 
addr
;

168 
	`DBG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

170 
	}
}

179 
	$c⁄f_ªad
(
addr
, 
ty≥1
)

181 
vÆue
, 
˝u
, 
èkí
;

182 
t2_cfg
 = 0;

184 
˝u
 = 
	`smp_¥o˚ss‹_id
();

186 
	`DBG
(("c⁄f_ªad◊ddr=0x%lx,Åy≥1=%d)\n", 
addr
, 
ty≥1
));

189 i‡(
ty≥1
) {

190 
t2_cfg
 = *(
vuÕ
)
T2_HAE_3
 & ~0xc0000000UL;

191 *(
vuÕ
)
T2_HAE_3
 = 0x40000000UL | 
t2_cfg
;

192 
	`mb
();

194 
	`mb
();

195 
	`døöa
();

197 
	`mcheck_ex≥˘ed
(
˝u
) = 1;

198 
	`mcheck_èkí
(
˝u
) = 0;

199 
t2_mcheck_™y_ex≥˘ed
 |(1 << 
˝u
);

200 
	`mb
();

203 
vÆue
 = *(
vuù
)
addr
;

204 
	`mb
();

205 
	`mb
();

211 
	`udñay
(100);

213 i‡((
èkí
 = 
	`mcheck_èkí
(
˝u
))) {

214 
	`mcheck_èkí
(
˝u
) = 0;

215 
t2_mcheck_œ°_èkí
 |(1 << 
˝u
);

216 
vÆue
 = 0xffffffffU;

217 
	`mb
();

219 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

220 
t2_mcheck_™y_ex≥˘ed
 = 0;

221 
	`mb
();

224 i‡(
ty≥1
) {

225 *(
vuÕ
)
T2_HAE_3
 = 
t2_cfg
;

226 
	`mb
();

229  
vÆue
;

230 
	}
}

233 
	$c⁄f_wrôe
(
addr
, 
vÆue
, 
ty≥1
)

235 
˝u
, 
èkí
;

236 
t2_cfg
 = 0;

238 
˝u
 = 
	`smp_¥o˚ss‹_id
();

241 i‡(
ty≥1
) {

242 
t2_cfg
 = *(
vuÕ
)
T2_HAE_3
 & ~0xc0000000UL;

243 *(
vuÕ
)
T2_HAE_3
 = 
t2_cfg
 | 0x40000000UL;

244 
	`mb
();

246 
	`mb
();

247 
	`døöa
();

249 
	`mcheck_ex≥˘ed
(
˝u
) = 1;

250 
	`mcheck_èkí
(
˝u
) = 0;

251 
t2_mcheck_™y_ex≥˘ed
 |(1 << 
˝u
);

252 
	`mb
();

255 *(
vuù
)
addr
 = 
vÆue
;

256 
	`mb
();

257 
	`mb
();

263 
	`udñay
(100);

265 i‡((
èkí
 = 
	`mcheck_èkí
(
˝u
))) {

266 
	`mcheck_èkí
(
˝u
) = 0;

267 
t2_mcheck_œ°_èkí
 |(1 << 
˝u
);

268 
	`mb
();

270 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

271 
t2_mcheck_™y_ex≥˘ed
 = 0;

272 
	`mb
();

275 i‡(
ty≥1
) {

276 *(
vuÕ
)
T2_HAE_3
 = 
t2_cfg
;

277 
	`mb
();

279 
	}
}

282 
	$t2_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

283 
size
, 
u32
 *
vÆue
)

285 
addr
, 
pci_addr
;

286 
ty≥1
;

287 
shi·
;

288 
mask
;

290 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

291  
PCIBIOS_DEVICE_NOT_FOUND
;

293 
mask
 = (
size
 - 1) * 8;

294 
shi·
 = (
whîe
 & 3) * 8;

295 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
T2_CONF
;

296 *
vÆue
 = 
	`c⁄f_ªad
(
addr
, 
ty≥1
Ë>> (
shi·
);

297  
PCIBIOS_SUCCESSFUL
;

298 
	}
}

301 
	$t2_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
,

302 
u32
 
vÆue
)

304 
addr
, 
pci_addr
;

305 
ty≥1
;

306 
mask
;

308 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
pci_addr
, &
ty≥1
))

309  
PCIBIOS_DEVICE_NOT_FOUND
;

311 
mask
 = (
size
 - 1) * 8;

312 
addr
 = (
pci_addr
 << 5Ë+ 
mask
 + 
T2_CONF
;

313 
	`c⁄f_wrôe
(
addr
, 
vÆue
 << ((
whîe
 & 3Ë* 8), 
ty≥1
);

314  
PCIBIOS_SUCCESSFUL
;

315 
	}
}

317 
pci_›s
 
	gt2_pci_›s
 =

319 .
ªad
 = 
t2_ªad_c⁄fig
,

320 .
	gwrôe
 = 
t2_wrôe_c⁄fig
,

323 
__öô


324 
	$t2_dúe˘_m≠_wödow1
(
ba£
, 
Àngth
)

326 
ãmp
;

328 
__dúe˘_m≠_ba£
 = 
ba£
;

329 
__dúe˘_m≠_size
 = 
Àngth
;

331 
ãmp
 = (
ba£
 & 0xfff00000ULË| ((ba£ + 
Àngth
 - 1) >> 20);

332 *(
vuÕ
)
T2_WBASE1
 = 
ãmp
 | 0x80000UL;

333 
ãmp
 = (
Àngth
 - 1) & 0xfff00000UL;

334 *(
vuÕ
)
T2_WMASK1
 = 
ãmp
;

335 *(
vuÕ
)
T2_TBASE1
 = 0;

337 #i‡
DEBUG_PRINT_FINAL_SETTINGS


338 
	`¥ötk
("%s: setting WBASE1=0x%lx WMASK1=0x%lx TBASE1=0x%lx\n",

339 
__FUNCTION__
,

340 *(
vuÕ
)
T2_WBASE1
,

341 *(
vuÕ
)
T2_WMASK1
,

342 *(
vuÕ
)
T2_TBASE1
);

344 
	}
}

346 
__öô


347 
	$t2_sg_m≠_wödow2
(
pci_c⁄åﬁÀr
 *
ho£
,

348 
ba£
,

349 
Àngth
)

351 
ãmp
;

355 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(ho£, 
ba£
, 
Àngth
, 0);

356 
ho£
->
sg_pci
 = 
NULL
;

358 
ãmp
 = (
ba£
 & 0xfff00000ULË| ((ba£ + 
Àngth
 - 1) >> 20);

359 *(
vuÕ
)
T2_WBASE2
 = 
ãmp
 | 0xc0000UL;

360 
ãmp
 = (
Àngth
 - 1) & 0xfff00000UL;

361 *(
vuÕ
)
T2_WMASK2
 = 
ãmp
;

362 *(
vuÕ
)
T2_TBASE2
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
) >> 1;

363 
	`mb
();

365 
	`t2_pci_tbi
(
ho£
, 0, -1);

367 #i‡
DEBUG_PRINT_FINAL_SETTINGS


368 
	`¥ötk
("%s: setting WBASE2=0x%lx WMASK2=0x%lx TBASE2=0x%lx\n",

369 
__FUNCTION__
,

370 *(
vuÕ
)
T2_WBASE2
,

371 *(
vuÕ
)
T2_WMASK2
,

372 *(
vuÕ
)
T2_TBASE2
);

374 
	}
}

376 
__öô


377 
	$t2_ßve_c⁄figuøti⁄
()

379 #i‡
DEBUG_PRINT_INITIAL_SETTINGS


380 
	`¥ötk
("%s: HAE_1 wa†0x%lx\n", 
__FUNCTION__
, 
§m_h´
);

381 
	`¥ötk
("%s: HAE_2 wa†0x%lx\n", 
__FUNCTION__
, *(
vuÕ
)
T2_HAE_2
);

382 
	`¥ötk
("%s: HAE_3 wa†0x%lx\n", 
__FUNCTION__
, *(
vuÕ
)
T2_HAE_3
);

383 
	`¥ötk
("%s: HAE_4 wa†0x%lx\n", 
__FUNCTION__
, *(
vuÕ
)
T2_HAE_4
);

384 
	`¥ötk
("%s: HBASE wa†0x%lx\n", 
__FUNCTION__
, *(
vuÕ
)
T2_HBASE
);

386 
	`¥ötk
("%s: WBASE1=0x%lx WMASK1=0x%lx TBASE1=0x%lx\n", 
__FUNCTION__
,

387 *(
vuÕ
)
T2_WBASE1
, *(vuÕ)
T2_WMASK1
, *(vuÕ)
T2_TBASE1
);

388 
	`¥ötk
("%s: WBASE2=0x%lx WMASK2=0x%lx TBASE2=0x%lx\n", 
__FUNCTION__
,

389 *(
vuÕ
)
T2_WBASE2
, *(vuÕ)
T2_WMASK2
, *(vuÕ)
T2_TBASE2
);

395 
t2_ßved_c⁄fig
.
wödow
[0].
wba£
 = *(
vuÕ
)
T2_WBASE1
;

396 
t2_ßved_c⁄fig
.
wödow
[0].
wmask
 = *(
vuÕ
)
T2_WMASK1
;

397 
t2_ßved_c⁄fig
.
wödow
[0].
tba£
 = *(
vuÕ
)
T2_TBASE1
;

398 
t2_ßved_c⁄fig
.
wödow
[1].
wba£
 = *(
vuÕ
)
T2_WBASE2
;

399 
t2_ßved_c⁄fig
.
wödow
[1].
wmask
 = *(
vuÕ
)
T2_WMASK2
;

400 
t2_ßved_c⁄fig
.
wödow
[1].
tba£
 = *(
vuÕ
)
T2_TBASE2
;

402 
t2_ßved_c⁄fig
.
h´_1
 = 
§m_h´
;

403 
t2_ßved_c⁄fig
.
h´_2
 = *(
vuÕ
)
T2_HAE_2
;

404 
t2_ßved_c⁄fig
.
h´_3
 = *(
vuÕ
)
T2_HAE_3
;

405 
t2_ßved_c⁄fig
.
h´_4
 = *(
vuÕ
)
T2_HAE_4
;

406 
t2_ßved_c⁄fig
.
hba£
 = *(
vuÕ
)
T2_HBASE
;

407 
	}
}

409 
__öô


410 
	$t2_öô_¨ch
()

412 
pci_c⁄åﬁÀr
 *
ho£
;

413 
ãmp
;

414 
i
;

416 
i
 = 0; i < 
NR_CPUS
; i++) {

417 
	`mcheck_ex≥˘ed
(
i
) = 0;

418 
	`mcheck_èkí
(
i
) = 0;

420 
t2_mcheck_™y_ex≥˘ed
 = 0;

421 
t2_mcheck_œ°_èkí
 = 0;

424 
ãmp
 = *(
vuÕ
)
T2_IOCSR
;

425 i‡(!(
ãmp
 & (0x1UL << 26))) {

426 
	`¥ötk
("t2_init_arch:Énabling SG TLB, IOCSR was 0x%lx\n",

427 
ãmp
);

428 *(
vuÕ
)
T2_IOCSR
 = 
ãmp
 | (0x1UL << 26);

429 
	`mb
();

430 *(
vuÕ
)
T2_IOCSR
;

433 
	`t2_ßve_c⁄figuøti⁄
();

438 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

439 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

440 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

441 
ho£
->
ödex
 = 0;

443 
ho£
->
•¨£_mem_ba£
 = 
T2_SPARSE_MEM
 - 
IDENT_ADDR
;

444 
ho£
->
dí£_mem_ba£
 = 
T2_DENSE_MEM
 - 
IDENT_ADDR
;

445 
ho£
->
•¨£_io_ba£
 = 
T2_IO
 - 
IDENT_ADDR
;

446 
ho£
->
dí£_io_ba£
 = 0;

455 
	`t2_dúe˘_m≠_wödow1
(
T2_DIRECTMAP_START
, 
T2_DIRECTMAP_LENGTH
);

458 
	`t2_sg_m≠_wödow2
(
ho£
, 
T2_ISA_SG_START
, 
T2_ISA_SG_LENGTH
);

460 *(
vuÕ
)
T2_HBASE
 = 0x0;

463 *(
vuÕ
)
T2_HAE_1
 = 0; 
	`mb
();

464 *(
vuÕ
)
T2_HAE_2
 = 0; 
	`mb
();

465 *(
vuÕ
)
T2_HAE_3
 = 0; 
	`mb
();

476 *(
vuÕ
)
T2_HAE_4
 = 0; 
	`mb
();

477 
	}
}

480 
	$t2_kûl_¨ch
(
mode
)

485 *(
vuÕ
)
T2_WBASE1
 = 
t2_ßved_c⁄fig
.
wödow
[0].
wba£
;

486 *(
vuÕ
)
T2_WMASK1
 = 
t2_ßved_c⁄fig
.
wödow
[0].
wmask
;

487 *(
vuÕ
)
T2_TBASE1
 = 
t2_ßved_c⁄fig
.
wödow
[0].
tba£
;

488 *(
vuÕ
)
T2_WBASE2
 = 
t2_ßved_c⁄fig
.
wödow
[1].
wba£
;

489 *(
vuÕ
)
T2_WMASK2
 = 
t2_ßved_c⁄fig
.
wödow
[1].
wmask
;

490 *(
vuÕ
)
T2_TBASE2
 = 
t2_ßved_c⁄fig
.
wödow
[1].
tba£
;

491 
	`mb
();

493 *(
vuÕ
)
T2_HAE_1
 = 
§m_h´
;

494 *(
vuÕ
)
T2_HAE_2
 = 
t2_ßved_c⁄fig
.
h´_2
;

495 *(
vuÕ
)
T2_HAE_3
 = 
t2_ßved_c⁄fig
.
h´_3
;

496 *(
vuÕ
)
T2_HAE_4
 = 
t2_ßved_c⁄fig
.
h´_4
;

497 *(
vuÕ
)
T2_HBASE
 = 
t2_ßved_c⁄fig
.
hba£
;

498 
	`mb
();

499 *(
vuÕ
)
T2_HBASE
;

500 
	}
}

503 
	$t2_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

505 
t2_ioc§
;

507 
t2_ioc§
 = *(
vuÕ
)
T2_IOCSR
;

510 *(
vuÕ
)
T2_IOCSR
 = 
t2_ioc§
 | (0x1UL << 28);

511 
	`mb
();

512 *(
vuÕ
)
T2_IOCSR
;

515 *(
vuÕ
)
T2_IOCSR
 = 
t2_ioc§
 & ~(0x1UL << 28);

516 
	`mb
();

517 *(
vuÕ
)
T2_IOCSR
;

518 
	}
}

520 
	#SIC_SEIC
 (1UL << 33Ë

	)

523 
	$t2_˛ór_îr‹s
(
˝u
)

525 
ßbÀ_˝u_c§
 *
˝u_ªgs
;

527 
˝u_ªgs
 = (
ßbÀ_˝u_c§
 *)
	`T2_CPUn_BASE
(
˝u
);

529 
˝u_ªgs
->
sic
 &~
SIC_SEIC
;

532 
˝u_ªgs
->
bc˚
 |= cpu_regs->bcce;

533 
˝u_ªgs
->
cbe
 |= cpu_regs->cbe;

534 
˝u_ªgs
->
bcue
 |= cpu_regs->bcue;

535 
˝u_ªgs
->
dãr
 |= cpu_regs->dter;

537 *(
vuÕ
)
T2_CERR1
 |= *(vulp)T2_CERR1;

538 *(
vuÕ
)
T2_PERR1
 |= *(vulp)T2_PERR1;

540 
	`mb
();

541 
	`mb
();

542 
	}
}

554 
	$t2_machöe_check
(
ve˘‹
, 
œ_±r
)

556 
˝u
 = 
	`smp_¥o˚ss‹_id
();

557 #ifde‡
CONFIG_VERBOSE_MCHECK


558 
ñ_comm⁄
 *
mchk_hódî
 = (ñ_comm⁄ *)
œ_±r
;

562 
	`mb
();

563 
	`mb
();

564 
	`døöa
();

565 
	`t2_˛ór_îr‹s
(
˝u
);

569 
	`wrm˚s
(0x7);

570 
	`mb
();

573 i‡(!
	`mcheck_ex≥˘ed
(
˝u
Ë&& 
t2_mcheck_™y_ex≥˘ed
) {

580 #ifde‡
CONFIG_VERBOSE_MCHECK


581 i‡(
Æpha_vîbo£_mcheck
 > 1) {

582 
	`¥ötk
("t2_machine_check(cpu%d):ány_expected 0x%x -"

584 " codê0x%x\n", 
˝u
, 
t2_mcheck_™y_ex≥˘ed
,

585 ()
mchk_hódî
->
code
);

591 i‡(!
	`mcheck_ex≥˘ed
(
˝u
Ë&& !
t2_mcheck_™y_ex≥˘ed
) {

592 i‡(
t2_mcheck_œ°_èkí
 & (1 << 
˝u
)) {

593 #ifde‡
CONFIG_VERBOSE_MCHECK


594 i‡(
Æpha_vîbo£_mcheck
 > 1) {

595 
	`¥ötk
("t2_machine_check(cpu%d):Üast_taken 0x%x - "

597 
˝u
, 
t2_mcheck_œ°_èkí
,

598 ()
mchk_hódî
->
code
);

601 
t2_mcheck_œ°_èkí
 = 0;

602 
	`mb
();

605 
t2_mcheck_œ°_èkí
 = 0;

606 
	`mb
();

610 #ifde‡
CONFIG_VERBOSE_MCHECK


611 i‡(
Æpha_vîbo£_mcheck
 > 1) {

612 
	`¥ötk
("%sÅ2_mcheck(cpu%d):Üast_taken 0x%x - "

614 (
	`mcheck_ex≥˘ed
(
˝u
) ? "EX" : "UN"), cpu,

615 
t2_mcheck_œ°_èkí
, 
t2_mcheck_™y_ex≥˘ed
,

616 ()
mchk_hódî
->
code
);

620 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "T2", 
	`mcheck_ex≥˘ed
(
˝u
));

621 
	}
}

	@arch/alpha/kernel/core_titan.c

7 
	#__EXTERN_INLINE
 
ölöe


	)

8 
	~<asm/io.h
>

9 
	~<asm/c‹e_tô™.h
>

10 #unde‡
__EXTERN_INLINE


12 
	~<löux/moduÀ.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/pci.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/vmÆloc.h
>

18 
	~<löux/boŸmem.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/pgÆloc.h
>

23 
	~<asm/ébÊush.h
>

24 
	~<asm/vga.h
>

26 
	~"¥Ÿo.h
"

27 
	~"pci_im∂.h
"

33 
	mwsba
[4];

34 
	mwsm
[4];

35 
	mtba
[4];

36 } 
	gßved_c⁄fig
[4] 
__©åibuã__
((
comm⁄
));

41 
	gtô™_pchù1_¥e£¡
;

47 
	#DEBUG_CONFIG
 0

	)

49 #i‡
DEBUG_CONFIG


50 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

52 
	#DBG_CFG
(
¨gs
)

	)

59 
ölöe
 volatile *

60 
	$mk_tig_addr
(
off£t
)

62  (vﬁ©ûê*)(
TITAN_TIG_SPACE
 + (
off£t
 << 6));

63 
	}
}

65 
ölöe
 
u8


66 
	$tô™_ªad_tig
(
off£t
, 
u8
 
vÆue
)

68 vﬁ©ûê*
tig_addr
 = 
	`mk_tig_addr
(
off£t
);

69  (
u8
)(*
tig_addr
 & 0xff);

70 
	}
}

72 
ölöe
 

73 
	$tô™_wrôe_tig
(
off£t
, 
u8
 
vÆue
)

75 vﬁ©ûê*
tig_addr
 = 
	`mk_tig_addr
(
off£t
);

76 *
tig_addr
 = ()
vÆue
;

77 
	}
}

115 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

116 *
pci_addr
, *
ty≥1
)

118 
pci_c⁄åﬁÀr
 *
ho£
 = 
pbus
->
sysd©a
;

119 
addr
;

120 
u8
 
bus
 = 
pbus
->
numbî
;

122 
	`DBG_CFG
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, "

124 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

126 i‡(!
pbus
->
∑ª¡
)

127 
bus
 = 0;

128 *
ty≥1
 = (
bus
 != 0);

130 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

131 
addr
 |
ho£
->
c⁄fig_•a˚_ba£
;

133 *
pci_addr
 = 
addr
;

134 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

136 
	}
}

139 
	$tô™_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

140 
size
, 
u32
 *
vÆue
)

142 
addr
;

143 
ty≥1
;

145 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

146  
PCIBIOS_DEVICE_NOT_FOUND
;

148 
size
) {

150 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

153 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

156 *
vÆue
 = *(
vuù
)
addr
;

160  
PCIBIOS_SUCCESSFUL
;

161 
	}
}

164 
	$tô™_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

165 
size
, 
u32
 
vÆue
)

167 
addr
;

168 
ty≥1
;

170 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

171  
PCIBIOS_DEVICE_NOT_FOUND
;

173 
size
) {

175 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

176 
	`mb
();

177 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

180 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

181 
	`mb
();

182 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

185 *(
vuù
)
addr
 = 
vÆue
;

186 
	`mb
();

187 *(
vuù
)
addr
;

191  
PCIBIOS_SUCCESSFUL
;

192 
	}
}

194 
pci_›s
 
	gtô™_pci_›s
 =

196 .
ªad
 = 
tô™_ªad_c⁄fig
,

197 .
	gwrôe
 = 
tô™_wrôe_c⁄fig
,

202 
	$tô™_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

204 
tô™_∑chù
 *
∑chù
 =

205 (
ho£
->
ödex
 & 1Ë? 
TITAN_∑chù1
 : 
TITAN_∑chù0
;

206 
tô™_∑chù_p‹t
 *
p‹t
;

207 vﬁ©ûê*
c§
;

208 
vÆue
;

211 
p‹t
 = &
∑chù
->
g_p‹t
;

212 i‡(
ho£
->
ödex
 & 2)

213 
p‹t
 = &
∑chù
->
a_p‹t
;

220 
c§
 = &
p‹t
->
p‹t_•ecific
.
g
.
gébü
.csr;

221 i‡(((
°¨t
 ^ 
íd
) & 0xffff0000) == 0)

222 
c§
 = &
p‹t
->
p‹t_•ecific
.
g
.
gébiv
.csr;

226 
vÆue
 = (
°¨t
 & 0xffff0000) >> 12;

228 
	`wmb
();

229 *
c§
 = 
vÆue
;

230 
	`mb
();

231 *
c§
;

232 
	}
}

235 
	$tô™_quîy_agp
(
tô™_∑chù_p‹t
 *
p‹t
)

237 
TPAchùPCTL
 
p˘l
;

240 
p˘l
.
p˘l_q_whﬁe
 = 
p‹t
->p˘l.
c§
;

242  
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_¥e£¡
;

244 
	}
}

246 
__öô


247 
	$tô™_öô_⁄e_∑chù_p‹t
(
tô™_∑chù_p‹t
 *
p‹t
, 
ödex
)

249 
pci_c⁄åﬁÀr
 *
ho£
;

251 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

252 i‡(
ödex
 == 0)

253 
pci_iß_ho£
 = 
ho£
;

254 
ho£
->
io_•a˚
 = 
	`Æloc_ªsour˚
();

255 
ho£
->
mem_•a˚
 = 
	`Æloc_ªsour˚
();

264 
ho£
->
•¨£_mem_ba£
 = 0;

265 
ho£
->
•¨£_io_ba£
 = 0;

266 
ho£
->
dí£_mem_ba£


267 (
	`TITAN_MEM
(
ödex
) & 0xffffffffffUL) | 0x80000000000UL;

268 
ho£
->
dí£_io_ba£


269 (
	`TITAN_IO
(
ödex
) & 0xffffffffffUL) | 0x80000000000UL;

271 
ho£
->
c⁄fig_•a˚_ba£
 = 
	`TITAN_CONF
(
ödex
);

272 
ho£
->
ödex
 = index;

274 
ho£
->
io_•a˚
->
°¨t
 = 
	`TITAN_IO
(
ödex
Ë- 
TITAN_IO_BIAS
;

275 
ho£
->
io_•a˚
->
íd
 = ho£->io_•a˚->
°¨t
 + 
TITAN_IO_SPACE
 - 1;

276 
ho£
->
io_•a˚
->
«me
 = 
pci_io_«mes
[
ödex
];

277 
ho£
->
io_•a˚
->
Êags
 = 
IORESOURCE_IO
;

279 
ho£
->
mem_•a˚
->
°¨t
 = 
	`TITAN_MEM
(
ödex
Ë- 
TITAN_MEM_BIAS
;

280 
ho£
->
mem_•a˚
->
íd
 = ho£->mem_•a˚->
°¨t
 + 0xffffffff;

281 
ho£
->
mem_•a˚
->
«me
 = 
pci_mem_«mes
[
ödex
];

282 
ho£
->
mem_•a˚
->
Êags
 = 
IORESOURCE_MEM
;

284 i‡(
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
ho£
->
io_•a˚
) < 0)

285 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° IO o¿ho£ %d\n", 
ödex
);

286 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
ho£
->
mem_•a˚
) < 0)

287 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° MEM o¿ho£ %d\n", 
ödex
);

293 
ßved_c⁄fig
[
ödex
].
wsba
[0] = 
p‹t
->wsba[0].
c§
;

294 
ßved_c⁄fig
[
ödex
].
wsm
[0] = 
p‹t
->wsm[0].
c§
;

295 
ßved_c⁄fig
[
ödex
].
tba
[0] = 
p‹t
->tba[0].
c§
;

297 
ßved_c⁄fig
[
ödex
].
wsba
[1] = 
p‹t
->wsba[1].
c§
;

298 
ßved_c⁄fig
[
ödex
].
wsm
[1] = 
p‹t
->wsm[1].
c§
;

299 
ßved_c⁄fig
[
ödex
].
tba
[1] = 
p‹t
->tba[1].
c§
;

301 
ßved_c⁄fig
[
ödex
].
wsba
[2] = 
p‹t
->wsba[2].
c§
;

302 
ßved_c⁄fig
[
ödex
].
wsm
[2] = 
p‹t
->wsm[2].
c§
;

303 
ßved_c⁄fig
[
ödex
].
tba
[2] = 
p‹t
->tba[2].
c§
;

305 
ßved_c⁄fig
[
ödex
].
wsba
[3] = 
p‹t
->wsba[3].
c§
;

306 
ßved_c⁄fig
[
ödex
].
wsm
[3] = 
p‹t
->wsm[3].
c§
;

307 
ßved_c⁄fig
[
ödex
].
tba
[3] = 
p‹t
->tba[3].
c§
;

318 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

319 
ho£
->
sg_iß
->
Æign_íåy
 = 8;

321 
ho£
->
sg_pci
 = 
	`iommu_¨ía_√w
(hose, 0xc0000000, 0x40000000, 0);

322 
ho£
->
sg_pci
->
Æign_íåy
 = 4;

324 
p‹t
->
wsba
[0].
c§
 = 
ho£
->
sg_iß
->
dma_ba£
 | 3;

325 
p‹t
->
wsm
[0].
c§
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

326 
p‹t
->
tba
[0].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
);

328 
p‹t
->
wsba
[1].
c§
 = 
__dúe˘_m≠_ba£
 | 1;

329 
p‹t
->
wsm
[1].
c§
 = (
__dúe˘_m≠_size
 - 1) & 0xfff00000;

330 
p‹t
->
tba
[1].
c§
 = 0;

332 
p‹t
->
wsba
[2].
c§
 = 
ho£
->
sg_pci
->
dma_ba£
 | 3;

333 
p‹t
->
wsm
[2].
c§
 = (
ho£
->
sg_pci
->
size
 - 1) & 0xfff00000;

334 
p‹t
->
tba
[2].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_pci
->
±es
);

336 
p‹t
->
wsba
[3].
c§
 = 0;

339 
p‹t
->
p˘l
.
c§
 |
p˘l_m_mwö
;

344 i‡(
	`tô™_quîy_agp
(
p‹t
))

345 
p‹t
->
p‹t_•ecific
.
a
.
ag∂a°wr
.
c§
 = 
__dúe˘_m≠_ba£
;

347 
	`tô™_pci_tbi
(
ho£
, 0, -1);

348 
	}
}

350 
__öô


351 
	$tô™_öô_∑chùs
(
tô™_∑chù
 *
∑chù0
,Åô™_∑chù *
∑chù1
)

353 
tô™_pchù1_¥e£¡
 = 
TITAN_cchù
->
csc
.
c§
 & 1L<<14;

356 
	`tô™_öô_⁄e_∑chù_p‹t
(&
∑chù0
->
g_p‹t
, 0);

357 i‡(
tô™_pchù1_¥e£¡
)

358 
	`tô™_öô_⁄e_∑chù_p‹t
(&
∑chù1
->
g_p‹t
, 1);

359 
	`tô™_öô_⁄e_∑chù_p‹t
(&
∑chù0
->
a_p‹t
, 2);

360 i‡(
tô™_pchù1_¥e£¡
)

361 
	`tô™_öô_⁄e_∑chù_p‹t
(&
∑chù1
->
a_p‹t
, 3);

362 
	}
}

364 
__öô


365 
	$tô™_öô_¨ch
()

368 
	`¥ötk
("%s:Åô™_öô_¨ch()\n", 
__FUNCTION__
);

369 
	`¥ötk
("%s: CChùÑegi°îs:\n", 
__FUNCTION__
);

370 
	`¥ötk
("%s: CSR_CSC 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
csc
.
c§
);

371 
	`¥ötk
("%s: CSR_MTR 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
må
.
c§
);

372 
	`¥ötk
("%s: CSR_MISC 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
misc
.
c§
);

373 
	`¥ötk
("%s: CSR_DIM0 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
dim0
.
c§
);

374 
	`¥ötk
("%s: CSR_DIM1 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
dim1
.
c§
);

375 
	`¥ötk
("%s: CSR_DIR0 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
dú0
.
c§
);

376 
	`¥ötk
("%s: CSR_DIR1 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
dú1
.
c§
);

377 
	`¥ötk
("%s: CSR_DRIR 0x%lx\n", 
__FUNCTION__
, 
TITAN_cchù
->
drú
.
c§
);

379 
	`¥ötk
("%s: DChùÑegi°îs:\n", 
__FUNCTION__
);

380 
	`¥ötk
("%s: CSR_DSC 0x%lx\n", 
__FUNCTION__
, 
TITAN_dchù
->
dsc
.
c§
);

381 
	`¥ötk
("%s: CSR_STR 0x%lx\n", 
__FUNCTION__
, 
TITAN_dchù
->
°r
.
c§
);

382 
	`¥ötk
("%s: CSR_DREV 0x%lx\n", 
__FUNCTION__
, 
TITAN_dchù
->
dªv
.
c§
);

385 
boŸ_˝uid
 = 
	`__h¨d_smp_¥o˚ss‹_id
();

388 
i›‹t_ªsour˚
.
íd
 = ~0UL;

389 
iomem_ªsour˚
.
íd
 = ~0UL;

392 
__dúe˘_m≠_ba£
 = 0x80000000;

393 
__dúe˘_m≠_size
 = 0x40000000;

396 
	`tô™_öô_∑chùs
(
TITAN_∑chù0
, 
TITAN_∑chù1
);

399 
	`föd_c⁄sﬁe_vga_ho£
();

400 
	}
}

403 
	$tô™_kûl_⁄e_∑chù_p‹t
(
tô™_∑chù_p‹t
 *
p‹t
, 
ödex
)

405 
p‹t
->
wsba
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[0];

406 
p‹t
->
wsm
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[0];

407 
p‹t
->
tba
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[0];

409 
p‹t
->
wsba
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[1];

410 
p‹t
->
wsm
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[1];

411 
p‹t
->
tba
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[1];

413 
p‹t
->
wsba
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[2];

414 
p‹t
->
wsm
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[2];

415 
p‹t
->
tba
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[2];

417 
p‹t
->
wsba
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[3];

418 
p‹t
->
wsm
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[3];

419 
p‹t
->
tba
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[3];

420 
	}
}

423 
	$tô™_kûl_∑chùs
(
tô™_∑chù
 *
∑chù0
,Åô™_∑chù *
∑chù1
)

425 i‡(
tô™_pchù1_¥e£¡
) {

426 
	`tô™_kûl_⁄e_∑chù_p‹t
(&
∑chù1
->
g_p‹t
, 1);

427 
	`tô™_kûl_⁄e_∑chù_p‹t
(&
∑chù1
->
a_p‹t
, 3);

429 
	`tô™_kûl_⁄e_∑chù_p‹t
(&
∑chù0
->
g_p‹t
, 0);

430 
	`tô™_kûl_⁄e_∑chù_p‹t
(&
∑chù0
->
a_p‹t
, 2);

431 
	}
}

434 
	$tô™_kûl_¨ch
(
mode
)

436 
	`tô™_kûl_∑chùs
(
TITAN_∑chù0
, 
TITAN_∑chù1
);

437 
	}
}

444 
__iomem
 *

445 
	$tô™_i›‹tm≠
(
addr
)

447 
	`FIXUP_IOADDR_VGA
(
addr
);

448  (
__iomem
 *)(
addr
 + 
TITAN_IO_BIAS
);

449 
	}
}

452 
__iomem
 *

453 
	$tô™_i‹em≠
(
addr
, 
size
)

455 
h
 = (
addr
 & 
TITAN_HOSE_MASK
Ë>> 
TITAN_HOSE_SHIFT
;

456 
baddr
 = 
addr
 & ~
TITAN_HOSE_MASK
;

457 
œ°
 = 
baddr
 + 
size
 - 1;

458 
pci_c⁄åﬁÀr
 *
ho£
;

459 
vm_°ru˘
 *
¨ó
;

460 
vaddr
;

461 *
±es
;

462 
p‚
;

467 i‡(
pci_vga_ho£
 && 
	`__is_mem_vga
(
addr
)) {

468 
h
 = 
pci_vga_ho£
->
ödex
;

469 
addr
 +
pci_vga_ho£
->
mem_•a˚
->
°¨t
;

475 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

476 i‡(
ho£
->
ödex
 =
h
)

478 i‡(!
ho£
)

479  
NULL
;

484 i‡((
baddr
 >
__dúe˘_m≠_ba£
) &&

485 ((
baddr
 + 
size
 - 1Ë< 
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
)) {

486 
vaddr
 = 
addr
 - 
__dúe˘_m≠_ba£
 + 
TITAN_MEM_BIAS
;

487  (
__iomem
 *Ë
vaddr
;

493 i‡(
ho£
->
sg_pci
 &&

494 
baddr
 >()
ho£
->
sg_pci
->
dma_ba£
 &&

495 
œ°
 < ()
ho£
->
sg_pci
->
dma_ba£
 + ho£->sg_pci->
size
){

500 
baddr
 -
ho£
->
sg_pci
->
dma_ba£
;

501 
œ°
 -
ho£
->
sg_pci
->
dma_ba£
;

502 
baddr
 &
PAGE_MASK
;

503 
size
 = 
	`PAGE_ALIGN
(
œ°
Ë- 
baddr
;

508 
¨ó
 = 
	`gë_vm_¨ó
(
size
, 
VM_IOREMAP
);

509 i‡(!
¨ó
) {

510 
	`¥ötk
("ioremap failed...Ço vm_area...\n");

511  
NULL
;

514 
±es
 = 
ho£
->
sg_pci
->ptes;

515 
vaddr
 = ()
¨ó
->
addr
;

516 
baddr
 <
œ°
;

517 
baddr
 +
PAGE_SIZE
, 
vaddr
 += PAGE_SIZE) {

518 
p‚
 = 
±es
[
baddr
 >> 
PAGE_SHIFT
];

519 i‡(!(
p‚
 & 1)) {

520 
	`¥ötk
("ioremap failed...ÖteÇot valid...\n");

521 
	`v‰ì
(
¨ó
->
addr
);

522  
NULL
;

524 
p‚
 >>= 1;

526 i‡(
	`__Æpha_ªm≠_¨ó_∑ges
(
vaddr
,

527 
p‚
 << 
PAGE_SHIFT
,

528 
PAGE_SIZE
, 0)) {

529 
	`¥ötk
("FAILEDÅoÑemap_area_pages...\n");

530 
	`v‰ì
(
¨ó
->
addr
);

531  
NULL
;

535 
	`Êush_éb_Æl
();

537 
vaddr
 = ()
¨ó
->
addr
 + (add∏& ~
PAGE_MASK
);

538  (
__iomem
 *Ë
vaddr
;

542  (
__iomem
 *)(
addr
 + 
TITAN_MEM_BIAS
);

543 
	}
}

546 
	$tô™_iounm≠
(vﬁ©ûê
__iomem
 *
xaddr
)

548 
addr
 = (Ë
xaddr
;

549 i‡(
addr
 >
VMALLOC_START
)

550 
	`v‰ì
((*)(
PAGE_MASK
 & 
addr
));

551 
	}
}

554 
	$tô™_is_mmio
(c⁄° vﬁ©ûê
__iomem
 *
xaddr
)

556 
addr
 = (Ë
xaddr
;

558 i‡(
addr
 >
VMALLOC_START
)

561  (
addr
 & 0x100000000UL) == 0;

562 
	}
}

564 #i‚de‡
CONFIG_ALPHA_GENERIC


565 
EXPORT_SYMBOL
(
tô™_i›‹tm≠
);

566 
EXPORT_SYMBOL
(
tô™_i‹em≠
);

567 
EXPORT_SYMBOL
(
tô™_iounm≠
);

568 
EXPORT_SYMBOL
(
tô™_is_mmio
);

574 
	~<löux/agp_backíd.h
>

575 
	~<asm/agp_backíd.h
>

576 
	~<löux/¶ab.h
>

577 
	~<löux/dñay.h
>

579 
	stô™_agp_≠îtuª
 {

580 
pci_iommu_¨ía
 *
	m¨ía
;

581 
	mpg_°¨t
;

582 
	mpg_cou¡
;

586 
	$tô™_agp_£tup
(
Æpha_agp_öfo
 *
agp
)

588 
tô™_agp_≠îtuª
 *
≠î
;

590 i‡(!
Æpha_agpg¨t_size
)

591  -
ENOMEM
;

593 
≠î
 = 
	`kmÆloc
((
tô™_agp_≠îtuª
), 
GFP_KERNEL
);

594 i‡(
≠î
 =
NULL
)

595  -
ENOMEM
;

597 
≠î
->
¨ía
 = 
agp
->
ho£
->
sg_pci
;

598 
≠î
->
pg_cou¡
 = 
Æpha_agpg¨t_size
 / 
PAGE_SIZE
;

599 
≠î
->
pg_°¨t
 = 
	`iommu_ª£rve
◊≥r->
¨ía
,á≥r->
pg_cou¡
,

600 
≠î
->
pg_cou¡
 - 1);

601 i‡(
≠î
->
pg_°¨t
 < 0) {

602 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑeserve AGP memory\n");

603 
	`k‰ì
(
≠î
);

604  -
ENOMEM
;

607 
agp
->
≠îtuª
.
bus_ba£
 =

608 
≠î
->
¨ía
->
dma_ba£
 +á≥r->
pg_°¨t
 * 
PAGE_SIZE
;

609 
agp
->
≠îtuª
.
size
 = 
≠î
->
pg_cou¡
 * 
PAGE_SIZE
;

610 
agp
->
≠îtuª
.
sysd©a
 = 
≠î
;

613 
	}
}

616 
	$tô™_agp_˛ónup
(
Æpha_agp_öfo
 *
agp
)

618 
tô™_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

619 
°©us
;

621 
°©us
 = 
	`iommu_ªÀa£
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,á≥r->
pg_cou¡
);

622 i‡(
°©us
 =-
EBUSY
) {

623 
	`¥ötk
(
KERN_WARNING


625 
	`iommu_unböd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,á≥r->
pg_cou¡
);

626 
°©us
 = 
	`iommu_ªÀa£
(
≠î
->
¨ía
,á≥r->
pg_°¨t
,

627 
≠î
->
pg_cou¡
);

629 i‡(
°©us
 < 0)

630 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑelease AGP memory\n");

632 
	`k‰ì
(
≠î
);

633 
	`k‰ì
(
agp
);

634 
	}
}

637 
	$tô™_agp_c⁄figuª
(
Æpha_agp_öfo
 *
agp
)

639 
TPAchùPCTL
 
p˘l
;

640 
tô™_∑chù_p‹t
 *
p‹t
 = 
agp
->
¥iv©e
;

641 
p˘l
.
p˘l_q_whﬁe
 = 
p‹t
->p˘l.
c§
;

644 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_sba_í
 = 
agp
->
mode
.
bôs
.
sba
;

647 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_øã
 = 0;

648 i‡(
agp
->
mode
.
bôs
.
øã
 & 2)

649 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_øã
 = 1;

651 i‡(
agp
->
mode
.
bôs
.
øã
 & 4)

652 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_øã
 = 2;

656 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_hp_rd
 = 2;

657 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_Õ_rd
 = 7;

662 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_í
 = 
agp
->
mode
.
bôs
.
íabÀ
;

665 
	`¥ötk
("Enabling AGP: %dX%s\n",

666 1 << 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_øã
,

667 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_sba_í
 ? " - SBA" : "");

670 
p‹t
->
p˘l
.
c§
 =Ö˘l.
p˘l_q_whﬁe
;

673 
	`udñay
(100);

676 
	}
}

679 
	$tô™_agp_böd_mem‹y
(
Æpha_agp_öfo
 *
agp
, 
off_t
 
pg_°¨t
, 
agp_mem‹y
 *
mem
)

681 
tô™_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

682  
	`iommu_böd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
 +Ög_start,

683 
mem
->
∑ge_cou¡
, mem->
mem‹y
);

684 
	}
}

687 
	$tô™_agp_unböd_mem‹y
(
Æpha_agp_öfo
 *
agp
, 
off_t
 
pg_°¨t
, 
agp_mem‹y
 *
mem
)

689 
tô™_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

690  
	`iommu_unböd
(
≠î
->
¨ía
,á≥r->
pg_°¨t
 +Ög_start,

691 
mem
->
∑ge_cou¡
);

692 
	}
}

695 
	$tô™_agp_å™¶©e
(
Æpha_agp_öfo
 *
agp
, 
dma_addr_t
 
addr
)

697 
tô™_agp_≠îtuª
 *
≠î
 = 
agp
->
≠îtuª
.
sysd©a
;

698 
baddr
 = 
addr
 - 
≠î
->
¨ía
->
dma_ba£
;

699 
±e
;

701 i‡(
addr
 < 
agp
->
≠îtuª
.
bus_ba£
 ||

702 
addr
 >
agp
->
≠îtuª
.
bus_ba£
 +ágp->≠îtuª.
size
) {

703 
	`¥ötk
("%s:ádd∏ouào‡ønge\n", 
__FUNCTION__
);

704  -
EINVAL
;

707 
±e
 = 
≠î
->
¨ía
->
±es
[
baddr
 >> 
PAGE_SHIFT
];

708 i‡(!(
±e
 & 1)) {

709 
	`¥ötk
("%s:ÖãÇŸ vÆid\n", 
__FUNCTION__
);

710  -
EINVAL
;

713  (
±e
 >> 1Ë<< 
PAGE_SHIFT
;

714 
	}
}

716 
Æpha_agp_›s
 
	gtô™_agp_›s
 =

718 .
£tup
 = 
tô™_agp_£tup
,

719 .
	g˛ónup
 = 
tô™_agp_˛ónup
,

720 .
	gc⁄figuª
 = 
tô™_agp_c⁄figuª
,

721 .
	gböd
 = 
tô™_agp_böd_mem‹y
,

722 .
	gunböd
 = 
tô™_agp_unböd_mem‹y
,

723 .
	gå™¶©e
 = 
tô™_agp_å™¶©e


726 
Æpha_agp_öfo
 *

727 
	$tô™_agp_öfo
()

729 
Æpha_agp_öfo
 *
agp
;

730 
pci_c⁄åﬁÀr
 *
ho£
;

731 
tô™_∑chù_p‹t
 *
p‹t
;

732 
ho£num
 = -1;

733 
TPAchùPCTL
 
p˘l
;

738 
p‹t
 = &
TITAN_∑chù0
->
a_p‹t
;

739 i‡(
	`tô™_quîy_agp
(
p‹t
))

740 
ho£num
 = 2;

741 i‡(
ho£num
 < 0 &&

742 
tô™_pchù1_¥e£¡
 &&

743 
	`tô™_quîy_agp
(
p‹t
 = &
TITAN_∑chù1
->
a_p‹t
))

744 
ho£num
 = 3;

749 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

750 i‡(
ho£
->
ödex
 =
ho£num
)

753 i‡(!
ho£
 || !ho£->
sg_pci
)

754  
NULL
;

759 
agp
 = 
	`kmÆloc
((*agp), 
GFP_KERNEL
);

764 
agp
->
ho£
 = hose;

765 
agp
->
¥iv©e
 = 
p‹t
;

766 
agp
->
›s
 = &
tô™_agp_›s
;

773 
agp
->
≠îtuª
.
bus_ba£
 = 0;

774 
agp
->
≠îtuª
.
size
 = 0;

775 
agp
->
≠îtuª
.
sysd©a
 = 
NULL
;

780 
agp
->
ˇ∑bûôy
.
lw
 = 0;

781 
agp
->
ˇ∑bûôy
.
bôs
.
øã
 = 3;

782 
agp
->
ˇ∑bûôy
.
bôs
.
sba
 = 1;

783 
agp
->
ˇ∑bûôy
.
bôs
.
rq
 = 7;

788 
p˘l
.
p˘l_q_whﬁe
 = 
p‹t
->p˘l.
c§
;

789 
agp
->
mode
.
lw
 = 0;

790 
agp
->
mode
.
bôs
.
øã
 = 1 << 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_øã
;

791 
agp
->
mode
.
bôs
.
sba
 = 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_sba_í
;

792 
agp
->
mode
.
bôs
.
rq
 = 7;

793 
agp
->
mode
.
bôs
.
íabÀ
 = 
p˘l
.
p˘l_r_bôs
.
≠˘l_v_agp_í
;

795  
agp
;

796 
	}
}

	@arch/alpha/kernel/core_tsunami.c

9 
	#__EXTERN_INLINE
 
ölöe


	)

10 
	~<asm/io.h
>

11 
	~<asm/c‹e_tsu«mi.h
>

12 #unde‡
__EXTERN_INLINE


14 
	~<löux/ty≥s.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/boŸmem.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/smp.h
>

22 
	~<asm/vga.h
>

24 
	~"¥Ÿo.h
"

25 
	~"pci_im∂.h
"

31 
	mwsba
[4];

32 
	mwsm
[4];

33 
	mtba
[4];

34 } 
	gßved_c⁄fig
[2] 
__©åibuã__
((
comm⁄
));

46 
	#DEBUG_CONFIG
 0

	)

48 #i‡
DEBUG_CONFIG


49 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

51 
	#DBG_CFG
(
¨gs
)

	)

90 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

91 *
pci_addr
, *
ty≥1
)

93 
pci_c⁄åﬁÀr
 *
ho£
 = 
pbus
->
sysd©a
;

94 
addr
;

95 
u8
 
bus
 = 
pbus
->
numbî
;

97 
	`DBG_CFG
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, "

99 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

101 i‡(!
pbus
->
∑ª¡
)

102 
bus
 = 0;

103 *
ty≥1
 = (
bus
 != 0);

105 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

106 
addr
 |
ho£
->
c⁄fig_•a˚_ba£
;

108 *
pci_addr
 = 
addr
;

109 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

111 
	}
}

114 
	$tsu«mi_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

115 
size
, 
u32
 *
vÆue
)

117 
addr
;

118 
ty≥1
;

120 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

121  
PCIBIOS_DEVICE_NOT_FOUND
;

123 
size
) {

125 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

128 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

131 *
vÆue
 = *(
vuù
)
addr
;

135  
PCIBIOS_SUCCESSFUL
;

136 
	}
}

139 
	$tsu«mi_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

140 
size
, 
u32
 
vÆue
)

142 
addr
;

143 
ty≥1
;

145 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

146  
PCIBIOS_DEVICE_NOT_FOUND
;

148 
size
) {

150 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

151 
	`mb
();

152 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

155 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

156 
	`mb
();

157 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

160 *(
vuù
)
addr
 = 
vÆue
;

161 
	`mb
();

162 *(
vuù
)
addr
;

166  
PCIBIOS_SUCCESSFUL
;

167 
	}
}

169 
pci_›s
 
	gtsu«mi_pci_›s
 =

171 .
ªad
 = 
tsu«mi_ªad_c⁄fig
,

172 .
	gwrôe
 = 
tsu«mi_wrôe_c⁄fig
,

176 
	$tsu«mi_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

178 
tsu«mi_pchù
 *
pchù
 = 
ho£
->
ödex
 ? 
TSUNAMI_pchù1
 : 
TSUNAMI_pchù0
;

179 vﬁ©ûê*
c§
;

180 
vÆue
;

184 
c§
 = &
pchù
->
ébü
.csr;

185 i‡(((
°¨t
 ^ 
íd
) & 0xffff0000) == 0)

186 
c§
 = &
pchù
->
ébiv
.csr;

190 
vÆue
 = (
°¨t
 & 0xffff0000) >> 12;

192 *
c§
 = 
vÆue
;

193 
	`mb
();

194 *
c§
;

195 
	}
}

197 #ifde‡
NXM_MACHINE_CHECKS_ON_TSUNAMI


198 
__öô


199 
	$tsu«mi_¥obe_ªad
(vﬁ©ûê*
vaddr
)

201 
d⁄t_ˇª
, 
¥obe_ªsu…
;

202 
˝u
 = 
	`smp_¥o˚ss‹_id
();

203 
s
 = 
	`swpùl
(
IPL_MCHECK
 - 1);

205 
	`mcheck_èkí
(
˝u
) = 0;

206 
	`mcheck_ex≥˘ed
(
˝u
) = 1;

207 
	`mb
();

208 
d⁄t_ˇª
 = *
vaddr
;

209 
	`døöa
();

210 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

211 
¥obe_ªsu…
 = !
	`mcheck_èkí
(
˝u
);

212 
	`mcheck_èkí
(
˝u
) = 0;

213 
	`£tùl
(
s
);

215 
	`¥ötk
("d⁄t_ˇª =0x%lx\n", 
d⁄t_ˇª
);

217  
¥obe_ªsu…
;

218 
	}
}

220 
__öô


221 
	$tsu«mi_¥obe_wrôe
(vﬁ©ûê*
vaddr
)

223 
åue_c⁄ã¡s
, 
¥obe_ªsu…
 = 1;

225 
TSUNAMI_cchù
->
misc
.
c§
 |= (1L << 28);

226 
åue_c⁄ã¡s
 = *
vaddr
;

227 *
vaddr
 = 0;

228 
	`døöa
();

229 i‡(
TSUNAMI_cchù
->
misc
.
c§
 & (1L << 28)) {

230 
sour˚
 = (
TSUNAMI_cchù
->
misc
.
c§
 >> 29) & 7;

231 
TSUNAMI_cchù
->
misc
.
c§
 |= (1L << 28);

232 
¥obe_ªsu…
 = 0;

233 
	`¥ötk
("tsu«mi_¥obe_wrôe: unô %dáà0x%016lx\n", 
sour˚
,

234 ()
vaddr
);

236 i‡(
¥obe_ªsu…
)

237 *
vaddr
 = 
åue_c⁄ã¡s
;

238  
¥obe_ªsu…
;

239 
	}
}

241 
	#tsu«mi_¥obe_ªad
(
ADDR
Ë1

	)

244 
	#FN
 
__FUNCTION__


	)

246 
__öô


247 
	$tsu«mi_öô_⁄e_pchù
(
tsu«mi_pchù
 *
pchù
, 
ödex
)

249 
pci_c⁄åﬁÀr
 *
ho£
;

251 i‡(
	`tsu«mi_¥obe_ªad
(&
pchù
->
p˘l
.
c§
) == 0)

254 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

255 i‡(
ödex
 == 0)

256 
pci_iß_ho£
 = 
ho£
;

257 
ho£
->
io_•a˚
 = 
	`Æloc_ªsour˚
();

258 
ho£
->
mem_•a˚
 = 
	`Æloc_ªsour˚
();

264 
ho£
->
•¨£_mem_ba£
 = 0;

265 
ho£
->
•¨£_io_ba£
 = 0;

266 
ho£
->
dí£_mem_ba£


267 (
	`TSUNAMI_MEM
(
ödex
) & 0xffffffffffL) | 0x80000000000L;

268 
ho£
->
dí£_io_ba£


269 (
	`TSUNAMI_IO
(
ödex
) & 0xffffffffffL) | 0x80000000000L;

271 
ho£
->
c⁄fig_•a˚_ba£
 = 
	`TSUNAMI_CONF
(
ödex
);

272 
ho£
->
ödex
 = index;

274 
ho£
->
io_•a˚
->
°¨t
 = 
	`TSUNAMI_IO
(
ödex
Ë- 
TSUNAMI_IO_BIAS
;

275 
ho£
->
io_•a˚
->
íd
 = ho£->io_•a˚->
°¨t
 + 
TSUNAMI_IO_SPACE
 - 1;

276 
ho£
->
io_•a˚
->
«me
 = 
pci_io_«mes
[
ödex
];

277 
ho£
->
io_•a˚
->
Êags
 = 
IORESOURCE_IO
;

279 
ho£
->
mem_•a˚
->
°¨t
 = 
	`TSUNAMI_MEM
(
ödex
Ë- 
TSUNAMI_MEM_BIAS
;

280 
ho£
->
mem_•a˚
->
íd
 = ho£->mem_•a˚->
°¨t
 + 0xffffffff;

281 
ho£
->
mem_•a˚
->
«me
 = 
pci_mem_«mes
[
ödex
];

282 
ho£
->
mem_•a˚
->
Êags
 = 
IORESOURCE_MEM
;

284 i‡(
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
ho£
->
io_•a˚
) < 0)

285 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° IO o¿ho£ %d\n", 
ödex
);

286 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
ho£
->
mem_•a˚
) < 0)

287 
	`¥ötk
(
KERN_ERR
 "FaûedÅÿªque° MEM o¿ho£ %d\n", 
ödex
);

294 
ßved_c⁄fig
[
ödex
].
wsba
[0] = 
pchù
->wsba[0].
c§
;

295 
ßved_c⁄fig
[
ödex
].
wsm
[0] = 
pchù
->wsm[0].
c§
;

296 
ßved_c⁄fig
[
ödex
].
tba
[0] = 
pchù
->tba[0].
c§
;

298 
ßved_c⁄fig
[
ödex
].
wsba
[1] = 
pchù
->wsba[1].
c§
;

299 
ßved_c⁄fig
[
ödex
].
wsm
[1] = 
pchù
->wsm[1].
c§
;

300 
ßved_c⁄fig
[
ödex
].
tba
[1] = 
pchù
->tba[1].
c§
;

302 
ßved_c⁄fig
[
ödex
].
wsba
[2] = 
pchù
->wsba[2].
c§
;

303 
ßved_c⁄fig
[
ödex
].
wsm
[2] = 
pchù
->wsm[2].
c§
;

304 
ßved_c⁄fig
[
ödex
].
tba
[2] = 
pchù
->tba[2].
c§
;

306 
ßved_c⁄fig
[
ödex
].
wsba
[3] = 
pchù
->wsba[3].
c§
;

307 
ßved_c⁄fig
[
ödex
].
wsm
[3] = 
pchù
->wsm[3].
c§
;

308 
ßved_c⁄fig
[
ödex
].
tba
[3] = 
pchù
->tba[3].
c§
;

322 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

324 
ho£
->
sg_iß
->
Æign_íåy
 = 4;

326 
ho£
->
sg_pci
 = 
	`iommu_¨ía_√w
(hose, 0x40000000,

327 
	`size_f‹_mem‹y
(0x40000000), 0);

328 
ho£
->
sg_pci
->
Æign_íåy
 = 4;

330 
__dúe˘_m≠_ba£
 = 0x80000000;

331 
__dúe˘_m≠_size
 = 0x80000000;

333 
pchù
->
wsba
[0].
c§
 = 
ho£
->
sg_iß
->
dma_ba£
 | 3;

334 
pchù
->
wsm
[0].
c§
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

335 
pchù
->
tba
[0].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
);

337 
pchù
->
wsba
[1].
c§
 = 
ho£
->
sg_pci
->
dma_ba£
 | 3;

338 
pchù
->
wsm
[1].
c§
 = (
ho£
->
sg_pci
->
size
 - 1) & 0xfff00000;

339 
pchù
->
tba
[1].
c§
 = 
	`vút_to_phys
(
ho£
->
sg_pci
->
±es
);

341 
pchù
->
wsba
[2].
c§
 = 0x80000000 | 1;

342 
pchù
->
wsm
[2].
c§
 = (0x80000000 - 1) & 0xfff00000;

343 
pchù
->
tba
[2].
c§
 = 0;

345 
pchù
->
wsba
[3].
c§
 = 0;

348 
pchù
->
p˘l
.
c§
 |
p˘l_m_mwö
;

350 
	`tsu«mi_pci_tbi
(
ho£
, 0, -1);

351 
	}
}

354 
__iomem
 *

355 
	$tsu«mi_i›‹tm≠
(
addr
)

357 
	`FIXUP_IOADDR_VGA
(
addr
);

358  (
__iomem
 *)(
addr
 + 
TSUNAMI_IO_BIAS
);

359 
	}
}

361 
__iomem
 *

362 
	$tsu«mi_i‹em≠
(
addr
, 
size
)

364 
	`FIXUP_MEMADDR_VGA
(
addr
);

365  (
__iomem
 *)(
addr
 + 
TSUNAMI_MEM_BIAS
);

366 
	}
}

368 #i‚de‡
CONFIG_ALPHA_GENERIC


369 
EXPORT_SYMBOL
(
tsu«mi_i›‹tm≠
);

370 
EXPORT_SYMBOL
(
tsu«mi_i‹em≠
);

373 
__öô


374 
	$tsu«mi_öô_¨ch
()

376 #ifde‡
NXM_MACHINE_CHECKS_ON_TSUNAMI


377 
tmp
;

381 
	`wª¡
(
ítI¡
, 0);

385 
tmp
 = ()(
TSUNAMI_cchù
 - 1);

386 
	`¥ötk
("%s:Örobög bogu†addªss: 0x%016lx\n", 
FN
, 
bogus_addr
);

387 
	`¥ötk
("\tprobe %s\n",

388 
	`tsu«mi_¥obe_wrôe
((*)
bogus_addr
)

393 
	`¥ötk
("%s: CChùÑegi°îs:\n", 
FN
);

394 
	`¥ötk
("%s: CSR_CSC 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
csc
.
c§
);

395 
	`¥ötk
("%s: CSR_MTR 0x%lx\n", 
FN
, 
TSUNAMI_cchù
.
må
.
c§
);

396 
	`¥ötk
("%s: CSR_MISC 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
misc
.
c§
);

397 
	`¥ötk
("%s: CSR_DIM0 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
dim0
.
c§
);

398 
	`¥ötk
("%s: CSR_DIM1 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
dim1
.
c§
);

399 
	`¥ötk
("%s: CSR_DIR0 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
dú0
.
c§
);

400 
	`¥ötk
("%s: CSR_DIR1 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
dú1
.
c§
);

401 
	`¥ötk
("%s: CSR_DRIR 0x%lx\n", 
FN
, 
TSUNAMI_cchù
->
drú
.
c§
);

403 
	`¥ötk
("%s: DChipÑegisters:\n");

404 
	`¥ötk
("%s: CSR_DSC 0x%lx\n", 
FN
, 
TSUNAMI_dchù
->
dsc
.
c§
);

405 
	`¥ötk
("%s: CSR_STR 0x%lx\n", 
FN
, 
TSUNAMI_dchù
->
°r
.
c§
);

406 
	`¥ötk
("%s: CSR_DREV 0x%lx\n", 
FN
, 
TSUNAMI_dchù
->
dªv
.
c§
);

409 
i›‹t_ªsour˚
.
íd
 = ~0UL;

414 
	`tsu«mi_öô_⁄e_pchù
(
TSUNAMI_pchù0
, 0);

415 i‡(
TSUNAMI_cchù
->
csc
.
c§
 & 1L<<14)

416 
	`tsu«mi_öô_⁄e_pchù
(
TSUNAMI_pchù1
, 1);

419 
	`föd_c⁄sﬁe_vga_ho£
();

420 
	}
}

423 
	$tsu«mi_kûl_⁄e_pchù
(
tsu«mi_pchù
 *
pchù
, 
ödex
)

425 
pchù
->
wsba
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[0];

426 
pchù
->
wsm
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[0];

427 
pchù
->
tba
[0].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[0];

429 
pchù
->
wsba
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[1];

430 
pchù
->
wsm
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[1];

431 
pchù
->
tba
[1].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[1];

433 
pchù
->
wsba
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[2];

434 
pchù
->
wsm
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[2];

435 
pchù
->
tba
[2].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[2];

437 
pchù
->
wsba
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].wsba[3];

438 
pchù
->
wsm
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].wsm[3];

439 
pchù
->
tba
[3].
c§
 = 
ßved_c⁄fig
[
ödex
].tba[3];

440 
	}
}

443 
	$tsu«mi_kûl_¨ch
(
mode
)

445 
	`tsu«mi_kûl_⁄e_pchù
(
TSUNAMI_pchù0
, 0);

446 i‡(
TSUNAMI_cchù
->
csc
.
c§
 & 1L<<14)

447 
	`tsu«mi_kûl_⁄e_pchù
(
TSUNAMI_pchù1
, 1);

448 
	}
}

450 
ölöe
 

451 
	$tsu«mi_pci_˛r_îr_1
(
tsu«mi_pchù
 *
pchù
)

453 
pchù
->
≥º‹
.
c§
;

454 
pchù
->
≥º‹
.
c§
 = 0x040;

455 
	`mb
();

456 
pchù
->
≥º‹
.
c§
;

457 
	}
}

459 
ölöe
 

460 
	$tsu«mi_pci_˛r_îr
()

462 
	`tsu«mi_pci_˛r_îr_1
(
TSUNAMI_pchù0
);

465 i‡(
TSUNAMI_cchù
->
csc
.
c§
 & 1L<<14)

466 
	`tsu«mi_pci_˛r_îr_1
(
TSUNAMI_pchù1
);

467 
	}
}

470 
	$tsu«mi_machöe_check
(
ve˘‹
, 
œ_±r
)

473 
	`mb
();

474 
	`mb
();

475 
	`døöa
();

476 
	`tsu«mi_pci_˛r_îr
();

477 
	`wrm˚s
(0x7);

478 
	`mb
();

480 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "TSUNAMI",

481 
	`mcheck_ex≥˘ed
(
	`smp_¥o˚ss‹_id
()));

482 
	}
}

	@arch/alpha/kernel/core_wildfire.c

9 
	#__EXTERN_INLINE
 
ölöe


	)

10 
	~<asm/io.h
>

11 
	~<asm/c‹e_wûdfúe.h
>

12 #unde‡
__EXTERN_INLINE


14 
	~<löux/ty≥s.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öô.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/smp.h
>

22 
	~"¥Ÿo.h
"

23 
	~"pci_im∂.h
"

25 
	#DEBUG_CONFIG
 0

	)

26 
	#DEBUG_DUMP_REGS
 0

	)

27 
	#DEBUG_DUMP_CONFIG
 1

	)

29 #i‡
DEBUG_CONFIG


30 
	#DBG_CFG
(
¨gs
Ë
¥ötk
 
	)
args

32 
	#DBG_CFG
(
¨gs
)

	)

35 #i‡
DEBUG_DUMP_REGS


36 
wûdfúe_dump_pci_ªgs
(
qbbno
, 
ho£no
);

37 
wûdfúe_dump_pˇ_ªgs
(
qbbno
, 
pˇno
);

38 
wûdfúe_dump_qß_ªgs
(
qbbno
);

39 
wûdfúe_dump_qsd_ªgs
(
qbbno
);

40 
wûdfúe_dump_i›_ªgs
(
qbbno
);

41 
wûdfúe_dump_gp_ªgs
(
qbbno
);

43 #i‡
DEBUG_DUMP_CONFIG


44 
wûdfúe_dump_h¨dw¨e_c⁄fig
();

47 
	gwûdfúe_h¨d_qbb_m≠
[
WILDFIRE_MAX_QBB
];

48 
	gwûdfúe_so·_qbb_m≠
[
WILDFIRE_MAX_QBB
];

49 
	#QBB_MAP_EMPTY
 0xff

	)

51 
	gwûdfúe_h¨d_qbb_mask
;

52 
	gwûdfúe_so·_qbb_mask
;

53 
	gwûdfúe_gp_mask
;

54 
	gwûdfúe_hs_mask
;

55 
	gwûdfúe_i›_mask
;

56 
	gwûdfúe_i‹_mask
;

57 
	gwûdfúe_pˇ_mask
;

58 
	gwûdfúe_˝u_mask
;

59 
	gwûdfúe_mem_mask
;

61 
__öô


62 
	$wûdfúe_öô_ho£
(
qbbno
, 
ho£no
)

64 
pci_c⁄åﬁÀr
 *
ho£
;

65 
wûdfúe_pci
 *
pci
;

67 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

68 
ho£
->
io_•a˚
 = 
	`Æloc_ªsour˚
();

69 
ho£
->
mem_•a˚
 = 
	`Æloc_ªsour˚
();

72 
ho£
->
•¨£_mem_ba£
 = 0;

73 
ho£
->
•¨£_io_ba£
 = 0;

74 
ho£
->
dí£_mem_ba£
 = 
	`WILDFIRE_MEM
(
qbbno
, 
ho£no
);

75 
ho£
->
dí£_io_ba£
 = 
	`WILDFIRE_IO
(
qbbno
, 
ho£no
);

77 
ho£
->
c⁄fig_•a˚_ba£
 = 
	`WILDFIRE_CONF
(
qbbno
, 
ho£no
);

78 
ho£
->
ödex
 = (
qbbno
 << 3Ë+ 
ho£no
;

80 
ho£
->
io_•a˚
->
°¨t
 = 
	`WILDFIRE_IO
(
qbbno
, 
ho£no
Ë- 
WILDFIRE_IO_BIAS
;

81 
ho£
->
io_•a˚
->
íd
 = ho£->io_•a˚->
°¨t
 + 
WILDFIRE_IO_SPACE
 - 1;

82 
ho£
->
io_•a˚
->
«me
 = 
pci_io_«mes
[
ho£no
];

83 
ho£
->
io_•a˚
->
Êags
 = 
IORESOURCE_IO
;

85 
ho£
->
mem_•a˚
->
°¨t
 = 
	`WILDFIRE_MEM
(
qbbno
, 
ho£no
)-
WILDFIRE_MEM_BIAS
;

86 
ho£
->
mem_•a˚
->
íd
 = ho£->mem_•a˚->
°¨t
 + 0xffffffff;

87 
ho£
->
mem_•a˚
->
«me
 = 
pci_mem_«mes
[
ho£no
];

88 
ho£
->
mem_•a˚
->
Êags
 = 
IORESOURCE_MEM
;

90 i‡(
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
ho£
->
io_•a˚
) < 0)

91 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest IO on qbb %d hose %d\n",

92 
qbbno
, 
ho£no
);

93 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
ho£
->
mem_•a˚
) < 0)

94 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest MEM on qbb %d hose %d\n",

95 
qbbno
, 
ho£no
);

97 #i‡
DEBUG_DUMP_REGS


98 
	`wûdfúe_dump_pci_ªgs
(
qbbno
, 
ho£no
);

113 
ho£
->
sg_iß
 = 
	`iommu_¨ía_√w
(hose, 0x00800000, 0x00800000, 0);

114 
ho£
->
sg_pci
 = 
	`iommu_¨ía_√w
(hose, 0xc0000000, 0x08000000, 0);

116 
pci
 = 
	`WILDFIRE_pci
(
qbbno
, 
ho£no
);

118 
pci
->
pci_wödow
[0].
wba£
.
c§
 = 
ho£
->
sg_iß
->
dma_ba£
 | 3;

119 
pci
->
pci_wödow
[0].
wmask
.
c§
 = (
ho£
->
sg_iß
->
size
 - 1) & 0xfff00000;

120 
pci
->
pci_wödow
[0].
tba£
.
c§
 = 
	`vút_to_phys
(
ho£
->
sg_iß
->
±es
);

122 
pci
->
pci_wödow
[1].
wba£
.
c§
 = 0x40000000 | 1;

123 
pci
->
pci_wödow
[1].
wmask
.
c§
 = (0x40000000 -1) & 0xfff00000;

124 
pci
->
pci_wödow
[1].
tba£
.
c§
 = 0;

126 
pci
->
pci_wödow
[2].
wba£
.
c§
 = 0x80000000 | 1;

127 
pci
->
pci_wödow
[2].
wmask
.
c§
 = (0x40000000 -1) & 0xfff00000;

128 
pci
->
pci_wödow
[2].
tba£
.
c§
 = 0x40000000;

130 
pci
->
pci_wödow
[3].
wba£
.
c§
 = 
ho£
->
sg_pci
->
dma_ba£
 | 3;

131 
pci
->
pci_wödow
[3].
wmask
.
c§
 = (
ho£
->
sg_pci
->
size
 - 1) & 0xfff00000;

132 
pci
->
pci_wödow
[3].
tba£
.
c§
 = 
	`vút_to_phys
(
ho£
->
sg_pci
->
±es
);

134 
	`wûdfúe_pci_tbi
(
ho£
, 0, 0);

135 
	}
}

137 
__öô


138 
	$wûdfúe_öô_pˇ
(
qbbno
, 
pˇno
)

142 i‡(!
	`WILDFIRE_PCA_EXISTS
(
qbbno
, 
pˇno
))

145 #i‡
DEBUG_DUMP_REGS


146 
	`wûdfúe_dump_pˇ_ªgs
(
qbbno
, 
pˇno
);

150 
	`wûdfúe_öô_ho£
(
qbbno
, (
pˇno
 << 1) + 0);

151 
	`wûdfúe_öô_ho£
(
qbbno
, (
pˇno
 << 1) + 1);

152 
	}
}

154 
__öô


155 
	$wûdfúe_öô_qbb
(
qbbno
)

157 
pˇno
;

160 i‡(!
	`WILDFIRE_QBB_EXISTS
(
qbbno
))

163 #i‡
DEBUG_DUMP_REGS


164 
	`wûdfúe_dump_qß_ªgs
(
qbbno
);

165 
	`wûdfúe_dump_qsd_ªgs
(
qbbno
);

166 
	`wûdfúe_dump_i›_ªgs
(
qbbno
);

167 
	`wûdfúe_dump_gp_ªgs
(
qbbno
);

171 
pˇno
 = 0;Öˇnÿ< 
WILDFIRE_PCA_PER_QBB
;Öcano++) {

172 
	`wûdfúe_öô_pˇ
(
qbbno
, 
pˇno
);

174 
	}
}

176 
__öô


177 
	$wûdfúe_h¨dw¨e_¥obe
()

179 
ãmp
;

180 
h¨d_qbb
, 
so·_qbb
;

181 
wûdfúe_Á°_qsd
 *
Á°
 = 
	`WILDFIRE_Á°_qsd
();

182 
wûdfúe_qsd
 *
qsd
;

183 
wûdfúe_qß
 *
qß
;

184 
wûdfúe_i›
 *
i›
;

185 
wûdfúe_gp
 *
gp
;

186 
wûdfúe_√
 *
√
;

187 
wûdfúe_„
 *
„
;

188 
i
;

190 
ãmp
 = 
Á°
->
qsd_whami
.
c§
;

192 
	`¥ötk
(
KERN_ERR
 "Á° QSD_WHAMIáàba£ %∞i†0x%lx\n", 
Á°
, 
ãmp
);

195 
h¨d_qbb
 = (
ãmp
 >> 8) & 7;

196 
so·_qbb
 = (
ãmp
 >> 4) & 7;

199 
wûdfúe_h¨d_qbb_mask
 = (1 << 
h¨d_qbb
);

200 
wûdfúe_so·_qbb_mask
 = (1 << 
so·_qbb
);

202 
wûdfúe_gp_mask
 = 0;

203 
wûdfúe_hs_mask
 = 0;

204 
wûdfúe_i›_mask
 = 0;

205 
wûdfúe_i‹_mask
 = 0;

206 
wûdfúe_pˇ_mask
 = 0;

208 
wûdfúe_˝u_mask
 = 0;

209 
wûdfúe_mem_mask
 = 0;

211 
	`mem£t
(
wûdfúe_h¨d_qbb_m≠
, 
QBB_MAP_EMPTY
, 
WILDFIRE_MAX_QBB
);

212 
	`mem£t
(
wûdfúe_so·_qbb_m≠
, 
QBB_MAP_EMPTY
, 
WILDFIRE_MAX_QBB
);

215 
qß
 = 
	`WILDFIRE_qß
(
so·_qbb
);

217 
ãmp
 = 
qß
->
qß_qbb_id
.
c§
;

219 
	`¥ötk
(
KERN_ERR
 "QSA_QBB_IDáàba£ %∞i†0x%lx\n", 
qß
, 
ãmp
);

222 i‡(
ãmp
 & 0x40)

223 
wûdfúe_hs_mask
 = 1;

225 i‡(
ãmp
 & 0x20) {

226 
gp
 = 
	`WILDFIRE_gp
(
so·_qbb
);

227 
ãmp
 = 0;

228 
i
 = 0; i < 4; i++) {

229 
ãmp
 |
gp
->
g∑_qbb_m≠
[
i
].
c§
 << (i * 8);

231 
	`¥ötk
(
KERN_ERR
 "GPA_QBB_MAP[%d]át base %p is 0x%lx\n",

232 
i
, 
gp
, 
ãmp
);

236 
h¨d_qbb
 = 0; h¨d_qbb < 
WILDFIRE_MAX_QBB
; hard_qbb++) {

237 i‡(
ãmp
 & 8) {

238 
so·_qbb
 = 
ãmp
 & 7;

239 
wûdfúe_h¨d_qbb_mask
 |(1 << 
h¨d_qbb
);

240 
wûdfúe_so·_qbb_mask
 |(1 << 
so·_qbb
);

242 
ãmp
 >>= 4;

244 
wûdfúe_gp_mask
 = 
wûdfúe_so·_qbb_mask
;

248 
so·_qbb
 = 0; so·_qbb < 
WILDFIRE_MAX_QBB
; soft_qbb++) {

249 i‡(
	`WILDFIRE_QBB_EXISTS
(
so·_qbb
)) {

250 
qsd
 = 
	`WILDFIRE_qsd
(
so·_qbb
);

251 
ãmp
 = 
qsd
->
qsd_whami
.
c§
;

253 
	`¥ötk
(
KERN_ERR
 "QSD_WHAMIáàba£ %∞i†0x%lx\n", 
qsd
, 
ãmp
);

255 
h¨d_qbb
 = (
ãmp
 >> 8) & 7;

256 
wûdfúe_h¨d_qbb_m≠
[
h¨d_qbb
] = 
so·_qbb
;

257 
wûdfúe_so·_qbb_m≠
[
so·_qbb
] = 
h¨d_qbb
;

259 
qß
 = 
	`WILDFIRE_qß
(
so·_qbb
);

260 
ãmp
 = 
qß
->
qß_qbb_p›
[0].
c§
;

262 
	`¥ötk
(
KERN_ERR
 "QSA_QBB_POP_0áàba£ %∞i†0x%lx\n", 
qß
, 
ãmp
);

264 
wûdfúe_˝u_mask
 |((
ãmp
 >> 0Ë& 0xfË<< (
so·_qbb
 << 2);

265 
wûdfúe_mem_mask
 |((
ãmp
 >> 4Ë& 0xfË<< (
so·_qbb
 << 2);

267 
ãmp
 = 
qß
->
qß_qbb_p›
[1].
c§
;

269 
	`¥ötk
(
KERN_ERR
 "QSA_QBB_POP_1áàba£ %∞i†0x%lx\n", 
qß
, 
ãmp
);

271 
wûdfúe_i›_mask
 |(1 << 
so·_qbb
);

272 
wûdfúe_i‹_mask
 |((
ãmp
 >> 4Ë& 0xfË<< (
so·_qbb
 << 2);

274 
ãmp
 = 
qß
->
qß_qbb_id
.
c§
;

276 
	`¥ötk
(
KERN_ERR
 "QSA_QBB_IDáà%∞i†0x%lx\n", 
qß
, 
ãmp
);

278 i‡(
ãmp
 & 0x20)

279 
wûdfúe_gp_mask
 |(1 << 
so·_qbb
);

282 
i
 = 0; i < 
WILDFIRE_PCA_PER_QBB
; i++) {

283 
i›
 = 
	`WILDFIRE_i›
(
so·_qbb
);

284 
√
 = 
	`WILDFIRE_√
(
so·_qbb
, 
i
);

285 
„
 = 
	`WILDFIRE_„
(
so·_qbb
, 
i
);

287 i‡((
i›
->
i›_ho£
[
i
].
öô
.
c§
 & 1) == 1 &&

288 ((
√
->
√_wh©_am_i
.
c§
 & 0xf00000300UL) == 0x100000300UL) &&

289 ((
„
->
„_wh©_am_i
.
c§
 & 0xf00000300UL) == 0x100000200UL))

291 
wûdfúe_pˇ_mask
 |1 << ((
so·_qbb
 << 2Ë+ 
i
);

297 #i‡
DEBUG_DUMP_CONFIG


298 
	`wûdfúe_dump_h¨dw¨e_c⁄fig
();

300 
	}
}

302 
__öô


303 
	$wûdfúe_öô_¨ch
()

305 
qbbno
;

308 
i›‹t_ªsour˚
.
íd
 = ~0UL;

312 
	`wûdfúe_h¨dw¨e_¥obe
();

315 
qbbno
 = 0; qbbnÿ< 
WILDFIRE_MAX_QBB
; qbbno++) {

316 
	`wûdfúe_öô_qbb
(
qbbno
);

320 
__dúe˘_m≠_ba£
 = 0x40000000UL;

321 
__dúe˘_m≠_size
 = 0x80000000UL;

322 
	}
}

325 
	$wûdfúe_machöe_check
(
ve˘‹
, 
œ_±r
)

327 
	`mb
();

328 
	`mb
();

329 
	`døöa
();

331 
	`wrm˚s
(0x7);

332 
	`mb
();

334 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "WILDFIRE",

335 
	`mcheck_ex≥˘ed
(
	`smp_¥o˚ss‹_id
()));

336 
	}
}

339 
	$wûdfúe_kûl_¨ch
(
mode
)

341 
	}
}

344 
	$wûdfúe_pci_tbi
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
°¨t
, dma_addr_à
íd
)

346 
qbbno
 = 
ho£
->
ödex
 >> 3;

347 
ho£no
 = 
ho£
->
ödex
 & 7;

348 
wûdfúe_pci
 *
pci
 = 
	`WILDFIRE_pci
(
qbbno
, 
ho£no
);

350 
	`mb
();

351 
pci
->
pci_Êush_éb
.
c§
;

352 
	}
}

355 
	$mk_c⁄f_addr
(
pci_bus
 *
pbus
, 
devi˚_‚
, 
whîe
,

356 *
pci_addr
, *
ty≥1
)

358 
pci_c⁄åﬁÀr
 *
ho£
 = 
pbus
->
sysd©a
;

359 
addr
;

360 
u8
 
bus
 = 
pbus
->
numbî
;

362 
	`DBG_CFG
(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, "

364 
bus
, 
devi˚_‚
, 
whîe
, 
pci_addr
, 
ty≥1
));

366 i‡(!
pbus
->
∑ª¡
)

367 
bus
 = 0;

368 *
ty≥1
 = (
bus
 != 0);

370 
addr
 = (
bus
 << 16Ë| (
devi˚_‚
 << 8Ë| 
whîe
;

371 
addr
 |
ho£
->
c⁄fig_•a˚_ba£
;

373 *
pci_addr
 = 
addr
;

374 
	`DBG_CFG
(("mk_c⁄f_addr:Ñëu∫ögÖci_add∏0x%lx\n", 
addr
));

376 
	}
}

379 
	$wûdfúe_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

380 
size
, 
u32
 *
vÆue
)

382 
addr
;

383 
ty≥1
;

385 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

386  
PCIBIOS_DEVICE_NOT_FOUND
;

388 
size
) {

390 *
vÆue
 = 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

393 *
vÆue
 = 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

396 *
vÆue
 = *(
vuù
)
addr
;

400  
PCIBIOS_SUCCESSFUL
;

401 
	}
}

404 
	$wûdfúe_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

405 
size
, 
u32
 
vÆue
)

407 
addr
;

408 
ty≥1
;

410 i‡(
	`mk_c⁄f_addr
(
bus
, 
dev‚
, 
whîe
, &
addr
, &
ty≥1
))

411  
PCIBIOS_DEVICE_NOT_FOUND
;

413 
size
) {

415 
	`__kî√l_°b
(
vÆue
, *(
vu˝
)
addr
);

416 
	`mb
();

417 
	`__kî√l_ldbu
(*(
vu˝
)
addr
);

420 
	`__kî√l_°w
(
vÆue
, *(
vu•
)
addr
);

421 
	`mb
();

422 
	`__kî√l_ldwu
(*(
vu•
)
addr
);

425 *(
vuù
)
addr
 = 
vÆue
;

426 
	`mb
();

427 *(
vuù
)
addr
;

431  
PCIBIOS_SUCCESSFUL
;

432 
	}
}

434 
pci_›s
 
	gwûdfúe_pci_›s
 =

436 .
ªad
 = 
wûdfúe_ªad_c⁄fig
,

437 .
	gwrôe
 = 
wûdfúe_wrôe_c⁄fig
,

444 
	$wûdfúe_∑_to_nid
(
∑
)

446  
∑
 >> 36;

447 
	}
}

449 
	$wûdfúe_˝uid_to_nid
(
˝uid
)

452  
˝uid
 >> 2;

453 
	}
}

455 
	$wûdfúe_node_mem_°¨t
(
nid
)

458  ()
nid
 * (64UL * 1024 * 1024 * 1024);

459 
	}
}

461 
	$wûdfúe_node_mem_size
(
nid
)

465 
	}
}

467 #i‡
DEBUG_DUMP_REGS


469 
__öô


470 
	$wûdfúe_dump_pci_ªgs
(
qbbno
, 
ho£no
)

472 
wûdfúe_pci
 *
pci
 = 
	`WILDFIRE_pci
(
qbbno
, 
ho£no
);

473 
i
;

475 
	`¥ötk
(
KERN_ERR
 "PCIÑegisters for QBB %d hose %d (%p)\n",

476 
qbbno
, 
ho£no
, 
pci
);

478 
	`¥ötk
(
KERN_ERR
 " PCI_IO_ADDR_EXT: 0x%16lx\n",

479 
pci
->
pci_io_addr_ext
.
c§
);

480 
	`¥ötk
(
KERN_ERR
 " PCI_CTRL: 0x%16lx\n", 
pci
->
pci_˘æ
.
c§
);

481 
	`¥ötk
(
KERN_ERR
 " PCI_ERR_SUM: 0x%16lx\n", 
pci
->
pci_îr_sum
.
c§
);

482 
	`¥ötk
(
KERN_ERR
 " PCI_ERR_ADDR: 0x%16lx\n", 
pci
->
pci_îr_addr
.
c§
);

483 
	`¥ötk
(
KERN_ERR
 " PCI_STALL_CNT: 0x%16lx\n", 
pci
->
pci_°Æl_˙t
.
c§
);

484 
	`¥ötk
(
KERN_ERR
 " PCI_PEND_INT: 0x%16lx\n", 
pci
->
pci_≥nd_öt
.
c§
);

485 
	`¥ötk
(
KERN_ERR
 " PCI_SENT_INT: 0x%16lx\n", 
pci
->
pci_£¡_öt
.
c§
);

487 
	`¥ötk
(
KERN_ERR
 " DMA windowÑegisters for QBB %d hose %d (%p)\n",

488 
qbbno
, 
ho£no
, 
pci
);

489 
i
 = 0; i < 4; i++) {

490 
	`¥ötk
(
KERN_ERR
 " wödow %d: 0x%16lx 0x%16lx 0x%16lx\n", 
i
,

491 
pci
->
pci_wödow
[
i
].
wba£
.
c§
,

492 
pci
->
pci_wödow
[
i
].
wmask
.
c§
,

493 
pci
->
pci_wödow
[
i
].
tba£
.
c§
);

495 
	`¥ötk
(
KERN_ERR
 "\n");

496 
	}
}

498 
__öô


499 
	$wûdfúe_dump_pˇ_ªgs
(
qbbno
, 
pˇno
)

501 
wûdfúe_pˇ
 *
pˇ
 = 
	`WILDFIRE_pˇ
(
qbbno
, 
pˇno
);

502 
i
;

504 
	`¥ötk
(
KERN_ERR
 "PCAÑegisters for QBB %d PCA %d (%p)\n",

505 
qbbno
, 
pˇno
, 
pˇ
);

507 
	`¥ötk
(
KERN_ERR
 " PCA_WHAT_AM_I: 0x%16lx\n", 
pˇ
->
pˇ_wh©_am_i
.
c§
);

508 
	`¥ötk
(
KERN_ERR
 " PCA_ERR_SUM: 0x%16lx\n", 
pˇ
->
pˇ_îr_sum
.
c§
);

509 
	`¥ötk
(
KERN_ERR
 " PCA_PEND_INT: 0x%16lx\n", 
pˇ
->
pˇ_≥nd_öt
.
c§
);

510 
	`¥ötk
(
KERN_ERR
 " PCA_SENT_INT: 0x%16lx\n", 
pˇ
->
pˇ_£¡_öt
.
c§
);

511 
	`¥ötk
(
KERN_ERR
 " PCA_STDIO_EL: 0x%16lx\n",

512 
pˇ
->
pˇ_°dio_edge_Àvñ
.
c§
);

514 
	`¥ötk
(
KERN_ERR
 " PCAÅargetÑegisters for QBB %d PCA %d (%p)\n",

515 
qbbno
, 
pˇno
, 
pˇ
);

516 
i
 = 0; i < 4; i++) {

517 
	`¥ötk
(
KERN_ERR
 "Å¨gë %d: 0x%16lx 0x%16lx\n", 
i
,

518 
pˇ
->
pˇ_öt
[
i
].
èrgë
.
c§
,

519 
pˇ
->
pˇ_öt
[
i
].
íabÀ
.
c§
);

522 
	`¥ötk
(
KERN_ERR
 "\n");

523 
	}
}

525 
__öô


526 
	$wûdfúe_dump_qß_ªgs
(
qbbno
)

528 
wûdfúe_qß
 *
qß
 = 
	`WILDFIRE_qß
(
qbbno
);

529 
i
;

531 
	`¥ötk
(
KERN_ERR
 "QSAÑegi°î†f‹ QBB %d (%p)\n", 
qbbno
, 
qß
);

533 
	`¥ötk
(
KERN_ERR
 " QSA_QBB_ID: 0x%16lx\n", 
qß
->
qß_qbb_id
.
c§
);

534 
	`¥ötk
(
KERN_ERR
 " QSA_PORT_ENA: 0x%16lx\n", 
qß
->
qß_p‹t_ía
.
c§
);

535 
	`¥ötk
(
KERN_ERR
 " QSA_REF_INT: 0x%16lx\n", 
qß
->
qß_ªf_öt
.
c§
);

537 
i
 = 0; i < 5; i++)

538 
	`¥ötk
(
KERN_ERR
 " QSA_CONFIG_%d: 0x%16lx\n",

539 
i
, 
qß
->
qß_c⁄fig
[i].
c§
);

541 
i
 = 0; i < 2; i++)

542 
	`¥ötk
(
KERN_ERR
 " QSA_QBB_POP_%d: 0x%16lx\n",

543 
i
, 
qß
->
qß_qbb_p›
[0].
c§
);

545 
	`¥ötk
(
KERN_ERR
 "\n");

546 
	}
}

548 
__öô


549 
	$wûdfúe_dump_qsd_ªgs
(
qbbno
)

551 
wûdfúe_qsd
 *
qsd
 = 
	`WILDFIRE_qsd
(
qbbno
);

553 
	`¥ötk
(
KERN_ERR
 "QSDÑegi°î†f‹ QBB %d (%p)\n", 
qbbno
, 
qsd
);

555 
	`¥ötk
(
KERN_ERR
 " QSD_WHAMI: 0x%16lx\n", 
qsd
->
qsd_whami
.
c§
);

556 
	`¥ötk
(
KERN_ERR
 " QSD_REV: 0x%16lx\n", 
qsd
->
qsd_ªv
.
c§
);

557 
	`¥ötk
(
KERN_ERR
 " QSD_PORT_PRESENT: 0x%16lx\n",

558 
qsd
->
qsd_p‹t_¥e£¡
.
c§
);

559 
	`¥ötk
(
KERN_ERR
 " QSD_PORT_ACTUVE: 0x%16lx\n",

560 
qsd
->
qsd_p‹t_a˘ive
.
c§
);

561 
	`¥ötk
(
KERN_ERR
 " QSD_FAULT_ENA: 0x%16lx\n",

562 
qsd
->
qsd_Áu…_ía
.
c§
);

563 
	`¥ötk
(
KERN_ERR
 " QSD_CPU_INT_ENA: 0x%16lx\n",

564 
qsd
->
qsd_˝u_öt_ía
.
c§
);

565 
	`¥ötk
(
KERN_ERR
 " QSD_MEM_CONFIG: 0x%16lx\n",

566 
qsd
->
qsd_mem_c⁄fig
.
c§
);

567 
	`¥ötk
(
KERN_ERR
 " QSD_ERR_SUM: 0x%16lx\n",

568 
qsd
->
qsd_îr_sum
.
c§
);

570 
	`¥ötk
(
KERN_ERR
 "\n");

571 
	}
}

573 
__öô


574 
	$wûdfúe_dump_i›_ªgs
(
qbbno
)

576 
wûdfúe_i›
 *
i›
 = 
	`WILDFIRE_i›
(
qbbno
);

577 
i
;

579 
	`¥ötk
(
KERN_ERR
 "IOPÑegi°î†f‹ QBB %d (%p)\n", 
qbbno
, 
i›
);

581 
	`¥ötk
(
KERN_ERR
 " IOA_CONFIG: 0x%16lx\n", 
i›
->
iﬂ_c⁄fig
.
c§
);

582 
	`¥ötk
(
KERN_ERR
 " IOD_CONFIG: 0x%16lx\n", 
i›
->
iod_c⁄fig
.
c§
);

583 
	`¥ötk
(
KERN_ERR
 " IOP_SWITCH_CREDITS: 0x%16lx\n",

584 
i›
->
i›_swôch_¸edôs
.
c§
);

585 
	`¥ötk
(
KERN_ERR
 " IOP_HOSE_CREDITS: 0x%16lx\n",

586 
i›
->
i›_ho£_¸edôs
.
c§
);

588 
i
 = 0; i < 4; i++)

589 
	`¥ötk
(
KERN_ERR
 " IOP_HOSE_%d_INIT: 0x%16lx\n",

590 
i
, 
i›
->
i›_ho£
[i].
öô
.
c§
);

591 
i
 = 0; i < 4; i++)

592 
	`¥ötk
(
KERN_ERR
 " IOP_DEV_INT_TARGET_%d: 0x%16lx\n",

593 
i
, 
i›
->
i›_dev_öt
[i].
èrgë
.
c§
);

595 
	`¥ötk
(
KERN_ERR
 "\n");

596 
	}
}

598 
__öô


599 
	$wûdfúe_dump_gp_ªgs
(
qbbno
)

601 
wûdfúe_gp
 *
gp
 = 
	`WILDFIRE_gp
(
qbbno
);

602 
i
;

604 
	`¥ötk
(
KERN_ERR
 "GPÑegi°î†f‹ QBB %d (%p)\n", 
qbbno
, 
gp
);

605 
i
 = 0; i < 4; i++)

606 
	`¥ötk
(
KERN_ERR
 " GPA_QBB_MAP_%d: 0x%16lx\n",

607 
i
, 
gp
->
g∑_qbb_m≠
[i].
c§
);

609 
	`¥ötk
(
KERN_ERR
 " GPA_MEM_POP_MAP: 0x%16lx\n",

610 
gp
->
g∑_mem_p›_m≠
.
c§
);

611 
	`¥ötk
(
KERN_ERR
 " GPA_SCRATCH: 0x%16lx\n", 
gp
->
g∑_s¸©ch
.
c§
);

612 
	`¥ötk
(
KERN_ERR
 " GPA_DIAG: 0x%16lx\n", 
gp
->
g∑_düg
.
c§
);

613 
	`¥ötk
(
KERN_ERR
 " GPA_CONFIG_0: 0x%16lx\n", 
gp
->
g∑_c⁄fig_0
.
c§
);

614 
	`¥ötk
(
KERN_ERR
 " GPA_INIT_ID: 0x%16lx\n", 
gp
->
g∑_öô_id
.
c§
);

615 
	`¥ötk
(
KERN_ERR
 " GPA_CONFIG_2: 0x%16lx\n", 
gp
->
g∑_c⁄fig_2
.
c§
);

617 
	`¥ötk
(
KERN_ERR
 "\n");

618 
	}
}

621 #i‡
DEBUG_DUMP_CONFIG


622 
__öô


623 
	$wûdfúe_dump_h¨dw¨e_c⁄fig
()

625 
i
;

627 
	`¥ötk
(
KERN_ERR
 "Probed Hardware Configuration\n");

629 
	`¥ötk
(
KERN_ERR
 " h¨d_qbb_mask: 0x%16lx\n", 
wûdfúe_h¨d_qbb_mask
);

630 
	`¥ötk
(
KERN_ERR
 " so·_qbb_mask: 0x%16lx\n", 
wûdfúe_so·_qbb_mask
);

632 
	`¥ötk
(
KERN_ERR
 " gp_mask: 0x%16lx\n", 
wûdfúe_gp_mask
);

633 
	`¥ötk
(
KERN_ERR
 " hs_mask: 0x%16lx\n", 
wûdfúe_hs_mask
);

634 
	`¥ötk
(
KERN_ERR
 " i›_mask: 0x%16lx\n", 
wûdfúe_i›_mask
);

635 
	`¥ötk
(
KERN_ERR
 " i‹_mask: 0x%16lx\n", 
wûdfúe_i‹_mask
);

636 
	`¥ötk
(
KERN_ERR
 "Öˇ_mask: 0x%16lx\n", 
wûdfúe_pˇ_mask
);

638 
	`¥ötk
(
KERN_ERR
 " cpu_mask: 0x%16lx\n", 
wûdfúe_˝u_mask
);

639 
	`¥ötk
(
KERN_ERR
 " mem_mask: 0x%16lx\n", 
wûdfúe_mem_mask
);

641 
	`¥ötk
(" hard_qbb_map: ");

642 
i
 = 0; i < 
WILDFIRE_MAX_QBB
; i++)

643 i‡(
wûdfúe_h¨d_qbb_m≠
[
i
] =
QBB_MAP_EMPTY
)

644 
	`¥ötk
("--- ");

646 
	`¥ötk
("%3d ", 
wûdfúe_h¨d_qbb_m≠
[
i
]);

647 
	`¥ötk
("\n");

649 
	`¥ötk
(" soft_qbb_map: ");

650 
i
 = 0; i < 
WILDFIRE_MAX_QBB
; i++)

651 i‡(
wûdfúe_so·_qbb_m≠
[
i
] =
QBB_MAP_EMPTY
)

652 
	`¥ötk
("--- ");

654 
	`¥ötk
("%3d ", 
wûdfúe_so·_qbb_m≠
[
i
]);

655 
	`¥ötk
("\n");

656 
	}
}

	@arch/alpha/kernel/err_common.c

9 
	~<löux/öô.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/io.h
>

13 
	~<asm/hwΩb.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/îr_comm⁄.h
>

17 
	~"îr_im∂.h
"

18 
	~"¥Ÿo.h
"

24 *
	gîr_¥öt_¥efix
 = 
KERN_NOTICE
;

31 
	$mchk_dump_mem
(*
d©a
, 
size_t
 
Àngth
, **
™nŸ©i⁄
)

33 *
ld©a
 = 
d©a
;

34 
size_t
 
i
;

36 
i
 = 0; (ò* (*
ld©a
)Ë< 
Àngth
; i++) {

37 i‡(
™nŸ©i⁄
 && !™nŸ©i⁄[
i
])

38 
™nŸ©i⁄
 = 
NULL
;

39 
	`¥ötk
("%s %08x: %016lx %s\n",

40 
îr_¥öt_¥efix
,

41 ()(
i
 * (*
ld©a
)),Üdata[i],

42 
™nŸ©i⁄
 ?á¬Ÿ©i⁄[
i
] : "");

44 
	}
}

47 
	$mchk_dump_logout_‰ame
(
ñ_comm⁄
 *
mchk_hódî
)

49 
	`¥ötk
("%s -- Frame Header --\n"

57 
îr_¥öt_¥efix
,

58 
mchk_hódî
->
size
, mchk_header->size,

59 
mchk_hódî
->
ªåy
 ? "RETRY " : "",

60 
mchk_hódî
->
îr2
 ? "SECOND_ERR " : "",

61 
mchk_hódî
->
code
,

62 
mchk_hódî
->
‰ame_ªv
,

63 
mchk_hódî
->
¥oc_off£t
,

64 
mchk_hódî
->
sys_off£t
);

66 
	`mchk_dump_mem
((*)

67 (()
mchk_hódî
 + mchk_hódî->
¥oc_off£t
),

68 
mchk_hódî
->
sys_off£t
 - mchk_hódî->
¥oc_off£t
,

69 
NULL
);

71 
	`¥ötk
("%† -- Sy°em Regi⁄ --\n", 
îr_¥öt_¥efix
);

72 
	`mchk_dump_mem
((*)

73 (()
mchk_hódî
 + mchk_hódî->
sys_off£t
),

74 
mchk_hódî
->
size
 - mchk_hódî->
sys_off£t
,

75 
NULL
);

76 
	`¥ötk
("%† -- End o‡Fømê--\n", 
îr_¥öt_¥efix
);

77 
	}
}

84 
ñ_sub∑ckë_h™dÀr
 *
	gsub∑ckë_h™dÀr_li°
 = 
NULL
;

85 
ñ_sub∑ckë_™nŸ©i⁄
 *
	gsub∑ckë_™nŸ©i⁄_li°
 = 
NULL
;

87 
ñ_sub∑ckë
 *

88 
	$ñ_¥o˚ss_hódî_sub∑ckë
(
ñ_sub∑ckë
 *
hódî
)

90 
ñ_time°amp
 
time°amp
;

91 *
«me
 = "UNKNOWN EVENT";

92 
∑ckë_cou¡
 = 0;

93 
Àngth
 = 0;

95 i‡(
hódî
->
˛ass
 !
EL_CLASS__HEADER
) {

96 
	`¥ötk
("%s** Unexpected header CLASS %d TYPE %d,áborting\n",

97 
îr_¥öt_¥efix
,

98 
hódî
->
˛ass
, hódî->
ty≥
);

99  
NULL
;

102 
hódî
->
ty≥
) {

103 
EL_TYPE__HEADER__SYSTEM_ERROR_FRAME
:

104 
«me
 = "SYSTEM ERROR";

105 
Àngth
 = 
hódî
->
by_ty≥
.
sys_îr
.
‰ame_Àngth
;

106 
∑ckë_cou¡
 =

107 
hódî
->
by_ty≥
.
sys_îr
.
‰ame_∑ckë_cou¡
;

108 
time°amp
.
as_öt
 = 0;

110 
EL_TYPE__HEADER__SYSTEM_EVENT_FRAME
:

111 
«me
 = "SYSTEM EVENT";

112 
Àngth
 = 
hódî
->
by_ty≥
.
sys_evít
.
‰ame_Àngth
;

113 
∑ckë_cou¡
 =

114 
hódî
->
by_ty≥
.
sys_evít
.
‰ame_∑ckë_cou¡
;

115 
time°amp
 = 
hódî
->
by_ty≥
.
sys_evít
.timestamp;

117 
EL_TYPE__HEADER__HALT_FRAME
:

118 
«me
 = "ERROR HALT";

119 
Àngth
 = 
hódî
->
by_ty≥
.
îr_hÆt
.
‰ame_Àngth
;

120 
∑ckë_cou¡
 =

121 
hódî
->
by_ty≥
.
îr_hÆt
.
‰ame_∑ckë_cou¡
;

122 
time°amp
 = 
hódî
->
by_ty≥
.
îr_hÆt
.timestamp;

124 
EL_TYPE__HEADER__LOGOUT_FRAME
:

125 
«me
 = "LOGOUT FRAME";

126 
Àngth
 = 
hódî
->
by_ty≥
.
logout_hódî
.
‰ame_Àngth
;

127 
∑ckë_cou¡
 = 1;

128 
time°amp
.
as_öt
 = 0;

131 
	`¥ötk
("%s** Unknown header - CLASS %d TYPE %d,áborting\n",

132 
îr_¥öt_¥efix
,

133 
hódî
->
˛ass
, hódî->
ty≥
);

134  
NULL
;

137 
	`¥ötk
("%s*** %s:\n"

139 
îr_¥öt_¥efix
,

140 
«me
,

141 
hódî
->
˛ass
, hódî->
ty≥
);

142 
	`ñ_¥öt_time°amp
(&
time°amp
);

147 
	`ñ_¥o˚ss_sub∑ckës
(
hódî
, 
∑ckë_cou¡
);

150 
hódî
 = (
ñ_sub∑ckë
 *)

151 (()
hódî
 + hódî->
Àngth
 +Üength);

152  
hódî
;

153 
	}
}

155 
ñ_sub∑ckë
 *

156 
	$ñ_¥o˚ss_sub∑ckë_ªg
(
ñ_sub∑ckë
 *
hódî
)

158 
ñ_sub∑ckë
 *
√xt
 = 
NULL
;

159 
ñ_sub∑ckë_h™dÀr
 *
h
 = 
sub∑ckë_h™dÀr_li°
;

161 ; 
h
 && h->
˛ass
 !
hódî
->˛ass; h = h->
√xt
);

162 i‡(
h
Ë
√xt
 = h->
	`h™dÀr
(
hódî
);

164  
√xt
;

165 
	}
}

168 
	$ñ_¥öt_time°amp
(
ñ_time°amp
 *
time°amp
)

170 i‡(
time°amp
->
as_öt
)

171 
	`¥ötk
("%s TIMESTAMP: %d/%d/%02d %d:%02d:%0d\n",

172 
îr_¥öt_¥efix
,

173 
time°amp
->
b
.
m⁄th
,Åime°amp->b.
day
,

174 
time°amp
->
b
.
yór
,Åime°amp->b.
hour
,

175 
time°amp
->
b
.
möuã
,Åime°amp->b.
£c⁄d
);

176 
	}
}

179 
	$ñ_¥o˚ss_sub∑ckës
(
ñ_sub∑ckë
 *
hódî
, 
∑ckë_cou¡
)

181 
ñ_sub∑ckë
 *
sub∑ckë
;

182 
i
;

184 
sub∑ckë
 = (
ñ_sub∑ckë
 *)

185 (()
hódî
 + hódî->
Àngth
);

187 
i
 = 0; 
sub∑ckë
 && i < 
∑ckë_cou¡
; i++) {

188 
	`¥ötk
("%sPROCESSING SUBPACKET %d\n", 
îr_¥öt_¥efix
, 
i
);

189 
sub∑ckë
 = 
	`ñ_¥o˚ss_sub∑ckë
(subpacket);

191 
	}
}

193 
ñ_sub∑ckë
 *

194 
	$ñ_¥o˚ss_sub∑ckë
(
ñ_sub∑ckë
 *
hódî
)

196 
ñ_sub∑ckë
 *
√xt
 = 
NULL
;

198 
hódî
->
˛ass
) {

199 
EL_CLASS__TERMINATION
:

202 
EL_CLASS__HEADER
:

203 
√xt
 = 
	`ñ_¥o˚ss_hódî_sub∑ckë
(
hódî
);

206 i‡(
NULL
 =(
√xt
 = 
	`ñ_¥o˚ss_sub∑ckë_ªg
(
hódî
))) {

207 
	`¥ötk
("%s** Unexpected header CLASS %d TYPE %d"

209 
îr_¥öt_¥efix
,

210 
hódî
->
˛ass
, hódî->
ty≥
);

215  
√xt
;

216 
	}
}

219 
	$ñ_™nŸ©e_sub∑ckë
(
ñ_sub∑ckë
 *
hódî
)

221 
ñ_sub∑ckë_™nŸ©i⁄
 *
a
;

222 **
™nŸ©i⁄
 = 
NULL
;

224 
a
 = 
sub∑ckë_™nŸ©i⁄_li°
;á;á =á->
√xt
) {

225 i‡(
a
->
˛ass
 =
hódî
->class &&

226 
a
->
ty≥
 =
hódî
->type &&

227 
a
->
ªvisi⁄
 =
hódî
->revision) {

231 
™nŸ©i⁄
 = 
a
->annotation;

232 
	`¥ötk
("%† %s\n", 
îr_¥öt_¥efix
, 
a
->
des¸ùti⁄
);

237 
	`mchk_dump_mem
(
hódî
, hódî->
Àngth
, 
™nŸ©i⁄
);

238 
	}
}

240 
__öô


241 
	$cdl_¥o˚ss_c⁄sﬁe_d©a_log
(
˝u
, 
≥r˝u_°ru˘
 *
p˝u
)

243 
ñ_sub∑ckë
 *
hódî
 = (el_subpacket *)

244 (
IDENT_ADDR
 | 
p˝u
->
c⁄sﬁe_d©a_log_∑
);

245 
îr
;

247 
	`¥ötk
("%s******* CONSOLE DATA LOG FOR CPU %d. *******\n"

249 
îr_¥öt_¥efix
, 
˝u
);

251 
îr
 = 0; 
hódî
 && (hódî->
˛ass
 !
EL_CLASS__TERMINATION
);Érr++)

252 
hódî
 = 
	`ñ_¥o˚ss_sub∑ckë
(header);

255 
p˝u
->
c⁄sﬁe_d©a_log_∑
 = 0;

257 
	`¥ötk
("%s*** %dÅotalÉrror(s)Üogged\n"

259 
îr_¥öt_¥efix
, 
îr
, 
˝u
);

260 
	}
}

262 
__öô


263 
	$cdl_check_c⁄sﬁe_d©a_log
()

265 
≥r˝u_°ru˘
 *
p˝u
;

266 
˝u
;

268 
˝u
 = 0; cpu < 
hwΩb
->
ƒ_¥o˚ss‹s
; cpu++) {

269 
p˝u
 = (
≥r˝u_°ru˘
 *)

270 (()
hwΩb
 + hwΩb->
¥o˚ss‹_off£t


271 + 
˝u
 * 
hwΩb
->
¥o˚ss‹_size
);

272 i‡(
p˝u
->
c⁄sﬁe_d©a_log_∑
)

273 
	`cdl_¥o˚ss_c⁄sﬁe_d©a_log
(
˝u
, 
p˝u
);

276 
	}
}

278 
__öô


279 
	$cdl_ªgi°î_sub∑ckë_™nŸ©i⁄
(
ñ_sub∑ckë_™nŸ©i⁄
 *
√w
)

281 
ñ_sub∑ckë_™nŸ©i⁄
 *
a
 = 
sub∑ckë_™nŸ©i⁄_li°
;

283 i‡(
a
 =
NULL
Ë
sub∑ckë_™nŸ©i⁄_li°
 = 
√w
;

285 ; 
a
->
√xt
 !
NULL
;á =á->next) {

286 i‡((
a
->
˛ass
 =
√w
->˛as†&&á->
ty≥
 ==Çew->type) ||

287 
a
 =
√w
) {

288 
	`¥ötk
("AttemptedÅoÑe-register "

290  -
EINVAL
;

293 
a
->
√xt
 = 
√w
;

295 
√w
->
√xt
 = 
NULL
;

298 
	}
}

300 
__öô


301 
	$cdl_ªgi°î_sub∑ckë_h™dÀr
(
ñ_sub∑ckë_h™dÀr
 *
√w
)

303 
ñ_sub∑ckë_h™dÀr
 *
h
 = 
sub∑ckë_h™dÀr_li°
;

305 i‡(
h
 =
NULL
Ë
sub∑ckë_h™dÀr_li°
 = 
√w
;

307 ; 
h
->
√xt
 !
NULL
; h = h->next) {

308 i‡(
h
->
˛ass
 =
√w
->class || h ==Çew) {

309 
	`¥ötk
("AttemptedÅoÑe-register "

311  -
EINVAL
;

314 
h
->
√xt
 = 
√w
;

316 
√w
->
√xt
 = 
NULL
;

319 
	}
}

	@arch/alpha/kernel/err_ev6.c

9 
	~<löux/öô.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/io.h
>

13 
	~<asm/úq_ªgs.h
>

14 
	~<asm/hwΩb.h
>

15 
	~<asm/smp.h
>

16 
	~<asm/îr_comm⁄.h
>

17 
	~<asm/îr_ev6.h
>

19 
	~"îr_im∂.h
"

20 
	~"¥Ÿo.h
"

23 
	$ev6_∑r£_ibox
(
u64
 
i_°©
, 
¥öt
)

25 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

27 
	#EV6__I_STAT__PAR
 (1UL << 29)

	)

28 
	#EV6__I_STAT__ERRMASK
 (
EV6__I_STAT__PAR
)

	)

30 i‡(!(
i_°©
 & 
EV6__I_STAT__ERRMASK
))

31  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

33 i‡(!
¥öt
)

34  
°©us
;

36 i‡(
i_°©
 & 
EV6__I_STAT__PAR
)

37 
	`¥ötk
("%† Iˇchê∑rôyÉº‹\n", 
îr_¥öt_¥efix
);

39  
°©us
;

40 
	}
}

43 
	$ev6_∑r£_mbox
(
u64
 
mm_°©
, u64 
d_°©
, u64 
c_°©
, 
¥öt
)

45 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

47 
	#EV6__MM_STAT__DC_TAG_PERR
 (1UL << 10)

	)

48 
	#EV6__MM_STAT__ERRMASK
 (
EV6__MM_STAT__DC_TAG_PERR
)

	)

49 
	#EV6__D_STAT__TPERR_P0
 (1UL << 0)

	)

50 
	#EV6__D_STAT__TPERR_P1
 (1UL << 1)

	)

51 
	#EV6__D_STAT__ECC_ERR_ST
 (1UL << 2)

	)

52 
	#EV6__D_STAT__ECC_ERR_LD
 (1UL << 3)

	)

53 
	#EV6__D_STAT__SEO
 (1UL << 4)

	)

54 
	#EV6__D_STAT__ERRMASK
 (
EV6__D_STAT__TPERR_P0
 | \

55 
EV6__D_STAT__TPERR_P1
 | \

56 
EV6__D_STAT__ECC_ERR_ST
 | \

57 
EV6__D_STAT__ECC_ERR_LD
 | \

58 
EV6__D_STAT__SEO
)

	)

60 i‡(!(
d_°©
 & 
EV6__D_STAT__ERRMASK
) &&

61 !(
mm_°©
 & 
EV6__MM_STAT__ERRMASK
))

62  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

64 i‡(!
¥öt
)

65  
°©us
;

67 i‡(
mm_°©
 & 
EV6__MM_STAT__DC_TAG_PERR
)

68 
	`¥ötk
("%s DcacheÅagÖarityÉrror onÖrobe\n",

69 
îr_¥öt_¥efix
);

70 i‡(
d_°©
 & 
EV6__D_STAT__TPERR_P0
)

71 
	`¥ötk
("%s DcacheÅagÖarityÉrror -Öipe 0\n",

72 
îr_¥öt_¥efix
);

73 i‡(
d_°©
 & 
EV6__D_STAT__TPERR_P1
)

74 
	`¥ötk
("%s DcacheÅagÖarityÉrror -Öipe 1\n",

75 
îr_¥öt_¥efix
);

76 i‡(
d_°©
 & 
EV6__D_STAT__ECC_ERR_ST
)

77 
	`¥ötk
("%s ECCÉrror occurred oná store\n",

78 
îr_¥öt_¥efix
);

79 i‡(
d_°©
 & 
EV6__D_STAT__ECC_ERR_LD
)

80 
	`¥ötk
("%s ECCÉrror occurred oná %sÜoad\n",

81 
îr_¥öt_¥efix
,

82 
c_°©
 ? "" : "speculative ");

83 i‡(
d_°©
 & 
EV6__D_STAT__SEO
)

84 
	`¥ötk
("%† Dˇchê£c⁄dÉº‹\n", 
îr_¥öt_¥efix
);

86  
°©us
;

87 
	}
}

90 
	$ev6_∑r£_cbox
(
u64
 
c_addr
, u64 
c1_syn
, u64 
c2_syn
,

91 
u64
 
c_°©
, u64 
c_°s
, 
¥öt
)

93 *
sour˚«me
[] = { "UNKNOWN", "UNKNOWN", "UNKNOWN",

96 *
°ªam«me
[] = { "D", "I" };

97 *
bô¢ame
[] = { "SINGLE", "DOUBLE" };

98 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

99 
sour˚
 = -1, 
°ªam
 = -1, 
bôs
 = -1;

101 
	#EV6__C_STAT__BC_PERR
 (0x01)

	)

102 
	#EV6__C_STAT__DC_PERR
 (0x02)

	)

103 
	#EV6__C_STAT__DSTREAM_MEM_ERR
 (0x03)

	)

104 
	#EV6__C_STAT__DSTREAM_BC_ERR
 (0x04)

	)

105 
	#EV6__C_STAT__DSTREAM_DC_ERR
 (0x05)

	)

106 
	#EV6__C_STAT__PROBE_BC_ERR0
 (0x06Ë

	)

107 
	#EV6__C_STAT__PROBE_BC_ERR1
 (0x07Ë

	)

108 
	#EV6__C_STAT__ISTREAM_MEM_ERR
 (0x0B)

	)

109 
	#EV6__C_STAT__ISTREAM_BC_ERR
 (0x0C)

	)

110 
	#EV6__C_STAT__DSTREAM_MEM_DBL
 (0x13)

	)

111 
	#EV6__C_STAT__DSTREAM_BC_DBL
 (0x14)

	)

112 
	#EV6__C_STAT__ISTREAM_MEM_DBL
 (0x1B)

	)

113 
	#EV6__C_STAT__ISTREAM_BC_DBL
 (0x1C)

	)

114 
	#EV6__C_STAT__SOURCE_MEMORY
 (0x03)

	)

115 
	#EV6__C_STAT__SOURCE_BCACHE
 (0x04)

	)

116 
	#EV6__C_STAT__SOURCE__S
 (0)

	)

117 
	#EV6__C_STAT__SOURCE__M
 (0x07)

	)

118 
	#EV6__C_STAT__ISTREAM__S
 (3)

	)

119 
	#EV6__C_STAT__ISTREAM__M
 (0x01)

	)

120 
	#EV6__C_STAT__DOUBLE__S
 (4)

	)

121 
	#EV6__C_STAT__DOUBLE__M
 (0x01)

	)

122 
	#EV6__C_STAT__ERRMASK
 (0x1F)

	)

123 
	#EV6__C_STS__SHARED
 (1 << 0)

	)

124 
	#EV6__C_STS__DIRTY
 (1 << 1)

	)

125 
	#EV6__C_STS__VALID
 (1 << 2)

	)

126 
	#EV6__C_STS__PARITY
 (1 << 3)

	)

128 i‡(!(
c_°©
 & 
EV6__C_STAT__ERRMASK
))

129  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

131 i‡(!
¥öt
)

132  
°©us
;

134 
sour˚
 = 
	`EXTRACT
(
c_°©
, 
EV6__C_STAT__SOURCE
);

135 
°ªam
 = 
	`EXTRACT
(
c_°©
, 
EV6__C_STAT__ISTREAM
);

136 
bôs
 = 
	`EXTRACT
(
c_°©
, 
EV6__C_STAT__DOUBLE
);

138 i‡(
c_°©
 & 
EV6__C_STAT__BC_PERR
) {

139 
	`¥ötk
("%† BˇchêègÖ¨ôyÉº‹\n", 
îr_¥öt_¥efix
);

140 
sour˚
 = -1;

143 i‡(
c_°©
 & 
EV6__C_STAT__DC_PERR
) {

144 
	`¥ötk
("%† DˇchêègÖ¨ôyÉº‹\n", 
îr_¥öt_¥efix
);

145 
sour˚
 = -1;

148 i‡(
c_°©
 =
EV6__C_STAT__PROBE_BC_ERR0
 ||

149 
c_°©
 =
EV6__C_STAT__PROBE_BC_ERR1
) {

150 
	`¥ötk
("%s Bcache single-bitÉrror onáÖrobe hit\n",

151 
îr_¥öt_¥efix
);

152 
sour˚
 = -1;

155 i‡(
sour˚
 != -1)

156 
	`¥ötk
("%s %s-STREAM %s-BIT ECCÉrror from %s\n",

157 
îr_¥öt_¥efix
,

158 
°ªam«me
[
°ªam
], 
bô¢ame
[
bôs
], 
sour˚«me
[
sour˚
]);

160 
	`¥ötk
("%s Address: 0x%016lx\n"

162 
îr_¥öt_¥efix
,

163 
c_addr
,

164 
c2_syn
, 
c1_syn
);

166 i‡(
sour˚
 =
EV6__C_STAT__SOURCE_MEMORY
 ||

167 
sour˚
 =
EV6__C_STAT__SOURCE_BCACHE
)

168 
	`¥ötk
("%s Block status: %s%s%s%s\n",

169 
îr_¥öt_¥efix
,

170 (
c_°s
 & 
EV6__C_STS__SHARED
) ? "SHARED " : "",

171 (
c_°s
 & 
EV6__C_STS__DIRTY
) ? "DIRTY " : "",

172 (
c_°s
 & 
EV6__C_STS__VALID
) ? "VALID " : "",

173 (
c_°s
 & 
EV6__C_STS__PARITY
) ? "PARITY " : "");

175  
°©us
;

176 
	}
}

179 
	$ev6_ªgi°î_îr‹_h™dÀrs
()

182 
	}
}

185 
	$ev6_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *
mchk_hódî
, 
¥öt
)

187 
ñ_comm⁄_EV6_mcheck
 *
ev6mchk
 =

188 (
ñ_comm⁄_EV6_mcheck
 *)
mchk_hódî
;

189 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

191 
°©us
 |
	`ev6_∑r£_ibox
(
ev6mchk
->
I_STAT
, 
¥öt
);

192 
°©us
 |
	`ev6_∑r£_mbox
(
ev6mchk
->
MM_STAT
,Év6mchk->
DC_STAT
,

193 
ev6mchk
->
C_STAT
, 
¥öt
);

194 
°©us
 |
	`ev6_∑r£_cbox
(
ev6mchk
->
C_ADDR
,Év6mchk->
DC1_SYNDROME
,

195 
ev6mchk
->
DC0_SYNDROME
,Év6mchk->
C_STAT
,

196 
ev6mchk
->
C_STS
, 
¥öt
);

198 i‡(!
¥öt
)

199  
°©us
;

201 i‡(
°©us
 !
MCHK_DISPOSITION_DISMISS
) {

202 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

207 
	`¥ötk
("%s EXC_ADDR: 0x%016lx IER_CM: 0x%016lx"

211 
îr_¥öt_¥efix
,

212 
ev6mchk
->
EXC_ADDR
,Év6mchk->
IER_CM
,Év6mchk->
ISUM
,

213 
ev6mchk
->
PAL_BASE
,Év6mchk->
I_CTL
,Év6mchk->
PCTX
);

215 i‡(
°©us
 =
MCHK_DISPOSITION_UNKNOWN_ERROR
) {

216 
	`¥ötk
("%s UNKNOWNÉrror, frame follows:\n",

217 
îr_¥öt_¥efix
);

220 
îr_¥öt_¥efix
 = 
KERN_NOTICE
;

223 
	`mchk_dump_logout_‰ame
(
mchk_hódî
);

225 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

228  
°©us
;

229 
	}
}

232 
	$ev6_machöe_check
(
u64
 
ve˘‹
, u64 
œ_±r
)

234 
ñ_comm⁄
 *
mchk_hódî
 = (ñ_comm⁄ *)
œ_±r
;

239 
	`mb
();

240 
	`døöa
();

247 i‡(
	`ev6_¥o˚ss_logout_‰ame
(
mchk_hódî
, 0) !=

248 
MCHK_DISPOSITION_DISMISS
) {

249 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

250 
îr_¥öt_¥efix
 = 
KERN_CRIT
;

257 
	`¥ötk
("%s*CPU %s Error (Vector 0x%x)Ñeported on CPU %d:\n",

258 
îr_¥öt_¥efix
,

259 (
ve˘‹
 =
SCB_Q_PROCERR
)?"Correctable":"Uncorrectable",

260 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

262 
	`ev6_¥o˚ss_logout_‰ame
(
mchk_hódî
, 1);

263 
	`dik_show_ªgs
(
	`gë_úq_ªgs
(), 
NULL
);

265 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

271 
	`wrm˚s
(0x7);

272 
	`mb
();

273 
	}
}

	@arch/alpha/kernel/err_ev7.c

9 
	~<löux/öô.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/io.h
>

13 
	~<asm/hwΩb.h
>

14 
	~<asm/smp.h
>

15 
	~<asm/îr_comm⁄.h
>

16 
	~<asm/îr_ev7.h
>

18 
	~"îr_im∂.h
"

19 
	~"¥Ÿo.h
"

21 
ev7_lf_sub∑ckës
 *

22 
	$ev7_cﬁÀ˘_logout_‰ame_sub∑ckës
(
ñ_sub∑ckë
 *
ñ_±r
,

23 
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
)

25 
ñ_sub∑ckë
 *
sub∑ckë
;

26 
i
;

32 i‡(
ñ_±r
->
˛ass
 !
EL_CLASS__HEADER
 ||

33 
ñ_±r
->
ty≥
 !
EL_TYPE__HEADER__LOGOUT_FRAME
)

34  
NULL
;

39 
ñ_±r
 = (
ñ_sub∑ckë
 *)

40 (()
ñ_±r
 +Él_±r->
Àngth
);

45 i‡(
ñ_±r
->
˛ass
 !
EL_CLASS__PAL
 ||

46 
ñ_±r
->
ty≥
 !
EL_TYPE__PAL__LOGOUT_FRAME
)

47  
NULL
;

49 
lf_sub∑ckës
->
logout
 = (
ev7_∑l_logout_sub∑ckë
 *)

50 
ñ_±r
->
by_ty≥
.
øw
.
d©a_°¨t
;

55 
sub∑ckë
 = (
ñ_sub∑ckë
 *)

56 (()
ñ_±r
 +Él_±r->
Àngth
);

57 
i
 = 0;

58 
sub∑ckë
 && 
i
 < 
lf_sub∑ckës
->
logout
->
sub∑ckë_cou¡
;

59 
sub∑ckë
 = (
ñ_sub∑ckë
 *)

60 (()
sub∑ckë
 + sub∑ckë->
Àngth
), 
i
++) {

64 i‡(
sub∑ckë
->
˛ass
 !
EL_CLASS__PAL
) {

65 
	`¥ötk
("%s**UNEXPECTED SUBPACKET CLASS %d "

67 
îr_¥öt_¥efix
, 
sub∑ckë
->
˛ass
, 
i
);

68  
NULL
;

74 
sub∑ckë
->
ty≥
) {

75 
EL_TYPE__PAL__EV7_PROCESSOR
:

76 
lf_sub∑ckës
->
ev7
 =

77 (
ev7_∑l_¥o˚ss‹_sub∑ckë
 *)

78 
sub∑ckë
->
by_ty≥
.
øw
.
d©a_°¨t
;

81 
EL_TYPE__PAL__EV7_RBOX
:

82 
lf_sub∑ckës
->
rbox
 = (
ev7_∑l_rbox_sub∑ckë
 *)

83 
sub∑ckë
->
by_ty≥
.
øw
.
d©a_°¨t
;

86 
EL_TYPE__PAL__EV7_ZBOX
:

87 
lf_sub∑ckës
->
zbox
 = (
ev7_∑l_zbox_sub∑ckë
 *)

88 
sub∑ckë
->
by_ty≥
.
øw
.
d©a_°¨t
;

91 
EL_TYPE__PAL__EV7_IO
:

92 
lf_sub∑ckës
->
io
 = (
ev7_∑l_io_sub∑ckë
 *)

93 
sub∑ckë
->
by_ty≥
.
øw
.
d©a_°¨t
;

96 
EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE
:

97 
EL_TYPE__PAL__ENV__AIRMOVER_FAN
:

98 
EL_TYPE__PAL__ENV__VOLTAGE
:

99 
EL_TYPE__PAL__ENV__INTRUSION
:

100 
EL_TYPE__PAL__ENV__POWER_SUPPLY
:

101 
EL_TYPE__PAL__ENV__LAN
:

102 
EL_TYPE__PAL__ENV__HOT_PLUG
:

103 
lf_sub∑ckës
->
ív
[
	`ev7_lf_ív_ödex
(
sub∑ckë
->
ty≥
)] =

104 (
ev7_∑l_ívú⁄míèl_sub∑ckë
 *)

105 
sub∑ckë
->
by_ty≥
.
øw
.
d©a_°¨t
;

112  
NULL
;

116  
lf_sub∑ckës
;

117 
	}
}

120 
	$ev7_machöe_check
(
u64
 
ve˘‹
, u64 
œ_±r
)

122 
ñ_sub∑ckë
 *
ñ_±r
 = (ñ_sub∑ckë *)
œ_±r
;

123 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

128 
	`mb
();

129 
	`døöa
();

131 
îr_¥öt_¥efix
 = 
KERN_CRIT
;

132 
	`¥ötk
("%s*CPU %s Error (Vector 0x%x)Ñeported on CPU %d\n",

133 
îr_¥öt_¥efix
,

134 (
ve˘‹
 =
SCB_Q_PROCERR
) ? "Correctable" : "Uncorrectable",

135 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

136 
	`ñ_¥o˚ss_sub∑ckë
(
ñ_±r
);

137 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

142 
	`wrm˚s
(0x7);

143 
	`mb
();

144 
	}
}

146 *
	gñ_ev7_¥o˚ss‹_sub∑ckë_™nŸ©i⁄
[] = {

155 "BBOX_DAT_RMP", 
NULL


158 *
	gñ_ev7_zbox_sub∑ckë_™nŸ©i⁄
[] = {

173 
NULL


176 *
	gñ_ev7_rbox_sub∑ckë_™nŸ©i⁄
[] = {

182 "RBOX_INTQ", "RBOX_INT", 
NULL


185 *
	gñ_ev7_io_sub∑ckë_™nŸ©i⁄
[] = {

207 
NULL


210 
ñ_sub∑ckë_™nŸ©i⁄
 
	gñ_ev7_∑l_™nŸ©i⁄s
[] = {

211 
SUBPACKET_ANNOTATION
(
EL_CLASS__PAL
,

212 
EL_TYPE__PAL__EV7_PROCESSOR
,

215 
ñ_ev7_¥o˚ss‹_sub∑ckë_™nŸ©i⁄
),

216 
SUBPACKET_ANNOTATION
(
EL_CLASS__PAL
,

217 
EL_TYPE__PAL__EV7_ZBOX
,

220 
ñ_ev7_zbox_sub∑ckë_™nŸ©i⁄
),

221 
SUBPACKET_ANNOTATION
(
EL_CLASS__PAL
,

222 
EL_TYPE__PAL__EV7_RBOX
,

225 
ñ_ev7_rbox_sub∑ckë_™nŸ©i⁄
),

226 
SUBPACKET_ANNOTATION
(
EL_CLASS__PAL
,

227 
EL_TYPE__PAL__EV7_IO
,

230 
ñ_ev7_io_sub∑ckë_™nŸ©i⁄
)

233 
ñ_sub∑ckë
 *

234 
	$ev7_¥o˚ss_∑l_sub∑ckë
(
ñ_sub∑ckë
 *
hódî
)

236 
ev7_∑l_sub∑ckë
 *
∑ckë
;

238 i‡(
hódî
->
˛ass
 !
EL_CLASS__PAL
) {

239 
	`¥ötk
("%s ** Unexpected header CLASS %d TYPE %d,áborting\n",

240 
îr_¥öt_¥efix
,

241 
hódî
->
˛ass
, hódî->
ty≥
);

242  
NULL
;

245 
∑ckë
 = (
ev7_∑l_sub∑ckë
 *)
hódî
->
by_ty≥
.
øw
.
d©a_°¨t
;

247 
hódî
->
ty≥
) {

248 
EL_TYPE__PAL__LOGOUT_FRAME
:

249 
	`¥ötk
("%s*** MCHK occurred on LPID %ld (RBOX %lx)\n",

250 
îr_¥öt_¥efix
,

251 
∑ckë
->
by_ty≥
.
logout
.
whami
,

252 
∑ckë
->
by_ty≥
.
logout
.
rbox_whami
);

253 
	`ñ_¥öt_time°amp
(&
∑ckë
->
by_ty≥
.
logout
.
time°amp
);

254 
	`¥ötk
("%s EXC_ADDR: %016lx\n"

256 
îr_¥öt_¥efix
,

257 
∑ckë
->
by_ty≥
.
logout
.
exc_addr
,

258 
∑ckë
->
by_ty≥
.
logout
.
hÆt_code
);

259 
	`ñ_¥o˚ss_sub∑ckës
(
hódî
,

260 
∑ckë
->
by_ty≥
.
logout
.
sub∑ckë_cou¡
);

263 
	`¥ötk
("%s ** PAL TYPE %d SUBPACKET\n",

264 
îr_¥öt_¥efix
,

265 
hódî
->
ty≥
);

266 
	`ñ_™nŸ©e_sub∑ckë
(
hódî
);

270  (
ñ_sub∑ckë
 *)(()
hódî
 + hódî->
Àngth
);

271 
	}
}

273 
ñ_sub∑ckë_h™dÀr
 
	gev7_∑l_sub∑ckë_h™dÀr
 =

274 
SUBPACKET_HANDLER_INIT
(
EL_CLASS__PAL
, 
ev7_¥o˚ss_∑l_sub∑ckë
);

277 
	$ev7_ªgi°î_îr‹_h™dÀrs
()

279 
i
;

281 
i
 = 0; i < 
	`ARRAY_SIZE
(
ñ_ev7_∑l_™nŸ©i⁄s
); i++)

282 
	`cdl_ªgi°î_sub∑ckë_™nŸ©i⁄
(&
ñ_ev7_∑l_™nŸ©i⁄s
[
i
]);

284 
	`cdl_ªgi°î_sub∑ckë_h™dÀr
(&
ev7_∑l_sub∑ckë_h™dÀr
);

285 
	}
}

	@arch/alpha/kernel/err_impl.h

10 
	gñ_time°amp
;

11 
	gñ_sub∑ckë
;

12 
	gev7_lf_sub∑ckës
;

14 
	sñ_sub∑ckë_™nŸ©i⁄
 {

15 
ñ_sub∑ckë_™nŸ©i⁄
 *
	m√xt
;

16 
u16
 
	m˛ass
;

17 
u16
 
	mty≥
;

18 
u16
 
	mªvisi⁄
;

19 *
	mdes¸ùti⁄
;

20 **
	m™nŸ©i⁄
;

22 
	#SUBPACKET_ANNOTATION
(
c
, 
t
, 
r
, 
d
, 
a
Ë{
NULL
, (c), (t), (r), (d), (a)}

	)

24 
	sñ_sub∑ckë_h™dÀr
 {

25 
ñ_sub∑ckë_h™dÀr
 *
	m√xt
;

26 
u16
 
	m˛ass
;

27 
	mñ_sub∑ckë
 *(*
	mh™dÀr
)(el_subpacket *);

29 
	#SUBPACKET_HANDLER_INIT
(
c
, 
h
Ë{
NULL
, (c), (h)}

	)

38 
	#EXTRACT
(
u
, 
f
Ë(((uË>> f##
__S
Ë& f##
__M
)

	)

39 
	#GEN_MASK
(
f
Ë((
u64
)f##
__M
 << f##
__S
)

	)

44 *
îr_¥öt_¥efix
;

46 
mchk_dump_mem
(*, 
size_t
, **);

47 
mchk_dump_logout_‰ame
(
ñ_comm⁄
 *);

48 
ñ_¥öt_time°amp
(
ñ_time°amp
 *);

49 
ñ_¥o˚ss_sub∑ckës
(
ñ_sub∑ckë
 *, );

50 
ñ_sub∑ckë
 *
ñ_¥o˚ss_sub∑ckë
(el_subpacket *);

51 
ñ_™nŸ©e_sub∑ckë
(
ñ_sub∑ckë
 *);

52 
cdl_check_c⁄sﬁe_d©a_log
();

53 
cdl_ªgi°î_sub∑ckë_™nŸ©i⁄
(
ñ_sub∑ckë_™nŸ©i⁄
 *);

54 
cdl_ªgi°î_sub∑ckë_h™dÀr
(
ñ_sub∑ckë_h™dÀr
 *);

59 
ev7_lf_sub∑ckës
 *

60 
ev7_cﬁÀ˘_logout_‰ame_sub∑ckës
(
ñ_sub∑ckë
 *,

61 
ev7_lf_sub∑ckës
 *);

62 
ev7_ªgi°î_îr‹_h™dÀrs
();

63 
ev7_machöe_check
(
u64
, u64);

68 
ev6_ªgi°î_îr‹_h™dÀrs
();

69 
ev6_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *, );

70 
ev6_machöe_check
(
u64
, u64);

75 
m¨vñ_machöe_check
(
u64
, u64);

76 
m¨vñ_ªgi°î_îr‹_h™dÀrs
();

81 
tô™_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *, );

82 
tô™_machöe_check
(
u64
, u64);

83 
tô™_ªgi°î_îr‹_h™dÀrs
();

84 
¥iv©ìr_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *, );

85 
¥iv©ìr_machöe_check
(
u64
, u64);

	@arch/alpha/kernel/err_marvel.c

8 
	~<löux/öô.h
>

9 
	~<löux/pci.h
>

10 
	~<löux/sched.h
>

12 
	~<asm/io.h
>

13 
	~<asm/c⁄sﬁe.h
>

14 
	~<asm/c‹e_m¨vñ.h
>

15 
	~<asm/hwΩb.h
>

16 
	~<asm/smp.h
>

17 
	~<asm/îr_comm⁄.h
>

18 
	~<asm/îr_ev7.h
>

20 
	~"îr_im∂.h
"

21 
	~"¥Ÿo.h
"

24 
	$m¨vñ_¥öt_680_‰ame
(
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
)

26 #ifde‡
CONFIG_VERBOSE_MCHECK


27 
ev7_∑l_ívú⁄míèl_sub∑ckë
 *
ív
;

28 °ru˘ { 
ty≥
; *
«me
; } 
ev_∑ckës
[] = {

29 { 
EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE
,

31 { 
EL_TYPE__PAL__ENV__AIRMOVER_FAN
,

33 { 
EL_TYPE__PAL__ENV__VOLTAGE
,

35 { 
EL_TYPE__PAL__ENV__INTRUSION
,

37 { 
EL_TYPE__PAL__ENV__POWER_SUPPLY
,

39 { 
EL_TYPE__PAL__ENV__LAN
,

41 { 
EL_TYPE__PAL__ENV__HOT_PLUG
,

43 { 0, 
NULL
 }

45 
i
;

47 
i
 = 0; 
ev_∑ckës
[i].
ty≥
 != 0; i++) {

48 
ív
 = 
lf_sub∑ckës
->ív[
	`ev7_lf_ív_ödex
(
ev_∑ckës
[
i
].
ty≥
)];

49 i‡(!
ív
)

52 
	`¥ötk
("%s**%sÉvent (cabinet %d, drawer %d)\n",

53 
îr_¥öt_¥efix
,

54 
ev_∑ckës
[
i
].
«me
,

55 
ív
->
ˇböë
,

56 
ív
->
døwî
);

57 
	`¥ötk
("%s Module Type: 0x%x - Unit ID 0x%x - "

59 
îr_¥öt_¥efix
,

60 
ív
->
moduÀ_ty≥
,

61 
ív
->
unô_id
,

62 
ív
->
c⁄dôi⁄
);

65 
	}
}

68 
	$m¨vñ_¥o˚ss_680_‰ame
(
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
, 
¥öt
)

70 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

71 
i
;

73 
i
 = 
	`ev7_lf_ív_ödex
(
EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE
);

74 
i
 <
	`ev7_lf_ív_ödex
(
EL_TYPE__PAL__ENV__HOT_PLUG
);

75 
i
++) {

76 i‡(
lf_sub∑ckës
->
ív
[
i
])

77 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

80 i‡(
¥öt
)

81 
	`m¨vñ_¥öt_680_‰ame
(
lf_sub∑ckës
);

83  
°©us
;

84 
	}
}

86 #ifde‡
CONFIG_VERBOSE_MCHECK


89 
	$m¨vñ_¥öt_îr_cyc
(
u64
 
îr_cyc
)

91 *
∑ckë_desc
[] = {

103 
	#IO7__ERR_CYC__ODD_FLT
 (1UL << 0)

	)

104 
	#IO7__ERR_CYC__EVN_FLT
 (1UL << 1)

	)

105 
	#IO7__ERR_CYC__PACKET__S
 (6)

	)

106 
	#IO7__ERR_CYC__PACKET__M
 (0x7)

	)

107 
	#IO7__ERR_CYC__LOC
 (1UL << 5)

	)

108 
	#IO7__ERR_CYC__CYCLE__S
 (2)

	)

109 
	#IO7__ERR_CYC__CYCLE__M
 (0x7)

	)

111 
	`¥ötk
("%s Packet In Error: %s\n"

113 
îr_¥öt_¥efix
,

114 
∑ckë_desc
[
	`EXTRACT
(
îr_cyc
, 
IO7__ERR_CYC__PACKET
)],

115 
îr_¥öt_¥efix
,

116 (
îr_cyc
 & 
IO7__ERR_CYC__LOC
) ? "DATA" : "HEADER",

117 
	`EXTRACT
(
îr_cyc
, 
IO7__ERR_CYC__CYCLE
),

118 (
îr_cyc
 & 
IO7__ERR_CYC__ODD_FLT
) ? " [ODD Flit]": "",

119 (
îr_cyc
 & 
IO7__ERR_CYC__EVN_FLT
) ? " [Even Flit]": "");

120 
	}
}

123 
	$m¨vñ_¥öt_po7_¸r˘_sym
(
u64
 
¸r˘_sym
)

125 
	#IO7__PO7_CRRCT_SYM__SYN__S
 (0)

	)

126 
	#IO7__PO7_CRRCT_SYM__SYN__M
 (0x7f)

	)

127 
	#IO7__PO7_CRRCT_SYM__ERR_CYC__S
 (7Ë

	)

128 
	#IO7__PO7_CRRCT_SYM__ERR_CYC__M
 (0x1ff)

	)

131 
	`¥ötk
("%s Correctable Error Symptoms:\n"

133 
îr_¥öt_¥efix
,

134 
îr_¥öt_¥efix
, 
	`EXTRACT
(
¸r˘_sym
, 
IO7__PO7_CRRCT_SYM__SYN
));

135 
	`m¨vñ_¥öt_îr_cyc
(
	`EXTRACT
(
¸r˘_sym
, 
IO7__PO7_CRRCT_SYM__ERR_CYC
));

136 
	}
}

139 
	$m¨vñ_¥öt_po7_un¸r_sym
(
u64
 
un¸r_sym
, u64 
vÆid_mask
)

141 *
˛k_«mes
[] = { "_h[0]", "_h[1]", "_n[0]", "_n[1]" };

142 *
˛k_decode
[] = {

148 *
p‹t_«mes
[] = { "Port 0", "Port 1",

152 
s¸©ch
, 
i
;

154 
	#IO7__PO7_UNCRR_SYM__SYN__S
 (0)

	)

155 
	#IO7__PO7_UNCRR_SYM__SYN__M
 (0x7f)

	)

156 
	#IO7__PO7_UNCRR_SYM__ERR_CYC__S
 (7Ë

	)

157 
	#IO7__PO7_UNCRR_SYM__ERR_CYC__M
 (0x1ffË

	)

158 
	#IO7__PO7_UNCRR_SYM__CLK__S
 (16)

	)

159 
	#IO7__PO7_UNCRR_SYM__CLK__M
 (0xff)

	)

160 
	#IO7__PO7_UNCRR_SYM__CDT_OVF_TO__REQ
 (1UL << 24)

	)

161 
	#IO7__PO7_UNCRR_SYM__CDT_OVF_TO__RIO
 (1UL << 25)

	)

162 
	#IO7__PO7_UNCRR_SYM__CDT_OVF_TO__WIO
 (1UL << 26)

	)

163 
	#IO7__PO7_UNCRR_SYM__CDT_OVF_TO__BLK
 (1UL << 27)

	)

164 
	#IO7__PO7_UNCRR_SYM__CDT_OVF_TO__NBK
 (1UL << 28)

	)

165 
	#IO7__PO7_UNCRR_SYM__OVF__READIO
 (1UL << 29)

	)

166 
	#IO7__PO7_UNCRR_SYM__OVF__WRITEIO
 (1UL << 30)

	)

167 
	#IO7__PO7_UNCRR_SYM__OVF__FWD
 (1UL << 31)

	)

168 
	#IO7__PO7_UNCRR_SYM__VICTIM_SP__S
 (32)

	)

169 
	#IO7__PO7_UNCRR_SYM__VICTIM_SP__M
 (0xff)

	)

170 
	#IO7__PO7_UNCRR_SYM__DETECT_SP__S
 (40)

	)

171 
	#IO7__PO7_UNCRR_SYM__DETECT_SP__M
 (0xff)

	)

172 
	#IO7__PO7_UNCRR_SYM__STRV_VTR__S
 (48)

	)

173 
	#IO7__PO7_UNCRR_SYM__STRV_VTR__M
 (0x3ff)

	)

175 
	#IO7__STRV_VTR__LSI__INTX__S
 (0)

	)

176 
	#IO7__STRV_VTR__LSI__INTX__M
 (0x3)

	)

177 
	#IO7__STRV_VTR__LSI__SLOT__S
 (2)

	)

178 
	#IO7__STRV_VTR__LSI__SLOT__M
 (0x7)

	)

179 
	#IO7__STRV_VTR__LSI__BUS__S
 (5)

	)

180 
	#IO7__STRV_VTR__LSI__BUS__M
 (0x3)

	)

181 
	#IO7__STRV_VTR__MSI__INTNUM__S
 (0)

	)

182 
	#IO7__STRV_VTR__MSI__INTNUM__M
 (0x1ff)

	)

183 
	#IO7__STRV_VTR__IS_MSI
 (1UL << 9)

	)

185 
	`¥ötk
("%† Unc‹ª˘abÀ Eº‹ Sym±oms:\n", 
îr_¥öt_¥efix
);

186 
un¸r_sym
 &
vÆid_mask
;

188 i‡(
	`EXTRACT
(
vÆid_mask
, 
IO7__PO7_UNCRR_SYM__SYN
))

189 
	`¥ötk
("%s Syndrome: 0x%lx\n",

190 
îr_¥öt_¥efix
,

191 
	`EXTRACT
(
un¸r_sym
, 
IO7__PO7_UNCRR_SYM__SYN
));

193 i‡(
	`EXTRACT
(
vÆid_mask
, 
IO7__PO7_UNCRR_SYM__ERR_CYC
))

194 
	`m¨vñ_¥öt_îr_cyc
(
	`EXTRACT
(
un¸r_sym
,

195 
IO7__PO7_UNCRR_SYM__ERR_CYC
));

197 
s¸©ch
 = 
	`EXTRACT
(
un¸r_sym
, 
IO7__PO7_UNCRR_SYM__CLK
);

198 
i
 = 0; i < 4; i++, 
s¸©ch
 >>= 2) {

199 i‡(
s¸©ch
 & 0x3)

200 
	`¥ötk
("%s Clock %s: %s\n",

201 
îr_¥öt_¥efix
,

202 
˛k_«mes
[
i
], 
˛k_decode
[
s¸©ch
 & 0x3]);

205 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__CDT_OVF_TO__REQ
)

206 
	`¥ötk
("%s REQ Credit Timeout or Overflow\n",

207 
îr_¥öt_¥efix
);

208 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__CDT_OVF_TO__RIO
)

209 
	`¥ötk
("%s RIO Credit Timeout or Overflow\n",

210 
îr_¥öt_¥efix
);

211 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__CDT_OVF_TO__WIO
)

212 
	`¥ötk
("%s WIO Credit Timeout or Overflow\n",

213 
îr_¥öt_¥efix
);

214 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__CDT_OVF_TO__BLK
)

215 
	`¥ötk
("%s BLK Credit Timeout or Overflow\n",

216 
îr_¥öt_¥efix
);

217 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__CDT_OVF_TO__NBK
)

218 
	`¥ötk
("%s NBK Credit Timeout or Overflow\n",

219 
îr_¥öt_¥efix
);

221 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__OVF__READIO
)

222 
	`¥ötk
("%s Read I/O Buffer Overflow\n",

223 
îr_¥öt_¥efix
);

224 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__OVF__WRITEIO
)

225 
	`¥ötk
("%s Write I/O Buffer Overflow\n",

226 
îr_¥öt_¥efix
);

227 i‡(
un¸r_sym
 & 
IO7__PO7_UNCRR_SYM__OVF__FWD
)

228 
	`¥ötk
("%s FWD Buffer Overflow\n",

229 
îr_¥öt_¥efix
);

231 i‡((
s¸©ch
 = 
	`EXTRACT
(
un¸r_sym
, 
IO7__PO7_UNCRR_SYM__VICTIM_SP
))) {

232 
lo°
 = 
s¸©ch
 & (1UL << 4);

233 
s¸©ch
 &~
lo°
;

234 
i
 = 0; i < 8; i++, 
s¸©ch
 >>= 1) {

235 i‡(!(
s¸©ch
 & 1))

237 
	`¥ötk
("%s Error Response sentÅo %s",

238 
îr_¥öt_¥efix
, 
p‹t_«mes
[
i
]);

240 i‡(
lo°
)

241 
	`¥ötk
("%s Lost Error sent somewhereÉlse\n",

242 
îr_¥öt_¥efix
);

245 i‡((
s¸©ch
 = 
	`EXTRACT
(
un¸r_sym
, 
IO7__PO7_UNCRR_SYM__DETECT_SP
))) {

246 
i
 = 0; i < 8; i++, 
s¸©ch
 >>= 1) {

247 i‡(!(
s¸©ch
 & 1))

249 
	`¥ötk
("%s Error Reported by %s",

250 
îr_¥öt_¥efix
, 
p‹t_«mes
[
i
]);

254 i‡(
	`EXTRACT
(
vÆid_mask
, 
IO7__PO7_UNCRR_SYM__STRV_VTR
)) {

255 
°¨v©i⁄_mesßge
[80];

257 
s¸©ch
 = 
	`EXTRACT
(
un¸r_sym
, 
IO7__PO7_UNCRR_SYM__STRV_VTR
);

258 i‡(
s¸©ch
 & 
IO7__STRV_VTR__IS_MSI
)

259 
	`•rötf
(
°¨v©i⁄_mesßge
,

261 
	`EXTRACT
(
s¸©ch
, 
IO7__STRV_VTR__MSI__INTNUM
));

263 
	`•rötf
(
°¨v©i⁄_mesßge
,

265 'A' + 
	`EXTRACT
(
s¸©ch
,

266 
IO7__STRV_VTR__LSI__INTX
),

267 
	`EXTRACT
(
s¸©ch
, 
IO7__STRV_VTR__LSI__BUS
),

268 
	`EXTRACT
(
s¸©ch
, 
IO7__STRV_VTR__LSI__SLOT
));

270 
	`¥ötk
("%s Starvation Int Trigger By: %s\n",

271 
îr_¥öt_¥efix
, 
°¨v©i⁄_mesßge
);

273 
	}
}

276 
	$m¨vñ_¥öt_po7_ugbge_sym
(
u64
 
ugbge_sym
)

278 
›code_°r
[10];

280 
	#IO7__PO7_UGBGE_SYM__UPH_PKT_OFF__S
 (6)

	)

281 
	#IO7__PO7_UGBGE_SYM__UPH_PKT_OFF__M
 (0xfffffffful)

	)

282 
	#IO7__PO7_UGBGE_SYM__UPH_OPCODE__S
 (40)

	)

283 
	#IO7__PO7_UGBGE_SYM__UPH_OPCODE__M
 (0xff)

	)

284 
	#IO7__PO7_UGBGE_SYM__UPH_SRC_PORT__S
 (48)

	)

285 
	#IO7__PO7_UGBGE_SYM__UPH_SRC_PORT__M
 (0xf)

	)

286 
	#IO7__PO7_UGBGE_SYM__UPH_DEST_PID__S
 (52)

	)

287 
	#IO7__PO7_UGBGE_SYM__UPH_DEST_PID__M
 (0x7ff)

	)

288 
	#IO7__PO7_UGBGE_SYM__VALID
 (1UL << 63)

	)

290 i‡(!(
ugbge_sym
 & 
IO7__PO7_UGBGE_SYM__VALID
))

293 
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_OPCODE
)) {

295 
	`•rötf
(
›code_°r
, "Wr32");

298 
	`•rötf
(
›code_°r
, "WrQW");

301 
	`•rötf
(
›code_°r
, "WrIPR");

304 
	`•rötf
(
›code_°r
, "Victim");

307 
	`•rötf
(
›code_°r
, "BlkIO");

310 
	`•rötf
(
›code_°r
, "0x%lx\n",

311 
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_OPCODE
));

315 
	`¥ötk
("%s Up Hose Garbage Symptom:\n"

317 
îr_¥öt_¥efix
,

318 
îr_¥öt_¥efix
,

319 
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_SRC_PORT
),

320 
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_DEST_PID
),

321 
›code_°r
);

323 i‡(0xC5 !
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_OPCODE
))

324 
	`¥ötk
("%s Packet Offset 0x%08lx\n",

325 
îr_¥öt_¥efix
,

326 
	`EXTRACT
(
ugbge_sym
, 
IO7__PO7_UGBGE_SYM__UPH_PKT_OFF
));

327 
	}
}

330 
	$m¨vñ_¥öt_po7_îr_sum
(
ev7_∑l_io_sub∑ckë
 *
io
)

332 
u64
 
un¸r_sym_vÆid
 = 0;

334 
	#IO7__PO7_ERRSUM__CR_SBE
 (1UL << 32)

	)

335 
	#IO7__PO7_ERRSUM__CR_SBE2
 (1UL << 33)

	)

336 
	#IO7__PO7_ERRSUM__CR_PIO_WBYTE
 (1UL << 34)

	)

337 
	#IO7__PO7_ERRSUM__CR_CSR_NXM
 (1UL << 35)

	)

338 
	#IO7__PO7_ERRSUM__CR_RPID_ACV
 (1UL << 36)

	)

339 
	#IO7__PO7_ERRSUM__CR_RSP_NXM
 (1UL << 37)

	)

340 
	#IO7__PO7_ERRSUM__CR_ERR_RESP
 (1UL << 38)

	)

341 
	#IO7__PO7_ERRSUM__CR_CLK_DERR
 (1UL << 39)

	)

342 
	#IO7__PO7_ERRSUM__CR_DAT_DBE
 (1UL << 40)

	)

343 
	#IO7__PO7_ERRSUM__CR_DAT_GRBG
 (1UL << 41)

	)

344 
	#IO7__PO7_ERRSUM__MAF_TO
 (1UL << 42)

	)

345 
	#IO7__PO7_ERRSUM__UGBGE
 (1UL << 43)

	)

346 
	#IO7__PO7_ERRSUM__UN_MAF_LOST
 (1UL << 44)

	)

347 
	#IO7__PO7_ERRSUM__UN_PKT_OVF
 (1UL << 45)

	)

348 
	#IO7__PO7_ERRSUM__UN_CDT_OVF
 (1UL << 46)

	)

349 
	#IO7__PO7_ERRSUM__UN_DEALLOC
 (1UL << 47)

	)

350 
	#IO7__PO7_ERRSUM__BH_CDT_TO
 (1UL << 51)

	)

351 
	#IO7__PO7_ERRSUM__BH_CLK_HDR
 (1UL << 52)

	)

352 
	#IO7__PO7_ERRSUM__BH_DBE_HDR
 (1UL << 53)

	)

353 
	#IO7__PO7_ERRSUM__BH_GBG_HDR
 (1UL << 54)

	)

354 
	#IO7__PO7_ERRSUM__BH_BAD_CMD
 (1UL << 55)

	)

355 
	#IO7__PO7_ERRSUM__HLT_INT
 (1UL << 56)

	)

356 
	#IO7__PO7_ERRSUM__HP_INT
 (1UL << 57)

	)

357 
	#IO7__PO7_ERRSUM__CRD_INT
 (1UL << 58)

	)

358 
	#IO7__PO7_ERRSUM__STV_INT
 (1UL << 59)

	)

359 
	#IO7__PO7_ERRSUM__HRD_INT
 (1UL << 60)

	)

360 
	#IO7__PO7_ERRSUM__BH_SUM
 (1UL << 61)

	)

361 
	#IO7__PO7_ERRSUM__ERR_LST
 (1UL << 62)

	)

362 
	#IO7__PO7_ERRSUM__ERR_VALID
 (1UL << 63)

	)

364 
	#IO7__PO7_ERRSUM__ERR_MASK
 (
IO7__PO7_ERRSUM__ERR_VALID
 | \

365 
IO7__PO7_ERRSUM__CR_SBE
)

	)

370 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_SBE
) {

371 
	`¥ötk
("%s %sSingle Bit Error(s) detected/corrected\n",

372 
îr_¥öt_¥efix
,

373 (
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_SBE2
)

375 
	`m¨vñ_¥öt_po7_¸r˘_sym
(
io
->
po7_¸r˘_sym
);

381 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__HLT_INT
)

382 
	`¥ötk
("%† HÆàI¡îru±Öo°ed", 
îr_¥öt_¥efix
);

383 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__HP_INT
) {

384 
	`¥ötk
("%s Hot Plug Event InterruptÖosted",

385 
îr_¥öt_¥efix
);

386 
un¸r_sym_vÆid
 |
	`GEN_MASK
(
IO7__PO7_UNCRR_SYM__DETECT_SP
);

388 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CRD_INT
)

389 
	`¥ötk
("%s Correctable Error InterruptÖosted",

390 
îr_¥öt_¥efix
);

391 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__STV_INT
) {

392 
	`¥ötk
("%† Sèrv©i⁄ I¡îru±Öo°ed", 
îr_¥öt_¥efix
);

393 
un¸r_sym_vÆid
 |
	`GEN_MASK
(
IO7__PO7_UNCRR_SYM__STRV_VTR
);

395 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__HRD_INT
) {

396 
	`¥ötk
("%† H¨d Eº‹ I¡îru±Öo°ed", 
îr_¥öt_¥efix
);

397 
un¸r_sym_vÆid
 |
	`GEN_MASK
(
IO7__PO7_UNCRR_SYM__DETECT_SP
);

404 i‡(!(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__ERR_VALID
))

405 
check_un¸r_sym
;

414 
un¸r_sym_vÆid
 |
	`GEN_MASK
(
IO7__PO7_UNCRR_SYM__VICTIM_SP
);

415 i‡(!(
io
->
po7_îr‹_sum
 & (
IO7__PO7_ERRSUM__CR_PIO_WBYTE
 |

416 
IO7__PO7_ERRSUM__CR_CSR_NXM
 |

417 
IO7__PO7_ERRSUM__CR_RSP_NXM
 |

418 
IO7__PO7_ERRSUM__CR_ERR_RESP
 |

419 
IO7__PO7_ERRSUM__MAF_TO
)))

420 
un¸r_sym_vÆid
 |= 0x3ffffffful;

422 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_PIO_WBYTE
)

423 
	`¥ötk
("%† Wrôêbyã i¡ÿIO7 CSR\n", 
îr_¥öt_¥efix
);

424 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_CSR_NXM
)

425 
	`¥ötk
("%† PIOÅÿn⁄-exi°íàCSR\n", 
îr_¥öt_¥efix
);

426 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_RPID_ACV
)

427 
	`¥ötk
("%s Bus Requester PID (Access Violation)\n",

428 
îr_¥öt_¥efix
);

429 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_RSP_NXM
)

430 
	`¥ötk
("%s Received NXMÑesponse from EV7\n",

431 
îr_¥öt_¥efix
);

432 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_ERR_RESP
)

433 
	`¥ötk
("%† Re˚ived ERROR RESPONSE\n", 
îr_¥öt_¥efix
);

434 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_CLK_DERR
)

435 
	`¥ötk
("%† ClockÉº‹ o¿d©®Êô\n", 
îr_¥öt_¥efix
);

436 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_DAT_DBE
)

437 
	`¥ötk
("%s Double Bit Error Data Error Detected\n",

438 
îr_¥öt_¥efix
);

439 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__CR_DAT_GRBG
)

440 
	`¥ötk
("%s Garbage Encoding Detected onÅhe data\n",

441 
îr_¥öt_¥efix
);

442 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__UGBGE
) {

443 
	`¥ötk
("%s Garbage Encoding sent up hose\n",

444 
îr_¥öt_¥efix
);

445 
	`m¨vñ_¥öt_po7_ugbge_sym
(
io
->
po7_ugbge_sym
);

447 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__UN_MAF_LOST
)

448 
	`¥ötk
("%s OrphanÑesponse (unexpectedÑesponse)\n",

449 
îr_¥öt_¥efix
);

450 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__UN_PKT_OVF
)

451 
	`¥ötk
("%† Dow¿ho£Öackë ovîÊow\n", 
îr_¥öt_¥efix
);

452 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__UN_CDT_OVF
)

453 
	`¥ötk
("%† Dow¿ho£ cªdô ovîÊow\n", 
îr_¥öt_¥efix
);

454 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__UN_DEALLOC
)

455 
	`¥ötk
("%s Unexpected or bad dealloc field\n",

456 
îr_¥öt_¥efix
);

461 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__MAF_TO
)

462 
	`¥ötk
("%s BLACK HOLE: Timeout forállÑesponses\n",

463 
îr_¥öt_¥efix
);

464 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__BH_CDT_TO
)

465 
	`¥ötk
("%† BLACK HOLE: Cªdô Timeout\n", 
îr_¥öt_¥efix
);

466 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__BH_CLK_HDR
)

467 
	`¥ötk
("%s BLACK HOLE: Clock check on header\n",

468 
îr_¥öt_¥efix
);

469 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__BH_DBE_HDR
)

470 
	`¥ötk
("%s BLACK HOLE: Uncorrectable Error on header\n",

471 
îr_¥öt_¥efix
);

472 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__BH_GBG_HDR
)

473 
	`¥ötk
("%s BLACK HOLE: Garbage on header\n",

474 
îr_¥öt_¥efix
);

475 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__BH_BAD_CMD
)

476 
	`¥ötk
("%s BLACK HOLE: Bad EV7 command\n",

477 
îr_¥öt_¥efix
);

479 i‡(
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__ERR_LST
)

480 
	`¥ötk
("%† Lo° Eº‹\n", 
îr_¥öt_¥efix
);

482 
	`¥ötk
("%s Failing Packet:\n"

485 
îr_¥öt_¥efix
,

486 
îr_¥öt_¥efix
, 
io
->
po7_îr_pkt0
,

487 
îr_¥öt_¥efix
, 
io
->
po7_îr_pkt1
);

492 
check_un¸r_sym
:

493 i‡(
un¸r_sym_vÆid
)

494 
	`m¨vñ_¥öt_po7_un¸r_sym
(
io
->
po7_un¸r_sym
, 
un¸r_sym_vÆid
);

495 
	}
}

498 
	$m¨vñ_¥öt_pox_éb_îr
(
u64
 
éb_îr
)

500 *
éb_îr‹s
[] = {

507 
	#IO7__POX_TLBERR__ERR_VALID
 (1UL << 63)

	)

508 
	#IO7__POX_TLBERR__ERRCODE__S
 (0)

	)

509 
	#IO7__POX_TLBERR__ERRCODE__M
 (0x3)

	)

510 
	#IO7__POX_TLBERR__ERR_TLB_PTR__S
 (3)

	)

511 
	#IO7__POX_TLBERR__ERR_TLB_PTR__M
 (0x7)

	)

512 
	#IO7__POX_TLBERR__FADDR__S
 (6)

	)

513 
	#IO7__POX_TLBERR__FADDR__M
 (0x3fffffffffful)

	)

515 i‡(!(
éb_îr
 & 
IO7__POX_TLBERR__ERR_VALID
))

518 
	`¥ötk
("%s TLB Error on index 0x%lx:\n"

521 
îr_¥öt_¥efix
,

522 
	`EXTRACT
(
éb_îr
, 
IO7__POX_TLBERR__ERR_TLB_PTR
),

523 
îr_¥öt_¥efix
,

524 
éb_îr‹s
[
	`EXTRACT
(
éb_îr
, 
IO7__POX_TLBERR__ERRCODE
)],

525 
îr_¥öt_¥efix
,

526 
	`EXTRACT
(
éb_îr
, 
IO7__POX_TLBERR__FADDR
) << 6);

527 
	}
}

530 
	$m¨vñ_¥öt_pox_•l_cm∂t
(
u64
 
•l_cm∂t
)

532 
mesßge
[80];

534 
	#IO7__POX_SPLCMPLT__MESSAGE__S
 (0)

	)

535 
	#IO7__POX_SPLCMPLT__MESSAGE__M
 (0x0fffffffful)

	)

536 
	#IO7__POX_SPLCMPLT__SOURCE_BUS__S
 (40)

	)

537 
	#IO7__POX_SPLCMPLT__SOURCE_BUS__M
 (0xfful)

	)

538 
	#IO7__POX_SPLCMPLT__SOURCE_DEV__S
 (35)

	)

539 
	#IO7__POX_SPLCMPLT__SOURCE_DEV__M
 (0x1ful)

	)

540 
	#IO7__POX_SPLCMPLT__SOURCE_FUNC__S
 (32)

	)

541 
	#IO7__POX_SPLCMPLT__SOURCE_FUNC__M
 (0x07ul)

	)

543 
	#IO7__POX_SPLCMPLT__MSG_CLASS__S
 (28)

	)

544 
	#IO7__POX_SPLCMPLT__MSG_CLASS__M
 (0xf)

	)

545 
	#IO7__POX_SPLCMPLT__MSG_INDEX__S
 (20)

	)

546 
	#IO7__POX_SPLCMPLT__MSG_INDEX__M
 (0xff)

	)

547 
	#IO7__POX_SPLCMPLT__MSG_CLASSINDEX__S
 (20)

	)

548 
	#IO7__POX_SPLCMPLT__MSG_CLASSINDEX__M
 (0xfff)

	)

549 
	#IO7__POX_SPLCMPLT__REM_LOWER_ADDR__S
 (12)

	)

550 
	#IO7__POX_SPLCMPLT__REM_LOWER_ADDR__M
 (0x7f)

	)

551 
	#IO7__POX_SPLCMPLT__REM_BYTE_COUNT__S
 (0)

	)

552 
	#IO7__POX_SPLCMPLT__REM_BYTE_COUNT__M
 (0xfff)

	)

554 
	`¥ötk
("%s Split Completion Error:\n"

556 
îr_¥öt_¥efix
,

557 
îr_¥öt_¥efix
,

558 
	`EXTRACT
(
•l_cm∂t
, 
IO7__POX_SPLCMPLT__SOURCE_BUS
),

559 
	`EXTRACT
(
•l_cm∂t
, 
IO7__POX_SPLCMPLT__SOURCE_DEV
),

560 
	`EXTRACT
(
•l_cm∂t
, 
IO7__POX_SPLCMPLT__SOURCE_FUNC
));

562 
	`EXTRACT
(
•l_cm∂t
, 
IO7__POX_SPLCMPLT__MSG_CLASSINDEX
)) {

564 
	`•rötf
(
mesßge
, "Normal completion");

567 
	`•rötf
(
mesßge
, "Bridge - Master Abort");

570 
	`•rötf
(
mesßge
, "Bridge - Target Abort");

573 
	`•rötf
(
mesßge
, "Bridge - Uncorrectable Write Data Error");

576 
	`•rötf
(
mesßge
, "Byte Count Out of Range");

579 
	`•rötf
(
mesßge
, "Uncorrectable Split Write Data Error");

582 
	`•rötf
(
mesßge
, "%08lx\n",

583 
	`EXTRACT
(
•l_cm∂t
, 
IO7__POX_SPLCMPLT__MESSAGE
));

586 
	`¥ötk
("%s Mesßge: %s\n", 
îr_¥öt_¥efix
, 
mesßge
);

587 
	}
}

590 
	$m¨vñ_¥öt_pox_å™s_sum
(
u64
 
å™s_sum
)

592 *
pcix_cmd
[] = { "Interrupt Acknowledge",

610 
	#IO7__POX_TRANSUM__PCI_ADDR__S
 (0)

	)

611 
	#IO7__POX_TRANSUM__PCI_ADDR__M
 (0x3fffffffffffful)

	)

612 
	#IO7__POX_TRANSUM__DAC
 (1UL << 50)

	)

613 
	#IO7__POX_TRANSUM__PCIX_MASTER_SLOT__S
 (52)

	)

614 
	#IO7__POX_TRANSUM__PCIX_MASTER_SLOT__M
 (0xf)

	)

615 
	#IO7__POX_TRANSUM__PCIX_CMD__S
 (56)

	)

616 
	#IO7__POX_TRANSUM__PCIX_CMD__M
 (0xf)

	)

617 
	#IO7__POX_TRANSUM__ERR_VALID
 (1UL << 63)

	)

619 i‡(!(
å™s_sum
 & 
IO7__POX_TRANSUM__ERR_VALID
))

622 
	`¥ötk
("%s Transaction Summary:\n"

626 
îr_¥öt_¥efix
,

627 
îr_¥öt_¥efix
,

628 
	`EXTRACT
(
å™s_sum
, 
IO7__POX_TRANSUM__PCIX_CMD
),

629 
pcix_cmd
[
	`EXTRACT
(
å™s_sum
, 
IO7__POX_TRANSUM__PCIX_CMD
)],

630 
îr_¥öt_¥efix
,

631 
	`EXTRACT
(
å™s_sum
, 
IO7__POX_TRANSUM__PCI_ADDR
),

632 (
å™s_sum
 & 
IO7__POX_TRANSUM__DAC
) ? " (DAC)" : "",

633 
îr_¥öt_¥efix
,

634 
	`EXTRACT
(
å™s_sum
, 
IO7__POX_TRANSUM__PCIX_MASTER_SLOT
));

635 
	}
}

638 
	$m¨vñ_¥öt_pox_îr
(
u64
 
îr_sum
, 
ev7_∑l_io_⁄e_p‹t
 *
p‹t
)

640 
	#IO7__POX_ERRSUM__AGP_REQQ_OVFL
 (1UL << 4)

	)

641 
	#IO7__POX_ERRSUM__AGP_SYNC_ERR
 (1UL << 5)

	)

642 
	#IO7__POX_ERRSUM__MRETRY_TO
 (1UL << 6)

	)

643 
	#IO7__POX_ERRSUM__PCIX_UX_SPL
 (1UL << 7)

	)

644 
	#IO7__POX_ERRSUM__PCIX_SPLIT_TO
 (1UL << 8)

	)

645 
	#IO7__POX_ERRSUM__PCIX_DISCARD_SPL
 (1UL << 9)

	)

646 
	#IO7__POX_ERRSUM__DMA_RD_TO
 (1UL << 10)

	)

647 
	#IO7__POX_ERRSUM__CSR_NXM_RD
 (1UL << 11)

	)

648 
	#IO7__POX_ERRSUM__CSR_NXM_WR
 (1UL << 12)

	)

649 
	#IO7__POX_ERRSUM__DMA_TO
 (1UL << 13)

	)

650 
	#IO7__POX_ERRSUM__ALL_MABORTS
 (1UL << 14)

	)

651 
	#IO7__POX_ERRSUM__MABORT
 (1UL << 15)

	)

652 
	#IO7__POX_ERRSUM__MABORT_MASK
 (
IO7__POX_ERRSUM__ALL_MABORTS
|\

653 
IO7__POX_ERRSUM__MABORT
)

	)

654 
	#IO7__POX_ERRSUM__PT_TABORT
 (1UL << 16)

	)

655 
	#IO7__POX_ERRSUM__PM_TABORT
 (1UL << 17)

	)

656 
	#IO7__POX_ERRSUM__TABORT_MASK
 (
IO7__POX_ERRSUM__PT_TABORT
 | \

657 
IO7__POX_ERRSUM__PM_TABORT
)

	)

658 
	#IO7__POX_ERRSUM__SERR
 (1UL << 18)

	)

659 
	#IO7__POX_ERRSUM__ADDRERR_STB
 (1UL << 19)

	)

660 
	#IO7__POX_ERRSUM__DETECTED_SERR
 (1UL << 20)

	)

661 
	#IO7__POX_ERRSUM__PERR
 (1UL << 21)

	)

662 
	#IO7__POX_ERRSUM__DATAERR_STB_NIOW
 (1UL << 22)

	)

663 
	#IO7__POX_ERRSUM__DETECTED_PERR
 (1UL << 23)

	)

664 
	#IO7__POX_ERRSUM__PM_PERR
 (1UL << 24)

	)

665 
	#IO7__POX_ERRSUM__PT_SCERROR
 (1UL << 26)

	)

666 
	#IO7__POX_ERRSUM__HUNG_BUS
 (1UL << 28)

	)

667 
	#IO7__POX_ERRSUM__UPE_ERROR__S
 (51)

	)

668 
	#IO7__POX_ERRSUM__UPE_ERROR__M
 (0xffUL)

	)

669 
	#IO7__POX_ERRSUM__UPE_ERROR
 
	`GEN_MASK
(
IO7__POX_ERRSUM__UPE_ERROR
)

	)

670 
	#IO7__POX_ERRSUM__TLB_ERR
 (1UL << 59)

	)

671 
	#IO7__POX_ERRSUM__ERR_VALID
 (1UL << 63)

	)

673 
	#IO7__POX_ERRSUM__TRANS_SUM__MASK
 (
IO7__POX_ERRSUM__MRETRY_TO
 | \

674 
IO7__POX_ERRSUM__PCIX_UX_SPL
 | \

675 
IO7__POX_ERRSUM__PCIX_SPLIT_TO
 | \

676 
IO7__POX_ERRSUM__DMA_TO
 | \

677 
IO7__POX_ERRSUM__MABORT_MASK
 | \

678 
IO7__POX_ERRSUM__TABORT_MASK
 | \

679 
IO7__POX_ERRSUM__SERR
 | \

680 
IO7__POX_ERRSUM__ADDRERR_STB
 | \

681 
IO7__POX_ERRSUM__PERR
 | \

682 
IO7__POX_ERRSUM__DATAERR_STB_NIOW
 |\

683 
IO7__POX_ERRSUM__DETECTED_PERR
 | \

684 
IO7__POX_ERRSUM__PM_PERR
 | \

685 
IO7__POX_ERRSUM__PT_SCERROR
 | \

686 
IO7__POX_ERRSUM__UPE_ERROR
)

	)

688 i‡(!(
îr_sum
 & 
IO7__POX_ERRSUM__ERR_VALID
))

694 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__MRETRY_TO
)

695 
	`¥ötk
("%s IO7 Master Retry TimeoutÉxpired\n",

696 
îr_¥öt_¥efix
);

697 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PCIX_UX_SPL
)

698 
	`¥ötk
("%s Unexpected Split Completion\n",

699 
îr_¥öt_¥efix
);

700 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PCIX_SPLIT_TO
)

701 
	`¥ötk
("%s IO7 Split Completion TimeoutÉxpired\n",

702 
îr_¥öt_¥efix
);

703 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__DMA_TO
)

704 
	`¥ötk
("%s Hung bus during DMAÅransaction\n",

705 
îr_¥öt_¥efix
);

706 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__MABORT_MASK
)

707 
	`¥ötk
("%† Ma°î Ab‹t\n", 
îr_¥öt_¥efix
);

708 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PT_TABORT
)

709 
	`¥ötk
("%† IO7 As£πed T¨gë Ab‹t\n", 
îr_¥öt_¥efix
);

710 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PM_TABORT
)

711 
	`¥ötk
("%† IO7 Re˚ived T¨gë Ab‹t\n", 
îr_¥öt_¥efix
);

712 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__ADDRERR_STB
) {

713 
	`¥ötk
("%s Address or PCI-X Attribute Parity Error\n",

714 
îr_¥öt_¥efix
);

715 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__SERR
)

716 
	`¥ötk
("%† IO7 As£πed SERR\n", 
îr_¥öt_¥efix
);

718 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PERR
) {

719 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__DATAERR_STB_NIOW
)

720 
	`¥ötk
("%s IO7 Detected Data Parity Error\n",

721 
îr_¥öt_¥efix
);

723 
	`¥ötk
("%s Split Completion Response with "

724 "P¨ôy Eº‹\n", 
îr_¥öt_¥efix
);

726 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__DETECTED_PERR
)

727 
	`¥ötk
("%† PERR dëe˘ed\n", 
îr_¥öt_¥efix
);

728 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PM_PERR
)

729 
	`¥ötk
("%† PERR whûêIO7 i†ma°î\n", 
îr_¥öt_¥efix
);

730 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PT_SCERROR
) {

731 
	`¥ötk
("%s IO7 Received Split Completion Error message\n",

732 
îr_¥öt_¥efix
);

733 
	`m¨vñ_¥öt_pox_•l_cm∂t
(
p‹t
->
pox_•l_cm∂t
);

735 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__UPE_ERROR
) {

736 
u≥_îr‹
 = 
	`EXTRACT
(
îr_sum
,

737 
IO7__POX_ERRSUM__UPE_ERROR
);

738 
i
;

739 *
u≥_îr‹s
[] = {

750 
	`¥ötk
("%† UPE Eº‹:\n", 
îr_¥öt_¥efix
);

751 
i
 = 0; i < 8; i++) {

752 i‡(
u≥_îr‹
 & (1 << 
i
))

753 
	`¥ötk
("%† %s\n", 
îr_¥öt_¥efix
,

754 
u≥_îr‹s
[
i
]);

761 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__TRANS_SUM__MASK
)

762 
	`m¨vñ_¥öt_pox_å™s_sum
(
p‹t
->
pox_å™s_sum
);

767 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__TLB_ERR
) {

768 
	`¥ötk
("%† TLB ERROR\n", 
îr_¥öt_¥efix
);

769 
	`m¨vñ_¥öt_pox_éb_îr
(
p‹t
->
pox_éb_îr
);

775 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__AGP_REQQ_OVFL
)

776 
	`¥ötk
("%† AGP Reque° QueuêOvîÊow\n", 
îr_¥öt_¥efix
);

777 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__AGP_SYNC_ERR
)

778 
	`¥ötk
("%† AGP Syn¯Eº‹\n", 
îr_¥öt_¥efix
);

779 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__PCIX_DISCARD_SPL
)

780 
	`¥ötk
("%† Disˇrded s∂ô com∂ëi⁄\n", 
îr_¥öt_¥efix
);

781 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__DMA_RD_TO
)

782 
	`¥ötk
("%† DMA Ród Timeout\n", 
îr_¥öt_¥efix
);

783 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__CSR_NXM_RD
)

784 
	`¥ötk
("%† CSR NXM READ\n", 
îr_¥öt_¥efix
);

785 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__CSR_NXM_WR
)

786 
	`¥ötk
("%† CSR NXM WRITE\n", 
îr_¥öt_¥efix
);

787 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__DETECTED_SERR
)

788 
	`¥ötk
("%† SERR dëe˘ed\n", 
îr_¥öt_¥efix
);

789 i‡(
îr_sum
 & 
IO7__POX_ERRSUM__HUNG_BUS
)

790 
	`¥ötk
("%† HUNG BUS dëe˘ed\n", 
îr_¥öt_¥efix
);

791 
	}
}

795 
ev7_∑l_io_sub∑ckë
 *

796 
	$m¨vñ_föd_io7_wôh_îr‹
(
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
)

798 
ev7_∑l_io_sub∑ckë
 *
io
 = 
lf_sub∑ckës
->io;

799 
io7
 *io7;

800 
i
;

805 i‡(!
io
)

806  
NULL
;

811 
	`mem£t
(
io
, 0x55, (*io));

813 
io7
 = 
NULL
; NULL !(io7 = 
	`m¨vñ_√xt_io7
(io7)); ) {

814 
îr_sum
 = 0;

816 
îr_sum
 |
io7
->
c§s
->
PO7_ERROR_SUM
.
c§
;

817 
i
 = 0; i < 
IO7_NUM_PORTS
; i++) {

818 i‡(!
io7
->
p‹ts
[
i
].
íabÀd
)

820 
îr_sum
 |
io7
->
p‹ts
[
i
].
c§s
->
POx_ERR_SUM
.
c§
;

826 i‡(
îr_sum
 & (1UL << 63))

833 i‡(!
io7
)

834  
NULL
;

841 
io
->
io_asic_ªv
 = 
io7
->
c§s
->
IO_ASIC_REV
.
c§
;

842 
io
->
io_sys_ªv
 = 
io7
->
c§s
->
IO_SYS_REV
.
c§
;

843 
io
->
io7_uph
 = 
io7
->
c§s
->
IO7_UPH
.
c§
;

844 
io
->
hpi_˘l
 = 
io7
->
c§s
->
HPI_CTL
.
c§
;

845 
io
->
¸d_˘l
 = 
io7
->
c§s
->
CRD_CTL
.
c§
;

846 
io
->
hei_˘l
 = 
io7
->
c§s
->
HEI_CTL
.
c§
;

847 
io
->
po7_îr‹_sum
 = 
io7
->
c§s
->
PO7_ERROR_SUM
.
c§
;

848 
io
->
po7_un¸r_sym
 = 
io7
->
c§s
->
PO7_UNCRR_SYM
.
c§
;

849 
io
->
po7_¸r˘_sym
 = 
io7
->
c§s
->
PO7_CRRCT_SYM
.
c§
;

850 
io
->
po7_ugbge_sym
 = 
io7
->
c§s
->
PO7_UGBGE_SYM
.
c§
;

851 
io
->
po7_îr_pkt0
 = 
io7
->
c§s
->
PO7_ERR_PKT
[0].
c§
;

852 
io
->
po7_îr_pkt1
 = 
io7
->
c§s
->
PO7_ERR_PKT
[1].
c§
;

854 
i
 = 0; i < 
IO7_NUM_PORTS
; i++) {

855 
io7_i›‹t_c§s
 *
c§s
 = 
io7
->
p‹ts
[
i
].csrs;

857 i‡(!
io7
->
p‹ts
[
i
].
íabÀd
)

860 
io
->
p‹ts
[
i
].
pox_îr_sum
 = 
c§s
->
POx_ERR_SUM
.
c§
;

861 
io
->
p‹ts
[
i
].
pox_éb_îr
 = 
c§s
->
POx_TLB_ERR
.
c§
;

862 
io
->
p‹ts
[
i
].
pox_•l_cm∂t
 = 
c§s
->
POx_SPL_COMPLT
.
c§
;

863 
io
->
p‹ts
[
i
].
pox_å™s_sum
 = 
c§s
->
POx_TRANS_SUM
.
c§
;

864 
io
->
p‹ts
[
i
].
pox_fú°_îr
 = 
c§s
->
POx_FIRST_ERR
.
c§
;

865 
io
->
p‹ts
[
i
].
pox_mu…_îr
 = 
c§s
->
POx_MULT_ERR
.
c§
;

866 
io
->
p‹ts
[
i
].
pox_dm_sour˚
 = 
c§s
->
POx_DM_SOURCE
.
c§
;

867 
io
->
p‹ts
[
i
].
pox_dm_de°
 = 
c§s
->
POx_DM_DEST
.
c§
;

868 
io
->
p‹ts
[
i
].
pox_dm_size
 = 
c§s
->
POx_DM_SIZE
.
c§
;

869 
io
->
p‹ts
[
i
].
pox_dm_˘æ
 = 
c§s
->
POx_DM_CTRL
.
c§
;

879 
c§s
->
POx_TLB_ERR
.
c§
 = 
io
->
p‹ts
[
i
].
pox_éb_îr
;

880 
c§s
->
POx_ERR_SUM
.
c§
 = 
io
->
p‹ts
[
i
].
pox_îr_sum
;

881 
	`mb
();

882 
c§s
->
POx_ERR_SUM
.
c§
;

888 
io7
->
c§s
->
PO7_ERROR_SUM
.
c§
 = 
io
->
po7_îr‹_sum
;

889 
	`mb
();

890 
io7
->
c§s
->
PO7_ERROR_SUM
.
c§
;

895 
lf_sub∑ckës
->
io_pid
 = 
io7
->
≥
;

897  
io
;

898 
	}
}

901 
	$m¨vñ_¥o˚ss_io_îr‹
(
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
, 
¥öt
)

903 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

905 #ifde‡
CONFIG_VERBOSE_MCHECK


906 
ev7_∑l_io_sub∑ckë
 *
io
 = 
lf_sub∑ckës
->io;

907 
i
;

910 
	#MARVEL_IO_ERR_VALID
(
x
Ë((xË& (1UL << 63))

	)

912 i‡(!
lf_sub∑ckës
->
logout
 || !lf_sub∑ckës->
io
)

913  
°©us
;

931 i‡((
lf_sub∑ckës
->
io
->
po7_îr‹_sum
 & (1UL << 32)) ||

932 ((
lf_sub∑ckës
->
io
->
po7_îr‹_sum
 |

933 
lf_sub∑ckës
->
io
->
p‹ts
[0].
pox_îr_sum
 |

934 
lf_sub∑ckës
->
io
->
p‹ts
[1].
pox_îr_sum
 |

935 
lf_sub∑ckës
->
io
->
p‹ts
[2].
pox_îr_sum
 |

936 
lf_sub∑ckës
->
io
->
p‹ts
[3].
pox_îr_sum
) & (1UL << 63))) {

942 i‡(!
	`m¨vñ_föd_io7_wôh_îr‹
(
lf_sub∑ckës
))

943  
°©us
;

949 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

951 #ifde‡
CONFIG_VERBOSE_MCHECK


953 i‡(!
¥öt
)

954  
°©us
;

956 
	`¥ötk
("%s*Error occurred on IO7át PID %u\n",

957 
îr_¥öt_¥efix
, 
lf_sub∑ckës
->
io_pid
);

962 i‡(
lf_sub∑ckës
->
io
->
po7_îr‹_sum
 & 
IO7__PO7_ERRSUM__ERR_MASK
) {

963 
	`m¨vñ_¥öt_po7_îr_sum
(
io
);

966 
	`¥ötk
("%s PORT 7 ERROR:\n"

973 
îr_¥öt_¥efix
,

974 
îr_¥öt_¥efix
, 
io
->
po7_îr‹_sum
,

975 
îr_¥öt_¥efix
, 
io
->
po7_un¸r_sym
,

976 
îr_¥öt_¥efix
, 
io
->
po7_¸r˘_sym
,

977 
îr_¥öt_¥efix
, 
io
->
po7_ugbge_sym
,

978 
îr_¥öt_¥efix
, 
io
->
po7_îr_pkt0
,

979 
îr_¥öt_¥efix
, 
io
->
po7_îr_pkt1
);

986 
i
 = 0; i < 
IO7_NUM_PORTS
; i++) {

987 i‡(!
	`MARVEL_IO_ERR_VALID
(
io
->
p‹ts
[
i
].
pox_îr_sum
))

990 
	`¥ötk
("%s PID %u PORT %d POx_ERR_SUM: %016lx\n",

991 
îr_¥öt_¥efix
,

992 
lf_sub∑ckës
->
io_pid
, 
i
, 
io
->
p‹ts
[i].
pox_îr_sum
);

993 
	`m¨vñ_¥öt_pox_îr
(
io
->
p‹ts
[
i
].
pox_îr_sum
, &io->ports[i]);

995 
	`¥ötk
("%s [ POx_FIRST_ERR: %016lx ]\n",

996 
îr_¥öt_¥efix
, 
io
->
p‹ts
[
i
].
pox_fú°_îr
);

997 
	`m¨vñ_¥öt_pox_îr
(
io
->
p‹ts
[
i
].
pox_fú°_îr
,

998 &
io
->
p‹ts
[
i
]);

1005  
°©us
;

1006 
	}
}

1009 
	$m¨vñ_¥o˚ss_logout_‰ame
(
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
, 
¥öt
)

1011 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

1016 
	#EV7__RBOX_INT__IO_ERROR__MASK
 0x20000400ul

	)

1017 i‡(
lf_sub∑ckës
->
logout
 &&

1018 (
lf_sub∑ckës
->
logout
->
rbox_öt
 & 0x20000400ul))

1019 
°©us
 = 
	`m¨vñ_¥o˚ss_io_îr‹
(
lf_sub∑ckës
, 
¥öt
);

1034 i‡(
lf_sub∑ckës
->
ev7
 &&

1035 (
lf_sub∑ckës
->
ev7
->
c_°©
 == 0x14) &&

1036 !(
lf_sub∑ckës
->
ev7
->
c_°s
 & 0x8) &&

1037 ((
lf_sub∑ckës
->
ev7
->
c_addr
 & 0x400ff000000ul)

1039 
°©us
 = 
MCHK_DISPOSITION_DISMISS
;

1041  
°©us
;

1042 
	}
}

1045 
	$m¨vñ_machöe_check
(
u64
 
ve˘‹
, u64 
œ_±r
)

1047 
ñ_sub∑ckë
 *
ñ_±r
 = (ñ_sub∑ckë *)
œ_±r
;

1048 (*
¥o˚ss_‰ame
)(
ev7_lf_sub∑ckës
 *, Ë
NULL
;

1049 
ev7_lf_sub∑ckës
 
sub∑ckë_cﬁÀ˘i⁄
 = { 
NULL
, };

1050 
ev7_∑l_io_sub∑ckë
 
s¸©ch_io_∑ckë
 = { 0, };

1051 
ev7_lf_sub∑ckës
 *
lf_sub∑ckës
 = 
NULL
;

1052 
di•osôi⁄
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

1053 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

1054 *
îr‹_ty≥
 = 
NULL
;

1059 
	`mb
();

1060 
	`døöa
();

1062 
ve˘‹
) {

1063 
SCB_Q_SYSEVENT
:

1064 
¥o˚ss_‰ame
 = 
m¨vñ_¥o˚ss_680_‰ame
;

1065 
îr‹_ty≥
 = "System Event";

1068 
SCB_Q_SYSMCHK
:

1069 
¥o˚ss_‰ame
 = 
m¨vñ_¥o˚ss_logout_‰ame
;

1070 
îr‹_ty≥
 = "System Uncorrectable Error";

1073 
SCB_Q_SYSERR
:

1074 
¥o˚ss_‰ame
 = 
m¨vñ_¥o˚ss_logout_‰ame
;

1075 
îr‹_ty≥
 = "System Correctable Error";

1080 
	`ev7_machöe_check
(
ve˘‹
, 
œ_±r
);

1090 
îr_¥öt_¥efix
 = 
KERN_CRIT
;

1097 
lf_sub∑ckës
 =

1098 
	`ev7_cﬁÀ˘_logout_‰ame_sub∑ckës
(
ñ_±r
,

1099 &
sub∑ckë_cﬁÀ˘i⁄
);

1100 i‡(
¥o˚ss_‰ame
 && 
lf_sub∑ckës
 &&Üf_sub∑ckës->
logout
) {

1109 i‡(!
lf_sub∑ckës
->
io
)

1110 
lf_sub∑ckës
->
io
 = &
s¸©ch_io_∑ckë
;

1117 
lf_sub∑ckës
->
io_pid
 =Üf_sub∑ckës->
logout
->
whami
;

1122 
di•osôi⁄
 = 
	`¥o˚ss_‰ame
(
lf_sub∑ckës
, 0);

1124 
di•osôi⁄
) {

1125 
MCHK_DISPOSITION_DISMISS
:

1129 
MCHK_DISPOSITION_REPORT
:

1131 
	`¥ötk
("%s*%s (Vector 0x%x)Ñeported on CPU %d\n",

1132 
îr_¥öt_¥efix
, 
îr‹_ty≥
,

1133 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

1134 
	`ñ_¥öt_time°amp
(&
lf_sub∑ckës
->
logout
->
time°amp
);

1135 
	`¥o˚ss_‰ame
(
lf_sub∑ckës
, 1);

1140 
	`¥ötk
("%s*%s (Vector 0x%x)Ñeported on CPU %d\n",

1141 
îr_¥öt_¥efix
, 
îr‹_ty≥
,

1142 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

1143 
	`ñ_¥o˚ss_sub∑ckë
(
ñ_±r
);

1148 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

1151 
	`wrm˚s
(0x7);

1152 
	`mb
();

1153 
	}
}

1156 
	$m¨vñ_ªgi°î_îr‹_h™dÀrs
()

1158 
	`ev7_ªgi°î_îr‹_h™dÀrs
();

1159 
	}
}

	@arch/alpha/kernel/err_titan.c

9 
	~<löux/öô.h
>

10 
	~<löux/pci.h
>

11 
	~<löux/sched.h
>

13 
	~<asm/io.h
>

14 
	~<asm/c‹e_tô™.h
>

15 
	~<asm/hwΩb.h
>

16 
	~<asm/smp.h
>

17 
	~<asm/îr_comm⁄.h
>

18 
	~<asm/îr_ev6.h
>

19 
	~<asm/úq_ªgs.h
>

21 
	~"îr_im∂.h
"

22 
	~"¥Ÿo.h
"

26 
	$tô™_∑r£_c_misc
(
u64
 
c_misc
, 
¥öt
)

28 #ifde‡
CONFIG_VERBOSE_MCHECK


29 *
§c
;

30 
nxs
 = 0;

32 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

34 
	#TITAN__CCHIP_MISC__NXM
 (1UL << 28)

	)

35 
	#TITAN__CCHIP_MISC__NXS__S
 (29)

	)

36 
	#TITAN__CCHIP_MISC__NXS__M
 (0x7)

	)

38 i‡(!(
c_misc
 & 
TITAN__CCHIP_MISC__NXM
))

39  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

41 #ifde‡
CONFIG_VERBOSE_MCHECK


42 i‡(!
¥öt
)

43  
°©us
;

45 
nxs
 = 
	`EXTRACT
(
c_misc
, 
TITAN__CCHIP_MISC__NXS
);

46 
nxs
) {

51 
§c
 = "CPU";

56 
§c
 = "Pchip";

57 
nxs
 -= 4;

60 
§c
 = "Unknown, NXS =";

65 
	`¥ötk
("%s Non-existent memoryáccess from: %s %d\n",

66 
îr_¥öt_¥efix
, 
§c
, 
nxs
);

69  
°©us
;

70 
	}
}

73 
	$tô™_∑r£_p_£º‹
(
which
, 
u64
 
£º‹
, 
¥öt
)

75 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

77 #ifde‡
CONFIG_VERBOSE_MCHECK


78 *
£º‹_§c
[] = {"GPCI", "APCI", "AGP HP", "AGP LP"};

79 *
£º‹_cmd
[] = {"DMA Read", "DMA RMW", "SGTE Read", "Reserved"};

82 
	#TITAN__PCHIP_SERROR__LOST_UECC
 (1UL << 0)

	)

83 
	#TITAN__PCHIP_SERROR__UECC
 (1UL << 1)

	)

84 
	#TITAN__PCHIP_SERROR__CRE
 (1UL << 2)

	)

85 
	#TITAN__PCHIP_SERROR__NXIO
 (1UL << 3)

	)

86 
	#TITAN__PCHIP_SERROR__LOST_CRE
 (1UL << 4)

	)

87 
	#TITAN__PCHIP_SERROR__ECCMASK
 (
TITAN__PCHIP_SERROR__UECC
 | \

88 
TITAN__PCHIP_SERROR__CRE
)

	)

89 
	#TITAN__PCHIP_SERROR__ERRMASK
 (
TITAN__PCHIP_SERROR__LOST_UECC
 | \

90 
TITAN__PCHIP_SERROR__UECC
 | \

91 
TITAN__PCHIP_SERROR__CRE
 | \

92 
TITAN__PCHIP_SERROR__NXIO
 | \

93 
TITAN__PCHIP_SERROR__LOST_CRE
)

	)

94 
	#TITAN__PCHIP_SERROR__SRC__S
 (52)

	)

95 
	#TITAN__PCHIP_SERROR__SRC__M
 (0x3)

	)

96 
	#TITAN__PCHIP_SERROR__CMD__S
 (54)

	)

97 
	#TITAN__PCHIP_SERROR__CMD__M
 (0x3)

	)

98 
	#TITAN__PCHIP_SERROR__SYN__S
 (56)

	)

99 
	#TITAN__PCHIP_SERROR__SYN__M
 (0xff)

	)

100 
	#TITAN__PCHIP_SERROR__ADDR__S
 (15)

	)

101 
	#TITAN__PCHIP_SERROR__ADDR__M
 (0xffffffffUL)

	)

103 i‡(!(
£º‹
 & 
TITAN__PCHIP_SERROR__ERRMASK
))

104  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

106 #ifde‡
CONFIG_VERBOSE_MCHECK


107 i‡(!
¥öt
)

108  
°©us
;

110 
	`¥ötk
("%s PChip %d SERROR: %016lx\n",

111 
îr_¥öt_¥efix
, 
which
, 
£º‹
);

112 i‡(
£º‹
 & 
TITAN__PCHIP_SERROR__ECCMASK
) {

113 
	`¥ötk
("%s %sorrectable ECC Error:\n"

116 
îr_¥öt_¥efix
,

117 (
£º‹
 & 
TITAN__PCHIP_SERROR__UECC
) ? "Unc" : "C",

118 
£º‹_§c
[
	`EXTRACT
(
£º‹
, 
TITAN__PCHIP_SERROR__SRC
)],

119 
£º‹_cmd
[
	`EXTRACT
(
£º‹
, 
TITAN__PCHIP_SERROR__CMD
)],

120 ()
	`EXTRACT
(
£º‹
, 
TITAN__PCHIP_SERROR__SYN
),

121 
	`EXTRACT
(
£º‹
, 
TITAN__PCHIP_SERROR__ADDR
));

123 i‡(
£º‹
 & 
TITAN__PCHIP_SERROR__NXIO
)

124 
	`¥ötk
("%† N⁄ Exi°íàI/O Eº‹\n", 
îr_¥öt_¥efix
);

125 i‡(
£º‹
 & 
TITAN__PCHIP_SERROR__LOST_UECC
)

126 
	`¥ötk
("%s Lost Uncorrectable ECC Error\n",

127 
îr_¥öt_¥efix
);

128 i‡(
£º‹
 & 
TITAN__PCHIP_SERROR__LOST_CRE
)

129 
	`¥ötk
("%† Lo° C‹ª˘abÀ ECC Eº‹\n", 
îr_¥öt_¥efix
);

132  
°©us
;

133 
	}
}

136 
	$tô™_∑r£_p_≥º‹
(
which
, 
p‹t
, 
u64
 
≥º‹
, 
¥öt
)

138 
cmd
;

139 
addr
;

140 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

142 #ifde‡
CONFIG_VERBOSE_MCHECK


143 *
≥º‹_cmd
[] = { "Interrupt Acknowledge", "Special Cycle",

154 
	#TITAN__PCHIP_PERROR__LOST
 (1UL << 0)

	)

155 
	#TITAN__PCHIP_PERROR__SERR
 (1UL << 1)

	)

156 
	#TITAN__PCHIP_PERROR__PERR
 (1UL << 2)

	)

157 
	#TITAN__PCHIP_PERROR__DCRTO
 (1UL << 3)

	)

158 
	#TITAN__PCHIP_PERROR__SGE
 (1UL << 4)

	)

159 
	#TITAN__PCHIP_PERROR__APE
 (1UL << 5)

	)

160 
	#TITAN__PCHIP_PERROR__TA
 (1UL << 6)

	)

161 
	#TITAN__PCHIP_PERROR__DPE
 (1UL << 7)

	)

162 
	#TITAN__PCHIP_PERROR__NDS
 (1UL << 8)

	)

163 
	#TITAN__PCHIP_PERROR__IPTPR
 (1UL << 9)

	)

164 
	#TITAN__PCHIP_PERROR__IPTPW
 (1UL << 10)

	)

165 
	#TITAN__PCHIP_PERROR__ERRMASK
 (
TITAN__PCHIP_PERROR__LOST
 | \

166 
TITAN__PCHIP_PERROR__SERR
 | \

167 
TITAN__PCHIP_PERROR__PERR
 | \

168 
TITAN__PCHIP_PERROR__DCRTO
 | \

169 
TITAN__PCHIP_PERROR__SGE
 | \

170 
TITAN__PCHIP_PERROR__APE
 | \

171 
TITAN__PCHIP_PERROR__TA
 | \

172 
TITAN__PCHIP_PERROR__DPE
 | \

173 
TITAN__PCHIP_PERROR__NDS
 | \

174 
TITAN__PCHIP_PERROR__IPTPR
 | \

175 
TITAN__PCHIP_PERROR__IPTPW
)

	)

176 
	#TITAN__PCHIP_PERROR__DAC
 (1UL << 47)

	)

177 
	#TITAN__PCHIP_PERROR__MWIN
 (1UL << 48)

	)

178 
	#TITAN__PCHIP_PERROR__CMD__S
 (52)

	)

179 
	#TITAN__PCHIP_PERROR__CMD__M
 (0x0f)

	)

180 
	#TITAN__PCHIP_PERROR__ADDR__S
 (14)

	)

181 
	#TITAN__PCHIP_PERROR__ADDR__M
 (0x1fffffffful)

	)

183 i‡(!(
≥º‹
 & 
TITAN__PCHIP_PERROR__ERRMASK
))

184  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

186 
cmd
 = 
	`EXTRACT
(
≥º‹
, 
TITAN__PCHIP_PERROR__CMD
);

187 
addr
 = 
	`EXTRACT
(
≥º‹
, 
TITAN__PCHIP_PERROR__ADDR
) << 2;

214 i‡(((
≥º‹
 & 
TITAN__PCHIP_PERROR__NDS
) ||

215 ((
≥º‹
 & 
TITAN__PCHIP_PERROR__ERRMASK
) ==

216 
TITAN__PCHIP_PERROR__LOST
)) &&

217 ((((
cmd
 & 0xEË=2Ë&& (
addr
 < 0x1000)) ||

218 (((
cmd
 & 0xEË=6Ë&& (
addr
 >= 0xA0000) && (addr < 0x100000)))) {

219 
°©us
 = 
MCHK_DISPOSITION_DISMISS
;

222 #ifde‡
CONFIG_VERBOSE_MCHECK


223 i‡(!
¥öt
)

224  
°©us
;

226 
	`¥ötk
("%s PChip %d %cPERROR: %016lx\n",

227 
îr_¥öt_¥efix
, 
which
,

228 
p‹t
 ? 'A' : 'G', 
≥º‹
);

229 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__IPTPW
)

230 
	`¥ötk
("%† InvÆid Pìr-to-Pì∏Wrôe\n", 
îr_¥öt_¥efix
);

231 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__IPTPR
)

232 
	`¥ötk
("%† InvÆid Pìr-to-Pì∏Ród\n", 
îr_¥öt_¥efix
);

233 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__NDS
)

234 
	`¥ötk
("%s No DEVSELás PCI Master [Master Abort]\n",

235 
îr_¥öt_¥efix
);

236 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__DPE
)

237 
	`¥ötk
("%† D©®P¨ôy Eº‹\n", 
îr_¥öt_¥efix
);

238 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__TA
)

239 
	`¥ötk
("%† T¨gë Ab‹t\n", 
îr_¥öt_¥efix
);

240 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__APE
)

241 
	`¥ötk
("%† Addªs†P¨ôy Eº‹\n", 
îr_¥öt_¥efix
);

242 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__SGE
)

243 
	`¥ötk
("%s Scatter-Gather Error, Invalid PTE\n",

244 
îr_¥öt_¥efix
);

245 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__DCRTO
)

246 
	`¥ötk
("%s Delayed-Completion Retry Timeout\n",

247 
îr_¥öt_¥efix
);

248 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__PERR
)

249 
	`¥ötk
("%† PERR As£πed\n", 
îr_¥öt_¥efix
);

250 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__SERR
)

251 
	`¥ötk
("%† SERR As£πed\n", 
îr_¥öt_¥efix
);

252 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__LOST
)

253 
	`¥ötk
("%† Lo° Eº‹\n", 
îr_¥öt_¥efix
);

254 
	`¥ötk
("%s Command: 0x%x - %s\n"

256 
îr_¥öt_¥efix
,

257 
cmd
, 
≥º‹_cmd
[cmd],

258 
addr
);

259 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__DAC
)

260 
	`¥ötk
("%† DuÆ Addªs†Cy˛e\n", 
îr_¥öt_¥efix
);

261 i‡(
≥º‹
 & 
TITAN__PCHIP_PERROR__MWIN
)

262 
	`¥ötk
("%† Hô i¿M⁄°î Wödow\n", 
îr_¥öt_¥efix
);

265  
°©us
;

266 
	}
}

269 
	$tô™_∑r£_p_ag≥º‹
(
which
, 
u64
 
ag≥º‹
, 
¥öt
)

271 
°©us
 = 
MCHK_DISPOSITION_REPORT
;

272 #ifde‡
CONFIG_VERBOSE_MCHECK


273 
cmd
, 
Àn
;

274 
addr
;

276 *
ag≥º‹_cmd
[] = { "Read (low-priority)", "Read (high-priority)",

284 
	#TITAN__PCHIP_AGPERROR__LOST
 (1UL << 0)

	)

285 
	#TITAN__PCHIP_AGPERROR__LPQFULL
 (1UL << 1)

	)

286 
	#TITAN__PCHIP_AGPERROR__HPQFULL
 (1UL << 2)

	)

287 
	#TITAN__PCHIP_AGPERROR__RESCMD
 (1UL << 3)

	)

288 
	#TITAN__PCHIP_AGPERROR__IPTE
 (1UL << 4)

	)

289 
	#TITAN__PCHIP_AGPERROR__PTP
 (1UL << 5)

	)

290 
	#TITAN__PCHIP_AGPERROR__NOWINDOW
 (1UL << 6)

	)

291 
	#TITAN__PCHIP_AGPERROR__ERRMASK
 (
TITAN__PCHIP_AGPERROR__LOST
 | \

292 
TITAN__PCHIP_AGPERROR__LPQFULL
 | \

293 
TITAN__PCHIP_AGPERROR__HPQFULL
 | \

294 
TITAN__PCHIP_AGPERROR__RESCMD
 | \

295 
TITAN__PCHIP_AGPERROR__IPTE
 | \

296 
TITAN__PCHIP_AGPERROR__PTP
 | \

297 
TITAN__PCHIP_AGPERROR__NOWINDOW
)

	)

298 
	#TITAN__PCHIP_AGPERROR__DAC
 (1UL << 48)

	)

299 
	#TITAN__PCHIP_AGPERROR__MWIN
 (1UL << 49)

	)

300 
	#TITAN__PCHIP_AGPERROR__FENCE
 (1UL << 59)

	)

301 
	#TITAN__PCHIP_AGPERROR__CMD__S
 (50)

	)

302 
	#TITAN__PCHIP_AGPERROR__CMD__M
 (0x07)

	)

303 
	#TITAN__PCHIP_AGPERROR__ADDR__S
 (15)

	)

304 
	#TITAN__PCHIP_AGPERROR__ADDR__M
 (0xffffffffUL)

	)

305 
	#TITAN__PCHIP_AGPERROR__LEN__S
 (53)

	)

306 
	#TITAN__PCHIP_AGPERROR__LEN__M
 (0x3f)

	)

308 i‡(!(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__ERRMASK
))

309  
MCHK_DISPOSITION_UNKNOWN_ERROR
;

311 #ifde‡
CONFIG_VERBOSE_MCHECK


312 i‡(!
¥öt
)

313  
°©us
;

315 
cmd
 = 
	`EXTRACT
(
ag≥º‹
, 
TITAN__PCHIP_AGPERROR__CMD
);

316 
addr
 = 
	`EXTRACT
(
ag≥º‹
, 
TITAN__PCHIP_AGPERROR__ADDR
) << 3;

317 
Àn
 = 
	`EXTRACT
(
ag≥º‹
, 
TITAN__PCHIP_AGPERROR__LEN
);

319 
	`¥ötk
("%† PChù %d AGPERROR: %016lx\n", 
îr_¥öt_¥efix
,

320 
which
, 
ag≥º‹
);

321 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__NOWINDOW
)

322 
	`¥ötk
("%† NÿWödow\n", 
îr_¥öt_¥efix
);

323 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__PTP
)

324 
	`¥ötk
("%† Pìr-to-Pì∏£t\n", 
îr_¥öt_¥efix
);

325 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__IPTE
)

326 
	`¥ötk
("%† InvÆid PTE\n", 
îr_¥öt_¥efix
);

327 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__RESCMD
)

328 
	`¥ötk
("%† Re£rved Comm™d\n", 
îr_¥öt_¥efix
);

329 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__HPQFULL
)

330 
	`¥ötk
("%s HP Transaction Received while Queue Full\n",

331 
îr_¥öt_¥efix
);

332 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__LPQFULL
)

333 
	`¥ötk
("%s LP Transaction Received while Queue Full\n",

334 
îr_¥öt_¥efix
);

335 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__LOST
)

336 
	`¥ötk
("%† Lo° Eº‹\n", 
îr_¥öt_¥efix
);

337 
	`¥ötk
("%s Command: 0x%x - %s, %d Quadwords%s\n"

339 
îr_¥öt_¥efix
, 
cmd
, 
ag≥º‹_cmd
[cmd], 
Àn
,

340 (
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__FENCE
) ? ", FENCE" : "",

341 
addr
);

342 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__DAC
)

343 
	`¥ötk
("%† DuÆ Addªs†Cy˛e\n", 
îr_¥öt_¥efix
);

344 i‡(
ag≥º‹
 & 
TITAN__PCHIP_AGPERROR__MWIN
)

345 
	`¥ötk
("%† Hô i¿M⁄°î Wödow\n", 
îr_¥öt_¥efix
);

348  
°©us
;

349 
	}
}

352 
	$tô™_∑r£_p_chù
(
which
, 
u64
 
£º‹
, u64 
g≥º‹
,

353 
u64
 
≠îr‹
, u64 
ag≥º‹
, 
¥öt
)

355 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

356 
°©us
 |
	`tô™_∑r£_p_£º‹
(
which
, 
£º‹
, 
¥öt
);

357 
°©us
 |
	`tô™_∑r£_p_≥º‹
(
which
, 0, 
g≥º‹
, 
¥öt
);

358 
°©us
 |
	`tô™_∑r£_p_≥º‹
(
which
, 1, 
≠îr‹
, 
¥öt
);

359 
°©us
 |
	`tô™_∑r£_p_ag≥º‹
(
which
, 
ag≥º‹
, 
¥öt
);

360  
°©us
;

361 
	}
}

364 
	$tô™_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *
mchk_hódî
, 
¥öt
)

366 
ñ_TITAN_sysd©a_mcheck
 *
tmchk
 =

367 (
ñ_TITAN_sysd©a_mcheck
 *)

368 (()
mchk_hódî
 + mchk_hódî->
sys_off£t
);

369 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

371 
°©us
 |
	`tô™_∑r£_c_misc
(
tmchk
->
c_misc
, 
¥öt
);

372 
°©us
 |
	`tô™_∑r£_p_chù
(0, 
tmchk
->
p0_£º‹
,Åmchk->
p0_g≥º‹
,

373 
tmchk
->
p0_≠îr‹
,Åmchk->
p0_ag≥º‹
,

374 
¥öt
);

375 
°©us
 |
	`tô™_∑r£_p_chù
(1, 
tmchk
->
p1_£º‹
,Åmchk->
p1_g≥º‹
,

376 
tmchk
->
p1_≠îr‹
,Åmchk->
p1_ag≥º‹
,

377 
¥öt
);

379  
°©us
;

380 
	}
}

383 
	$tô™_machöe_check
(
u64
 
ve˘‹
, u64 
œ_±r
)

385 
ñ_comm⁄
 *
mchk_hódî
 = (ñ_comm⁄ *)
œ_±r
;

386 
ñ_TITAN_sysd©a_mcheck
 *
tmchk
 =

387 (
ñ_TITAN_sysd©a_mcheck
 *)

388 (()
mchk_hódî
 + mchk_hódî->
sys_off£t
);

389 
u64
 
úqmask
;

400 
	#TITAN_MCHECK_INTERRUPT_MASK
 0xF800000000000000UL

	)

405 
	`mb
();

406 
	`døöa
();

411 i‡((
ve˘‹
 !
SCB_Q_SYSMCHK
Ë&& (ve˘‹ !
SCB_Q_SYSERR
)) {

412 
	`ev6_machöe_check
(
ve˘‹
, 
œ_±r
);

427 i‡(
	`tô™_¥o˚ss_logout_‰ame
(
mchk_hódî
, 0) !=

428 
MCHK_DISPOSITION_DISMISS
) {

429 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

430 
îr_¥öt_¥efix
 = 
KERN_CRIT
;

437 
	`¥ötk
("%s"

439 
îr_¥öt_¥efix
,

440 (
ve˘‹
 =
SCB_Q_SYSERR
)?"Correctable":"Uncorrectable",

441 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

443 #ifde‡
CONFIG_VERBOSE_MCHECK


444 
	`tô™_¥o˚ss_logout_‰ame
(
mchk_hódî
, 
Æpha_vîbo£_mcheck
);

445 i‡(
Æpha_vîbo£_mcheck
)

446 
	`dik_show_ªgs
(
	`gë_úq_ªgs
(), 
NULL
);

449 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

455 
úqmask
 = 
tmchk
->
c_dúx
 & 
TITAN_MCHECK_INTERRUPT_MASK
;

456 
	`tô™_di•©ch_úqs
(
úqmask
);

463 
	`wrm˚s
(0x7);

464 
	`mb
();

465 
	}
}

470 *
	gñ_tô™_pchù0_exãnded_™nŸ©i⁄
[] = {

482 "P0_GTBA3", 
NULL


484 *
	gñ_tô™_pchù1_exãnded_™nŸ©i⁄
[] = {

496 "P1_GTBA3", 
NULL


498 *
	gñ_tô™_mem‹y_exãnded_™nŸ©i⁄
[] = {

502 "P1_GPCTL", "P1_SCTL", 
NULL


505 
ñ_sub∑ckë_™nŸ©i⁄
 
	gñ_tô™_™nŸ©i⁄s
[] = {

506 
SUBPACKET_ANNOTATION
(
EL_CLASS__REGATTA_FAMILY
,

507 
EL_TYPE__REGATTA__TITAN_PCHIP0_EXTENDED
,

510 
ñ_tô™_pchù0_exãnded_™nŸ©i⁄
),

511 
SUBPACKET_ANNOTATION
(
EL_CLASS__REGATTA_FAMILY
,

512 
EL_TYPE__REGATTA__TITAN_PCHIP1_EXTENDED
,

515 
ñ_tô™_pchù1_exãnded_™nŸ©i⁄
),

516 
SUBPACKET_ANNOTATION
(
EL_CLASS__REGATTA_FAMILY
,

517 
EL_TYPE__REGATTA__TITAN_MEMORY_EXTENDED
,

520 
ñ_tô™_mem‹y_exãnded_™nŸ©i⁄
),

521 
SUBPACKET_ANNOTATION
(
EL_CLASS__REGATTA_FAMILY
,

522 
EL_TYPE__TERMINATION__TERMINATION
,

525 
NULL
)

528 
ñ_sub∑ckë
 *

529 
	$ñ_¥o˚ss_ªg©è_sub∑ckë
(
ñ_sub∑ckë
 *
hódî
)

531 
°©us
;

533 i‡(
hódî
->
˛ass
 !
EL_CLASS__REGATTA_FAMILY
) {

534 
	`¥ötk
("%s ** Unexpected header CLASS %d TYPE %d,áborting\n",

535 
îr_¥öt_¥efix
,

536 
hódî
->
˛ass
, hódî->
ty≥
);

537  
NULL
;

540 
hódî
->
ty≥
) {

541 
EL_TYPE__REGATTA__PROCESSOR_ERROR_FRAME
:

542 
EL_TYPE__REGATTA__SYSTEM_ERROR_FRAME
:

543 
EL_TYPE__REGATTA__ENVIRONMENTAL_FRAME
:

544 
EL_TYPE__REGATTA__PROCESSOR_DBL_ERROR_HALT
:

545 
EL_TYPE__REGATTA__SYSTEM_DBL_ERROR_HALT
:

546 
	`¥ötk
("%s ** Occurred on CPU %d:\n",

547 
îr_¥öt_¥efix
,

548 ()
hódî
->
by_ty≥
.
ªg©è_‰ame
.
˝uid
);

549 
°©us
 = 
	`¥iv©ìr_¥o˚ss_logout_‰ame
((
ñ_comm⁄
 *)

550 
hódî
->
by_ty≥
.
ªg©è_‰ame
.
d©a_°¨t
, 1);

553 
	`¥ötk
("%s ** REGATTA TYPE %d SUBPACKET\n",

554 
îr_¥öt_¥efix
, 
hódî
->
ty≥
);

555 
	`ñ_™nŸ©e_sub∑ckë
(
hódî
);

560  (
ñ_sub∑ckë
 *)(()
hódî
 + hódî->
Àngth
);

561 
	}
}

563 
ñ_sub∑ckë_h™dÀr
 
	gtô™_sub∑ckë_h™dÀr
 =

564 
SUBPACKET_HANDLER_INIT
(
EL_CLASS__REGATTA_FAMILY
,

565 
ñ_¥o˚ss_ªg©è_sub∑ckë
);

568 
	$tô™_ªgi°î_îr‹_h™dÀrs
()

570 
size_t
 
i
;

572 
i
 = 0; i < 
	`ARRAY_SIZE
 (
ñ_tô™_™nŸ©i⁄s
); i++)

573 
	`cdl_ªgi°î_sub∑ckë_™nŸ©i⁄
(&
ñ_tô™_™nŸ©i⁄s
[
i
]);

575 
	`cdl_ªgi°î_sub∑ckë_h™dÀr
(&
tô™_sub∑ckë_h™dÀr
);

577 
	`ev6_ªgi°î_îr‹_h™dÀrs
();

578 
	}
}

586 
	$¥iv©ìr_¥o˚ss_680_‰ame
(
ñ_comm⁄
 *
mchk_hódî
, 
¥öt
)

588 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

589 #ifde‡
CONFIG_VERBOSE_MCHECK


590 
ñ_PRIVATEER_ívd©a_mcheck
 *
emchk
 =

591 (
ñ_PRIVATEER_ívd©a_mcheck
 *)

592 (()
mchk_hódî
 + mchk_hódî->
sys_off£t
);

596 i‡(!
¥öt
)

597  
°©us
;

600 
	`¥ötk
("%s Summary Flags: %016lx\n"

610 
îr_¥öt_¥efix
,

611 
emchk
->
summ¨y
,

612 
emchk
->
c_dúx
,

613 
emchk
->
smú
,

614 
emchk
->
˝uú
,

615 
emchk
->
psú
,

616 
emchk
->
Áu…
,

617 
emchk
->
sys_do‹s
,

618 
emchk
->
ãmp_w¨n
,

619 
emchk
->
Án_˘æ
,

620 
emchk
->
code
);

623  
°©us
;

624 
	}
}

627 
	$¥iv©ìr_¥o˚ss_logout_‰ame
(
ñ_comm⁄
 *
mchk_hódî
, 
¥öt
)

629 
ñ_comm⁄_EV6_mcheck
 *
ev6mchk
 =

630 (
ñ_comm⁄_EV6_mcheck
 *)
mchk_hódî
;

631 
°©us
 = 
MCHK_DISPOSITION_UNKNOWN_ERROR
;

636 
	#PRIVATEER_MCHK__CORR_ECC
 0x86

	)

637 
	#PRIVATEER_MCHK__DC_TAG_PERR
 0x9E

	)

638 
	#PRIVATEER_MCHK__PAL_BUGCHECK
 0x8E

	)

639 
	#PRIVATEER_MCHK__OS_BUGCHECK
 0x90

	)

640 
	#PRIVATEER_MCHK__PROC_HRD_ERR
 0x98

	)

641 
	#PRIVATEER_MCHK__ISTREAM_CMOV_PRX
 0xA0

	)

642 
	#PRIVATEER_MCHK__ISTREAM_CMOV_FLT
 0xA2

	)

643 
	#PRIVATEER_MCHK__SYS_HRD_ERR
 0x202

	)

644 
	#PRIVATEER_MCHK__SYS_CORR_ERR
 0x204

	)

645 
	#PRIVATEER_MCHK__SYS_ENVIRON
 0x206

	)

647 
ev6mchk
->
MCHK_Code
) {

651 
PRIVATEER_MCHK__CORR_ECC
:

652 
PRIVATEER_MCHK__DC_TAG_PERR
:

659 
PRIVATEER_MCHK__PAL_BUGCHECK
:

660 
PRIVATEER_MCHK__OS_BUGCHECK
:

661 
PRIVATEER_MCHK__PROC_HRD_ERR
:

662 
PRIVATEER_MCHK__ISTREAM_CMOV_PRX
:

663 
PRIVATEER_MCHK__ISTREAM_CMOV_FLT
:

664 
°©us
 |
	`ev6_¥o˚ss_logout_‰ame
(
mchk_hódî
, 
¥öt
);

670 
PRIVATEER_MCHK__SYS_CORR_ERR
:

677 
PRIVATEER_MCHK__SYS_HRD_ERR
:

678 
°©us
 |
	`tô™_¥o˚ss_logout_‰ame
(
mchk_hódî
, 
¥öt
);

684 
PRIVATEER_MCHK__SYS_ENVIRON
:

685 
°©us
 |
	`¥iv©ìr_¥o˚ss_680_‰ame
(
mchk_hódî
, 
¥öt
);

692 
°©us
 |
MCHK_DISPOSITION_REPORT
;

693 i‡(
¥öt
) {

694 
	`¥ötk
("%s** Unknown Error, frame follows\n",

695 
îr_¥öt_¥efix
);

696 
	`mchk_dump_logout_‰ame
(
mchk_hódî
);

701  
°©us
;

702 
	}
}

705 
	$¥iv©ìr_machöe_check
(
u64
 
ve˘‹
, u64 
œ_±r
)

707 
ñ_comm⁄
 *
mchk_hódî
 = (ñ_comm⁄ *)
œ_±r
;

708 
ñ_TITAN_sysd©a_mcheck
 *
tmchk
 =

709 (
ñ_TITAN_sysd©a_mcheck
 *)

710 (
œ_±r
 + 
mchk_hódî
->
sys_off£t
);

711 
u64
 
úqmask
;

712 *
ßved_îr_¥efix
 = 
îr_¥öt_¥efix
;

714 
	#PRIVATEER_680_INTERRUPT_MASK
 (0xE00UL)

	)

715 
	#PRIVATEER_HOTPLUG_INTERRUPT_MASK
 (0xE00UL)

	)

720 
	`mb
();

721 
	`døöa
();

726 i‡(
ve˘‹
 !
SCB_Q_SYSEVENT
)

727  
	`tô™_machöe_check
(
ve˘‹
, 
œ_±r
);

734 
îr_¥öt_¥efix
 = 
KERN_CRIT
;

735 
	`¥ötk
("%s*System Event (Vector 0x%x)Ñeported on CPU %d:\n",

736 
îr_¥öt_¥efix
,

737 ()
ve˘‹
, ()
	`smp_¥o˚ss‹_id
());

738 
	`¥iv©ìr_¥o˚ss_680_‰ame
(
mchk_hódî
, 1);

739 
îr_¥öt_¥efix
 = 
ßved_îr_¥efix
;

745 
úqmask
 = 
tmchk
->
c_dúx
 & 
PRIVATEER_680_INTERRUPT_MASK
;

750 
	`tô™_di•©ch_úqs
(
úqmask
);

755 
	`wrm˚s
(0x7);

756 
	`mb
();

757 
	}
}

	@arch/alpha/kernel/es1888.c

7 
	~<löux/öô.h
>

8 
	~<asm/io.h
>

9 
	~"¥Ÿo.h
"

11 
__öô


12 
	$es1888_öô
()

15 
	`öb
(0x0229);

16 
	`öb
(0x0229);

17 
	`öb
(0x0229);

18 
	`öb
(0x022b);

19 
	`öb
(0x0229);

20 
	`öb
(0x022b);

21 
	`öb
(0x0229);

22 
	`öb
(0x0229);

23 
	`öb
(0x022b);

24 
	`öb
(0x0229);

25 
	`öb
(0x0220);

28 
	`outb
(0x01, 0x0226);

29 
	`öb
(0x0226);

30 
	`outb
(0x00, 0x0226);

31 !(
	`öb
(0x022e) & 0x80))

33 
	`öb
(0x022a);

34 
	`outb
(0xc6, 0x022c);

35 
	`öb
(0x022a);

36 
	`öb
(0x022c) & 0x80)

38 
	`outb
(0xb1, 0x022c);

39 
	`öb
(0x022c) & 0x80)

41 
	`outb
(0x14, 0x022c);

42 
	`öb
(0x022c) & 0x80)

44 
	`outb
(0xb2, 0x022c);

45 
	`öb
(0x022c) & 0x80)

47 
	`outb
(0x18, 0x022c);

48 
	`öb
(0x022c);

49 
	}
}

	@arch/alpha/kernel/gct.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<löux/î∫o.h
>

9 
	~<asm/hwΩb.h
>

10 
	~<asm/g˘.h
>

13 
	$g˘6_föd_nodes
(
g˘6_node
 *
node
, 
g˘6_£¨ch_°ru˘
 *
£¨ch
)

15 
g˘6_£¨ch_°ru˘
 *
w™ãd
;

16 
°©us
 = 0;

19 i‡(
node
->
magic
 !
GCT_NODE_MAGIC
) {

20 
	`¥ötk
(
KERN_ERR
 "GCT Node MAGIC incorrect - GCT invalid\n");

21  -
EINVAL
;

25 
w™ãd
 = 
£¨ch
;

26 
w™ãd
 && (w™ãd->
ty≥
 | w™ãd->
subty≥
);

27 
w™ãd
++) {

28 i‡(
node
->
ty≥
 !
w™ãd
->type)

30 i‡(
node
->
subty≥
 !
w™ãd
->subtype)

34 i‡(
w™ãd
->
ˇŒout
)

35 
w™ãd
->
	`ˇŒout
(
node
);

39 i‡(
node
->
√xt
)

40 
°©us
 |
	`g˘6_föd_nodes
(
	`GCT_NODE_PTR
(
node
->
√xt
), 
£¨ch
);

43 i‡(
node
->
chûd
)

44 
°©us
 |
	`g˘6_föd_nodes
(
	`GCT_NODE_PTR
(
node
->
chûd
), 
£¨ch
);

46  
°©us
;

47 
	}
}

	@arch/alpha/kernel/init_task.c

1 
	~<löux/mm.h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/sched.h
>

4 
	~<löux/öô.h
>

5 
	~<löux/öô_èsk.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/mqueue.h
>

8 
	~<asm/uac˚ss.h
>

11 
fs_°ru˘
 
	göô_fs
 = 
INIT_FS
;

12 
fûes_°ru˘
 
	göô_fûes
 = 
INIT_FILES
;

13 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

14 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

15 
mm_°ru˘
 
	göô_mm
 = 
INIT_MM
(
öô_mm
);

16 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

18 
EXPORT_SYMBOL
(
öô_mm
);

19 
EXPORT_SYMBOL
(
öô_èsk
);

21 
thªad_uni⁄
 
öô_thªad_uni⁄


22 
__©åibuã__
((
£˘i⁄
(".data.init_thread")))

23 { 
INIT_THREAD_INFO
(
öô_èsk
) };

	@arch/alpha/kernel/io.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<asm/io.h
>

16 
	$i‹ód8
(
__iomem
 *
addr
)

18 
ªt
 = 
	`IO_CONCAT
(
__IO_PREFIX
,
i‹ód8
)(
addr
);

19 
	`mb
();

20  
ªt
;

21 
	}
}

23 
	$i‹ód16
(
__iomem
 *
addr
)

25 
ªt
 = 
	`IO_CONCAT
(
__IO_PREFIX
,
i‹ód16
)(
addr
);

26 
	`mb
();

27  
ªt
;

28 
	}
}

30 
	$i‹ód32
(
__iomem
 *
addr
)

32 
ªt
 = 
	`IO_CONCAT
(
__IO_PREFIX
,
i‹ód32
)(
addr
);

33 
	`mb
();

34  
ªt
;

35 
	}
}

37 
	$iowrôe8
(
u8
 
b
, 
__iomem
 *
addr
)

39 
	`IO_CONCAT
(
__IO_PREFIX
,
iowrôe8
)(
b
, 
addr
);

40 
	`mb
();

41 
	}
}

43 
	$iowrôe16
(
u16
 
b
, 
__iomem
 *
addr
)

45 
	`IO_CONCAT
(
__IO_PREFIX
,
iowrôe16
)(
b
, 
addr
);

46 
	`mb
();

47 
	}
}

49 
	$iowrôe32
(
u32
 
b
, 
__iomem
 *
addr
)

51 
	`IO_CONCAT
(
__IO_PREFIX
,
iowrôe32
)(
b
, 
addr
);

52 
	`mb
();

53 
	}
}

55 
EXPORT_SYMBOL
(
i‹ód8
);

56 
EXPORT_SYMBOL
(
i‹ód16
);

57 
EXPORT_SYMBOL
(
i‹ód32
);

58 
EXPORT_SYMBOL
(
iowrôe8
);

59 
EXPORT_SYMBOL
(
iowrôe16
);

60 
EXPORT_SYMBOL
(
iowrôe32
);

62 
u8
 
	$öb
(
p‹t
)

64  
	`i‹ód8
(
	`i›‹t_m≠
(
p‹t
, 1));

65 
	}
}

67 
u16
 
	$öw
(
p‹t
)

69  
	`i‹ód16
(
	`i›‹t_m≠
(
p‹t
, 2));

70 
	}
}

72 
u32
 
	$öl
(
p‹t
)

74  
	`i‹ód32
(
	`i›‹t_m≠
(
p‹t
, 4));

75 
	}
}

77 
	$outb
(
u8
 
b
, 
p‹t
)

79 
	`iowrôe8
(
b
, 
	`i›‹t_m≠
(
p‹t
, 1));

80 
	}
}

82 
	$outw
(
u16
 
b
, 
p‹t
)

84 
	`iowrôe16
(
b
, 
	`i›‹t_m≠
(
p‹t
, 2));

85 
	}
}

87 
	$oué
(
u32
 
b
, 
p‹t
)

89 
	`iowrôe32
(
b
, 
	`i›‹t_m≠
(
p‹t
, 4));

90 
	}
}

92 
EXPORT_SYMBOL
(
öb
);

93 
EXPORT_SYMBOL
(
öw
);

94 
EXPORT_SYMBOL
(
öl
);

95 
EXPORT_SYMBOL
(
outb
);

96 
EXPORT_SYMBOL
(
outw
);

97 
EXPORT_SYMBOL
(
oué
);

99 
u8
 
	$__øw_ªadb
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

101  
	`IO_CONCAT
(
__IO_PREFIX
,
ªadb
)(
addr
);

102 
	}
}

104 
u16
 
	$__øw_ªadw
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

106  
	`IO_CONCAT
(
__IO_PREFIX
,
ªadw
)(
addr
);

107 
	}
}

109 
u32
 
	$__øw_ªadl
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

111  
	`IO_CONCAT
(
__IO_PREFIX
,
ªadl
)(
addr
);

112 
	}
}

114 
u64
 
	$__øw_ªadq
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

116  
	`IO_CONCAT
(
__IO_PREFIX
,
ªadq
)(
addr
);

117 
	}
}

119 
	$__øw_wrôeb
(
u8
 
b
, vﬁ©ûê
__iomem
 *
addr
)

121 
	`IO_CONCAT
(
__IO_PREFIX
,
wrôeb
)(
b
, 
addr
);

122 
	}
}

124 
	$__øw_wrôew
(
u16
 
b
, vﬁ©ûê
__iomem
 *
addr
)

126 
	`IO_CONCAT
(
__IO_PREFIX
,
wrôew
)(
b
, 
addr
);

127 
	}
}

129 
	$__øw_wrôñ
(
u32
 
b
, vﬁ©ûê
__iomem
 *
addr
)

131 
	`IO_CONCAT
(
__IO_PREFIX
,
wrôñ
)(
b
, 
addr
);

132 
	}
}

134 
	$__øw_wrôeq
(
u64
 
b
, vﬁ©ûê
__iomem
 *
addr
)

136 
	`IO_CONCAT
(
__IO_PREFIX
,
wrôeq
)(
b
, 
addr
);

137 
	}
}

139 
EXPORT_SYMBOL
(
__øw_ªadb
);

140 
EXPORT_SYMBOL
(
__øw_ªadw
);

141 
EXPORT_SYMBOL
(
__øw_ªadl
);

142 
EXPORT_SYMBOL
(
__øw_ªadq
);

143 
EXPORT_SYMBOL
(
__øw_wrôeb
);

144 
EXPORT_SYMBOL
(
__øw_wrôew
);

145 
EXPORT_SYMBOL
(
__øw_wrôñ
);

146 
EXPORT_SYMBOL
(
__øw_wrôeq
);

148 
u8
 
	$ªadb
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

150 
u8
 
ªt
 = 
	`__øw_ªadb
(
addr
);

151 
	`mb
();

152  
ªt
;

153 
	}
}

155 
u16
 
	$ªadw
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

157 
u16
 
ªt
 = 
	`__øw_ªadw
(
addr
);

158 
	`mb
();

159  
ªt
;

160 
	}
}

162 
u32
 
	$ªadl
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

164 
u32
 
ªt
 = 
	`__øw_ªadl
(
addr
);

165 
	`mb
();

166  
ªt
;

167 
	}
}

169 
u64
 
	$ªadq
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

171 
u64
 
ªt
 = 
	`__øw_ªadq
(
addr
);

172 
	`mb
();

173  
ªt
;

174 
	}
}

176 
	$wrôeb
(
u8
 
b
, vﬁ©ûê
__iomem
 *
addr
)

178 
	`__øw_wrôeb
(
b
, 
addr
);

179 
	`mb
();

180 
	}
}

182 
	$wrôew
(
u16
 
b
, vﬁ©ûê
__iomem
 *
addr
)

184 
	`__øw_wrôew
(
b
, 
addr
);

185 
	`mb
();

186 
	}
}

188 
	$wrôñ
(
u32
 
b
, vﬁ©ûê
__iomem
 *
addr
)

190 
	`__øw_wrôñ
(
b
, 
addr
);

191 
	`mb
();

192 
	}
}

194 
	$wrôeq
(
u64
 
b
, vﬁ©ûê
__iomem
 *
addr
)

196 
	`__øw_wrôeq
(
b
, 
addr
);

197 
	`mb
();

198 
	}
}

200 
EXPORT_SYMBOL
(
ªadb
);

201 
EXPORT_SYMBOL
(
ªadw
);

202 
EXPORT_SYMBOL
(
ªadl
);

203 
EXPORT_SYMBOL
(
ªadq
);

204 
EXPORT_SYMBOL
(
wrôeb
);

205 
EXPORT_SYMBOL
(
wrôew
);

206 
EXPORT_SYMBOL
(
wrôñ
);

207 
EXPORT_SYMBOL
(
wrôeq
);

213 
	$i‹ód8_ªp
(
__iomem
 *
p‹t
, *
d°
, 
cou¡
)

215 ()
d°
 & 0x3) {

216 i‡(!
cou¡
)

218 
cou¡
--;

219 *(*)
d°
 = 
	`i‹ód8
(
p‹t
);

220 
d°
 += 1;

223 
cou¡
 >= 4) {

224 
w
;

225 
cou¡
 -= 4;

226 
w
 = 
	`i‹ód8
(
p‹t
);

227 
w
 |
	`i‹ód8
(
p‹t
) << 8;

228 
w
 |
	`i‹ód8
(
p‹t
) << 16;

229 
w
 |
	`i‹ód8
(
p‹t
) << 24;

230 *(*)
d°
 = 
w
;

231 
d°
 += 4;

234 
cou¡
) {

235 --
cou¡
;

236 *(*)
d°
 = 
	`i‹ód8
(
p‹t
);

237 
d°
 += 1;

239 
	}
}

241 
	$ösb
(
p‹t
, *
d°
, 
cou¡
)

243 
	`i‹ód8_ªp
(
	`i›‹t_m≠
(
p‹t
, 1), 
d°
, 
cou¡
);

244 
	}
}

246 
EXPORT_SYMBOL
(
i‹ód8_ªp
);

247 
EXPORT_SYMBOL
(
ösb
);

256 
	$i‹ód16_ªp
(
__iomem
 *
p‹t
, *
d°
, 
cou¡
)

258 i‡(
	`u∆ikñy
(()
d°
 & 0x3)) {

259 i‡(!
cou¡
)

261 
	`BUG_ON
(()
d°
 & 0x1);

262 
cou¡
--;

263 *(*)
d°
 = 
	`i‹ód16
(
p‹t
);

264 
d°
 += 2;

267 
cou¡
 >= 2) {

268 
w
;

269 
cou¡
 -= 2;

270 
w
 = 
	`i‹ód16
(
p‹t
);

271 
w
 |
	`i‹ód16
(
p‹t
) << 16;

272 *(*)
d°
 = 
w
;

273 
d°
 += 4;

276 i‡(
cou¡
) {

277 *(*)
d°
 = 
	`i‹ód16
(
p‹t
);

279 
	}
}

281 
	$ösw
(
p‹t
, *
d°
, 
cou¡
)

283 
	`i‹ód16_ªp
(
	`i›‹t_m≠
(
p‹t
, 2), 
d°
, 
cou¡
);

284 
	}
}

286 
EXPORT_SYMBOL
(
i‹ód16_ªp
);

287 
EXPORT_SYMBOL
(
ösw
);

296 
	$i‹ód32_ªp
(
__iomem
 *
p‹t
, *
d°
, 
cou¡
)

298 i‡(
	`u∆ikñy
(()
d°
 & 0x3)) {

299 
cou¡
--) {

300 
	sS
 { 
x
 
	`__©åibuã__
((
∑cked
)); };

301 ((
S
 *)
d°
)->
x
 = 
	`i‹ód32
(
p‹t
);

302 
d°
 += 4;

306 
cou¡
--) {

307 *(*)
d°
 = 
	`i‹ód32
(
p‹t
);

308 
d°
 += 4;

311 
	}
}

313 
	$ö¶
(
p‹t
, *
d°
, 
cou¡
)

315 
	`i‹ód32_ªp
(
	`i›‹t_m≠
(
p‹t
, 4), 
d°
, 
cou¡
);

316 
	}
}

318 
EXPORT_SYMBOL
(
i‹ód32_ªp
);

319 
EXPORT_SYMBOL
(
ö¶
);

328 
	$iowrôe8_ªp
(
__iomem
 *
p‹t
, c⁄° *
x§c
, 
cou¡
)

330 c⁄° *
§c
 = 
x§c
;

331 
cou¡
--)

332 
	`iowrôe8
(*
§c
++, 
p‹t
);

333 
	}
}

335 
	$outsb
(
p‹t
, c⁄° *
§c
, 
cou¡
)

337 
	`iowrôe8_ªp
(
	`i›‹t_m≠
(
p‹t
, 1), 
§c
, 
cou¡
);

338 
	}
}

340 
EXPORT_SYMBOL
(
iowrôe8_ªp
);

341 
EXPORT_SYMBOL
(
outsb
);

350 
	$iowrôe16_ªp
(
__iomem
 *
p‹t
, c⁄° *
§c
, 
cou¡
)

352 i‡(
	`u∆ikñy
(()
§c
 & 0x3)) {

353 i‡(!
cou¡
)

355 
	`BUG_ON
(()
§c
 & 0x1);

356 
	`iowrôe16
(*(*)
§c
, 
p‹t
);

357 
§c
 += 2;

358 --
cou¡
;

361 
cou¡
 >= 2) {

362 
w
;

363 
cou¡
 -= 2;

364 
w
 = *(*)
§c
;

365 
§c
 += 4;

366 
	`iowrôe16
(
w
 >> 0, 
p‹t
);

367 
	`iowrôe16
(
w
 >> 16, 
p‹t
);

370 i‡(
cou¡
) {

371 
	`iowrôe16
(*(*)
§c
, 
p‹t
);

373 
	}
}

375 
	$outsw
(
p‹t
, c⁄° *
§c
, 
cou¡
)

377 
	`iowrôe16_ªp
(
	`i›‹t_m≠
(
p‹t
, 2), 
§c
, 
cou¡
);

378 
	}
}

380 
EXPORT_SYMBOL
(
iowrôe16_ªp
);

381 
EXPORT_SYMBOL
(
outsw
);

390 
	$iowrôe32_ªp
(
__iomem
 *
p‹t
, c⁄° *
§c
, 
cou¡
)

392 i‡(
	`u∆ikñy
(()
§c
 & 0x3)) {

393 
cou¡
--) {

394 
	sS
 { 
x
 
	`__©åibuã__
((
∑cked
)); };

395 
	`iowrôe32
(((
S
 *)
§c
)->
x
, 
p‹t
);

396 
§c
 += 4;

400 
cou¡
--) {

401 
	`iowrôe32
(*(*)
§c
, 
p‹t
);

402 
§c
 += 4;

405 
	}
}

407 
	$out¶
(
p‹t
, c⁄° *
§c
, 
cou¡
)

409 
	`iowrôe32_ªp
(
	`i›‹t_m≠
(
p‹t
, 4), 
§c
, 
cou¡
);

410 
	}
}

412 
EXPORT_SYMBOL
(
iowrôe32_ªp
);

413 
EXPORT_SYMBOL
(
out¶
);

420 
	$mem˝y_‰omio
(*
to
, c⁄° vﬁ©ûê
__iomem
 *
‰om
, 
cou¡
)

425 i‡(
cou¡
 >8 && ((
u64
)
to
 & 7Ë=((u64)
‰om
 & 7)) {

426 
cou¡
 -= 8;

428 *(
u64
 *)
to
 = 
	`__øw_ªadq
(
‰om
);

429 
cou¡
 -= 8;

430 
to
 += 8;

431 
‰om
 += 8;

432 } 
cou¡
 >= 0);

433 
cou¡
 += 8;

436 i‡(
cou¡
 >4 && ((
u64
)
to
 & 3Ë=((u64)
‰om
 & 3)) {

437 
cou¡
 -= 4;

439 *(
u32
 *)
to
 = 
	`__øw_ªadl
(
‰om
);

440 
cou¡
 -= 4;

441 
to
 += 4;

442 
‰om
 += 4;

443 } 
cou¡
 >= 0);

444 
cou¡
 += 4;

447 i‡(
cou¡
 >2 && ((
u64
)
to
 & 1Ë=((u64)
‰om
 & 1)) {

448 
cou¡
 -= 2;

450 *(
u16
 *)
to
 = 
	`__øw_ªadw
(
‰om
);

451 
cou¡
 -= 2;

452 
to
 += 2;

453 
‰om
 += 2;

454 } 
cou¡
 >= 0);

455 
cou¡
 += 2;

458 
cou¡
 > 0) {

459 *(
u8
 *Ë
to
 = 
	`__øw_ªadb
(
‰om
);

460 
cou¡
--;

461 
to
++;

462 
‰om
++;

464 
	`mb
();

465 
	}
}

467 
EXPORT_SYMBOL
(
mem˝y_‰omio
);

474 
	$mem˝y_toio
(vﬁ©ûê
__iomem
 *
to
, c⁄° *
‰om
, 
cou¡
)

480 i‡(
cou¡
 >8 && ((
u64
)
to
 & 7Ë=((u64)
‰om
 & 7)) {

481 
cou¡
 -= 8;

483 
	`__øw_wrôeq
(*(c⁄° 
u64
 *)
‰om
, 
to
);

484 
cou¡
 -= 8;

485 
to
 += 8;

486 
‰om
 += 8;

487 } 
cou¡
 >= 0);

488 
cou¡
 += 8;

491 i‡(
cou¡
 >4 && ((
u64
)
to
 & 3Ë=((u64)
‰om
 & 3)) {

492 
cou¡
 -= 4;

494 
	`__øw_wrôñ
(*(c⁄° 
u32
 *)
‰om
, 
to
);

495 
cou¡
 -= 4;

496 
to
 += 4;

497 
‰om
 += 4;

498 } 
cou¡
 >= 0);

499 
cou¡
 += 4;

502 i‡(
cou¡
 >2 && ((
u64
)
to
 & 1Ë=((u64)
‰om
 & 1)) {

503 
cou¡
 -= 2;

505 
	`__øw_wrôew
(*(c⁄° 
u16
 *)
‰om
, 
to
);

506 
cou¡
 -= 2;

507 
to
 += 2;

508 
‰om
 += 2;

509 } 
cou¡
 >= 0);

510 
cou¡
 += 2;

513 
cou¡
 > 0) {

514 
	`__øw_wrôeb
(*(c⁄° 
u8
 *Ë
‰om
, 
to
);

515 
cou¡
--;

516 
to
++;

517 
‰om
++;

519 
	`mb
();

520 
	}
}

522 
EXPORT_SYMBOL
(
mem˝y_toio
);

528 
	$_mem£t_c_io
(vﬁ©ûê
__iomem
 *
to
, 
c
, 
cou¡
)

531 i‡(
cou¡
 > 0 && ((
u64
)
to
 & 1)) {

532 
	`__øw_wrôeb
(
c
, 
to
);

533 
to
++;

534 
cou¡
--;

538 i‡(
cou¡
 >2 && ((
u64
)
to
 & 2)) {

539 
	`__øw_wrôew
(
c
, 
to
);

540 
to
 += 2;

541 
cou¡
 -= 2;

545 i‡(
cou¡
 >4 && ((
u64
)
to
 & 4)) {

546 
	`__øw_wrôñ
(
c
, 
to
);

547 
to
 += 4;

548 
cou¡
 -= 4;

553 
cou¡
 -= 8;

554 i‡(
cou¡
 >= 0) {

556 
	`__øw_wrôeq
(
c
, 
to
);

557 
to
 += 8;

558 
cou¡
 -= 8;

559 } 
cou¡
 >= 0);

561 
cou¡
 += 8;

564 i‡(
cou¡
 >= 4) {

565 
	`__øw_wrôñ
(
c
, 
to
);

566 
to
 += 4;

567 
cou¡
 -= 4;

571 i‡(
cou¡
 >= 2) {

572 
	`__øw_wrôew
(
c
, 
to
);

573 
to
 += 2;

574 
cou¡
 -= 2;

578 i‡(
cou¡
) {

579 
	`__øw_wrôeb
(
c
, 
to
);

581 
	`mb
();

582 
	}
}

584 
EXPORT_SYMBOL
(
_mem£t_c_io
);

590 
	$s¸_mem˝yw
(
u16
 *
d
, c⁄° u16 *
s
, 
cou¡
)

592 c⁄° 
u16
 
__iomem
 *
ios
 = (c⁄° u16 __iomem *Ë
s
;

593 
u16
 
__iomem
 *
iod
 = (u16 __iomem *Ë
d
;

594 
s_isio
 = 
	`__is_iﬂddr
(
s
);

595 
d_isio
 = 
	`__is_iﬂddr
(
d
);

597 i‡(
s_isio
) {

598 i‡(
d_isio
) {

602 
cou¡
 /= 2;

603 
cou¡
--) {

604 
u16
 
tmp
 = 
	`__øw_ªadw
(
ios
++);

605 
	`__øw_wrôew
(
tmp
, 
iod
++);

609 
	`mem˝y_‰omio
(
d
, 
ios
, 
cou¡
);

611 i‡(
d_isio
)

612 
	`mem˝y_toio
(
iod
, 
s
, 
cou¡
);

614 
	`mem˝y
(
d
, 
s
, 
cou¡
);

616 
	}
}

618 
EXPORT_SYMBOL
(
s¸_mem˝yw
);

620 
__iomem
 *
	$i›‹t_m≠
(
p‹t
, 
size
)

622  
	`IO_CONCAT
(
__IO_PREFIX
,
i›‹tm≠
Ë(
p‹t
);

623 
	}
}

625 
	$i›‹t_unm≠
(
__iomem
 *
addr
)

627 
	}
}

629 
EXPORT_SYMBOL
(
i›‹t_m≠
);

630 
EXPORT_SYMBOL
(
i›‹t_unm≠
);

	@arch/alpha/kernel/irq.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/î∫o.h
>

16 
	~<löux/kî√l_°©.h
>

17 
	~<löux/sig«l.h
>

18 
	~<löux/sched.h
>

19 
	~<löux/±ø˚.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/úq.h
>

25 
	~<löux/¥oc_fs.h
>

26 
	~<löux/£q_fûe.h
>

27 
	~<löux/¥ofûe.h
>

28 
	~<löux/bô›s.h
>

30 
	~<asm/sy°em.h
>

31 
	~<asm/io.h
>

32 
	~<asm/uac˚ss.h
>

34 vﬁ©ûê
	gúq_îr_cou¡
;

36 
	$ack_bad_úq
(
úq
)

38 
úq_îr_cou¡
++;

39 
	`¥ötk
(
KERN_CRIT
 "U√x≥˘ed IRQÅø∞© ve˘‹ %u\n", 
úq
);

40 
	}
}

42 #ifde‡
CONFIG_SMP


43 
	gúq_u£r_afföôy
[
NR_IRQS
];

46 
	$£À˘_smp_afföôy
(
úq
)

48 
œ°_˝u
;

49 
˝u
 = 
œ°_˝u
 + 1;

51 i‡(!
úq_desc
[
úq
].
chù
->
£t_afföôy
 || 
úq_u£r_afföôy
[irq])

54 !
	`˝u_possibÀ
(
˝u
))

55 
˝u
 = (˝u < (
NR_CPUS
-1) ? cpu + 1 : 0);

56 
œ°_˝u
 = 
˝u
;

58 
úq_desc
[
úq
].
afföôy
 = 
	`˝umask_of_˝u
(
˝u
);

59 
úq_desc
[
úq
].
chù
->
	`£t_afföôy
(úq, 
	`˝umask_of_˝u
(
˝u
));

61 
	}
}

65 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

67 #ifde‡
CONFIG_SMP


68 
j
;

70 
úq
 = *(
loff_t
 *Ë
v
;

71 
úqa˘i⁄
 * 
a˘i⁄
;

72 
Êags
;

74 #ifde‡
CONFIG_SMP


75 i‡(
úq
 == 0) {

76 
	`£q_puts
(
p
, " ");

77 
	`f‹_óch_⁄löe_˝u
(
j
)

78 
	`£q_¥ötf
(
p
, "CPU%d ", 
j
);

79 
	`£q_putc
(
p
, '\n');

83 i‡(
úq
 < 
ACTUAL_NR_IRQS
) {

84 
	`•ö_lock_úqßve
(&
úq_desc
[
úq
].
lock
, 
Êags
);

85 
a˘i⁄
 = 
úq_desc
[
úq
].action;

86 i‡(!
a˘i⁄
)

87 
u∆ock
;

88 
	`£q_¥ötf
(
p
, "%3d: ", 
úq
);

89 #i‚de‡
CONFIG_SMP


90 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_úqs
(
úq
));

92 
	`f‹_óch_⁄löe_˝u
(
j
)

93 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_˝u
(
j
).
úqs
[
úq
]);

95 
	`£q_¥ötf
(
p
, " %14s", 
úq_desc
[
úq
].
chù
->
ty≥«me
);

96 
	`£q_¥ötf
(
p
, " %c%s",

97 (
a˘i⁄
->
Êags
 & 
IRQF_DISABLED
)?'+':' ',

98 
a˘i⁄
->
«me
);

100 
a˘i⁄
˜˘i⁄->
√xt
;áction;áction =áction->next) {

101 
	`£q_¥ötf
(
p
, ", %c%s",

102 (
a˘i⁄
->
Êags
 & 
IRQF_DISABLED
)?'+':' ',

103 
a˘i⁄
->
«me
);

106 
	`£q_putc
(
p
, '\n');

107 
u∆ock
:

108 
	`•ö_u∆ock_úqª°‹e
(&
úq_desc
[
úq
].
lock
, 
Êags
);

109 } i‡(
úq
 =
ACTUAL_NR_IRQS
) {

110 #ifde‡
CONFIG_SMP


111 
	`£q_puts
(
p
, "IPI: ");

112 
	`f‹_óch_⁄löe_˝u
(
j
)

113 
	`£q_¥ötf
(
p
, "%10lu ", 
˝u_d©a
[
j
].
ùi_cou¡
);

114 
	`£q_putc
(
p
, '\n');

116 
	`£q_¥ötf
(
p
, "ERR: %10lu\n", 
úq_îr_cou¡
);

119 
	}
}

127 
	#MAX_ILLEGAL_IRQS
 16

	)

130 
	$h™dÀ_úq
(
úq
)

142 
ûÀgÆ_cou¡
=0;

144 i‡((Ë
úq
 > 
ACTUAL_NR_IRQS
 && 
ûÀgÆ_cou¡
 < 
MAX_ILLEGAL_IRQS
 ) {

145 
úq_îr_cou¡
++;

146 
ûÀgÆ_cou¡
++;

147 
	`¥ötk
(
KERN_CRIT
 "device_interrupt: invalid interrupt %d\n",

148 
úq
);

152 
	`úq_íãr
();

159 
	`loˇl_úq_dißbÀ
();

160 
	`__do_IRQ
(
úq
);

161 
	`úq_exô
();

162 
	}
}

	@arch/alpha/kernel/irq_alpha.c

5 
	~<löux/öô.h
>

6 
	~<löux/sched.h
>

7 
	~<löux/úq.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/moduÀ.h
>

11 
	~<asm/machvec.h
>

12 
	~<asm/dma.h
>

14 
	~"¥Ÿo.h
"

15 
	~"úq_im∂.h
"

18 #ifde‡
CONFIG_ALPHA_BROKEN_IRQ_MASK


19 
	g__mö_ùl
;

20 
EXPORT_SYMBOL
(
__mö_ùl
);

28 
	$dummy_≥rf
(
ve˘‹
, 
±_ªgs
 *
ªgs
)

30 
úq_îr_cou¡
++;

31 
	`¥ötk
(
KERN_CRIT
 "Performance counter interrupt!\n");

32 
	}
}

34 (*
≥rf_úq
)(, 
±_ªgs
 *Ë
dummy_≥rf
;

35 
	`EXPORT_SYMBOL
(
≥rf_úq
);

41 
asmlökage
 

42 
	$do_ítI¡
(
ty≥
, 
ve˘‹
,

43 
œ_±r
, 
±_ªgs
 *
ªgs
)

45 
±_ªgs
 *
ﬁd_ªgs
;

46 
ty≥
) {

48 #ifde‡
CONFIG_SMP


49 
	`h™dÀ_ùi
(
ªgs
);

52 
úq_îr_cou¡
++;

53 
	`¥ötk
(
KERN_CRIT
 "Interprocessor interrupt? "

58 
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

59 #ifde‡
CONFIG_SMP


61 
˝u
;

63 
	`loˇl_úq_dißbÀ
();

64 
	`smp_≥r˝u_timî_öãºu±
(
ªgs
);

65 
˝u
 = 
	`smp_¥o˚ss‹_id
();

66 i‡(
˝u
 !
boŸ_˝uid
) {

67 
	`k°©_˝u
(
˝u
).
úqs
[
RTC_IRQ
]++;

69 
	`h™dÀ_úq
(
RTC_IRQ
);

73 
	`h™dÀ_úq
(
RTC_IRQ
);

75 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

78 
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

79 
Æpha_mv
.
	`machöe_check
(
ve˘‹
, 
œ_±r
);

80 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

83 
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

84 
Æpha_mv
.
	`devi˚_öãºu±
(
ve˘‹
);

85 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

88 
	`≥rf_úq
(
œ_±r
, 
ªgs
);

91 
	`¥ötk
(
KERN_CRIT
 "Hardware intr %ld %lx? Huh?\n",

92 
ty≥
, 
ve˘‹
);

94 
	`¥ötk
(
KERN_CRIT
 "PC = %016lx PS=%04lx\n", 
ªgs
->
pc
,Ñegs->
ps
);

95 
	}
}

97 
__öô


98 
	$comm⁄_öô_iß_dma
()

100 
	`outb
(0, 
DMA1_RESET_REG
);

101 
	`outb
(0, 
DMA2_RESET_REG
);

102 
	`outb
(0, 
DMA1_CLR_MASK_REG
);

103 
	`outb
(0, 
DMA2_CLR_MASK_REG
);

104 
	}
}

106 
__öô


107 
	$öô_IRQ
()

111 
	`wª¡
(
ítI¡
, 0);

113 
Æpha_mv
.
	`öô_úq
();

114 
	}
}

119 
	#MCHK_K_TPERR
 0x0080

	)

120 
	#MCHK_K_TCPERR
 0x0082

	)

121 
	#MCHK_K_HERR
 0x0084

	)

122 
	#MCHK_K_ECC_C
 0x0086

	)

123 
	#MCHK_K_ECC_NC
 0x0088

	)

124 
	#MCHK_K_OS_BUGCHECK
 0x008A

	)

125 
	#MCHK_K_PAL_BUGCHECK
 0x0090

	)

127 #i‚de‡
CONFIG_SMP


128 
mcheck_öfo
 
	g__mcheck_öfo
;

132 
	$¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
,

133 c⁄° *
machöe
, 
ex≥˘ed
)

135 
ñ_comm⁄
 *
mchk_hódî
;

136 c⁄° *
ªas⁄
;

143 #ifde‡
CONFIG_VERBOSE_MCHECK


144 i‡(
Æpha_vîbo£_mcheck
 > 1) {

145 
	`¥ötk
(
KERN_CRIT
 "%†machöêcheck %s\n", 
machöe
,

146 
ex≥˘ed
 ? "expected." : "NOTÉxpected!!!");

150 i‡(
ex≥˘ed
) {

151 
˝u
 = 
	`smp_¥o˚ss‹_id
();

152 
	`mcheck_ex≥˘ed
(
˝u
) = 0;

153 
	`mcheck_èkí
(
˝u
) = 1;

157 
mchk_hódî
 = (
ñ_comm⁄
 *)
œ_±r
;

159 
	`¥ötk
(
KERN_CRIT
 "%s machine check: vector=0x%lxÖc=0x%lx code=0x%x\n",

160 
machöe
, 
ve˘‹
, 
	`gë_úq_ªgs
()->
pc
, 
mchk_hódî
->
code
);

162 
mchk_hódî
->
code
) {

164 0x80: 
ªas⁄
 = "tagÖarityÉrror"; ;

165 0x82: 
ªas⁄
 = "tag controlÖarityÉrror"; ;

166 0x84: 
ªas⁄
 = "generic hardÉrror"; ;

167 0x86: 
ªas⁄
 = "correctable ECCÉrror"; ;

168 0x88: 
ªas⁄
 = "uncorrectable ECCÉrror"; ;

169 0x8A: 
ªas⁄
 = "OS-specific PAL bugcheck"; ;

170 0x90: 
ªas⁄
 = "callsys in kernel mode"; ;

171 0x96: 
ªas⁄
 = "i-cacheÑeadÑetryableÉrror"; ;

172 0x98: 
ªas⁄
 = "processor detected hardÉrror"; ;

175 0x202: 
ªas⁄
 = "system detected hardÉrror"; ;

176 0x203: 
ªas⁄
 = "system detected uncorrectable ECCÉrror"; ;

177 0x204: 
ªas⁄
 = "SIO SERR occurred on PCI bus"; ;

178 0x205: 
ªas⁄
 = "parityÉrror detected by coreÜogic"; ;

179 0x206: 
ªas⁄
 = "SIO IOCHK occurred on ISA bus"; ;

180 0x207: 
ªas⁄
 = "non-existent memoryÉrror"; ;

181 0x208: 
ªas⁄
 = "MCHK_K_DCSR"; ;

182 0x209: 
ªas⁄
 = "PCI SERR detected"; ;

183 0x20b: 
ªas⁄
 = "PCI dataÖarityÉrror detected"; ;

184 0x20d: 
ªas⁄
 = "PCIáddressÖarityÉrror detected"; ;

185 0x20f: 
ªas⁄
 = "PCI masterábortÉrror"; ;

186 0x211: 
ªas⁄
 = "PCIÅargetábortÉrror"; ;

187 0x213: 
ªas⁄
 = "scatter/gather PTE invalidÉrror"; ;

188 0x215: 
ªas⁄
 = "flash ROM writeÉrror"; ;

189 0x217: 
ªas⁄
 = "IOAÅimeout detected"; ;

190 0x219: 
ªas⁄
 = "IOCHK#, EISAádd-in boardÖarity or other catastrophicÉrror"; ;

191 0x21b: 
ªas⁄
 = "EISA fail-safeÅimerÅimeout"; ;

192 0x21d: 
ªas⁄
 = "EISA busÅime-out"; ;

193 0x21f: 
ªas⁄
 = "EISA software generated NMI"; ;

194 0x221: 
ªas⁄
 = "unexpectedÉv5 IRQ[3] interrupt"; ;

195 : 
ªas⁄
 = "unknown"; ;

198 
	`¥ötk
(
KERN_CRIT
 "machine checkÅype: %s%s\n",

199 
ªas⁄
, 
mchk_hódî
->
ªåy
 ? " (retryable)" : "");

201 
	`dik_show_ªgs
(
	`gë_úq_ªgs
(), 
NULL
);

203 #ifde‡
CONFIG_VERBOSE_MCHECK


204 i‡(
Æpha_vîbo£_mcheck
 > 1) {

206 *
±r
 = (*)
œ_±r
;

207 
i
;

208 
i
 = 0; i < 
mchk_hódî
->
size
 / (); i += 2) {

209 
	`¥ötk
(
KERN_CRIT
 " +%8lx %016lx %016lx\n",

210 
i
*(), 
±r
[i],Ötr[i+1]);

214 
	}
}

221 
	$πc_íabÀ_dißbÀ
(
úq
Ë{ 
	}
}

222 
	$πc_°¨tup
(
úq
Ë{  0; 
	}
}

224 
úqa˘i⁄
 
	gtimî_úqa˘i⁄
 = {

225 .
h™dÀr
 = 
timî_öãºu±
,

226 .
	gÊags
 = 
IRQF_DISABLED
,

227 .
	g«me
 = "timer",

230 
hw_öãºu±_ty≥
 
	gπc_úq_ty≥
 = {

231 .
ty≥«me
 = "RTC",

232 .
	g°¨tup
 = 
πc_°¨tup
,

233 .
	gshutdown
 = 
πc_íabÀ_dißbÀ
,

234 .
	gíabÀ
 = 
πc_íabÀ_dißbÀ
,

235 .
	gdißbÀ
 = 
πc_íabÀ_dißbÀ
,

236 .
	gack
 = 
πc_íabÀ_dißbÀ
,

237 .
	gíd
 = 
πc_íabÀ_dißbÀ
,

240 
__öô


241 
	$öô_πc_úq
()

243 
úq_desc
[
RTC_IRQ
].
°©us
 = 
IRQ_DISABLED
;

244 
úq_desc
[
RTC_IRQ
].
chù
 = &
πc_úq_ty≥
;

245 
	`£tup_úq
(
RTC_IRQ
, &
timî_úqa˘i⁄
);

246 
	}
}

249 
úqa˘i⁄
 
	giß_ˇsˇde_úqa˘i⁄
 = {

250 .
h™dÀr
 = 
no_a˘i⁄
,

251 .
	g«me
 = "isa-cascade"

254 
úqa˘i⁄
 
	gtimî_ˇsˇde_úqa˘i⁄
 = {

255 .
h™dÀr
 = 
no_a˘i⁄
,

256 .
	g«me
 = "timer-cascade"

259 
úqa˘i⁄
 
	ghÆt_swôch_úqa˘i⁄
 = {

260 .
h™dÀr
 = 
no_a˘i⁄
,

261 .
	g«me
 = "halt-switch"

	@arch/alpha/kernel/irq_i8259.c

10 
	~<löux/öô.h
>

11 
	~<löux/ˇche.h
>

12 
	~<löux/sched.h
>

13 
	~<löux/úq.h
>

14 
	~<löux/öãºu±.h
>

16 
	~<asm/io.h
>

18 
	~"¥Ÿo.h
"

19 
	~"úq_im∂.h
"

23 
	gˇched_úq_mask
 = 0xffff;

24 
DEFINE_SPINLOCK
(
i8259_úq_lock
);

26 
ölöe
 

27 
	$i8259_upd©e_úq_hw
(
úq
, 
mask
)

29 
p‹t
 = 0x21;

30 i‡(
úq
 & 8Ë
mask
 >>= 8;

31 i‡(
úq
 & 8Ë
p‹t
 = 0xA1;

32 
	`outb
(
mask
, 
p‹t
);

33 
	}
}

35 
ölöe
 

36 
	$i8259a_íabÀ_úq
(
úq
)

38 
	`•ö_lock
(&
i8259_úq_lock
);

39 
	`i8259_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 &= ~(1 << irq));

40 
	`•ö_u∆ock
(&
i8259_úq_lock
);

41 
	}
}

43 
ölöe
 

44 
	$__i8259a_dißbÀ_úq
(
úq
)

46 
	`i8259_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 |= 1 << irq);

47 
	}
}

50 
	$i8259a_dißbÀ_úq
(
úq
)

52 
	`•ö_lock
(&
i8259_úq_lock
);

53 
	`__i8259a_dißbÀ_úq
(
úq
);

54 
	`•ö_u∆ock
(&
i8259_úq_lock
);

55 
	}
}

58 
	$i8259a_mask_™d_ack_úq
(
úq
)

60 
	`•ö_lock
(&
i8259_úq_lock
);

61 
	`__i8259a_dißbÀ_úq
(
úq
);

64 i‡(
úq
 >= 8) {

65 
	`outb
(0xE0 | (
úq
 - 8), 0xa0);

66 
úq
 = 2;

68 
	`outb
(0xE0 | 
úq
, 0x20);

69 
	`•ö_u∆ock
(&
i8259_úq_lock
);

70 
	}
}

73 
	$i8259a_°¨tup_úq
(
úq
)

75 
	`i8259a_íabÀ_úq
(
úq
);

77 
	}
}

80 
	$i8259a_íd_úq
(
úq
)

82 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

83 
	`i8259a_íabÀ_úq
(
úq
);

84 
	}
}

86 
hw_öãºu±_ty≥
 
	gi8259a_úq_ty≥
 = {

87 .
ty≥«me
 = "XT-PIC",

88 .
	g°¨tup
 = 
i8259a_°¨tup_úq
,

89 .
	gshutdown
 = 
i8259a_dißbÀ_úq
,

90 .
	gíabÀ
 = 
i8259a_íabÀ_úq
,

91 .
	gdißbÀ
 = 
i8259a_dißbÀ_úq
,

92 .
	gack
 = 
i8259a_mask_™d_ack_úq
,

93 .
	gíd
 = 
i8259a_íd_úq
,

96 
__öô


97 
	$öô_i8259a_úqs
()

99 
úqa˘i⁄
 
ˇsˇde
 = {

100 .
h™dÀr
 = 
no_a˘i⁄
,

101 .
«me
 = "cascade",

104 
i
;

106 
	`outb
(0xff, 0x21);

107 
	`outb
(0xff, 0xA1);

109 
i
 = 0; i < 16; i++) {

110 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
;

111 
úq_desc
[
i
].
chù
 = &
i8259a_úq_ty≥
;

114 
	`£tup_úq
(2, &
ˇsˇde
);

115 
	}
}

118 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
)

119 
	#IACK_SC
 
Æpha_mv
.
ück_sc


	)

120 #ñi‡
deföed
(
CONFIG_ALPHA_APECS
)

121 
	#IACK_SC
 
APECS_IACK_SC


	)

122 #ñi‡
deföed
(
CONFIG_ALPHA_LCA
)

123 
	#IACK_SC
 
LCA_IACK_SC


	)

124 #ñi‡
deföed
(
CONFIG_ALPHA_CIA
)

125 
	#IACK_SC
 
CIA_IACK_SC


	)

126 #ñi‡
deföed
(
CONFIG_ALPHA_PYXIS
)

127 
	#IACK_SC
 
PYXIS_IACK_SC


	)

128 #ñi‡
deföed
(
CONFIG_ALPHA_TITAN
)

129 
	#IACK_SC
 
TITAN_IACK_SC


	)

130 #ñi‡
deföed
(
CONFIG_ALPHA_TSUNAMI
)

131 
	#IACK_SC
 
TSUNAMI_IACK_SC


	)

132 #ñi‡
deföed
(
CONFIG_ALPHA_IRONGATE
)

133 
	#IACK_SC
 
IRONGATE_IACK_SC


	)

138 #i‡
deföed
(
IACK_SC
)

140 
	$iß_devi˚_öãºu±
(
ve˘‹
)

148 
j
 = *(
vuù
Ë
IACK_SC
;

149 
j
 &= 0xff;

150 
	`h™dÀ_úq
(
j
);

151 
	}
}

154 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| !deföed(
IACK_SC
)

156 
	$iß_no_ück_sc_devi˚_öãºu±
(
ve˘‹
)

158 
pic
;

173 
pic
 = 
	`öb
(0x20) | (inb(0xA0) << 8);

174 
pic
 &= 0xFFFB;

176 
pic
) {

177 
j
 = 
	`ffz
(~
pic
);

178 
pic
 &=Öic - 1;

179 
	`h™dÀ_úq
(
j
);

181 
	}
}

	@arch/alpha/kernel/irq_impl.h

11 
	~<löux/öãºu±.h
>

12 
	~<löux/úq.h
>

13 
	~<löux/¥ofûe.h
>

16 
	#RTC_IRQ
 8

	)

18 
iß_devi˚_öãºu±
();

19 
iß_no_ück_sc_devi˚_öãºu±
();

20 
§m_devi˚_öãºu±
();

21 
pyxis_devi˚_öãºu±
();

23 
úqa˘i⁄
 
timî_úqa˘i⁄
;

24 
úqa˘i⁄
 
iß_ˇsˇde_úqa˘i⁄
;

25 
úqa˘i⁄
 
timî_ˇsˇde_úqa˘i⁄
;

26 
úqa˘i⁄
 
hÆt_swôch_úqa˘i⁄
;

28 
öô_§m_úqs
(, );

29 
öô_pyxis_úqs
();

30 
öô_πc_úq
();

32 
comm⁄_öô_iß_dma
();

34 
i8259a_íabÀ_úq
();

35 
i8259a_dißbÀ_úq
();

36 
i8259a_mask_™d_ack_úq
();

37 
i8259a_°¨tup_úq
();

38 
i8259a_íd_úq
();

39 
hw_öãºu±_ty≥
 
i8259a_úq_ty≥
;

40 
öô_i8259a_úqs
();

42 
h™dÀ_úq
(
úq
);

	@arch/alpha/kernel/irq_pyxis.c

9 
	~<löux/öô.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/úq.h
>

13 
	~<asm/io.h
>

14 
	~<asm/c‹e_cü.h
>

16 
	~"¥Ÿo.h
"

17 
	~"úq_im∂.h
"

21 
	gˇched_úq_mask
;

23 
ölöe
 

24 
	$pyxis_upd©e_úq_hw
(
mask
)

26 *(
vuÕ
)
PYXIS_INT_MASK
 = 
mask
;

27 
	`mb
();

28 *(
vuÕ
)
PYXIS_INT_MASK
;

29 
	}
}

31 
ölöe
 

32 
	$pyxis_íabÀ_úq
(
úq
)

34 
	`pyxis_upd©e_úq_hw
(
ˇched_úq_mask
 |1UL << (
úq
 - 16));

35 
	}
}

38 
	$pyxis_dißbÀ_úq
(
úq
)

40 
	`pyxis_upd©e_úq_hw
(
ˇched_úq_mask
 &~(1UL << (
úq
 - 16)));

41 
	}
}

44 
	$pyxis_°¨tup_úq
(
úq
)

46 
	`pyxis_íabÀ_úq
(
úq
);

48 
	}
}

51 
	$pyxis_íd_úq
(
úq
)

53 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

54 
	`pyxis_íabÀ_úq
(
úq
);

55 
	}
}

58 
	$pyxis_mask_™d_ack_úq
(
úq
)

60 
bô
 = 1UL << (
úq
 - 16);

61 
mask
 = 
ˇched_úq_mask
 &~
bô
;

64 *(
vuÕ
)
PYXIS_INT_MASK
 = 
mask
;

65 
	`wmb
();

67 *(
vuÕ
)
PYXIS_INT_REQ
 = 
bô
;

68 
	`mb
();

70 *(
vuÕ
)
PYXIS_INT_MASK
;

71 
	}
}

73 
hw_öãºu±_ty≥
 
	gpyxis_úq_ty≥
 = {

74 .
ty≥«me
 = "PYXIS",

75 .
	g°¨tup
 = 
pyxis_°¨tup_úq
,

76 .
	gshutdown
 = 
pyxis_dißbÀ_úq
,

77 .
	gíabÀ
 = 
pyxis_íabÀ_úq
,

78 .
	gdißbÀ
 = 
pyxis_dißbÀ_úq
,

79 .
	gack
 = 
pyxis_mask_™d_ack_úq
,

80 .
	gíd
 = 
pyxis_íd_úq
,

84 
	$pyxis_devi˚_öãºu±
(
ve˘‹
)

86 
∂d
;

87 
i
;

90 
∂d
 = *(
vuÕ
)
PYXIS_INT_REQ
;

91 
∂d
 &
ˇched_úq_mask
;

97 
∂d
) {

98 
i
 = 
	`ffz
(~
∂d
);

99 
∂d
 &=Öld - 1;

100 i‡(
i
 == 7)

101 
	`iß_devi˚_öãºu±
(
ve˘‹
);

103 
	`h™dÀ_úq
(16+
i
);

105 
	}
}

107 
__öô


108 
	$öô_pyxis_úqs
(
ign‹e_mask
)

110 
i
;

112 *(
vuÕ
)
PYXIS_INT_MASK
 = 0;

113 *(
vuÕ
)
PYXIS_INT_REQ
 = -1;

114 
	`mb
();

117 *(
vuù
Ë
CIA_IACK_SC
;

119 
i
 = 16; i < 48; ++i) {

120 i‡((
ign‹e_mask
 >> 
i
) & 1)

122 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

123 
úq_desc
[
i
].
chù
 = &
pyxis_úq_ty≥
;

126 
	`£tup_úq
(16+7, &
iß_ˇsˇde_úqa˘i⁄
);

127 
	}
}

	@arch/alpha/kernel/irq_srm.c

5 
	~<löux/öô.h
>

6 
	~<löux/sched.h
>

7 
	~<löux/úq.h
>

9 
	~"¥Ÿo.h
"

10 
	~"úq_im∂.h
"

18 
DEFINE_SPINLOCK
(
§m_úq_lock
);

20 
ölöe
 

21 
	$§m_íabÀ_úq
(
úq
)

23 
	`•ö_lock
(&
§m_úq_lock
);

24 
	`c£rve_ía
(
úq
 - 16);

25 
	`•ö_u∆ock
(&
§m_úq_lock
);

26 
	}
}

29 
	$§m_dißbÀ_úq
(
úq
)

31 
	`•ö_lock
(&
§m_úq_lock
);

32 
	`c£rve_dis
(
úq
 - 16);

33 
	`•ö_u∆ock
(&
§m_úq_lock
);

34 
	}
}

37 
	$§m_°¨tup_úq
(
úq
)

39 
	`§m_íabÀ_úq
(
úq
);

41 
	}
}

44 
	$§m_íd_úq
(
úq
)

46 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

47 
	`§m_íabÀ_úq
(
úq
);

48 
	}
}

51 
hw_öãºu±_ty≥
 
	g§m_úq_ty≥
 = {

52 .
ty≥«me
 = "SRM",

53 .
	g°¨tup
 = 
§m_°¨tup_úq
,

54 .
	gshutdown
 = 
§m_dißbÀ_úq
,

55 .
	gíabÀ
 = 
§m_íabÀ_úq
,

56 .
	gdißbÀ
 = 
§m_dißbÀ_úq
,

57 .
	gack
 = 
§m_dißbÀ_úq
,

58 .
	gíd
 = 
§m_íd_úq
,

61 
__öô


62 
	$öô_§m_úqs
(
max
, 
ign‹e_mask
)

64 
i
;

66 
i
 = 16; i < 
max
; ++i) {

67 i‡(
i
 < 64 && ((
ign‹e_mask
 >> i) & 1))

69 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

70 
úq_desc
[
i
].
chù
 = &
§m_úq_ty≥
;

72 
	}
}

75 
	$§m_devi˚_öãºu±
(
ve˘‹
)

77 
úq
 = (
ve˘‹
 - 0x800) >> 4;

78 
	`h™dÀ_úq
(
úq
);

79 
	}
}

	@arch/alpha/kernel/machvec_impl.h

9 
	~<asm/pgÆloc.h
>

15 
	#IRONGATE_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

16 
	#MARVEL_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

17 
	#POLARIS_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

18 
	#TSUNAMI_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

19 
	#TITAN_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

20 
	#WILDFIRE_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

22 #ifde‡
CIA_ONE_HAE_WINDOW


23 
	#CIA_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

25 #ifde‡
MCPCIA_ONE_HAE_WINDOW


26 
	#MCPCIA_HAE_ADDRESS
 (&
Æpha_mv
.
h´_ˇche
)

	)

32 
	#JENSEN_IACK_SC
 1

	)

33 
	#T2_IACK_SC
 1

	)

34 
	#WILDFIRE_IACK_SC
 1

	)

40 
	#CAT1
(
x
,
y
Ëx##
	)
y

41 
	#CAT
(
x
,
y
Ë
	`CAT1
(x,y)

	)

43 
	#DO_DEFAULT_RTC
 .
πc_p‹t
 = 0x70

	)

45 
	#DO_EV4_MMU
 \

46 .
max_a¢
 = 
EV4_MAX_ASN
, \

47 .
mv_swôch_mm
 = 
ev4_swôch_mm
, \

48 .
mv_a˘iv©e_mm
 = 
ev4_a˘iv©e_mm
, \

49 .
mv_Êush_éb_cuºít
 = 
ev4_Êush_éb_cuºít
, \

50 .
mv_Êush_éb_cuºít_∑ge
 = 
ev4_Êush_éb_cuºít_∑ge


	)

52 
	#DO_EV5_MMU
 \

53 .
max_a¢
 = 
EV5_MAX_ASN
, \

54 .
mv_swôch_mm
 = 
ev5_swôch_mm
, \

55 .
mv_a˘iv©e_mm
 = 
ev5_a˘iv©e_mm
, \

56 .
mv_Êush_éb_cuºít
 = 
ev5_Êush_éb_cuºít
, \

57 .
mv_Êush_éb_cuºít_∑ge
 = 
ev5_Êush_éb_cuºít_∑ge


	)

59 
	#DO_EV6_MMU
 \

60 .
max_a¢
 = 
EV6_MAX_ASN
, \

61 .
mv_swôch_mm
 = 
ev5_swôch_mm
, \

62 .
mv_a˘iv©e_mm
 = 
ev5_a˘iv©e_mm
, \

63 .
mv_Êush_éb_cuºít
 = 
ev5_Êush_éb_cuºít
, \

64 .
mv_Êush_éb_cuºít_∑ge
 = 
ev5_Êush_éb_cuºít_∑ge


	)

66 
	#DO_EV7_MMU
 \

67 .
max_a¢
 = 
EV6_MAX_ASN
, \

68 .
mv_swôch_mm
 = 
ev5_swôch_mm
, \

69 .
mv_a˘iv©e_mm
 = 
ev5_a˘iv©e_mm
, \

70 .
mv_Êush_éb_cuºít
 = 
ev5_Êush_éb_cuºít
, \

71 .
mv_Êush_éb_cuºít_∑ge
 = 
ev5_Êush_éb_cuºít_∑ge


	)

73 
	#IO_LITE
(
UP
,
low
) \

74 .
h´_ªgi°î
 = (*Ë
	`CAT
(
UP
,
_HAE_ADDRESS
), \

75 .
ück_sc
 = 
	`CAT
(
UP
,
_IACK_SC
), \

76 .
mv_i‹ód8
 = 
	`CAT
(
low
,
_i‹ód8
), \

77 .
mv_i‹ód16
 = 
	`CAT
(
low
,
_i‹ód16
), \

78 .
mv_i‹ód32
 = 
	`CAT
(
low
,
_i‹ód32
), \

79 .
mv_iowrôe8
 = 
	`CAT
(
low
,
_iowrôe8
), \

80 .
mv_iowrôe16
 = 
	`CAT
(
low
,
_iowrôe16
), \

81 .
mv_iowrôe32
 = 
	`CAT
(
low
,
_iowrôe32
), \

82 .
mv_ªadb
 = 
	`CAT
(
low
,
_ªadb
), \

83 .
mv_ªadw
 = 
	`CAT
(
low
,
_ªadw
), \

84 .
mv_ªadl
 = 
	`CAT
(
low
,
_ªadl
), \

85 .
mv_ªadq
 = 
	`CAT
(
low
,
_ªadq
), \

86 .
mv_wrôeb
 = 
	`CAT
(
low
,
_wrôeb
), \

87 .
mv_wrôew
 = 
	`CAT
(
low
,
_wrôew
), \

88 .
mv_wrôñ
 = 
	`CAT
(
low
,
_wrôñ
), \

89 .
mv_wrôeq
 = 
	`CAT
(
low
,
_wrôeq
), \

90 .
mv_i›‹tm≠
 = 
	`CAT
(
low
,
_i›‹tm≠
), \

91 .
mv_i‹em≠
 = 
	`CAT
(
low
,
_i‹em≠
), \

92 .
mv_iounm≠
 = 
	`CAT
(
low
,
_iounm≠
), \

93 .
mv_is_iﬂddr
 = 
	`CAT
(
low
,
_is_iﬂddr
), \

94 .
mv_is_mmio
 = 
	`CAT
(
low
,
_is_mmio
) \

95 

	)

96 
	#IO
(
UP
,
low
) \

97 
	`IO_LITE
(
UP
,
low
), \

98 .
pci_›s
 = &
	`CAT
(
low
,
_pci_›s
), \

99 .
mv_pci_tbi
 = 
	`CAT
(
low
,
_pci_tbi
)

	)

101 
	#DO_APECS_IO
 
	`IO
(
APECS
,
≠ecs
)

	)

102 
	#DO_CIA_IO
 
	`IO
(
CIA
,
cü
)

	)

103 
	#DO_IRONGATE_IO
 
	`IO
(
IRONGATE
,
ú⁄g©e
)

	)

104 
	#DO_LCA_IO
 
	`IO
(
LCA
,
lˇ
)

	)

105 
	#DO_MARVEL_IO
 
	`IO
(
MARVEL
,
m¨vñ
)

	)

106 
	#DO_MCPCIA_IO
 
	`IO
(
MCPCIA
,
m˝cü
)

	)

107 
	#DO_POLARIS_IO
 
	`IO
(
POLARIS
,
pﬁ¨is
)

	)

108 
	#DO_T2_IO
 
	`IO
(
T2
,
t2
)

	)

109 
	#DO_TSUNAMI_IO
 
	`IO
(
TSUNAMI
,
tsu«mi
)

	)

110 
	#DO_TITAN_IO
 
	`IO
(
TITAN
,
tô™
)

	)

111 
	#DO_WILDFIRE_IO
 
	`IO
(
WILDFIRE
,
wûdfúe
)

	)

113 
	#DO_PYXIS_IO
 
	`IO_LITE
(
CIA
,
cü_bwx
), \

114 .
pci_›s
 = &
cü_pci_›s
, \

115 .
mv_pci_tbi
 = 
cü_pci_tbi


	)

133 #ifde‡
CONFIG_ALPHA_GENERIC


134 
	#__öômv
 
__öôd©a


	)

135 
	#ALIAS_MV
(
x
)

	)

137 
	#__öômv


	)

143 
	#ALIAS_MV
(
sy°em
) \

144 
Æpha_machöe_ve˘‹
 
Æpha_mv
 
	`__©åibuã__
((
	`Æüs
(#sy°em "_mv")));

	)

146 
	#ALIAS_MV
(
sy°em
) \

147 
	`asm
(".globÆáÕha_mv\«Õha_mv = " #sy°em "_mv");

	)

	@arch/alpha/kernel/module.c

18 
	~<löux/moduÀlﬂdî.h
>

19 
	~<löux/ñf.h
>

20 
	~<löux/vmÆloc.h
>

21 
	~<löux/fs.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/¶ab.h
>

27 
	#DEBUGP
 
¥ötk


	)

29 
	#DEBUGP
(
fmt
...)

	)

33 
	$moduÀ_Æloc
(
size
)

35 i‡(
size
 == 0)

36  
NULL
;

37  
	`vmÆloc
(
size
);

38 
	}
}

41 
	$moduÀ_‰ì
(
moduÀ
 *
mod
, *
moduÀ_ªgi⁄
)

43 
	`v‰ì
(
moduÀ_ªgi⁄
);

44 
	}
}

48 
	sgŸ_íåy
 {

49 
gŸ_íåy
 *
	m√xt
;

50 
Elf64_Sxw‹d
 
	mr_addíd
;

51 
	mgŸ_off£t
;

54 
ölöe
 

55 
	$¥o˚ss_ªloc_f‹_gŸ
(
Elf64_Rña
 *
ªœ
,

56 
gŸ_íåy
 *
chaös
, 
Elf64_Xw‹d
 *
poff£t
)

58 
r_sym
 = 
	`ELF64_R_SYM
 (
ªœ
->
r_öfo
);

59 
r_ty≥
 = 
	`ELF64_R_TYPE
 (
ªœ
->
r_öfo
);

60 
Elf64_Sxw‹d
 
r_addíd
 = 
ªœ
->r_addend;

61 
gŸ_íåy
 *
g
;

63 i‡(
r_ty≥
 !
R_ALPHA_LITERAL
)

66 
g
 = 
chaös
 + 
r_sym
; g ; g = g->
√xt
)

67 i‡(
g
->
r_addíd
 ==Ñ_addend) {

68 i‡(
g
->
gŸ_off£t
 == 0) {

69 
g
->
gŸ_off£t
 = *
poff£t
;

70 *
poff£t
 += 8;

72 
found_íåy
;

75 
g
 = 
	`kmÆloc
 ( (*g), 
GFP_KERNEL
);

76 
g
->
√xt
 = 
chaös
[
r_sym
].next;

77 
g
->
r_addíd
 =Ñ_addend;

78 
g
->
gŸ_off£t
 = *
poff£t
;

79 *
poff£t
 += 8;

80 
chaös
[
r_sym
].
√xt
 = 
g
;

82 
found_íåy
:

86 
ªœ
->
r_öfo
 |
g
->
gŸ_off£t
 << 8;

87 
	}
}

90 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf64_Ehdr
 *
hdr
, 
Elf64_Shdr
 *
£chdrs
,

91 *
£c°rögs
, 
moduÀ
 *
me
)

93 
gŸ_íåy
 *
chaös
;

94 
Elf64_Rña
 *
ªœ
;

95 
Elf64_Shdr
 *
e£chdrs
, *
symèb
, *
s
, *
gŸ
;

96 
nsyms
, 
ƒña
, 
i
;

98 
e£chdrs
 = 
£chdrs
 + 
hdr
->
e_shnum
;

99 
symèb
 = 
gŸ
 = 
NULL
;

104 
s
 = 
£chdrs
; s < 
e£chdrs
; ++s)

105 i‡(
s
->
sh_ty≥
 =
SHT_SYMTAB
)

106 
symèb
 = 
s
;

107 i‡(!
	`°rcmp
(".gŸ", 
£c°rögs
 + 
s
->
sh_«me
)) {

108 
gŸ
 = 
s
;

109 
me
->
¨ch
.
gŸ£cödex
 = 
s
 - 
£chdrs
;

112 i‡(!
symèb
) {

113 
	`¥ötk
(
KERN_ERR
 "moduÀ %s:ÇÿsymbﬁÅabÀ\n", 
me
->
«me
);

114  -
ENOEXEC
;

116 i‡(!
gŸ
) {

117 
	`¥ötk
(
KERN_ERR
 "moduÀ %s:ÇÿgŸ se˘i⁄\n", 
me
->
«me
);

118  -
ENOEXEC
;

121 
nsyms
 = 
symèb
->
sh_size
 / (
Elf64_Sym
);

122 
chaös
 = 
	`kmÆloc
(
nsyms
 * (
gŸ_íåy
), 
GFP_KERNEL
);

123 
	`mem£t
(
chaös
, 0, 
nsyms
 * (
gŸ_íåy
));

125 
gŸ
->
sh_size
 = 0;

126 
gŸ
->
sh_addølign
 = 8;

127 
gŸ
->
sh_ty≥
 = 
SHT_NOBITS
;

131 
s
 = 
£chdrs
; s < 
e£chdrs
; ++s)

132 i‡(
s
->
sh_ty≥
 =
SHT_RELA
) {

133 
ƒña
 = 
s
->
sh_size
 / (
Elf64_Rña
);

134 
ªœ
 = (*)
hdr
 + 
s
->
sh_off£t
;

135 
i
 = 0; i < 
ƒña
; ++i)

136 
	`¥o˚ss_ªloc_f‹_gŸ
(
ªœ
+
i
, 
chaös
,

137 &
gŸ
->
sh_size
);

141 
i
 = 0; i < 
nsyms
; ++i) {

142 
gŸ_íåy
 *
g
, *
n
;

143 
g
 = 
chaös
[
i
].
√xt
; g ; g = 
n
) {

144 
n
 = 
g
->
√xt
;

145 
	`k‰ì
(
g
);

148 
	`k‰ì
(
chaös
);

151 
	}
}

154 
	$≠∂y_ªloˇã
(
Elf64_Shdr
 *
£chdrs
, c⁄° *
°πab
, 
symödex
,

155 
ªl£c
, 
moduÀ
 *
me
)

157 
	`¥ötk
(
KERN_ERR
 "moduÀ %s: RELÑñoˇti⁄ unsuµ‹ãd\n", 
me
->
«me
);

158  -
ENOEXEC
;

159 
	}
}

162 
	$≠∂y_ªloˇã_add
(
Elf64_Shdr
 *
£chdrs
, c⁄° *
°πab
,

163 
symödex
, 
ªl£c
,

164 
moduÀ
 *
me
)

166 
Elf64_Rña
 *
ªœ
 = (*)
£chdrs
[
ªl£c
].
sh_addr
;

167 
i
, 
n
 = 
£chdrs
[
ªl£c
].
sh_size
 / (*
ªœ
);

168 
Elf64_Sym
 *
symèb
, *
sym
;

169 *
ba£
, *
loˇti⁄
;

170 
gŸ
, 
gp
;

172 
	`DEBUGP
("AµlyögÑñoˇã se˘i⁄ %uÅÿ%u\n", 
ªl£c
,

173 
£chdrs
[
ªl£c
].
sh_öfo
);

175 
ba£
 = (*)
£chdrs
[£chdrs[
ªl£c
].
sh_öfo
].
sh_addr
;

176 
symèb
 = (
Elf64_Sym
 *)
£chdrs
[
symödex
].
sh_addr
;

180 
gp
 = (
u64
)
me
->
moduÀ_c‹e
 + me->
c‹e_size
 - 0x8000;

181 
gŸ
 = 
£chdrs
[
me
->
¨ch
.
gŸ£cödex
].
sh_addr
;

183 
i
 = 0; i < 
n
; i++) {

184 
r_sym
 = 
	`ELF64_R_SYM
 (
ªœ
[
i
].
r_öfo
);

185 
r_ty≥
 = 
	`ELF64_R_TYPE
 (
ªœ
[
i
].
r_öfo
);

186 
r_gŸ_off£t
 = 
r_ty≥
 >> 8;

187 
vÆue
, 
hi
, 
lo
;

188 
r_ty≥
 &= 0xff;

191 
loˇti⁄
 = 
ba£
 + 
ªœ
[
i
].
r_off£t
;

195 
sym
 = 
symèb
 + 
r_sym
;

196 
vÆue
 = 
sym
->
°_vÆue
 + 
ªœ
[
i
].
r_addíd
;

198 
r_ty≥
) {

199 
R_ALPHA_NONE
:

201 
R_ALPHA_REFQUAD
:

203 ((
u32
 *)
loˇti⁄
)[0] = 
vÆue
;

204 ((
u32
 *)
loˇti⁄
)[1] = 
vÆue
 >> 32;

206 
R_ALPHA_GPREL32
:

207 
vÆue
 -
gp
;

208 i‡(()
vÆue
 != value)

209 
ªloc_ovîÊow
;

210 *(
u32
 *)
loˇti⁄
 = 
vÆue
;

212 
R_ALPHA_LITERAL
:

213 
hi
 = 
gŸ
 + 
r_gŸ_off£t
;

214 
lo
 = 
hi
 - 
gp
;

215 i‡(()
lo
 !=Üo)

216 
ªloc_ovîÊow
;

217 *(
u16
 *)
loˇti⁄
 = 
lo
;

218 *(
u64
 *)
hi
 = 
vÆue
;

220 
R_ALPHA_LITUSE
:

222 
R_ALPHA_GPDISP
:

223 
vÆue
 = 
gp
 - (
u64
)
loˇti⁄
;

224 
lo
 = ()
vÆue
;

225 
hi
 = ()(
vÆue
 - 
lo
);

226 i‡(
hi
 + 
lo
 !
vÆue
)

227 
ªloc_ovîÊow
;

228 *(
u16
 *)
loˇti⁄
 = 
hi
 >> 16;

229 *(
u16
 *)(
loˇti⁄
 + 
ªœ
[
i
].
r_addíd
Ë
lo
;

231 
R_ALPHA_BRSGP
:

235 i‡(
sym
->
°_shndx
 =
SHN_UNDEF
)

236 
ªloc_ovîÊow
;

237 i‡((
sym
->
°_Ÿhî
 & 
STO_ALPHA_STD_GPLOAD
) ==

238 
STO_ALPHA_STD_GPLOAD
)

240 
vÆue
 += 8;

242 
R_ALPHA_BRADDR
:

243 
vÆue
 -(
u64
)
loˇti⁄
 + 4;

244 i‡(
vÆue
 & 3)

245 
ªloc_ovîÊow
;

246 
vÆue
 = ()value >> 2;

247 i‡(
vÆue
 + (1<<21) >= 1<<22)

248 
ªloc_ovîÊow
;

249 
vÆue
 &= 0x1fffff;

250 
vÆue
 |*(
u32
 *)
loˇti⁄
 & ~0x1fffff;

251 *(
u32
 *)
loˇti⁄
 = 
vÆue
;

253 
R_ALPHA_HINT
:

255 
R_ALPHA_SREL32
:

256 
vÆue
 -(
u64
)
loˇti⁄
;

257 i‡(()
vÆue
 != value)

258 
ªloc_ovîÊow
;

259 *(
u32
 *)
loˇti⁄
 = 
vÆue
;

261 
R_ALPHA_SREL64
:

262 
vÆue
 -(
u64
)
loˇti⁄
;

263 *(
u64
 *)
loˇti⁄
 = 
vÆue
;

265 
R_ALPHA_GPRELHIGH
:

266 
vÆue
 = ()(vÆuê- 
gp
 + 0x8000) >> 16;

267 i‡((Ë
vÆue
 != value)

268 
ªloc_ovîÊow
;

269 *(
u16
 *)
loˇti⁄
 = 
vÆue
;

271 
R_ALPHA_GPRELLOW
:

272 
vÆue
 -
gp
;

273 *(
u16
 *)
loˇti⁄
 = 
vÆue
;

275 
R_ALPHA_GPREL16
:

276 
vÆue
 -
gp
;

277 i‡((Ë
vÆue
 != value)

278 
ªloc_ovîÊow
;

279 *(
u16
 *)
loˇti⁄
 = 
vÆue
;

282 
	`¥ötk
(
KERN_ERR
 "module %s: UnknownÑelocation: %lu\n",

283 
me
->
«me
, 
r_ty≥
);

284  -
ENOEXEC
;

285 
ªloc_ovîÊow
:

286 i‡(
	`ELF64_ST_TYPE
 (
sym
->
°_öfo
Ë=
STT_SECTION
)

287 
	`¥ötk
(
KERN_ERR


289 
me
->
«me
, 
r_ty≥
, 
sym
->
°_shndx
);

291 
	`¥ötk
(
KERN_ERR


293 
me
->
«me
, 
r_ty≥
, 
°πab
 + 
sym
->
°_«me
);

294  -
ENOEXEC
;

299 
	}
}

302 
	$moduÀ_föÆize
(c⁄° 
Elf_Ehdr
 *
hdr
, c⁄° 
Elf_Shdr
 *
£chdrs
,

303 
moduÀ
 *
me
)

306 
	}
}

309 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

311 
	}
}

	@arch/alpha/kernel/ns87312.c

5 
	~<löux/öô.h
>

6 
	~<asm/io.h
>

7 
	~"¥Ÿo.h
"

25 
__öô


26 
	$ns87312_íabÀ_ide
(
ide_ba£
)

28 
d©a
;

29 
Êags
;

31 
	`loˇl_úq_ßve
(
Êags
);

32 
	`outb
(0, 
ide_ba£
);

33 
d©a
 = 
	`öb
(
ide_ba£
+1);

34 
	`outb
(0, 
ide_ba£
);

35 
	`outb
(
d©a
 | 0x40, 
ide_ba£
+1);

36 
	`outb
(
d©a
 | 0x40, 
ide_ba£
+1);

37 
	`loˇl_úq_ª°‹e
(
Êags
);

38 
	}
}

	@arch/alpha/kernel/osf_sys.c

13 
	~<löux/î∫o.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/smp.h
>

18 
	~<löux/smp_lock.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/sysˇŒs.h
>

21 
	~<löux/uni°d.h
>

22 
	~<löux/±ø˚.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/u£r.h
>

25 
	~<löux/a.out.h
>

26 
	~<löux/ut¢ame.h
>

27 
	~<löux/time.h
>

28 
	~<löux/timex.h
>

29 
	~<löux/maj‹.h
>

30 
	~<löux/°©.h
>

31 
	~<löux/mm™.h
>

32 
	~<löux/shm.h
>

33 
	~<löux/pﬁl.h
>

34 
	~<löux/fûe.h
>

35 
	~<löux/ty≥s.h
>

36 
	~<löux/ùc.h
>

37 
	~<löux/«mei.h
>

38 
	~<löux/uio.h
>

39 
	~<löux/vfs.h
>

40 
	~<löux/rcupd©e.h
>

42 
	~<asm/Âu.h
>

43 
	~<asm/io.h
>

44 
	~<asm/uac˚ss.h
>

45 
	~<asm/sy°em.h
>

46 
	~<asm/sysöfo.h
>

47 
	~<asm/hwΩb.h
>

48 
	~<asm/¥o˚ss‹.h
>

50 
do_pùe
(*);

58 
asmlökage
 

59 
	$osf_brk
(
brk
)

61 
ªtvÆ
 = 
	`sys_brk
(
brk
);

62 i‡(
brk
 && brk !
ªtvÆ
)

63 
ªtvÆ
 = -
ENOMEM
;

64  
ªtvÆ
;

65 
	}
}

70 
asmlökage
 

71 
	$osf_£t_¥ogøm_©åibuãs
(
ãxt_°¨t
, 
ãxt_Àn
,

72 
bss_°¨t
, 
bss_Àn
)

74 
mm_°ru˘
 *
mm
;

76 
	`lock_kî√l
();

77 
mm
 = 
cuºít
->mm;

78 
mm
->
íd_code
 = 
bss_°¨t
 + 
bss_Àn
;

79 
mm
->
brk
 = 
bss_°¨t
 + 
bss_Àn
;

81 
	`¥ötk
("set_program_attributes(%lx %lx %lx %lx)\n",

82 
ãxt_°¨t
, 
ãxt_Àn
, 
bss_°¨t
, 
bss_Àn
);

84 
	`u∆ock_kî√l
();

86 
	}
}

95 
	#NAME_OFFSET
 
	`off£tof
 (
osf_dúít
, 
d_«me
)

	)

97 
	sosf_dúít
 {

98 
	md_öo
;

99 
	md_ª˛í
;

100 
	md_«mÀn
;

101 
	md_«me
[1];

104 
	sosf_dúít_ˇŒback
 {

105 
osf_dúít
 
__u£r
 *
	mdúít
;

106 
__u£r
 *
	mba£p
;

107 
	mcou¡
;

108 
	mîr‹
;

112 
	$osf_fûldú
(*
__buf
, c⁄° *
«me
, 
«mÀn
, 
loff_t
 
off£t
,

113 
u64
 
öo
, 
d_ty≥
)

115 
osf_dúít
 
__u£r
 *
dúít
;

116 
osf_dúít_ˇŒback
 *
buf
 = (osf_dúít_ˇŒback *Ë
__buf
;

117 
ª˛í
 = 
	`ALIGN
(
NAME_OFFSET
 + 
«mÀn
 + 1, (
u32
));

118 
d_öo
;

120 
buf
->
îr‹
 = -
EINVAL
;

121 i‡(
ª˛í
 > 
buf
->
cou¡
)

122  -
EINVAL
;

123 
d_öo
 = 
öo
;

124 i‡((
d_öo
Ë< (
öo
) && d_ino != ino)

125  -
EOVERFLOW
;

126 i‡(
buf
->
ba£p
) {

127 i‡(
	`put_u£r
(
off£t
, 
buf
->
ba£p
))

128  -
EFAULT
;

129 
buf
->
ba£p
 = 
NULL
;

131 
dúít
 = 
buf
->dirent;

132 
	`put_u£r
(
d_öo
, &
dúít
->d_ino);

133 
	`put_u£r
(
«mÀn
, &
dúít
->
d_«mÀn
);

134 
	`put_u£r
(
ª˛í
, &
dúít
->
d_ª˛í
);

135 i‡(
	`c›y_to_u£r
(
dúít
->
d_«me
, 
«me
, 
«mÀn
) ||

136 
	`put_u£r
(0, 
dúít
->
d_«me
 + 
«mÀn
))

137  -
EFAULT
;

138 
dúít
 = (
__u£r
 *)dúíà+ 
ª˛í
;

139 
buf
->
dúít
 = dirent;

140 
buf
->
cou¡
 -
ª˛í
;

142 
	}
}

144 
asmlökage
 

145 
	$osf_gëdúíåõs
(
fd
, 
osf_dúít
 
__u£r
 *
dúít
,

146 
cou¡
, 
__u£r
 *
ba£p
)

148 
îr‹
;

149 
fûe
 *file;

150 
osf_dúít_ˇŒback
 
buf
;

152 
îr‹
 = -
EBADF
;

153 
fûe
 = 
	`fgë
(
fd
);

154 i‡(!
fûe
)

155 
out
;

157 
buf
.
dúít
 = dirent;

158 
buf
.
ba£p
 = basep;

159 
buf
.
cou¡
 = count;

160 
buf
.
îr‹
 = 0;

162 
îr‹
 = 
	`vfs_ªaddú
(
fûe
, 
osf_fûldú
, &
buf
);

163 i‡(
îr‹
 < 0)

164 
out_putf
;

166 
îr‹
 = 
buf
.error;

167 i‡(
cou¡
 !
buf
.count)

168 
îr‹
 = 
cou¡
 - 
buf
.count;

170 
out_putf
:

171 
	`Âut
(
fûe
);

172 
out
:

173  
îr‹
;

174 
	}
}

176 #unde‡
NAME_OFFSET


178 
asmlökage
 

179 
	$osf_mm≠
(
addr
, 
Àn
, 
¥Ÿ
,

180 
Êags
, 
fd
, 
off
)

182 
fûe
 *fûê
NULL
;

183 
ªt
 = -
EBADF
;

186 i‡(
Êags
 & (
_MAP_HASSEMAPHORE
 | 
_MAP_INHERIT
 | 
_MAP_UNALIGNED
))

187 
	`¥ötk
("%s: unimplemented OSF mmap flags %04lx\n",

188 
cuºít
->
comm
, 
Êags
);

190 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

191 
fûe
 = 
	`fgë
(
fd
);

192 i‡(!
fûe
)

193 
out
;

195 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

196 
	`down_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

197 
ªt
 = 
	`do_mm≠
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
off
);

198 
	`up_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

199 i‡(
fûe
)

200 
	`Âut
(
fûe
);

201 
out
:

202  
ªt
;

203 
	}
}

210 
	sosf_°©fs
 {

211 
	mf_ty≥
;

212 
	mf_Êags
;

213 
	mf_fsize
;

214 
	mf_bsize
;

215 
	mf_blocks
;

216 
	mf_b‰ì
;

217 
	mf_bavaû
;

218 
	mf_fûes
;

219 
	mf_f‰ì
;

220 
__kî√l_fsid_t
 
	mf_fsid
;

224 
	$löux_to_osf_°©fs
(
k°©fs
 *
löux_°©
, 
osf_°©fs
 
__u£r
 *
osf_°©
,

225 
bufsiz
)

227 
osf_°©fs
 
tmp_°©
;

229 
tmp_°©
.
f_ty≥
 = 
löux_°©
->f_type;

230 
tmp_°©
.
f_Êags
 = 0;

231 
tmp_°©
.
f_fsize
 = 
löux_°©
->
f_‰size
;

232 
tmp_°©
.
f_bsize
 = 
löux_°©
->f_bsize;

233 
tmp_°©
.
f_blocks
 = 
löux_°©
->f_blocks;

234 
tmp_°©
.
f_b‰ì
 = 
löux_°©
->f_bfree;

235 
tmp_°©
.
f_bavaû
 = 
löux_°©
->f_bavail;

236 
tmp_°©
.
f_fûes
 = 
löux_°©
->f_files;

237 
tmp_°©
.
f_f‰ì
 = 
löux_°©
->f_ffree;

238 
tmp_°©
.
f_fsid
 = 
löux_°©
->f_fsid;

239 i‡(
bufsiz
 > (
tmp_°©
))

240 
bufsiz
 = (
tmp_°©
);

241  
	`c›y_to_u£r
(
osf_°©
, &
tmp_°©
, 
bufsiz
Ë? -
EFAULT
 : 0;

242 
	}
}

245 
	$do_osf_°©fs
(
díåy
 * díåy, 
osf_°©fs
 
__u£r
 *
buf„r
,

246 
bufsiz
)

248 
k°©fs
 
löux_°©
;

249 
îr‹
 = 
	`vfs_°©fs
(
díåy
, &
löux_°©
);

250 i‡(!
îr‹
)

251 
îr‹
 = 
	`löux_to_osf_°©fs
(&
löux_°©
, 
buf„r
, 
bufsiz
);

252  
îr‹
;

253 
	}
}

255 
asmlökage
 

256 
	$osf_°©fs
(
__u£r
 *
∑th
, 
osf_°©fs
 __u£∏*
buf„r
, 
bufsiz
)

258 
«meid©a
 
nd
;

259 
ªtvÆ
;

261 
ªtvÆ
 = 
	`u£r_∑th_wÆk
(
∑th
, &
nd
);

262 i‡(!
ªtvÆ
) {

263 
ªtvÆ
 = 
	`do_osf_°©fs
(
nd
.
díåy
, 
buf„r
, 
bufsiz
);

264 
	`∑th_ªÀa£
(&
nd
);

266  
ªtvÆ
;

267 
	}
}

269 
asmlökage
 

270 
	$osf_f°©fs
(
fd
, 
osf_°©fs
 
__u£r
 *
buf„r
, 
bufsiz
)

272 
fûe
 *file;

273 
ªtvÆ
;

275 
ªtvÆ
 = -
EBADF
;

276 
fûe
 = 
	`fgë
(
fd
);

277 i‡(
fûe
) {

278 
ªtvÆ
 = 
	`do_osf_°©fs
(
fûe
->
f_∑th
.
díåy
, 
buf„r
, 
bufsiz
);

279 
	`Âut
(
fûe
);

281  
ªtvÆ
;

282 
	}
}

289 
	sufs_¨gs
 {

290 
__u£r
 *
	mdev«me
;

291 
	mÊags
;

292 
uid_t
 
	mexroŸ
;

295 
	scdfs_¨gs
 {

296 
__u£r
 *
	mdev«me
;

297 
	mÊags
;

298 
uid_t
 
	mexroŸ
;

304 
	s¥ocfs_¨gs
 {

305 
__u£r
 *
	mdev«me
;

306 
	mÊags
;

307 
uid_t
 
	mexroŸ
;

319 
	$osf_ufs_mou¡
(*
dú«me
, 
ufs_¨gs
 
__u£r
 *
¨gs
, 
Êags
)

321 
ªtvÆ
;

322 
cdfs_¨gs
 
tmp
;

323 *
dev«me
;

325 
ªtvÆ
 = -
EFAULT
;

326 i‡(
	`c›y_‰om_u£r
(&
tmp
, 
¨gs
, (tmp)))

327 
out
;

328 
dev«me
 = 
	`gë«me
(
tmp
.devname);

329 
ªtvÆ
 = 
	`PTR_ERR
(
dev«me
);

330 i‡(
	`IS_ERR
(
dev«me
))

331 
out
;

332 
ªtvÆ
 = 
	`do_mou¡
(
dev«me
, 
dú«me
, "ext2", 
Êags
, 
NULL
);

333 
	`puäame
(
dev«me
);

334 
out
:

335  
ªtvÆ
;

336 
	}
}

339 
	$osf_cdfs_mou¡
(*
dú«me
, 
cdfs_¨gs
 
__u£r
 *
¨gs
, 
Êags
)

341 
ªtvÆ
;

342 
cdfs_¨gs
 
tmp
;

343 *
dev«me
;

345 
ªtvÆ
 = -
EFAULT
;

346 i‡(
	`c›y_‰om_u£r
(&
tmp
, 
¨gs
, (tmp)))

347 
out
;

348 
dev«me
 = 
	`gë«me
(
tmp
.devname);

349 
ªtvÆ
 = 
	`PTR_ERR
(
dev«me
);

350 i‡(
	`IS_ERR
(
dev«me
))

351 
out
;

352 
ªtvÆ
 = 
	`do_mou¡
(
dev«me
, 
dú«me
, "iso9660", 
Êags
, 
NULL
);

353 
	`puäame
(
dev«me
);

354 
out
:

355  
ªtvÆ
;

356 
	}
}

359 
	$osf_¥ocfs_mou¡
(*
dú«me
, 
¥ocfs_¨gs
 
__u£r
 *
¨gs
, 
Êags
)

361 
¥ocfs_¨gs
 
tmp
;

363 i‡(
	`c›y_‰om_u£r
(&
tmp
, 
¨gs
, (tmp)))

364  -
EFAULT
;

366  
	`do_mou¡
("", 
dú«me
, "¥oc", 
Êags
, 
NULL
);

367 
	}
}

369 
asmlökage
 

370 
	$osf_mou¡
(
ty≥ƒ
, 
__u£r
 *
∑th
, 
Êag
, __u£∏*
d©a
)

372 
ªtvÆ
 = -
EINVAL
;

373 *
«me
;

375 
	`lock_kî√l
();

377 
«me
 = 
	`gë«me
(
∑th
);

378 
ªtvÆ
 = 
	`PTR_ERR
(
«me
);

379 i‡(
	`IS_ERR
(
«me
))

380 
out
;

381 
ty≥ƒ
) {

383 
ªtvÆ
 = 
	`osf_ufs_mou¡
(
«me
, 
d©a
, 
Êag
);

386 
ªtvÆ
 = 
	`osf_cdfs_mou¡
(
«me
, 
d©a
, 
Êag
);

389 
ªtvÆ
 = 
	`osf_¥ocfs_mou¡
(
«me
, 
d©a
, 
Êag
);

392 
	`¥ötk
("osf_mou¡(%ld, %x)\n", 
ty≥ƒ
, 
Êag
);

394 
	`puäame
(
«me
);

395 
out
:

396 
	`u∆ock_kî√l
();

397  
ªtvÆ
;

398 
	}
}

400 
asmlökage
 

401 
	$osf_ut¢ame
(
__u£r
 *
«me
)

403 
îr‹
;

405 
	`down_ªad
(&
uts_£m
);

406 
îr‹
 = -
EFAULT
;

407 i‡(
	`c›y_to_u£r
(
«me
 + 0, 
	`ut¢ame
()->
sy¢ame
, 32))

408 
out
;

409 i‡(
	`c›y_to_u£r
(
«me
 + 32, 
	`ut¢ame
()->
nodíame
, 32))

410 
out
;

411 i‡(
	`c›y_to_u£r
(
«me
 + 64, 
	`ut¢ame
()->
ªÀa£
, 32))

412 
out
;

413 i‡(
	`c›y_to_u£r
(
«me
 + 96, 
	`ut¢ame
()->
vîsi⁄
, 32))

414 
out
;

415 i‡(
	`c›y_to_u£r
(
«me
 + 128, 
	`ut¢ame
()->
machöe
, 32))

416 
out
;

418 
îr‹
 = 0;

419 
out
:

420 
	`up_ªad
(&
uts_£m
);

421  
îr‹
;

422 
	}
}

424 
asmlökage
 

425 
	$sys_gë∑gesize
()

427  
PAGE_SIZE
;

428 
	}
}

430 
asmlökage
 

431 
	$sys_gëdèbÀsize
()

433  
NR_OPEN
;

434 
	}
}

439 
asmlökage
 

440 
	$osf_gëdomaö«me
(
__u£r
 *
«me
, 
«mñí
)

442 
Àn
;

443 
i
;

445 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
«me
, 
«mñí
))

446  -
EFAULT
;

448 
Àn
 = 
«mñí
;

449 i‡(
«mñí
 > 32)

450 
Àn
 = 32;

452 
	`down_ªad
(&
uts_£m
);

453 
i
 = 0; i < 
Àn
; ++i) {

454 
	`__put_u£r
(
	`ut¢ame
()->
domaö«me
[
i
], 
«me
 + i);

455 i‡(
	`ut¢ame
()->
domaö«me
[
i
] == '\0')

458 
	`up_ªad
(&
uts_£m
);

461 
	}
}

473 
	#PLE_PROPAGATE_ON_COPY
 0x1

	)

475 
	#PLE_FLAG_MASK
 0x1

	)

476 
	#PLE_FLAG_ALL
 -1

	)

478 
	s¥›li°«me_¨gs
 {

479 
	m∂_mask
;

480 
	m∂_num«mes
;

481 **
	m∂_«mes
;

484 
	u∂_¨gs
 {

485 
	s£èrgs
 {

486 
__u£r
 *
	m∑th
;

487 
	mfﬁlow
;

488 
	mnbyãs
;

489 
__u£r
 *
	mbuf
;

490 } 
	m£t
;

491 
	sf£èrgs
 {

492 
	mfd
;

493 
	mnbyãs
;

494 
__u£r
 *
	mbuf
;

495 } 
	mf£t
;

496 
	sgë¨gs
 {

497 
__u£r
 *
	m∑th
;

498 
	mfﬁlow
;

499 
¥›li°«me_¨gs
 
__u£r
 *
	m«me_¨gs
;

500 
	mnbyãs
;

501 
__u£r
 *
	mbuf
;

502 
__u£r
 *
	mmö_buf_size
;

503 } 
	mgë
;

504 
	sfgë¨gs
 {

505 
	mfd
;

506 
¥›li°«me_¨gs
 
__u£r
 *
	m«me_¨gs
;

507 
	mnbyãs
;

508 
__u£r
 *
	mbuf
;

509 
__u£r
 *
	mmö_buf_size
;

510 } 
	mfgë
;

511 
	sdñ¨gs
 {

512 
__u£r
 *
	m∑th
;

513 
	mfﬁlow
;

514 
¥›li°«me_¨gs
 
__u£r
 *
	m«me_¨gs
;

515 } 
	mdñ
;

516 
	sfdñ¨gs
 {

517 
	mfd
;

518 
¥›li°«me_¨gs
 
__u£r
 *
	m«me_¨gs
;

519 } 
	mfdñ
;

522 
	e∂_code
 {

523 
	mPL_SET
 = 1, 
	mPL_FSET
 = 2,

524 
	mPL_GET
 = 3, 
	mPL_FGET
 = 4,

525 
	mPL_DEL
 = 5, 
	mPL_FDEL
 = 6

528 
asmlökage
 

529 
	$osf_¥›li°_sysˇŒ
(
∂_code
 
code
, 
∂_¨gs
 
__u£r
 *
¨gs
)

531 
îr‹
;

532 
__u£r
 *
mö_buf_size_±r
;

534 
	`lock_kî√l
();

535 
code
) {

536 
PL_SET
:

537 i‡(
	`gë_u£r
(
îr‹
, &
¨gs
->
£t
.
nbyãs
))

538 
îr‹
 = -
EFAULT
;

540 
PL_FSET
:

541 i‡(
	`gë_u£r
(
îr‹
, &
¨gs
->
f£t
.
nbyãs
))

542 
îr‹
 = -
EFAULT
;

544 
PL_GET
:

545 
îr‹
 = 
	`gë_u£r
(
mö_buf_size_±r
, &
¨gs
->
gë
.
mö_buf_size
);

546 i‡(
îr‹
)

548 
îr‹
 = 
	`put_u£r
(0, 
mö_buf_size_±r
);

550 
PL_FGET
:

551 
îr‹
 = 
	`gë_u£r
(
mö_buf_size_±r
, &
¨gs
->
fgë
.
mö_buf_size
);

552 i‡(
îr‹
)

554 
îr‹
 = 
	`put_u£r
(0, 
mö_buf_size_±r
);

556 
PL_DEL
:

557 
PL_FDEL
:

558 
îr‹
 = 0;

561 
îr‹
 = -
EOPNOTSUPP
;

564 
	`u∆ock_kî√l
();

565  
îr‹
;

566 
	}
}

568 
asmlökage
 

569 
	$osf_sig°ack
(
sig°ack
 
__u£r
 *
uss
, sig°ack __u£∏*
uoss
)

571 
u•
 = 
	`rdu•
();

572 
oss_•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

573 
oss_os
 = 
	`⁄_sig_°ack
(
u•
);

574 
îr‹
;

576 i‡(
uss
) {

577 
__u£r
 *
ss_•
;

579 
îr‹
 = -
EFAULT
;

580 i‡(
	`gë_u£r
(
ss_•
, &
uss
->ss_sp))

581 
out
;

585 
îr‹
 = -
EPERM
;

586 i‡(
cuºít
->
ßs_ss_•
 && 
	`⁄_sig_°ack
(
u•
))

587 
out
;

592 
cuºít
->
ßs_ss_•
 = ()
ss_•
 - 
SIGSTKSZ
;

593 
cuºít
->
ßs_ss_size
 = 
SIGSTKSZ
;

596 i‡(
uoss
) {

597 
îr‹
 = -
EFAULT
;

598 i‡(! 
	`ac˚ss_ok
(
VERIFY_WRITE
, 
uoss
, (*uoss))

599 || 
	`__put_u£r
(
oss_•
, &
uoss
->
ss_•
)

600 || 
	`__put_u£r
(
oss_os
, &
uoss
->
ss_⁄°ack
))

601 
out
;

604 
îr‹
 = 0;

605 
out
:

606  
îr‹
;

607 
	}
}

609 
asmlökage
 

610 
	$osf_sysöfo
(
comm™d
, 
__u£r
 *
buf
, 
cou¡
)

612 *
sysöfo_èbÀ
[] = {

613 
	`ut¢ame
()->
sy¢ame
,

614 
	`ut¢ame
()->
nodíame
,

615 
	`ut¢ame
()->
ªÀa£
,

616 
	`ut¢ame
()->
vîsi⁄
,

617 
	`ut¢ame
()->
machöe
,

623 
off£t
;

624 *
ªs
;

625 
Àn
, 
îr
 = -
EINVAL
;

627 
off£t
 = 
comm™d
-1;

628 i‡(
off£t
 >
	`ARRAY_SIZE
(
sysöfo_èbÀ
)) {

630 
	`¥ötk
("sysöfo(%d)", 
comm™d
);

631 
out
;

634 
	`down_ªad
(&
uts_£m
);

635 
ªs
 = 
sysöfo_èbÀ
[
off£t
];

636 
Àn
 = 
	`°æí
(
ªs
)+1;

637 i‡(
Àn
 > 
cou¡
)

638 
Àn
 = 
cou¡
;

639 i‡(
	`c›y_to_u£r
(
buf
, 
ªs
, 
Àn
))

640 
îr
 = -
EFAULT
;

642 
îr
 = 0;

643 
	`up_ªad
(&
uts_£m
);

644 
out
:

645  
îr
;

646 
	}
}

648 
asmlökage
 

649 
	$osf_gësysöfo
(
›
, 
__u£r
 *
buf„r
, 
nbyãs
,

650 
__u£r
 *
°¨t
, __u£∏*
¨g
)

652 
w
;

653 
≥r˝u_°ru˘
 *
˝u
;

655 
›
) {

656 
GSI_IEEE_FP_CONTROL
:

660 
w
 = 
	`cuºít_thªad_öfo
()->
õì_°©e
 & 
IEEE_SW_MASK
;

661 
w
 = 
	`sw¸_upd©e_°©us
(w, 
	`rdÂ¸
());

662 i‡(
	`put_u£r
(
w
, (
__u£r
 *Ë
buf„r
))

663  -
EFAULT
;

666 
GSI_IEEE_STATE_AT_SIGNAL
:

674 
GSI_UACPROC
:

675 i‡(
nbyãs
 < ())

676  -
EINVAL
;

677 
w
 = (
	`cuºít_thªad_öfo
()->
Êags
 >> 
UAC_SHIFT
Ë& 
UAC_BITMASK
;

678 i‡(
	`put_u£r
(
w
, (
__u£r
 *)
buf„r
))

679  -
EFAULT
;

682 
GSI_PROC_TYPE
:

683 i‡(
nbyãs
 < ())

684  -
EINVAL
;

685 
˝u
 = (
≥r˝u_°ru˘
*)

686 ((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

687 
w
 = 
˝u
->
ty≥
;

688 i‡(
	`put_u£r
(
w
, (
__u£r
*)
buf„r
))

689  -
EFAULT
;

692 
GSI_GET_HWRPB
:

693 i‡(
nbyãs
 < (*
hwΩb
))

694  -
EINVAL
;

695 i‡(
	`c›y_to_u£r
(
buf„r
, 
hwΩb
, 
nbyãs
) != 0)

696  -
EFAULT
;

703  -
EOPNOTSUPP
;

704 
	}
}

706 
asmlökage
 

707 
	$osf_£tsysöfo
(
›
, 
__u£r
 *
buf„r
, 
nbyãs
,

708 
__u£r
 *
°¨t
, __u£∏*
¨g
)

710 
›
) {

711 
SSI_IEEE_FP_CONTROL
: {

712 
sw¸
, 
Â¸
;

713 *
°©e
;

722 i‡(
	`gë_u£r
(
sw¸
, (
__u£r
 *)
buf„r
))

723  -
EFAULT
;

724 
°©e
 = &
	`cuºít_thªad_öfo
()->
õì_°©e
;

727 *
°©e
 = (*°©ê& ~
IEEE_SW_MASK
Ë| (
sw¸
 & IEEE_SW_MASK);

730 
Â¸
 = 
	`rdÂ¸
(Ë& 
FPCR_DYN_MASK
;

731 
Â¸
 |
	`õì_sw¸_to_Â¸
(
sw¸
);

732 
	`wrÂ¸
(
Â¸
);

737 
SSI_IEEE_RAISE_EXCEPTION
: {

738 
exc
, 
sw¸
, 
Â¸
, 
„x
;

739 *
°©e
;

741 i‡(
	`gë_u£r
(
exc
, (
__u£r
 *)
buf„r
))

742  -
EFAULT
;

743 
°©e
 = &
	`cuºít_thªad_öfo
()->
õì_°©e
;

744 
exc
 &
IEEE_STATUS_MASK
;

747 
sw¸
 = (*
°©e
 & 
IEEE_SW_MASK
Ë| 
exc
;

748 *
°©e
 |
exc
;

751 
Â¸
 = 
	`rdÂ¸
();

752 
Â¸
 |
	`õì_sw¸_to_Â¸
(
sw¸
);

753 
	`wrÂ¸
(
Â¸
);

757 
„x
 = (
exc
 >> 
IEEE_STATUS_TO_EXCSUM_SHIFT
Ë& 
sw¸
;

758 i‡(
„x
) {

759 
sigöfo_t
 
öfo
;

760 
si_code
 = 0;

762 i‡(
„x
 & 
IEEE_TRAP_ENABLE_DNO
Ë
si_code
 = 
FPE_FLTUND
;

763 i‡(
„x
 & 
IEEE_TRAP_ENABLE_INE
Ë
si_code
 = 
FPE_FLTRES
;

764 i‡(
„x
 & 
IEEE_TRAP_ENABLE_UNF
Ë
si_code
 = 
FPE_FLTUND
;

765 i‡(
„x
 & 
IEEE_TRAP_ENABLE_OVF
Ë
si_code
 = 
FPE_FLTOVF
;

766 i‡(
„x
 & 
IEEE_TRAP_ENABLE_DZE
Ë
si_code
 = 
FPE_FLTDIV
;

767 i‡(
„x
 & 
IEEE_TRAP_ENABLE_INV
Ë
si_code
 = 
FPE_FLTINV
;

769 
öfo
.
si_signo
 = 
SIGFPE
;

770 
öfo
.
si_î∫o
 = 0;

771 
öfo
.
si_code
 = si_code;

772 
öfo
.
si_addr
 = 
NULL
;

773 
	`£nd_sig_öfo
(
SIGFPE
, &
öfo
, 
cuºít
);

778 
SSI_IEEE_STATE_AT_SIGNAL
:

779 
SSI_IEEE_IGNORE_STATE_AT_SIGNAL
:

787 
SSI_NVPAIRS
: {

788 
v
, 
w
, 
i
;

789 
ﬁd
, 
√w
;

791 
i
 = 0; i < 
nbyãs
; ++i) {

793 i‡(
	`gë_u£r
(
v
, 2*
i
 + (
__u£r
 *)
buf„r
))

794  -
EFAULT
;

795 i‡(
	`gë_u£r
(
w
, 2*
i
 + 1 + (
__u£r
 *)
buf„r
))

796  -
EFAULT
;

797 
v
) {

798 
SSIN_UACPROC
:

799 
agaö
:

800 
ﬁd
 = 
	`cuºít_thªad_öfo
()->
Êags
;

801 
√w
 = 
ﬁd
 & ~(
UAC_BITMASK
 << 
UAC_SHIFT
);

802 
√w
 =Çew | (
w
 & 
UAC_BITMASK
Ë<< 
UAC_SHIFT
;

803 i‡(
	`cmpxchg
(&
	`cuºít_thªad_öfo
()->
Êags
,

804 
ﬁd
, 
√w
) != old)

805 
agaö
;

809  -
EOPNOTSUPP
;

819  -
EOPNOTSUPP
;

820 
	}
}

825 
timez⁄e
 
sys_tz
;

827 
	stimevÆ32


829 
	mtv_£c
, 
	mtv_u£c
;

832 
	sôimîvÆ32


834 
timevÆ32
 
	mô_öãrvÆ
;

835 
timevÆ32
 
	mô_vÆue
;

838 
ölöe
 

839 
	$gë_tv32
(
timevÆ
 *
o
, 
timevÆ32
 
__u£r
 *
i
)

841  (!
	`ac˚ss_ok
(
VERIFY_READ
, 
i
, (*i)) ||

842 (
	`__gë_u£r
(
o
->
tv_£c
, &
i
->tv_sec) |

843 
	`__gë_u£r
(
o
->
tv_u£c
, &
i
->tv_usec)));

844 
	}
}

846 
ölöe
 

847 
	$put_tv32
(
timevÆ32
 
__u£r
 *
o
, 
timevÆ
 *
i
)

849  (!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
o
, (*o)) ||

850 (
	`__put_u£r
(
i
->
tv_£c
, &
o
->tv_sec) |

851 
	`__put_u£r
(
i
->
tv_u£c
, &
o
->tv_usec)));

852 
	}
}

854 
ölöe
 

855 
	$gë_ô32
(
ôimîvÆ
 *
o
, 
ôimîvÆ32
 
__u£r
 *
i
)

857  (!
	`ac˚ss_ok
(
VERIFY_READ
, 
i
, (*i)) ||

858 (
	`__gë_u£r
(
o
->
ô_öãrvÆ
.
tv_£c
, &
i
->it_interval.tv_sec) |

859 
	`__gë_u£r
(
o
->
ô_öãrvÆ
.
tv_u£c
, &
i
->it_interval.tv_usec) |

860 
	`__gë_u£r
(
o
->
ô_vÆue
.
tv_£c
, &
i
->it_value.tv_sec) |

861 
	`__gë_u£r
(
o
->
ô_vÆue
.
tv_u£c
, &
i
->it_value.tv_usec)));

862 
	}
}

864 
ölöe
 

865 
	$put_ô32
(
ôimîvÆ32
 
__u£r
 *
o
, 
ôimîvÆ
 *
i
)

867  (!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
o
, (*o)) ||

868 (
	`__put_u£r
(
i
->
ô_öãrvÆ
.
tv_£c
, &
o
->it_interval.tv_sec) |

869 
	`__put_u£r
(
i
->
ô_öãrvÆ
.
tv_u£c
, &
o
->it_interval.tv_usec) |

870 
	`__put_u£r
(
i
->
ô_vÆue
.
tv_£c
, &
o
->it_value.tv_sec) |

871 
	`__put_u£r
(
i
->
ô_vÆue
.
tv_u£c
, &
o
->it_value.tv_usec)));

872 
	}
}

874 
ölöe
 

875 
	$jiffõs_to_timevÆ32
(
jiffõs
, 
timevÆ32
 *
vÆue
)

877 
vÆue
->
tv_u£c
 = (
jiffõs
 % 
HZ
) * (1000000L / HZ);

878 
vÆue
->
tv_£c
 = 
jiffõs
 / 
HZ
;

879 
	}
}

881 
asmlökage
 

882 
	$osf_gëtimeofday
(
timevÆ32
 
__u£r
 *
tv
, 
timez⁄e
 __u£∏*
tz
)

884 i‡(
tv
) {

885 
timevÆ
 
ktv
;

886 
	`do_gëtimeofday
(&
ktv
);

887 i‡(
	`put_tv32
(
tv
, &
ktv
))

888  -
EFAULT
;

890 i‡(
tz
) {

891 i‡(
	`c›y_to_u£r
(
tz
, &
sys_tz
, (sys_tz)))

892  -
EFAULT
;

895 
	}
}

897 
asmlökage
 

898 
	$osf_£âimeofday
(
timevÆ32
 
__u£r
 *
tv
, 
timez⁄e
 __u£∏*
tz
)

900 
time•ec
 
kts
;

901 
timez⁄e
 
ktz
;

903 i‡(
tv
) {

904 i‡(
	`gë_tv32
((
timevÆ
 *)&
kts
, 
tv
))

905  -
EFAULT
;

907 i‡(
tz
) {

908 i‡(
	`c›y_‰om_u£r
(&
ktz
, 
tz
, (*tz)))

909  -
EFAULT
;

912 
kts
.
tv_n£c
 *= 1000;

914  
	`do_sys_£âimeofday
(
tv
 ? &
kts
 : 
NULL
, 
tz
 ? &
ktz
 : NULL);

915 
	}
}

917 
asmlökage
 

918 
	$osf_gëôimî
(
which
, 
ôimîvÆ32
 
__u£r
 *
ô
)

920 
ôimîvÆ
 
kô
;

921 
îr‹
;

923 
îr‹
 = 
	`do_gëôimî
(
which
, &
kô
);

924 i‡(!
îr‹
 && 
	`put_ô32
(
ô
, &
kô
))

925 
îr‹
 = -
EFAULT
;

927  
îr‹
;

928 
	}
}

930 
asmlökage
 

931 
	$osf_£tôimî
(
which
, 
ôimîvÆ32
 
__u£r
 *
ö
, ôimîvÆ32 __u£∏*
out
)

933 
ôimîvÆ
 
kö
, 
kout
;

934 
îr‹
;

936 i‡(
ö
) {

937 i‡(
	`gë_ô32
(&
kö
, 
ö
))

938  -
EFAULT
;

940 
	`mem£t
(&
kö
, 0, (kin));

942 
îr‹
 = 
	`do_£tôimî
(
which
, &
kö
, 
out
 ? &
kout
 : 
NULL
);

943 i‡(
îr‹
 || !
out
)

944  
îr‹
;

946 i‡(
	`put_ô32
(
out
, &
kout
))

947  -
EFAULT
;

951 
	}
}

953 
asmlökage
 

954 
	$osf_utimes
(
__u£r
 *
fûíame
, 
timevÆ32
 __u£∏*
tvs
)

956 
time•ec
 
tv
[2];

958 i‡(
tvs
) {

959 
timevÆ
 
ktvs
[2];

960 i‡(
	`gë_tv32
(&
ktvs
[0], &
tvs
[0]) ||

961 
	`gë_tv32
(&
ktvs
[1], &
tvs
[1]))

962  -
EFAULT
;

964 i‡(
ktvs
[0].
tv_u£c
 < 0 || ktvs[0].tv_usec >= 1000000 ||

965 
ktvs
[1].
tv_u£c
 < 0 || ktvs[1].tv_usec >= 1000000)

966  -
EINVAL
;

968 
tv
[0].
tv_£c
 = 
ktvs
[0].tv_sec;

969 
tv
[0].
tv_n£c
 = 1000 * 
ktvs
[0].
tv_u£c
;

970 
tv
[1].
tv_£c
 = 
ktvs
[1].tv_sec;

971 
tv
[1].
tv_n£c
 = 1000 * 
ktvs
[1].
tv_u£c
;

974  
	`do_utimes
(
AT_FDCWD
, 
fûíame
, 
tvs
 ? 
tv
 : 
NULL
, 0);

975 
	}
}

977 
	#MAX_SELECT_SECONDS
 \

978 ((Ë(
MAX_SCHEDULE_TIMEOUT
 / 
HZ
)-1)

	)

980 
asmlökage
 

981 
	$osf_£À˘
(
n
, 
fd_£t
 
__u£r
 *
öp
, fd_£à__u£∏*
ouç
, fd_£à__u£∏*
exp
,

982 
timevÆ32
 
__u£r
 *
tvp
)

984 
fd_£t_bôs
 
fds
;

985 *
bôs
;

986 
size_t
 
size
;

987 
timeout
;

988 
ªt
 = -
EINVAL
;

989 
fdèbÀ
 *
fdt
;

990 
max_fds
;

992 
timeout
 = 
MAX_SCHEDULE_TIMEOUT
;

993 i‡(
tvp
) {

994 
time_t
 
£c
, 
u£c
;

996 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
tvp
, (*tvp))

997 || 
	`__gë_u£r
(
£c
, &
tvp
->
tv_£c
)

998 || 
	`__gë_u£r
(
u£c
, &
tvp
->
tv_u£c
)) {

999 
ªt
 = -
EFAULT
;

1000 
out_nofds
;

1003 i‡(
£c
 < 0 || 
u£c
 < 0)

1004 
out_nofds
;

1006 i‡((Ë
£c
 < 
MAX_SELECT_SECONDS
) {

1007 
timeout
 = (
u£c
 + 1000000/
HZ
 - 1) / (1000000/HZ);

1008 
timeout
 +
£c
 * (Ë
HZ
;

1012 
	`rcu_ªad_lock
();

1013 
fdt
 = 
	`fûes_fdèbÀ
(
cuºít
->
fûes
);

1014 
max_fds
 = 
fdt
->max_fds;

1015 
	`rcu_ªad_u∆ock
();

1016 i‡(
n
 < 0 ||Ç > 
max_fds
)

1017 
out_nofds
;

1024 
ªt
 = -
ENOMEM
;

1025 
size
 = 
	`FDS_BYTES
(
n
);

1026 
bôs
 = 
	`kmÆloc
(6 * 
size
, 
GFP_KERNEL
);

1027 i‡(!
bôs
)

1028 
out_nofds
;

1029 
fds
.
ö
 = (*Ë
bôs
;

1030 
fds
.
out
 = (*Ë(
bôs
 + 
size
);

1031 
fds
.
ex
 = (*Ë(
bôs
 + 2*
size
);

1032 
fds
.
ªs_ö
 = (*Ë(
bôs
 + 3*
size
);

1033 
fds
.
ªs_out
 = (*Ë(
bôs
 + 4*
size
);

1034 
fds
.
ªs_ex
 = (*Ë(
bôs
 + 5*
size
);

1036 i‡((
ªt
 = 
	`gë_fd_£t
(
n
, 
öp
->
fds_bôs
, 
fds
.
ö
)) ||

1037 (
ªt
 = 
	`gë_fd_£t
(
n
, 
ouç
->
fds_bôs
, 
fds
.
out
)) ||

1038 (
ªt
 = 
	`gë_fd_£t
(
n
, 
exp
->
fds_bôs
, 
fds
.
ex
)))

1039 
out
;

1040 
	`zîo_fd_£t
(
n
, 
fds
.
ªs_ö
);

1041 
	`zîo_fd_£t
(
n
, 
fds
.
ªs_out
);

1042 
	`zîo_fd_£t
(
n
, 
fds
.
ªs_ex
);

1044 
ªt
 = 
	`do_£À˘
(
n
, &
fds
, &
timeout
);

1048 i‡(
ªt
 < 0)

1049 
out
;

1050 i‡(!
ªt
) {

1051 
ªt
 = -
ERESTARTNOHAND
;

1052 i‡(
	`sig«l_≥ndög
(
cuºít
))

1053 
out
;

1054 
ªt
 = 0;

1057 i‡(
	`£t_fd_£t
(
n
, 
öp
->
fds_bôs
, 
fds
.
ªs_ö
) ||

1058 
	`£t_fd_£t
(
n
, 
ouç
->
fds_bôs
, 
fds
.
ªs_out
) ||

1059 
	`£t_fd_£t
(
n
, 
exp
->
fds_bôs
, 
fds
.
ªs_ex
))

1060 
ªt
 = -
EFAULT
;

1062 
out
:

1063 
	`k‰ì
(
bôs
);

1064 
out_nofds
:

1065  
ªt
;

1066 
	}
}

1068 
	srußge32
 {

1069 
timevÆ32
 
	mru_utime
;

1070 
timevÆ32
 
	mru_°ime
;

1071 
	mru_maxrss
;

1072 
	mru_ixrss
;

1073 
	mru_idrss
;

1074 
	mru_i§ss
;

1075 
	mru_möÊt
;

1076 
	mru_majÊt
;

1077 
	mru_nsw≠
;

1078 
	mru_öblock
;

1079 
	mru_oublock
;

1080 
	mru_msg¢d
;

1081 
	mru_msgrcv
;

1082 
	mru_nsig«ls
;

1083 
	mru_nvcsw
;

1084 
	mru_nivcsw
;

1087 
asmlökage
 

1088 
	$osf_gërußge
(
who
, 
rußge32
 
__u£r
 *
ru
)

1090 
rußge32
 
r
;

1092 i‡(
who
 !
RUSAGE_SELF
 && whÿ!
RUSAGE_CHILDREN
)

1093  -
EINVAL
;

1095 
	`mem£t
(&
r
, 0, (r));

1096 
who
) {

1097 
RUSAGE_SELF
:

1098 
	`jiffõs_to_timevÆ32
(
cuºít
->
utime
, &
r
.
ru_utime
);

1099 
	`jiffõs_to_timevÆ32
(
cuºít
->
°ime
, &
r
.
ru_°ime
);

1100 
r
.
ru_möÊt
 = 
cuºít
->
mö_Êt
;

1101 
r
.
ru_majÊt
 = 
cuºít
->
maj_Êt
;

1103 
RUSAGE_CHILDREN
:

1104 
	`jiffõs_to_timevÆ32
(
cuºít
->
sig«l
->
cutime
, &
r
.
ru_utime
);

1105 
	`jiffõs_to_timevÆ32
(
cuºít
->
sig«l
->
c°ime
, &
r
.
ru_°ime
);

1106 
r
.
ru_möÊt
 = 
cuºít
->
sig«l
->
cmö_Êt
;

1107 
r
.
ru_majÊt
 = 
cuºít
->
sig«l
->
cmaj_Êt
;

1111  
	`c›y_to_u£r
(
ru
, &
r
, ‘)Ë? -
EFAULT
 : 0;

1112 
	}
}

1114 
asmlökage
 

1115 
	$osf_waô4
(
pid_t
 
pid
, 
__u£r
 *
u°©us
, 
›ti⁄s
,

1116 
rußge32
 
__u£r
 *
ur
)

1118 
rußge
 
r
;

1119 
ªt
, 
îr
;

1120 
mm_£gmít_t
 
ﬁd_fs
;

1122 i‡(!
ur
)

1123  
	`sys_waô4
(
pid
, 
u°©us
, 
›ti⁄s
, 
NULL
);

1125 
ﬁd_fs
 = 
	`gë_fs
();

1127 
	`£t_fs
 (
KERNEL_DS
);

1128 
ªt
 = 
	`sys_waô4
(
pid
, 
u°©us
, 
›ti⁄s
, (
rußge
 
__u£r
 *Ë&
r
);

1129 
	`£t_fs
 (
ﬁd_fs
);

1131 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ur
, (*ur)))

1132  -
EFAULT
;

1134 
îr
 = 0;

1135 
îr
 |
	`__put_u£r
(
r
.
ru_utime
.
tv_£c
, &
ur
->ru_utime.tv_sec);

1136 
îr
 |
	`__put_u£r
(
r
.
ru_utime
.
tv_u£c
, &
ur
->ru_utime.tv_usec);

1137 
îr
 |
	`__put_u£r
(
r
.
ru_°ime
.
tv_£c
, &
ur
->ru_stime.tv_sec);

1138 
îr
 |
	`__put_u£r
(
r
.
ru_°ime
.
tv_u£c
, &
ur
->ru_stime.tv_usec);

1139 
îr
 |
	`__put_u£r
(
r
.
ru_maxrss
, &
ur
->ru_maxrss);

1140 
îr
 |
	`__put_u£r
(
r
.
ru_ixrss
, &
ur
->ru_ixrss);

1141 
îr
 |
	`__put_u£r
(
r
.
ru_idrss
, &
ur
->ru_idrss);

1142 
îr
 |
	`__put_u£r
(
r
.
ru_i§ss
, &
ur
->ru_isrss);

1143 
îr
 |
	`__put_u£r
(
r
.
ru_möÊt
, &
ur
->ru_minflt);

1144 
îr
 |
	`__put_u£r
(
r
.
ru_majÊt
, &
ur
->ru_majflt);

1145 
îr
 |
	`__put_u£r
(
r
.
ru_nsw≠
, &
ur
->ru_nswap);

1146 
îr
 |
	`__put_u£r
(
r
.
ru_öblock
, &
ur
->ru_inblock);

1147 
îr
 |
	`__put_u£r
(
r
.
ru_oublock
, &
ur
->ru_oublock);

1148 
îr
 |
	`__put_u£r
(
r
.
ru_msg¢d
, &
ur
->ru_msgsnd);

1149 
îr
 |
	`__put_u£r
(
r
.
ru_msgrcv
, &
ur
->ru_msgrcv);

1150 
îr
 |
	`__put_u£r
(
r
.
ru_nsig«ls
, &
ur
->ru_nsignals);

1151 
îr
 |
	`__put_u£r
(
r
.
ru_nvcsw
, &
ur
->ru_nvcsw);

1152 
îr
 |
	`__put_u£r
(
r
.
ru_nivcsw
, &
ur
->ru_nivcsw);

1154  
îr
 ?Éº : 
ªt
;

1155 
	}
}

1162 
asmlökage
 

1163 
	$osf_u¶ìp_thªad
(
timevÆ32
 
__u£r
 *
¶ìp
, timevÆ32 __u£∏*
ªmaö
)

1165 
timevÆ
 
tmp
;

1166 
ticks
;

1168 i‡(
	`gë_tv32
(&
tmp
, 
¶ìp
))

1169 
Áu…
;

1171 
ticks
 = 
	`timevÆ_to_jiffõs
(&
tmp
);

1173 
ticks
 = 
	`scheduÀ_timeout_öãºu±ibÀ
(ticks);

1175 i‡(
ªmaö
) {

1176 
	`jiffõs_to_timevÆ
(
ticks
, &
tmp
);

1177 i‡(
	`put_tv32
(
ªmaö
, &
tmp
))

1178 
Áu…
;

1182 
Áu…
:

1183  -
EFAULT
;

1184 
	}
}

1187 
	stimex32
 {

1188 
	mmodes
;

1189 
	moff£t
;

1190 
	m‰eq
;

1191 
	mmaxîr‹
;

1192 
	me°îr‹
;

1193 
	m°©us
;

1194 
	mc⁄°™t
;

1195 
	m¥ecisi⁄
;

1196 
	mtﬁî™˚
;

1199 
timevÆ32
 
	mtime
;

1200 
	mtick
;

1202 
	mµs‰eq
;

1203 
	mjôãr
;

1204 
	mshi·
;

1205 
	m°abû
;

1206 
	mjô˙t
;

1207 
	mˇl˙t
;

1208 
	mîr˙t
;

1209 
	m°b˙t
;

1216 
asmlökage
 

1217 
	$sys_ﬁd_adjtimex
(
timex32
 
__u£r
 *
txc_p
)

1219 
timex
 
txc
;

1220 
ªt
;

1223 i‡(
	`c›y_‰om_u£r
(&
txc
, 
txc_p
, 
	`off£tof
(
timex32
, 
time
)) ||

1224 
	`c›y_‰om_u£r
(&
txc
.
tick
, &
txc_p
->tick, (
timex32
) -

1225 
	`off£tof
(
timex32
, 
time
)))

1226  -
EFAULT
;

1228 
ªt
 = 
	`do_adjtimex
(&
txc
);

1229 i‡(
ªt
 < 0)

1230  
ªt
;

1233 i‡(
	`c›y_to_u£r
(
txc_p
, &
txc
, 
	`off£tof
(
timex32
, 
time
)) ||

1234 (
	`c›y_to_u£r
(&
txc_p
->
tick
, &
txc
.tick, (
timex32
) -

1235 
	`off£tof
(
timex32
, 
tick
))) ||

1236 (
	`put_tv32
(&
txc_p
->
time
, &
txc
.time)))

1237  -
EFAULT
;

1239  
ªt
;

1240 
	}
}

1246 
	$¨ch_gë_unm≠≥d_¨ó_1
(
addr
, 
Àn
,

1247 
limô
)

1249 
vm_¨ó_°ru˘
 *
vma
 = 
	`föd_vma
(
cuºít
->
mm
, 
addr
);

1253 i‡(
limô
 - 
Àn
 < 
addr
)

1254  -
ENOMEM
;

1255 i‡(!
vma
 || 
addr
 + 
Àn
 <vma->
vm_°¨t
)

1256  
addr
;

1257 
addr
 = 
vma
->
vm_íd
;

1258 
vma
 = vma->
vm_√xt
;

1260 
	}
}

1263 
	$¨ch_gë_unm≠≥d_¨ó
(
fûe
 *
fûp
, 
addr
,

1264 
Àn
, 
pgoff
,

1265 
Êags
)

1267 
limô
;

1270 i‡(
cuºít
->
≥rs⁄Æôy
 & 
ADDR_LIMIT_32BIT
)

1271 
limô
 = 0x80000000;

1273 
limô
 = 
TASK_SIZE
;

1275 i‡(
Àn
 > 
limô
)

1276  -
ENOMEM
;

1278 i‡(
Êags
 & 
MAP_FIXED
)

1279  
addr
;

1291 i‡(
addr
) {

1292 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó_1
 (
	`PAGE_ALIGN
◊ddr), 
Àn
, 
limô
);

1293 i‡(
addr
 !(Ë-
ENOMEM
)

1294  
addr
;

1298 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó_1
 (
	`PAGE_ALIGN
(
TASK_UNMAPPED_BASE
),

1299 
Àn
, 
limô
);

1300 i‡(
addr
 !(Ë-
ENOMEM
)

1301  
addr
;

1304 
addr
 = 
	`¨ch_gë_unm≠≥d_¨ó_1
 (
PAGE_SIZE
, 
Àn
, 
limô
);

1306  
addr
;

1307 
	}
}

1309 #ifde‡
CONFIG_OSF4_COMPAT


1315 
	$osf_fix_iov_Àn
(c⁄° 
iovec
 
__u£r
 *
iov
, 
cou¡
)

1317 
i
;

1319 
i
 = 0 ; i < 
cou¡
 ; i++) {

1320 
__u£r
 *
iov_Àn_high
 = (__u£∏*)&
iov
[
i
].
iov_Àn
 + 1;

1322 i‡(
	`put_u£r
(0, 
iov_Àn_high
))

1323  -
EFAULT
;

1326 
	}
}

1328 
asmlökage
 
ssize_t


1329 
	$osf_ªadv
(
fd
, c⁄° 
iovec
 
__u£r
 * 
ve˘‹
, 
cou¡
)

1331 i‡(
	`u∆ikñy
(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_OSF4
))

1332 i‡(
	`osf_fix_iov_Àn
(
ve˘‹
, 
cou¡
))

1333  -
EFAULT
;

1334  
	`sys_ªadv
(
fd
, 
ve˘‹
, 
cou¡
);

1335 
	}
}

1337 
asmlökage
 
ssize_t


1338 
	$osf_wrôev
(
fd
, c⁄° 
iovec
 
__u£r
 * 
ve˘‹
, 
cou¡
)

1340 i‡(
	`u∆ikñy
(
	`≥rs⁄Æôy
(
cuºít
->
≥rs⁄Æôy
Ë=
PER_OSF4
))

1341 i‡(
	`osf_fix_iov_Àn
(
ve˘‹
, 
cou¡
))

1342  -
EFAULT
;

1343  
	`sys_wrôev
(
fd
, 
ve˘‹
, 
cou¡
);

1344 
	}
}

	@arch/alpha/kernel/pci-noop.c

7 
	~<löux/pci.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/mm.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/sched.h
>

14 
	~<löux/dma-m≠pög.h
>

16 
	~"¥Ÿo.h
"

23 
pci_c⁄åﬁÀr
 *
	gho£_hód
, **
	gho£_èû
 = &
ho£_hód
;

24 
pci_c⁄åﬁÀr
 *
	gpci_iß_ho£
;

27 
pci_c⁄åﬁÀr
 * 
__öô


28 
	$Æloc_pci_c⁄åﬁÀr
()

30 
pci_c⁄åﬁÀr
 *
ho£
;

32 
ho£
 = 
	`Æloc_boŸmem
((*hose));

34 *
ho£_èû
 = 
ho£
;

35 
ho£_èû
 = &
ho£
->
√xt
;

37  
ho£
;

38 
	}
}

40 
ªsour˚
 * 
__öô


41 
	$Æloc_ªsour˚
()

43 
ªsour˚
 *
ªs
;

45 
ªs
 = 
	`Æloc_boŸmem
((*res));

47  
ªs
;

48 
	}
}

50 
asmlökage
 

51 
	$sys_pcic⁄fig_ioba£
(
which
, 
bus
, 
d‚
)

53 
pci_c⁄åﬁÀr
 *
ho£
;

56 i‡(
which
 & 
IOBASE_FROM_HOSE
) {

57 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

58 i‡(
ho£
->
ödex
 =
bus
)

60 i‡(!
ho£
)

61  -
ENODEV
;

64 i‡(
bus
 =0 && 
d‚
 == 0)

65 
ho£
 = 
pci_iß_ho£
;

67  -
ENODEV
;

70 
which
 & ~
IOBASE_FROM_HOSE
) {

71 
IOBASE_HOSE
:

72  
ho£
->
ödex
;

73 
IOBASE_SPARSE_MEM
:

74  
ho£
->
•¨£_mem_ba£
;

75 
IOBASE_DENSE_MEM
:

76  
ho£
->
dí£_mem_ba£
;

77 
IOBASE_SPARSE_IO
:

78  
ho£
->
•¨£_io_ba£
;

79 
IOBASE_DENSE_IO
:

80  
ho£
->
dí£_io_ba£
;

81 
IOBASE_ROOT_BUS
:

82  
ho£
->
bus
->
numbî
;

85  -
EOPNOTSUPP
;

86 
	}
}

88 
asmlökage
 

89 
	$sys_pcic⁄fig_ªad
(
bus
, 
d‚
,

90 
off
, 
Àn
, *
buf
)

92 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

93  -
EPERM
;

95  -
ENODEV
;

96 
	}
}

98 
asmlökage
 

99 
	$sys_pcic⁄fig_wrôe
(
bus
, 
d‚
,

100 
off
, 
Àn
, *
buf
)

102 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

103  -
EPERM
;

105  -
ENODEV
;

106 
	}
}

111 
	$pci_Æloc_c⁄si°ít
(
pci_dev
 *
pdev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addΩ
)

113  
NULL
;

114 
	}
}

117 
	$pci_‰ì_c⁄si°ít
(
pci_dev
 *
pdev
, 
size_t
 
size
, *
˝u_addr
,

118 
dma_addr_t
 
dma_addr
)

120 
	}
}

122 
dma_addr_t


123 
	$pci_m≠_sögÀ
(
pci_dev
 *
pdev
, *
˝u_addr
, 
size_t
 
size
,

124 
dúe˘i⁄
)

126  (
dma_addr_t
) 0;

127 
	}
}

130 
	$pci_unm≠_sögÀ
(
pci_dev
 *
pdev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

131 
dúe˘i⁄
)

133 
	}
}

136 
	$pci_m≠_sg
(
pci_dev
 *
pdev
, 
sˇâîli°
 *
sg
, 
√¡s
,

137 
dúe˘i⁄
)

140 
	}
}

143 
	$pci_unm≠_sg
(
pci_dev
 *
pdev
, 
sˇâîli°
 *
sg
, 
√¡s
,

144 
dúe˘i⁄
)

146 
	}
}

149 
	$pci_dma_suµ‹ãd
(
pci_dev
 *
hwdev
, 
dma_addr_t
 
mask
)

152 
	}
}

157 
	$dma_Æloc_cohîít
(
devi˚
 *
dev
, 
size_t
 
size
,

158 
dma_addr_t
 *
dma_h™dÀ
, 
gÂ_t
 
gÂ
)

160 *
ªt
;

162 i‡(!
dev
 || *dev->
dma_mask
 >= 0xffffffffUL)

163 
gÂ
 &~
GFP_DMA
;

164 
ªt
 = (*)
	`__gë_‰ì_∑ges
(
gÂ
, 
	`gë_‹dî
(
size
));

165 i‡(
ªt
) {

166 
	`mem£t
(
ªt
, 0, 
size
);

167 *
dma_h™dÀ
 = 
	`vút_to_bus
(
ªt
);

169  
ªt
;

170 
	}
}

172 
EXPORT_SYMBOL
(
dma_Æloc_cohîít
);

175 
	$dma_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

176 
dma_d©a_dúe˘i⁄
 
dúe˘i⁄
)

178 
i
;

180 
i
 = 0; i < 
√¡s
; i++ ) {

181 *
va
;

183 
	`BUG_ON
(!
sg
[
i
].
∑ge
);

184 
va
 = 
	`∑ge_addªss
(
sg
[
i
].
∑ge
Ë+ sg[i].
off£t
;

185 
	`sg_dma_addªss
(
sg
 + 
i
Ë(
dma_addr_t
)
	`vút_to_bus
(
va
);

186 
	`sg_dma_Àn
(
sg
 + 
i
Ësg[i].
Àngth
;

189  
√¡s
;

190 
	}
}

192 
EXPORT_SYMBOL
(
dma_m≠_sg
);

195 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

197 i‡(!
dev
->
dma_mask
 || !
	`dma_suµ‹ãd
(dev, 
mask
))

198  -
EIO
;

200 *
dev
->
dma_mask
 = 
mask
;

203 
	}
}

204 
EXPORT_SYMBOL
(
dma_£t_mask
);

206 
__iomem
 *
	$pci_iom≠
(
pci_dev
 *
dev
, 
b¨
, 
maxÀn
)

208  
NULL
;

209 
	}
}

211 
	$pci_iounm≠
(
pci_dev
 *
dev
, 
__iomem
 * 
addr
)

213 
	}
}

215 
EXPORT_SYMBOL
(
pci_iom≠
);

216 
EXPORT_SYMBOL
(
pci_iounm≠
);

	@arch/alpha/kernel/pci.c

15 
	~<löux/°rög.h
>

16 
	~<löux/pci.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/boŸmem.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/ˇche.h
>

23 
	~<löux/¶ab.h
>

24 
	~<asm/machvec.h
>

26 
	~"¥Ÿo.h
"

27 
	~"pci_im∂.h
"

34 c⁄° *c⁄° 
	gpci_io_«mes
[] = {

39 c⁄° *c⁄° 
	gpci_mem_«mes
[] = {

44 c⁄° 
	gpci_h´0_«me
[] = "HAE0";

51 
	gpci_¥obe_⁄ly
;

57 
pci_c⁄åﬁÀr
 *
	gho£_hód
, **
	gho£_èû
 = &
ho£_hód
;

58 
pci_c⁄åﬁÀr
 *
	gpci_iß_ho£
;

64 
__öô


65 
	$quúk_iß_bridge
(
pci_dev
 *
dev
)

67 
dev
->
˛ass
 = 
PCI_CLASS_BRIDGE_ISA
 << 8;

68 
	}
}

69 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82378
, 
quúk_iß_bridge
);

71 
__öô


72 
	$quúk_cy¥ess
(
pci_dev
 *
dev
)

81 i‡(
dev
->
˛ass
 >> 8 =
PCI_CLASS_STORAGE_IDE
) {

82 
dev
->
ªsour˚
[0].
Êags
 = 0;

83 
dev
->
ªsour˚
[1].
Êags
 = 0;

92 i‡(
dev
->
˛ass
 >> 8 =
PCI_CLASS_BRIDGE_ISA
) {

93 i‡(
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
 >= 0xfff00000UL)

94 
__dúe˘_m≠_size
 = 0xfff00000UL - 
__dúe˘_m≠_ba£
;

96 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

97 
pci_iommu_¨ía
 *
pci
 = 
ho£
->
sg_pci
;

98 i‡(
pci
 &&Öci->
dma_ba£
 +Öci->
size
 >= 0xfff00000UL)

99 
pci
->
size
 = 0xfff00000UL -Öci->
dma_ba£
;

102 
	}
}

103 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_CONTAQ
, 
PCI_DEVICE_ID_CONTAQ_82C693
, 
quúk_cy¥ess
);

106 
__öô


107 
	$pcibios_fixup_föÆ
(
pci_dev
 *
dev
)

109 
˛ass
 = 
dev
->class >> 8;

111 i‡(
˛ass
 =
PCI_CLASS_BRIDGE_ISA
 || cœs†=
PCI_CLASS_BRIDGE_EISA
) {

112 
dev
->
dma_mask
 = 
MAX_ISA_DMA_ADDRESS
 - 1;

113 
iß_bridge
 = 
dev
;

115 
	}
}

116 
DECLARE_PCI_FIXUP_FINAL
(
PCI_ANY_ID
, PCI_ANY_ID, 
pcibios_fixup_föÆ
);

120 
	#KB
 1024

	)

121 
	#MB
 (1024*
KB
)

	)

122 
	#GB
 (1024*
MB
)

	)

125 
	$pcibios_Æign_ªsour˚
(*
d©a
, 
ªsour˚
 *
ªs
,

126 
ªsour˚_size_t
 
size
,Ñesour˚_size_à
Æign
)

128 
pci_dev
 *
dev
 = 
d©a
;

129 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

130 
Æig¡o
;

131 
ªsour˚_size_t
 
°¨t
 = 
ªs
->start;

133 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
) {

135 i‡(
°¨t
 - 
ho£
->
io_•a˚
->°¨à< 
PCIBIOS_MIN_IO
)

136 
°¨t
 = 
PCIBIOS_MIN_IO
 + 
ho£
->
io_•a˚
->start;

141 i‡(
°¨t
 & 0x300)

142 
°¨t
 = (start + 0x3ff) & ~0x3ff;

144 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
) {

146 i‡(
°¨t
 - 
ho£
->
mem_•a˚
->°¨à< 
PCIBIOS_MIN_MEM
)

147 
°¨t
 = 
PCIBIOS_MIN_MEM
 + 
ho£
->
mem_•a˚
->start;

166 
Æig¡o
 = 
	`max
(0x1000UL, 
Æign
);

167 
°¨t
 = 
	`ALIGN
(°¨t, 
Æig¡o
);

168 i‡(
ho£
->
•¨£_mem_ba£
 && 
size
 <7 * 16*
MB
) {

169 i‡(((
°¨t
 / (16*
MB
)) & 0x7) == 0) {

170 
°¨t
 &~(128*
MB
 - 1);

171 
°¨t
 +16*
MB
;

172 
°¨t
 = 
	`ALIGN
(°¨t, 
Æig¡o
);

174 i‡(
°¨t
/(128*
MB
Ë!(°¨à+ 
size
 - 1)/(128*MB)) {

175 
°¨t
 &~(128*
MB
 - 1);

176 
°¨t
 +(128 + 16)*
MB
;

177 
°¨t
 = 
	`ALIGN
(°¨t, 
Æig¡o
);

182 
ªs
->
°¨t
 = start;

183 
	}
}

184 #unde‡
KB


185 #unde‡
MB


186 #unde‡
GB


188 
__öô


189 
	$pcibios_öô
()

191 i‡(
Æpha_mv
.
öô_pci
)

192 
Æpha_mv
.
	`öô_pci
();

194 
	}
}

196 
subsys_öôˇŒ
(
pcibios_öô
);

198 * 
__öô


199 
	$pcibios_£tup
(*
°r
)

201  
°r
;

202 
	}
}

204 #ifde‡
ALPHA_RESTORE_SRM_SETUP


205 
pdev_§m_ßved_c⁄f
 *
	g§m_ßved_c⁄figs
;

207 
__öô


208 
	$pdev_ßve_§m_c⁄fig
(
pci_dev
 *
dev
)

210 
pdev_§m_ßved_c⁄f
 *
tmp
;

211 
¥öãd
 = 0;

213 i‡(!
Æpha_usög_§m
 || 
pci_¥obe_⁄ly
)

216 i‡(!
¥öãd
) {

217 
	`¥ötk
(
KERN_INFO
 "pci:Énabling save/restore of SRM state\n");

218 
¥öãd
 = 1;

221 
tmp
 = 
	`kmÆloc
((*tmp), 
GFP_KERNEL
);

222 i‡(!
tmp
) {

223 
	`¥ötk
(
KERN_ERR
 "%s: kmÆloc(ËÁûed!\n", 
__FUNCTION__
);

226 
tmp
->
√xt
 = 
§m_ßved_c⁄figs
;

227 
tmp
->
dev
 = dev;

229 
	`pci_ßve_°©e
(
dev
);

231 
§m_ßved_c⁄figs
 = 
tmp
;

232 
	}
}

235 
	$pci_ª°‹e_§m_c⁄fig
()

237 
pdev_§m_ßved_c⁄f
 *
tmp
;

240 i‡(
pci_¥obe_⁄ly
)

244 
tmp
 = 
§m_ßved_c⁄figs
;Åmp;Åm∞tmp->
√xt
) {

245 
	`pci_ª°‹e_°©e
(
tmp
->
dev
);

247 
	}
}

250 
__öô


251 
	$pcibios_fixup_ªsour˚
(
ªsour˚
 *
ªs
, ªsour˚ *
roŸ
)

253 
ªs
->
°¨t
 +
roŸ
->start;

254 
ªs
->
íd
 +
roŸ
->
°¨t
;

255 
	}
}

257 
__öô


258 
	$pcibios_fixup_devi˚_ªsour˚s
(
pci_dev
 *
dev
, 
pci_bus
 *
bus
)

261 
pci_c⁄åﬁÀr
 *
ho£
 = (pci_c⁄åﬁÀ∏*)
bus
->
sysd©a
;

262 
i
;

264 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

265 i‡(!
dev
->
ªsour˚
[
i
].
°¨t
)

267 i‡(
dev
->
ªsour˚
[
i
].
Êags
 & 
IORESOURCE_IO
)

268 
	`pcibios_fixup_ªsour˚
(&
dev
->
ªsour˚
[
i
],

269 
ho£
->
io_•a˚
);

270 i‡(
dev
->
ªsour˚
[
i
].
Êags
 & 
IORESOURCE_MEM
)

271 
	`pcibios_fixup_ªsour˚
(&
dev
->
ªsour˚
[
i
],

272 
ho£
->
mem_•a˚
);

274 
	}
}

276 
__öô


277 
	$pcibios_fixup_bus
(
pci_bus
 *
bus
)

281 
pci_c⁄åﬁÀr
 *
ho£
 = 
bus
->
sysd©a
;

282 
pci_dev
 *
dev
 = 
bus
->
£lf
;

284 i‡(!
dev
) {

286 
u32
 
pci_mem_íd
;

287 
u32
 
sg_ba£
 = 
ho£
->
sg_pci
 ? ho£->sg_pci->
dma_ba£
 : ~0;

288 
íd
;

290 
bus
->
ªsour˚
[0] = 
ho£
->
io_•a˚
;

291 
bus
->
ªsour˚
[1] = 
ho£
->
mem_•a˚
;

295 
pci_mem_íd
 = 
	`mö
((
u32
)
__dúe˘_m≠_ba£
, 
sg_ba£
) - 1;

296 
íd
 = 
ho£
->
mem_•a˚
->
°¨t
 + 
pci_mem_íd
;

297 i‡(
ho£
->
mem_•a˚
->
íd
 >Énd)

298 
ho£
->
mem_•a˚
->
íd
 =Énd;

299 } i‡(
pci_¥obe_⁄ly
 &&

300 (
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_BRIDGE_PCI
) {

301 
	`pci_ªad_bridge_ba£s
(
bus
);

302 
	`pcibios_fixup_devi˚_ªsour˚s
(
dev
, 
bus
);

305 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
) {

306 
	`pdev_ßve_§m_c⁄fig
(
dev
);

307 i‡((
dev
->
˛ass
 >> 8Ë!
PCI_CLASS_BRIDGE_PCI
)

308 
	`pcibios_fixup_devi˚_ªsour˚s
(
dev
, 
bus
);

310 
	}
}

312 
__öô


313 
	$pcibios_upd©e_úq
(
pci_dev
 *
dev
, 
úq
)

315 
	`pci_wrôe_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, 
úq
);

316 
	}
}

320 
u8
 
__öô


321 
	$comm⁄_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

323 
u8
 
pö
 = *
pöp
;

325 
dev
->
bus
->
∑ª¡
) {

326 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
));

328 
dev
 = dev->
bus
->
£lf
;

330 *
pöp
 = 
pö
;

333  
	`PCI_SLOT
(
dev
->
dev‚
);

334 
	}
}

336 
__devöô


337 
	$pcibios_ªsour˚_to_bus
(
pci_dev
 *
dev
, 
pci_bus_ªgi⁄
 *
ªgi⁄
,

338 
ªsour˚
 *
ªs
)

340 
pci_c⁄åﬁÀr
 *
ho£
 = (pci_c⁄åﬁÀ∏*)
dev
->
sysd©a
;

341 
off£t
 = 0;

343 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
)

344 
off£t
 = 
ho£
->
io_•a˚
->
°¨t
;

345 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

346 
off£t
 = 
ho£
->
mem_•a˚
->
°¨t
;

348 
ªgi⁄
->
°¨t
 = 
ªs
->°¨à- 
off£t
;

349 
ªgi⁄
->
íd
 = 
ªs
->íd - 
off£t
;

350 
	}
}

352 
	$pcibios_bus_to_ªsour˚
(
pci_dev
 *
dev
, 
ªsour˚
 *
ªs
,

353 
pci_bus_ªgi⁄
 *
ªgi⁄
)

355 
pci_c⁄åﬁÀr
 *
ho£
 = (pci_c⁄åﬁÀ∏*)
dev
->
sysd©a
;

356 
off£t
 = 0;

358 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
)

359 
off£t
 = 
ho£
->
io_•a˚
->
°¨t
;

360 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

361 
off£t
 = 
ho£
->
mem_•a˚
->
°¨t
;

363 
ªs
->
°¨t
 = 
ªgi⁄
->°¨à+ 
off£t
;

364 
ªs
->
íd
 = 
ªgi⁄
->íd + 
off£t
;

365 
	}
}

367 #ifde‡
CONFIG_HOTPLUG


368 
EXPORT_SYMBOL
(
pcibios_ªsour˚_to_bus
);

369 
EXPORT_SYMBOL
(
pcibios_bus_to_ªsour˚
);

373 
	$pcibios_íabÀ_devi˚
(
pci_dev
 *
dev
, 
mask
)

375 
u16
 
cmd
, 
ﬁdcmd
;

376 
i
;

378 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, &
cmd
);

379 
ﬁdcmd
 = 
cmd
;

381 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

382 
ªsour˚
 *
ªs
 = &
dev
->ªsour˚[
i
];

384 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
)

385 
cmd
 |
PCI_COMMAND_IO
;

386 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

387 
cmd
 |
PCI_COMMAND_MEMORY
;

390 i‡(
cmd
 !
ﬁdcmd
) {

391 
	`¥ötk
(
KERN_DEBUG
 "PCI: Enabling device: (%s), cmd %x\n",

392 
	`pci_«me
(
dev
), 
cmd
);

394 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, 
cmd
);

397 
	}
}

405 
	$pcibios_£t_ma°î
(
pci_dev
 *
dev
)

407 
u8
 
œt
;

408 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_LATENCY_TIMER
, &
œt
);

409 i‡(
œt
 >= 16) ;

410 
	`¥ötk
("PCI: SettingÜatencyÅimer of device %sÅo 64\n",

411 
	`pci_«me
(
dev
));

412 
	`pci_wrôe_c⁄fig_byã
(
dev
, 
PCI_LATENCY_TIMER
, 64);

413 
	}
}

415 
__öô


416 
	$pcibios_˛aim_⁄e_bus
(
pci_bus
 *
b
)

418 
pci_dev
 *
dev
;

419 
pci_bus
 *
chûd_bus
;

421 
	`li°_f‹_óch_íåy
(
dev
, &
b
->
devi˚s
, 
bus_li°
) {

422 
i
;

424 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

425 
ªsour˚
 *
r
 = &
dev
->ªsour˚[
i
];

427 i‡(
r
->
∑ª¡
 || !r->
°¨t
 || !r->
Êags
)

429 
	`pci_˛aim_ªsour˚
(
dev
, 
i
);

433 
	`li°_f‹_óch_íåy
(
chûd_bus
, &
b
->
chûdªn
, 
node
)

434 
	`pcibios_˛aim_⁄e_bus
(
chûd_bus
);

435 
	}
}

437 
__öô


438 
	$pcibios_˛aim_c⁄sﬁe_£tup
()

440 
pci_bus
 *
b
;

442 
	`li°_f‹_óch_íåy
(
b
, &
pci_roŸ_bu£s
, 
node
)

443 
	`pcibios_˛aim_⁄e_bus
(
b
);

444 
	}
}

446 
__öô


447 
	$comm⁄_öô_pci
()

449 
pci_c⁄åﬁÀr
 *
ho£
;

450 
pci_bus
 *
bus
;

451 
√xt_bu¢o
;

452 
√ed_domaö_öfo
 = 0;

455 
√xt_bu¢o
 = 0, 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
) {

456 
bus
 = 
	`pci_sˇn_bus
(
√xt_bu¢o
, 
Æpha_mv
.
pci_›s
, 
ho£
);

457 
ho£
->
bus
 = bus;

458 
ho£
->
√ed_domaö_öfo
 =Çeed_domain_info;

459 
√xt_bu¢o
 = 
bus
->
sub‹dö©e
 + 1;

462 i‡(
√xt_bu¢o
 > 224) {

463 
√xt_bu¢o
 = 0;

464 
√ed_domaö_öfo
 = 1;

468 i‡(
pci_¥obe_⁄ly
)

469 
	`pcibios_˛aim_c⁄sﬁe_£tup
();

471 
	`pci_assign_u«ssig√d_ªsour˚s
();

472 
	`pci_fixup_úqs
(
Æpha_mv
.
pci_swizzÀ
,áÕha_mv.
pci_m≠_úq
);

473 
	}
}

476 
pci_c⁄åﬁÀr
 * 
__öô


477 
	$Æloc_pci_c⁄åﬁÀr
()

479 
pci_c⁄åﬁÀr
 *
ho£
;

481 
ho£
 = 
	`Æloc_boŸmem
((*hose));

483 *
ho£_èû
 = 
ho£
;

484 
ho£_èû
 = &
ho£
->
√xt
;

486  
ho£
;

487 
	}
}

489 
ªsour˚
 * 
__öô


490 
	$Æloc_ªsour˚
()

492 
ªsour˚
 *
ªs
;

494 
ªs
 = 
	`Æloc_boŸmem
((*res));

496  
ªs
;

497 
	}
}

503 
asmlökage
 

504 
	$sys_pcic⁄fig_ioba£
(
which
, 
bus
, 
d‚
)

506 
pci_c⁄åﬁÀr
 *
ho£
;

507 
pci_dev
 *
dev
;

510 i‡(
which
 & 
IOBASE_FROM_HOSE
) {

511 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

512 i‡(
ho£
->
ödex
 =
bus
) ;

513 i‡(!
ho£
Ë -
ENODEV
;

516 i‡(
bus
 =0 && 
d‚
 == 0) {

517 
ho£
 = 
pci_iß_ho£
;

519 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(
bus
, 
d‚
);

520 i‡(!
dev
)

521  -
ENODEV
;

522 
ho£
 = 
dev
->
sysd©a
;

523 
	`pci_dev_put
(
dev
);

527 
which
 & ~
IOBASE_FROM_HOSE
) {

528 
IOBASE_HOSE
:

529  
ho£
->
ödex
;

530 
IOBASE_SPARSE_MEM
:

531  
ho£
->
•¨£_mem_ba£
;

532 
IOBASE_DENSE_MEM
:

533  
ho£
->
dí£_mem_ba£
;

534 
IOBASE_SPARSE_IO
:

535  
ho£
->
•¨£_io_ba£
;

536 
IOBASE_DENSE_IO
:

537  
ho£
->
dí£_io_ba£
;

538 
IOBASE_ROOT_BUS
:

539  
ho£
->
bus
->
numbî
;

542  -
EOPNOTSUPP
;

543 
	}
}

548 
__iomem
 *
	$pci_iom≠
(
pci_dev
 *
dev
, 
b¨
, 
maxÀn
)

550 
°¨t
 = 
	`pci_ªsour˚_°¨t
(
dev
, 
b¨
);

551 
Àn
 = 
	`pci_ªsour˚_Àn
(
dev
, 
b¨
);

552 
Êags
 = 
	`pci_ªsour˚_Êags
(
dev
, 
b¨
);

554 i‡(!
Àn
 || !
°¨t
)

555  
NULL
;

556 i‡(
maxÀn
 && 
Àn
 > maxlen)

557 
Àn
 = 
maxÀn
;

558 i‡(
Êags
 & 
IORESOURCE_IO
)

559  
	`i›‹t_m≠
(
°¨t
, 
Àn
);

560 i‡(
Êags
 & 
IORESOURCE_MEM
) {

563  
	`i‹em≠
(
°¨t
, 
Àn
);

565  
NULL
;

566 
	}
}

570 
	$pci_iounm≠
(
pci_dev
 *
dev
, 
__iomem
 * 
addr
)

572 i‡(
	`__is_mmio
(
addr
))

573 
	`iounm≠
(
addr
);

574 
	}
}

576 
EXPORT_SYMBOL
(
pci_iom≠
);

577 
EXPORT_SYMBOL
(
pci_iounm≠
);

580 
pci_dev
 *
	giß_bridge
;

581 
EXPORT_SYMBOL
(
iß_bridge
);

	@arch/alpha/kernel/pci_impl.h

8 
	gpci_dev
;

9 
	gpci_c⁄åﬁÀr
;

10 
	gpci_iommu_¨ía
;

25 
	#EISA_DEFAULT_IO_BASE
 0x9000

	)

26 
	#DEFAULT_IO_BASE
 0x8000

	)

46 
	#XL_DEFAULT_MEM_BASE
 ((16+2)*1024*1024Ë

	)

52 
	#APECS_AND_LCA_DEFAULT_MEM_BASE
 ((16+2)*1024*1024)

	)

60 
	#MCPCIA_DEFAULT_MEM_BASE
 ((32+2)*1024*1024)

	)

61 
	#T2_DEFAULT_MEM_BASE
 ((16+1)*1024*1024)

	)

67 
	#DEFAULT_MEM_BASE
 ((128+16)*1024*1024)

	)

70 
	#CIA_DEFAULT_MEM_BASE
 ((32+2)*1024*1024)

	)

72 
	#IRONGATE_DEFAULT_MEM_BASE
 ((256*8-16)*1024*1024)

	)

74 
	#DEFAULT_AGP_APER_SIZE
 (64*1024*1024)

	)

114 
ölöe
 
u8
 
	$bridge_swizzÀ
(
u8
 
pö
, u8 
¶Ÿ
)

116  (((
pö
-1Ë+ 
¶Ÿ
) % 4) + 1;

117 
	}
}

123 
	#COMMON_TABLE_LOOKUP
 \

124 ({ 
_˘l_
 = -1; \

125 i‡(
¶Ÿ
 >
mö_id£l
 && slŸ <
max_id£l
 && 
pö
 < 
úqs_≥r_¶Ÿ
) \

126 
_˘l_
 = 
úq_èb
[
¶Ÿ
 - 
mö_id£l
][
pö
]; \

127 
_˘l_
; })

	)

137 
	spci_iommu_¨ía


139 
•ölock_t
 
	mlock
;

140 
pci_c⁄åﬁÀr
 *
	mho£
;

141 
	#IOMMU_INVALID_PTE
 0x2

	)

142 
	#IOMMU_RESERVED_PTE
 0xÁ˚

	)

143 *
	m±es
;

144 
dma_addr_t
 
	mdma_ba£
;

145 
	msize
;

146 
	m√xt_íåy
;

147 
	mÆign_íåy
;

150 #i‡
deföed
(
CONFIG_ALPHA_SRM
) && \

151 (
deföed
(
CONFIG_ALPHA_CIA
Ë|| 
	$deföed
(
CONFIG_ALPHA_LCA
))

152 
	#NEED_SRM_SAVE_RESTORE


	)

154 #unde‡
NEED_SRM_SAVE_RESTORE


157 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
NEED_SRM_SAVE_RESTORE
)

158 
	#ALPHA_RESTORE_SRM_SETUP


	)

160 #unde‡
ALPHA_RESTORE_SRM_SETUP


163 #ifde‡
ALPHA_RESTORE_SRM_SETUP


165 
	spdev_§m_ßved_c⁄f


167 
pdev_§m_ßved_c⁄f
 *
√xt
;

168 
pci_dev
 *
dev
;

171 
	`pci_ª°‹e_§m_c⁄fig
();

173 
	#pdev_ßve_§m_c⁄fig
(
dev
Ëdÿ{
	}
} 0)

	)

174 
	#pci_ª°‹e_§m_c⁄fig
(Ëdÿ{} 0)

	)

178 
pci_c⁄åﬁÀr
 *
ho£_hód
, **
ho£_èû
;

179 
pci_c⁄åﬁÀr
 *
pci_iß_ho£
;

182 
pci_¥obe_⁄ly
;

184 
Æpha_agpg¨t_size
;

186 
comm⁄_öô_pci
();

187 
u8
 
comm⁄_swizzÀ
(
pci_dev
 *, u8 *);

188 
pci_c⁄åﬁÀr
 *
Æloc_pci_c⁄åﬁÀr
();

189 
ªsour˚
 *
Æloc_ªsour˚
();

191 
pci_iommu_¨ía
 *
iommu_¨ía_√w_node
(,

192 
pci_c⁄åﬁÀr
 *,

193 
dma_addr_t
, ,

195 
pci_iommu_¨ía
 *
iommu_¨ía_√w
(
pci_c⁄åﬁÀr
 *,

196 
dma_addr_t
, ,

198 c⁄° *c⁄° 
pci_io_«mes
[];

199 c⁄° *c⁄° 
pci_mem_«mes
[];

200 c⁄° 
pci_h´0_«me
[];

202 
size_f‹_mem‹y
(
max
);

204 
iommu_ª£rve
(
pci_iommu_¨ía
 *, , );

205 
iommu_ªÀa£
(
pci_iommu_¨ía
 *, , );

206 
iommu_böd
(
pci_iommu_¨ía
 *, , , *);

207 
iommu_unböd
(
pci_iommu_¨ía
 *, , );

	@arch/alpha/kernel/pci_iommu.c

5 
	~<löux/kî√l.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/pci.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/boŸmem.h
>

10 
	~<löux/log2.h
>

12 
	~<asm/io.h
>

13 
	~<asm/hwΩb.h
>

15 
	~"¥Ÿo.h
"

16 
	~"pci_im∂.h
"

19 
	#DEBUG_ALLOC
 0

	)

20 #i‡
DEBUG_ALLOC
 > 0

21 
	#DBGA
(
¨gs
...Ë
	`¥ötk
(
KERN_DEBUG
árgs)

	)

23 
	#DBGA
(
¨gs
...)

	)

25 #i‡
DEBUG_ALLOC
 > 1

26 
	#DBGA2
(
¨gs
...Ë
	`¥ötk
(
KERN_DEBUG
árgs)

	)

28 
	#DBGA2
(
¨gs
...)

	)

31 
	#DEBUG_NODIRECT
 0

	)

32 
	#DEBUG_FORCEDAC
 0

	)

34 
	#ISA_DMA_MASK
 0x00ffffff

	)

36 
ölöe
 

37 
	$mk_iommu_±e
(
∑ddr
)

39  (
∑ddr
 >> (
PAGE_SHIFT
-1)) | 1;

40 
	}
}

42 
ölöe
 

43 
	$ˇlc_≈ages
(
byãs
)

45  (
byãs
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

46 
	}
}

53 
	$size_f‹_mem‹y
(
max
)

55 
mem
 = 
max_low_p‚
 << 
PAGE_SHIFT
;

56 i‡(
mem
 < 
max
)

57 
max
 = 
	`roundup_pow_of_two
(
mem
);

58  
max
;

59 
	}
}

61 
pci_iommu_¨ía
 *

62 
	$iommu_¨ía_√w_node
(
nid
, 
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
ba£
,

63 
wödow_size
, 
Æign
)

65 
mem_size
;

66 
pci_iommu_¨ía
 *
¨ía
;

68 
mem_size
 = 
wödow_size
 / (
PAGE_SIZE
 / ());

74 i‡(
Æign
 < 
mem_size
)

75 
Æign
 = 
mem_size
;

78 #ifde‡
CONFIG_DISCONTIGMEM


80 i‡(!
	`NODE_DATA
(
nid
) ||

81 (
NULL
 =(
¨ía
 = 
	`Æloc_boŸmem_node
(
	`NODE_DATA
(
nid
),

82 (*
¨ía
))))) {

83 
	`¥ötk
("%s: couldn'tállocateárena fromÇode %d\n"

85 
__FUNCTION__
, 
nid
);

86 
¨ía
 = 
	`Æloc_boŸmem
((*arena));

89 i‡(!
	`NODE_DATA
(
nid
) ||

90 (
NULL
 =(
¨ía
->
±es
 = 
	`__Æloc_boŸmem_node
(
	`NODE_DATA
(
nid
),

91 
mem_size
,

92 
Æign
,

94 
	`¥ötk
("%s: couldn'tállocateárenaÖtes fromÇode %d\n"

96 
__FUNCTION__
, 
nid
);

97 
¨ía
->
±es
 = 
	`__Æloc_boŸmem
(
mem_size
, 
Æign
, 0);

102 
¨ía
 = 
	`Æloc_boŸmem
((*arena));

103 
¨ía
->
±es
 = 
	`__Æloc_boŸmem
(
mem_size
, 
Æign
, 0);

107 
	`•ö_lock_öô
(&
¨ía
->
lock
);

108 
¨ía
->
ho£
 = hose;

109 
¨ía
->
dma_ba£
 = 
ba£
;

110 
¨ía
->
size
 = 
wödow_size
;

111 
¨ía
->
√xt_íåy
 = 0;

115 
¨ía
->
Æign_íåy
 = 1;

117  
¨ía
;

118 
	}
}

120 
pci_iommu_¨ía
 *

121 
	$iommu_¨ía_√w
(
pci_c⁄åﬁÀr
 *
ho£
, 
dma_addr_t
 
ba£
,

122 
wödow_size
, 
Æign
)

124  
	`iommu_¨ía_√w_node
(0, 
ho£
, 
ba£
, 
wödow_size
, 
Æign
);

125 
	}
}

129 
	$iommu_¨ía_föd_∑ges
(
pci_iommu_¨ía
 *
¨ía
, 
n
, 
mask
)

131 *
±es
;

132 
i
, 
p
, 
√¡
;

135 
±es
 = 
¨ía
->ptes;

136 
√¡
 = 
¨ía
->
size
 >> 
PAGE_SHIFT
;

137 
p
 = (
¨ía
->
√xt_íåy
 + 
mask
) & ~mask;

138 
i
 = 0;

139 
i
 < 
n
 && 
p
+ò< 
√¡
) {

140 i‡(
±es
[
p
+
i
])

141 
p
 = (∞+ 
i
 + 1 + 
mask
) & ~mask, i = 0;

143 
i
 = i + 1;

146 i‡(
i
 < 
n
) {

149 
Æpha_mv
.
	`mv_pci_tbi
(
¨ía
->
ho£
, 0, -1);

151 
p
 = 0, 
i
 = 0;

152 
i
 < 
n
 && 
p
+ò< 
√¡
) {

153 i‡(
±es
[
p
+
i
])

154 
p
 = (∞+ 
i
 + 1 + 
mask
) & ~mask, i = 0;

156 
i
 = i + 1;

159 i‡(
i
 < 
n
)

165  
p
;

166 
	}
}

169 
	$iommu_¨ía_Æloc
(
pci_iommu_¨ía
 *
¨ía
, 
n
, 
Æign
)

171 
Êags
;

172 *
±es
;

173 
i
, 
p
, 
mask
;

175 
	`•ö_lock_úqßve
(&
¨ía
->
lock
, 
Êags
);

178 
±es
 = 
¨ía
->ptes;

179 
mask
 = 
	`max
(
Æign
, 
¨ía
->
Æign_íåy
) - 1;

180 
p
 = 
	`iommu_¨ía_föd_∑ges
(
¨ía
, 
n
, 
mask
);

181 i‡(
p
 < 0) {

182 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

190 
i
 = 0; i < 
n
; ++i)

191 
±es
[
p
+
i
] = 
IOMMU_INVALID_PTE
;

193 
¨ía
->
√xt_íåy
 = 
p
 + 
n
;

194 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

196  
p
;

197 
	}
}

200 
	$iommu_¨ía_‰ì
(
pci_iommu_¨ía
 *
¨ía
, 
ofs
, 
n
)

202 *
p
;

203 
i
;

205 
p
 = 
¨ía
->
±es
 + 
ofs
;

206 
i
 = 0; i < 
n
; ++i)

207 
p
[
i
] = 0;

208 
	}
}

215 
dma_addr_t


216 
	$pci_m≠_sögÀ_1
(
pci_dev
 *
pdev
, *
˝u_addr
, 
size_t
 
size
,

217 
dac_Ælowed
)

219 
pci_c⁄åﬁÀr
 *
ho£
 = 
pdev
 ?Ödev->
sysd©a
 : 
pci_iß_ho£
;

220 
dma_addr_t
 
max_dma
 = 
pdev
 ?Ödev->
dma_mask
 : 
ISA_DMA_MASK
;

221 
pci_iommu_¨ía
 *
¨ía
;

222 
≈ages
, 
dma_ofs
, 
i
;

223 
∑ddr
;

224 
dma_addr_t
 
ªt
;

225 
Æign
 = 0;

227 
∑ddr
 = 
	`__∑
(
˝u_addr
);

229 #i‡!
DEBUG_NODIRECT


231 i‡(
∑ddr
 + 
size
 + 
__dúe˘_m≠_ba£
 - 1 <
max_dma


232 && 
∑ddr
 + 
size
 <
__dúe˘_m≠_size
) {

233 
ªt
 = 
∑ddr
 + 
__dúe˘_m≠_ba£
;

235 
	`DBGA2
("pci_map_single: [%p,%lx] -> direct %lx from %p\n",

236 
˝u_addr
, 
size
, 
ªt
, 
	`__buûtö_ªtu∫_addªss
(0));

238  
ªt
;

243 i‡(
dac_Ælowed
) {

244 
ªt
 = 
∑ddr
 + 
Æpha_mv
.
pci_dac_off£t
;

246 
	`DBGA2
("pci_map_single: [%p,%lx] -> DAC %lx from %p\n",

247 
˝u_addr
, 
size
, 
ªt
, 
	`__buûtö_ªtu∫_addªss
(0));

249  
ªt
;

255 i‡(! 
Æpha_mv
.
mv_pci_tbi
) {

256 
bìn_hîe
 = 0;

257 i‡(!
bìn_hîe
) {

258 
	`¥ötk
(
KERN_WARNING
 "pci_map_single:Ço HW sg\n");

259 
bìn_hîe
 = 1;

264 
¨ía
 = 
ho£
->
sg_pci
;

265 i‡(!
¨ía
 ||áª«->
dma_ba£
 +áª«->
size
 - 1 > 
max_dma
)

266 
¨ía
 = 
ho£
->
sg_iß
;

268 
≈ages
 = 
	`ˇlc_≈ages
((
∑ddr
 & ~
PAGE_MASK
Ë+ 
size
);

271 i‡(
pdev
 &&Ödev =
iß_bridge
)

272 
Æign
 = 8;

273 
dma_ofs
 = 
	`iommu_¨ía_Æloc
(
¨ía
, 
≈ages
, 
Æign
);

274 i‡(
dma_ofs
 < 0) {

275 
	`¥ötk
(
KERN_WARNING
 "pci_map_single failed: "

280 
∑ddr
 &
PAGE_MASK
;

281 
i
 = 0; i < 
≈ages
; ++i, 
∑ddr
 +
PAGE_SIZE
)

282 
¨ía
->
±es
[
i
 + 
dma_ofs
] = 
	`mk_iommu_±e
(
∑ddr
);

284 
ªt
 = 
¨ía
->
dma_ba£
 + 
dma_ofs
 * 
PAGE_SIZE
;

285 
ªt
 +()
˝u_addr
 & ~
PAGE_MASK
;

287 
	`DBGA2
("pci_map_single: [%p,%lx]Çp %ld -> sg %lx from %p\n",

288 
˝u_addr
, 
size
, 
≈ages
, 
ªt
, 
	`__buûtö_ªtu∫_addªss
(0));

290  
ªt
;

291 
	}
}

293 
dma_addr_t


294 
	$pci_m≠_sögÀ
(
pci_dev
 *
pdev
, *
˝u_addr
, 
size_t
 
size
, 
dú
)

296 
dac_Ælowed
;

298 i‡(
dú
 =
PCI_DMA_NONE
)

299 
	`BUG
();

301 
dac_Ælowed
 = 
pdev
 ? 
	`pci_dac_dma_suµ‹ãd
’dev,Ödev->
dma_mask
) : 0;

302  
	`pci_m≠_sögÀ_1
(
pdev
, 
˝u_addr
, 
size
, 
dac_Ælowed
);

303 
	}
}

304 
EXPORT_SYMBOL
(
pci_m≠_sögÀ
);

306 
dma_addr_t


307 
	$pci_m≠_∑ge
(
pci_dev
 *
pdev
, 
∑ge
 *∑ge, 
off£t
,

308 
size_t
 
size
, 
dú
)

310 
dac_Ælowed
;

312 i‡(
dú
 =
PCI_DMA_NONE
)

313 
	`BUG
();

315 
dac_Ælowed
 = 
pdev
 ? 
	`pci_dac_dma_suµ‹ãd
’dev,Ödev->
dma_mask
) : 0;

316  
	`pci_m≠_sögÀ_1
(
pdev
, (*)
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
,

317 
size
, 
dac_Ælowed
);

318 
	}
}

319 
EXPORT_SYMBOL
(
pci_m≠_∑ge
);

328 
	$pci_unm≠_sögÀ
(
pci_dev
 *
pdev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

329 
dúe˘i⁄
)

331 
Êags
;

332 
pci_c⁄åﬁÀr
 *
ho£
 = 
pdev
 ?Ödev->
sysd©a
 : 
pci_iß_ho£
;

333 
pci_iommu_¨ía
 *
¨ía
;

334 
dma_ofs
, 
≈ages
;

336 i‡(
dúe˘i⁄
 =
PCI_DMA_NONE
)

337 
	`BUG
();

339 i‡(
dma_addr
 >
__dúe˘_m≠_ba£


340 && 
dma_addr
 < 
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
) {

343 
	`DBGA2
("pci_unmap_single: direct [%lx,%lx] from %p\n",

344 
dma_addr
, 
size
, 
	`__buûtö_ªtu∫_addªss
(0));

349 i‡(
dma_addr
 > 0xffffffff) {

350 
	`DBGA2
("pci64_unmap_single: DAC [%lx,%lx] from %p\n",

351 
dma_addr
, 
size
, 
	`__buûtö_ªtu∫_addªss
(0));

355 
¨ía
 = 
ho£
->
sg_pci
;

356 i‡(!
¨ía
 || 
dma_addr
 <áª«->
dma_ba£
)

357 
¨ía
 = 
ho£
->
sg_iß
;

359 
dma_ofs
 = (
dma_addr
 - 
¨ía
->
dma_ba£
Ë>> 
PAGE_SHIFT
;

360 i‡(
dma_ofs
 * 
PAGE_SIZE
 >
¨ía
->
size
) {

361 
	`¥ötk
(
KERN_ERR
 "BogusÖci_unmap_single: dma_addr %lx "

362 " ba£ %lx sizê%x\n", 
dma_addr
, 
¨ía
->
dma_ba£
,

363 
¨ía
->
size
);

365 
	`BUG
();

368 
≈ages
 = 
	`ˇlc_≈ages
((
dma_addr
 & ~
PAGE_MASK
Ë+ 
size
);

370 
	`•ö_lock_úqßve
(&
¨ía
->
lock
, 
Êags
);

372 
	`iommu_¨ía_‰ì
(
¨ía
, 
dma_ofs
, 
≈ages
);

377 i‡(
dma_ofs
 >
¨ía
->
√xt_íåy
)

378 
Æpha_mv
.
	`mv_pci_tbi
(
ho£
, 
dma_addr
, dma_add∏+ 
size
 - 1);

380 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

382 
	`DBGA2
("pci_unmap_single: sg [%lx,%lx]Çp %ld from %p\n",

383 
dma_addr
, 
size
, 
≈ages
, 
	`__buûtö_ªtu∫_addªss
(0));

384 
	}
}

385 
EXPORT_SYMBOL
(
pci_unm≠_sögÀ
);

388 
	$pci_unm≠_∑ge
(
pci_dev
 *
pdev
, 
dma_addr_t
 
dma_addr
,

389 
size_t
 
size
, 
dúe˘i⁄
)

391 
	`pci_unm≠_sögÀ
(
pdev
, 
dma_addr
, 
size
, 
dúe˘i⁄
);

392 
	}
}

393 
EXPORT_SYMBOL
(
pci_unm≠_∑ge
);

401 
	$pci_Æloc_c⁄si°ít
(
pci_dev
 *
pdev
, 
size_t
 
size
, 
dma_addr_t
 *
dma_addΩ
)

403 *
˝u_addr
;

404 
‹dî
 = 
	`gë_‹dî
(
size
);

405 
gÂ_t
 
gÂ
 = 
GFP_ATOMIC
;

407 
åy_agaö
:

408 
˝u_addr
 = (*)
	`__gë_‰ì_∑ges
(
gÂ
, 
‹dî
);

409 i‡(! 
˝u_addr
) {

410 
	`¥ötk
(
KERN_INFO
 "pci_alloc_consistent: "

412 
	`__buûtö_ªtu∫_addªss
(0));

415  
NULL
;

417 
	`mem£t
(
˝u_addr
, 0, 
size
);

419 *
dma_addΩ
 = 
	`pci_m≠_sögÀ_1
(
pdev
, 
˝u_addr
, 
size
, 0);

420 i‡(*
dma_addΩ
 == 0) {

421 
	`‰ì_∑ges
(()
˝u_addr
, 
‹dî
);

422 i‡(
Æpha_mv
.
mv_pci_tbi
 || (
gÂ
 & 
GFP_DMA
))

423  
NULL
;

426 
gÂ
 |
GFP_DMA
;

427 
åy_agaö
;

430 
	`DBGA2
("pci_alloc_consistent: %lx -> [%p,%x] from %p\n",

431 
size
, 
˝u_addr
, *
dma_addΩ
, 
	`__buûtö_ªtu∫_addªss
(0));

433  
˝u_addr
;

434 
	}
}

435 
EXPORT_SYMBOL
(
pci_Æloc_c⁄si°ít
);

444 
	$pci_‰ì_c⁄si°ít
(
pci_dev
 *
pdev
, 
size_t
 
size
, *
˝u_addr
,

445 
dma_addr_t
 
dma_addr
)

447 
	`pci_unm≠_sögÀ
(
pdev
, 
dma_addr
, 
size
, 
PCI_DMA_BIDIRECTIONAL
);

448 
	`‰ì_∑ges
(()
˝u_addr
, 
	`gë_‹dî
(
size
));

450 
	`DBGA2
("pci_free_consistent: [%x,%lx] from %p\n",

451 
dma_addr
, 
size
, 
	`__buûtö_ªtu∫_addªss
(0));

452 
	}
}

453 
EXPORT_SYMBOL
(
pci_‰ì_c⁄si°ít
);

464 
	#SG_ENT_VIRT_ADDRESS
(
SG
Ë(
	`∑ge_addªss
((SG)->
∑ge
Ë+ (SG)->
off£t
)

	)

465 
	#SG_ENT_PHYS_ADDRESS
(
SG
Ë
	`__∑
(
	`SG_ENT_VIRT_ADDRESS
(SG))

	)

468 
	$sg_˛assify
(
sˇâîli°
 *
sg
, sˇâîli° *
íd
, 
vút_ok
)

470 
√xt_∑ddr
;

471 
sˇâîli°
 *
Àadî
;

472 
Àadî_Êag
, 
Àadî_Àngth
;

474 
Àadî
 = 
sg
;

475 
Àadî_Êag
 = 0;

476 
Àadî_Àngth
 = 
Àadî
->
Àngth
;

477 
√xt_∑ddr
 = 
	`SG_ENT_PHYS_ADDRESS
(
Àadî
Ë+ 
Àadî_Àngth
;

479 ++
sg
; sg < 
íd
; ++sg) {

480 
addr
, 
Àn
;

481 
addr
 = 
	`SG_ENT_PHYS_ADDRESS
(
sg
);

482 
Àn
 = 
sg
->
Àngth
;

484 i‡(
√xt_∑ddr
 =
addr
) {

485 
sg
->
dma_addªss
 = -1;

486 
Àadî_Àngth
 +
Àn
;

487 } i‡(((
√xt_∑ddr
 | 
addr
Ë& ~
PAGE_MASK
Ë=0 && 
vút_ok
) {

488 
sg
->
dma_addªss
 = -2;

489 
Àadî_Êag
 = 1;

490 
Àadî_Àngth
 +
Àn
;

492 
Àadî
->
dma_addªss
 = 
Àadî_Êag
;

493 
Àadî
->
dma_Àngth
 = 
Àadî_Àngth
;

494 
Àadî
 = 
sg
;

495 
Àadî_Êag
 = 0;

496 
Àadî_Àngth
 = 
Àn
;

499 
√xt_∑ddr
 = 
addr
 + 
Àn
;

502 
Àadî
->
dma_addªss
 = 
Àadî_Êag
;

503 
Àadî
->
dma_Àngth
 = 
Àadî_Àngth
;

504 
	}
}

510 
	$sg_fûl
(
sˇâîli°
 *
Àadî
, sˇâîli° *
íd
,

511 
sˇâîli°
 *
out
, 
pci_iommu_¨ía
 *
¨ía
,

512 
dma_addr_t
 
max_dma
, 
dac_Ælowed
)

514 
∑ddr
 = 
	`SG_ENT_PHYS_ADDRESS
(
Àadî
);

515 
size
 = 
Àadî
->
dma_Àngth
;

516 
sˇâîli°
 *
sg
;

517 *
±es
;

518 
≈ages
, 
dma_ofs
, 
i
;

520 #i‡!
DEBUG_NODIRECT


523 i‡(
Àadî
->
dma_addªss
 == 0

524 && 
∑ddr
 + 
size
 + 
__dúe˘_m≠_ba£
 - 1 <
max_dma


525 && 
∑ddr
 + 
size
 <
__dúe˘_m≠_size
) {

526 
out
->
dma_addªss
 = 
∑ddr
 + 
__dúe˘_m≠_ba£
;

527 
out
->
dma_Àngth
 = 
size
;

529 
	`DBGA
(" sg_fill: [%p,%lx] -> direct %lx\n",

530 
	`__va
(
∑ddr
), 
size
, 
out
->
dma_addªss
);

537 i‡(
Àadî
->
dma_addªss
 =0 && 
dac_Ælowed
) {

538 
out
->
dma_addªss
 = 
∑ddr
 + 
Æpha_mv
.
pci_dac_off£t
;

539 
out
->
dma_Àngth
 = 
size
;

541 
	`DBGA
(" sg_fill: [%p,%lx] -> DAC %lx\n",

542 
	`__va
(
∑ddr
), 
size
, 
out
->
dma_addªss
);

550 
∑ddr
 &~
PAGE_MASK
;

551 
≈ages
 = 
	`ˇlc_≈ages
(
∑ddr
 + 
size
);

552 
dma_ofs
 = 
	`iommu_¨ía_Æloc
(
¨ía
, 
≈ages
, 0);

553 i‡(
dma_ofs
 < 0) {

555 i‡(
Àadî
->
dma_addªss
 == 0)

560 
	`sg_˛assify
(
Àadî
, 
íd
, 0);

561  
	`sg_fûl
(
Àadî
, 
íd
, 
out
, 
¨ía
, 
max_dma
, 
dac_Ælowed
);

564 
out
->
dma_addªss
 = 
¨ía
->
dma_ba£
 + 
dma_ofs
*
PAGE_SIZE
 + 
∑ddr
;

565 
out
->
dma_Àngth
 = 
size
;

567 
	`DBGA
(" sg_fill: [%p,%lx] -> sg %lxÇp %ld\n",

568 
	`__va
(
∑ddr
), 
size
, 
out
->
dma_addªss
, 
≈ages
);

572 
±es
 = &
¨ía
->±es[
dma_ofs
];

573 
sg
 = 
Àadî
;

575 #i‡
DEBUG_ALLOC
 > 0

576 
sˇâîli°
 *
œ°_sg
 = 
sg
;

579 
size
 = 
sg
->
Àngth
;

580 
∑ddr
 = 
	`SG_ENT_PHYS_ADDRESS
(
sg
);

582 
sg
+1 < 
íd
 && (Ësg[1].
dma_addªss
 == -1) {

583 
size
 +
sg
[1].
Àngth
;

584 
sg
++;

587 
≈ages
 = 
	`ˇlc_≈ages
((
∑ddr
 & ~
PAGE_MASK
Ë+ 
size
);

589 
∑ddr
 &
PAGE_MASK
;

590 
i
 = 0; i < 
≈ages
; ++i, 
∑ddr
 +
PAGE_SIZE
)

591 *
±es
++ = 
	`mk_iommu_±e
(
∑ddr
);

593 #i‡
DEBUG_ALLOC
 > 0

594 
	`DBGA
(" (%ld) [%p,%x]Çp %ld\n",

595 
œ°_sg
 - 
Àadî
, 
	`SG_ENT_VIRT_ADDRESS
(last_sg),

596 
œ°_sg
->
Àngth
, 
≈ages
);

597 ++
œ°_sg
 <
sg
) {

598 
	`DBGA
(" (%ld) [%p,%x] cont\n",

599 
œ°_sg
 - 
Àadî
, 
	`SG_ENT_VIRT_ADDRESS
(last_sg),

600 
œ°_sg
->
Àngth
);

603 } ++
sg
 < 
íd
 && (Ësg->
dma_addªss
 < 0);

606 
	}
}

609 
	$pci_m≠_sg
(
pci_dev
 *
pdev
, 
sˇâîli°
 *
sg
, 
√¡s
,

610 
dúe˘i⁄
)

612 
sˇâîli°
 *
°¨t
, *
íd
, *
out
;

613 
pci_c⁄åﬁÀr
 *
ho£
;

614 
pci_iommu_¨ía
 *
¨ía
;

615 
dma_addr_t
 
max_dma
;

616 
dac_Ælowed
;

618 i‡(
dúe˘i⁄
 =
PCI_DMA_NONE
)

619 
	`BUG
();

621 
dac_Ælowed
 = 
pdev
 ? 
	`pci_dac_dma_suµ‹ãd
’dev,Ödev->
dma_mask
) : 0;

624 i‡(
√¡s
 == 1) {

625 
sg
->
dma_Àngth
 = sg->
Àngth
;

626 
sg
->
dma_addªss


627 
	`pci_m≠_sögÀ_1
(
pdev
, 
	`SG_ENT_VIRT_ADDRESS
(
sg
),

628 
sg
->
Àngth
, 
dac_Ælowed
);

629  
sg
->
dma_addªss
 != 0;

632 
°¨t
 = 
sg
;

633 
íd
 = 
sg
 + 
√¡s
;

636 
	`sg_˛assify
(
sg
, 
íd
, 
Æpha_mv
.
mv_pci_tbi
 != 0);

639 i‡(
Æpha_mv
.
mv_pci_tbi
) {

640 
ho£
 = 
pdev
 ?Ödev->
sysd©a
 : 
pci_iß_ho£
;

641 
max_dma
 = 
pdev
 ?Ödev->
dma_mask
 : 
ISA_DMA_MASK
;

642 
¨ía
 = 
ho£
->
sg_pci
;

643 i‡(!
¨ía
 ||áª«->
dma_ba£
 +áª«->
size
 - 1 > 
max_dma
)

644 
¨ía
 = 
ho£
->
sg_iß
;

646 
max_dma
 = -1;

647 
¨ía
 = 
NULL
;

648 
ho£
 = 
NULL
;

653 
out
 = 
sg
; sg < 
íd
; ++sg) {

654 i‡((Ë
sg
->
dma_addªss
 < 0)

656 i‡(
	`sg_fûl
(
sg
, 
íd
, 
out
, 
¨ía
, 
max_dma
, 
dac_Ælowed
) < 0)

657 
îr‹
;

658 
out
++;

662 i‡(
out
 < 
íd
)

663 
out
->
dma_Àngth
 = 0;

665 i‡(
out
 - 
°¨t
 == 0)

666 
	`¥ötk
(
KERN_WARNING
 "pci_map_sg failed:ÇoÉntries?\n");

667 
	`DBGA
("pci_m≠_sg: %ldÉ¡rõs\n", 
out
 - 
°¨t
);

669  
out
 - 
°¨t
;

671 
îr‹
:

672 
	`¥ötk
(
KERN_WARNING
 "pci_map_sg failed: "

677 i‡(
out
 > 
°¨t
)

678 
	`pci_unm≠_sg
(
pdev
, 
°¨t
, 
out
 - sèπ, 
dúe˘i⁄
);

680 
	}
}

681 
EXPORT_SYMBOL
(
pci_m≠_sg
);

688 
	$pci_unm≠_sg
(
pci_dev
 *
pdev
, 
sˇâîli°
 *
sg
, 
√¡s
,

689 
dúe˘i⁄
)

691 
Êags
;

692 
pci_c⁄åﬁÀr
 *
ho£
;

693 
pci_iommu_¨ía
 *
¨ía
;

694 
sˇâîli°
 *
íd
;

695 
dma_addr_t
 
max_dma
;

696 
dma_addr_t
 
fbeg
, 
„nd
;

698 i‡(
dúe˘i⁄
 =
PCI_DMA_NONE
)

699 
	`BUG
();

701 i‡(! 
Æpha_mv
.
mv_pci_tbi
)

704 
ho£
 = 
pdev
 ?Ödev->
sysd©a
 : 
pci_iß_ho£
;

705 
max_dma
 = 
pdev
 ?Ödev->
dma_mask
 : 
ISA_DMA_MASK
;

706 
¨ía
 = 
ho£
->
sg_pci
;

707 i‡(!
¨ía
 ||áª«->
dma_ba£
 +áª«->
size
 - 1 > 
max_dma
)

708 
¨ía
 = 
ho£
->
sg_iß
;

710 
fbeg
 = -1, 
„nd
 = 0;

712 
	`•ö_lock_úqßve
(&
¨ía
->
lock
, 
Êags
);

714 
íd
 = 
sg
 + 
√¡s
; sg <Énd; ++sg) {

715 
dma64_addr_t
 
addr
;

716 
size_t
 
size
;

717 
≈ages
, 
ofs
;

718 
dma_addr_t
 
ãnd
;

720 
addr
 = 
sg
->
dma_addªss
;

721 
size
 = 
sg
->
dma_Àngth
;

722 i‡(!
size
)

725 i‡(
addr
 > 0xffffffff) {

727 
	`DBGA
(" (%ld) DAC [%lx,%lx]\n",

728 
sg
 - 
íd
 + 
√¡s
, 
addr
, 
size
);

732 i‡(
addr
 >
__dúe˘_m≠_ba£


733 && 
addr
 < 
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
) {

735 
	`DBGA
(" (%ld) direct [%lx,%lx]\n",

736 
sg
 - 
íd
 + 
√¡s
, 
addr
, 
size
);

740 
	`DBGA
(" (%ld) sg [%lx,%lx]\n",

741 
sg
 - 
íd
 + 
√¡s
, 
addr
, 
size
);

743 
≈ages
 = 
	`ˇlc_≈ages
((
addr
 & ~
PAGE_MASK
Ë+ 
size
);

744 
ofs
 = (
addr
 - 
¨ía
->
dma_ba£
Ë>> 
PAGE_SHIFT
;

745 
	`iommu_¨ía_‰ì
(
¨ía
, 
ofs
, 
≈ages
);

747 
ãnd
 = 
addr
 + 
size
 - 1;

748 i‡(
fbeg
 > 
addr
) fbeg =áddr;

749 i‡(
„nd
 < 
ãnd
) fend =Åend;

755 i‡((
„nd
 - 
¨ía
->
dma_ba£
Ë>> 
PAGE_SHIFT
 >¨ía->
√xt_íåy
)

756 
Æpha_mv
.
	`mv_pci_tbi
(
ho£
, 
fbeg
, 
„nd
);

758 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

760 
	`DBGA
("pci_unm≠_sg: %ldÉ¡rõs\n", 
√¡s
 - (
íd
 - 
sg
));

761 
	}
}

762 
EXPORT_SYMBOL
(
pci_unm≠_sg
);

769 
	$pci_dma_suµ‹ãd
(
pci_dev
 *
pdev
, 
u64
 
mask
)

771 
pci_c⁄åﬁÀr
 *
ho£
;

772 
pci_iommu_¨ía
 *
¨ía
;

777 i‡(
__dúe˘_m≠_size
 != 0

778 && (
__dúe˘_m≠_ba£
 + 
__dúe˘_m≠_size
 - 1 <
mask
 ||

779 
__dúe˘_m≠_ba£
 + (
max_low_p‚
 << 
PAGE_SHIFT
Ë- 1 <
mask
))

783 
ho£
 = 
pdev
 ?Ödev->
sysd©a
 : 
pci_iß_ho£
;

784 
¨ía
 = 
ho£
->
sg_iß
;

785 i‡(
¨ía
 &&áª«->
dma_ba£
 +áª«->
size
 - 1 <
mask
)

787 
¨ía
 = 
ho£
->
sg_pci
;

788 i‡(
¨ía
 &&áª«->
dma_ba£
 +áª«->
size
 - 1 <
mask
)

792 i‡(!
__dúe˘_m≠_ba£
 && 
MAX_DMA_ADDRESS
 - 
IDENT_ADDR
 - 1 <
mask
)

796 
	}
}

797 
EXPORT_SYMBOL
(
pci_dma_suµ‹ãd
);

804 
	$iommu_ª£rve
(
pci_iommu_¨ía
 *
¨ía
, 
pg_cou¡
, 
Æign_mask
)

806 
Êags
;

807 *
±es
;

808 
i
, 
p
;

810 i‡(!
¨ía
Ë -
EINVAL
;

812 
	`•ö_lock_úqßve
(&
¨ía
->
lock
, 
Êags
);

815 
±es
 = 
¨ía
->ptes;

816 
p
 = 
	`iommu_¨ía_föd_∑ges
(
¨ía
, 
pg_cou¡
, 
Æign_mask
);

817 i‡(
p
 < 0) {

818 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

825 
i
 = 0; i < 
pg_cou¡
; ++i)

826 
±es
[
p
+
i
] = 
IOMMU_RESERVED_PTE
;

828 
¨ía
->
√xt_íåy
 = 
p
 + 
pg_cou¡
;

829 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

831  
p
;

832 
	}
}

835 
	$iommu_ªÀa£
(
pci_iommu_¨ía
 *
¨ía
, 
pg_°¨t
, 
pg_cou¡
)

837 *
±es
;

838 
i
;

840 i‡(!
¨ía
Ë -
EINVAL
;

842 
±es
 = 
¨ía
->ptes;

845 
i
 = 
pg_°¨t
; i <Ög_°¨à+ 
pg_cou¡
; i++)

846 i‡(
±es
[
i
] !
IOMMU_RESERVED_PTE
)

847  -
EBUSY
;

849 
	`iommu_¨ía_‰ì
(
¨ía
, 
pg_°¨t
, 
pg_cou¡
);

851 
	}
}

854 
	$iommu_böd
(
pci_iommu_¨ía
 *
¨ía
, 
pg_°¨t
, 
pg_cou¡
,

855 *
phyßddrs
)

857 
Êags
;

858 *
±es
;

859 
i
, 
j
;

861 i‡(!
¨ía
Ë -
EINVAL
;

863 
	`•ö_lock_úqßve
(&
¨ía
->
lock
, 
Êags
);

865 
±es
 = 
¨ía
->ptes;

867 
j
 = 
pg_°¨t
; j <Ög_°¨à+ 
pg_cou¡
; j++) {

868 i‡(
±es
[
j
] !
IOMMU_RESERVED_PTE
) {

869 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

870  -
EBUSY
;

874 
i
 = 0, 
j
 = 
pg_°¨t
; i < 
pg_cou¡
; i++, j++)

875 
±es
[
j
] = 
	`mk_iommu_±e
(
phyßddrs
[
i
]);

877 
	`•ö_u∆ock_úqª°‹e
(&
¨ía
->
lock
, 
Êags
);

880 
	}
}

883 
	$iommu_unböd
(
pci_iommu_¨ía
 *
¨ía
, 
pg_°¨t
, 
pg_cou¡
)

885 *
p
;

886 
i
;

888 i‡(!
¨ía
Ë -
EINVAL
;

890 
p
 = 
¨ía
->
±es
 + 
pg_°¨t
;

891 
i
 = 0; i < 
pg_cou¡
; i++)

892 
p
[
i
] = 
IOMMU_RESERVED_PTE
;

895 
	}
}

901 
	$pci_dac_dma_suµ‹ãd
(
pci_dev
 *
dev
, 
u64
 
mask
)

903 
dma64_addr_t
 
dac_off£t
 = 
Æpha_mv
.
pci_dac_off£t
;

904 
ok
 = 1;

907 i‡(
dac_off£t
 == 0)

908 
ok
 = 0;

911 i‡((
dac_off£t
 & 
dev
->
dma_mask
) != dac_offset)

912 
ok
 = 0;

915 
	`DBGA
("pci_dac_dma_supported %s from %p\n",

916 
ok
 ? "yes" : "no", 
	`__buûtö_ªtu∫_addªss
(0));

918  
ok
;

919 
	}
}

920 
EXPORT_SYMBOL
(
pci_dac_dma_suµ‹ãd
);

922 
dma64_addr_t


923 
	$pci_dac_∑ge_to_dma
(
pci_dev
 *
pdev
, 
∑ge
 *page,

924 
off£t
, 
dúe˘i⁄
)

926  (
Æpha_mv
.
pci_dac_off£t


927 + 
	`__∑
(
	`∑ge_addªss
(
∑ge
))

928 + (
dma64_addr_t
Ë
off£t
);

929 
	}
}

930 
EXPORT_SYMBOL
(
pci_dac_∑ge_to_dma
);

932 
∑ge
 *

933 
	$pci_dac_dma_to_∑ge
(
pci_dev
 *
pdev
, 
dma64_addr_t
 
dma_addr
)

935 
∑ddr
 = (
dma_addr
 & 
PAGE_MASK
Ë- 
Æpha_mv
.
pci_dac_off£t
;

936  
	`vút_to_∑ge
(
	`__va
(
∑ddr
));

937 
	}
}

938 
EXPORT_SYMBOL
(
pci_dac_dma_to_∑ge
);

941 
	$pci_dac_dma_to_off£t
(
pci_dev
 *
pdev
, 
dma64_addr_t
 
dma_addr
)

943  (
dma_addr
 & ~
PAGE_MASK
);

944 
	}
}

945 
EXPORT_SYMBOL
(
pci_dac_dma_to_off£t
);

949 
pci_dev
 *

950 
	$Æpha_gídev_to_pci
(
devi˚
 *
dev
)

952 i‡(
dev
 && dev->
bus
 =&
pci_bus_ty≥
)

953  
	`to_pci_dev
(
dev
);

957 
	`BUG_ON
(!
iß_bridge
);

961 i‡(!
dev
 || !dev->
dma_mask
 || !*dev->dma_mask)

962  
iß_bridge
;

966 i‡(*
dev
->
dma_mask
 >
iß_bridge
->dma_mask)

967  
iß_bridge
;

970  
NULL
;

971 
	}
}

972 
EXPORT_SYMBOL
(
Æpha_gídev_to_pci
);

975 
	$dma_£t_mask
(
devi˚
 *
dev
, 
u64
 
mask
)

977 i‡(!
dev
->
dma_mask
 ||

978 !
	`pci_dma_suµ‹ãd
(
	`Æpha_gídev_to_pci
(
dev
), 
mask
))

979  -
EIO
;

981 *
dev
->
dma_mask
 = 
mask
;

984 
	}
}

985 
EXPORT_SYMBOL
(
dma_£t_mask
);

	@arch/alpha/kernel/process.c

11 
	~<löux/î∫o.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/sched.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/smp.h
>

17 
	~<löux/°ddef.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/±ø˚.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/u£r.h
>

22 
	~<löux/a.out.h
>

23 
	~<löux/ut¢ame.h
>

24 
	~<löux/time.h
>

25 
	~<löux/maj‹.h
>

26 
	~<löux/°©.h
>

27 
	~<löux/vt.h
>

28 
	~<löux/mm™.h
>

29 
	~<löux/ñfc‹e.h
>

30 
	~<löux/ªboŸ.h
>

31 
	~<löux/ây.h
>

32 
	~<löux/c⁄sﬁe.h
>

34 
	~<asm/ªg.h
>

35 
	~<asm/uac˚ss.h
>

36 
	~<asm/sy°em.h
>

37 
	~<asm/io.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/hwΩb.h
>

40 
	~<asm/Âu.h
>

42 
	~"¥Ÿo.h
"

43 
	~"pci_im∂.h
"

48 (*
pm_powî_off
)(Ë
machöe_powî_off
;

49 
	`EXPORT_SYMBOL
(
pm_powî_off
);

52 
	$˝u_idÀ
()

54 
	`£t_thªad_Êag
(
TIF_POLLING_NRFLAG
);

60 !
	`√ed_ªsched
())

61 
	`˝u_ªœx
();

62 
	`scheduÀ
();

64 
	}
}

67 
	shÆt_öfo
 {

68 
	mmode
;

69 *
	mª°¨t_cmd
;

73 
	$comm⁄_shutdown_1
(*
gíîic_±r
)

75 
hÆt_öfo
 *
how
 = (hÆt_öfÿ*)
gíîic_±r
;

76 
≥r˝u_°ru˘
 *
˝up
;

77 *
pÊags
, 
Êags
;

78 
˝uid
 = 
	`smp_¥o˚ss‹_id
();

81 
	`loˇl_úq_dißbÀ
();

83 
˝up
 = (
≥r˝u_°ru˘
 *)

84 (()
hwΩb
 + hwΩb->
¥o˚ss‹_off£t


85 + 
hwΩb
->
¥o˚ss‹_size
 * 
˝uid
);

86 
pÊags
 = &
˝up
->
Êags
;

87 
Êags
 = *
pÊags
;

90 
Êags
 &= ~0x00ff0001UL;

92 #ifde‡
CONFIG_SMP


94 i‡(
˝uid
 !
boŸ_˝uid
) {

95 
Êags
 |= 0x00040000UL;

96 *
pÊags
 = 
Êags
;

97 
	`˝u_˛ór
(
˝uid
, 
˝u_¥e£¡_m≠
);

98 
	`hÆt
();

102 i‡(
how
->
mode
 =
LINUX_REBOOT_CMD_RESTART
) {

103 i‡(!
how
->
ª°¨t_cmd
) {

104 
Êags
 |= 0x00020000UL;

114 
Êags
 |= 0x00030000UL;

117 
Êags
 |= 0x00040000UL;

119 *
pÊags
 = 
Êags
;

121 #ifde‡
CONFIG_SMP


123 
	`˝u_˛ór
(
boŸ_˝uid
, 
˝u_¥e£¡_m≠
);

124 
	`˝us_weight
(
˝u_¥e£¡_m≠
))

125 
	`b¨rõr
();

129 i‡(
Æpha_usög_§m
) {

130 #ifde‡
CONFIG_DUMMY_CONSOLE


133 i‡(
	`ö_öãºu±
())

134 
	`úq_exô
();

136 
	`èke_ovî_c⁄sﬁe
(&
dummy_c⁄
, 0, 
MAX_NR_CONSOLES
-1, 1);

138 
	`pci_ª°‹e_§m_c⁄fig
();

139 
	`£t_h´
(
§m_h´
);

142 i‡(
Æpha_mv
.
kûl_¨ch
)

143 
Æpha_mv
.
	`kûl_¨ch
(
how
->
mode
);

145 i‡(! 
Æpha_usög_§m
 && 
how
->
mode
 !
LINUX_REBOOT_CMD_RESTART
) {

152 i‡(
Æpha_usög_§m
)

153 
	`§m_∑gög_°›
();

155 
	`hÆt
();

156 
	}
}

159 
	$comm⁄_shutdown
(
mode
, *
ª°¨t_cmd
)

161 
hÆt_öfo
 
¨gs
;

162 
¨gs
.
mode
 = mode;

163 
¨gs
.
ª°¨t_cmd
 =Ñestart_cmd;

164 
	`⁄_óch_˝u
(
comm⁄_shutdown_1
, &
¨gs
, 1, 0);

165 
	}
}

168 
	$machöe_ª°¨t
(*
ª°¨t_cmd
)

170 
	`comm⁄_shutdown
(
LINUX_REBOOT_CMD_RESTART
, 
ª°¨t_cmd
);

171 
	}
}

175 
	$machöe_hÆt
()

177 
	`comm⁄_shutdown
(
LINUX_REBOOT_CMD_HALT
, 
NULL
);

178 
	}
}

182 
	$machöe_powî_off
()

184 
	`comm⁄_shutdown
(
LINUX_REBOOT_CMD_POWER_OFF
, 
NULL
);

185 
	}
}

192 
	$show_ªgs
(
±_ªgs
 *
ªgs
)

194 
	`dik_show_ªgs
(
ªgs
, 
NULL
);

195 
	}
}

201 
	$°¨t_thªad
(
±_ªgs
 * 
ªgs
, 
pc
, 
•
)

203 
	`£t_fs
(
USER_DS
);

204 
ªgs
->
pc
 =Öc;

205 
ªgs
->
ps
 = 8;

206 
	`wru•
(
•
);

207 
	}
}

208 
EXPORT_SYMBOL
(
°¨t_thªad
);

214 
	$exô_thªad
()

216 
	}
}

219 
	$Êush_thªad
()

223 
	`cuºít_thªad_öfo
()->
õì_°©e
 = 0;

224 
	`wrÂ¸
(
FPCR_DYN_NORMAL
 | 
	`õì_sw¸_to_Â¸
(0));

227 
	`cuºít_thªad_öfo
()->
pcb
.
unique
 = 0;

228 
	}
}

231 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

233 
	}
}

245 
	$Æpha_˛⁄e
(
˛⁄e_Êags
, 
u•
,

246 
__u£r
 *
∑ª¡_tid
, __u£∏*
chûd_tid
,

247 
és_vÆue
, 
±_ªgs
 *
ªgs
)

249 i‡(!
u•
)

250 
u•
 = 
	`rdu•
();

252  
	`do_f‹k
(
˛⁄e_Êags
, 
u•
, 
ªgs
, 0, 
∑ª¡_tid
, 
chûd_tid
);

253 
	}
}

256 
	$Æpha_vf‹k
(
±_ªgs
 *
ªgs
)

258  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
	`rdu•
(),

259 
ªgs
, 0, 
NULL
, NULL);

260 
	}
}

274 
	$c›y_thªad
(
ƒ
, 
˛⁄e_Êags
, 
u•
,

275 
unu£d
,

276 
èsk_°ru˘
 * 
p
, 
±_ªgs
 * 
ªgs
)

278 
	`ªt_‰om_f‹k
();

280 
thªad_öfo
 *
chûdti
 = 
	`èsk_thªad_öfo
(
p
);

281 
±_ªgs
 * 
chûdªgs
;

282 
swôch_°ack
 * 
chûd°ack
, *
°ack
;

283 
°ack_off£t
, 
£âls
;

285 
°ack_off£t
 = 
PAGE_SIZE
 - (
±_ªgs
);

286 i‡(!(
ªgs
->
ps
 & 8))

287 
°ack_off£t
 = (
PAGE_SIZE
-1Ë& (Ë
ªgs
;

288 
chûdªgs
 = (
±_ªgs
 *)

289 (
°ack_off£t
 + 
PAGE_SIZE
 + 
	`èsk_°ack_∑ge
(
p
));

291 *
chûdªgs
 = *
ªgs
;

292 
£âls
 = 
ªgs
->
r20
;

293 
chûdªgs
->
r0
 = 0;

294 
chûdªgs
->
r19
 = 0;

295 
chûdªgs
->
r20
 = 1;

296 
ªgs
->
r20
 = 0;

297 
°ack
 = ((
swôch_°ack
 *Ë
ªgs
) - 1;

298 
chûd°ack
 = ((
swôch_°ack
 *Ë
chûdªgs
) - 1;

299 *
chûd°ack
 = *
°ack
;

300 
chûd°ack
->
r26
 = (Ë
ªt_‰om_f‹k
;

301 
chûdti
->
pcb
.
u•
 = usp;

302 
chûdti
->
pcb
.
k•
 = (Ë
chûd°ack
;

303 
chûdti
->
pcb
.
Êags
 = 1;

314 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
)

315 
chûdti
->
pcb
.
unique
 = 
£âls
;

318 
	}
}

324 
	$dump_thªad
(
±_ªgs
 * 
±
, 
u£r
 * 
dump
)

327 
swôch_°ack
 * 
sw
 = ((swôch_°ack *Ë
±
) - 1;

329 
dump
->
magic
 = 
CMAGIC
;

330 
dump
->
°¨t_code
 = 
cuºít
->
mm
->start_code;

331 
dump
->
°¨t_d©a
 = 
cuºít
->
mm
->start_data;

332 
dump
->
°¨t_°ack
 = 
	`rdu•
(Ë& ~(
PAGE_SIZE
 - 1);

333 
dump
->
u_tsize
 = ((
cuºít
->
mm
->
íd_code
 - dump->
°¨t_code
)

334 >> 
PAGE_SHIFT
);

335 
dump
->
u_dsize
 = ((
cuºít
->
mm
->
brk
 + 
PAGE_SIZE
-1 - dump->
°¨t_d©a
)

336 >> 
PAGE_SHIFT
);

337 
dump
->
u_ssize
 = (
cuºít
->
mm
->
°¨t_°ack
 - dump->start_stack

338 + 
PAGE_SIZE
-1Ë>> 
PAGE_SHIFT
;

345 
dump
->
ªgs
[
EF_V0
] = 
±
->
r0
;

346 
dump
->
ªgs
[
EF_T0
] = 
±
->
r1
;

347 
dump
->
ªgs
[
EF_T1
] = 
±
->
r2
;

348 
dump
->
ªgs
[
EF_T2
] = 
±
->
r3
;

349 
dump
->
ªgs
[
EF_T3
] = 
±
->
r4
;

350 
dump
->
ªgs
[
EF_T4
] = 
±
->
r5
;

351 
dump
->
ªgs
[
EF_T5
] = 
±
->
r6
;

352 
dump
->
ªgs
[
EF_T6
] = 
±
->
r7
;

353 
dump
->
ªgs
[
EF_T7
] = 
±
->
r8
;

354 
dump
->
ªgs
[
EF_S0
] = 
sw
->
r9
;

355 
dump
->
ªgs
[
EF_S1
] = 
sw
->
r10
;

356 
dump
->
ªgs
[
EF_S2
] = 
sw
->
r11
;

357 
dump
->
ªgs
[
EF_S3
] = 
sw
->
r12
;

358 
dump
->
ªgs
[
EF_S4
] = 
sw
->
r13
;

359 
dump
->
ªgs
[
EF_S5
] = 
sw
->
r14
;

360 
dump
->
ªgs
[
EF_S6
] = 
sw
->
r15
;

361 
dump
->
ªgs
[
EF_A3
] = 
±
->
r19
;

362 
dump
->
ªgs
[
EF_A4
] = 
±
->
r20
;

363 
dump
->
ªgs
[
EF_A5
] = 
±
->
r21
;

364 
dump
->
ªgs
[
EF_T8
] = 
±
->
r22
;

365 
dump
->
ªgs
[
EF_T9
] = 
±
->
r23
;

366 
dump
->
ªgs
[
EF_T10
] = 
±
->
r24
;

367 
dump
->
ªgs
[
EF_T11
] = 
±
->
r25
;

368 
dump
->
ªgs
[
EF_RA
] = 
±
->
r26
;

369 
dump
->
ªgs
[
EF_T12
] = 
±
->
r27
;

370 
dump
->
ªgs
[
EF_AT
] = 
±
->
r28
;

371 
dump
->
ªgs
[
EF_SP
] = 
	`rdu•
();

372 
dump
->
ªgs
[
EF_PS
] = 
±
->
ps
;

373 
dump
->
ªgs
[
EF_PC
] = 
±
->
pc
;

374 
dump
->
ªgs
[
EF_GP
] = 
±
->
gp
;

375 
dump
->
ªgs
[
EF_A0
] = 
±
->
r16
;

376 
dump
->
ªgs
[
EF_A1
] = 
±
->
r17
;

377 
dump
->
ªgs
[
EF_A2
] = 
±
->
r18
;

378 
	`mem˝y
((*)
dump
->
ªgs
 + 
EF_SIZE
, 
sw
->
Â
, 32 * 8);

379 
	}
}

380 
EXPORT_SYMBOL
(
dump_thªad
);

386 
	$dump_ñf_thªad
(
ñf_gªg_t
 *
de°
, 
±_ªgs
 *
±
, 
thªad_öfo
 *
ti
)

389 
swôch_°ack
 * 
sw
 = ((swôch_°ack *Ë
±
) - 1;

391 
de°
[ 0] = 
±
->
r0
;

392 
de°
[ 1] = 
±
->
r1
;

393 
de°
[ 2] = 
±
->
r2
;

394 
de°
[ 3] = 
±
->
r3
;

395 
de°
[ 4] = 
±
->
r4
;

396 
de°
[ 5] = 
±
->
r5
;

397 
de°
[ 6] = 
±
->
r6
;

398 
de°
[ 7] = 
±
->
r7
;

399 
de°
[ 8] = 
±
->
r8
;

400 
de°
[ 9] = 
sw
->
r9
;

401 
de°
[10] = 
sw
->
r10
;

402 
de°
[11] = 
sw
->
r11
;

403 
de°
[12] = 
sw
->
r12
;

404 
de°
[13] = 
sw
->
r13
;

405 
de°
[14] = 
sw
->
r14
;

406 
de°
[15] = 
sw
->
r15
;

407 
de°
[16] = 
±
->
r16
;

408 
de°
[17] = 
±
->
r17
;

409 
de°
[18] = 
±
->
r18
;

410 
de°
[19] = 
±
->
r19
;

411 
de°
[20] = 
±
->
r20
;

412 
de°
[21] = 
±
->
r21
;

413 
de°
[22] = 
±
->
r22
;

414 
de°
[23] = 
±
->
r23
;

415 
de°
[24] = 
±
->
r24
;

416 
de°
[25] = 
±
->
r25
;

417 
de°
[26] = 
±
->
r26
;

418 
de°
[27] = 
±
->
r27
;

419 
de°
[28] = 
±
->
r28
;

420 
de°
[29] = 
±
->
gp
;

421 
de°
[30] = 
	`rdu•
();

422 
de°
[31] = 
±
->
pc
;

427 
de°
[32] = 
ti
->
pcb
.
unique
;

428 
	}
}

429 
EXPORT_SYMBOL
(
dump_ñf_thªad
);

432 
	$dump_ñf_èsk
(
ñf_gªg_t
 *
de°
, 
èsk_°ru˘
 *
èsk
)

434 
	`dump_ñf_thªad
(
de°
, 
	`èsk_±_ªgs
(
èsk
), 
	`èsk_thªad_öfo
(task));

436 
	}
}

437 
EXPORT_SYMBOL
(
dump_ñf_èsk
);

440 
	$dump_ñf_èsk_Â
(
ñf_Âªg_t
 *
de°
, 
èsk_°ru˘
 *
èsk
)

442 
swôch_°ack
 *
sw
 = (swôch_°ack *)
	`èsk_±_ªgs
(
èsk
) - 1;

443 
	`mem˝y
(
de°
, 
sw
->
Â
, 32 * 8);

445 
	}
}

446 
EXPORT_SYMBOL
(
dump_ñf_èsk_Â
);

451 
asmlökage
 

452 
	$do_sys_execve
(
__u£r
 *
ufûíame
, __u£∏* __u£∏*
¨gv
,

453 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

455 
îr‹
;

456 *
fûíame
;

458 
fûíame
 = 
	`gë«me
(
ufûíame
);

459 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

460 i‡(
	`IS_ERR
(
fûíame
))

461 
out
;

462 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

463 
	`puäame
(
fûíame
);

464 
out
:

465  
îr‹
;

466 
	}
}

483 
	$thªad_ßved_pc
(
èsk_°ru˘
 *
t
)

485 
ba£
 = ()
	`èsk_°ack_∑ge
(
t
);

486 
Â
, 
•
 = 
	`èsk_thªad_öfo
(
t
)->
pcb
.
k•
;

488 i‡(
•
 > 
ba£
 && sp+6*8 < base + 16*1024) {

489 
Â
 = ((*)
•
)[6];

490 i‡(
Â
 > 
•
 && f∞< 
ba£
 + 16*1024)

491  *(*)
Â
;

495 
	}
}

498 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

500 
scheduÀ_‰ame
;

501 
pc
;

502 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

514 
pc
 = 
	`thªad_ßved_pc
(
p
);

515 i‡(
	`ö_sched_fun˘i⁄s
(
pc
)) {

516 
scheduÀ_‰ame
 = ((*)
	`èsk_thªad_öfo
(
p
)->
pcb
.
k•
)[6];

517  ((*)
scheduÀ_‰ame
)[12];

519  
pc
;

520 
	}
}

	@arch/alpha/kernel/proto.h

1 
	~<löux/öãºu±.h
>

2 
	~<löux/io.h
>

4 
	~<asm/pgèbÀ.h
>

8 
	#vu˝
 vﬁ©ûê*

	)

9 
	#vu•
 vﬁ©ûê*

	)

10 
	#vù
 vﬁ©ûê*

	)

11 
	#vuù
 vﬁ©ûê*

	)

12 
	#vuÕ
 vﬁ©ûê*

	)

14 
	g±_ªgs
;

15 
	gèsk_°ru˘
;

16 
	gpci_dev
;

17 
	gpci_c⁄åﬁÀr
;

20 
pci_›s
 
≠ecs_pci_›s
;

21 
≠ecs_öô_¨ch
();

22 
≠ecs_pci_˛r_îr
();

23 
≠ecs_machöe_check
(
u64
, u64);

24 
≠ecs_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

27 
pci_›s
 
cü_pci_›s
;

28 
cü_öô_pci
();

29 
cü_öô_¨ch
();

30 
pyxis_öô_¨ch
();

31 
cü_kûl_¨ch
();

32 
cü_machöe_check
(
u64
, u64);

33 
cü_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

36 
pci_›s
 
ú⁄g©e_pci_›s
;

37 
ú⁄g©e_pci_˛r_îr
();

38 
ú⁄g©e_öô_¨ch
();

39 
ú⁄g©e_machöe_check
(
u64
, u64);

40 
	#ú⁄g©e_pci_tbi
 ((*)0)

	)

43 
pci_›s
 
lˇ_pci_›s
;

44 
lˇ_öô_¨ch
();

45 
lˇ_machöe_check
(
u64
, u64);

46 
lˇ_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

49 
pci_›s
 
m¨vñ_pci_›s
;

50 
m¨vñ_öô_¨ch
();

51 
m¨vñ_kûl_¨ch
();

52 
m¨vñ_machöe_check
(
u64
, u64);

53 
m¨vñ_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

54 
m¨vñ_∑_to_nid
();

55 
m¨vñ_˝uid_to_nid
();

56 
m¨vñ_node_mem_°¨t
();

57 
m¨vñ_node_mem_size
();

58 
_Æpha_agp_öfo
 *
m¨vñ_agp_öfo
();

59 
io7
 *
m¨vñ_föd_io7
(
≥
);

60 
io7
 *
m¨vñ_√xt_io7
(io7 *
¥ev
);

61 
io7_˛ór_îr‹s
(
io7
 *io7);

64 
pci_›s
 
m˝cü_pci_›s
;

65 
m˝cü_öô_¨ch
();

66 
m˝cü_öô_ho£s
();

67 
m˝cü_machöe_check
(
u64
, u64);

68 
m˝cü_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

71 
pci_›s
 
pﬁ¨is_pci_›s
;

72 
pﬁ¨is_ªad_c⁄fig_dw‹d
(
pci_dev
 *, , 
u32
 *);

73 
pﬁ¨is_wrôe_c⁄fig_dw‹d
(
pci_dev
 *, , 
u32
);

74 
pﬁ¨is_öô_¨ch
();

75 
pﬁ¨is_machöe_check
(
u64
, u64);

76 
	#pﬁ¨is_pci_tbi
 ((*)0)

	)

79 
pci_›s
 
t2_pci_›s
;

80 
t2_öô_¨ch
();

81 
t2_kûl_¨ch
();

82 
t2_machöe_check
(
u64
, u64);

83 
t2_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

86 
pci_›s
 
tô™_pci_›s
;

87 
tô™_öô_¨ch
();

88 
tô™_kûl_¨ch
();

89 
tô™_machöe_check
(
u64
, u64);

90 
tô™_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

91 
_Æpha_agp_öfo
 *
tô™_agp_öfo
();

94 
pci_›s
 
tsu«mi_pci_›s
;

95 
tsu«mi_öô_¨ch
();

96 
tsu«mi_kûl_¨ch
();

97 
tsu«mi_machöe_check
(
u64
, u64);

98 
tsu«mi_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

101 
pci_›s
 
wûdfúe_pci_›s
;

102 
wûdfúe_öô_¨ch
();

103 
wûdfúe_kûl_¨ch
();

104 
wûdfúe_machöe_check
(
u64
, u64);

105 
wûdfúe_pci_tbi
(
pci_c⁄åﬁÀr
 *, 
dma_addr_t
, dma_addr_t);

106 
wûdfúe_∑_to_nid
();

107 
wûdfúe_˝uid_to_nid
();

108 
wûdfúe_node_mem_°¨t
();

109 
wûdfúe_node_mem_size
();

112 #ifde‡
CONFIG_VGA_HOSE


113 
föd_c⁄sﬁe_vga_ho£
();

114 
loˇã_™d_öô_vga
(*(*)(*, *));

116 
ölöe
 
	$föd_c⁄sﬁe_vga_ho£
(Ë{ 
	}
}

117 
ölöe
 
loˇã_™d_öô_vga
(*(*
£l_func
)(*, *)) { }

121 
§m_h´
;

122 
boŸ_˝uid
;

123 #ifde‡
CONFIG_VERBOSE_MCHECK


124 
Æpha_vîbo£_mcheck
;

128 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_SRM
)

129 
ªgi°î_§m_c⁄sﬁe
();

130 
uƒegi°î_§m_c⁄sﬁe
();

132 
	#ªgi°î_§m_c⁄sﬁe
()

	)

133 
	#uƒegi°î_§m_c⁄sﬁe
()

	)

137 
£tup_smp
();

138 
h™dÀ_ùi
(
±_ªgs
 *);

139 
smp_≥r˝u_timî_öãºu±
(
±_ªgs
 *);

145 
úqªtu∫_t
 
timî_öãºu±
(
úq
, *
dev
);

146 
comm⁄_öô_πc
();

147 
e°_cy˛e_‰eq
;

150 
SMC93x_Inô
();

153 
SMC669_Inô
();

156 
es1888_öô
();

159 
ns87312_íabÀ_ide
(
ide_ba£
);

162 
Æpha_wrôe_Â_ªg
 (
ªg
, 
vÆ
);

163 
Æpha_ªad_Â_ªg
 (
ªg
);

166 
wrm˚s
(
m˚s
);

167 
c£rve_ía
();

168 
c£rve_dis
();

169 
__smp_ˇŒö
();

172 
ítArôh
();

173 
ítIF
();

174 
ítI¡
();

175 
ítMM
();

176 
ítSys
();

177 
ítU«
();

178 
ítDbg
();

181 
±ø˚_£t_b±
 (
èsk_°ru˘
 *
chûd
);

182 
±ø˚_ˇn˚l_b±
 (
èsk_°ru˘
 *
chûd
);

185 
dik_show_ªgs
(
±_ªgs
 *
ªgs
, *
r9_15
);

186 
dõ_if_kî√l
(*, 
±_ªgs
 *, , *);

189 
tô™_di•©ch_úqs
(
u64
);

192 
swôch_to_sy°em_m≠
();

193 
§m_∑gög_°›
();

195 
ölöe
 

196 
	$__Æpha_ªm≠_¨ó_∑ges
(
addªss
, 
phys_addr
,

197 
size
, 
Êags
)

199 
pg¥Ÿ_t
 
¥Ÿ
;

201 
¥Ÿ
 = 
	`__pg¥Ÿ
(
_PAGE_VALID
 | 
_PAGE_ASM
 | 
_PAGE_KRE


202 | 
_PAGE_KWE
 | 
Êags
);

203  
	`i‹em≠_∑ge_ønge
(
addªss
,áddªs†+ 
size
, 
phys_addr
, 
¥Ÿ
);

204 
	}
}

208 #ifde‡
CONFIG_SMP


209 
	#mcheck_ex≥˘ed
(
˝u
Ë(
˝u_d©a
[˝u].
mcheck_ex≥˘ed
)

	)

210 
	#mcheck_èkí
(
˝u
Ë(
˝u_d©a
[˝u].
mcheck_èkí
)

	)

211 
	#mcheck_exåa
(
˝u
Ë(
˝u_d©a
[˝u].
mcheck_exåa
)

	)

213 
	smcheck_öfo


215 
ex≥˘ed
 
__©åibuã__
((
Æig√d
(8)));

216 
èkí
;

217 
exåa
;

218 } 
__mcheck_öfo
;

220 
	#mcheck_ex≥˘ed
(
˝u
Ë(*(()(˝u), &
__mcheck_öfo
.
ex≥˘ed
))

	)

221 
	#mcheck_èkí
(
˝u
Ë(*(()(˝u), &
__mcheck_öfo
.
èkí
))

	)

222 
	#mcheck_exåa
(
˝u
Ë(*(()(˝u), &
__mcheck_öfo
.
exåa
))

	)

225 
¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
,

226 c⁄° *
machöe
, 
ex≥˘ed
);

	@arch/alpha/kernel/ptrace.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/smp.h
>

11 
	~<löux/smp_lock.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/±ø˚.h
>

14 
	~<löux/u£r.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/£curôy.h
>

17 
	~<löux/sig«l.h
>

19 
	~<asm/uac˚ss.h
>

20 
	~<asm/pgèbÀ.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/Âu.h
>

24 
	~"¥Ÿo.h
"

26 
	#DEBUG
 
DBG_MEM


	)

27 #unde‡
DEBUG


29 #ifde‡
DEBUG


31 
	mDBG_MEM
 = (1<<0),

32 
	mDBG_BPT
 = (1<<1),

33 
	mDBG_MEM_ALL
 = (1<<2)

35 
	#DBG
(
Ác
,
¨gs
Ë{i‡((ÁcË& 
DEBUG
Ë
¥ötk
árgs;}

	)

37 
	#DBG
(
Ác
,
¨gs
)

	)

40 
	#BREAKINST
 0x00000080

	)

72 
	mREG_R0
 = 0, 
	mREG_F0
 = 32, 
	mREG_FPCR
 = 63, 
	mREG_PC
 = 64

75 
	#PT_REG
(
ªg
) \

76 (
PAGE_SIZE
*2 - (
±_ªgs
Ë+ 
	`off£tof
(±_ªgs, 
ªg
))

	)

78 
	#SW_REG
(
ªg
) \

79 (
PAGE_SIZE
*2 - (
±_ªgs
Ë- (
swôch_°ack
) \

80 + 
	`off£tof
(
swôch_°ack
, 
ªg
))

	)

82 
	gªgoff
[] = {

83 
PT_REG
–
r0
), PT_REG–
r1
), PT_REG–
r2
), PT_REG–
r3
),

84 
PT_REG
–
r4
), PT_REG–
r5
), PT_REG–
r6
), PT_REG–
r7
),

85 
PT_REG
–
r8
), 
SW_REG
–
r9
), SW_REG–
r10
), SW_REG–
r11
),

86 
SW_REG
–
r12
), SW_REG–
r13
), SW_REG–
r14
), SW_REG–
r15
),

87 
PT_REG
–
r16
), PT_REG–
r17
), PT_REG–
r18
), PT_REG–
r19
),

88 
PT_REG
–
r20
), PT_REG–
r21
), PT_REG–
r22
), PT_REG–
r23
),

89 
PT_REG
–
r24
), PT_REG–
r25
), PT_REG–
r26
), PT_REG–
r27
),

90 
PT_REG
–
r28
), PT_REG–
gp
), -1, -1,

91 
SW_REG
(
Â
[ 0]), SW_REG(fp[ 1]), SW_REG(fp[ 2]), SW_REG(fp[ 3]),

92 
SW_REG
(
Â
[ 4]), SW_REG(fp[ 5]), SW_REG(fp[ 6]), SW_REG(fp[ 7]),

93 
SW_REG
(
Â
[ 8]), SW_REG(fp[ 9]), SW_REG(fp[10]), SW_REG(fp[11]),

94 
SW_REG
(
Â
[12]), SW_REG(fp[13]), SW_REG(fp[14]), SW_REG(fp[15]),

95 
SW_REG
(
Â
[16]), SW_REG(fp[17]), SW_REG(fp[18]), SW_REG(fp[19]),

96 
SW_REG
(
Â
[20]), SW_REG(fp[21]), SW_REG(fp[22]), SW_REG(fp[23]),

97 
SW_REG
(
Â
[24]), SW_REG(fp[25]), SW_REG(fp[26]), SW_REG(fp[27]),

98 
SW_REG
(
Â
[28]), SW_REG(fp[29]), SW_REG(fp[30]), SW_REG(fp[31]),

99 
PT_REG
–
pc
)

102 
	gzîo
;

108 
	$gë_ªg_addr
(
èsk_°ru˘
 * 
èsk
, 
ªgno
)

110 *
addr
;

112 i‡(
ªgno
 == 30) {

113 
addr
 = &
	`èsk_thªad_öfo
(
èsk
)->
pcb
.
u•
;

114 } i‡(
ªgno
 == 65) {

115 
addr
 = &
	`èsk_thªad_öfo
(
èsk
)->
pcb
.
unique
;

116 } i‡(
ªgno
 == 31 ||Ñegno > 65) {

117 
zîo
 = 0;

118 
addr
 = &
zîo
;

120 
addr
 = 
	`èsk_°ack_∑ge
(
èsk
Ë+ 
ªgoff
[
ªgno
];

122  
addr
;

123 
	}
}

129 
	$gë_ªg
(
èsk_°ru˘
 * 
èsk
, 
ªgno
)

132 i‡(
ªgno
 == 63) {

133 
Â¸
 = *
	`gë_ªg_addr
(
èsk
, 
ªgno
);

134 
sw¸


135 
	`èsk_thªad_öfo
(
èsk
)->
õì_°©e
 & 
IEEE_SW_MASK
;

136 
sw¸
 = 
	`sw¸_upd©e_°©us
(sw¸, 
Â¸
);

137  
Â¸
 | 
sw¸
;

139  *
	`gë_ªg_addr
(
èsk
, 
ªgno
);

140 
	}
}

146 
	$put_ªg
(
èsk_°ru˘
 *
èsk
, 
ªgno
, 
d©a
)

148 i‡(
ªgno
 == 63) {

149 
	`èsk_thªad_öfo
(
èsk
)->
õì_°©e


150 ((
	`èsk_thªad_öfo
(
èsk
)->
õì_°©e
 & ~
IEEE_SW_MASK
)

151 | (
d©a
 & 
IEEE_SW_MASK
));

152 
d©a
 = (d©®& 
FPCR_DYN_MASK
Ë| 
	`õì_sw¸_to_Â¸
(data);

154 *
	`gë_ªg_addr
(
èsk
, 
ªgno
Ë
d©a
;

156 
	}
}

158 
ölöe
 

159 
	$ªad_öt
(
èsk_°ru˘
 *
èsk
, 
addr
, * 
d©a
)

161 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
, 
d©a
, (), 0);

162  (
c›õd
 =()Ë? 0 : -
EIO
;

163 
	}
}

165 
ölöe
 

166 
	$wrôe_öt
(
èsk_°ru˘
 *
èsk
, 
addr
, 
d©a
)

168 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
, &
d©a
, (), 1);

169  (
c›õd
 =()Ë? 0 : -
EIO
;

170 
	}
}

176 
	$±ø˚_£t_b±
(
èsk_°ru˘
 * 
chûd
)

178 
di•l
, 
i
, 
ªs
, 
ªg_b
, 
nßved
 = 0;

179 
ö¢
, 
›_code
;

180 
pc
;

182 
pc
 = 
	`gë_ªg
(
chûd
, 
REG_PC
);

183 
ªs
 = 
	`ªad_öt
(
chûd
, 
pc
, (*Ë&
ö¢
);

184 i‡(
ªs
 < 0)

185  
ªs
;

187 
›_code
 = 
ö¢
 >> 26;

188 i‡(
›_code
 >= 0x30) {

197 
di•l
 = ((
s32
)(
ö¢
 << 11)) >> 9;

198 
	`èsk_thªad_öfo
(
chûd
)->
b±_addr
[
nßved
++] = 
pc
 + 4;

199 i‡(
di•l
)

200 
	`èsk_thªad_öfo
(
chûd
)->
b±_addr
[
nßved
++]

201 
pc
 + 4 + 
di•l
;

202 
	`DBG
(
DBG_BPT
, ("execing branch\n"));

203 } i‡(
›_code
 == 0x1a) {

204 
ªg_b
 = (
ö¢
 >> 16) & 0x1f;

205 
	`èsk_thªad_öfo
(
chûd
)->
b±_addr
[
nßved
++] = 
	`gë_ªg
(chûd, 
ªg_b
);

206 
	`DBG
(
DBG_BPT
, ("execing jump\n"));

208 
	`èsk_thªad_öfo
(
chûd
)->
b±_addr
[
nßved
++] = 
pc
 + 4;

209 
	`DBG
(
DBG_BPT
, ("execingÇormal insn\n"));

213 
i
 = 0; i < 
nßved
; ++i) {

214 
ªs
 = 
	`ªad_öt
(
chûd
, 
	`èsk_thªad_öfo
(chûd)->
b±_addr
[
i
],

215 (*Ë&
ö¢
);

216 i‡(
ªs
 < 0)

217  
ªs
;

218 
	`èsk_thªad_öfo
(
chûd
)->
b±_ö¢
[
i
] = 
ö¢
;

219 
	`DBG
(
DBG_BPT
, (" ->Çext_pc=%lx\n",

220 
	`èsk_thªad_öfo
(
chûd
)->
b±_addr
[
i
]));

221 
ªs
 = 
	`wrôe_öt
(
chûd
, 
	`èsk_thªad_öfo
(chûd)->
b±_addr
[
i
],

222 
BREAKINST
);

223 i‡(
ªs
 < 0)

224  
ªs
;

226 
	`èsk_thªad_öfo
(
chûd
)->
b±_nßved
 = 
nßved
;

228 
	}
}

235 
	$±ø˚_ˇn˚l_b±
(
èsk_°ru˘
 * 
chûd
)

237 
i
, 
nßved
 = 
	`èsk_thªad_öfo
(
chûd
)->
b±_nßved
;

239 
	`èsk_thªad_öfo
(
chûd
)->
b±_nßved
 = 0;

241 i‡(
nßved
 > 2) {

242 
	`¥ötk
("±ø˚_ˇn˚l_b±: bogu†nßved: %d!\n", 
nßved
);

243 
nßved
 = 2;

246 
i
 = 0; i < 
nßved
; ++i) {

247 
	`wrôe_öt
(
chûd
, 
	`èsk_thªad_öfo
(chûd)->
b±_addr
[
i
],

248 
	`èsk_thªad_öfo
(
chûd
)->
b±_ö¢
[
i
]);

250  (
nßved
 != 0);

251 
	}
}

258 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

260 
	`±ø˚_ˇn˚l_b±
(
chûd
);

261 
	}
}

263 
asmlökage
 

264 
	$do_sys_±ø˚
(
ªque°
, 
pid
, 
addr
, 
d©a
,

265 
±_ªgs
 *
ªgs
)

267 
èsk_°ru˘
 *
chûd
;

268 
tmp
;

269 
size_t
 
c›õd
;

270 
ªt
;

272 
	`lock_kî√l
();

273 
	`DBG
(
DBG_MEM
, ("request=%ldÖid=%ldáddr=0x%lx data=0x%lx\n",

274 
ªque°
, 
pid
, 
addr
, 
d©a
));

275 i‡(
ªque°
 =
PTRACE_TRACEME
) {

276 
ªt
 = 
	`±ø˚_åa˚me
();

277 
out_nŸsk
;

280 
chûd
 = 
	`±ø˚_gë_èsk_°ru˘
(
pid
);

281 i‡(
	`IS_ERR
(
chûd
)) {

282 
ªt
 = 
	`PTR_ERR
(
chûd
);

283 
out_nŸsk
;

286 i‡(
ªque°
 =
PTRACE_ATTACH
) {

287 
ªt
 = 
	`±ø˚_©èch
(
chûd
);

288 
out
;

291 
ªt
 = 
	`±ø˚_check_©èch
(
chûd
, 
ªque°
 =
PTRACE_KILL
);

292 i‡(
ªt
 < 0)

293 
out
;

295 
ªque°
) {

297 
PTRACE_PEEKTEXT
:

298 
PTRACE_PEEKDATA
:

299 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, &
tmp
, (tmp), 0);

300 
ªt
 = -
EIO
;

301 i‡(
c›õd
 !(
tmp
))

304 
ªgs
->
r0
 = 0;

305 
ªt
 = 
tmp
;

309 
PTRACE_PEEKUSR
:

310 
ªgs
->
r0
 = 0;

311 
ªt
 = 
	`gë_ªg
(
chûd
, 
addr
);

312 
	`DBG
(
DBG_MEM
, ("≥ek $%ld->%#lx\n", 
addr
, 
ªt
));

316 
PTRACE_POKETEXT
:

317 
PTRACE_POKEDATA
:

318 
tmp
 = 
d©a
;

319 
c›õd
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, &
tmp
, (tmp), 1);

320 
ªt
 = (
c›õd
 =(
tmp
)Ë? 0 : -
EIO
;

323 
PTRACE_POKEUSR
:

324 
	`DBG
(
DBG_MEM
, ("pokê$%ld<-%#lx\n", 
addr
, 
d©a
));

325 
ªt
 = 
	`put_ªg
(
chûd
, 
addr
, 
d©a
);

328 
PTRACE_SYSCALL
:

330 
PTRACE_CONT
:

331 
ªt
 = -
EIO
;

332 i‡(!
	`vÆid_sig«l
(
d©a
))

334 i‡(
ªque°
 =
PTRACE_SYSCALL
)

335 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

337 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

338 
chûd
->
exô_code
 = 
d©a
;

340 
	`±ø˚_ˇn˚l_b±
(
chûd
);

341 
	`wake_up_¥o˚ss
(
chûd
);

342 
ªt
 = 0;

350 
PTRACE_KILL
:

351 
ªt
 = 0;

352 i‡(
chûd
->
exô_°©e
 =
EXIT_ZOMBIE
)

354 
chûd
->
exô_code
 = 
SIGKILL
;

356 
	`±ø˚_ˇn˚l_b±
(
chûd
);

357 
	`wake_up_¥o˚ss
(
chûd
);

358 
out
;

360 
PTRACE_SINGLESTEP
:

361 
ªt
 = -
EIO
;

362 i‡(!
	`vÆid_sig«l
(
d©a
))

365 
	`èsk_thªad_öfo
(
chûd
)->
b±_nßved
 = -1;

366 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

367 
chûd
->
exô_code
 = 
d©a
;

368 
	`wake_up_¥o˚ss
(
chûd
);

370 
ªt
 = 0;

371 
out
;

373 
PTRACE_DETACH
:

374 
ªt
 = 
	`±ø˚_dëach
(
chûd
, 
d©a
);

375 
out
;

378 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

379 
out
;

381 
out
:

382 
	`put_èsk_°ru˘
(
chûd
);

383 
out_nŸsk
:

384 
	`u∆ock_kî√l
();

385  
ªt
;

386 
	}
}

388 
asmlökage
 

389 
	$sysˇŒ_åa˚
()

391 i‡(!
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

393 i‡(!(
cuºít
->
±ø˚
 & 
PT_PTRACED
))

397 
	`±ø˚_nŸify
(
SIGTRAP
 | ((
cuºít
->
±ø˚
 & 
PT_TRACESYSGOOD
)

405 i‡(
cuºít
->
exô_code
) {

406 
	`£nd_sig
(
cuºít
->
exô_code
, current, 1);

407 
cuºít
->
exô_code
 = 0;

409 
	}
}

	@arch/alpha/kernel/semaphore.c

8 
	~<löux/î∫o.h
>

9 
	~<löux/sched.h
>

10 
	~<löux/öô.h
>

27 
ölöe
 
	$__£m_upd©e_cou¡
(
£m≠h‹e
 *
£m
, 
ö¸
)

29 
ﬁd_cou¡
, 
tmp
 = 0;

31 
__asm__
 
	`__vﬁ©ûe__
(

41 : "=&r" (
ﬁd_cou¡
), "=&r" (
tmp
), "=m" (
£m
->
cou¡
)

42 : "Ir" (
ö¸
), "1" (
tmp
), "m" (
£m
->
cou¡
));

44  
ﬁd_cou¡
;

45 
	}
}

64 
__sched


65 
	$__down_Áûed
(
£m≠h‹e
 *
£m
)

67 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

68 
	`DECLARE_WAITQUEUE
(
waô
, 
tsk
);

70 #ifde‡
CONFIG_DEBUG_SEMAPHORE


71 
	`¥ötk
("%s(%d): down failed(%p)\n",

72 
tsk
->
comm
,Åsk->
pid
, 
£m
);

75 
tsk
->
°©e
 = 
TASK_UNINTERRUPTIBLE
;

76 
	`wmb
();

77 
	`add_waô_queue_ex˛usive
(&
£m
->
waô
, &wait);

85 
	`__£m_upd©e_cou¡
(
£m
, -1) <= 0) {

86 
	`scheduÀ
();

87 
	`£t_èsk_°©e
(
tsk
, 
TASK_UNINTERRUPTIBLE
);

89 
	`ªmove_waô_queue
(&
£m
->
waô
, &wait);

90 
tsk
->
°©e
 = 
TASK_RUNNING
;

97 
	`wake_up
(&
£m
->
waô
);

99 #ifde‡
CONFIG_DEBUG_SEMAPHORE


100 
	`¥ötk
("%s(%d): downácquired(%p)\n",

101 
tsk
->
comm
,Åsk->
pid
, 
£m
);

103 
	}
}

105 
__sched


106 
	$__down_Áûed_öãºu±ibÀ
(
£m≠h‹e
 *
£m
)

108 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

109 
	`DECLARE_WAITQUEUE
(
waô
, 
tsk
);

110 
ªt
 = 0;

112 #ifde‡
CONFIG_DEBUG_SEMAPHORE


113 
	`¥ötk
("%s(%d): down failed(%p)\n",

114 
tsk
->
comm
,Åsk->
pid
, 
£m
);

117 
tsk
->
°©e
 = 
TASK_INTERRUPTIBLE
;

118 
	`wmb
();

119 
	`add_waô_queue_ex˛usive
(&
£m
->
waô
, &wait);

121 
	`__£m_upd©e_cou¡
(
£m
, -1) <= 0) {

122 i‡(
	`sig«l_≥ndög
(
cuºít
)) {

128 
	`__£m_upd©e_cou¡
(
£m
, 0);

129 
ªt
 = -
EINTR
;

132 
	`scheduÀ
();

133 
	`£t_èsk_°©e
(
tsk
, 
TASK_INTERRUPTIBLE
);

136 
	`ªmove_waô_queue
(&
£m
->
waô
, &wait);

137 
tsk
->
°©e
 = 
TASK_RUNNING
;

138 
	`wake_up
(&
£m
->
waô
);

140 #ifde‡
CONFIG_DEBUG_SEMAPHORE


141 
	`¥ötk
("%s(%d): down %s(%p)\n",

142 
cuºít
->
comm
, cuºít->
pid
,

143 (
ªt
 < 0 ? "öãºu±ed" : "acquúed"), 
£m
);

145  
ªt
;

146 
	}
}

149 
	$__up_wakeup
(
£m≠h‹e
 *
£m
)

159 
	`__£m_upd©e_cou¡
(
£m
, 1);

160 
	`wake_up
(&
£m
->
waô
);

161 
	}
}

163 
__sched


164 
	$down
(
£m≠h‹e
 *
£m
)

166 #ifde‡
WAITQUEUE_DEBUG


167 
	`CHECK_MAGIC
(
£m
->
__magic
);

169 #ifde‡
CONFIG_DEBUG_SEMAPHORE


170 
	`¥ötk
("%s(%d): down(%p) <count=%d> from %p\n",

171 
cuºít
->
comm
, cuºít->
pid
, 
£m
,

172 
	`©omic_ªad
(&
£m
->
cou¡
), 
	`__buûtö_ªtu∫_addªss
(0));

174 
	`__down
(
£m
);

175 
	}
}

177 
__sched


178 
	$down_öãºu±ibÀ
(
£m≠h‹e
 *
£m
)

180 #ifde‡
WAITQUEUE_DEBUG


181 
	`CHECK_MAGIC
(
£m
->
__magic
);

183 #ifde‡
CONFIG_DEBUG_SEMAPHORE


184 
	`¥ötk
("%s(%d): down(%p) <count=%d> from %p\n",

185 
cuºít
->
comm
, cuºít->
pid
, 
£m
,

186 
	`©omic_ªad
(&
£m
->
cou¡
), 
	`__buûtö_ªtu∫_addªss
(0));

188  
	`__down_öãºu±ibÀ
(
£m
);

189 
	}
}

192 
	$down_åylock
(
£m≠h‹e
 *
£m
)

194 
ªt
;

196 #ifde‡
WAITQUEUE_DEBUG


197 
	`CHECK_MAGIC
(
£m
->
__magic
);

200 
ªt
 = 
	`__down_åylock
(
£m
);

202 #ifde‡
CONFIG_DEBUG_SEMAPHORE


203 
	`¥ötk
("%s(%d): down_trylock %s from %p\n",

204 
cuºít
->
comm
, cuºít->
pid
,

205 
ªt
 ? "failed" : "acquired",

206 
	`__buûtö_ªtu∫_addªss
(0));

209  
ªt
;

210 
	}
}

213 
	$up
(
£m≠h‹e
 *
£m
)

215 #ifde‡
WAITQUEUE_DEBUG


216 
	`CHECK_MAGIC
(
£m
->
__magic
);

218 #ifde‡
CONFIG_DEBUG_SEMAPHORE


219 
	`¥ötk
("%s(%d): up(%p) <count=%d> from %p\n",

220 
cuºít
->
comm
, cuºít->
pid
, 
£m
,

221 
	`©omic_ªad
(&
£m
->
cou¡
), 
	`__buûtö_ªtu∫_addªss
(0));

223 
	`__up
(
£m
);

224 
	}
}

	@arch/alpha/kernel/setup.c

13 
	~<löux/sched.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/°ddef.h
>

17 
	~<löux/uni°d.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/¶ab.h
>

20 
	~<löux/u£r.h
>

21 
	~<löux/a.out.h
>

22 
	~<löux/s¸ìn_öfo.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/mc146818πc.h
>

25 
	~<löux/c⁄sﬁe.h
>

26 
	~<löux/˝u.h
>

27 
	~<löux/î∫o.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/°rög.h
>

30 
	~<löux/i›‹t.h
>

31 
	~<löux/∂©f‹m_devi˚.h
>

32 
	~<löux/boŸmem.h
>

33 
	~<löux/pci.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/roŸ_dev.h
>

36 
	~<löux/öôrd.h
>

37 
	~<löux/eiß.h
>

38 
	~<löux/p‚.h
>

39 #ifde‡
CONFIG_MAGIC_SYSRQ


40 
	~<löux/sy§q.h
>

41 
	~<löux/ªboŸ.h
>

43 
	~<löux/nŸifõr.h
>

44 
	~<asm/£tup.h
>

45 
	~<asm/io.h
>

46 
	~<löux/log2.h
>

48 
©omic_nŸifõr_hód
 
∑nic_nŸifõr_li°
;

49 
Æpha_∑nic_evít
(
nŸifõr_block
 *, , *);

50 
nŸifõr_block
 
	gÆpha_∑nic_block
 = {

51 
Æpha_∑nic_evít
,

52 
NULL
,

53 
INT_MAX


56 
	~<asm/uac˚ss.h
>

57 
	~<asm/pgèbÀ.h
>

58 
	~<asm/sy°em.h
>

59 
	~<asm/hwΩb.h
>

60 
	~<asm/dma.h
>

61 
	~<asm/io.h
>

62 
	~<asm/mmu_c⁄ãxt.h
>

63 
	~<asm/c⁄sﬁe.h
>

65 
	~"¥Ÿo.h
"

66 
	~"pci_im∂.h
"

69 
hwΩb_°ru˘
 *
	ghwΩb
;

70 
EXPORT_SYMBOL
(
hwΩb
);

71 
	g§m_h´
;

73 
	gÆpha_l1i_ˇchesh≠e
;

74 
	gÆpha_l1d_ˇchesh≠e
;

75 
	gÆpha_l2_ˇchesh≠e
;

76 
	gÆpha_l3_ˇchesh≠e
;

78 #ifde‡
CONFIG_VERBOSE_MCHECK


81 
	gÆpha_vîbo£_mcheck
 = 
CONFIG_VERBOSE_MCHECK_ON
;

85 
	gboŸ_˝uid
;

105 
	g§mc⁄s_ouçut
 = 0;

108 
	gmem_size_limô
 = 0;

111 
	gÆpha_agpg¨t_size
 = 
DEFAULT_AGP_APER_SIZE
;

113 #ifde‡
CONFIG_ALPHA_GENERIC


114 
Æpha_machöe_ve˘‹
 
	gÆpha_mv
;

115 
	gÆpha_usög_§m
;

116 
EXPORT_SYMBOL
(
Æpha_usög_§m
);

119 
Æpha_machöe_ve˘‹
 *
gë_sysvec
(, ,

121 
Æpha_machöe_ve˘‹
 *
gë_sysvec_by«me
(const *);

122 
gë_sy¢ames
(, , ,

124 
dëîmöe_˝u_ˇches
 ();

126 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

134 
s¸ìn_öfo
 
	gs¸ìn_öfo
 = {

135 .
‹ig_x
 = 0,

136 .
	g‹ig_y
 = 25,

137 .
	g‹ig_video_cﬁs
 = 80,

138 .
	g‹ig_video_löes
 = 25,

139 .
	g‹ig_video_isVGA
 = 1,

140 .
	g‹ig_video_poöts
 = 16

143 
EXPORT_SYMBOL
(
s¸ìn_öfo
);

150 
	g__dúe˘_m≠_ba£
;

151 
	g__dúe˘_m≠_size
;

152 
EXPORT_SYMBOL
(
__dúe˘_m≠_ba£
);

153 
EXPORT_SYMBOL
(
__dúe˘_m≠_size
);

163 
	#WEAK
(
X
) \

164 
Æpha_machöe_ve˘‹
 
X
; \

165 
	`asm
(".wók "#X)

	)

167 
WEAK
(
Æc‹_mv
);

168 
WEAK
(
Æphabook1_mv
);

169 
WEAK
(
av™ti_mv
);

170 
WEAK
(
ˇbriﬁë_mv
);

171 
WEAK
(
˛ù≥r_mv
);

172 
WEAK
(
dp264_mv
);

173 
WEAK
(
eb164_mv
);

174 
WEAK
(
eb64p_mv
);

175 
WEAK
(
eb66_mv
);

176 
WEAK
(
eb66p_mv
);

177 
WEAK
(
eigî_mv
);

178 
WEAK
(
jí£n_mv
);

179 
WEAK
(
lx164_mv
);

180 
WEAK
(
lynx_mv
);

181 
WEAK
(
m¨vñ_ev7_mv
);

182 
WEAK
(
müè_mv
);

183 
WEAK
(
mikaß_mv
);

184 
WEAK
(
mikaß_¥imo_mv
);

185 
WEAK
(
m⁄ë_mv
);

186 
WEAK
(
«utûus_mv
);

187 
WEAK
(
n⁄ame_mv
);

188 
WEAK
(
n‹ôake_mv
);

189 
WEAK
(
n‹ôake_¥imo_mv
);

190 
WEAK
(
p2k_mv
);

191 
WEAK
(
pc164_mv
);

192 
WEAK
(
¥iv©ìr_mv
);

193 
WEAK
(
øwhide_mv
);

194 
WEAK
(
ruffün_mv
);

195 
WEAK
(
rx164_mv
);

196 
WEAK
(
ßbÀ_mv
);

197 
WEAK
(
ßbÀ_gamma_mv
);

198 
WEAK
(
sh¨k_mv
);

199 
WEAK
(
sx164_mv
);

200 
WEAK
(
èk¨a_mv
);

201 
WEAK
(
tô™_mv
);

202 
WEAK
(
webbrick_mv
);

203 
WEAK
(
wûdfúe_mv
);

204 
WEAK
(
xl_mv
);

205 
WEAK
(
x…_mv
);

207 #unde‡
WEAK


217 
__öô


218 
	$ª£rve_°d_ªsour˚s
()

220 
ªsour˚
 
°™d¨d_io_ªsour˚s
[] = {

221 { .
«me
 = "πc", .
°¨t
 = -1, .
íd
 = -1 },

222 { .
«me
 = "dma1", .
°¨t
 = 0x00, .
íd
 = 0x1f },

223 { .
«me
 = "pic1", .
°¨t
 = 0x20, .
íd
 = 0x3f },

224 { .
«me
 = "timî", .
°¨t
 = 0x40, .
íd
 = 0x5f },

225 { .
«me
 = "keybﬂrd", .
°¨t
 = 0x60, .
íd
 = 0x6f },

226 { .
«me
 = "dm®∑gêªg", .
°¨t
 = 0x80, .
íd
 = 0x8f },

227 { .
«me
 = "pic2", .
°¨t
 = 0xa0, .
íd
 = 0xbf },

228 { .
«me
 = "dma2", .
°¨t
 = 0xc0, .
íd
 = 0xdf },

231 
ªsour˚
 *
io
 = &
i›‹t_ªsour˚
;

232 
size_t
 
i
;

234 i‡(
ho£_hód
) {

235 
pci_c⁄åﬁÀr
 *
ho£
;

236 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
)

237 i‡(
ho£
->
ödex
 == 0) {

238 
io
 = 
ho£
->
io_•a˚
;

244 
°™d¨d_io_ªsour˚s
[0].
°¨t
 = 
	`RTC_PORT
(0);

245 
°™d¨d_io_ªsour˚s
[0].
íd
 = 
	`RTC_PORT
(0) + 0x10;

247 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_io_ªsour˚s
); ++i)

248 
	`ªque°_ªsour˚
(
io
, 
°™d¨d_io_ªsour˚s
+
i
);

249 
	}
}

251 
	#PFN_MAX
 
	`PFN_DOWN
(0x80000000)

	)

252 
	#f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) \

253 (
˛u°î
Ë(
memdesc
)->˛u°î, (
i
) = 0; \

254 (
i
Ë< (
memdesc
)->
num˛u°îs
; (i)++, (
˛u°î
)++)

	)

256 
__öô


257 
	$gë_mem_size_limô
(*
s
)

259 
íd
 = 0;

260 *
‰om
 = 
s
;

262 
íd
 = 
	`sim∂e_°πoul
(
‰om
, &from, 0);

263 i‡–*
‰om
 == 'K' || *from == 'k' ) {

264 
íd
 =Énd << 10;

265 
‰om
++;

266 } i‡–*
‰om
 == 'M' || *from == 'm' ) {

267 
íd
 =Énd << 20;

268 
‰om
++;

269 } i‡–*
‰om
 == 'G' || *from == 'g' ) {

270 
íd
 =Énd << 30;

271 
‰om
++;

273  
íd
 >> 
PAGE_SHIFT
;

274 
	}
}

276 #ifde‡
CONFIG_BLK_DEV_INITRD


277 * 
__öô


278 
	$move_öôrd
(
mem_limô
)

280 *
°¨t
;

281 
size
;

283 
size
 = 
öôrd_íd
 - 
öôrd_°¨t
;

284 
°¨t
 = 
	`__Æloc_boŸmem
(
	`PAGE_ALIGN
(
size
), 
PAGE_SIZE
, 0);

285 i‡(!
°¨t
 || 
	`__∑
(°¨tË+ 
size
 > 
mem_limô
) {

286 
öôrd_°¨t
 = 
öôrd_íd
 = 0;

287  
NULL
;

289 
	`memmove
(
°¨t
, (*)
öôrd_°¨t
, 
size
);

290 
öôrd_°¨t
 = ()
°¨t
;

291 
öôrd_íd
 = 
öôrd_°¨t
 + 
size
;

292 
	`¥ötk
("öôrd movedÅÿ%p\n", 
°¨t
);

293  
°¨t
;

294 
	}
}

297 #i‚de‡
CONFIG_DISCONTIGMEM


298 
__öô


299 
	$£tup_mem‹y
(*
kî√l_íd
)

301 
mem˛u°_°ru˘
 * 
˛u°î
;

302 
memdesc_°ru˘
 * 
memdesc
;

303 
°¨t_kî√l_p‚
, 
íd_kî√l_p‚
;

304 
boŸm≠_size
, 
boŸm≠_∑ges
, 
boŸm≠_°¨t
;

305 
°¨t
, 
íd
;

306 
i
;

309 
memdesc
 = (
memdesc_°ru˘
 *)

310 (
hwΩb
->
mddt_off£t
 + () hwrpb);

312 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

313 
	`¥ötk
("memcluster %lu, usage %01lx, start %8lu,Énd %8lu\n",

314 
i
, 
˛u°î
->
ußge
, clu°î->
°¨t_p‚
,

315 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
);

320 i‡(
˛u°î
->
ußge
 & 3)

323 
íd
 = 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
;

324 i‡(
íd
 > 
max_low_p‚
)

325 
max_low_p‚
 = 
íd
;

343 i‡(!
mem_size_limô
)

344 
mem_size_limô
 = (32u»* 1024 * 1024 * 1024Ë>> 
PAGE_SHIFT
;

346 i‡(
mem_size_limô
 && 
max_low_p‚
 >= mem_size_limit)

348 
	`¥ötk
("setup: forcing memory sizeÅo %ldK (from %ldK).\n",

349 
mem_size_limô
 << (
PAGE_SHIFT
 - 10),

350 
max_low_p‚
 << (
PAGE_SHIFT
 - 10));

351 
max_low_p‚
 = 
mem_size_limô
;

355 
°¨t_kî√l_p‚
 = 
	`PFN_DOWN
(
KERNEL_START_PHYS
);

356 
íd_kî√l_p‚
 = 
	`PFN_UP
(
	`vút_to_phys
(
kî√l_íd
));

357 
boŸm≠_°¨t
 = -1;

359 
åy_agaö
:

360 i‡(
max_low_p‚
 <
íd_kî√l_p‚
)

361 
	`∑nic
("notÉnough memoryÅo boot");

365 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
max_low_p‚
);

368 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

369 i‡(
˛u°î
->
ußge
 & 3)

372 
°¨t
 = 
˛u°î
->
°¨t_p‚
;

373 
íd
 = 
°¨t
 + 
˛u°î
->
num∑ges
;

374 i‡(
°¨t
 >
max_low_p‚
)

376 i‡(
íd
 > 
max_low_p‚
)

377 
íd
 = 
max_low_p‚
;

378 i‡(
°¨t
 < 
°¨t_kî√l_p‚
) {

379 i‡(
íd
 > 
íd_kî√l_p‚


380 && 
íd
 - 
íd_kî√l_p‚
 >
boŸm≠_∑ges
) {

381 
boŸm≠_°¨t
 = 
íd_kî√l_p‚
;

383 } i‡(
íd
 > 
°¨t_kî√l_p‚
)

384 
íd
 = 
°¨t_kî√l_p‚
;

385 } i‡(
°¨t
 < 
íd_kî√l_p‚
)

386 
°¨t
 = 
íd_kî√l_p‚
;

387 i‡(
íd
 - 
°¨t
 >
boŸm≠_∑ges
) {

388 
boŸm≠_°¨t
 = 
°¨t
;

393 i‡(
boŸm≠_°¨t
 == ~0UL) {

394 
max_low_p‚
 >>= 1;

395 
åy_agaö
;

399 
boŸm≠_size
 = 
	`öô_boŸmem
(
boŸm≠_°¨t
, 
max_low_p‚
);

402 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

403 i‡(
˛u°î
->
ußge
 & 3)

406 
°¨t
 = 
˛u°î
->
°¨t_p‚
;

407 
íd
 = 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
;

408 i‡(
°¨t
 >
max_low_p‚
)

410 i‡(
íd
 > 
max_low_p‚
)

411 
íd
 = 
max_low_p‚
;

412 i‡(
°¨t
 < 
°¨t_kî√l_p‚
) {

413 i‡(
íd
 > 
íd_kî√l_p‚
) {

414 
	`‰ì_boŸmem
(
	`PFN_PHYS
(
°¨t
),

415 (
	`PFN_PHYS
(
°¨t_kî√l_p‚
)

416 - 
	`PFN_PHYS
(
°¨t
)));

417 
	`¥ötk
("freeingÖages %ld:%ld\n",

418 
°¨t
, 
°¨t_kî√l_p‚
);

419 
°¨t
 = 
íd_kî√l_p‚
;

420 } i‡(
íd
 > 
°¨t_kî√l_p‚
)

421 
íd
 = 
°¨t_kî√l_p‚
;

422 } i‡(
°¨t
 < 
íd_kî√l_p‚
)

423 
°¨t
 = 
íd_kî√l_p‚
;

424 i‡(
°¨t
 >
íd
)

427 
	`‰ì_boŸmem
(
	`PFN_PHYS
(
°¨t
), PFN_PHYS(
íd
) - PFN_PHYS(start));

428 
	`¥ötk
("‰ìögÖage†%ld:%ld\n", 
°¨t
, 
íd
);

432 
	`ª£rve_boŸmem
(
	`PFN_PHYS
(
boŸm≠_°¨t
), 
boŸm≠_size
);

433 
	`¥ötk
("ª£rvögÖage†%ld:%ld\n", 
boŸm≠_°¨t
, boŸm≠_°¨t+
	`PFN_UP
(
boŸm≠_size
));

435 #ifde‡
CONFIG_BLK_DEV_INITRD


436 
öôrd_°¨t
 = 
INITRD_START
;

437 i‡(
öôrd_°¨t
) {

438 
öôrd_íd
 = 
öôrd_°¨t
+
INITRD_SIZE
;

439 
	`¥ötk
("InitialÑamdiskát: 0x%p (%lu bytes)\n",

440 (*Ë
öôrd_°¨t
, 
INITRD_SIZE
);

442 i‡((*)
öôrd_íd
 > 
	`phys_to_vút
(
	`PFN_PHYS
(
max_low_p‚
))) {

443 i‡(!
	`move_öôrd
(
	`PFN_PHYS
(
max_low_p‚
)))

444 
	`¥ötk
("initrdÉxtends beyondÉnd of memory "

446 
öôrd_íd
,

447 
	`phys_to_vút
(
	`PFN_PHYS
(
max_low_p‚
)));

449 
	`ª£rve_boŸmem
(
	`vút_to_phys
((*)
öôrd_°¨t
),

450 
INITRD_SIZE
);

454 
	}
}

456 
£tup_mem‹y
(*);

459 
__öô


460 
	$∑ge_is_øm
(
p‚
)

462 
mem˛u°_°ru˘
 * 
˛u°î
;

463 
memdesc_°ru˘
 * 
memdesc
;

464 
i
;

466 
memdesc
 = (
memdesc_°ru˘
 *)

467 (
hwΩb
->
mddt_off£t
 + () hwrpb);

468 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
)

470 i‡(
p‚
 >
˛u°î
->
°¨t_p‚
 &&

471 
p‚
 < 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
) {

472  (
˛u°î
->
ußge
 & 3) ? 0 : 1;

477 
	}
}

479 
__öô


480 
	$ªgi°î_˝us
()

482 
i
;

484 
	`f‹_óch_possibÀ_˝u
(
i
) {

485 
˝u
 *
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

486 i‡(!
p
)

487  -
ENOMEM
;

488 
	`ªgi°î_˝u
(
p
, 
i
);

491 
	}
}

493 
¨ch_öôˇŒ
(
ªgi°î_˝us
);

495 
__öô


496 
	$£tup_¨ch
(**
cmdlöe_p
)

498 
_íd
[];

500 
Æpha_machöe_ve˘‹
 *
vec
 = 
NULL
;

501 
≥r˝u_°ru˘
 *
˝u
;

502 *
ty≥_«me
, *
v¨_«me
, *
p
;

503 *
kî√l_íd
 = 
_íd
;

504 *
¨gs
 = 
comm™d_löe
;

506 
hwΩb
 = (
hwΩb_°ru˘
*Ë
	`__va
(
INIT_HWRPB
->
phys_addr
);

507 
boŸ_˝uid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

519 i‡(()
hwΩb
->
sys_ty≥
 < 0) {

520 
hwΩb
->
sys_ty≥
 = -(()hwrpb->sys_type);

521 
	`hwΩb_upd©e_checksum
(
hwΩb
);

525 
	`©omic_nŸifõr_chaö_ªgi°î
(&
∑nic_nŸifõr_li°
,

526 &
Æpha_∑nic_block
);

528 #ifde‡
CONFIG_ALPHA_GENERIC


531 
Æpha_usög_§m
 = 
	`°∫cmp
((c⁄° *)
hwΩb
->
s¢
, "MILO", 4) != 0;

538 
kî√l_íd
 = 
	`ˇŒback_öô
(kernel_end);

546 i‡(
	`°rcmp
(
COMMAND_LINE
, "INSTALL") == 0) {

547 
	`°æ˝y
(
comm™d_löe
, "root=/dev/fd0Üoad_ramdisk=1",  command_line);

549 
	`°æ˝y
(
comm™d_löe
, 
COMMAND_LINE
,  command_line);

551 
	`°r˝y
(
boŸ_comm™d_löe
, 
comm™d_löe
);

552 *
cmdlöe_p
 = 
comm™d_löe
;

557 (
p
 = 
	`°r£p
(&
¨gs
, " \t")Ë!
NULL
) {

558 i‡(!*
p
) ;

559 i‡(
	`°∫cmp
(
p
, "alpha_mv=", 9) == 0) {

560 
vec
 = 
	`gë_sysvec_by«me
(
p
+9);

563 i‡(
	`°∫cmp
(
p
, "cycle=", 6) == 0) {

564 
e°_cy˛e_‰eq
 = 
	`sim∂e_°πﬁ
(
p
+6, 
NULL
, 0);

567 i‡(
	`°∫cmp
(
p
, "mem=", 4) == 0) {

568 
mem_size_limô
 = 
	`gë_mem_size_limô
(
p
+4);

571 i‡(
	`°∫cmp
(
p
, "srmcons", 7) == 0) {

572 
§mc⁄s_ouçut
 |= 1;

575 i‡(
	`°∫cmp
(
p
, "console=srm", 11) == 0) {

576 
§mc⁄s_ouçut
 |= 2;

579 i‡(
	`°∫cmp
(
p
, "gartsize=", 9) == 0) {

580 
Æpha_agpg¨t_size
 =

581 
	`gë_mem_size_limô
(
p
+9Ë<< 
PAGE_SHIFT
;

584 #ifde‡
CONFIG_VERBOSE_MCHECK


585 i‡(
	`°∫cmp
(
p
, "verbose_mcheck=", 15) == 0) {

586 
Æpha_vîbo£_mcheck
 = 
	`sim∂e_°πﬁ
(
p
+15, 
NULL
, 0);

593 
	`°r˝y
(
comm™d_löe
, 
boŸ_comm™d_löe
);

596 i‡(
Æpha_usög_§m
 && 
§mc⁄s_ouçut
) {

597 
	`ªgi°î_§m_c⁄sﬁe
();

603 i‡(
§mc⁄s_ouçut
 & 2)

604 
§mc⁄s_ouçut
 = 0;

607 #ifde‡
CONFIG_MAGIC_SYSRQ


610 i‡(
Æpha_usög_§m
) {

611 
sy§q_key_›
 *
›
 = 
	`__sy§q_gë_key_›
('b');

612 
›
->
h™dÀr
 = (*Ë
machöe_hÆt
;

619 
˝u
 = (
≥r˝u_°ru˘
*)((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

621 
	`gë_sy¢ames
(
hwΩb
->
sys_ty≥
, hwΩb->
sys_v¨üti⁄
,

622 
˝u
->
ty≥
, &
ty≥_«me
, &
v¨_«me
);

623 i‡(*
v¨_«me
 == '0')

624 
v¨_«me
 = "";

626 i‡(!
vec
) {

627 
vec
 = 
	`gë_sysvec
(
hwΩb
->
sys_ty≥
, hwΩb->
sys_v¨üti⁄
,

628 
˝u
->
ty≥
);

631 i‡(!
vec
) {

632 
	`∑nic
("Unsupported systemÅype: %s%s%s (%ld %ld)\n",

633 
ty≥_«me
, (*
v¨_«me
 ? " variation " : ""), var_name,

634 
hwΩb
->
sys_ty≥
, hwΩb->
sys_v¨üti⁄
);

636 i‡(
vec
 !&
Æpha_mv
) {

637 
Æpha_mv
 = *
vec
;

640 
	`¥ötk
("Booting "

641 #ifde‡
CONFIG_ALPHA_GENERIC


645 
ty≥_«me
, (*
v¨_«me
 ? " variation " : ""),

646 
v¨_«me
, 
Æpha_mv
.
ve˘‹_«me
,

647 (
Æpha_usög_§m
 ? "SRM" : "MILO"));

649 
	`¥ötk
("Major Options: "

650 #ifde‡
CONFIG_SMP


653 #ifde‡
CONFIG_ALPHA_EV56


656 #ifde‡
CONFIG_ALPHA_EV67


659 #ifde‡
CONFIG_ALPHA_LEGACY_START_ADDRESS


662 #ifde‡
CONFIG_VERBOSE_MCHECK


666 #ifde‡
CONFIG_DISCONTIGMEM


668 #ifde‡
CONFIG_NUMA


673 #ifde‡
CONFIG_DEBUG_SPINLOCK


676 #ifde‡
CONFIG_MAGIC_SYSRQ


681 
	`¥ötk
("Comm™dÜöe: %s\n", 
comm™d_löe
);

687 
§m_h´
 = *
Æpha_mv
.
h´_ªgi°î
;

688 
	`__£t_h´
(
Æpha_mv
.
h´_ˇche
);

691 
	`wrm˚s
(0x7);

694 
	`£tup_mem‹y
(
kî√l_íd
);

697 
	`dëîmöe_˝u_ˇches
(
˝u
->
ty≥
);

701 i‡(
Æpha_mv
.
öô_¨ch
)

702 
Æpha_mv
.
	`öô_¨ch
();

705 
	`ª£rve_°d_ªsour˚s
();

712 #ifde‡
CONFIG_VT


713 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

714 
c⁄swôchp
 = &
vga_c⁄
;

715 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

716 
c⁄swôchp
 = &
dummy_c⁄
;

721 
ROOT_DEV
 = 
RoŸ_SDA2
;

723 #ifde‡
CONFIG_EISA


725 
EISA_bus
 = 1;

734 i‡(
hwΩb
->
max_a¢
 !
MAX_ASN
) {

735 
	`¥ötk
("Max ASN from HWRPB i†bad (0x%lx)\n", 
hwΩb
->
max_a¢
);

742 #ifde‡
CONFIG_SMP


743 
	`£tup_smp
();

745 
	`∑gög_öô
();

746 
	}
}

748 
	gsys_unknown
[] = "Unknown";

749 
	gsy°y≥_«mes
[][16] = {

760 
	gunofficül_«mes
[][8] = {"100", "Ruffian"};

762 
	g≠i_«mes
[][16] = {"200", "Nautilus"};

764 
	geb164_«mes
[][8] = {"EB164", "PC164", "LX164", "SX164", "RX164"};

765 
	geb164_ödi˚s
[] = {0,0,0,1,1,1,1,1,2,2,2,2,3,3,3,3,4};

767 
	gÆc‹_«mes
[][16] = {"Alcor", "Maverick", "Bret"};

768 
	gÆc‹_ödi˚s
[] = {0,0,0,1,1,1,0,0,0,0,0,0,2,2,2,2,2,2};

770 
	geb64p_«mes
[][16] = {"EB64+", "Cabriolet", "AlphaPCI64"};

771 
	geb64p_ödi˚s
[] = {0,0,1,2};

773 
	geb66_«mes
[][8] = {"EB66", "EB66+"};

774 
	geb66_ödi˚s
[] = {0,0,1};

776 
	gm¨vñ_«mes
[][16] = {

779 
	gm¨vñ_ödi˚s
[] = { 0 };

781 
	gøwhide_«mes
[][16] = {

784 
	gøwhide_ödi˚s
[] = {0,0,0,1,1,2,2,3,3,4,4};

786 
	gtô™_«mes
[][16] = {

789 
	gtô™_ödi˚s
[] = {0,1,2,2,3};

791 
	gtsu«mi_«mes
[][16] = {

796 
	gtsu«mi_ödi˚s
[] = {0,1,2,3,4,5,6,7,8,9,10,11,12};

798 
Æpha_machöe_ve˘‹
 * 
__öô


799 
	$gë_sysvec
(
ty≥
, 
v¨üti⁄
, 
˝u
)

801 
Æpha_machöe_ve˘‹
 *
sy°y≥_vecs
[] 
__öôd©a
 =

803 
NULL
,

804 
NULL
,

805 
NULL
,

806 
NULL
,

807 
NULL
,

808 
NULL
,

809 &
jí£n_mv
,

810 
NULL
,

811 
NULL
,

812 
NULL
,

813 
NULL
,

814 &
n⁄ame_mv
,

815 
NULL
,

816 &
av™ti_mv
,

817 
NULL
,

818 
NULL
,

819 
NULL
,

820 
NULL
,

821 
NULL
,

822 
NULL
,

823 
NULL
,

824 &
Æphabook1_mv
,

825 &
øwhide_mv
,

826 
NULL
,

827 &
lynx_mv
,

828 &
xl_mv
,

829 
NULL
,

830 
NULL
,

831 
NULL
,

832 
NULL
,

833 &
müè_mv
,

834 
NULL
,

835 &
èk¨a_mv
,

836 
NULL
,

837 
NULL
,

838 &
wûdfúe_mv
,

839 
NULL
,

840 &
eigî_mv
,

841 
NULL
,

842 
NULL
,

845 
Æpha_machöe_ve˘‹
 *
unofficül_vecs
[] 
__öôd©a
 =

847 
NULL
,

848 &
ruffün_mv
,

851 
Æpha_machöe_ve˘‹
 *
≠i_vecs
[] 
__öôd©a
 =

853 
NULL
,

854 &
«utûus_mv
,

857 
Æpha_machöe_ve˘‹
 *
Æc‹_vecs
[] 
__öôd©a
 =

859 &
Æc‹_mv
, &
x…_mv
, &xlt_mv

862 
Æpha_machöe_ve˘‹
 *
eb164_vecs
[] 
__öôd©a
 =

864 &
eb164_mv
, &
pc164_mv
, &
lx164_mv
, &
sx164_mv
, &
rx164_mv


867 
Æpha_machöe_ve˘‹
 *
eb64p_vecs
[] 
__öôd©a
 =

869 &
eb64p_mv
,

870 &
ˇbriﬁë_mv
,

871 &
ˇbriﬁë_mv


874 
Æpha_machöe_ve˘‹
 *
eb66_vecs
[] 
__öôd©a
 =

876 &
eb66_mv
,

877 &
eb66p_mv


880 
Æpha_machöe_ve˘‹
 *
m¨vñ_vecs
[] 
__öôd©a
 =

882 &
m¨vñ_ev7_mv
,

885 
Æpha_machöe_ve˘‹
 *
tô™_vecs
[] 
__öôd©a
 =

887 &
tô™_mv
,

888 &
¥iv©ìr_mv
,

889 &
tô™_mv
,

890 &
¥iv©ìr_mv
,

893 
Æpha_machöe_ve˘‹
 *
tsu«mi_vecs
[] 
__öôd©a
 =

895 
NULL
,

896 &
dp264_mv
,

897 &
dp264_mv
,

898 &
dp264_mv
,

899 &
m⁄ë_mv
,

900 &
˛ù≥r_mv
,

901 &
dp264_mv
,

902 &
webbrick_mv
,

903 &
dp264_mv
,

904 
NULL
,

905 
NULL
,

906 
NULL
,

907 &
sh¨k_mv
,

912 
Æpha_machöe_ve˘‹
 *
vec
;

915 
vec
 = 
NULL
;

916 i‡(
ty≥
 < 
	`ARRAY_SIZE
(
sy°y≥_vecs
)) {

917 
vec
 = 
sy°y≥_vecs
[
ty≥
];

918 } i‡((
ty≥
 > 
ST_API_BIAS
) &&

919 (
ty≥
 - 
ST_API_BIAS
Ë< 
	`ARRAY_SIZE
(
≠i_vecs
)) {

920 
vec
 = 
≠i_vecs
[
ty≥
 - 
ST_API_BIAS
];

921 } i‡((
ty≥
 > 
ST_UNOFFICIAL_BIAS
) &&

922 (
ty≥
 - 
ST_UNOFFICIAL_BIAS
Ë< 
	`ARRAY_SIZE
(
unofficül_vecs
)) {

923 
vec
 = 
unofficül_vecs
[
ty≥
 - 
ST_UNOFFICIAL_BIAS
];

928 i‡(!
vec
) {

930 
membî
 = (
v¨üti⁄
 >> 10) & 0x3f;

932 
˝u
 &= 0xffffffff;

934 
ty≥
) {

935 
ST_DEC_ALCOR
:

936 i‡(
membî
 < 
	`ARRAY_SIZE
(
Æc‹_ödi˚s
))

937 
vec
 = 
Æc‹_vecs
[
Æc‹_ödi˚s
[
membî
]];

939 
ST_DEC_EB164
:

940 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb164_ödi˚s
))

941 
vec
 = 
eb164_vecs
[
eb164_ödi˚s
[
membî
]];

944 i‡(
vec
 =&
eb164_mv
 && 
˝u
 =
EV56_CPU
)

945 
vec
 = &
pc164_mv
;

947 
ST_DEC_EB64P
:

948 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb64p_ödi˚s
))

949 
vec
 = 
eb64p_vecs
[
eb64p_ödi˚s
[
membî
]];

951 
ST_DEC_EB66
:

952 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb66_ödi˚s
))

953 
vec
 = 
eb66_vecs
[
eb66_ödi˚s
[
membî
]];

955 
ST_DEC_MARVEL
:

956 i‡(
membî
 < 
	`ARRAY_SIZE
(
m¨vñ_ödi˚s
))

957 
vec
 = 
m¨vñ_vecs
[
m¨vñ_ödi˚s
[
membî
]];

959 
ST_DEC_TITAN
:

960 
vec
 = 
tô™_vecs
[0];

961 i‡(
membî
 < 
	`ARRAY_SIZE
(
tô™_ödi˚s
))

962 
vec
 = 
tô™_vecs
[
tô™_ödi˚s
[
membî
]];

964 
ST_DEC_TSUNAMI
:

965 i‡(
membî
 < 
	`ARRAY_SIZE
(
tsu«mi_ödi˚s
))

966 
vec
 = 
tsu«mi_vecs
[
tsu«mi_ödi˚s
[
membî
]];

968 
ST_DEC_1000
:

969 i‡(
˝u
 =
EV5_CPU
 || cpu =
EV56_CPU
)

970 
vec
 = &
mikaß_¥imo_mv
;

972 
vec
 = &
mikaß_mv
;

974 
ST_DEC_NORITAKE
:

975 i‡(
˝u
 =
EV5_CPU
 || cpu =
EV56_CPU
)

976 
vec
 = &
n‹ôake_¥imo_mv
;

978 
vec
 = &
n‹ôake_mv
;

980 
ST_DEC_2100_A500
:

981 i‡(
˝u
 =
EV5_CPU
 || cpu =
EV56_CPU
)

982 
vec
 = &
ßbÀ_gamma_mv
;

984 
vec
 = &
ßbÀ_mv
;

988  
vec
;

989 
	}
}

991 
Æpha_machöe_ve˘‹
 * 
__öô


992 
	$gë_sysvec_by«me
(c⁄° *
«me
)

994 
Æpha_machöe_ve˘‹
 *
Æl_vecs
[] 
__öôd©a
 =

996 &
Æc‹_mv
,

997 &
Æphabook1_mv
,

998 &
av™ti_mv
,

999 &
ˇbriﬁë_mv
,

1000 &
˛ù≥r_mv
,

1001 &
dp264_mv
,

1002 &
eb164_mv
,

1003 &
eb64p_mv
,

1004 &
eb66_mv
,

1005 &
eb66p_mv
,

1006 &
eigî_mv
,

1007 &
jí£n_mv
,

1008 &
lx164_mv
,

1009 &
lynx_mv
,

1010 &
müè_mv
,

1011 &
mikaß_mv
,

1012 &
mikaß_¥imo_mv
,

1013 &
m⁄ë_mv
,

1014 &
«utûus_mv
,

1015 &
n⁄ame_mv
,

1016 &
n‹ôake_mv
,

1017 &
n‹ôake_¥imo_mv
,

1018 &
p2k_mv
,

1019 &
pc164_mv
,

1020 &
¥iv©ìr_mv
,

1021 &
øwhide_mv
,

1022 &
ruffün_mv
,

1023 &
rx164_mv
,

1024 &
ßbÀ_mv
,

1025 &
ßbÀ_gamma_mv
,

1026 &
sh¨k_mv
,

1027 &
sx164_mv
,

1028 &
èk¨a_mv
,

1029 &
webbrick_mv
,

1030 &
wûdfúe_mv
,

1031 &
xl_mv
,

1032 &
x…_mv


1035 
size_t
 
i
;

1037 
i
 = 0; i < 
	`ARRAY_SIZE
(
Æl_vecs
); ++i) {

1038 
Æpha_machöe_ve˘‹
 *
mv
 = 
Æl_vecs
[
i
];

1039 i‡(
	`°rˇ£cmp
(
mv
->
ve˘‹_«me
, 
«me
) == 0)

1040  
mv
;

1042  
NULL
;

1043 
	}
}

1046 
	$gë_sy¢ames
(
ty≥
, 
v¨üti⁄
, 
˝u
,

1047 **
ty≥_«me
, **
v¨üti⁄_«me
)

1049 
membî
;

1053 i‡(
ty≥
 < 
	`ARRAY_SIZE
(
sy°y≥_«mes
)) {

1054 *
ty≥_«me
 = 
sy°y≥_«mes
[
ty≥
];

1055 } i‡((
ty≥
 > 
ST_API_BIAS
) &&

1056 (
ty≥
 - 
ST_API_BIAS
Ë< 
	`ARRAY_SIZE
(
≠i_«mes
)) {

1057 *
ty≥_«me
 = 
≠i_«mes
[
ty≥
 - 
ST_API_BIAS
];

1058 } i‡((
ty≥
 > 
ST_UNOFFICIAL_BIAS
) &&

1059 (
ty≥
 - 
ST_UNOFFICIAL_BIAS
Ë< 
	`ARRAY_SIZE
(
unofficül_«mes
)) {

1060 *
ty≥_«me
 = 
unofficül_«mes
[
ty≥
 - 
ST_UNOFFICIAL_BIAS
];

1062 *
ty≥_«me
 = 
sys_unknown
;

1063 *
v¨üti⁄_«me
 = 
sys_unknown
;

1068 *
v¨üti⁄_«me
 = 
sy°y≥_«mes
[0];

1069 i‡(
v¨üti⁄
 == 0) {

1073 
membî
 = (
v¨üti⁄
 >> 10) & 0x3f;

1075 
˝u
 &= 0xffffffff;

1077 
ty≥
) {

1080 
ST_DEC_EB164
:

1081 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb164_ödi˚s
))

1082 *
v¨üti⁄_«me
 = 
eb164_«mes
[
eb164_ödi˚s
[
membî
]];

1085 i‡(
eb164_ödi˚s
[
membî
] =0 && 
˝u
 =
EV56_CPU
)

1086 *
v¨üti⁄_«me
 = 
eb164_«mes
[1];

1088 
ST_DEC_ALCOR
:

1089 i‡(
membî
 < 
	`ARRAY_SIZE
(
Æc‹_ödi˚s
))

1090 *
v¨üti⁄_«me
 = 
Æc‹_«mes
[
Æc‹_ödi˚s
[
membî
]];

1092 
ST_DEC_EB64P
:

1093 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb64p_ödi˚s
))

1094 *
v¨üti⁄_«me
 = 
eb64p_«mes
[
eb64p_ödi˚s
[
membî
]];

1096 
ST_DEC_EB66
:

1097 i‡(
membî
 < 
	`ARRAY_SIZE
(
eb66_ödi˚s
))

1098 *
v¨üti⁄_«me
 = 
eb66_«mes
[
eb66_ödi˚s
[
membî
]];

1100 
ST_DEC_MARVEL
:

1101 i‡(
membî
 < 
	`ARRAY_SIZE
(
m¨vñ_ödi˚s
))

1102 *
v¨üti⁄_«me
 = 
m¨vñ_«mes
[
m¨vñ_ödi˚s
[
membî
]];

1104 
ST_DEC_RAWHIDE
:

1105 i‡(
membî
 < 
	`ARRAY_SIZE
(
øwhide_ödi˚s
))

1106 *
v¨üti⁄_«me
 = 
øwhide_«mes
[
øwhide_ödi˚s
[
membî
]];

1108 
ST_DEC_TITAN
:

1109 *
v¨üti⁄_«me
 = 
tô™_«mes
[0];

1110 i‡(
membî
 < 
	`ARRAY_SIZE
(
tô™_ödi˚s
))

1111 *
v¨üti⁄_«me
 = 
tô™_«mes
[
tô™_ödi˚s
[
membî
]];

1113 
ST_DEC_TSUNAMI
:

1114 i‡(
membî
 < 
	`ARRAY_SIZE
(
tsu«mi_ödi˚s
))

1115 *
v¨üti⁄_«me
 = 
tsu«mi_«mes
[
tsu«mi_ödi˚s
[
membî
]];

1118 
	}
}

1135 
	$∂©f‹m_°rög
()

1137 
d§_°ru˘
 *
d§
;

1138 
unk_sy°em_°rög
[] = "N/A";

1144 i‡(
hwΩb
->
ªvisi⁄
 < 5)

1145  (
unk_sy°em_°rög
);

1151 
d§
 = ((
d§_°ru˘
 *)

1152 ((*)
hwΩb
 + hwΩb->
d§_off£t
));

1153  ((*)
d§
 + (d§->
sy¢ame_off
 +

1156 
	}
}

1159 
	$gë_ƒ_¥o˚ss‹s
(
≥r˝u_°ru˘
 *
˝uba£
, 
num
)

1161 
≥r˝u_°ru˘
 *
˝u
;

1162 
i
;

1163 
cou¡
 = 0;

1165 
i
 = 0; i < 
num
; i++) {

1166 
˝u
 = (
≥r˝u_°ru˘
 *)

1167 ((*)
˝uba£
 + 
i
*
hwΩb
->
¥o˚ss‹_size
);

1168 i‡((
˝u
->
Êags
 & 0x1cc) == 0x1cc)

1169 
cou¡
++;

1171  
cou¡
;

1172 
	}
}

1175 
	$show_ˇche_size
 (
£q_fûe
 *
f
, c⁄° *
which
, 
sh≠e
)

1177 i‡(
sh≠e
 == -1)

1178 
	`£q_¥ötf
 (
f
, "%s\t\t:Ç/a\n", 
which
);

1179 i‡(
sh≠e
 == 0)

1180 
	`£q_¥ötf
 (
f
, "%s\t\t: unknown\n", 
which
);

1182 
	`£q_¥ötf
 (
f
, "%s\t\t: %dK, %d-way, %dbÜine\n",

1183 
which
, 
sh≠e
 >> 10, shape & 15,

1184 1 << ((
sh≠e
 >> 4) & 15));

1185 
	}
}

1188 
	$show_˝uöfo
(
£q_fûe
 *
f
, *
¶Ÿ
)

1190 
	su«lig√d_°©
 {

1191 
cou¡
, 
va
, 
pc
;

1192 } 
u«lig√d
[2];

1194 
˝u_«mes
[][8] = {

1200 
≥r˝u_°ru˘
 *
˝u
 = 
¶Ÿ
;

1201 
˝u_ödex
;

1202 *
˝u_«me
;

1203 *
sy°y≥_«me
;

1204 *
sysv¨üti⁄_«me
;

1205 
ƒ_¥o˚ss‹s
;

1207 
˝u_ödex
 = (Ë(
˝u
->
ty≥
 - 1);

1208 
˝u_«me
 = "Unknown";

1209 i‡(
˝u_ödex
 < 
	`ARRAY_SIZE
(
˝u_«mes
))

1210 
˝u_«me
 = 
˝u_«mes
[
˝u_ödex
];

1212 
	`gë_sy¢ames
(
hwΩb
->
sys_ty≥
, hwΩb->
sys_v¨üti⁄
,

1213 
˝u
->
ty≥
, &
sy°y≥_«me
, &
sysv¨üti⁄_«me
);

1215 
ƒ_¥o˚ss‹s
 = 
	`gë_ƒ_¥o˚ss‹s
(
˝u
, 
hwΩb
->nr_processors);

1217 
	`£q_¥ötf
(
f
, "cpu\t\t\t: Alpha\n"

1236 
˝u_«me
, 
˝u
->
v¨üti⁄
, cpu->
ªvisi⁄
,

1237 (*)
˝u
->
£rül_no
,

1238 
sy°y≥_«me
, 
sysv¨üti⁄_«me
, 
hwΩb
->
sys_ªvisi⁄
,

1239 (*)
hwΩb
->
s¢
,

1240 
e°_cy˛e_‰eq
 ? : 
hwΩb
->
cy˛e_‰eq
,

1241 
e°_cy˛e_‰eq
 ? "est." : "",

1242 
hwΩb
->
öå_‰eq
 / 4096,

1243 (100 * 
hwΩb
->
öå_‰eq
 / 4096) % 100,

1244 
hwΩb
->
∑gesize
,

1245 
hwΩb
->
∑_bôs
,

1246 
hwΩb
->
max_a¢
,

1247 
lo›s_≥r_jiffy
 / (500000/
HZ
),

1248 (
lo›s_≥r_jiffy
 / (5000/
HZ
)) % 100,

1249 
u«lig√d
[0].
cou¡
, u«lig√d[0].
pc
, u«lig√d[0].
va
,

1250 
u«lig√d
[1].
cou¡
, u«lig√d[1].
pc
, u«lig√d[1].
va
,

1251 
	`∂©f‹m_°rög
(), 
ƒ_¥o˚ss‹s
);

1253 #ifde‡
CONFIG_SMP


1254 
	`£q_¥ötf
(
f
, "cpusáctive\t\t: %d\n"

1256 
	`num_⁄löe_˝us
(), 
	`˝us_addr
(
˝u_possibÀ_m≠
)[0]);

1259 
	`show_ˇche_size
 (
f
, "L1 Iˇche", 
Æpha_l1i_ˇchesh≠e
);

1260 
	`show_ˇche_size
 (
f
, "L1 Dˇche", 
Æpha_l1d_ˇchesh≠e
);

1261 
	`show_ˇche_size
 (
f
, "L2 cache", 
Æpha_l2_ˇchesh≠e
);

1262 
	`show_ˇche_size
 (
f
, "L3 cache", 
Æpha_l3_ˇchesh≠e
);

1265 
	}
}

1267 
__öô


1268 
	$ªad_mem_block
(*
addr
, 
°ride
, 
size
)

1270 
∆ﬂds
 = 
size
 / 
°ride
, 
˙t
, 
tmp
;

1272 
__asm__
 
	`__vﬁ©ûe__
(

1285 : "=&r" (
˙t
), "=&r" (
∆ﬂds
), "=&r" (
addr
), "=&r" (
tmp
)

1286 : "r" (
°ride
), "1" (
∆ﬂds
), "2" (
addr
));

1288  
˙t
 / (
size
 / 
°ride
);

1289 
	}
}

1291 
	#CSHAPE
(
tŸÆsize
, 
löesize
, 
assoc
) \

1292 ((
tŸÆsize
 & ~0xffË| (
löesize
 << 4Ë| 
assoc
)

	)

1296 
	#MAX_BCACHE_SIZE
 16*1024*1024

	)

1299 
__öô


1300 
	$exã∫Æ_ˇche_¥obe
(
mösize
, 
width
)

1302 
cy˛es
, 
¥ev_cy˛es
 = 1000000;

1303 
°ride
 = 1 << 
width
;

1304 
size
 = 
mösize
, 
maxsize
 = 
MAX_BCACHE_SIZE
 * 2;

1306 i‡(
maxsize
 > (
max_low_p‚
 + 1Ë<< 
PAGE_SHIFT
)

1307 
maxsize
 = 1 << (
	`ûog2
(
max_low_p‚
 + 1Ë+ 
PAGE_SHIFT
);

1310 
	`ªad_mem_block
(
	`__va
(0), 
°ride
, 
size
);

1312 
size
 < 
maxsize
) {

1314 
cy˛es
 = 
	`ªad_mem_block
(
	`__va
(0), 
°ride
, 
size
);

1315 i‡(
cy˛es
 > 
¥ev_cy˛es
 * 2) {

1317 
	`¥ötk
("%ldK Bcache detected;Üoad hitÜatency %d "

1319 
size
 >> 11, 
¥ev_cy˛es
, 
cy˛es
);

1320  
	`CSHAPE
(
size
 >> 1, 
width
, 1);

1323 
	`ªad_mem_block
(
	`__va
(
size
), 
°ride
, size);

1324 
¥ev_cy˛es
 = 
cy˛es
;

1325 
size
 <<= 1;

1328 
	}
}

1330 
__öô


1331 
	$dëîmöe_˝u_ˇches
 (
˝u_ty≥
)

1333 
L1I
, 
L1D
, 
L2
, 
L3
;

1335 
˝u_ty≥
) {

1336 
EV4_CPU
:

1337 
EV45_CPU
:

1339 i‡(
˝u_ty≥
 =
EV4_CPU
)

1340 
L1I
 = 
	`CSHAPE
(8*1024, 5, 1);

1342 
L1I
 = 
	`CSHAPE
(16*1024, 5, 1);

1343 
L1D
 = 
L1I
;

1344 
L3
 = -1;

1356 
L2
 = 
	`exã∫Æ_ˇche_¥obe
(128*1024, 5);

1360 
LCA4_CPU
:

1362 
ˇr
, 
size
;

1364 
L1I
 = 
L1D
 = 
	`CSHAPE
(8*1024, 5, 1);

1365 
L3
 = -1;

1367 
ˇr
 = *(
vuù
Ë
	`phys_to_vút
 (0x120000078UL);

1368 
size
 = 64*1024 * (1 << ((
ˇr
 >> 5) & 7));

1370 
L2
 = (
ˇr
 & 1 ? 
	`CSHAPE
 (
size
, 3, 1) : -1);

1374 
EV5_CPU
:

1375 
EV56_CPU
:

1377 
sc_˘l
, 
width
;

1379 
L1I
 = 
L1D
 = 
	`CSHAPE
(8*1024, 5, 1);

1382 
sc_˘l
 = *(
vuÕ
Ë
	`phys_to_vút
 (0xfffff000a8UL);

1383 
width
 = 
sc_˘l
 & 0x1000 ? 6 : 5;

1384 
L2
 = 
	`CSHAPE
 (96*1024, 
width
, 3);

1396 
L3
 = 
	`exã∫Æ_ˇche_¥obe
(1024*1024, 
width
);

1400 
PCA56_CPU
:

1401 
PCA57_CPU
:

1403 
cbox_c⁄fig
, 
size
;

1405 i‡(
˝u_ty≥
 =
PCA56_CPU
) {

1406 
L1I
 = 
	`CSHAPE
(16*1024, 6, 1);

1407 
L1D
 = 
	`CSHAPE
(8*1024, 5, 1);

1409 
L1I
 = 
	`CSHAPE
(32*1024, 6, 2);

1410 
L1D
 = 
	`CSHAPE
(16*1024, 5, 1);

1412 
L3
 = -1;

1414 
cbox_c⁄fig
 = *(
vuÕ
Ë
	`phys_to_vút
 (0xfffff00008UL);

1415 
size
 = 512*1024 * (1 << ((
cbox_c⁄fig
 >> 12) & 3));

1418 
L2
 = ((
cbox_c⁄fig
 >> 31Ë& 1 ? 
	`CSHAPE
 (
size
, 6, 1) : -1);

1420 
L2
 = 
	`exã∫Æ_ˇche_¥obe
(512*1024, 6);

1425 
EV6_CPU
:

1426 
EV67_CPU
:

1427 
EV68CB_CPU
:

1428 
EV68AL_CPU
:

1429 
EV68CX_CPU
:

1430 
EV69_CPU
:

1431 
L1I
 = 
L1D
 = 
	`CSHAPE
(64*1024, 6, 2);

1432 
L2
 = 
	`exã∫Æ_ˇche_¥obe
(1024*1024, 6);

1433 
L3
 = -1;

1436 
EV7_CPU
:

1437 
EV79_CPU
:

1438 
L1I
 = 
L1D
 = 
	`CSHAPE
(64*1024, 6, 2);

1439 
L2
 = 
	`CSHAPE
(7*1024*1024/4, 6, 7);

1440 
L3
 = -1;

1445 
L1I
 = 
L1D
 = 
L2
 = 
L3
 = 0;

1449 
Æpha_l1i_ˇchesh≠e
 = 
L1I
;

1450 
Æpha_l1d_ˇchesh≠e
 = 
L1D
;

1451 
Æpha_l2_ˇchesh≠e
 = 
L2
;

1452 
Æpha_l3_ˇchesh≠e
 = 
L3
;

1453 
	}
}

1459 
	$c_°¨t
(
£q_fûe
 *
f
, 
loff_t
 *
pos
)

1461  *
pos
 ? 
NULL
 : (*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
;

1462 
	}
}

1465 
	$c_√xt
(
£q_fûe
 *
f
, *
v
, 
loff_t
 *
pos
)

1467  
NULL
;

1468 
	}
}

1471 
	$c_°›
(
£q_fûe
 *
f
, *
v
)

1473 
	}
}

1475 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

1476 .
°¨t
 = 
c_°¨t
,

1477 .
	g√xt
 = 
c_√xt
,

1478 .
	g°›
 = 
c_°›
,

1479 .
	gshow
 = 
show_˝uöfo
,

1484 
	$Æpha_∑nic_evít
(
nŸifõr_block
 *
this
, 
evít
, *
±r
)

1489 i‡(
Æpha_usög_§m
 && 
§mc⁄s_ouçut
)

1490 
	`__hÆt
();

1492  
NOTIFY_DONE
;

1493 
	}
}

1495 
__öô
 
	$add_pc•kr
()

1497 
∂©f‹m_devi˚
 *
pd
;

1498 
ªt
;

1500 
pd
 = 
	`∂©f‹m_devi˚_Æloc
("pcspkr", -1);

1501 i‡(!
pd
)

1502  -
ENOMEM
;

1504 
ªt
 = 
	`∂©f‹m_devi˚_add
(
pd
);

1505 i‡(
ªt
)

1506 
	`∂©f‹m_devi˚_put
(
pd
);

1508  
ªt
;

1509 
	}
}

1510 
devi˚_öôˇŒ
(
add_pc•kr
);

	@arch/alpha/kernel/signal.c

9 
	~<löux/sched.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/sig«l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/waô.h
>

14 
	~<löux/±ø˚.h
>

15 
	~<löux/uni°d.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/smp.h
>

18 
	~<löux/°ddef.h
>

19 
	~<löux/ây.h
>

20 
	~<löux/böfmts.h
>

21 
	~<löux/bô›s.h
>

23 
	~<asm/uac˚ss.h
>

24 
	~<asm/sigc⁄ãxt.h
>

25 
	~<asm/uc⁄ãxt.h
>

27 
	~"¥Ÿo.h
"

30 
	#DEBUG_SIG
 0

	)

32 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

34 
asmlökage
 
ªt_‰om_sys_ˇŒ
();

35 
do_sig«l
(
±_ªgs
 *, 
swôch_°ack
 *,

54 
asmlökage
 

55 
	$do_osf_sig¥ocmask
(
how
, 
√wmask
, 
±_ªgs
 *
ªgs
)

57 
ﬁdmask
 = -
EINVAL
;

59 i‡(()
how
-1 <= 2) {

60 
sign
 = 
how
-2;

61 
block
, 
unblock
;

63 
√wmask
 &
_BLOCKABLE
;

64 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

65 
ﬁdmask
 = 
cuºít
->
blocked
.
sig
[0];

67 
unblock
 = 
ﬁdmask
 & ~
√wmask
;

68 
block
 = 
ﬁdmask
 | 
√wmask
;

69 i‡(!
sign
)

70 
block
 = 
unblock
;

71 i‡(
sign
 <= 0)

72 
√wmask
 = 
block
;

73 i‡(
_NSIG_WORDS
 > 1 && 
sign
 > 0)

74 
	`sigem±y£t
(&
cuºít
->
blocked
);

75 
cuºít
->
blocked
.
sig
[0] = 
√wmask
;

76 
	`ªˇlc_sig≥ndög
();

77 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

79 
ªgs
->
r0
 = 0;

81  
ﬁdmask
;

82 
	}
}

84 
asmlökage
 

85 
	$osf_siga˘i⁄
(
sig
, c⁄° 
osf_siga˘i⁄
 
__u£r
 *
a˘
,

86 
osf_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

88 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

89 
ªt
;

91 i‡(
a˘
) {

92 
ﬁd_sig£t_t
 
mask
;

93 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

94 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler) ||

95 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags))

96  -
EFAULT
;

97 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
);

98 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

99 
√w_ka
.
ka_ª°‹î
 = 
NULL
;

102 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

104 i‡(!
ªt
 && 
ﬂ˘
) {

105 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

106 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler) ||

107 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags))

108  -
EFAULT
;

109 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

112  
ªt
;

113 
	}
}

115 
asmlökage
 

116 
	$sys_π_siga˘i⁄
(
sig
, c⁄° 
siga˘i⁄
 
__u£r
 *
a˘
,

117 
siga˘i⁄
 
__u£r
 *
ﬂ˘
,

118 
size_t
 
sig£tsize
, 
__u£r
 *
ª°‹î
)

120 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

121 
ªt
;

124 i‡(
sig£tsize
 !(
sig£t_t
))

125  -
EINVAL
;

127 i‡(
a˘
) {

128 
√w_ka
.
ka_ª°‹î
 = 
ª°‹î
;

129 i‡(
	`c›y_‰om_u£r
(&
√w_ka
.
ß
, 
a˘
, (*act)))

130  -
EFAULT
;

133 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

135 i‡(!
ªt
 && 
ﬂ˘
) {

136 i‡(
	`c›y_to_u£r
(
ﬂ˘
, &
ﬁd_ka
.
ß
, (*oact)))

137  -
EFAULT
;

140  
ªt
;

141 
	}
}

146 
asmlökage
 

147 
	$do_sigsu•íd
(
ﬁd_sig£t_t
 
mask
, 
±_ªgs
 *
ªgs
, 
swôch_°ack
 *
sw
)

149 
mask
 &
_BLOCKABLE
;

150 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

151 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

152 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

153 
	`ªˇlc_sig≥ndög
();

154 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

158 
ªgs
->
r0
 = 
EINTR
;

159 
ªgs
->
r19
 = 1;

161 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

162 
	`scheduÀ
();

163 
	`£t_thªad_Êag
(
TIF_RESTORE_SIGMASK
);

164  -
ERESTARTNOHAND
;

165 
	}
}

167 
asmlökage
 

168 
	$do_π_sigsu•íd
(
sig£t_t
 
__u£r
 *
u£t
, 
size_t
 
sig£tsize
,

169 
±_ªgs
 *
ªgs
, 
swôch_°ack
 *
sw
)

171 
sig£t_t
 
£t
;

174 i‡(
sig£tsize
 !(
sig£t_t
))

175  -
EINVAL
;

176 i‡(
	`c›y_‰om_u£r
(&
£t
, 
u£t
, (set)))

177  -
EFAULT
;

179 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

180 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

181 
cuºít
->
ßved_sigmask
 = cuºít->
blocked
;

182 
cuºít
->
blocked
 = 
£t
;

183 
	`ªˇlc_sig≥ndög
();

184 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

188 
ªgs
->
r0
 = 
EINTR
;

189 
ªgs
->
r19
 = 1;

191 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

192 
	`scheduÀ
();

193 
	`£t_thªad_Êag
(
TIF_RESTORE_SIGMASK
);

194  -
ERESTARTNOHAND
;

195 
	}
}

197 
asmlökage
 

198 
	$sys_sigÆt°ack
(c⁄° 
°ack_t
 
__u£r
 *
uss
, sèck_à__u£∏*
uoss
)

200  
	`do_sigÆt°ack
(
uss
, 
uoss
, 
	`rdu•
());

201 
	}
}

207 #i‡
_NSIG_WORDS
 > 1

211 
	ssig‰ame


213 
sigc⁄ãxt
 
	msc
;

214 
	mªtcode
[3];

217 
	sπ_sig‰ame


219 
sigöfo
 
	möfo
;

220 
uc⁄ãxt
 
	muc
;

221 
	mªtcode
[3];

227 
compûe_time_as£π


228 [
off£tof
(
π_sig‰ame
, 
uc
.
uc_mc⁄ãxt
) == 176 ? 1 : -1];

230 
	#INSN_MOV_R30_R16
 0x47„0410

	)

231 
	#INSN_LDI_R0
 0x201f0000

	)

232 
	#INSN_CALLSYS
 0x00000083

	)

235 
	$ª°‹e_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, 
±_ªgs
 *
ªgs
,

236 
swôch_°ack
 *
sw
)

238 
u•
;

239 
i
, 
îr
 = 
	`__gë_u£r
(
ªgs
->
pc
, &
sc
->
sc_pc
);

241 
sw
->
r26
 = (Ë
ªt_‰om_sys_ˇŒ
;

243 
îr
 |
	`__gë_u£r
(
ªgs
->
r0
, 
sc
->
sc_ªgs
+0);

244 
îr
 |
	`__gë_u£r
(
ªgs
->
r1
, 
sc
->
sc_ªgs
+1);

245 
îr
 |
	`__gë_u£r
(
ªgs
->
r2
, 
sc
->
sc_ªgs
+2);

246 
îr
 |
	`__gë_u£r
(
ªgs
->
r3
, 
sc
->
sc_ªgs
+3);

247 
îr
 |
	`__gë_u£r
(
ªgs
->
r4
, 
sc
->
sc_ªgs
+4);

248 
îr
 |
	`__gë_u£r
(
ªgs
->
r5
, 
sc
->
sc_ªgs
+5);

249 
îr
 |
	`__gë_u£r
(
ªgs
->
r6
, 
sc
->
sc_ªgs
+6);

250 
îr
 |
	`__gë_u£r
(
ªgs
->
r7
, 
sc
->
sc_ªgs
+7);

251 
îr
 |
	`__gë_u£r
(
ªgs
->
r8
, 
sc
->
sc_ªgs
+8);

252 
îr
 |
	`__gë_u£r
(
sw
->
r9
, 
sc
->
sc_ªgs
+9);

253 
îr
 |
	`__gë_u£r
(
sw
->
r10
, 
sc
->
sc_ªgs
+10);

254 
îr
 |
	`__gë_u£r
(
sw
->
r11
, 
sc
->
sc_ªgs
+11);

255 
îr
 |
	`__gë_u£r
(
sw
->
r12
, 
sc
->
sc_ªgs
+12);

256 
îr
 |
	`__gë_u£r
(
sw
->
r13
, 
sc
->
sc_ªgs
+13);

257 
îr
 |
	`__gë_u£r
(
sw
->
r14
, 
sc
->
sc_ªgs
+14);

258 
îr
 |
	`__gë_u£r
(
sw
->
r15
, 
sc
->
sc_ªgs
+15);

259 
îr
 |
	`__gë_u£r
(
ªgs
->
r16
, 
sc
->
sc_ªgs
+16);

260 
îr
 |
	`__gë_u£r
(
ªgs
->
r17
, 
sc
->
sc_ªgs
+17);

261 
îr
 |
	`__gë_u£r
(
ªgs
->
r18
, 
sc
->
sc_ªgs
+18);

262 
îr
 |
	`__gë_u£r
(
ªgs
->
r19
, 
sc
->
sc_ªgs
+19);

263 
îr
 |
	`__gë_u£r
(
ªgs
->
r20
, 
sc
->
sc_ªgs
+20);

264 
îr
 |
	`__gë_u£r
(
ªgs
->
r21
, 
sc
->
sc_ªgs
+21);

265 
îr
 |
	`__gë_u£r
(
ªgs
->
r22
, 
sc
->
sc_ªgs
+22);

266 
îr
 |
	`__gë_u£r
(
ªgs
->
r23
, 
sc
->
sc_ªgs
+23);

267 
îr
 |
	`__gë_u£r
(
ªgs
->
r24
, 
sc
->
sc_ªgs
+24);

268 
îr
 |
	`__gë_u£r
(
ªgs
->
r25
, 
sc
->
sc_ªgs
+25);

269 
îr
 |
	`__gë_u£r
(
ªgs
->
r26
, 
sc
->
sc_ªgs
+26);

270 
îr
 |
	`__gë_u£r
(
ªgs
->
r27
, 
sc
->
sc_ªgs
+27);

271 
îr
 |
	`__gë_u£r
(
ªgs
->
r28
, 
sc
->
sc_ªgs
+28);

272 
îr
 |
	`__gë_u£r
(
ªgs
->
gp
, 
sc
->
sc_ªgs
+29);

273 
îr
 |
	`__gë_u£r
(
u•
, 
sc
->
sc_ªgs
+30);

274 
	`wru•
(
u•
);

276 
i
 = 0; i < 31; i++)

277 
îr
 |
	`__gë_u£r
(
sw
->
Â
[
i
], 
sc
->
sc_Âªgs
+i);

278 
îr
 |
	`__gë_u£r
(
sw
->
Â
[31], &
sc
->
sc_Â¸
);

280  
îr
;

281 
	}
}

287 
asmlökage
 

288 
	$do_sigªtu∫
(
sigc⁄ãxt
 
__u£r
 *
sc
, 
±_ªgs
 *
ªgs
,

289 
swôch_°ack
 *
sw
)

291 
sig£t_t
 
£t
;

294 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
sc
, (*sc)))

295 
give_sig£gv
;

296 i‡(
	`__gë_u£r
(
£t
.
sig
[0], &
sc
->
sc_mask
))

297 
give_sig£gv
;

299 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

300 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

301 
cuºít
->
blocked
 = 
£t
;

302 
	`ªˇlc_sig≥ndög
();

303 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

305 i‡(
	`ª°‹e_sigc⁄ãxt
(
sc
, 
ªgs
, 
sw
))

306 
give_sig£gv
;

309 i‡(
	`±ø˚_ˇn˚l_b±
 (
cuºít
)) {

310 
sigöfo_t
 
öfo
;

312 
öfo
.
si_signo
 = 
SIGTRAP
;

313 
öfo
.
si_î∫o
 = 0;

314 
öfo
.
si_code
 = 
TRAP_BRKPT
;

315 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

316 
öfo
.
si_å≠no
 = 0;

317 
	`£nd_sig_öfo
(
SIGTRAP
, &
öfo
, 
cuºít
);

321 
give_sig£gv
:

322 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

323 
	}
}

325 
asmlökage
 

326 
	$do_π_sigªtu∫
(
π_sig‰ame
 
__u£r
 *
‰ame
, 
±_ªgs
 *
ªgs
,

327 
swôch_°ack
 *
sw
)

329 
sig£t_t
 
£t
;

332 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, &
‰ame
->
uc
, (frame->uc)))

333 
give_sig£gv
;

334 i‡(
	`__c›y_‰om_u£r
(&
£t
, &
‰ame
->
uc
.
uc_sigmask
, (set)))

335 
give_sig£gv
;

337 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

338 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

339 
cuºít
->
blocked
 = 
£t
;

340 
	`ªˇlc_sig≥ndög
();

341 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

343 i‡(
	`ª°‹e_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
ªgs
, 
sw
))

344 
give_sig£gv
;

347 i‡(
	`±ø˚_ˇn˚l_b±
 (
cuºít
)) {

348 
sigöfo_t
 
öfo
;

350 
öfo
.
si_signo
 = 
SIGTRAP
;

351 
öfo
.
si_î∫o
 = 0;

352 
öfo
.
si_code
 = 
TRAP_BRKPT
;

353 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

354 
öfo
.
si_å≠no
 = 0;

355 
	`£nd_sig_öfo
(
SIGTRAP
, &
öfo
, 
cuºít
);

359 
give_sig£gv
:

360 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

361 
	}
}

368 
ölöe
 
__u£r
 *

369 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
•
, 
size_t
 
‰ame_size
)

371 i‡((
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
Ë!0 && ! 
	`ßs_ss_Êags
(
•
))

372 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

374  (
__u£r
 *)((
•
 - 
‰ame_size
) & -32ul);

375 
	}
}

378 
	$£tup_sigc⁄ãxt
(
sigc⁄ãxt
 
__u£r
 *
sc
, 
±_ªgs
 *
ªgs
,

379 
swôch_°ack
 *
sw
, 
mask
, 
•
)

381 
i
, 
îr
 = 0;

383 
îr
 |
	`__put_u£r
(
	`⁄_sig_°ack
(()
sc
), &sc->
sc_⁄°ack
);

384 
îr
 |
	`__put_u£r
(
mask
, &
sc
->
sc_mask
);

385 
îr
 |
	`__put_u£r
(
ªgs
->
pc
, &
sc
->
sc_pc
);

386 
îr
 |
	`__put_u£r
(8, &
sc
->
sc_ps
);

388 
îr
 |
	`__put_u£r
(
ªgs
->
r0
 , 
sc
->
sc_ªgs
+0);

389 
îr
 |
	`__put_u£r
(
ªgs
->
r1
 , 
sc
->
sc_ªgs
+1);

390 
îr
 |
	`__put_u£r
(
ªgs
->
r2
 , 
sc
->
sc_ªgs
+2);

391 
îr
 |
	`__put_u£r
(
ªgs
->
r3
 , 
sc
->
sc_ªgs
+3);

392 
îr
 |
	`__put_u£r
(
ªgs
->
r4
 , 
sc
->
sc_ªgs
+4);

393 
îr
 |
	`__put_u£r
(
ªgs
->
r5
 , 
sc
->
sc_ªgs
+5);

394 
îr
 |
	`__put_u£r
(
ªgs
->
r6
 , 
sc
->
sc_ªgs
+6);

395 
îr
 |
	`__put_u£r
(
ªgs
->
r7
 , 
sc
->
sc_ªgs
+7);

396 
îr
 |
	`__put_u£r
(
ªgs
->
r8
 , 
sc
->
sc_ªgs
+8);

397 
îr
 |
	`__put_u£r
(
sw
->
r9
 , 
sc
->
sc_ªgs
+9);

398 
îr
 |
	`__put_u£r
(
sw
->
r10
 , 
sc
->
sc_ªgs
+10);

399 
îr
 |
	`__put_u£r
(
sw
->
r11
 , 
sc
->
sc_ªgs
+11);

400 
îr
 |
	`__put_u£r
(
sw
->
r12
 , 
sc
->
sc_ªgs
+12);

401 
îr
 |
	`__put_u£r
(
sw
->
r13
 , 
sc
->
sc_ªgs
+13);

402 
îr
 |
	`__put_u£r
(
sw
->
r14
 , 
sc
->
sc_ªgs
+14);

403 
îr
 |
	`__put_u£r
(
sw
->
r15
 , 
sc
->
sc_ªgs
+15);

404 
îr
 |
	`__put_u£r
(
ªgs
->
r16
, 
sc
->
sc_ªgs
+16);

405 
îr
 |
	`__put_u£r
(
ªgs
->
r17
, 
sc
->
sc_ªgs
+17);

406 
îr
 |
	`__put_u£r
(
ªgs
->
r18
, 
sc
->
sc_ªgs
+18);

407 
îr
 |
	`__put_u£r
(
ªgs
->
r19
, 
sc
->
sc_ªgs
+19);

408 
îr
 |
	`__put_u£r
(
ªgs
->
r20
, 
sc
->
sc_ªgs
+20);

409 
îr
 |
	`__put_u£r
(
ªgs
->
r21
, 
sc
->
sc_ªgs
+21);

410 
îr
 |
	`__put_u£r
(
ªgs
->
r22
, 
sc
->
sc_ªgs
+22);

411 
îr
 |
	`__put_u£r
(
ªgs
->
r23
, 
sc
->
sc_ªgs
+23);

412 
îr
 |
	`__put_u£r
(
ªgs
->
r24
, 
sc
->
sc_ªgs
+24);

413 
îr
 |
	`__put_u£r
(
ªgs
->
r25
, 
sc
->
sc_ªgs
+25);

414 
îr
 |
	`__put_u£r
(
ªgs
->
r26
, 
sc
->
sc_ªgs
+26);

415 
îr
 |
	`__put_u£r
(
ªgs
->
r27
, 
sc
->
sc_ªgs
+27);

416 
îr
 |
	`__put_u£r
(
ªgs
->
r28
, 
sc
->
sc_ªgs
+28);

417 
îr
 |
	`__put_u£r
(
ªgs
->
gp
 , 
sc
->
sc_ªgs
+29);

418 
îr
 |
	`__put_u£r
(
•
, 
sc
->
sc_ªgs
+30);

419 
îr
 |
	`__put_u£r
(0, 
sc
->
sc_ªgs
+31);

421 
i
 = 0; i < 31; i++)

422 
îr
 |
	`__put_u£r
(
sw
->
Â
[
i
], 
sc
->
sc_Âªgs
+i);

423 
îr
 |
	`__put_u£r
(0, 
sc
->
sc_Âªgs
+31);

424 
îr
 |
	`__put_u£r
(
sw
->
Â
[31], &
sc
->
sc_Â¸
);

426 
îr
 |
	`__put_u£r
(
ªgs
->
å≠_a0
, &
sc
->
sc_å≠¨g_a0
);

427 
îr
 |
	`__put_u£r
(
ªgs
->
å≠_a1
, &
sc
->
sc_å≠¨g_a1
);

428 
îr
 |
	`__put_u£r
(
ªgs
->
å≠_a2
, &
sc
->
sc_å≠¨g_a2
);

430  
îr
;

431 
	}
}

434 
	$£tup_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
,

435 
±_ªgs
 *
ªgs
, 
swôch_°ack
 * 
sw
)

437 
ﬁd•
, 
r26
, 
îr
 = 0;

438 
sig‰ame
 
__u£r
 *
‰ame
;

440 
ﬁd•
 = 
	`rdu•
();

441 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ﬁd•
, (*frame));

442 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

443 
give_sig£gv
;

445 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
sc
, 
ªgs
, 
sw
, 
£t
->
sig
[0], 
ﬁd•
);

446 i‡(
îr
)

447 
give_sig£gv
;

451 i‡(
ka
->
ka_ª°‹î
) {

452 
r26
 = (Ë
ka
->
ka_ª°‹î
;

454 
îr
 |
	`__put_u£r
(
INSN_MOV_R30_R16
, 
‰ame
->
ªtcode
+0);

455 
îr
 |
	`__put_u£r
(
INSN_LDI_R0
+
__NR_sigªtu∫
, 
‰ame
->
ªtcode
+1);

456 
îr
 |
	`__put_u£r
(
INSN_CALLSYS
, 
‰ame
->
ªtcode
+2);

457 
	`imb
();

458 
r26
 = (Ë
‰ame
->
ªtcode
;

462 i‡(
îr
)

463 
give_sig£gv
;

466 
ªgs
->
r26
 =Ñ26;

467 
ªgs
->
r27
 =Ñegs->
pc
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

468 
ªgs
->
r16
 = 
sig
;

469 
ªgs
->
r17
 = 0;

470 
ªgs
->
r18
 = (Ë&
‰ame
->
sc
;

471 
	`wru•
((Ë
‰ame
);

473 #i‡
DEBUG_SIG


474 
	`¥ötk
("SIG deliver (%s:%d): sp=%pÖc=%pÑa=%p\n",

475 
cuºít
->
comm
, cuºít->
pid
, 
‰ame
, 
ªgs
->
pc
,Ñegs->
r26
);

480 
give_sig£gv
:

481 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

482  -
EFAULT
;

483 
	}
}

486 
	$£tup_π_‰ame
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

487 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
, 
swôch_°ack
 * 
sw
)

489 
ﬁd•
, 
r26
, 
îr
 = 0;

490 
π_sig‰ame
 
__u£r
 *
‰ame
;

492 
ﬁd•
 = 
	`rdu•
();

493 
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ﬁd•
, (*frame));

494 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, (*frame)))

495 
give_sig£gv
;

497 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

500 
îr
 |
	`__put_u£r
(0, &
‰ame
->
uc
.
uc_Êags
);

501 
îr
 |
	`__put_u£r
(0, &
‰ame
->
uc
.
uc_lök
);

502 
îr
 |
	`__put_u£r
(
£t
->
sig
[0], &
‰ame
->
uc
.
uc_osf_sigmask
);

503 
îr
 |
	`__put_u£r
(
cuºít
->
ßs_ss_•
, &
‰ame
->
uc
.
uc_°ack
.
ss_•
);

504 
îr
 |
	`__put_u£r
(
	`ßs_ss_Êags
(
ﬁd•
), &
‰ame
->
uc
.
uc_°ack
.
ss_Êags
);

505 
îr
 |
	`__put_u£r
(
cuºít
->
ßs_ss_size
, &
‰ame
->
uc
.
uc_°ack
.
ss_size
);

506 
îr
 |
	`£tup_sigc⁄ãxt
(&
‰ame
->
uc
.
uc_mc⁄ãxt
, 
ªgs
, 
sw
,

507 
£t
->
sig
[0], 
ﬁd•
);

508 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
uc
.
uc_sigmask
, 
£t
, (*set));

509 i‡(
îr
)

510 
give_sig£gv
;

514 i‡(
ka
->
ka_ª°‹î
) {

515 
r26
 = (Ë
ka
->
ka_ª°‹î
;

517 
îr
 |
	`__put_u£r
(
INSN_MOV_R30_R16
, 
‰ame
->
ªtcode
+0);

518 
îr
 |
	`__put_u£r
(
INSN_LDI_R0
+
__NR_π_sigªtu∫
,

519 
‰ame
->
ªtcode
+1);

520 
îr
 |
	`__put_u£r
(
INSN_CALLSYS
, 
‰ame
->
ªtcode
+2);

521 
	`imb
();

522 
r26
 = (Ë
‰ame
->
ªtcode
;

525 i‡(
îr
)

526 
give_sig£gv
;

529 
ªgs
->
r26
 =Ñ26;

530 
ªgs
->
r27
 =Ñegs->
pc
 = (Ë
ka
->
ß
.
ß_h™dÀr
;

531 
ªgs
->
r16
 = 
sig
;

532 
ªgs
->
r17
 = (Ë&
‰ame
->
öfo
;

533 
ªgs
->
r18
 = (Ë&
‰ame
->
uc
;

534 
	`wru•
((Ë
‰ame
);

536 #i‡
DEBUG_SIG


537 
	`¥ötk
("SIG deliver (%s:%d): sp=%pÖc=%pÑa=%p\n",

538 
cuºít
->
comm
, cuºít->
pid
, 
‰ame
, 
ªgs
->
pc
,Ñegs->
r26
);

543 
give_sig£gv
:

544 
	`f‹˚_sig£gv
(
sig
, 
cuºít
);

545  -
EFAULT
;

546 
	}
}

552 
ölöe
 

553 
	$h™dÀ_sig«l
(
sig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

554 
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 * 
ªgs
, 
swôch_°ack
 *
sw
)

556 
ªt
;

558 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

559 
ªt
 = 
	`£tup_π_‰ame
(
sig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
, 
sw
);

561 
ªt
 = 
	`£tup_‰ame
(
sig
, 
ka
, 
ﬁd£t
, 
ªgs
, 
sw
);

563 i‡(
ªt
 == 0) {

564 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

565 
	`sig‹£ts
(&
cuºít
->
blocked
,&cuºít->blocked,&
ka
->
ß
.
ß_mask
);

566 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

567 
	`sigadd£t
(&
cuºít
->
blocked
,
sig
);

568 
	`ªˇlc_sig≥ndög
();

569 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

572  
ªt
;

573 
	}
}

575 
ölöe
 

576 
	$sysˇŒ_ª°¨t
(
r0
, 
r19
,

577 
±_ªgs
 *
ªgs
, 
k_siga˘i⁄
 *
ka
)

579 
ªgs
->
r0
) {

580 
ERESTARTSYS
:

581 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

582 
ERESTARTNOHAND
:

583 
ªgs
->
r0
 = 
EINTR
;

587 
ERESTARTNOINTR
:

588 
ªgs
->
r0
 =Ñ0;

589 
ªgs
->
r19
 =Ñ19;

590 
ªgs
->
pc
 -= 4;

592 
ERESTART_RESTARTBLOCK
:

593 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

594 
ªgs
->
r0
 = 
EINTR
;

597 
	}
}

614 
	$do_sig«l
(
±_ªgs
 * 
ªgs
, 
swôch_°ack
 * 
sw
,

615 
r0
, 
r19
)

617 
sigöfo_t
 
öfo
;

618 
sigƒ
;

619 
sögÀ_°ïpög
 = 
	`±ø˚_ˇn˚l_b±
(
cuºít
);

620 
k_siga˘i⁄
 
ka
;

621 
sig£t_t
 *
ﬁd£t
;

623 i‡(
	`ã°_thªad_Êag
(
TIF_RESTORE_SIGMASK
))

624 
ﬁd£t
 = &
cuºít
->
ßved_sigmask
;

626 
ﬁd£t
 = &
cuºít
->
blocked
;

629 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

632 
sögÀ_°ïpög
 |
	`±ø˚_ˇn˚l_b±
(
cuºít
);

634 i‡(
sigƒ
 > 0) {

636 i‡(
r0
)

637 
	`sysˇŒ_ª°¨t
(
r0
, 
r19
, 
ªgs
, &
ka
);

638 i‡(
	`h™dÀ_sig«l
(
sigƒ
, &
ka
, &
öfo
, 
ﬁd£t
, 
ªgs
, 
sw
) == 0) {

643 i‡(
	`ã°_thªad_Êag
(
TIF_RESTORE_SIGMASK
))

644 
	`˛ór_thªad_Êag
(
TIF_RESTORE_SIGMASK
);

646 i‡(
sögÀ_°ïpög
)

647 
	`±ø˚_£t_b±
(
cuºít
);

651 i‡(
r0
) {

652 
ªgs
->
r0
) {

653 
ERESTARTNOHAND
:

654 
ERESTARTSYS
:

655 
ERESTARTNOINTR
:

657 
ªgs
->
r0
 =Ñ0;

658 
ªgs
->
r19
 =Ñ19;

659 
ªgs
->
pc
 -= 4;

661 
ERESTART_RESTARTBLOCK
:

663 
ªgs
->
r0
 = 
__NR_ª°¨t_sysˇŒ
;

664 
ªgs
->
pc
 -= 4;

670 i‡(
	`ã°_thªad_Êag
(
TIF_RESTORE_SIGMASK
)) {

671 
	`˛ór_thªad_Êag
(
TIF_RESTORE_SIGMASK
);

672 
	`sig¥ocmask
(
SIG_SETMASK
, &
cuºít
->
ßved_sigmask
, 
NULL
);

675 i‡(
sögÀ_°ïpög
)

676 
	`±ø˚_£t_b±
(
cuºít
);

677 
	}
}

680 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, 
swôch_°ack
 *
sw
,

681 
thªad_öfo_Êags
,

682 
r0
, 
r19
)

684 i‡(
thªad_öfo_Êags
 & (
_TIF_SIGPENDING
 | 
_TIF_RESTORE_SIGMASK
))

685 
	`do_sig«l
(
ªgs
, 
sw
, 
r0
, 
r19
);

686 
	}
}

	@arch/alpha/kernel/smc37c669.c

4 
	~<löux/kî√l.h
>

6 
	~<löux/¶ab.h
>

7 
	~<löux/mm.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/•ölock.h
>

12 
	~<asm/hwΩb.h
>

13 
	~<asm/io.h
>

14 
	~<asm/£gmít.h
>

17 
	#DBG_DEVS
(
¨gs
Ë
¥ötk
 
	)
args

19 
	#DBG_DEVS
(
¨gs
)

	)

22 
	#KB
 1024

	)

23 
	#MB
 (1024*
KB
)

	)

24 
	#GB
 (1024*
MB
)

	)

26 
	#SMC_DEBUG
 0

	)

63 #i‚de‡
__SMC37c669_H


64 
	#__SMC37c669_H


	)

72 
	#SMC37c669_DEVICE_IRQ_MASK
 0x80000000

	)

73 
	#SMC37c669_DEVICE_IRQ
–
__i
 ) \

74 ((
SMC37c669_DEVICE_IRQ_MASK
Ë| (
__i
))

	)

75 
	#SMC37c669_IS_DEVICE_IRQ
(
__i
) \

76 (((
__i
Ë& (
SMC37c669_DEVICE_IRQ_MASK
)Ë=(SMC37c669_DEVICE_IRQ_MASK))

	)

77 
	#SMC37c669_RAW_DEVICE_IRQ
(
__i
) \

78 ((
__i
Ë& ~(
SMC37c669_DEVICE_IRQ_MASK
))

	)

86 
	#SMC37c669_DEVICE_DRQ_MASK
 0x80000000

	)

87 
	#SMC37c669_DEVICE_DRQ
(
__d
) \

88 ((
SMC37c669_DEVICE_DRQ_MASK
Ë| (
__d
))

	)

89 
	#SMC37c669_IS_DEVICE_DRQ
(
__d
) \

90 (((
__d
Ë& (
SMC37c669_DEVICE_DRQ_MASK
)Ë=(SMC37c669_DEVICE_DRQ_MASK))

	)

91 
	#SMC37c669_RAW_DEVICE_DRQ
(
__d
) \

92 ((
__d
Ë& ~(
SMC37c669_DEVICE_DRQ_MASK
))

	)

94 
	#SMC37c669_DEVICE_ID
 0x3

	)

99 
	#SERIAL_0
 0

	)

100 
	#SERIAL_1
 1

	)

101 
	#PARALLEL_0
 2

	)

102 
	#FLOPPY_0
 3

	)

103 
	#IDE_0
 4

	)

104 
	#NUM_FUNCS
 5

	)

109 
	#COM1_BASE
 0x3F8

	)

110 
	#COM1_IRQ
 4

	)

111 
	#COM2_BASE
 0x2F8

	)

112 
	#COM2_IRQ
 3

	)

113 
	#PARP_BASE
 0x3BC

	)

114 
	#PARP_IRQ
 7

	)

115 
	#PARP_DRQ
 3

	)

116 
	#FDC_BASE
 0x3F0

	)

117 
	#FDC_IRQ
 6

	)

118 
	#FDC_DRQ
 2

	)

123 
	#SMC37c669_CONFIG_ON_KEY
 0x55

	)

124 
	#SMC37c669_CONFIG_OFF_KEY
 0xAA

	)

129 
	#SMC37c669_DEVICE_IRQ_A
 ( 
	`SMC37c669_DEVICE_IRQ
–0x01 ) )

	)

130 
	#SMC37c669_DEVICE_IRQ_B
 ( 
	`SMC37c669_DEVICE_IRQ
–0x02 ) )

	)

131 
	#SMC37c669_DEVICE_IRQ_C
 ( 
	`SMC37c669_DEVICE_IRQ
–0x03 ) )

	)

132 
	#SMC37c669_DEVICE_IRQ_D
 ( 
	`SMC37c669_DEVICE_IRQ
–0x04 ) )

	)

133 
	#SMC37c669_DEVICE_IRQ_E
 ( 
	`SMC37c669_DEVICE_IRQ
–0x05 ) )

	)

134 
	#SMC37c669_DEVICE_IRQ_F
 ( 
	`SMC37c669_DEVICE_IRQ
–0x06 ) )

	)

136 
	#SMC37c669_DEVICE_IRQ_H
 ( 
	`SMC37c669_DEVICE_IRQ
–0x08 ) )

	)

141 
	#SMC37c669_DEVICE_DRQ_A
 ( 
	`SMC37c669_DEVICE_DRQ
–0x01 ) )

	)

142 
	#SMC37c669_DEVICE_DRQ_B
 ( 
	`SMC37c669_DEVICE_DRQ
–0x02 ) )

	)

143 
	#SMC37c669_DEVICE_DRQ_C
 ( 
	`SMC37c669_DEVICE_DRQ
–0x03 ) )

	)

148 
	#SMC37c669_CR00_INDEX
 0x00

	)

149 
	#SMC37c669_CR01_INDEX
 0x01

	)

150 
	#SMC37c669_CR02_INDEX
 0x02

	)

151 
	#SMC37c669_CR03_INDEX
 0x03

	)

152 
	#SMC37c669_CR04_INDEX
 0x04

	)

153 
	#SMC37c669_CR05_INDEX
 0x05

	)

154 
	#SMC37c669_CR06_INDEX
 0x06

	)

155 
	#SMC37c669_CR07_INDEX
 0x07

	)

156 
	#SMC37c669_CR08_INDEX
 0x08

	)

157 
	#SMC37c669_CR09_INDEX
 0x09

	)

158 
	#SMC37c669_CR0A_INDEX
 0x0A

	)

159 
	#SMC37c669_CR0B_INDEX
 0x0B

	)

160 
	#SMC37c669_CR0C_INDEX
 0x0C

	)

161 
	#SMC37c669_CR0D_INDEX
 0x0D

	)

162 
	#SMC37c669_CR0E_INDEX
 0x0E

	)

163 
	#SMC37c669_CR0F_INDEX
 0x0F

	)

164 
	#SMC37c669_CR10_INDEX
 0x10

	)

165 
	#SMC37c669_CR11_INDEX
 0x11

	)

166 
	#SMC37c669_CR12_INDEX
 0x12

	)

167 
	#SMC37c669_CR13_INDEX
 0x13

	)

168 
	#SMC37c669_CR14_INDEX
 0x14

	)

169 
	#SMC37c669_CR15_INDEX
 0x15

	)

170 
	#SMC37c669_CR16_INDEX
 0x16

	)

171 
	#SMC37c669_CR17_INDEX
 0x17

	)

172 
	#SMC37c669_CR18_INDEX
 0x18

	)

173 
	#SMC37c669_CR19_INDEX
 0x19

	)

174 
	#SMC37c669_CR1A_INDEX
 0x1A

	)

175 
	#SMC37c669_CR1B_INDEX
 0x1B

	)

176 
	#SMC37c669_CR1C_INDEX
 0x1C

	)

177 
	#SMC37c669_CR1D_INDEX
 0x1D

	)

178 
	#SMC37c669_CR1E_INDEX
 0x1E

	)

179 
	#SMC37c669_CR1F_INDEX
 0x1F

	)

180 
	#SMC37c669_CR20_INDEX
 0x20

	)

181 
	#SMC37c669_CR21_INDEX
 0x21

	)

182 
	#SMC37c669_CR22_INDEX
 0x22

	)

183 
	#SMC37c669_CR23_INDEX
 0x23

	)

184 
	#SMC37c669_CR24_INDEX
 0x24

	)

185 
	#SMC37c669_CR25_INDEX
 0x25

	)

186 
	#SMC37c669_CR26_INDEX
 0x26

	)

187 
	#SMC37c669_CR27_INDEX
 0x27

	)

188 
	#SMC37c669_CR28_INDEX
 0x28

	)

189 
	#SMC37c669_CR29_INDEX
 0x29

	)

194 
	#SMC37c669_DEVICE_ID_INDEX
 
SMC37c669_CR0D_INDEX


	)

195 
	#SMC37c669_DEVICE_REVISION_INDEX
 
SMC37c669_CR0E_INDEX


	)

196 
	#SMC37c669_FDC_BASE_ADDRESS_INDEX
 
SMC37c669_CR20_INDEX


	)

197 
	#SMC37c669_IDE_BASE_ADDRESS_INDEX
 
SMC37c669_CR21_INDEX


	)

198 
	#SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX
 
SMC37c669_CR22_INDEX


	)

199 
	#SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX
 
SMC37c669_CR23_INDEX


	)

200 
	#SMC37c669_SERIAL0_BASE_ADDRESS_INDEX
 
SMC37c669_CR24_INDEX


	)

201 
	#SMC37c669_SERIAL1_BASE_ADDRESS_INDEX
 
SMC37c669_CR25_INDEX


	)

202 
	#SMC37c669_PARALLEL_FDC_DRQ_INDEX
 
SMC37c669_CR26_INDEX


	)

203 
	#SMC37c669_PARALLEL_FDC_IRQ_INDEX
 
SMC37c669_CR27_INDEX


	)

204 
	#SMC37c669_SERIAL_IRQ_INDEX
 
SMC37c669_CR28_INDEX


	)

212 
	s_SMC37c669_CONFIG_REGS
 {

213 
	mödex_p‹t
;

214 
	md©a_p‹t
;

215 } 
	tSMC37c669_CONFIG_REGS
;

235 
	u_SMC37c669_CR00
 {

236 
	mas_uch¨
;

238 
	mide_í
 : 2;

239 
	mª£rved1
 : 1;

240 
	mfdc_pwr
 : 1;

241 
	mª£rved2
 : 3;

242 
	mvÆid
 : 1;

243 } 
	mby_fõld
;

244 } 
	tSMC37c669_CR00
;

249 
	u_SMC37c669_CR01
 {

250 
	mas_uch¨
;

252 
	mª£rved1
 : 2;

253 
	mµt_pwr
 : 1;

254 
	mµt_mode
 : 1;

255 
	mª£rved2
 : 1;

256 
	mª£rved3
 : 2;

257 
	mlock_¸x
: 1;

258 } 
	mby_fõld
;

259 } 
	tSMC37c669_CR01
;

264 
	u_SMC37c669_CR02
 {

265 
	mas_uch¨
;

267 
	mª£rved1
 : 3;

268 
	mu¨t1_pwr
 : 1;

269 
	mª£rved2
 : 3;

270 
	mu¨t2_pwr
 : 1;

271 } 
	mby_fõld
;

272 } 
	tSMC37c669_CR02
;

290 
	u_SMC37c669_CR03
 {

291 
	mas_uch¨
;

293 
	mpwrgd_gamecs
 : 1;

294 
	mfdc_mode2
 : 1;

295 
	mpö94_0
 : 1;

296 
	mª£rved1
 : 1;

297 
	mdrvdí
 : 1;

298 
	m›_mode
 : 2;

299 
	mpö94_1
 : 1;

300 } 
	mby_fõld
;

301 } 
	tSMC37c669_CR03
;

346 
	u_SMC37c669_CR04
 {

347 
	mas_uch¨
;

349 
	mµt_ext_mode
 : 2;

350 
	mµt_fdc
 : 2;

351 
	mmidi1
 : 1;

352 
	mmidi2
 : 1;

353 
	mïp_ty≥
 : 1;

354 
	mÆt_io
 : 1;

355 } 
	mby_fõld
;

356 } 
	tSMC37c669_CR04
;

368 
	u_SMC37c669_CR05
 {

369 
	mas_uch¨
;

371 
	mª£rved1
 : 2;

372 
	mfdc_dma_mode
 : 1;

373 
	mdí_£l
 : 2;

374 
	msw≠_drv
 : 1;

375 
	mextx4
 : 1;

376 
	mª£rved2
 : 1;

377 } 
	mby_fõld
;

378 } 
	tSMC37c669_CR05
;

383 
	u_SMC37c669_CR06
 {

384 
	mas_uch¨
;

386 
	mÊ›py_a
 : 2;

387 
	mÊ›py_b
 : 2;

388 
	mÊ›py_c
 : 2;

389 
	mÊ›py_d
 : 2;

390 } 
	mby_fõld
;

391 } 
	tSMC37c669_CR06
;

404 
	u_SMC37c669_CR07
 {

405 
	mas_uch¨
;

407 
	mÊ›py_boŸ
 : 2;

408 
	mª£rved1
 : 2;

409 
	mµt_í
 : 1;

410 
	mu¨t1_í
 : 1;

411 
	mu¨t2_í
 : 1;

412 
	mfdc_í
 : 1;

413 } 
	mby_fõld
;

414 } 
	tSMC37c669_CR07
;

419 
	u_SMC37c669_CR08
 {

420 
	mas_uch¨
;

422 
	mzîo
 : 4;

423 
	maddrx7_4
 : 4;

424 } 
	mby_fõld
;

425 } 
	tSMC37c669_CR08
;

437 
	u_SMC37c669_CR09
 {

438 
	mas_uch¨
;

440 
	madø8
 : 3;

441 
	mª£rved1
 : 3;

442 
	madrx_c⁄fig
 : 2;

443 } 
	mby_fõld
;

444 } 
	tSMC37c669_CR09
;

449 
	u_SMC37c669_CR0A
 {

450 
	mas_uch¨
;

452 
	me˝_fifo_thªshﬁd
 : 4;

453 
	mª£rved1
 : 4;

454 } 
	mby_fõld
;

455 } 
	tSMC37c669_CR0A
;

460 
	u_SMC37c669_CR0B
 {

461 
	mas_uch¨
;

463 
	mfdd0_dπx
 : 2;

464 
	mfdd1_dπx
 : 2;

465 
	mfdd2_dπx
 : 2;

466 
	mfdd3_dπx
 : 2;

467 } 
	mby_fõld
;

468 } 
	tSMC37c669_CR0B
;

481 
	u_SMC37c669_CR0C
 {

482 
	mas_uch¨
;

484 
	mu¨t2_rcv_pﬁ¨ôy
 : 1;

485 
	mu¨t2_xmô_pﬁ¨ôy
 : 1;

486 
	mu¨t2_du∂ex
 : 1;

487 
	mu¨t2_mode
 : 3;

488 
	mu¨t1_•ìd
 : 1;

489 
	mu¨t2_•ìd
 : 1;

490 } 
	mby_fõld
;

491 } 
	tSMC37c669_CR0C
;

498 
	u_SMC37c669_CR0D
 {

499 
	mas_uch¨
;

501 
	mdevi˚_id
 : 8;

502 } 
	mby_fõld
;

503 } 
	tSMC37c669_CR0D
;

510 
	u_SMC37c669_CR0E
 {

511 
	mas_uch¨
;

513 
	mdevi˚_ªv
 : 8;

514 } 
	mby_fõld
;

515 } 
	tSMC37c669_CR0E
;

520 
	u_SMC37c669_CR0F
 {

521 
	mas_uch¨
;

523 
	mã°0
 : 1;

524 
	mã°1
 : 1;

525 
	mã°2
 : 1;

526 
	mã°3
 : 1;

527 
	mã°4
 : 1;

528 
	mã°5
 : 1;

529 
	mã°6
 : 1;

530 
	mã°7
 : 1;

531 } 
	mby_fõld
;

532 } 
	tSMC37c669_CR0F
;

537 
	u_SMC37c669_CR10
 {

538 
	mas_uch¨
;

540 
	mª£rved1
 : 3;

541 
	m∂l_gaö
 : 1;

542 
	m∂l_°›
 : 1;

543 
	ma˚_°›
 : 1;

544 
	m∂l_˛ock_˘æ
 : 1;

545 
	mú_ã°
 : 1;

546 } 
	mby_fõld
;

547 } 
	tSMC37c669_CR10
;

552 
	u_SMC37c669_CR11
 {

553 
	mas_uch¨
;

555 
	mú_lo›back
 : 1;

556 
	mã°_10ms
 : 1;

557 
	mª£rved1
 : 6;

558 } 
	mby_fõld
;

559 } 
	tSMC37c669_CR11
;

575 
	u_SMC37c66_CR1E
 {

576 
	mas_uch¨
;

578 
	mgamecs_c⁄fig
: 2;

579 
	mgamecs_addr9_4
 : 6;

580 } 
	mby_fõld
;

581 } 
	tSMC37c669_CR1E
;

599 
	u_SMC37c669_CR1F
 {

600 
	mas_uch¨
;

602 
	mfdd0_drive_ty≥
 : 2;

603 
	mfdd1_drive_ty≥
 : 2;

604 
	mfdd2_drive_ty≥
 : 2;

605 
	mfdd3_drive_ty≥
 : 2;

606 } 
	mby_fõld
;

607 } 
	tSMC37c669_CR1F
;

617 
	u_SMC37c669_CR20
 {

618 
	mas_uch¨
;

620 
	mzîo
 : 2;

621 
	maddr9_4
 : 6;

622 } 
	mby_fõld
;

623 } 
	tSMC37c669_CR20
;

633 
	u_SMC37c669_CR21
 {

634 
	mas_uch¨
;

636 
	mzîo
 : 2;

637 
	maddr9_4
 : 6;

638 } 
	mby_fõld
;

639 } 
	tSMC37c669_CR21
;

649 
	u_SMC37c669_CR22
 {

650 
	mas_uch¨
;

652 
	mzîo
 : 2;

653 
	maddr9_4
 : 6;

654 } 
	mby_fõld
;

655 } 
	tSMC37c669_CR22
;

667 
	u_SMC37c669_CR23
 {

668 
	mas_uch¨
;

670 
	maddr9_2
 : 8;

671 } 
	mby_fõld
;

672 } 
	tSMC37c669_CR23
;

682 
	u_SMC37c669_CR24
 {

683 
	mas_uch¨
;

685 
	mzîo
 : 1;

686 
	maddr9_3
 : 7;

687 } 
	mby_fõld
;

688 } 
	tSMC37c669_CR24
;

698 
	u_SMC37c669_CR25
 {

699 
	mas_uch¨
;

701 
	mzîo
 : 1;

702 
	maddr9_3
 : 7;

703 } 
	mby_fõld
;

704 } 
	tSMC37c669_CR25
;

720 
	u_SMC37c669_CR26
 {

721 
	mas_uch¨
;

723 
	mµt_drq
 : 4;

724 
	mfdc_drq
 : 4;

725 } 
	mby_fõld
;

726 } 
	tSMC37c669_CR26
;

749 
	u_SMC37c669_CR27
 {

750 
	mas_uch¨
;

752 
	mµt_úq
 : 4;

753 
	mfdc_úq
 : 4;

754 } 
	mby_fõld
;

755 } 
	tSMC37c669_CR27
;

783 
	u_SMC37c669_CR28
 {

784 
	mas_uch¨
;

786 
	mu¨t2_úq
 : 4;

787 
	mu¨t1_úq
 : 4;

788 } 
	mby_fõld
;

789 } 
	tSMC37c669_CR28
;

812 
	u_SMC37c669_CR29
 {

813 
	mas_uch¨
;

815 
	múqö_úq
 : 4;

816 
	mª£rved1
 : 4;

817 } 
	mby_fõld
;

818 } 
	tSMC37c669_CR29
;

835 
SMC37c669_CR0D
 
	tSMC37c669_DEVICE_ID_REGISTER
;

836 
SMC37c669_CR0E
 
	tSMC37c669_DEVICE_REVISION_REGISTER
;

837 
SMC37c669_CR20
 
	tSMC37c669_FDC_BASE_ADDRESS_REGISTER
;

838 
SMC37c669_CR21
 
	tSMC37c669_IDE_ADDRESS_REGISTER
;

839 
SMC37c669_CR23
 
	tSMC37c669_PARALLEL_BASE_ADDRESS_REGISTER
;

840 
SMC37c669_CR24
 
	tSMC37c669_SERIAL_BASE_ADDRESS_REGISTER
;

841 
SMC37c669_CR26
 
	tSMC37c669_PARALLEL_FDC_DRQ_REGISTER
;

842 
SMC37c669_CR27
 
	tSMC37c669_PARALLEL_FDC_IRQ_REGISTER
;

843 
SMC37c669_CR28
 
	tSMC37c669_SERIAL_IRQ_REGISTER
;

848 
	s_SMC37c669_IRQ_TRANSLATION_ENTRY
 {

849 
	mdevi˚_úq
;

850 
	miß_úq
;

851 } 
	tSMC37c669_IRQ_TRANSLATION_ENTRY
;

856 
	s_SMC37c669_DRQ_TRANSLATION_ENTRY
 {

857 
	mdevi˚_drq
;

858 
	miß_drq
;

859 } 
	tSMC37c669_DRQ_TRANSLATION_ENTRY
;

865 
SMC37c669_CONFIG_REGS
 *
SMC37c669_dëe˘
(

869 
SMC37c669_íabÀ_devi˚
(

870 
func


873 
SMC37c669_dißbÀ_devi˚
(

874 
func


877 
SMC37c669_c⁄figuª_devi˚
(

878 
func
,

879 
p‹t
,

880 
úq
,

881 
drq


884 
SMC37c669_di•œy_devi˚_öfo
(

939 
	~"˝$öc:∂©f‹m_io.h
"

941 
	~"˝$§c:comm⁄.h
"

942 
	~"˝$öc:¥ŸŸy≥s.h
"

943 
	~"˝$§c:kî√l_def.h
"

944 
	~"˝$§c:msg_def.h
"

945 
	~"˝$§c:smcc669_def.h
"

947 
	~"˝$§c:∂©f‹m.h
"

950 #i‚de‡
TRUE


951 
	#TRUE
 1

	)

953 #i‚de‡
FALSE


954 
	#FALSE
 0

	)

957 
	#wb
–
_x_
, 
_y_
 ) 
	`outb
–_y_, ()(()_x_Ë)

	)

958 
	#rb
–
_x_
 ) 
	`öb
–()(()_x_Ë)

	)

970 
	sDEVICE_CONFIG
 {

971 
	mp‹t1
;

972 
	mp‹t2
;

973 
	múq
;

974 
	mdrq
;

975 } 
	gloˇl_c⁄fig
 [
NUM_FUNCS
];

980 
	gSMC37c669_Addªs£s
[] 
	g__öôd©a
 =

990 
SMC37c669_CONFIG_REGS
 *
SMC37c669
 
	g__öôd©a
 = 
NULL
;

999 
SMC37c669_IRQ_TRANSLATION_ENTRY
 *
SMC37c669_úq_èbÀ
 
	g__öôd©a
;

1005 
SMC37c669_IRQ_TRANSLATION_ENTRY
 
	gSMC37c669_deÁu…_úq_èbÀ
[]

1006 
	g__öôd©a
 =

1008 { 
SMC37c669_DEVICE_IRQ_A
, -1 },

1009 { 
SMC37c669_DEVICE_IRQ_B
, -1 },

1010 { 
SMC37c669_DEVICE_IRQ_C
, 7 },

1011 { 
SMC37c669_DEVICE_IRQ_D
, 6 },

1012 { 
SMC37c669_DEVICE_IRQ_E
, 4 },

1013 { 
SMC37c669_DEVICE_IRQ_F
, 3 },

1014 { 
SMC37c669_DEVICE_IRQ_H
, -1 },

1022 
SMC37c669_IRQ_TRANSLATION_ENTRY
 
	gSMC37c669_m⁄ë_úq_èbÀ
[]

1023 
	g__öôd©a
 =

1025 { 
SMC37c669_DEVICE_IRQ_A
, -1 },

1026 { 
SMC37c669_DEVICE_IRQ_B
, -1 },

1027 { 
SMC37c669_DEVICE_IRQ_C
, 6 },

1028 { 
SMC37c669_DEVICE_IRQ_D
, 7 },

1029 { 
SMC37c669_DEVICE_IRQ_E
, 4 },

1030 { 
SMC37c669_DEVICE_IRQ_F
, 3 },

1031 { 
SMC37c669_DEVICE_IRQ_H
, -1 },

1035 
SMC37c669_IRQ_TRANSLATION_ENTRY
 *
	gSMC37c669_úq_èbÀs
[] 
	g__öôd©a
 =

1037 
SMC37c669_deÁu…_úq_èbÀ
,

1038 
SMC37c669_m⁄ë_úq_èbÀ


1048 
SMC37c669_DRQ_TRANSLATION_ENTRY
 *
SMC37c669_drq_èbÀ
 
	g__öôd©a
;

1054 
SMC37c669_DRQ_TRANSLATION_ENTRY
 
	gSMC37c669_deÁu…_drq_èbÀ
[]

1055 
	g__öôd©a
 =

1057 { 
SMC37c669_DEVICE_DRQ_A
, 2 },

1058 { 
SMC37c669_DEVICE_DRQ_B
, 3 },

1059 { 
SMC37c669_DEVICE_DRQ_C
, -1 },

1067 
SMC37c669_is_devi˚_íabÀd
(

1068 
func


1072 
SMC37c669_gë_devi˚_c⁄fig
(

1073 
func
,

1074 *
p‹t
,

1075 *
úq
,

1076 *
drq


1080 
SMC37c669_c⁄fig_mode
(

1081 
íabÀ


1084 
SMC37c669_ªad_c⁄fig
(

1085 
ödex


1088 
SMC37c669_wrôe_c⁄fig
(

1089 
ödex
,

1090 
d©a


1093 
SMC37c669_öô_loˇl_c⁄fig
( );

1095 
DEVICE_CONFIG
 *
SMC37c669_gë_c⁄fig
(

1096 
func


1099 
SMC37c669_xœã_úq
(

1100 
úq


1103 
SMC37c669_xœã_drq
(

1104 
drq


1107 
__ˇchñöe_Æig√d
 
DEFINE_SPINLOCK
(
smc_lock
);

1131 
SMC37c669_CONFIG_REGS
 * 
__öô
 
	$SMC37c669_dëe˘
–
ödex
 )

1133 
i
;

1134 
SMC37c669_DEVICE_ID_REGISTER
 
id
;

1136  
i
 = 0; 
SMC37c669_Addªs£s
[i] != 0; i++ ) {

1143 
SMC37c669
 = ( 
SMC37c669_CONFIG_REGS
 * )
SMC37c669_Addªs£s
[
i
];

1147 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

1151 
id
.
as_uch¨
 = 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_DEVICE_ID_INDEX
 );

1155 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

1160 i‡–
id
.
by_fõld
.
devi˚_id
 =
SMC37c669_DEVICE_ID
 ) {

1164 
SMC37c669_úq_èbÀ
 = 
SMC37c669_úq_èbÀs
[ 
ödex
 ];

1165 
SMC37c669_drq_èbÀ
 = 
SMC37c669_deÁu…_drq_èbÀ
;

1179 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

1183 
	`SMC37c669_öô_loˇl_c⁄fig
( );

1187 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

1198 
SMC37c669
 = 
NULL
;

1201  
SMC37c669
;

1202 
	}
}

1239 
__öô
 
	$SMC37c669_íabÀ_devi˚
 ( 
func
 )

1241 
ªt_vÆ
 = 
FALSE
;

1245 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

1246  
func
 ) {

1247 
SERIAL_0
:

1249 
SMC37c669_SERIAL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1250 
SMC37c669_SERIAL_IRQ_REGISTER
 
úq
;

1254 
úq
.
as_uch¨
 =

1255 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
 );

1257 
úq
.
by_fõld
.
u¨t1_úq
 =

1258 
	`SMC37c669_RAW_DEVICE_IRQ
(

1259 
	`SMC37c669_xœã_úq
–
loˇl_c⁄fig
[ 
func
 ].
úq
 )

1262 
	`SMC37c669_wrôe_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
, 
úq
.
as_uch¨
 );

1266 
ba£_addr
.
as_uch¨
 = 0;

1267 
ba£_addr
.
by_fõld
.
addr9_3
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t1
 >> 3;

1269 
	`SMC37c669_wrôe_c⁄fig
(

1270 
SMC37c669_SERIAL0_BASE_ADDRESS_INDEX
,

1271 
ba£_addr
.
as_uch¨


1273 
ªt_vÆ
 = 
TRUE
;

1276 
SERIAL_1
:

1278 
SMC37c669_SERIAL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1279 
SMC37c669_SERIAL_IRQ_REGISTER
 
úq
;

1283 
úq
.
as_uch¨
 =

1284 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
 );

1286 
úq
.
by_fõld
.
u¨t2_úq
 =

1287 
	`SMC37c669_RAW_DEVICE_IRQ
(

1288 
	`SMC37c669_xœã_úq
–
loˇl_c⁄fig
[ 
func
 ].
úq
 )

1291 
	`SMC37c669_wrôe_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
, 
úq
.
as_uch¨
 );

1295 
ba£_addr
.
as_uch¨
 = 0;

1296 
ba£_addr
.
by_fõld
.
addr9_3
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t1
 >> 3;

1298 
	`SMC37c669_wrôe_c⁄fig
(

1299 
SMC37c669_SERIAL1_BASE_ADDRESS_INDEX
,

1300 
ba£_addr
.
as_uch¨


1302 
ªt_vÆ
 = 
TRUE
;

1305 
PARALLEL_0
:

1307 
SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1308 
SMC37c669_PARALLEL_FDC_IRQ_REGISTER
 
úq
;

1309 
SMC37c669_PARALLEL_FDC_DRQ_REGISTER
 
drq
;

1313 
drq
.
as_uch¨
 =

1314 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_DRQ_INDEX
 );

1316 
drq
.
by_fõld
.
µt_drq
 =

1317 
	`SMC37c669_RAW_DEVICE_DRQ
(

1318 
	`SMC37c669_xœã_drq
–
loˇl_c⁄fig
[ 
func
 ].
drq
 )

1321 
	`SMC37c669_wrôe_c⁄fig
(

1322 
SMC37c669_PARALLEL_FDC_DRQ_INDEX
,

1323 
drq
.
as_uch¨


1328 
úq
.
as_uch¨
 =

1329 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_IRQ_INDEX
 );

1331 
úq
.
by_fõld
.
µt_úq
 =

1332 
	`SMC37c669_RAW_DEVICE_IRQ
(

1333 
	`SMC37c669_xœã_úq
–
loˇl_c⁄fig
[ 
func
 ].
úq
 )

1336 
	`SMC37c669_wrôe_c⁄fig
(

1337 
SMC37c669_PARALLEL_FDC_IRQ_INDEX
,

1338 
úq
.
as_uch¨


1343 
ba£_addr
.
as_uch¨
 = 0;

1344 
ba£_addr
.
by_fõld
.
addr9_2
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t1
 >> 2;

1346 
	`SMC37c669_wrôe_c⁄fig
(

1347 
SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX
,

1348 
ba£_addr
.
as_uch¨


1350 
ªt_vÆ
 = 
TRUE
;

1353 
FLOPPY_0
:

1355 
SMC37c669_FDC_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1356 
SMC37c669_PARALLEL_FDC_IRQ_REGISTER
 
úq
;

1357 
SMC37c669_PARALLEL_FDC_DRQ_REGISTER
 
drq
;

1361 
drq
.
as_uch¨
 =

1362 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_DRQ_INDEX
 );

1364 
drq
.
by_fõld
.
fdc_drq
 =

1365 
	`SMC37c669_RAW_DEVICE_DRQ
(

1366 
	`SMC37c669_xœã_drq
–
loˇl_c⁄fig
[ 
func
 ].
drq
 )

1369 
	`SMC37c669_wrôe_c⁄fig
(

1370 
SMC37c669_PARALLEL_FDC_DRQ_INDEX
,

1371 
drq
.
as_uch¨


1376 
úq
.
as_uch¨
 =

1377 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_IRQ_INDEX
 );

1379 
úq
.
by_fõld
.
fdc_úq
 =

1380 
	`SMC37c669_RAW_DEVICE_IRQ
(

1381 
	`SMC37c669_xœã_úq
–
loˇl_c⁄fig
[ 
func
 ].
úq
 )

1384 
	`SMC37c669_wrôe_c⁄fig
(

1385 
SMC37c669_PARALLEL_FDC_IRQ_INDEX
,

1386 
úq
.
as_uch¨


1391 
ba£_addr
.
as_uch¨
 = 0;

1392 
ba£_addr
.
by_fõld
.
addr9_4
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t1
 >> 4;

1394 
	`SMC37c669_wrôe_c⁄fig
(

1395 
SMC37c669_FDC_BASE_ADDRESS_INDEX
,

1396 
ba£_addr
.
as_uch¨


1398 
ªt_vÆ
 = 
TRUE
;

1401 
IDE_0
:

1403 
SMC37c669_IDE_ADDRESS_REGISTER
 
ide_addr
;

1407 
ide_addr
.
as_uch¨
 = 0;

1408 
ide_addr
.
by_fõld
.
addr9_4
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t2
 >> 4;

1410 
	`SMC37c669_wrôe_c⁄fig
(

1411 
SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX
,

1412 
ide_addr
.
as_uch¨


1417 
ide_addr
.
as_uch¨
 = 0;

1418 
ide_addr
.
by_fõld
.
addr9_4
 = 
loˇl_c⁄fig
[ 
func
 ].
p‹t1
 >> 4;

1420 
	`SMC37c669_wrôe_c⁄fig
(

1421 
SMC37c669_IDE_BASE_ADDRESS_INDEX
,

1422 
ide_addr
.
as_uch¨


1424 
ªt_vÆ
 = 
TRUE
;

1431 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

1433  
ªt_vÆ
;

1434 
	}
}

1467 
__öô
 
	$SMC37c669_dißbÀ_devi˚
 ( 
func
 )

1469 
ªt_vÆ
 = 
FALSE
;

1474 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

1475  
func
 ) {

1476 
SERIAL_0
:

1478 
SMC37c669_SERIAL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1479 
SMC37c669_SERIAL_IRQ_REGISTER
 
úq
;

1483 
úq
.
as_uch¨
 =

1484 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
 );

1486 
úq
.
by_fõld
.
u¨t1_úq
 = 0;

1488 
	`SMC37c669_wrôe_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
, 
úq
.
as_uch¨
 );

1492 
ba£_addr
.
as_uch¨
 = 0;

1493 
	`SMC37c669_wrôe_c⁄fig
(

1494 
SMC37c669_SERIAL0_BASE_ADDRESS_INDEX
,

1495 
ba£_addr
.
as_uch¨


1497 
ªt_vÆ
 = 
TRUE
;

1500 
SERIAL_1
:

1502 
SMC37c669_SERIAL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1503 
SMC37c669_SERIAL_IRQ_REGISTER
 
úq
;

1507 
úq
.
as_uch¨
 =

1508 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
 );

1510 
úq
.
by_fõld
.
u¨t2_úq
 = 0;

1512 
	`SMC37c669_wrôe_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
, 
úq
.
as_uch¨
 );

1516 
ba£_addr
.
as_uch¨
 = 0;

1518 
	`SMC37c669_wrôe_c⁄fig
(

1519 
SMC37c669_SERIAL1_BASE_ADDRESS_INDEX
,

1520 
ba£_addr
.
as_uch¨


1522 
ªt_vÆ
 = 
TRUE
;

1525 
PARALLEL_0
:

1527 
SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1528 
SMC37c669_PARALLEL_FDC_IRQ_REGISTER
 
úq
;

1529 
SMC37c669_PARALLEL_FDC_DRQ_REGISTER
 
drq
;

1533 
drq
.
as_uch¨
 =

1534 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_DRQ_INDEX
 );

1536 
drq
.
by_fõld
.
µt_drq
 = 0;

1538 
	`SMC37c669_wrôe_c⁄fig
(

1539 
SMC37c669_PARALLEL_FDC_DRQ_INDEX
,

1540 
drq
.
as_uch¨


1545 
úq
.
as_uch¨
 =

1546 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_IRQ_INDEX
 );

1548 
úq
.
by_fõld
.
µt_úq
 = 0;

1550 
	`SMC37c669_wrôe_c⁄fig
(

1551 
SMC37c669_PARALLEL_FDC_IRQ_INDEX
,

1552 
úq
.
as_uch¨


1557 
ba£_addr
.
as_uch¨
 = 0;

1559 
	`SMC37c669_wrôe_c⁄fig
(

1560 
SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX
,

1561 
ba£_addr
.
as_uch¨


1563 
ªt_vÆ
 = 
TRUE
;

1566 
FLOPPY_0
:

1568 
SMC37c669_FDC_BASE_ADDRESS_REGISTER
 
ba£_addr
;

1569 
SMC37c669_PARALLEL_FDC_IRQ_REGISTER
 
úq
;

1570 
SMC37c669_PARALLEL_FDC_DRQ_REGISTER
 
drq
;

1574 
drq
.
as_uch¨
 =

1575 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_DRQ_INDEX
 );

1577 
drq
.
by_fõld
.
fdc_drq
 = 0;

1579 
	`SMC37c669_wrôe_c⁄fig
(

1580 
SMC37c669_PARALLEL_FDC_DRQ_INDEX
,

1581 
drq
.
as_uch¨


1586 
úq
.
as_uch¨
 =

1587 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_IRQ_INDEX
 );

1589 
úq
.
by_fõld
.
fdc_úq
 = 0;

1591 
	`SMC37c669_wrôe_c⁄fig
(

1592 
SMC37c669_PARALLEL_FDC_IRQ_INDEX
,

1593 
úq
.
as_uch¨


1598 
ba£_addr
.
as_uch¨
 = 0;

1600 
	`SMC37c669_wrôe_c⁄fig
(

1601 
SMC37c669_FDC_BASE_ADDRESS_INDEX
,

1602 
ba£_addr
.
as_uch¨


1604 
ªt_vÆ
 = 
TRUE
;

1607 
IDE_0
:

1609 
SMC37c669_IDE_ADDRESS_REGISTER
 
ide_addr
;

1613 
ide_addr
.
as_uch¨
 = 0;

1615 
	`SMC37c669_wrôe_c⁄fig
(

1616 
SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX
,

1617 
ide_addr
.
as_uch¨


1622 
ide_addr
.
as_uch¨
 = 0;

1624 
	`SMC37c669_wrôe_c⁄fig
(

1625 
SMC37c669_IDE_BASE_ADDRESS_INDEX
,

1626 
ide_addr
.
as_uch¨


1628 
ªt_vÆ
 = 
TRUE
;

1635 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

1637  
ªt_vÆ
;

1638 
	}
}

1681 
__öô
 
	$SMC37c669_c⁄figuª_devi˚
 (

1682 
func
,

1683 
p‹t
,

1684 
úq
,

1685 
drq
 )

1687 
DEVICE_CONFIG
 *
˝
;

1692 i‡––
˝
 = 
	`SMC37c669_gë_c⁄fig
 ( 
func
 ) ) !
NULL
 ) {

1696 i‡––
drq
 & ~0xFF ) == 0 ) {

1697 
˝
->
drq
 = drq;

1699 i‡––
úq
 & ~0xFF ) == 0 ) {

1700 
˝
->
úq
 = irq;

1702 i‡––
p‹t
 & ~0xFFFF ) == 0 ) {

1703 
˝
->
p‹t1
 = 
p‹t
;

1709 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
func
 ) ) {

1710 
	`SMC37c669_íabÀ_devi˚
–
func
 );

1712  
TRUE
;

1714  
FALSE
;

1715 
	}
}

1748 
__öô
 
	$SMC37c669_is_devi˚_íabÀd
 ( 
func
 )

1750 
ba£_addr
 = 0;

1751 
dev_ok
 = 
FALSE
;

1752 
ªt_vÆ
 = 
FALSE
;

1756 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

1758  
func
 ) {

1759 
SERIAL_0
:

1760 
ba£_addr
 =

1761 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL0_BASE_ADDRESS_INDEX
 );

1762 
dev_ok
 = 
TRUE
;

1764 
SERIAL_1
:

1765 
ba£_addr
 =

1766 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL1_BASE_ADDRESS_INDEX
 );

1767 
dev_ok
 = 
TRUE
;

1769 
PARALLEL_0
:

1770 
ba£_addr
 =

1771 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX
 );

1772 
dev_ok
 = 
TRUE
;

1774 
FLOPPY_0
:

1775 
ba£_addr
 =

1776 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_FDC_BASE_ADDRESS_INDEX
 );

1777 
dev_ok
 = 
TRUE
;

1779 
IDE_0
:

1780 
ba£_addr
 =

1781 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_IDE_BASE_ADDRESS_INDEX
 );

1782 
dev_ok
 = 
TRUE
;

1789 i‡––
dev_ok
 ) && ( ( 
ba£_addr
 & 0xC0 ) != 0 ) ) {

1794 
ªt_vÆ
 = 
TRUE
;

1799 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

1801  
ªt_vÆ
;

1802 
	}
}

1847 
__öô
 
	$SMC37c669_gë_devi˚_c⁄fig
 (

1848 
func
,

1849 *
p‹t
,

1850 *
úq
,

1851 *
drq
 )

1853 
DEVICE_CONFIG
 *
˝
;

1854 
ªt_vÆ
 = 
FALSE
;

1858 i‡––
˝
 = 
	`SMC37c669_gë_c⁄fig
–
func
 ) ) !
NULL
 ) {

1859 i‡–
drq
 !
NULL
 ) {

1860 *
drq
 = 
˝
->drq;

1861 
ªt_vÆ
 = 
TRUE
;

1863 i‡–
úq
 !
NULL
 ) {

1864 *
úq
 = 
˝
->irq;

1865 
ªt_vÆ
 = 
TRUE
;

1867 i‡–
p‹t
 !
NULL
 ) {

1868 *
p‹t
 = 
˝
->
p‹t1
;

1869 
ªt_vÆ
 = 
TRUE
;

1872  
ªt_vÆ
;

1873 
	}
}

1898 
__öô
 
	$SMC37c669_di•œy_devi˚_öfo
 ( )

1900 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
SERIAL_0
 ) ) {

1901 
	`¥ötk
( " Serial 0: Enabled [ Port 0x%x, IRQ %d ]\n",

1902 
loˇl_c⁄fig
[ 
SERIAL_0
 ].
p‹t1
,

1903 
loˇl_c⁄fig
[ 
SERIAL_0
 ].
úq


1907 
	`¥ötk
( " Serial 0: Disabled\n" );

1910 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
SERIAL_1
 ) ) {

1911 
	`¥ötk
( " Serial 1: Enabled [ Port 0x%x, IRQ %d ]\n",

1912 
loˇl_c⁄fig
[ 
SERIAL_1
 ].
p‹t1
,

1913 
loˇl_c⁄fig
[ 
SERIAL_1
 ].
úq


1917 
	`¥ötk
( " Serial 1: Disabled\n" );

1920 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
PARALLEL_0
 ) ) {

1921 
	`¥ötk
( " Parallel: Enabled [ Port 0x%x, IRQ %d/%d ]\n",

1922 
loˇl_c⁄fig
[ 
PARALLEL_0
 ].
p‹t1
,

1923 
loˇl_c⁄fig
[ 
PARALLEL_0
 ].
úq
,

1924 
loˇl_c⁄fig
[ 
PARALLEL_0
 ].
drq


1928 
	`¥ötk
( " Parallel: Disabled\n" );

1931 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
FLOPPY_0
 ) ) {

1932 
	`¥ötk
( " Floppy Ctrl: Enabled [ Port 0x%x, IRQ %d/%d ]\n",

1933 
loˇl_c⁄fig
[ 
FLOPPY_0
 ].
p‹t1
,

1934 
loˇl_c⁄fig
[ 
FLOPPY_0
 ].
úq
,

1935 
loˇl_c⁄fig
[ 
FLOPPY_0
 ].
drq


1939 
	`¥ötk
( " Floppy Ctrl: Disabled\n" );

1942 i‡–
	`SMC37c669_is_devi˚_íabÀd
–
IDE_0
 ) ) {

1943 
	`¥ötk
( " IDE 0: Enabled [ Port 0x%x, IRQ %d ]\n",

1944 
loˇl_c⁄fig
[ 
IDE_0
 ].
p‹t1
,

1945 
loˇl_c⁄fig
[ 
IDE_0
 ].
úq


1949 
	`¥ötk
( " IDE 0: Disabled\n" );

1951 
	}
}

1976 
__öô
 
	$SMC37c669_c⁄fig_mode
(

1977 
íabÀ
 )

1979 i‡–
íabÀ
 ) {

1987 
	`•ö_lock
(&
smc_lock
);

1988 
	`wb
–&
SMC37c669
->
ödex_p‹t
, 
SMC37c669_CONFIG_ON_KEY
 );

1989 
	`wb
–&
SMC37c669
->
ödex_p‹t
, 
SMC37c669_CONFIG_ON_KEY
 );

1990 
	`•ö_u∆ock
(&
smc_lock
);

1993 
	`wb
–&
SMC37c669
->
ödex_p‹t
, 
SMC37c669_CONFIG_OFF_KEY
 );

1995 
	}
}

2020 
__öô
 
	$SMC37c669_ªad_c⁄fig
(

2021 
ödex
 )

2023 
d©a
;

2025 
	`wb
–&
SMC37c669
->
ödex_p‹t
, 
ödex
 );

2026 
d©a
 = 
	`rb
–&
SMC37c669
->
d©a_p‹t
 );

2027  
d©a
;

2028 
	}
}

2056 
__öô
 
	$SMC37c669_wrôe_c⁄fig
(

2057 
ödex
,

2058 
d©a
 )

2060 
	`wb
–&
SMC37c669
->
ödex_p‹t
, 
ödex
 );

2061 
	`wb
–&
SMC37c669
->
d©a_p‹t
, 
d©a
 );

2062 
	}
}

2089 
__öô
 
	$SMC37c669_öô_loˇl_c⁄fig
 ( )

2091 
SMC37c669_SERIAL_BASE_ADDRESS_REGISTER
 
u¨t_ba£
;

2092 
SMC37c669_SERIAL_IRQ_REGISTER
 
u¨t_úqs
;

2093 
SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER
 
µt_ba£
;

2094 
SMC37c669_PARALLEL_FDC_IRQ_REGISTER
 
µt_fdc_úqs
;

2095 
SMC37c669_PARALLEL_FDC_DRQ_REGISTER
 
µt_fdc_drqs
;

2096 
SMC37c669_FDC_BASE_ADDRESS_REGISTER
 
fdc_ba£
;

2097 
SMC37c669_IDE_ADDRESS_REGISTER
 
ide_ba£
;

2098 
SMC37c669_IDE_ADDRESS_REGISTER
 
ide_Æt
;

2103 
u¨t_ba£
.
as_uch¨
 =

2104 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL0_BASE_ADDRESS_INDEX
 );

2108 
u¨t_úqs
.
as_uch¨
 =

2109 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL_IRQ_INDEX
 );

2113 
loˇl_c⁄fig
[
SERIAL_0
].
p‹t1
 = 
u¨t_ba£
.
by_fõld
.
addr9_3
 << 3;

2114 
loˇl_c⁄fig
[
SERIAL_0
].
úq
 =

2115 
	`SMC37c669_xœã_úq
(

2116 
	`SMC37c669_DEVICE_IRQ
–
u¨t_úqs
.
by_fõld
.
u¨t1_úq
 )

2121 
u¨t_ba£
.
as_uch¨
 =

2122 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_SERIAL1_BASE_ADDRESS_INDEX
 );

2126 
loˇl_c⁄fig
[
SERIAL_1
].
p‹t1
 = 
u¨t_ba£
.
by_fõld
.
addr9_3
 << 3;

2127 
loˇl_c⁄fig
[
SERIAL_1
].
úq
 =

2128 
	`SMC37c669_xœã_úq
(

2129 
	`SMC37c669_DEVICE_IRQ
–
u¨t_úqs
.
by_fõld
.
u¨t2_úq
 )

2134 
µt_ba£
.
as_uch¨
 =

2135 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX
 );

2139 
µt_fdc_úqs
.
as_uch¨
 =

2140 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_IRQ_INDEX
 );

2144 
µt_fdc_drqs
.
as_uch¨
 =

2145 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_PARALLEL_FDC_DRQ_INDEX
 );

2149 
loˇl_c⁄fig
[
PARALLEL_0
].
p‹t1
 = 
µt_ba£
.
by_fõld
.
addr9_2
 << 2;

2150 
loˇl_c⁄fig
[
PARALLEL_0
].
úq
 =

2151 
	`SMC37c669_xœã_úq
(

2152 
	`SMC37c669_DEVICE_IRQ
–
µt_fdc_úqs
.
by_fõld
.
µt_úq
 )

2154 
loˇl_c⁄fig
[
PARALLEL_0
].
drq
 =

2155 
	`SMC37c669_xœã_drq
(

2156 
	`SMC37c669_DEVICE_DRQ
–
µt_fdc_drqs
.
by_fõld
.
µt_drq
 )

2161 
fdc_ba£
.
as_uch¨
 =

2162 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_FDC_BASE_ADDRESS_INDEX
 );

2166 
loˇl_c⁄fig
[
FLOPPY_0
].
p‹t1
 = 
fdc_ba£
.
by_fõld
.
addr9_4
 << 4;

2167 
loˇl_c⁄fig
[
FLOPPY_0
].
úq
 =

2168 
	`SMC37c669_xœã_úq
(

2169 
	`SMC37c669_DEVICE_IRQ
–
µt_fdc_úqs
.
by_fõld
.
fdc_úq
 )

2171 
loˇl_c⁄fig
[
FLOPPY_0
].
drq
 =

2172 
	`SMC37c669_xœã_drq
(

2173 
	`SMC37c669_DEVICE_DRQ
–
µt_fdc_drqs
.
by_fõld
.
fdc_drq
 )

2178 
ide_ba£
.
as_uch¨
 =

2179 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_IDE_BASE_ADDRESS_INDEX
 );

2183 
ide_Æt
.
as_uch¨
 =

2184 
	`SMC37c669_ªad_c⁄fig
–
SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX
 );

2188 
loˇl_c⁄fig
[
IDE_0
].
p‹t1
 = 
ide_ba£
.
by_fõld
.
addr9_4
 << 4;

2189 
loˇl_c⁄fig
[
IDE_0
].
p‹t2
 = 
ide_Æt
.
by_fõld
.
addr9_4
 << 4;

2190 
loˇl_c⁄fig
[
IDE_0
].
úq
 = 14;

2191 
	}
}

2217 
DEVICE_CONFIG
 * 
__öô
 
	$SMC37c669_gë_c⁄fig
–
func
 )

2219 
DEVICE_CONFIG
 *
˝
 = 
NULL
;

2221  
func
 ) {

2222 
SERIAL_0
:

2223 
˝
 = &
loˇl_c⁄fig
[ 
SERIAL_0
 ];

2225 
SERIAL_1
:

2226 
˝
 = &
loˇl_c⁄fig
[ 
SERIAL_1
 ];

2228 
PARALLEL_0
:

2229 
˝
 = &
loˇl_c⁄fig
[ 
PARALLEL_0
 ];

2231 
FLOPPY_0
:

2232 
˝
 = &
loˇl_c⁄fig
[ 
FLOPPY_0
 ];

2234 
IDE_0
:

2235 
˝
 = &
loˇl_c⁄fig
[ 
IDE_0
 ];

2238  
˝
;

2239 
	}
}

2263 
__öô
 
	$SMC37c669_xœã_úq
 ( 
úq
 )

2265 
i
, 
å™¶©ed_úq
 = -1;

2267 i‡–
	`SMC37c669_IS_DEVICE_IRQ
–
úq
 ) ) {

2271  
i
 = 0; ( 
SMC37c669_úq_èbÀ
[i].
devi˚_úq
 !-1 ) || ( SMC37c669_úq_èbÀ[i].
iß_úq
 != -1 ); i++ ) {

2272 i‡–
úq
 =
SMC37c669_úq_èbÀ
[
i
].
devi˚_úq
 ) {

2273 
å™¶©ed_úq
 = 
SMC37c669_úq_èbÀ
[
i
].
iß_úq
;

2282  
i
 = 0; ( 
SMC37c669_úq_èbÀ
[i].
iß_úq
 !-1 ) || ( SMC37c669_úq_èbÀ[i].
devi˚_úq
 != -1 ); i++ ) {

2283 i‡–
úq
 =
SMC37c669_úq_èbÀ
[
i
].
iß_úq
 ) {

2284 
å™¶©ed_úq
 = 
SMC37c669_úq_èbÀ
[
i
].
devi˚_úq
;

2289  
å™¶©ed_úq
;

2290 
	}
}

2315 
__öô
 
	$SMC37c669_xœã_drq
 ( 
drq
 )

2317 
i
, 
å™¶©ed_drq
 = -1;

2319 i‡–
	`SMC37c669_IS_DEVICE_DRQ
–
drq
 ) ) {

2323  
i
 = 0; ( 
SMC37c669_drq_èbÀ
[i].
devi˚_drq
 !-1 ) || ( SMC37c669_drq_èbÀ[i].
iß_drq
 != -1 ); i++ ) {

2324 i‡–
drq
 =
SMC37c669_drq_èbÀ
[
i
].
devi˚_drq
 ) {

2325 
å™¶©ed_drq
 = 
SMC37c669_drq_èbÀ
[
i
].
iß_drq
;

2334  
i
 = 0; ( 
SMC37c669_drq_èbÀ
[i].
iß_drq
 !-1 ) || ( SMC37c669_drq_èbÀ[i].
devi˚_drq
 != -1 ); i++ ) {

2335 i‡–
drq
 =
SMC37c669_drq_èbÀ
[
i
].
iß_drq
 ) {

2336 
å™¶©ed_drq
 = 
SMC37c669_drq_èbÀ
[
i
].
devi˚_drq
;

2341  
å™¶©ed_drq
;

2342 
	}
}

2345 
__öô
 
	$smcc669_öô
 ( )

2347 
INODE
 *
ù
;

2349 
	`Ælocöode
–
smc_ddb
.
«me
, 1, &
ù
 );

2350 
ù
->
dva
 = &
smc_ddb
;

2351 
ù
->
©å
 = 
ATTR$M_WRITE
 | 
ATTR$M_READ
;

2352 
ù
->
Àn
[0] = 0x30;

2353 
ù
->
misc
 = 0;

2354 
	`INODE_UNLOCK
–
ù
 );

2356  
msg_suc˚ss
;

2357 
	}
}

2359 
__öô
 
	$smcc669_›í
–
FILE
 *
Â
, *
öfo
, *
√xt
, *
mode
 )

2361 
INODE
 *
ù
;

2366 
ù
 = 
Â
->ip;

2367 
	`INODE_LOCK
–
ù
 );

2368 i‡–
Â
->
mode
 & 
ATTR$M_WRITE
 ) {

2369 i‡–
ù
->
misc
 ) {

2370 
	`INODE_UNLOCK
–
ù
 );

2371  
msg_Áûuª
;

2373 
ù
->
misc
++;

2378 *
Â
->
off£t
 = 
	`xtoi
–
öfo
 );

2379 
	`INODE_UNLOCK
–
ù
 );

2381  
msg_suc˚ss
;

2382 
	}
}

2384 
__öô
 
	$smcc669_˛o£
–
FILE
 *
Â
 )

2386 
INODE
 *
ù
;

2388 
ù
 = 
Â
->ip;

2389 i‡–
Â
->
mode
 & 
ATTR$M_WRITE
 ) {

2390 
	`INODE_LOCK
–
ù
 );

2391 
ù
->
misc
--;

2392 
	`INODE_UNLOCK
–
ù
 );

2394  
msg_suc˚ss
;

2395 
	}
}

2397 
__öô
 
	$smcc669_ªad
–
FILE
 *
Â
, 
size
, 
numbî
, *
buf
 )

2399 
i
;

2400 
Àngth
;

2401 
nbyãs
;

2402 
INODE
 *
ù
;

2407 
ù
 = 
Â
->ip;

2408 
Àngth
 = 
size
 * 
numbî
;

2409 
nbyãs
 = 0;

2411 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

2412  
i
 = 0; i < 
Àngth
; i++ ) {

2413 i‡–!
	`öønge
–*
Â
->
off£t
, 0, 
ù
->
Àn
[0] ) )

2415 *
buf
++ = 
	`SMC37c669_ªad_c⁄fig
–*
Â
->
off£t
 );

2416 *
Â
->
off£t
 += 1;

2417 
nbyãs
++;

2419 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

2420  
nbyãs
;

2421 
	}
}

2423 
__öô
 
	$smcc669_wrôe
–
FILE
 *
Â
, 
size
, 
numbî
, *
buf
 )

2425 
i
;

2426 
Àngth
;

2427 
nbyãs
;

2428 
INODE
 *
ù
;

2432 
ù
 = 
Â
->ip;

2433 
Àngth
 = 
size
 * 
numbî
;

2434 
nbyãs
 = 0;

2436 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

2437  
i
 = 0; i < 
Àngth
; i++ ) {

2438 i‡–!
	`öønge
–*
Â
->
off£t
, 0, 
ù
->
Àn
[0] ) )

2440 
	`SMC37c669_wrôe_c⁄fig
–*
Â
->
off£t
, *
buf
 );

2441 *
Â
->
off£t
 += 1;

2442 
buf
++;

2443 
nbyãs
++;

2445 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

2446  
nbyãs
;

2447 
	}
}

2450 
__öô


2451 
	$SMC37c669_dump_ªgi°îs
()

2453 
i
;

2454 
i
 = 0; i <= 0x29; i++)

2455 
	`¥ötk
("-- CR%02x : %02x\n", 
i
, 
	`SMC37c669_ªad_c⁄fig
(i));

2456 
	}
}

2484 
__öô
 
	$SMC669_Inô
 ( 
ödex
 )

2486 
SMC37c669_CONFIG_REGS
 *
SMC_ba£
;

2487 
Êags
;

2489 
	`loˇl_úq_ßve
(
Êags
);

2490 i‡––
SMC_ba£
 = 
	`SMC37c669_dëe˘
–
ödex
 ) ) !
NULL
 ) {

2491 #i‡
SMC_DEBUG


2492 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

2493 
	`SMC37c669_dump_ªgi°îs
( );

2494 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

2495 
	`SMC37c669_di•œy_devi˚_öfo
( );

2497 
	`SMC37c669_dißbÀ_devi˚
–
SERIAL_0
 );

2498 
	`SMC37c669_c⁄figuª_devi˚
(

2499 
SERIAL_0
,

2500 
COM1_BASE
,

2501 
COM1_IRQ
,

2504 
	`SMC37c669_íabÀ_devi˚
–
SERIAL_0
 );

2506 
	`SMC37c669_dißbÀ_devi˚
–
SERIAL_1
 );

2507 
	`SMC37c669_c⁄figuª_devi˚
(

2508 
SERIAL_1
,

2509 
COM2_BASE
,

2510 
COM2_IRQ
,

2513 
	`SMC37c669_íabÀ_devi˚
–
SERIAL_1
 );

2515 
	`SMC37c669_dißbÀ_devi˚
–
PARALLEL_0
 );

2516 
	`SMC37c669_c⁄figuª_devi˚
(

2517 
PARALLEL_0
,

2518 
PARP_BASE
,

2519 
PARP_IRQ
,

2520 
PARP_DRQ


2522 
	`SMC37c669_íabÀ_devi˚
–
PARALLEL_0
 );

2524 
	`SMC37c669_dißbÀ_devi˚
–
FLOPPY_0
 );

2525 
	`SMC37c669_c⁄figuª_devi˚
(

2526 
FLOPPY_0
,

2527 
FDC_BASE
,

2528 
FDC_IRQ
,

2529 
FDC_DRQ


2531 
	`SMC37c669_íabÀ_devi˚
–
FLOPPY_0
 );

2534 
	`outb
(0xc, 0x3f2);

2536 
	`SMC37c669_dißbÀ_devi˚
–
IDE_0
 );

2538 #i‡
SMC_DEBUG


2539 
	`SMC37c669_c⁄fig_mode
–
TRUE
 );

2540 
	`SMC37c669_dump_ªgi°îs
( );

2541 
	`SMC37c669_c⁄fig_mode
–
FALSE
 );

2542 
	`SMC37c669_di•œy_devi˚_öfo
( );

2544 
	`loˇl_úq_ª°‹e
(
Êags
);

2545 
	`¥ötk
( "SMC37c669 Super I/O Controller found @ 0x%lx\n",

2546 (Ë
SMC_ba£
 );

2549 
	`loˇl_úq_ª°‹e
(
Êags
);

2550 #i‡
SMC_DEBUG


2551 
	`¥ötk
( "No SMC37c669 Super I/O Controller found\n" );

2554 
	}
}

	@arch/alpha/kernel/smc37c93x.c

5 
	~<löux/kî√l.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/dñay.h
>

12 
	~<asm/hwΩb.h
>

13 
	~<asm/io.h
>

14 
	~<asm/£gmít.h
>

16 
	#SMC_DEBUG
 0

	)

18 #i‡
SMC_DEBUG


19 
	#DBG_DEVS
(
¨gs
Ë
¥ötk
 
	)
args

21 
	#DBG_DEVS
(
¨gs
)

	)

24 
	#KB
 1024

	)

25 
	#MB
 (1024*
KB
)

	)

26 
	#GB
 (1024*
MB
)

	)

29 
	#DEVICE_ON
 1

	)

30 
	#DEVICE_OFF
 0

	)

33 
	#CONFIG_ON_KEY
 0x55

	)

34 
	#CONFIG_OFF_KEY
 0xØ

	)

37 
	#FDC
 0

	)

38 
	#IDE1
 1

	)

39 
	#IDE2
 2

	)

40 
	#PARP
 3

	)

41 
	#SER1
 4

	)

42 
	#SER2
 5

	)

43 
	#RTCL
 6

	)

44 
	#KYBD
 7

	)

45 
	#AUXIO
 8

	)

48 
	#CONFIG_CONTROL
 0x02

	)

49 
	#INDEX_ADDRESS
 0x03

	)

50 
	#LOGICAL_DEVICE_NUMBER
 0x07

	)

51 
	#DEVICE_ID
 0x20

	)

52 
	#DEVICE_REV
 0x21

	)

53 
	#POWER_CONTROL
 0x22

	)

54 
	#POWER_MGMT
 0x23

	)

55 
	#OSC
 0x24

	)

57 
	#ACTIVATE
 0x30

	)

58 
	#ADDR_HI
 0x60

	)

59 
	#ADDR_LO
 0x61

	)

60 
	#INTERRUPT_SEL
 0x70

	)

61 
	#INTERRUPT_SEL_2
 0x72

	)

62 
	#DMA_CHANNEL_SEL
 0x74

	)

64 
	#FDD_MODE_REGISTER
 0x90

	)

65 
	#FDD_OPTION_REGISTER
 0x91

	)

68 
	#VALID_DEVICE_ID
 2

	)

71 
	#KYBD_INTERRUPT
 1

	)

72 
	#MOUS_INTERRUPT
 12

	)

73 
	#COM2_BASE
 0x2f8

	)

74 
	#COM2_INTERRUPT
 3

	)

75 
	#COM1_BASE
 0x3f8

	)

76 
	#COM1_INTERRUPT
 4

	)

77 
	#PARP_BASE
 0x3bc

	)

78 
	#PARP_INTERRUPT
 7

	)

80 
__öô
 
	$SMCC⁄figSèã
(
ba£Addr
)

82 
devId
;

83 
devRev
;

85 
c⁄figP‹t
;

86 
ödexP‹t
;

87 
d©aP‹t
;

89 
i
;

91 
c⁄figP‹t
 = 
ödexP‹t
 = 
ba£Addr
;

92 
d©aP‹t
 = 
c⁄figP‹t
 + 1;

94 
	#NUM_RETRIES
 5

	)

96 
i
 = 0; i < 
NUM_RETRIES
; i++)

98 
	`outb
(
CONFIG_ON_KEY
, 
c⁄figP‹t
);

99 
	`outb
(
CONFIG_ON_KEY
, 
c⁄figP‹t
);

100 
	`outb
(
DEVICE_ID
, 
ödexP‹t
);

101 
devId
 = 
	`öb
(
d©aP‹t
);

102 i‡(
devId
 =
VALID_DEVICE_ID
) {

103 
	`outb
(
DEVICE_REV
, 
ödexP‹t
);

104 
devRev
 = 
	`öb
(
d©aP‹t
);

108 
	`udñay
(100);

110  (
i
 !
NUM_RETRIES
Ë? 
ba£Addr
 : 0L;

111 
	}
}

113 
__öô
 
	$SMCRunSèã
(
ba£Addr
)

115 
	`outb
(
CONFIG_OFF_KEY
, 
ba£Addr
);

116 
	}
}

118 
__öô
 
	$SMCDëe˘U…øIO
()

120 
ba£Addr
;

122 
ba£Addr
 = 0x3F0;

123 i‡––
ba£Addr
 = 
	`SMCC⁄figSèã
( baseAddr ) ) == 0x3F0 ) {

124 –
ba£Addr
 );

126 
ba£Addr
 = 0x370;

127 i‡––
ba£Addr
 = 
	`SMCC⁄figSèã
( baseAddr ) ) == 0x370 ) {

128 –
ba£Addr
 );

131 
	}
}

133 
__öô
 
	$SMCE«bÀDevi˚
(
ba£Addr
,

134 
devi˚
,

135 
p‹èddr
,

136 
öãºu±
)

138 
ödexP‹t
;

139 
d©aP‹t
;

141 
ödexP‹t
 = 
ba£Addr
;

142 
d©aP‹t
 = 
ba£Addr
 + 1;

144 
	`outb
(
LOGICAL_DEVICE_NUMBER
, 
ödexP‹t
);

145 
	`outb
(
devi˚
, 
d©aP‹t
);

147 
	`outb
(
ADDR_LO
, 
ödexP‹t
);

148 
	`outb
(–
p‹èddr
 & 0xFF ), 
d©aP‹t
);

150 
	`outb
(
ADDR_HI
, 
ödexP‹t
);

151 
	`outb
((
p‹èddr
 >> 8Ë& 0xFF, 
d©aP‹t
);

153 
	`outb
(
INTERRUPT_SEL
, 
ödexP‹t
);

154 
	`outb
(
öãºu±
, 
d©aP‹t
);

156 
	`outb
(
ACTIVATE
, 
ödexP‹t
);

157 
	`outb
(
DEVICE_ON
, 
d©aP‹t
);

158 
	}
}

160 
__öô
 
	$SMCE«bÀKYBD
(
ba£Addr
)

162 
ödexP‹t
;

163 
d©aP‹t
;

165 
ödexP‹t
 = 
ba£Addr
;

166 
d©aP‹t
 = 
ba£Addr
 + 1;

168 
	`outb
(
LOGICAL_DEVICE_NUMBER
, 
ödexP‹t
);

169 
	`outb
(
KYBD
, 
d©aP‹t
);

171 
	`outb
(
INTERRUPT_SEL
, 
ödexP‹t
);

172 
	`outb
(
KYBD_INTERRUPT
, 
d©aP‹t
);

174 
	`outb
(
INTERRUPT_SEL_2
, 
ödexP‹t
);

175 
	`outb
(
MOUS_INTERRUPT
, 
d©aP‹t
);

177 
	`outb
(
ACTIVATE
, 
ödexP‹t
);

178 
	`outb
(
DEVICE_ON
, 
d©aP‹t
);

179 
	}
}

181 
__öô
 
	$SMCE«bÀFDC
(
ba£Addr
)

183 
ödexP‹t
;

184 
d©aP‹t
;

186 
ﬁdVÆue
;

188 
ödexP‹t
 = 
ba£Addr
;

189 
d©aP‹t
 = 
ba£Addr
 + 1;

191 
	`outb
(
LOGICAL_DEVICE_NUMBER
, 
ödexP‹t
);

192 
	`outb
(
FDC
, 
d©aP‹t
);

194 
	`outb
(
FDD_MODE_REGISTER
, 
ödexP‹t
);

195 
ﬁdVÆue
 = 
	`öb
(
d©aP‹t
);

197 
ﬁdVÆue
 |= 0x0E;

198 
	`outb
(
ﬁdVÆue
, 
d©aP‹t
);

200 
	`outb
(
INTERRUPT_SEL
, 
ödexP‹t
);

201 
	`outb
(0x06, 
d©aP‹t
 );

203 
	`outb
(
DMA_CHANNEL_SEL
, 
ödexP‹t
);

204 
	`outb
(0x02, 
d©aP‹t
);

206 
	`outb
(
ACTIVATE
, 
ödexP‹t
);

207 
	`outb
(
DEVICE_ON
, 
d©aP‹t
);

208 
	}
}

210 #i‡
SMC_DEBUG


211 
__öô
 
	$SMCRï‹tDevi˚Sètus
(
ba£Addr
)

213 
ödexP‹t
;

214 
d©aP‹t
;

215 
cuºítC⁄åﬁ
;

217 
ödexP‹t
 = 
ba£Addr
;

218 
d©aP‹t
 = 
ba£Addr
 + 1;

220 
	`outb
(
POWER_CONTROL
, 
ödexP‹t
);

221 
cuºítC⁄åﬁ
 = 
	`öb
(
d©aP‹t
);

223 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
FDC
)

225 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
IDE1
)

227 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
IDE2
)

229 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
PARP
)

231 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
SER1
)

233 
	`¥ötk
(
cuºítC⁄åﬁ
 & (1 << 
SER2
)

236 
	`¥ötk
( "\n" );

237 
	}
}

240 
__öô
 
	$SMC93x_Inô
()

242 
SMCU…øBa£
;

243 
Êags
;

245 
	`loˇl_úq_ßve
(
Êags
);

246 i‡((
SMCU…øBa£
 = 
	`SMCDëe˘U…øIO
()) != 0UL) {

247 #i‡
SMC_DEBUG


248 
	`SMCRï‹tDevi˚Sètus
(
SMCU…øBa£
);

250 
	`SMCE«bÀDevi˚
(
SMCU…øBa£
, 
SER1
, 
COM1_BASE
, 
COM1_INTERRUPT
);

251 
	`DBG_DEVS
(("SMC FDC37C93X: SER1 done\n"));

252 
	`SMCE«bÀDevi˚
(
SMCU…øBa£
, 
SER2
, 
COM2_BASE
, 
COM2_INTERRUPT
);

253 
	`DBG_DEVS
(("SMC FDC37C93X: SER2 done\n"));

254 
	`SMCE«bÀDevi˚
(
SMCU…øBa£
, 
PARP
, 
PARP_BASE
, 
PARP_INTERRUPT
);

255 
	`DBG_DEVS
(("SMC FDC37C93X: PARP done\n"));

258 
	`SMCE«bÀKYBD
(
SMCU…øBa£
);

259 
	`DBG_DEVS
(("SMC FDC37C93X: KYB done\n"));

260 
	`SMCE«bÀFDC
(
SMCU…øBa£
);

261 
	`DBG_DEVS
(("SMC FDC37C93X: FDC done\n"));

262 #i‡
SMC_DEBUG


263 
	`SMCRï‹tDevi˚Sètus
(
SMCU…øBa£
);

265 
	`SMCRunSèã
(
SMCU…øBa£
);

266 
	`loˇl_úq_ª°‹e
(
Êags
);

267 
	`¥ötk
("SMC FDC37C93X Ultra I/O Controller found @ 0x%lx\n",

268 
SMCU…øBa£
);

272 
	`loˇl_úq_ª°‹e
(
Êags
);

273 
	`DBG_DEVS
(("No SMC FDC37C93X Ultra I/O Controller found\n"));

276 
	}
}

	@arch/alpha/kernel/smp.c

13 
	~<löux/î∫o.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/kî√l_°©.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/thªads.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/•ölock.h
>

25 
	~<löux/úq.h
>

26 
	~<löux/ˇche.h
>

27 
	~<löux/¥ofûe.h
>

28 
	~<löux/bô›s.h
>

30 
	~<asm/hwΩb.h
>

31 
	~<asm/±ø˚.h
>

32 
	~<asm/©omic.h
>

34 
	~<asm/io.h
>

35 
	~<asm/úq.h
>

36 
	~<asm/pgèbÀ.h
>

37 
	~<asm/pgÆloc.h
>

38 
	~<asm/mmu_c⁄ãxt.h
>

39 
	~<asm/ébÊush.h
>

41 
	~"¥Ÿo.h
"

42 
	~"úq_im∂.h
"

45 
	#DEBUG_SMP
 0

	)

46 #i‡
DEBUG_SMP


47 
	#DBGS
(
¨gs
Ë
¥ötk
 
	)
args

49 
	#DBGS
(
¨gs
)

	)

53 
˝uöfo_Æpha
 
	g˝u_d©a
[
NR_CPUS
];

54 
EXPORT_SYMBOL
(
˝u_d©a
);

58 
bôs
 
	m____ˇchñöe_Æig√d
;

59 } 
	gùi_d©a
[
NR_CPUS
] 
	g__ˇchñöe_Æig√d
;

61 
	eùi_mesßge_ty≥
 {

62 
	mIPI_RESCHEDULE
,

63 
	mIPI_CALL_FUNC
,

64 
	mIPI_CPU_STOP
,

68 
smp_£c⁄d¨y_Æive
 
	g__öôd©a
 = 0;

71 
˝umask_t
 
	g˝u_⁄löe_m≠
;

73 
EXPORT_SYMBOL
(
˝u_⁄löe_m≠
);

75 
	gsmp_num_¥obed
;

76 
	gsmp_num_˝us
 = 1;

77 
EXPORT_SYMBOL
(
smp_num_˝us
);

79 
ˇlibøã_dñay
();

87 
ölöe
 
__öô


88 
	$smp_°‹e_˝u_öfo
(
˝uid
)

90 
˝u_d©a
[
˝uid
].
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

91 
˝u_d©a
[
˝uid
].
œ°_a¢
 = 
ASN_FIRST_VERSION
;

92 
˝u_d©a
[
˝uid
].
√ed_√w_a¢
 = 0;

93 
˝u_d©a
[
˝uid
].
a¢_lock
 = 0;

94 
	}
}

99 
ölöe
 
__öô


100 
	$smp_£tup_≥r˝u_timî
(
˝uid
)

102 
˝u_d©a
[
˝uid
].
¥of_cou¡î
 = 1;

103 
˝u_d©a
[
˝uid
].
¥of_mu…ùlõr
 = 1;

104 
	}
}

106 
__öô


107 
	$waô_boŸ_˝u_to_°›
(
˝uid
)

109 
°›
 = 
jiffõs
 + 10*
HZ
;

111 
	`time_bef‹e
(
jiffõs
, 
°›
)) {

112 i‡(!
smp_£c⁄d¨y_Æive
)

114 
	`b¨rõr
();

117 
	`¥ötk
("waô_boŸ_˝u_to_°›: FAILED o¿CPU %d, h™gögÇow\n", 
˝uid
);

119 
	`b¨rõr
();

120 
	}
}

125 
__öô


126 
	$smp_ˇŒö
()

128 
˝uid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

130 i‡(
	`˝u_ã°_™d_£t
(
˝uid
, 
˝u_⁄löe_m≠
)) {

131 
	`¥ötk
("??, cpu 0x%xáÃódyÖª£¡??\n", 
˝uid
);

132 
	`BUG
();

136 
	`wrm˚s
(7);

139 
	`å≠_öô
();

142 
	`wª¡
(
ítI¡
, 0);

145 
	`smp_£tup_≥r˝u_timî
(
˝uid
);

148 i‡(
Æpha_mv
.
smp_ˇŒö
ËÆpha_mv.
	`smp_ˇŒö
();

151 
	`©omic_öc
(&
öô_mm
.
mm_cou¡
);

152 
cuºít
->
a˘ive_mm
 = &
öô_mm
;

155 
	`loˇl_úq_íabÀ
();

159 
	`waô_boŸ_˝u_to_°›
(
˝uid
);

160 
	`mb
();

161 
	`ˇlibøã_dñay
();

163 
	`smp_°‹e_˝u_öfo
(
˝uid
);

165 
	`wmb
();

166 
smp_£c⁄d¨y_Æive
 = 1;

168 
	`DBGS
(("smp_callin: commencing CPU %d current %páctive_mm %p\n",

169 
˝uid
, 
cuºít
, cuºít->
a˘ive_mm
));

172 
	`˝u_idÀ
();

173 
	}
}

176 
__öô


177 
	$waô_f‹_txrdy
 (
˝umask
)

179 
timeout
;

181 i‡(!(
hwΩb
->
txrdy
 & 
˝umask
))

184 
timeout
 = 
jiffõs
 + 10*
HZ
;

185 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

186 i‡(!(
hwΩb
->
txrdy
 & 
˝umask
))

188 
	`udñay
(10);

189 
	`b¨rõr
();

193 
	}
}

199 
__öô


200 
	$£nd_£c⁄d¨y_c⁄sﬁe_msg
(*
°r
, 
˝uid
)

202 
≥r˝u_°ru˘
 *
˝u
;

203 *
˝1
, *
˝2
;

204 
˝umask
;

205 
size_t
 
Àn
;

207 
˝u
 = (
≥r˝u_°ru˘
 *)

208 ((*)
hwΩb


209 + 
hwΩb
->
¥o˚ss‹_off£t


210 + 
˝uid
 * 
hwΩb
->
¥o˚ss‹_size
);

212 
˝umask
 = (1UL << 
˝uid
);

213 i‡(
	`waô_f‹_txrdy
(
˝umask
))

214 
timeout
;

216 
˝2
 = 
°r
;

217 
Àn
 = 
	`°æí
(
˝2
);

218 *(*)&
˝u
->
ùc_buf„r
[0] = 
Àn
;

219 
˝1
 = (*Ë&
˝u
->
ùc_buf„r
[1];

220 
	`mem˝y
(
˝1
, 
˝2
, 
Àn
);

223 
	`wmb
();

224 
	`£t_bô
(
˝uid
, &
hwΩb
->
rxrdy
);

226 i‡(
	`waô_f‹_txrdy
(
˝umask
))

227 
timeout
;

230 
timeout
:

231 
	`¥ötk
("Pro˚ss‹ %xÇŸÑódy\n", 
˝uid
);

232 
	}
}

238 
	$ªcv_£c⁄d¨y_c⁄sﬁe_msg
()

240 
my˝u
, 
i
, 
˙t
;

241 
txrdy
 = 
hwΩb
->txrdy;

242 *
˝1
, *
˝2
, 
buf
[80];

243 
≥r˝u_°ru˘
 *
˝u
;

245 
	`DBGS
(("ªcv_£c⁄d¨y_c⁄sﬁe_msg: TXRDY 0x%lx.\n", 
txrdy
));

247 
my˝u
 = 
	`h¨d_smp_¥o˚ss‹_id
();

249 
i
 = 0; i < 
NR_CPUS
; i++) {

250 i‡(!(
txrdy
 & (1UL << 
i
)))

253 
	`DBGS
(("recv_secondary_console_msg: "

254 "TXRDY c⁄èö†CPU %d.\n", 
i
));

256 
˝u
 = (
≥r˝u_°ru˘
 *)

257 ((*)
hwΩb


258 + 
hwΩb
->
¥o˚ss‹_off£t


259 + 
i
 * 
hwΩb
->
¥o˚ss‹_size
);

261 
	`DBGS
(("recv_secondary_console_msg: on %d from %d"

263 
my˝u
, 
i
, 
˝u
->
hÆt_ªas⁄
, cpu->
Êags
));

265 
˙t
 = 
˝u
->
ùc_buf„r
[0] >> 32;

266 i‡(
˙t
 <= 0 || cnt >= 80)

267 
	`°r˝y
(
buf
, "<<< BOGUS MSG >>>");

269 
˝1
 = (*Ë&
˝u
->
ùc_buf„r
[11];

270 
˝2
 = 
buf
;

271 
	`°r˝y
(
˝2
, 
˝1
);

273 (
˝2
 = 
	`°rchr
(cp2, '\r')) != 0) {

274 *
˝2
 = ' ';

275 i‡(
˝2
[1] == '\n')

276 
˝2
[1] = ' ';

280 
	`DBGS
((
KERN_INFO
 "recv_secondary_console_msg: on %d "

281 "mesßgêi†'%s'\n", 
my˝u
, 
buf
));

284 
hwΩb
->
txrdy
 = 0;

285 
	}
}

290 
__öô


291 
	$£c⁄d¨y_˝u_°¨t
(
˝uid
, 
èsk_°ru˘
 *
idÀ
)

293 
≥r˝u_°ru˘
 *
˝u
;

294 
pcb_°ru˘
 *
hwpcb
, *
ùcb
;

295 
timeout
;

297 
˝u
 = (
≥r˝u_°ru˘
 *)

298 ((*)
hwΩb


299 + 
hwΩb
->
¥o˚ss‹_off£t


300 + 
˝uid
 * 
hwΩb
->
¥o˚ss‹_size
);

301 
hwpcb
 = (
pcb_°ru˘
 *Ë
˝u
->hwpcb;

302 
ùcb
 = &
	`èsk_thªad_öfo
(
idÀ
)->
pcb
;

308 
hwpcb
->
k•
 = ()
ùcb
 + (
thªad_uni⁄
) - 16;

309 
hwpcb
->
u•
 = 0;

310 
hwpcb
->
±br
 = 
ùcb
->ptbr;

311 
hwpcb
->
pcc
 = 0;

312 
hwpcb
->
a¢
 = 0;

313 
hwpcb
->
unique
 = 
	`vút_to_phys
(
ùcb
);

314 
hwpcb
->
Êags
 = 
ùcb
->flags;

315 
hwpcb
->
ªs1
 = hwpcb->
ªs2
 = 0;

318 
	`DBGS
(("KSP 0x%lx PTBR 0x%lx VPTBR 0x%lx UNIQUE 0x%lx\n",

319 
hwpcb
->
k•
, hwpcb->
±br
, 
hwΩb
->
v±b
, hwpcb->
unique
));

321 
	`DBGS
(("Starting secondary cpu %d: state 0x%lxÖal_flags 0x%lx\n",

322 
˝uid
, 
idÀ
->
°©e
, 
ùcb
->
Êags
));

325 
hwΩb
->
CPU_ª°¨t
 = 
__smp_ˇŒö
;

326 
hwΩb
->
CPU_ª°¨t_d©a
 = (Ë
__smp_ˇŒö
;

329 
	`hwΩb_upd©e_checksum
(
hwΩb
);

336 
˝u
->
Êags
 |= 0x22;

337 
˝u
->
Êags
 &= ~1;

338 
	`wmb
();

340 
	`£nd_£c⁄d¨y_c⁄sﬁe_msg
("START\r\n", 
˝uid
);

343 
timeout
 = 
jiffõs
 + 10*
HZ
;

344 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

345 i‡(
˝u
->
Êags
 & 1)

346 
°¨ãd
;

347 
	`udñay
(10);

348 
	`b¨rõr
();

350 
	`¥ötk
(
KERN_ERR
 "SMP: Pro˚ss‹ %d faûedÅÿ°¨t.\n", 
˝uid
);

353 
°¨ãd
:

354 
	`DBGS
(("£c⁄d¨y_˝u_°¨t: SUCCESS f‹ CPU %d!!!\n", 
˝uid
));

356 
	}
}

361 
__öô


362 
	$smp_boŸ_⁄e_˝u
(
˝uid
)

364 
èsk_°ru˘
 *
idÀ
;

365 
timeout
;

373 
idÀ
 = 
	`f‹k_idÀ
(
˝uid
);

374 i‡(
	`IS_ERR
(
idÀ
))

375 
	`∑nic
("Áûed f‹k f‹ CPU %d", 
˝uid
);

377 
	`DBGS
(("smp_boot_one_cpu: CPU %d state 0x%lx flags 0x%lx\n",

378 
˝uid
, 
idÀ
->
°©e
, idÀ->
Êags
));

381 
smp_£c⁄d¨y_Æive
 = -1;

384 i‡(
	`£c⁄d¨y_˝u_°¨t
(
˝uid
, 
idÀ
))

388 
	`mb
();

389 
smp_£c⁄d¨y_Æive
 = 0;

393 
timeout
 = 
jiffõs
 + 1*
HZ
;

394 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

395 i‡(
smp_£c⁄d¨y_Æive
 == 1)

396 
Æive
;

397 
	`udñay
(10);

398 
	`b¨rõr
();

403 
	`¥ötk
(
KERN_ERR
 "SMP: Pro˚ss‹ %d i†°uck.\n", 
˝uid
);

406 
Æive
:

409 
	}
}

415 
__öô


416 
	$£tup_smp
()

418 
≥r˝u_°ru˘
 *
˝uba£
, *
˝u
;

419 
i
;

421 i‡(
boŸ_˝uid
 != 0) {

422 
	`¥ötk
(
KERN_WARNING
 "SMP: Booting off cpu %d instead of 0?\n",

423 
boŸ_˝uid
);

426 i‡(
hwΩb
->
ƒ_¥o˚ss‹s
 > 1) {

427 
boŸ_˝u_∑Ãev
;

429 
	`DBGS
(("setup_smp:Çr_processors %ld\n",

430 
hwΩb
->
ƒ_¥o˚ss‹s
));

432 
˝uba£
 = (
≥r˝u_°ru˘
 *)

433 ((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

434 
boŸ_˝u_∑Ãev
 = 
˝uba£
->
∑l_ªvisi⁄
;

436 
i
 = 0; i < 
hwΩb
->
ƒ_¥o˚ss‹s
; i++) {

437 
˝u
 = (
≥r˝u_°ru˘
 *)

438 ((*)
˝uba£
 + 
i
*
hwΩb
->
¥o˚ss‹_size
);

439 i‡((
˝u
->
Êags
 & 0x1cc) == 0x1cc) {

440 
smp_num_¥obed
++;

442 
	`˝u_£t
(
i
, 
˝u_¥e£¡_m≠
);

443 
˝u
->
∑l_ªvisi⁄
 = 
boŸ_˝u_∑Ãev
;

446 
	`DBGS
(("setup_smp: CPU %d: flags 0x%lxÅype 0x%lx\n",

447 
i
, 
˝u
->
Êags
, cpu->
ty≥
));

448 
	`DBGS
(("setup_smp: CPU %d: PALÑev 0x%lx\n",

449 
i
, 
˝u
->
∑l_ªvisi⁄
));

452 
smp_num_¥obed
 = 1;

455 
	`¥ötk
(
KERN_INFO
 "SMP: %d CPUsÖrobed -- cpu_present_map = %lx\n",

456 
smp_num_¥obed
, 
˝u_¥e£¡_m≠
.
bôs
[0]);

457 
	}
}

462 
__öô


463 
	$smp_¥ï¨e_˝us
(
max_˝us
)

466 
	`mem£t
(
ùi_d©a
, 0, (ipi_data));

468 
	`cuºít_thªad_öfo
()->
˝u
 = 
boŸ_˝uid
;

470 
	`smp_°‹e_˝u_öfo
(
boŸ_˝uid
);

471 
	`smp_£tup_≥r˝u_timî
(
boŸ_˝uid
);

474 i‡(
smp_num_¥obed
 =1 || 
max_˝us
 == 0) {

475 
˝u_¥e£¡_m≠
 = 
	`˝umask_of_˝u
(
boŸ_˝uid
);

476 
	`¥ötk
(
KERN_INFO
 "SMP mode deactivated.\n");

480 
	`¥ötk
(
KERN_INFO
 "SMP starting up secondaries.\n");

482 
smp_num_˝us
 = 
smp_num_¥obed
;

483 
	}
}

485 
__devöô


486 
	$smp_¥ï¨e_boŸ_˝u
()

488 
	}
}

490 
__devöô


491 
	$__˝u_up
(
˝u
)

493 
	`smp_boŸ_⁄e_˝u
(
˝u
);

495  
	`˝u_⁄löe
(
˝u
Ë? 0 : -
ENOSYS
;

496 
	}
}

498 
__öô


499 
	$smp_˝us_d⁄e
(
max_˝us
)

501 
˝u
;

502 
bogosum
 = 0;

504 
˝u
 = 0; cpu < 
NR_CPUS
; cpu++)

505 i‡(
	`˝u_⁄löe
(
˝u
))

506 
bogosum
 +
˝u_d©a
[
˝u
].
lo›s_≥r_jiffy
;

508 
	`¥ötk
(
KERN_INFO
 "SMP: Total of %dÖrocessorsáctivated "

510 
	`num_⁄löe_˝us
(),

511 (
bogosum
 + 2500Ë/ (500000/
HZ
),

512 ((
bogosum
 + 2500Ë/ (5000/
HZ
)) % 100);

513 
	}
}

517 
	$smp_≥r˝u_timî_öãºu±
(
±_ªgs
 *
ªgs
)

519 
±_ªgs
 *
ﬁd_ªgs
;

520 
˝u
 = 
	`smp_¥o˚ss‹_id
();

521 
u£r
 = 
	`u£r_mode
(
ªgs
);

522 
˝uöfo_Æpha
 *
d©a
 = &
˝u_d©a
[
˝u
];

524 
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

527 
	`¥ofûe_tick
(
CPU_PROFILING
);

529 i‡(!--
d©a
->
¥of_cou¡î
) {

533 
	`úq_íãr
();

535 
	`upd©e_¥o˚ss_times
(
u£r
);

537 
d©a
->
¥of_cou¡î
 = d©a->
¥of_mu…ùlõr
;

539 
	`úq_exô
();

541 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

542 
	}
}

544 
__öô


545 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

547  -
EINVAL
;

548 
	}
}

552 
	$£nd_ùi_mesßge
(
˝umask_t
 
to_whom
, 
ùi_mesßge_ty≥
 
›î©i⁄
)

554 
i
;

556 
	`mb
();

557 
	`f‹_óch_˝u_mask
(
i
, 
to_whom
)

558 
	`£t_bô
(
›î©i⁄
, &
ùi_d©a
[
i
].
bôs
);

560 
	`mb
();

561 
	`f‹_óch_˝u_mask
(
i
, 
to_whom
)

562 
	`wrùú
(
i
);

563 
	}
}

568 
	ssmp_ˇŒ_°ru˘
 {

569 (*
	mfunc
Ë(*
	möfo
);

570 *
	möfo
;

571 
	mwaô
;

572 
©omic_t
 
	mun°¨ãd_cou¡
;

573 
©omic_t
 
	munföished_cou¡
;

576 
smp_ˇŒ_°ru˘
 *
	gsmp_ˇŒ_fun˘i⁄_d©a
;

582 
	$poöãr_lock
 (*
lock
, *
d©a
, 
ªåy
)

584 *
ﬁd
, *
tmp
;

586 
	`mb
();

587 
agaö
:

589 
asm
 volatile (

596 : "=&r"(
ﬁd
), "=m"(*(**)
lock
), "=&r"(
tmp
)

597 : "r"(
d©a
)

600 i‡(
ﬁd
 == 0)

602 i‡(! 
ªåy
)

603  -
EBUSY
;

605 *(**)
lock
)

606 
	`b¨rõr
();

607 
agaö
;

608 
	}
}

611 
	$h™dÀ_ùi
(
±_ªgs
 *
ªgs
)

613 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

614 *
≥ndög_ùis
 = &
ùi_d©a
[
this_˝u
].
bôs
;

615 
›s
;

618 
	`DBGS
(("handle_ipi: on CPU %d ops 0x%lx PC 0x%lx\n",

619 
this_˝u
, *
≥ndög_ùis
, 
ªgs
->
pc
));

622 
	`mb
();

623 (
›s
 = 
	`xchg
(
≥ndög_ùis
, 0)) != 0) {

624 
	`mb
();

626 
which
;

628 
which
 = 
›s
 & -ops;

629 
›s
 &~
which
;

630 
which
 = 
	`__ffs
(which);

632 
which
) {

633 
IPI_RESCHEDULE
:

638 
IPI_CALL_FUNC
:

640 
smp_ˇŒ_°ru˘
 *
d©a
;

641 (*
func
)(*
öfo
);

642 *
öfo
;

643 
waô
;

645 
d©a
 = 
smp_ˇŒ_fun˘i⁄_d©a
;

646 
func
 = 
d©a
->func;

647 
öfo
 = 
d©a
->info;

648 
waô
 = 
d©a
->wait;

652 
	`mb
();

653 
	`©omic_dec
 (&
d©a
->
un°¨ãd_cou¡
);

657 (*
func
)(
öfo
);

660 
	`mb
();

661 i‡(
waô
Ë
	`©omic_dec
 (&
d©a
->
unföished_cou¡
);

665 
IPI_CPU_STOP
:

666 
	`hÆt
();

669 
	`¥ötk
(
KERN_CRIT
 "Unknown IPI on CPU %d: %lu\n",

670 
this_˝u
, 
which
);

673 } 
›s
);

675 
	`mb
();

678 
˝u_d©a
[
this_˝u
].
ùi_cou¡
++;

680 i‡(
hwΩb
->
txrdy
)

681 
	`ªcv_£c⁄d¨y_c⁄sﬁe_msg
();

682 
	}
}

685 
	$smp_£nd_ªscheduÀ
(
˝u
)

687 #ifde‡
DEBUG_IPI_MSG


688 i‡(
˝u
 =
	`h¨d_smp_¥o˚ss‹_id
())

689 
	`¥ötk
(
KERN_WARNING


692 
	`£nd_ùi_mesßge
(
	`˝umask_of_˝u
(
˝u
), 
IPI_RESCHEDULE
);

693 
	}
}

696 
	$smp_£nd_°›
()

698 
˝umask_t
 
to_whom
 = 
˝u_possibÀ_m≠
;

699 
	`˝u_˛ór
(
	`smp_¥o˚ss‹_id
(), 
to_whom
);

700 #ifde‡
DEBUG_IPI_MSG


701 i‡(
	`h¨d_smp_¥o˚ss‹_id
(Ë!
boŸ_˝u_id
)

702 
	`¥ötk
(
KERN_WARNING
 "smp_send_stop: Not on boot cpu.\n");

704 
	`£nd_ùi_mesßge
(
to_whom
, 
IPI_CPU_STOP
);

705 
	}
}

722 
smp_ˇŒ_fun˘i⁄_⁄_˝u
 ((*
func
Ë(*
öfo
), *öfo, 
ªåy
,

723 
waô
, 
˝umask_t
 
to_whom
)

725 
smp_ˇŒ_°ru˘
 
d©a
;

726 
timeout
;

727 
num_˝us_to_ˇŒ
;

730 
	`WARN_ON
(
	`úqs_dißbÀd
());

732 
d©a
.
func
 = func;

733 
d©a
.
öfo
 = info;

734 
d©a
.
waô
 = wait;

736 
	`˝u_˛ór
(
	`smp_¥o˚ss‹_id
(), 
to_whom
);

737 
num_˝us_to_ˇŒ
 = 
	`˝us_weight
(
to_whom
);

739 
	`©omic_£t
(&
d©a
.
un°¨ãd_cou¡
, 
num_˝us_to_ˇŒ
);

740 
	`©omic_£t
(&
d©a
.
unföished_cou¡
, 
num_˝us_to_ˇŒ
);

743 i‡(
	`poöãr_lock
(&
smp_ˇŒ_fun˘i⁄_d©a
, &
d©a
, 
ªåy
))

744  -
EBUSY
;

747 
	`£nd_ùi_mesßge
(
to_whom
, 
IPI_CALL_FUNC
);

750 
timeout
 = 
jiffõs
 + 
HZ
;

751 
	`©omic_ªad
 (&
d©a
.
un°¨ãd_cou¡
) > 0

752 && 
	`time_bef‹e
 (
jiffõs
, 
timeout
))

753 
	`b¨rõr
();

759 i‡(
	`©omic_ªad
(&
d©a
.
un°¨ãd_cou¡
) > 0) {

760 
°¨t_time
 = 
jiffõs
;

761 
	`¥ötk
(
KERN_ERR
 "%s: initialÅimeout --ÅryingÜong wait\n",

762 
__FUNCTION__
);

763 
timeout
 = 
jiffõs
 + 30 * 
HZ
;

764 
	`©omic_ªad
(&
d©a
.
un°¨ãd_cou¡
) > 0

765 && 
	`time_bef‹e
(
jiffõs
, 
timeout
))

766 
	`b¨rõr
();

767 i‡(
	`©omic_ªad
(&
d©a
.
un°¨ãd_cou¡
) <= 0) {

768 
dñè
 = 
jiffõs
 - 
°¨t_time
;

769 
	`¥ötk
(
KERN_ERR


771 
__FUNCTION__
, 
dñè
 / 
HZ
,

772 (100 * (
dñè
 - ((dñè / 
HZ
) * HZ))) / HZ);

777 
	`mb
();

778 
smp_ˇŒ_fun˘i⁄_d©a
 = 
NULL
;

784 
	`BUG_ON
(
	`©omic_ªad
 (&
d©a
.
un°¨ãd_cou¡
) > 0);

787 i‡(
waô
) {

788 
	`©omic_ªad
 (&
d©a
.
unföished_cou¡
) > 0)

789 
	`b¨rõr
();

793 
	}
}

794 
EXPORT_SYMBOL
(
smp_ˇŒ_fun˘i⁄_⁄_˝u
);

797 
smp_ˇŒ_fun˘i⁄
 ((*
func
Ë(*
öfo
), *öfo, 
ªåy
, 
waô
)

799  
	`smp_ˇŒ_fun˘i⁄_⁄_˝u
 (
func
, 
öfo
, 
ªåy
, 
waô
,

800 
˝u_⁄löe_m≠
);

801 
	}
}

802 
EXPORT_SYMBOL
(
smp_ˇŒ_fun˘i⁄
);

805 
	$ùi_imb
(*
ign‹ed
)

807 
	`imb
();

808 
	}
}

811 
	$smp_imb
()

814 i‡(
	`⁄_óch_˝u
(
ùi_imb
, 
NULL
, 1, 1))

815 
	`¥ötk
(
KERN_CRIT
 "smp_imb:Åimed out\n");

816 
	}
}

817 
EXPORT_SYMBOL
(
smp_imb
);

820 
	$ùi_Êush_éb_Æl
(*
ign‹ed
)

822 
	`tbü
();

823 
	}
}

826 
	$Êush_éb_Æl
()

830 i‡(
	`⁄_óch_˝u
(
ùi_Êush_éb_Æl
, 
NULL
, 1, 1)) {

831 
	`¥ötk
(
KERN_CRIT
 "flush_tlb_all:Åimed out\n");

833 
	}
}

835 
	#a¢_locked
(Ë(
˝u_d©a
[
	`smp_¥o˚ss‹_id
()].
a¢_lock
)

	)

838 
	$ùi_Êush_éb_mm
(*
x
)

840 
mm_°ru˘
 *
mm
 = (mm_°ru˘ *Ë
x
;

841 i‡(
mm
 =
cuºít
->
a˘ive_mm
 && !
	`a¢_locked
())

842 
	`Êush_éb_cuºít
(
mm
);

844 
	`Êush_éb_Ÿhî
(
mm
);

845 
	}
}

848 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

850 
	`¥ìm±_dißbÀ
();

852 i‡(
mm
 =
cuºít
->
a˘ive_mm
) {

853 
	`Êush_éb_cuºít
(
mm
);

854 i‡(
	`©omic_ªad
(&
mm
->
mm_u£rs
) <= 1) {

855 
˝u
, 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

856 
˝u
 = 0; cpu < 
NR_CPUS
; cpu++) {

857 i‡(!
	`˝u_⁄löe
(
˝u
Ë|| cpu =
this_˝u
)

859 i‡(
mm
->
c⁄ãxt
[
˝u
])

860 
mm
->
c⁄ãxt
[
˝u
] = 0;

862 
	`¥ìm±_íabÀ
();

867 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_Êush_éb_mm
, 
mm
, 1, 1)) {

868 
	`¥ötk
(
KERN_CRIT
 "flush_tlb_mm:Åimed out\n");

871 
	`¥ìm±_íabÀ
();

872 
	}
}

873 
EXPORT_SYMBOL
(
Êush_éb_mm
);

875 
	sÊush_éb_∑ge_°ru˘
 {

876 
vm_¨ó_°ru˘
 *
	mvma
;

877 
mm_°ru˘
 *
	mmm
;

878 
	maddr
;

882 
	$ùi_Êush_éb_∑ge
(*
x
)

884 
Êush_éb_∑ge_°ru˘
 *
d©a
 = (Êush_éb_∑ge_°ru˘ *)
x
;

885 
mm_°ru˘
 * 
mm
 = 
d©a
->mm;

887 i‡(
mm
 =
cuºít
->
a˘ive_mm
 && !
	`a¢_locked
())

888 
	`Êush_éb_cuºít_∑ge
(
mm
, 
d©a
->
vma
, d©a->
addr
);

890 
	`Êush_éb_Ÿhî
(
mm
);

891 
	}
}

894 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
addr
)

896 
Êush_éb_∑ge_°ru˘
 
d©a
;

897 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

899 
	`¥ìm±_dißbÀ
();

901 i‡(
mm
 =
cuºít
->
a˘ive_mm
) {

902 
	`Êush_éb_cuºít_∑ge
(
mm
, 
vma
, 
addr
);

903 i‡(
	`©omic_ªad
(&
mm
->
mm_u£rs
) <= 1) {

904 
˝u
, 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

905 
˝u
 = 0; cpu < 
NR_CPUS
; cpu++) {

906 i‡(!
	`˝u_⁄löe
(
˝u
Ë|| cpu =
this_˝u
)

908 i‡(
mm
->
c⁄ãxt
[
˝u
])

909 
mm
->
c⁄ãxt
[
˝u
] = 0;

911 
	`¥ìm±_íabÀ
();

916 
d©a
.
vma
 = vma;

917 
d©a
.
mm
 = mm;

918 
d©a
.
addr
 =áddr;

920 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_Êush_éb_∑ge
, &
d©a
, 1, 1)) {

921 
	`¥ötk
(
KERN_CRIT
 "flush_tlb_page:Åimed out\n");

924 
	`¥ìm±_íabÀ
();

925 
	}
}

926 
EXPORT_SYMBOL
(
Êush_éb_∑ge
);

929 
	$Êush_éb_ønge
(
vm_¨ó_°ru˘
 *
vma
, 
°¨t
, 
íd
)

932 
	`Êush_éb_mm
(
vma
->
vm_mm
);

933 
	}
}

934 
EXPORT_SYMBOL
(
Êush_éb_ønge
);

937 
	$ùi_Êush_iˇche_∑ge
(*
x
)

939 
mm_°ru˘
 *
mm
 = (mm_°ru˘ *Ë
x
;

940 i‡(
mm
 =
cuºít
->
a˘ive_mm
 && !
	`a¢_locked
())

941 
	`__lﬂd_√w_mm_c⁄ãxt
(
mm
);

943 
	`Êush_éb_Ÿhî
(
mm
);

944 
	}
}

947 
	$Êush_iˇche_u£r_ønge
(
vm_¨ó_°ru˘
 *
vma
, 
∑ge
 *page,

948 
addr
, 
Àn
)

950 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

952 i‡((
vma
->
vm_Êags
 & 
VM_EXEC
) == 0)

955 
	`¥ìm±_dißbÀ
();

957 i‡(
mm
 =
cuºít
->
a˘ive_mm
) {

958 
	`__lﬂd_√w_mm_c⁄ãxt
(
mm
);

959 i‡(
	`©omic_ªad
(&
mm
->
mm_u£rs
) <= 1) {

960 
˝u
, 
this_˝u
 = 
	`smp_¥o˚ss‹_id
();

961 
˝u
 = 0; cpu < 
NR_CPUS
; cpu++) {

962 i‡(!
	`˝u_⁄löe
(
˝u
Ë|| cpu =
this_˝u
)

964 i‡(
mm
->
c⁄ãxt
[
˝u
])

965 
mm
->
c⁄ãxt
[
˝u
] = 0;

967 
	`¥ìm±_íabÀ
();

972 i‡(
	`smp_ˇŒ_fun˘i⁄
(
ùi_Êush_iˇche_∑ge
, 
mm
, 1, 1)) {

973 
	`¥ötk
(
KERN_CRIT
 "flush_icache_page:Åimed out\n");

976 
	`¥ìm±_íabÀ
();

977 
	}
}

	@arch/alpha/kernel/srm_env.c

32 
	~<löux/kî√l.h
>

33 
	~<löux/moduÀ.h
>

34 
	~<löux/öô.h
>

35 
	~<löux/¥oc_fs.h
>

36 
	~<asm/c⁄sﬁe.h
>

37 
	~<asm/uac˚ss.h
>

38 
	~<asm/machvec.h
>

40 
	#BASE_DIR
 "§m_ívú⁄mít"

	)

41 
	#NAMED_DIR
 "«med_v¨übÀs"

	)

42 
	#NUMBERED_DIR
 "numbîed_v¨übÀs"

	)

43 
	#VERSION
 "0.0.6"

	)

44 
	#NAME
 "§m_ív"

	)

46 
MODULE_AUTHOR
("Jan-Benedict Glaw <jbglaw@lug-owl.de>");

47 
MODULE_DESCRIPTION
("Accessing Alpha SRMÉnvironmentÅhroughÖrocfs interface");

48 
MODULE_LICENSE
("GPL");

50 
	s_§m_ív
 {

51 *
	m«me
;

52 
	mid
;

53 
¥oc_dú_íåy
 *
	m¥oc_íåy
;

54 } 
	t§m_ív_t
;

56 
¥oc_dú_íåy
 *
	gba£_dú
;

57 
¥oc_dú_íåy
 *
	g«med_dú
;

58 
¥oc_dú_íåy
 *
	gnumbîed_dú
;

59 
	gnumbî
[256][4];

61 
§m_ív_t
 
	g§m_«med_íåõs
[] = {

62 { "auto_a˘i⁄", 
ENV_AUTO_ACTION
 },

63 { "boŸ_dev", 
ENV_BOOT_DEV
 },

64 { "boŸdef_dev", 
ENV_BOOTDEF_DEV
 },

65 { "boŸed_dev", 
ENV_BOOTED_DEV
 },

66 { "boŸ_fûe", 
ENV_BOOT_FILE
 },

67 { "boŸed_fûe", 
ENV_BOOTED_FILE
 },

68 { "boŸ_osÊags", 
ENV_BOOT_OSFLAGS
 },

69 { "boŸed_osÊags", 
ENV_BOOTED_OSFLAGS
 },

70 { "boŸ_ª£t", 
ENV_BOOT_RESET
 },

71 { "dump_dev", 
ENV_DUMP_DEV
 },

72 { "íabÀ_audô", 
ENV_ENABLE_AUDIT
 },

73 { "li˚n£", 
ENV_LICENSE
 },

74 { "ch¨_£t", 
ENV_CHAR_SET
 },

75 { "œnguage", 
ENV_LANGUAGE
 },

76 { "ây_dev", 
ENV_TTY_DEV
 },

77 { 
NULL
, 0 },

79 
§m_ív_t
 
	g§m_numbîed_íåõs
[256];

83 
	$§m_ív_ªad
(*
∑ge
, **
°¨t
, 
off_t
 
off
, 
cou¡
, *
eof
,

84 *
d©a
)

86 
nbyãs
;

87 
ªt
;

88 
§m_ív_t
 *
íåy
;

90 i‡(
off
 != 0) {

91 *
eof
 = 1;

95 
íåy
 = (
§m_ív_t
 *Ë
d©a
;

96 
ªt
 = 
	`ˇŒback_gëív
(
íåy
->
id
, 
∑ge
, 
cou¡
);

98 i‡((
ªt
 >> 61) == 0) {

99 
nbyãs
 = (Ë
ªt
;

100 *
eof
 = 1;

102 
nbyãs
 = -
EFAULT
;

104  
nbyãs
;

105 
	}
}

108 
	$§m_ív_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf„r
, 
cou¡
,

109 *
d©a
)

111 
ªs
;

112 
§m_ív_t
 *
íåy
;

113 *
buf
 = (*Ë
	`__gë_‰ì_∑ge
(
GFP_USER
);

114 
ªt1
, 
ªt2
;

116 
íåy
 = (
§m_ív_t
 *Ë
d©a
;

118 i‡(!
buf
)

119  -
ENOMEM
;

121 
ªs
 = -
EINVAL
;

122 i‡(
cou¡
 >
PAGE_SIZE
)

123 
out
;

125 
ªs
 = -
EFAULT
;

126 i‡(
	`c›y_‰om_u£r
(
buf
, 
buf„r
, 
cou¡
))

127 
out
;

128 
buf
[
cou¡
] = '\0';

130 
ªt1
 = 
	`ˇŒback_£ãnv
(
íåy
->
id
, 
buf
, 
cou¡
);

131 i‡((
ªt1
 >> 61) == 0) {

133 
ªt2
 = 
	`ˇŒback_ßve_ív
();

134 (
ªt2
 >> 61) == 1);

135 
ªs
 = (Ë
ªt1
;

138 
out
:

139 
	`‰ì_∑ge
(()
buf
);

140  
ªs
;

141 
	}
}

144 
	$§m_ív_˛ónup
()

146 
§m_ív_t
 *
íåy
;

147 
v¨_num
;

149 i‡(
ba£_dú
) {

153 i‡(
«med_dú
) {

154 
íåy
 = 
§m_«med_íåõs
;

155 
íåy
->
«me
 !
NULL
 &&É¡ry->
id
 != 0) {

156 i‡(
íåy
->
¥oc_íåy
) {

157 
	`ªmove_¥oc_íåy
(
íåy
->
«me
,

158 
«med_dú
);

159 
íåy
->
¥oc_íåy
 = 
NULL
;

161 
íåy
++;

163 
	`ªmove_¥oc_íåy
(
NAMED_DIR
, 
ba£_dú
);

169 i‡(
numbîed_dú
) {

170 
v¨_num
 = 0; var_num <= 255; var_num++) {

171 
íåy
 = &
§m_numbîed_íåõs
[
v¨_num
];

173 i‡(
íåy
->
¥oc_íåy
) {

174 
	`ªmove_¥oc_íåy
(
íåy
->
«me
,

175 
numbîed_dú
);

176 
íåy
->
¥oc_íåy
 = 
NULL
;

177 
íåy
->
«me
 = 
NULL
;

180 
	`ªmove_¥oc_íåy
(
NUMBERED_DIR
, 
ba£_dú
);

183 
	`ªmove_¥oc_íåy
(
BASE_DIR
, 
NULL
);

187 
	}
}

189 
__öô


190 
	$§m_ív_öô
()

192 
§m_ív_t
 *
íåy
;

193 
v¨_num
;

198 i‡(!
Æpha_usög_§m
) {

199 
	`¥ötk
(
KERN_INFO
 "%s: This Alpha system doesn't "

202 "misdëe˘ed)...\n", 
__FUNCTION__
);

203  -
ENODEV
;

209 
v¨_num
 = 0; var_num <= 255; var_num++)

210 
	`•rötf
(
numbî
[
v¨_num
], "%ld", var_num);

215 
ba£_dú
 = 
	`¥oc_mkdú
(
BASE_DIR
, 
NULL
);

216 i‡(!
ba£_dú
) {

217 
	`¥ötk
(
KERN_ERR
 "Couldn't create base dir /proc/%s\n",

218 
BASE_DIR
);

219 
˛ónup
;

221 
ba£_dú
->
ow√r
 = 
THIS_MODULE
;

226 
«med_dú
 = 
	`¥oc_mkdú
(
NAMED_DIR
, 
ba£_dú
);

227 i‡(!
«med_dú
) {

228 
	`¥ötk
(
KERN_ERR
 "Couldn't create dir /proc/%s/%s\n",

229 
BASE_DIR
, 
NAMED_DIR
);

230 
˛ónup
;

232 
«med_dú
->
ow√r
 = 
THIS_MODULE
;

237 
numbîed_dú
 = 
	`¥oc_mkdú
(
NUMBERED_DIR
, 
ba£_dú
);

238 i‡(!
numbîed_dú
) {

239 
	`¥ötk
(
KERN_ERR
 "Couldn't create dir /proc/%s/%s\n",

240 
BASE_DIR
, 
NUMBERED_DIR
);

241 
˛ónup
;

244 
numbîed_dú
->
ow√r
 = 
THIS_MODULE
;

249 
íåy
 = 
§m_«med_íåõs
;

250 
íåy
->
«me
 &&É¡ry->
id
) {

251 
íåy
->
¥oc_íåy
 = 
	`¸óã_¥oc_íåy
”¡ry->
«me
,

252 0644, 
«med_dú
);

253 i‡(!
íåy
->
¥oc_íåy
)

254 
˛ónup
;

256 
íåy
->
¥oc_íåy
->
d©a
 = (*)Éntry;

257 
íåy
->
¥oc_íåy
->
ow√r
 = 
THIS_MODULE
;

258 
íåy
->
¥oc_íåy
->
ªad_¥oc
 = 
§m_ív_ªad
;

259 
íåy
->
¥oc_íåy
->
wrôe_¥oc
 = 
§m_ív_wrôe
;

261 
íåy
++;

267 
v¨_num
 = 0; var_num <= 255; var_num++) {

268 
íåy
 = &
§m_numbîed_íåõs
[
v¨_num
];

269 
íåy
->
«me
 = 
numbî
[
v¨_num
];

271 
íåy
->
¥oc_íåy
 = 
	`¸óã_¥oc_íåy
”¡ry->
«me
,

272 0644, 
numbîed_dú
);

273 i‡(!
íåy
->
¥oc_íåy
)

274 
˛ónup
;

276 
íåy
->
id
 = 
v¨_num
;

277 
íåy
->
¥oc_íåy
->
d©a
 = (*)Éntry;

278 
íåy
->
¥oc_íåy
->
ow√r
 = 
THIS_MODULE
;

279 
íåy
->
¥oc_íåy
->
ªad_¥oc
 = 
§m_ív_ªad
;

280 
íåy
->
¥oc_íåy
->
wrôe_¥oc
 = 
§m_ív_wrôe
;

283 
	`¥ötk
(
KERN_INFO
 "%s: vîsi⁄ %†lﬂded suc˚ssfuŒy\n", 
NAME
,

284 
VERSION
);

288 
˛ónup
:

289 
	`§m_ív_˛ónup
();

291  -
ENOMEM
;

292 
	}
}

294 
__exô


295 
	$§m_ív_exô
()

297 
	`§m_ív_˛ónup
();

298 
	`¥ötk
(
KERN_INFO
 "%s: u∆ﬂded suc˚ssfuŒy\n", 
NAME
);

301 
	}
}

303 
moduÀ_öô
(
§m_ív_öô
);

304 
moduÀ_exô
(
§m_ív_exô
);

	@arch/alpha/kernel/srmcons.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/c⁄sﬁe.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/timî.h
>

16 
	~<löux/ây.h
>

17 
	~<löux/ây_drivî.h
>

18 
	~<löux/ây_Êù.h
>

20 
	~<asm/c⁄sﬁe.h
>

21 
	~<asm/uac˚ss.h
>

24 
DEFINE_SPINLOCK
(
§mc⁄s_ˇŒback_lock
);

25 
	g§m_is_ªgi°îed_c⁄sﬁe
 = 0;

30 
	#MAX_SRM_CONSOLE_DEVICES
 1

	)

32 
	s§mc⁄s_¥iv©e
 {

33 
ây_°ru˘
 *
	mây
;

34 
timî_li°
 
	mtimî
;

35 
•ölock_t
 
	mlock
;

38 
	u_§mc⁄s_ªsu…
 {

40 
	mc
 :61;

41 
	m°©us
 :3;

42 } 
	mbôs
;

43 
	mas_l⁄g
;

44 } 
	t§mc⁄s_ªsu…
;

48 
	$§mc⁄s_do_ª˚ive_ch¨s
(
ây_°ru˘
 *
ây
)

50 
§mc⁄s_ªsu…
 
ªsu…
;

51 
cou¡
 = 0, 
lo›s
 = 0;

54 
ªsu…
.
as_l⁄g
 = 
	`ˇŒback_gëc
(0);

55 i‡(
ªsu…
.
bôs
.
°©us
 < 2) {

56 
	`ây_ö£π_Êù_ch¨
(
ây
, ()
ªsu…
.
bôs
.
c
, 0);

57 
cou¡
++;

59 } (
ªsu…
.
bôs
.
°©us
 & 1Ë&& (++
lo›s
 < 10));

61 i‡(
cou¡
)

62 
	`ây_scheduÀ_Êù
(
ây
);

64  
cou¡
;

65 
	}
}

68 
	$§mc⁄s_ª˚ive_ch¨s
(
d©a
)

70 
§mc⁄s_¥iv©e
 *
§mc⁄•
 = (§mc⁄s_¥iv©ê*)
d©a
;

71 
Êags
;

72 
ö¸
 = 10;

74 
	`loˇl_úq_ßve
(
Êags
);

75 i‡(
	`•ö_åylock
(&
§mc⁄s_ˇŒback_lock
)) {

76 i‡(!
	`§mc⁄s_do_ª˚ive_ch¨s
(
§mc⁄•
->
ây
))

77 
ö¸
 = 100;

78 
	`•ö_u∆ock
(&
§mc⁄s_ˇŒback_lock
);

81 
	`•ö_lock
(&
§mc⁄•
->
lock
);

82 i‡(
§mc⁄•
->
ây
) {

83 
§mc⁄•
->
timî
.
expúes
 = 
jiffõs
 + 
ö¸
;

84 
	`add_timî
(&
§mc⁄•
->
timî
);

86 
	`•ö_u∆ock
(&
§mc⁄•
->
lock
);

88 
	`loˇl_úq_ª°‹e
(
Êags
);

89 
	}
}

93 
	$§mc⁄s_do_wrôe
(
ây_°ru˘
 *
ây
, c⁄° *
buf
, 
cou¡
)

95 
°r_¸
[1] = "\r";

96 
c
, 
ªmaöög
 = 
cou¡
;

97 
§mc⁄s_ªsu…
 
ªsu…
;

98 *
cur
;

99 
√ed_¸
;

101 
cur
 = (*)
buf
; 
ªmaöög
 > 0; ) {

102 
√ed_¸
 = 0;

107 
c
 = 0; c < 
	`mö_t
(, 128L, 
ªmaöög
Ë&& !
√ed_¸
; c++)

108 i‡(
cur
[
c
] == '\n')

109 
√ed_¸
 = 1;

111 
c
 > 0) {

112 
ªsu…
.
as_l⁄g
 = 
	`ˇŒback_puts
(0, 
cur
, 
c
);

113 
c
 -
ªsu…
.
bôs
.c;

114 
ªmaöög
 -
ªsu…
.
bôs
.
c
;

115 
cur
 +
ªsu…
.
bôs
.
c
;

120 i‡(
ây
)

121 
	`§mc⁄s_do_ª˚ive_ch¨s
(
ây
);

124 
√ed_¸
) {

125 
ªsu…
.
as_l⁄g
 = 
	`ˇŒback_puts
(0, 
°r_¸
, 1);

126 i‡(
ªsu…
.
bôs
.
c
 > 0)

127 
√ed_¸
 = 0;

130  
cou¡
;

131 
	}
}

134 
	$§mc⁄s_wrôe
(
ây_°ru˘
 *
ây
,

135 c⁄° *
buf
, 
cou¡
)

137 
Êags
;

139 
	`•ö_lock_úqßve
(&
§mc⁄s_ˇŒback_lock
, 
Êags
);

140 
	`§mc⁄s_do_wrôe
(
ây
, (c⁄° *Ë
buf
, 
cou¡
);

141 
	`•ö_u∆ock_úqª°‹e
(&
§mc⁄s_ˇŒback_lock
, 
Êags
);

143  
cou¡
;

144 
	}
}

147 
	$§mc⁄s_wrôe_room
(
ây_°ru˘
 *
ây
)

150 
	}
}

153 
	$§mc⁄s_ch¨s_ö_buf„r
(
ây_°ru˘
 *
ây
)

156 
	}
}

159 
	$§mc⁄s_gë_¥iv©e_°ru˘
(
§mc⁄s_¥iv©e
 **
ps
)

161 
§mc⁄s_¥iv©e
 *
§mc⁄•
 = 
NULL
;

162 
	`DEFINE_SPINLOCK
(
§mc⁄•_lock
);

163 
Êags
;

164 
ªtvÆ
 = 0;

166 i‡(
§mc⁄•
 =
NULL
) {

167 
§mc⁄•
 = 
	`kmÆloc
((*§mc⁄•), 
GFP_KERNEL
);

168 
	`•ö_lock_úqßve
(&
§mc⁄•_lock
, 
Êags
);

170 i‡(
§mc⁄•
 =
NULL
)

171 
ªtvÆ
 = -
ENOMEM
;

173 
§mc⁄•
->
ây
 = 
NULL
;

174 
	`•ö_lock_öô
(&
§mc⁄•
->
lock
);

175 
	`öô_timî
(&
§mc⁄•
->
timî
);

178 
	`•ö_u∆ock_úqª°‹e
(&
§mc⁄•_lock
, 
Êags
);

181 *
ps
 = 
§mc⁄•
;

182  
ªtvÆ
;

183 
	}
}

186 
	$§mc⁄s_›í
(
ây_°ru˘
 *
ây
, 
fûe
 *
fûp
)

188 
§mc⁄s_¥iv©e
 *
§mc⁄•
;

189 
Êags
;

190 
ªtvÆ
;

192 
ªtvÆ
 = 
	`§mc⁄s_gë_¥iv©e_°ru˘
(&
§mc⁄•
);

193 i‡(
ªtvÆ
)

194  
ªtvÆ
;

196 
	`•ö_lock_úqßve
(&
§mc⁄•
->
lock
, 
Êags
);

198 i‡(!
§mc⁄•
->
ây
) {

199 
ây
->
drivî_d©a
 = 
§mc⁄•
;

201 
§mc⁄•
->
ây
 =Åty;

202 
§mc⁄•
->
timî
.
fun˘i⁄
 = 
§mc⁄s_ª˚ive_ch¨s
;

203 
§mc⁄•
->
timî
.
d©a
 = ()srmconsp;

204 
§mc⁄•
->
timî
.
expúes
 = 
jiffõs
 + 10;

205 
	`add_timî
(&
§mc⁄•
->
timî
);

208 
	`•ö_u∆ock_úqª°‹e
(&
§mc⁄•
->
lock
, 
Êags
);

211 
	}
}

214 
	$§mc⁄s_˛o£
(
ây_°ru˘
 *
ây
, 
fûe
 *
fûp
)

216 
§mc⁄s_¥iv©e
 *
§mc⁄•
 = 
ây
->
drivî_d©a
;

217 
Êags
;

219 
	`•ö_lock_úqßve
(&
§mc⁄•
->
lock
, 
Êags
);

221 i‡(
ây
->
cou¡
 == 1) {

222 
§mc⁄•
->
ây
 = 
NULL
;

223 
	`dñ_timî
(&
§mc⁄•
->
timî
);

226 
	`•ö_u∆ock_úqª°‹e
(&
§mc⁄•
->
lock
, 
Êags
);

227 
	}
}

230 
ây_drivî
 *
	g§mc⁄s_drivî
;

232 c⁄° 
ây_›î©i⁄s
 
	g§mc⁄s_›s
 = {

233 .
›í
 = 
§mc⁄s_›í
,

234 .
	g˛o£
 = 
§mc⁄s_˛o£
,

235 .
	gwrôe
 = 
§mc⁄s_wrôe
,

236 .
	gwrôe_room
 = 
§mc⁄s_wrôe_room
,

237 .
	gch¨s_ö_buf„r

§mc⁄s_ch¨s_ö_buf„r
,

240 
__öô


241 
	$§mc⁄s_öô
()

243 i‡(
§m_is_ªgi°îed_c⁄sﬁe
) {

244 
ây_drivî
 *
drivî
;

245 
îr
;

247 
drivî
 = 
	`Æloc_ây_drivî
(
MAX_SRM_CONSOLE_DEVICES
);

248 i‡(!
drivî
)

249  -
ENOMEM
;

250 
drivî
->
drivî_«me
 = "srm";

251 
drivî
->
«me
 = "srm";

252 
drivî
->
maj‹
 = 0;

253 
drivî
->
mö‹_°¨t
 = 0;

254 
drivî
->
ty≥
 = 
TTY_DRIVER_TYPE_SYSTEM
;

255 
drivî
->
subty≥
 = 
SYSTEM_TYPE_SYSCONS
;

256 
drivî
->
öô_ãrmios
 = 
ây_°d_ãrmios
;

257 
	`ây_£t_›î©i⁄s
(
drivî
, &
§mc⁄s_›s
);

258 
îr
 = 
	`ây_ªgi°î_drivî
(
drivî
);

259 i‡(
îr
) {

260 
	`put_ây_drivî
(
drivî
);

261  
îr
;

263 
§mc⁄s_drivî
 = 
drivî
;

266  -
ENODEV
;

267 
	}
}

269 
moduÀ_öô
(
§mc⁄s_öô
);

276 
	$§m_c⁄sﬁe_wrôe
(
c⁄sﬁe
 *
co
, c⁄° *
s
, 
cou¡
)

278 
Êags
;

280 
	`•ö_lock_úqßve
(&
§mc⁄s_ˇŒback_lock
, 
Êags
);

281 
	`§mc⁄s_do_wrôe
(
NULL
, 
s
, 
cou¡
);

282 
	`•ö_u∆ock_úqª°‹e
(&
§mc⁄s_ˇŒback_lock
, 
Êags
);

283 
	}
}

285 
ây_drivî
 *

286 
	$§m_c⁄sﬁe_devi˚
(
c⁄sﬁe
 *
co
, *
ödex
)

288 *
ödex
 = 
co
->index;

289  
§mc⁄s_drivî
;

290 
	}
}

292 
__öô


293 
	$§m_c⁄sﬁe_£tup
(
c⁄sﬁe
 *
co
, *
›ti⁄s
)

296 
	}
}

298 
c⁄sﬁe
 
	g§mc⁄s
 = {

299 .
«me
 = "srm",

300 .
	gwrôe
 = 
§m_c⁄sﬁe_wrôe
,

301 .
	gdevi˚
 = 
§m_c⁄sﬁe_devi˚
,

302 .
	g£tup
 = 
§m_c⁄sﬁe_£tup
,

303 .
	gÊags
 = 
CON_PRINTBUFFER
 | 
CON_BOOT
,

304 .
	gödex
 = -1,

307 
__öô


308 
	$ªgi°î_§m_c⁄sﬁe
()

310 i‡(!
§m_is_ªgi°îed_c⁄sﬁe
) {

311 
	`ˇŒback_›í_c⁄sﬁe
();

312 
	`ªgi°î_c⁄sﬁe
(&
§mc⁄s
);

313 
§m_is_ªgi°îed_c⁄sﬁe
 = 1;

315 
	}
}

317 
__öô


318 
	$uƒegi°î_§m_c⁄sﬁe
()

320 i‡(
§m_is_ªgi°îed_c⁄sﬁe
) {

321 
	`ˇŒback_˛o£_c⁄sﬁe
();

322 
	`uƒegi°î_c⁄sﬁe
(&
§mc⁄s
);

323 
§m_is_ªgi°îed_c⁄sﬁe
 = 0;

325 
	}
}

	@arch/alpha/kernel/sys_alcor.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/ªboŸ.h
>

18 
	~<löux/bô›s.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/io.h
>

23 
	~<asm/dma.h
>

24 
	~<asm/mmu_c⁄ãxt.h
>

25 
	~<asm/úq.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/c‹e_cü.h
>

28 
	~<asm/ébÊush.h
>

30 
	~"¥Ÿo.h
"

31 
	~"úq_im∂.h
"

32 
	~"pci_im∂.h
"

33 
	~"machvec_im∂.h
"

37 
	gˇched_úq_mask
;

39 
ölöe
 

40 
	$Æc‹_upd©e_úq_hw
(
mask
)

42 *(
vuù
)
GRU_INT_MASK
 = 
mask
;

43 
	`mb
();

44 
	}
}

46 
ölöe
 

47 
	$Æc‹_íabÀ_úq
(
úq
)

49 
	`Æc‹_upd©e_úq_hw
(
ˇched_úq_mask
 |1UL << (
úq
 - 16));

50 
	}
}

53 
	$Æc‹_dißbÀ_úq
(
úq
)

55 
	`Æc‹_upd©e_úq_hw
(
ˇched_úq_mask
 &~(1UL << (
úq
 - 16)));

56 
	}
}

59 
	$Æc‹_mask_™d_ack_úq
(
úq
)

61 
	`Æc‹_dißbÀ_úq
(
úq
);

64 *(
vuù
)
GRU_INT_CLEAR
 = 1 << (
úq
 - 16); 
	`mb
();

65 *(
vuù
)
GRU_INT_CLEAR
 = 0; 
	`mb
();

66 
	}
}

69 
	$Æc‹_°¨tup_úq
(
úq
)

71 
	`Æc‹_íabÀ_úq
(
úq
);

73 
	}
}

76 
	$Æc‹_iß_mask_™d_ack_úq
(
úq
)

78 
	`i8259a_mask_™d_ack_úq
(
úq
);

81 *(
vuù
)
GRU_INT_CLEAR
 = 0x80000000; 
	`mb
();

82 *(
vuù
)
GRU_INT_CLEAR
 = 0; 
	`mb
();

83 
	}
}

86 
	$Æc‹_íd_úq
(
úq
)

88 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

89 
	`Æc‹_íabÀ_úq
(
úq
);

90 
	}
}

92 
hw_öãºu±_ty≥
 
	gÆc‹_úq_ty≥
 = {

93 .
ty≥«me
 = "ALCOR",

94 .
	g°¨tup
 = 
Æc‹_°¨tup_úq
,

95 .
	gshutdown
 = 
Æc‹_dißbÀ_úq
,

96 .
	gíabÀ
 = 
Æc‹_íabÀ_úq
,

97 .
	gdißbÀ
 = 
Æc‹_dißbÀ_úq
,

98 .
	gack
 = 
Æc‹_mask_™d_ack_úq
,

99 .
	gíd
 = 
Æc‹_íd_úq
,

103 
	$Æc‹_devi˚_öãºu±
(
ve˘‹
)

105 
∂d
;

106 
i
;

109 
∂d
 = (*(
vuù
)
GRU_INT_REQ
Ë& 
GRU_INT_REQ_BITS
;

115 
∂d
) {

116 
i
 = 
	`ffz
(~
∂d
);

117 
∂d
 &=Öld - 1;

118 i‡(
i
 == 31) {

119 
	`iß_devi˚_öãºu±
(
ve˘‹
);

121 
	`h™dÀ_úq
(16 + 
i
);

124 
	}
}

126 
__öô


127 
	$Æc‹_öô_úq
()

129 
i
;

131 i‡(
Æpha_usög_§m
)

132 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
;

134 *(
vuù
)
GRU_INT_MASK
 = 0; 
	`mb
();

135 *(
vuù
)
GRU_INT_EDGE
 = 0; 
	`mb
();

136 *(
vuù
)
GRU_INT_HILO
 = 0x80000000U; 
	`mb
();

137 *(
vuù
)
GRU_INT_CLEAR
 = 0; 
	`mb
();

139 
i
 = 16; i < 48; ++i) {

143 i‡(
i
 >= 16+20 && i <= 16+30)

145 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

146 
úq_desc
[
i
].
chù
 = &
Æc‹_úq_ty≥
;

148 
i8259a_úq_ty≥
.
ack
 = 
Æc‹_iß_mask_™d_ack_úq
;

150 
	`öô_i8259a_úqs
();

151 
	`comm⁄_öô_iß_dma
();

153 
	`£tup_úq
(16+31, &
iß_ˇsˇde_úqa˘i⁄
);

154 
	}
}

202 
__öô


203 
	$Æc‹_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

205 
úq_èb
[7][5] 
__öôd©a
 = {

216 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 12, 
úqs_≥r_¶Ÿ
 = 5;

217  
COMMON_TABLE_LOOKUP
;

218 
	}
}

221 
	$Æc‹_kûl_¨ch
(
mode
)

223 
	`cü_kûl_¨ch
(
mode
);

225 #i‚de‡
ALPHA_RESTORE_SRM_SETUP


226 
mode
) {

227 
LINUX_REBOOT_CMD_RESTART
:

229 i‡(
Æpha_usög_§m
) {

230 *(
vuù
Ë
GRU_RESET
 = 0x0000dead;

231 
	`mb
();

234 
LINUX_REBOOT_CMD_HALT
:

236 
LINUX_REBOOT_CMD_POWER_OFF
:

240 
	`hÆt
();

242 
	}
}

244 
__öô


245 
	$Æc‹_öô_pci
()

247 
pci_dev
 *
dev
;

249 
	`cü_öô_pci
();

256 
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_DEC
,

257 
PCI_DEVICE_ID_DEC_TULIP
,

258 
NULL
);

259 i‡(
dev
 && dev->
dev‚
 =
	`PCI_DEVFN
(6,0)) {

260 
Æpha_mv
.
sys
.
cü
.
gru_öt_ªq_bôs
 = 
XLT_GRU_INT_REQ_BITS
;

261 
	`¥ötk
(
KERN_INFO
 "%s: Detected AS500 or XLT motherboard.\n",

262 
__FUNCTION__
);

264 
	`pci_dev_put
(
dev
);

265 
	}
}

272 
Æpha_machöe_ve˘‹
 
Æc‹_mv
 
	g__öômv
 = {

273 .
ve˘‹_«me
 = "Alcor",

274 
	gDO_EV5_MMU
,

275 
	gDO_DEFAULT_RTC
,

276 
	gDO_CIA_IO
,

277 .
	gmachöe_check
 = 
cü_machöe_check
,

278 .
	gmax_iß_dma_addªss
 = 
ALPHA_ALCOR_MAX_ISA_DMA_ADDRESS
,

279 .
	gmö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

280 .
	gmö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

282 .
	gƒ_úqs
 = 48,

283 .
	gdevi˚_öãºu±
 = 
Æc‹_devi˚_öãºu±
,

285 .
	göô_¨ch
 = 
cü_öô_¨ch
,

286 .
	göô_úq
 = 
Æc‹_öô_úq
,

287 .
	göô_πc
 = 
comm⁄_öô_πc
,

288 .
	göô_pci
 = 
Æc‹_öô_pci
,

289 .
	gkûl_¨ch
 = 
Æc‹_kûl_¨ch
,

290 .
	gpci_m≠_úq
 = 
Æc‹_m≠_úq
,

291 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

293 .
	gsys
 = { .
cü
 = {

294 .
gru_öt_ªq_bôs
 = 
ALCOR_GRU_INT_REQ_BITS


297 
	$ALIAS_MV
(
Æc‹
)

299 
Æpha_machöe_ve˘‹
 
x…_mv
 
__öômv
 = {

300 .
ve˘‹_«me
 = "XLT",

301 
DO_EV5_MMU
,

302 
DO_DEFAULT_RTC
,

303 
DO_CIA_IO
,

304 .
machöe_check
 = 
cü_machöe_check
,

305 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

306 .
mö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

307 .
mö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

309 .
ƒ_úqs
 = 48,

310 .
devi˚_öãºu±
 = 
Æc‹_devi˚_öãºu±
,

312 .
öô_¨ch
 = 
cü_öô_¨ch
,

313 .
öô_úq
 = 
Æc‹_öô_úq
,

314 .
öô_πc
 = 
comm⁄_öô_πc
,

315 .
öô_pci
 = 
Æc‹_öô_pci
,

316 .
kûl_¨ch
 = 
Æc‹_kûl_¨ch
,

317 .
pci_m≠_úq
 = 
Æc‹_m≠_úq
,

318 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

320 .
sys
 = { .
cü
 = {

321 .
gru_öt_ªq_bôs
 = 
XLT_GRU_INT_REQ_BITS


323 
	}
};

	@arch/alpha/kernel/sys_cabriolet.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/bô›s.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/dma.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/mmu_c⁄ãxt.h
>

25 
	~<asm/io.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/c‹e_≠ecs.h
>

28 
	~<asm/c‹e_cü.h
>

29 
	~<asm/c‹e_lˇ.h
>

30 
	~<asm/ébÊush.h
>

32 
	~"¥Ÿo.h
"

33 
	~"úq_im∂.h
"

34 
	~"pci_im∂.h
"

35 
	~"machvec_im∂.h
"

39 
	gˇched_úq_mask
 = ~0UL;

41 
ölöe
 

42 
	$ˇbriﬁë_upd©e_úq_hw
(
úq
, 
mask
)

44 
ofs
 = (
úq
 - 16) / 8;

45 
	`outb
(
mask
 >> (16 + 
ofs
 * 8), 0x804 + ofs);

46 
	}
}

48 
ölöe
 

49 
	$ˇbriﬁë_íabÀ_úq
(
úq
)

51 
	`ˇbriﬁë_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 &= ~(1UL << irq));

52 
	}
}

55 
	$ˇbriﬁë_dißbÀ_úq
(
úq
)

57 
	`ˇbriﬁë_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 |= 1UL << irq);

58 
	}
}

61 
	$ˇbriﬁë_°¨tup_úq
(
úq
)

63 
	`ˇbriﬁë_íabÀ_úq
(
úq
);

65 
	}
}

68 
	$ˇbriﬁë_íd_úq
(
úq
)

70 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

71 
	`ˇbriﬁë_íabÀ_úq
(
úq
);

72 
	}
}

74 
hw_öãºu±_ty≥
 
	gˇbriﬁë_úq_ty≥
 = {

75 .
ty≥«me
 = "CABRIOLET",

76 .
	g°¨tup
 = 
ˇbriﬁë_°¨tup_úq
,

77 .
	gshutdown
 = 
ˇbriﬁë_dißbÀ_úq
,

78 .
	gíabÀ
 = 
ˇbriﬁë_íabÀ_úq
,

79 .
	gdißbÀ
 = 
ˇbriﬁë_dißbÀ_úq
,

80 .
	gack
 = 
ˇbriﬁë_dißbÀ_úq
,

81 .
	gíd
 = 
ˇbriﬁë_íd_úq
,

85 
	$ˇbriﬁë_devi˚_öãºu±
(
v
)

87 
∂d
;

88 
i
;

91 
∂d
 = 
	`öb
(0x804) | (inb(0x805) << 8) | (inb(0x806) << 16);

97 
∂d
) {

98 
i
 = 
	`ffz
(~
∂d
);

99 
∂d
 &=Öld - 1;

100 i‡(
i
 == 4) {

101 
	`iß_devi˚_öãºu±
(
v
);

103 
	`h™dÀ_úq
(16 + 
i
);

106 
	}
}

108 
__öô


109 
comm⁄_öô_úq
((*
§m_dev_öt
)(
v
))

111 
	`öô_i8259a_úqs
();

113 i‡(
Æpha_usög_§m
) {

114 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_dev_öt
;

115 
	`öô_§m_úqs
(35, 0);

118 
i
;

120 
	`outb
(0xff, 0x804);

121 
	`outb
(0xff, 0x805);

122 
	`outb
(0xff, 0x806);

124 
i
 = 16; i < 35; ++i) {

125 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

126 
úq_desc
[
i
].
chù
 = &
ˇbriﬁë_úq_ty≥
;

130 
	`comm⁄_öô_iß_dma
();

131 
	`£tup_úq
(16+4, &
iß_ˇsˇde_úqa˘i⁄
);

132 
	}
}

134 #i‚de‡
CONFIG_ALPHA_PC164


135 
__öô


136 
	$ˇbriﬁë_öô_úq
()

138 
	`comm⁄_öô_úq
(
§m_devi˚_öãºu±
);

139 
	}
}

142 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_PC164
)

157 
	$pc164_§m_devi˚_öãºu±
(
v
)

159 
__mö_ùl
 = 
	`gëùl
();

160 
	`§m_devi˚_öãºu±
(
v
);

161 
__mö_ùl
 = 0;

162 
	}
}

165 
	$pc164_devi˚_öãºu±
(
v
)

167 
__mö_ùl
 = 
	`gëùl
();

168 
	`ˇbriﬁë_devi˚_öãºu±
(
v
);

169 
__mö_ùl
 = 0;

170 
	}
}

172 
__öô


173 
	$pc164_öô_úq
()

175 
	`comm⁄_öô_úq
(
pc164_§m_devi˚_öãºu±
);

176 
	}
}

193 
ölöe
 
__öô


194 
	$eb66p_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

196 
úq_èb
[5][5] 
__öôd©a
 = {

204 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 10, 
úqs_≥r_¶Ÿ
 = 5;

205  
COMMON_TABLE_LOOKUP
;

206 
	}
}

223 
ölöe
 
__öô


224 
	$ˇbriﬁë_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

226 
úq_èb
[5][5] 
__öôd©a
 = {

234 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 9, 
úqs_≥r_¶Ÿ
 = 5;

235  
COMMON_TABLE_LOOKUP
;

236 
	}
}

238 
ölöe
 
__öô


239 
	$ˇbriﬁë_öô_pci
()

241 
	`comm⁄_öô_pci
();

242 
	`ns87312_íabÀ_ide
(0x398);

243 
	}
}

245 
ölöe
 
__öô


246 
	$cü_ˇb_öô_pci
()

248 
	`cü_öô_pci
();

249 
	`ns87312_íabÀ_ide
(0x398);

250 
	}
}

294 
ölöe
 
__öô


295 
	$Æph≠c164_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

297 
úq_èb
[7][5] 
__öôd©a
 = {

307 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 11, 
úqs_≥r_¶Ÿ
 = 5;

308  
COMMON_TABLE_LOOKUP
;

309 
	}
}

311 
ölöe
 
__öô


312 
	$Æph≠c164_öô_pci
()

314 
	`cü_öô_pci
();

315 
	`SMC93x_Inô
();

316 
	}
}

323 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_CABRIOLET
)

324 
Æpha_machöe_ve˘‹
 
ˇbriﬁë_mv
 
	g__öômv
 = {

325 .
ve˘‹_«me
 = "Cabriolet",

326 
	gDO_EV4_MMU
,

327 
	gDO_DEFAULT_RTC
,

328 
	gDO_APECS_IO
,

329 .
	gmachöe_check
 = 
≠ecs_machöe_check
,

330 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

331 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

332 .
	gmö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

334 .
	gƒ_úqs
 = 35,

335 .
	gdevi˚_öãºu±
 = 
ˇbriﬁë_devi˚_öãºu±
,

337 .
	göô_¨ch
 = 
≠ecs_öô_¨ch
,

338 .
	göô_úq
 = 
ˇbriﬁë_öô_úq
,

339 .
	göô_πc
 = 
comm⁄_öô_πc
,

340 .
	göô_pci
 = 
ˇbriﬁë_öô_pci
,

341 .
	gpci_m≠_úq
 = 
ˇbriﬁë_m≠_úq
,

342 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

344 #i‚de‡
CONFIG_ALPHA_EB64P


345 
	$ALIAS_MV
(
ˇbriﬁë
)

349 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_EB164
)

350 
Æpha_machöe_ve˘‹
 
eb164_mv
 
__öômv
 = {

351 .
ve˘‹_«me
 = "EB164",

352 
DO_EV5_MMU
,

353 
DO_DEFAULT_RTC
,

354 
DO_CIA_IO
,

355 .
machöe_check
 = 
cü_machöe_check
,

356 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

357 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

358 .
mö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

360 .
ƒ_úqs
 = 35,

361 .
devi˚_öãºu±
 = 
ˇbriﬁë_devi˚_öãºu±
,

363 .
öô_¨ch
 = 
cü_öô_¨ch
,

364 .
öô_úq
 = 
ˇbriﬁë_öô_úq
,

365 .
öô_πc
 = 
comm⁄_öô_πc
,

366 .
öô_pci
 = 
cü_ˇb_öô_pci
,

367 .
kûl_¨ch
 = 
cü_kûl_¨ch
,

368 .
pci_m≠_úq
 = 
ˇbriﬁë_m≠_úq
,

369 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

370 
	}
};

371 
	$ALIAS_MV
(
eb164
)

374 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_EB66P
)

375 
Æpha_machöe_ve˘‹
 
eb66p_mv
 
__öômv
 = {

376 .
ve˘‹_«me
 = "EB66+",

377 
DO_EV4_MMU
,

378 
DO_DEFAULT_RTC
,

379 
DO_LCA_IO
,

380 .
machöe_check
 = 
lˇ_machöe_check
,

381 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

382 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

383 .
mö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

385 .
ƒ_úqs
 = 35,

386 .
devi˚_öãºu±
 = 
ˇbriﬁë_devi˚_öãºu±
,

388 .
öô_¨ch
 = 
lˇ_öô_¨ch
,

389 .
öô_úq
 = 
ˇbriﬁë_öô_úq
,

390 .
öô_πc
 = 
comm⁄_öô_πc
,

391 .
öô_pci
 = 
ˇbriﬁë_öô_pci
,

392 .
pci_m≠_úq
 = 
eb66p_m≠_úq
,

393 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

394 
	}
};

395 
	$ALIAS_MV
(
eb66p
)

398 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_LX164
)

399 
Æpha_machöe_ve˘‹
 
lx164_mv
 
__öômv
 = {

400 .
ve˘‹_«me
 = "LX164",

401 
DO_EV5_MMU
,

402 
DO_DEFAULT_RTC
,

403 
DO_PYXIS_IO
,

404 .
machöe_check
 = 
cü_machöe_check
,

405 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

406 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

407 .
mö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

408 .
pci_dac_off£t
 = 
PYXIS_DAC_OFFSET
,

410 .
ƒ_úqs
 = 35,

411 .
devi˚_öãºu±
 = 
ˇbriﬁë_devi˚_öãºu±
,

413 .
öô_¨ch
 = 
pyxis_öô_¨ch
,

414 .
öô_úq
 = 
ˇbriﬁë_öô_úq
,

415 .
öô_πc
 = 
comm⁄_öô_πc
,

416 .
öô_pci
 = 
Æph≠c164_öô_pci
,

417 .
kûl_¨ch
 = 
cü_kûl_¨ch
,

418 .
pci_m≠_úq
 = 
Æph≠c164_m≠_úq
,

419 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

420 
	}
};

421 
	$ALIAS_MV
(
lx164
)

424 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_PC164
)

425 
Æpha_machöe_ve˘‹
 
pc164_mv
 
__öômv
 = {

426 .
ve˘‹_«me
 = "PC164",

427 
DO_EV5_MMU
,

428 
DO_DEFAULT_RTC
,

429 
DO_CIA_IO
,

430 .
machöe_check
 = 
cü_machöe_check
,

431 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

432 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

433 .
mö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

435 .
ƒ_úqs
 = 35,

436 .
devi˚_öãºu±
 = 
pc164_devi˚_öãºu±
,

438 .
öô_¨ch
 = 
cü_öô_¨ch
,

439 .
öô_úq
 = 
pc164_öô_úq
,

440 .
öô_πc
 = 
comm⁄_öô_πc
,

441 .
öô_pci
 = 
Æph≠c164_öô_pci
,

442 .
kûl_¨ch
 = 
cü_kûl_¨ch
,

443 .
pci_m≠_úq
 = 
Æph≠c164_m≠_úq
,

444 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

445 
	}
};

446 
	$ALIAS_MV
(
pc164
)

	@arch/alpha/kernel/sys_dp264.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/ty≥s.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sched.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/bô›s.h
>

23 
	~<asm/±ø˚.h
>

24 
	~<asm/sy°em.h
>

25 
	~<asm/dma.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/io.h
>

29 
	~<asm/pgèbÀ.h
>

30 
	~<asm/c‹e_tsu«mi.h
>

31 
	~<asm/hwΩb.h
>

32 
	~<asm/ébÊush.h
>

34 
	~"¥Ÿo.h
"

35 
	~"úq_im∂.h
"

36 
	~"pci_im∂.h
"

37 
	~"machvec_im∂.h
"

41 
	gˇched_úq_mask
;

43 
	g˝u_úq_afföôy
[4] = { 0UL, 0UL, 0UL, 0UL };

45 
DEFINE_SPINLOCK
(
dp264_úq_lock
);

48 
	$tsu«mi_upd©e_úq_hw
(
mask
)

50 
tsu«mi_cchù
 *
cchù
 = 
TSUNAMI_cchù
;

51 
iß_íabÀ
 = 1UL << 55;

52 
b˝u
 = 
boŸ_˝uid
;

54 #ifde‡
CONFIG_SMP


55 vﬁ©ûê*
dim0
, *
dim1
, *
dim2
, *
dim3
;

56 
mask0
, 
mask1
, 
mask2
, 
mask3
, 
dummy
;

58 
mask
 &~
iß_íabÀ
;

59 
mask0
 = 
mask
 & 
˝u_úq_afföôy
[0];

60 
mask1
 = 
mask
 & 
˝u_úq_afföôy
[1];

61 
mask2
 = 
mask
 & 
˝u_úq_afföôy
[2];

62 
mask3
 = 
mask
 & 
˝u_úq_afföôy
[3];

64 i‡(
b˝u
 =0Ë
mask0
 |
iß_íabÀ
;

65 i‡(
b˝u
 =1Ë
mask1
 |
iß_íabÀ
;

66 i‡(
b˝u
 =2Ë
mask2
 |
iß_íabÀ
;

67 
mask3
 |
iß_íabÀ
;

69 
dim0
 = &
cchù
->dim0.
c§
;

70 
dim1
 = &
cchù
->dim1.
c§
;

71 
dim2
 = &
cchù
->dim2.
c§
;

72 
dim3
 = &
cchù
->dim3.
c§
;

73 i‡(!
	`˝u_possibÀ
(0)Ë
dim0
 = &
dummy
;

74 i‡(!
	`˝u_possibÀ
(1)Ë
dim1
 = &
dummy
;

75 i‡(!
	`˝u_possibÀ
(2)Ë
dim2
 = &
dummy
;

76 i‡(!
	`˝u_possibÀ
(3)Ë
dim3
 = &
dummy
;

78 *
dim0
 = 
mask0
;

79 *
dim1
 = 
mask1
;

80 *
dim2
 = 
mask2
;

81 *
dim3
 = 
mask3
;

82 
	`mb
();

83 *
dim0
;

84 *
dim1
;

85 *
dim2
;

86 *
dim3
;

88 vﬁ©ûê*
dimB
;

89 i‡(
b˝u
 =0Ë
dimB
 = &
cchù
->
dim0
.
c§
;

90 i‡(
b˝u
 =1Ë
dimB
 = &
cchù
->
dim1
.
c§
;

91 i‡(
b˝u
 =2Ë
dimB
 = &
cchù
->
dim2
.
c§
;

92 
dimB
 = &
cchù
->
dim3
.
c§
;

94 *
dimB
 = 
mask
 | 
iß_íabÀ
;

95 
	`mb
();

96 *
dimB
;

98 
	}
}

101 
	$dp264_íabÀ_úq
(
úq
)

103 
	`•ö_lock
(&
dp264_úq_lock
);

104 
ˇched_úq_mask
 |1UL << 
úq
;

105 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

106 
	`•ö_u∆ock
(&
dp264_úq_lock
);

107 
	}
}

110 
	$dp264_dißbÀ_úq
(
úq
)

112 
	`•ö_lock
(&
dp264_úq_lock
);

113 
ˇched_úq_mask
 &~(1UL << 
úq
);

114 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

115 
	`•ö_u∆ock
(&
dp264_úq_lock
);

116 
	}
}

119 
	$dp264_°¨tup_úq
(
úq
)

121 
	`dp264_íabÀ_úq
(
úq
);

123 
	}
}

126 
	$dp264_íd_úq
(
úq
)

128 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

129 
	`dp264_íabÀ_úq
(
úq
);

130 
	}
}

133 
	$˛ù≥r_íabÀ_úq
(
úq
)

135 
	`•ö_lock
(&
dp264_úq_lock
);

136 
ˇched_úq_mask
 |1UL << (
úq
 - 16);

137 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

138 
	`•ö_u∆ock
(&
dp264_úq_lock
);

139 
	}
}

142 
	$˛ù≥r_dißbÀ_úq
(
úq
)

144 
	`•ö_lock
(&
dp264_úq_lock
);

145 
ˇched_úq_mask
 &~(1UL << (
úq
 - 16));

146 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

147 
	`•ö_u∆ock
(&
dp264_úq_lock
);

148 
	}
}

151 
	$˛ù≥r_°¨tup_úq
(
úq
)

153 
	`˛ù≥r_íabÀ_úq
(
úq
);

155 
	}
}

158 
	$˛ù≥r_íd_úq
(
úq
)

160 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

161 
	`˛ù≥r_íabÀ_úq
(
úq
);

162 
	}
}

165 
	$˝u_£t_úq_afföôy
(
úq
, 
˝umask_t
 
afföôy
)

167 
˝u
;

169 
˝u
 = 0; cpu < 4; cpu++) {

170 
aff
 = 
˝u_úq_afföôy
[
˝u
];

171 i‡(
	`˝u_is£t
(
˝u
, 
afföôy
))

172 
aff
 |1UL << 
úq
;

174 
aff
 &~(1UL << 
úq
);

175 
˝u_úq_afföôy
[
˝u
] = 
aff
;

177 
	}
}

180 
	$dp264_£t_afföôy
(
úq
, 
˝umask_t
 
afföôy
)

182 
	`•ö_lock
(&
dp264_úq_lock
);

183 
	`˝u_£t_úq_afföôy
(
úq
, 
afföôy
);

184 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

185 
	`•ö_u∆ock
(&
dp264_úq_lock
);

186 
	}
}

189 
	$˛ù≥r_£t_afföôy
(
úq
, 
˝umask_t
 
afföôy
)

191 
	`•ö_lock
(&
dp264_úq_lock
);

192 
	`˝u_£t_úq_afföôy
(
úq
 - 16, 
afföôy
);

193 
	`tsu«mi_upd©e_úq_hw
(
ˇched_úq_mask
);

194 
	`•ö_u∆ock
(&
dp264_úq_lock
);

195 
	}
}

197 
hw_öãºu±_ty≥
 
	gdp264_úq_ty≥
 = {

198 .
ty≥«me
 = "DP264",

199 .
	g°¨tup
 = 
dp264_°¨tup_úq
,

200 .
	gshutdown
 = 
dp264_dißbÀ_úq
,

201 .
	gíabÀ
 = 
dp264_íabÀ_úq
,

202 .
	gdißbÀ
 = 
dp264_dißbÀ_úq
,

203 .
	gack
 = 
dp264_dißbÀ_úq
,

204 .
	gíd
 = 
dp264_íd_úq
,

205 .
	g£t_afföôy
 = 
dp264_£t_afföôy
,

208 
hw_öãºu±_ty≥
 
	g˛ù≥r_úq_ty≥
 = {

209 .
ty≥«me
 = "CLIPPER",

210 .
	g°¨tup
 = 
˛ù≥r_°¨tup_úq
,

211 .
	gshutdown
 = 
˛ù≥r_dißbÀ_úq
,

212 .
	gíabÀ
 = 
˛ù≥r_íabÀ_úq
,

213 .
	gdißbÀ
 = 
˛ù≥r_dißbÀ_úq
,

214 .
	gack
 = 
˛ù≥r_dißbÀ_úq
,

215 .
	gíd
 = 
˛ù≥r_íd_úq
,

216 .
	g£t_afföôy
 = 
˛ù≥r_£t_afföôy
,

220 
	$dp264_devi˚_öãºu±
(
ve˘‹
)

223 
	`¥ötk
("dp264_device_interrupt: NOT IMPLEMENTED YET!! \n");

225 
∂d
;

226 
i
;

229 
∂d
 = 
TSUNAMI_cchù
->
dú0
.
c§
;

235 
∂d
) {

236 
i
 = 
	`ffz
(~
∂d
);

237 
∂d
 &=Öld - 1;

238 i‡(
i
 == 55)

239 
	`iß_devi˚_öãºu±
(
ve˘‹
);

241 
	`h™dÀ_úq
(16 + 
i
);

243 
TSUNAMI_cchù
->
dú0
.
c§
 = 1UL << 
i
; 
	`mb
();

244 
tmp
 = 
TSUNAMI_cchù
->
dú0
.
c§
;

248 
	}
}

251 
	$dp264_§m_devi˚_öãºu±
(
ve˘‹
)

253 
úq
;

255 
úq
 = (
ve˘‹
 - 0x800) >> 4;

268 i‡(
úq
 >= 32)

269 
úq
 -= 16;

271 
	`h™dÀ_úq
(
úq
);

272 
	}
}

275 
	$˛ù≥r_§m_devi˚_öãºu±
(
ve˘‹
)

277 
úq
;

279 
úq
 = (
ve˘‹
 - 0x800) >> 4;

293 
	`h™dÀ_úq
(
úq
);

294 
	}
}

296 
__öô


297 
	$öô_tsu«mi_úqs
(
hw_öãºu±_ty≥
 * 
›s
, 
imö
, 
imax
)

299 
i
;

300 
i
 = 
imö
; i <
imax
; ++i) {

301 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

302 
úq_desc
[
i
].
chù
 = 
›s
;

304 
	}
}

306 
__öô


307 
	$dp264_öô_úq
()

309 
	`outb
(0, 
DMA1_RESET_REG
);

310 
	`outb
(0, 
DMA2_RESET_REG
);

311 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
);

312 
	`outb
(0, 
DMA2_MASK_REG
);

314 i‡(
Æpha_usög_§m
)

315 
Æpha_mv
.
devi˚_öãºu±
 = 
dp264_§m_devi˚_öãºu±
;

317 
	`tsu«mi_upd©e_úq_hw
(0);

319 
	`öô_i8259a_úqs
();

320 
	`öô_tsu«mi_úqs
(&
dp264_úq_ty≥
, 16, 47);

321 
	}
}

323 
__öô


324 
	$˛ù≥r_öô_úq
()

326 
	`outb
(0, 
DMA1_RESET_REG
);

327 
	`outb
(0, 
DMA2_RESET_REG
);

328 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
);

329 
	`outb
(0, 
DMA2_MASK_REG
);

331 i‡(
Æpha_usög_§m
)

332 
Æpha_mv
.
devi˚_öãºu±
 = 
˛ù≥r_§m_devi˚_öãºu±
;

334 
	`tsu«mi_upd©e_úq_hw
(0);

336 
	`öô_i8259a_úqs
();

337 
	`öô_tsu«mi_úqs
(&
˛ù≥r_úq_ty≥
, 24, 63);

338 
	}
}

396 
__öô


397 
	$iß_úq_fixup
(
pci_dev
 *
dev
, 
úq
)

399 
u8
 
úq8
;

401 i‡(
úq
 > 0)

402  
úq
;

407 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
úq8
);

409  
úq8
 & 0xf;

410 
	}
}

412 
__öô


413 
	$dp264_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

415 
úq_èb
[6][5] 
__öôd©a
 = {

424 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 10, 
úqs_≥r_¶Ÿ
 = 5;

425 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

426 
úq
 = 
COMMON_TABLE_LOOKUP
;

428 i‡(
úq
 > 0)

429 
úq
 +16 * 
ho£
->
ödex
;

431  
	`iß_úq_fixup
(
dev
, 
úq
);

432 
	}
}

434 
__öô


435 
	$m⁄ë_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

437 
úq_èb
[13][5] 
__öôd©a
 = {

458 c⁄° 
mö_id£l
 = 3, 
max_id£l
 = 15, 
úqs_≥r_¶Ÿ
 = 5;

460  
	`iß_úq_fixup
(
dev
, 
COMMON_TABLE_LOOKUP
);

461 
	}
}

463 
u8
 
__öô


464 
	$m⁄ë_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

466 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

467 
¶Ÿ
, 
pö
 = *
pöp
;

469 i‡(!
dev
->
bus
->
∑ª¡
) {

470 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

473 i‡(
ho£
->
ödex
 =1 && 
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) {

474 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

479 i‡(
ho£
->
ödex
 == 1 &&

480 
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) {

481 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

484 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
)) ;

487 
dev
 = dev->
bus
->
£lf
;

489 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

490 } 
dev
->
bus
->
£lf
);

492 *
pöp
 = 
pö
;

493  
¶Ÿ
;

494 
	}
}

496 
__öô


497 
	$webbrick_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

499 
úq_èb
[13][5] 
__öôd©a
 = {

513 c⁄° 
mö_id£l
 = 7, 
max_id£l
 = 17, 
úqs_≥r_¶Ÿ
 = 5;

515  
	`iß_úq_fixup
(
dev
, 
COMMON_TABLE_LOOKUP
);

516 
	}
}

518 
__öô


519 
	$˛ù≥r_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

521 
úq_èb
[7][5] 
__öôd©a
 = {

531 c⁄° 
mö_id£l
 = 1, 
max_id£l
 = 7, 
úqs_≥r_¶Ÿ
 = 5;

532 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

533 
úq
 = 
COMMON_TABLE_LOOKUP
;

535 i‡(
úq
 > 0)

536 
úq
 +16 * 
ho£
->
ödex
;

538  
	`iß_úq_fixup
(
dev
, 
úq
);

539 
	}
}

541 
__öô


542 
	$dp264_öô_pci
()

544 
	`comm⁄_öô_pci
();

545 
	`SMC669_Inô
(0);

546 
	`loˇã_™d_öô_vga
(
NULL
);

547 
	}
}

549 
__öô


550 
	$m⁄ë_öô_pci
()

552 
	`comm⁄_öô_pci
();

553 
	`SMC669_Inô
(1);

554 
	`es1888_öô
();

555 
	`loˇã_™d_öô_vga
(
NULL
);

556 
	}
}

558 
__öô


559 
	$˛ù≥r_öô_pci
()

561 
	`comm⁄_öô_pci
();

562 
	`loˇã_™d_öô_vga
(
NULL
);

563 
	}
}

565 
__öô


566 
	$webbrick_öô_¨ch
()

568 
	`tsu«mi_öô_¨ch
();

571 
ho£_hód
->
sg_iß
->
Æign_íåy
 = 4;

572 
ho£_hód
->
sg_pci
->
Æign_íåy
 = 4;

573 
	}
}

580 
Æpha_machöe_ve˘‹
 
dp264_mv
 
	g__öômv
 = {

581 .
ve˘‹_«me
 = "DP264",

582 
	gDO_EV6_MMU
,

583 
	gDO_DEFAULT_RTC
,

584 
	gDO_TSUNAMI_IO
,

585 .
	gmachöe_check
 = 
tsu«mi_machöe_check
,

586 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

587 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

588 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

589 .
	gpci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

591 .
	gƒ_úqs
 = 64,

592 .
	gdevi˚_öãºu±
 = 
dp264_devi˚_öãºu±
,

594 .
	göô_¨ch
 = 
tsu«mi_öô_¨ch
,

595 .
	göô_úq
 = 
dp264_öô_úq
,

596 .
	göô_πc
 = 
comm⁄_öô_πc
,

597 .
	göô_pci
 = 
dp264_öô_pci
,

598 .
	gkûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

599 .
	gpci_m≠_úq
 = 
dp264_m≠_úq
,

600 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

602 
	$ALIAS_MV
(
dp264
)

604 
Æpha_machöe_ve˘‹
 
m⁄ë_mv
 
__öômv
 = {

605 .
ve˘‹_«me
 = "Monet",

606 
DO_EV6_MMU
,

607 
DO_DEFAULT_RTC
,

608 
DO_TSUNAMI_IO
,

609 .
machöe_check
 = 
tsu«mi_machöe_check
,

610 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

611 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

612 .
mö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

613 .
pci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

615 .
ƒ_úqs
 = 64,

616 .
devi˚_öãºu±
 = 
dp264_devi˚_öãºu±
,

618 .
öô_¨ch
 = 
tsu«mi_öô_¨ch
,

619 .
öô_úq
 = 
dp264_öô_úq
,

620 .
öô_πc
 = 
comm⁄_öô_πc
,

621 .
öô_pci
 = 
m⁄ë_öô_pci
,

622 .
kûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

623 .
pci_m≠_úq
 = 
m⁄ë_m≠_úq
,

624 .
pci_swizzÀ
 = 
m⁄ë_swizzÀ
,

625 
	}
};

627 
Æpha_machöe_ve˘‹
 
webbrick_mv
 
	g__öômv
 = {

628 .
ve˘‹_«me
 = "Webbrick",

629 
	gDO_EV6_MMU
,

630 
	gDO_DEFAULT_RTC
,

631 
	gDO_TSUNAMI_IO
,

632 .
	gmachöe_check
 = 
tsu«mi_machöe_check
,

633 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

634 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

635 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

636 .
	gpci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

638 .
	gƒ_úqs
 = 64,

639 .
	gdevi˚_öãºu±
 = 
dp264_devi˚_öãºu±
,

641 .
	göô_¨ch
 = 
webbrick_öô_¨ch
,

642 .
	göô_úq
 = 
dp264_öô_úq
,

643 .
	göô_πc
 = 
comm⁄_öô_πc
,

644 .
	göô_pci
 = 
comm⁄_öô_pci
,

645 .
	gkûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

646 .
	gpci_m≠_úq
 = 
webbrick_m≠_úq
,

647 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

650 
Æpha_machöe_ve˘‹
 
˛ù≥r_mv
 
	g__öômv
 = {

651 .
ve˘‹_«me
 = "Clipper",

652 
	gDO_EV6_MMU
,

653 
	gDO_DEFAULT_RTC
,

654 
	gDO_TSUNAMI_IO
,

655 .
	gmachöe_check
 = 
tsu«mi_machöe_check
,

656 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

657 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

658 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

659 .
	gpci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

661 .
	gƒ_úqs
 = 64,

662 .
	gdevi˚_öãºu±
 = 
dp264_devi˚_öãºu±
,

664 .
	göô_¨ch
 = 
tsu«mi_öô_¨ch
,

665 .
	göô_úq
 = 
˛ù≥r_öô_úq
,

666 .
	göô_πc
 = 
comm⁄_öô_πc
,

667 .
	göô_pci
 = 
˛ù≥r_öô_pci
,

668 .
	gkûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

669 .
	gpci_m≠_úq
 = 
˛ù≥r_m≠_úq
,

670 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

678 
Æpha_machöe_ve˘‹
 
sh¨k_mv
 
	g__öômv
 = {

679 .
ve˘‹_«me
 = "Shark",

680 
	gDO_EV6_MMU
,

681 
	gDO_DEFAULT_RTC
,

682 
	gDO_TSUNAMI_IO
,

683 .
	gmachöe_check
 = 
tsu«mi_machöe_check
,

684 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

685 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

686 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

687 .
	gpci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

689 .
	gƒ_úqs
 = 64,

690 .
	gdevi˚_öãºu±
 = 
dp264_devi˚_öãºu±
,

692 .
	göô_¨ch
 = 
tsu«mi_öô_¨ch
,

693 .
	göô_úq
 = 
˛ù≥r_öô_úq
,

694 .
	göô_πc
 = 
comm⁄_öô_πc
,

695 .
	göô_pci
 = 
comm⁄_öô_pci
,

696 .
	gkûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

697 .
	gpci_m≠_úq
 = 
˛ù≥r_m≠_úq
,

698 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

	@arch/alpha/kernel/sys_eb64p.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/bô›s.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_≠ecs.h
>

27 
	~<asm/c‹e_lˇ.h
>

28 
	~<asm/hwΩb.h
>

29 
	~<asm/ébÊush.h
>

31 
	~"¥Ÿo.h
"

32 
	~"úq_im∂.h
"

33 
	~"pci_im∂.h
"

34 
	~"machvec_im∂.h
"

38 
	gˇched_úq_mask
 = -1;

40 
ölöe
 

41 
	$eb64p_upd©e_úq_hw
(
úq
, 
mask
)

43 
	`outb
(
mask
 >> (
úq
 >= 24 ? 24 : 16), (irq >= 24 ? 0x27 : 0x26));

44 
	}
}

46 
ölöe
 

47 
	$eb64p_íabÀ_úq
(
úq
)

49 
	`eb64p_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 &= ~(1 << irq));

50 
	}
}

53 
	$eb64p_dißbÀ_úq
(
úq
)

55 
	`eb64p_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 |= 1 << irq);

56 
	}
}

59 
	$eb64p_°¨tup_úq
(
úq
)

61 
	`eb64p_íabÀ_úq
(
úq
);

63 
	}
}

66 
	$eb64p_íd_úq
(
úq
)

68 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

69 
	`eb64p_íabÀ_úq
(
úq
);

70 
	}
}

72 
hw_öãºu±_ty≥
 
	geb64p_úq_ty≥
 = {

73 .
ty≥«me
 = "EB64P",

74 .
	g°¨tup
 = 
eb64p_°¨tup_úq
,

75 .
	gshutdown
 = 
eb64p_dißbÀ_úq
,

76 .
	gíabÀ
 = 
eb64p_íabÀ_úq
,

77 .
	gdißbÀ
 = 
eb64p_dißbÀ_úq
,

78 .
	gack
 = 
eb64p_dißbÀ_úq
,

79 .
	gíd
 = 
eb64p_íd_úq
,

83 
	$eb64p_devi˚_öãºu±
(
ve˘‹
)

85 
∂d
;

86 
i
;

89 
∂d
 = 
	`öb
(0x26) | (inb(0x27) << 8);

95 
∂d
) {

96 
i
 = 
	`ffz
(~
∂d
);

97 
∂d
 &=Öld - 1;

99 i‡(
i
 == 5) {

100 
	`iß_devi˚_öãºu±
(
ve˘‹
);

102 
	`h™dÀ_úq
(16 + 
i
);

105 
	}
}

107 
__öô


108 
	$eb64p_öô_úq
()

110 
i
;

112 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_CABRIOLET
)

118 i‡(
	`öw
(0x806) != 0xffff) {

119 
Æpha_machöe_ve˘‹
 
ˇbriﬁë_mv
;

121 
	`¥ötk
("Detected Cabriolet: correcting HWRPB.\n");

123 
hwΩb
->
sys_v¨üti⁄
 |= 2L << 10;

124 
	`hwΩb_upd©e_checksum
(
hwΩb
);

126 
Æpha_mv
 = 
ˇbriﬁë_mv
;

127 
Æpha_mv
.
	`öô_úq
();

132 
	`outb
(0xff, 0x26);

133 
	`outb
(0xff, 0x27);

135 
	`öô_i8259a_úqs
();

137 
i
 = 16; i < 32; ++i) {

138 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

139 
úq_desc
[
i
].
chù
 = &
eb64p_úq_ty≥
;

142 
	`comm⁄_öô_iß_dma
();

143 
	`£tup_úq
(16+5, &
iß_ˇsˇde_úqa˘i⁄
);

144 
	}
}

188 
__öô


189 
	$eb64p_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

191 
úq_èb
[5][5] 
__öôd©a
 = {

199 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 9, 
úqs_≥r_¶Ÿ
 = 5;

200  
COMMON_TABLE_LOOKUP
;

201 
	}
}

208 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_EB64P
)

209 
Æpha_machöe_ve˘‹
 
eb64p_mv
 
	g__öômv
 = {

210 .
ve˘‹_«me
 = "EB64+",

211 
	gDO_EV4_MMU
,

212 
	gDO_DEFAULT_RTC
,

213 
	gDO_APECS_IO
,

214 .
	gmachöe_check
 = 
≠ecs_machöe_check
,

215 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

216 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

217 .
	gmö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

219 .
	gƒ_úqs
 = 32,

220 .
	gdevi˚_öãºu±
 = 
eb64p_devi˚_öãºu±
,

222 .
	göô_¨ch
 = 
≠ecs_öô_¨ch
,

223 .
	göô_úq
 = 
eb64p_öô_úq
,

224 .
	göô_πc
 = 
comm⁄_öô_πc
,

225 .
	göô_pci
 = 
comm⁄_öô_pci
,

226 .
	gkûl_¨ch
 = 
NULL
,

227 .
	gpci_m≠_úq
 = 
eb64p_m≠_úq
,

228 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

230 
	$ALIAS_MV
(
eb64p
)

233 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_EB66
)

234 
Æpha_machöe_ve˘‹
 
eb66_mv
 
__öômv
 = {

235 .
ve˘‹_«me
 = "EB66",

236 
DO_EV4_MMU
,

237 
DO_DEFAULT_RTC
,

238 
DO_LCA_IO
,

239 .
machöe_check
 = 
lˇ_machöe_check
,

240 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

241 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

242 .
mö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

244 .
ƒ_úqs
 = 32,

245 .
devi˚_öãºu±
 = 
eb64p_devi˚_öãºu±
,

247 .
öô_¨ch
 = 
lˇ_öô_¨ch
,

248 .
öô_úq
 = 
eb64p_öô_úq
,

249 .
öô_πc
 = 
comm⁄_öô_πc
,

250 .
öô_pci
 = 
comm⁄_öô_pci
,

251 .
pci_m≠_úq
 = 
eb64p_m≠_úq
,

252 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

253 
	}
};

254 
	$ALIAS_MV
(
eb66
)

	@arch/alpha/kernel/sys_eiger.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/bô›s.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/dma.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/mmu_c⁄ãxt.h
>

25 
	~<asm/io.h
>

26 
	~<asm/pci.h
>

27 
	~<asm/pgèbÀ.h
>

28 
	~<asm/c‹e_tsu«mi.h
>

29 
	~<asm/hwΩb.h
>

30 
	~<asm/ébÊush.h
>

32 
	~"¥Ÿo.h
"

33 
	~"úq_im∂.h
"

34 
	~"pci_im∂.h
"

35 
	~"machvec_im∂.h
"

41 
	gˇched_úq_mask
[2] = { -1, -1 };

43 
ölöe
 

44 
	$eigî_upd©e_úq_hw
(
úq
, 
mask
)

46 
ªgaddr
;

48 
mask
 = (
úq
 >= 64 ? mask << 16 : mask >> ((irq - 16) & 0x30));

49 
ªgaddr
 = 0x510 + (((
úq
 - 16) >> 2) & 0x0c);

50 
	`oué
(
mask
 & 0xffff0000UL, 
ªgaddr
);

51 
	}
}

53 
ölöe
 

54 
	$eigî_íabÀ_úq
(
úq
)

56 
mask
;

57 
mask
 = (
ˇched_úq_mask
[
úq
 >= 64] &= ~(1UL << (irq & 63)));

58 
	`eigî_upd©e_úq_hw
(
úq
, 
mask
);

59 
	}
}

62 
	$eigî_dißbÀ_úq
(
úq
)

64 
mask
;

65 
mask
 = (
ˇched_úq_mask
[
úq
 >= 64] |= 1UL << (irq & 63));

66 
	`eigî_upd©e_úq_hw
(
úq
, 
mask
);

67 
	}
}

70 
	$eigî_°¨tup_úq
(
úq
)

72 
	`eigî_íabÀ_úq
(
úq
);

74 
	}
}

77 
	$eigî_íd_úq
(
úq
)

79 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

80 
	`eigî_íabÀ_úq
(
úq
);

81 
	}
}

83 
hw_öãºu±_ty≥
 
	geigî_úq_ty≥
 = {

84 .
ty≥«me
 = "EIGER",

85 .
	g°¨tup
 = 
eigî_°¨tup_úq
,

86 .
	gshutdown
 = 
eigî_dißbÀ_úq
,

87 .
	gíabÀ
 = 
eigî_íabÀ_úq
,

88 .
	gdißbÀ
 = 
eigî_dißbÀ_úq
,

89 .
	gack
 = 
eigî_dißbÀ_úq
,

90 .
	gíd
 = 
eigî_íd_úq
,

94 
	$eigî_devi˚_öãºu±
(
ve˘‹
)

96 
öt°©us
;

114 
öt°©us
 = 
	`öw
(0x500) & 15;

115 i‡(
öt°©us
) {

121 i‡(
öt°©us
 & 8Ë
	`h™dÀ_úq
(16+3);

122 i‡(
öt°©us
 & 4Ë
	`h™dÀ_úq
(16+2);

123 i‡(
öt°©us
 & 2Ë
	`h™dÀ_úq
(16+1);

124 i‡(
öt°©us
 & 1Ë
	`h™dÀ_úq
(16+0);

126 
	`iß_devi˚_öãºu±
(
ve˘‹
);

128 
	}
}

131 
	$eigî_§m_devi˚_öãºu±
(
ve˘‹
)

133 
úq
 = (
ve˘‹
 - 0x800) >> 4;

134 
	`h™dÀ_úq
(
úq
);

135 
	}
}

137 
__öô


138 
	$eigî_öô_úq
()

140 
i
;

142 
	`outb
(0, 
DMA1_RESET_REG
);

143 
	`outb
(0, 
DMA2_RESET_REG
);

144 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
);

145 
	`outb
(0, 
DMA2_MASK_REG
);

147 i‡(
Æpha_usög_§m
)

148 
Æpha_mv
.
devi˚_öãºu±
 = 
eigî_§m_devi˚_öãºu±
;

150 
i
 = 16; i < 128; i += 16)

151 
	`eigî_upd©e_úq_hw
(
i
, -1);

153 
	`öô_i8259a_úqs
();

155 
i
 = 16; i < 128; ++i) {

156 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

157 
úq_desc
[
i
].
chù
 = &
eigî_úq_ty≥
;

159 
	}
}

161 
__öô


162 
	$eigî_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

164 
u8
 
úq_‹ig
;

173 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
úq_‹ig
);

175  
úq_‹ig
 - 0x80;

176 
	}
}

178 
u8
 
__öô


179 
	$eigî_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

181 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

182 
¶Ÿ
, 
pö
 = *
pöp
;

183 
bridge_cou¡
 = 0;

186 
back∂™e
 = 
	`öw
(0x502) & 0x0f;

188 
back∂™e
)

190 0x00: 
bridge_cou¡
 = 0; ;

191 0x01: 
bridge_cou¡
 = 1; ;

192 0x03: 
bridge_cou¡
 = 2; ;

193 0x07: 
bridge_cou¡
 = 3; ;

194 0x0f: 
bridge_cou¡
 = 4; ;

197 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

198 
dev
->
bus
->
£lf
) {

200 i‡(
ho£
->
ödex
 == 0

201 && (
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
)

202 > 20 - 
bridge_cou¡
)) {

203 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

207 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
));

210 
dev
 = dev->
bus
->
£lf
;

212 *
pöp
 = 
pö
;

213  
¶Ÿ
;

214 
	}
}

220 
Æpha_machöe_ve˘‹
 
eigî_mv
 
	g__öômv
 = {

221 .
ve˘‹_«me
 = "Eiger",

222 
	gDO_EV6_MMU
,

223 
	gDO_DEFAULT_RTC
,

224 
	gDO_TSUNAMI_IO
,

225 .
	gmachöe_check
 = 
tsu«mi_machöe_check
,

226 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

227 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

228 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

229 .
	gpci_dac_off£t
 = 
TSUNAMI_DAC_OFFSET
,

231 .
	gƒ_úqs
 = 128,

232 .
	gdevi˚_öãºu±
 = 
eigî_devi˚_öãºu±
,

234 .
	göô_¨ch
 = 
tsu«mi_öô_¨ch
,

235 .
	göô_úq
 = 
eigî_öô_úq
,

236 .
	göô_πc
 = 
comm⁄_öô_πc
,

237 .
	göô_pci
 = 
comm⁄_öô_pci
,

238 .
	gkûl_¨ch
 = 
tsu«mi_kûl_¨ch
,

239 .
	gpci_m≠_úq
 = 
eigî_m≠_úq
,

240 .
	gpci_swizzÀ
 = 
eigî_swizzÀ
,

242 
ALIAS_MV
(
eigî
)

	@arch/alpha/kernel/sys_jensen.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/sched.h
>

14 
	~<löux/pci.h
>

15 
	~<löux/öô.h
>

17 
	~<asm/±ø˚.h
>

18 
	~<asm/sy°em.h
>

20 
	#__EXTERN_INLINE
 
ölöe


	)

21 
	~<asm/io.h
>

22 
	~<asm/jí£n.h
>

23 #unde‡
__EXTERN_INLINE


25 
	~<asm/dma.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/pgèbÀ.h
>

29 
	~<asm/ébÊush.h
>

31 
	~"¥Ÿo.h
"

32 
	~"úq_im∂.h
"

33 
	~"pci_im∂.h
"

34 
	~"machvec_im∂.h
"

66 
	$jí£n_loˇl_°¨tup
(
úq
)

69 i‡(
úq
 == 7)

70 
	`i8259a_°¨tup_úq
(1);

76 i‡(
úq_desc
[
úq
].
a˘i⁄
)

77 
úq_desc
[
úq
].
a˘i⁄
->
Êags
 |
IRQF_DISABLED
;

79 
	}
}

82 
	$jí£n_loˇl_shutdown
(
úq
)

85 i‡(
úq
 == 7)

86 
	`i8259a_dißbÀ_úq
(1);

87 
	}
}

90 
	$jí£n_loˇl_íabÀ
(
úq
)

93 i‡(
úq
 == 7)

94 
	`i8259a_íabÀ_úq
(1);

95 
	}
}

98 
	$jí£n_loˇl_dißbÀ
(
úq
)

101 i‡(
úq
 == 7)

102 
	`i8259a_dißbÀ_úq
(1);

103 
	}
}

106 
	$jí£n_loˇl_ack
(
úq
)

109 i‡(
úq
 == 7)

110 
	`i8259a_mask_™d_ack_úq
(1);

111 
	}
}

114 
	$jí£n_loˇl_íd
(
úq
)

117 i‡(
úq
 == 7)

118 
	`i8259a_íd_úq
(1);

119 
	}
}

121 
hw_öãºu±_ty≥
 
	gjí£n_loˇl_úq_ty≥
 = {

122 .
ty≥«me
 = "LOCAL",

123 .
	g°¨tup
 = 
jí£n_loˇl_°¨tup
,

124 .
	gshutdown
 = 
jí£n_loˇl_shutdown
,

125 .
	gíabÀ
 = 
jí£n_loˇl_íabÀ
,

126 .
	gdißbÀ
 = 
jí£n_loˇl_dißbÀ
,

127 .
	gack
 = 
jí£n_loˇl_ack
,

128 .
	gíd
 = 
jí£n_loˇl_íd
,

132 
	$jí£n_devi˚_öãºu±
(
ve˘‹
)

134 
úq
;

136 
ve˘‹
) {

138 
	`¥ötk
("Whee.. NMIÑeceived. Probable hardwareÉrror\n");

139 
	`¥ötk
("61=%02x, 461=%02x\n", 
	`öb
(0x61), inb(0x461));

143 0x900: 
úq
 = 4; ;

144 0x920: 
úq
 = 3; ;

145 0x980: 
úq
 = 1; ;

146 0x990: 
úq
 = 9; ;

149 i‡(
ve˘‹
 > 0x900) {

150 
	`¥ötk
("Unknow¿loˇ»öãºu± %lx\n", 
ve˘‹
);

154 
úq
 = (
ve˘‹
 - 0x800) >> 4;

155 i‡(
úq
 == 1)

156 
úq
 = 7;

161 i‡(
úq_desc
[
úq
].
a˘i⁄
 =
NULL
) {

163 i‡(
ve˘‹
 >= 0x900)

166 
	`öb
(0x64);

167 
	`öb
(0x60);

169 
	`öb
(0x3fa);

170 
	`öb
(0x2fa);

171 
	`outb
(0x0c, 0x3fc);

172 
	`outb
(0x0c, 0x2fc);

174 
	`outb
(0,0x61);

175 
	`outb
(0,0x461);

182 
œ°_msg
 = 0, 
œ°_cc
 = 0;

183 
œ°_úq
 = -1, 
cou¡
 = 0;

184 
cc
;

186 
__asm
 
	`__vﬁ©ûe
("Ωc¯%0" : "Ù"(
cc
));

187 ++
cou¡
;

188 
	#JENSEN_CYCLES_PER_SEC
 (150000000)

	)

189 i‡(
cc
 - 
œ°_msg
 > ((
JENSEN_CYCLES_PER_SEC
) * 3) ||

190 
úq
 !
œ°_úq
) {

191 
	`¥ötk
(
KERN_CRIT
 " irq %d count %d cc %u @ %lx\n",

192 
úq
, 
cou¡
, 
cc
-
œ°_cc
, 
	`gë_úq_ªgs
()->
pc
);

193 
cou¡
 = 0;

194 
œ°_msg
 = 
cc
;

195 
œ°_úq
 = 
úq
;

197 
œ°_cc
 = 
cc
;

201 
	`h™dÀ_úq
(
úq
);

202 
	}
}

204 
__öô


205 
	$jí£n_öô_úq
()

207 
	`öô_i8259a_úqs
();

209 
úq_desc
[1].
chù
 = &
jí£n_loˇl_úq_ty≥
;

210 
úq_desc
[4].
chù
 = &
jí£n_loˇl_úq_ty≥
;

211 
úq_desc
[3].
chù
 = &
jí£n_loˇl_úq_ty≥
;

212 
úq_desc
[7].
chù
 = &
jí£n_loˇl_úq_ty≥
;

213 
úq_desc
[9].
chù
 = &
jí£n_loˇl_úq_ty≥
;

215 
	`comm⁄_öô_iß_dma
();

216 
	}
}

218 
__öô


219 
	$jí£n_öô_¨ch
()

221 
pci_c⁄åﬁÀr
 *
ho£
;

222 #ifde‡
CONFIG_PCI


223 
pci_dev
 
Áke_iß_bridge
 = { .
dma_mask
 = 0xffffffffUL, };

225 
iß_bridge
 = &
Áke_iß_bridge
;

231 
pci_iß_ho£
 = 
ho£
 = 
	`Æloc_pci_c⁄åﬁÀr
();

232 
ho£
->
io_•a˚
 = &
i›‹t_ªsour˚
;

233 
ho£
->
mem_•a˚
 = &
iomem_ªsour˚
;

234 
ho£
->
ödex
 = 0;

236 
ho£
->
•¨£_mem_ba£
 = 
EISA_MEM
 - 
IDENT_ADDR
;

237 
ho£
->
dí£_mem_ba£
 = 0;

238 
ho£
->
•¨£_io_ba£
 = 
EISA_IO
 - 
IDENT_ADDR
;

239 
ho£
->
dí£_io_ba£
 = 0;

241 
ho£
->
sg_iß
 = ho£->
sg_pci
 = 
NULL
;

242 
__dúe˘_m≠_ba£
 = 0;

243 
__dúe˘_m≠_size
 = 0xffffffff;

244 
	}
}

247 
	$jí£n_machöe_check
 (
u64
 
ve˘‹
, u64 
œ
)

249 
	`¥ötk
(
KERN_CRIT
 "Machine check\n");

250 
	}
}

257 
Æpha_machöe_ve˘‹
 
jí£n_mv
 
	g__öômv
 = {

258 .
ve˘‹_«me
 = "Jensen",

259 
	gDO_EV4_MMU
,

260 
IO_LITE
(
JENSEN
,
jí£n
),

261 .
	gmachöe_check
 = 
jí£n_machöe_check
,

262 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

263 .
	gπc_p‹t
 = 0x170,

265 .
	gƒ_úqs
 = 16,

266 .
	gdevi˚_öãºu±
 = 
jí£n_devi˚_öãºu±
,

268 .
	göô_¨ch
 = 
jí£n_öô_¨ch
,

269 .
	göô_úq
 = 
jí£n_öô_úq
,

270 .
	göô_πc
 = 
comm⁄_öô_πc
,

271 .
	göô_pci
 = 
NULL
,

272 .
	gkûl_¨ch
 = 
NULL
,

274 
ALIAS_MV
(
jí£n
)

	@arch/alpha/kernel/sys_marvel.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/ty≥s.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/sched.h
>

11 
	~<löux/pci.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/bô›s.h
>

15 
	~<asm/±ø˚.h
>

16 
	~<asm/sy°em.h
>

17 
	~<asm/dma.h
>

18 
	~<asm/úq.h
>

19 
	~<asm/mmu_c⁄ãxt.h
>

20 
	~<asm/io.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/c‹e_m¨vñ.h
>

23 
	~<asm/hwΩb.h
>

24 
	~<asm/ébÊush.h
>

25 
	~<asm/vga.h
>

27 
	~"¥Ÿo.h
"

28 
	~"îr_im∂.h
"

29 
	~"úq_im∂.h
"

30 
	~"pci_im∂.h
"

31 
	~"machvec_im∂.h
"

33 #i‡
NR_IRQS
 < 
MARVEL_NR_IRQS


34 #îr‹ 
NR_IRQS
 < 
MARVEL_NR_IRQS
 !!!

42 
	$io7_devi˚_öãºu±
(
ve˘‹
)

44 
pid
;

45 
úq
;

61 
pid
 = 
ve˘‹
 >> 16;

62 
úq
 = ((
ve˘‹
 & 0xffff) - 0x800) >> 4;

64 
úq
 += 16;

65 
úq
 &
MARVEL_IRQ_VEC_IRQ_MASK
;

66 
úq
 |
pid
 << 
MARVEL_IRQ_VEC_PE_SHIFT
;

68 
	`h™dÀ_úq
(
úq
);

69 
	}
}

72 
	$io7_gë_úq_˘l
(
úq
, 
io7
 **
pio7
)

74 vﬁ©ûê*
˘l
;

75 
pid
;

76 
io7
 *io7;

78 
pid
 = 
úq
 >> 
MARVEL_IRQ_VEC_PE_SHIFT
;

80 i‡(!(
io7
 = 
	`m¨vñ_föd_io7
(
pid
))) {

81 
	`¥ötk
(
KERN_ERR


83 
__FUNCTION__
, 
úq
, 
pid
);

84  
NULL
;

87 
úq
 &
MARVEL_IRQ_VEC_IRQ_MASK
;

88 
úq
 -= 16;

90 i‡(
úq
 >= 0x180) {

91 
	`¥ötk
(
KERN_ERR


93 
__FUNCTION__
, 
pid
, 
úq
);

94  
NULL
;

97 
˘l
 = &
io7
->
c§s
->
PO7_LSI_CTL
[
úq
 & 0xff].
c§
;

98 i‡(
úq
 >= 0x80)

99 
˘l
 = &
io7
->
c§s
->
PO7_MSI_CTL
[((
úq
 - 0x80Ë>> 5Ë& 0x0f].
c§
;

101 i‡(
pio7
Ë*pio7 = 
io7
;

102  
˘l
;

103 
	}
}

106 
	$io7_íabÀ_úq
(
úq
)

108 vﬁ©ûê*
˘l
;

109 
io7
 *io7;

111 
˘l
 = 
	`io7_gë_úq_˘l
(
úq
, &
io7
);

112 i‡(!
˘l
 || !
io7
) {

113 
	`¥ötk
(
KERN_ERR
 "%s: get_ctl failed for irq %x\n",

114 
__FUNCTION__
, 
úq
);

118 
	`•ö_lock
(&
io7
->
úq_lock
);

119 *
˘l
 |= 1UL << 24;

120 
	`mb
();

121 *
˘l
;

122 
	`•ö_u∆ock
(&
io7
->
úq_lock
);

123 
	}
}

126 
	$io7_dißbÀ_úq
(
úq
)

128 vﬁ©ûê*
˘l
;

129 
io7
 *io7;

131 
˘l
 = 
	`io7_gë_úq_˘l
(
úq
, &
io7
);

132 i‡(!
˘l
 || !
io7
) {

133 
	`¥ötk
(
KERN_ERR
 "%s: get_ctl failed for irq %x\n",

134 
__FUNCTION__
, 
úq
);

138 
	`•ö_lock
(&
io7
->
úq_lock
);

139 *
˘l
 &= ~(1UL << 24);

140 
	`mb
();

141 *
˘l
;

142 
	`•ö_u∆ock
(&
io7
->
úq_lock
);

143 
	}
}

146 
	$io7_°¨tup_úq
(
úq
)

148 
	`io7_íabÀ_úq
(
úq
);

150 
	}
}

153 
	$io7_íd_úq
(
úq
)

155 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

156 
	`io7_íabÀ_úq
(
úq
);

157 
	}
}

160 
	$m¨vñ_úq_no›
(
úq
)

163 
	}
}

166 
	$m¨vñ_úq_no›_ªtu∫
(
úq
)

169 
	}
}

171 
hw_öãºu±_ty≥
 
	gm¨vñ_Àgacy_úq_ty≥
 = {

172 .
ty≥«me
 = "LEGACY",

173 .
	g°¨tup
 = 
m¨vñ_úq_no›_ªtu∫
,

174 .
	gshutdown
 = 
m¨vñ_úq_no›
,

175 .
	gíabÀ
 = 
m¨vñ_úq_no›
,

176 .
	gdißbÀ
 = 
m¨vñ_úq_no›
,

177 .
	gack
 = 
m¨vñ_úq_no›
,

178 .
	gíd
 = 
m¨vñ_úq_no›
,

181 
hw_öãºu±_ty≥
 
	gio7_lsi_úq_ty≥
 = {

182 .
ty≥«me
 = "LSI",

183 .
	g°¨tup
 = 
io7_°¨tup_úq
,

184 .
	gshutdown
 = 
io7_dißbÀ_úq
,

185 .
	gíabÀ
 = 
io7_íabÀ_úq
,

186 .
	gdißbÀ
 = 
io7_dißbÀ_úq
,

187 .
	gack
 = 
io7_dißbÀ_úq
,

188 .
	gíd
 = 
io7_íd_úq
,

191 
hw_öãºu±_ty≥
 
	gio7_msi_úq_ty≥
 = {

192 .
ty≥«me
 = "MSI",

193 .
	g°¨tup
 = 
io7_°¨tup_úq
,

194 .
	gshutdown
 = 
io7_dißbÀ_úq
,

195 .
	gíabÀ
 = 
io7_íabÀ_úq
,

196 .
	gdißbÀ
 = 
io7_dißbÀ_úq
,

197 .
	gack
 = 
m¨vñ_úq_no›
,

198 .
	gíd
 = 
io7_íd_úq
,

202 
	$io7_ªdúe˘_úq
(
io7
 *io7,

203 vﬁ©ûê*
c§
,

204 
whîe
)

206 
vÆ
;

208 
vÆ
 = *
c§
;

209 
vÆ
 &= ~(0x1ffUL << 24);

210 
vÆ
 |(()
whîe
 << 24);

212 *
c§
 = 
vÆ
;

213 
	`mb
();

214 *
c§
;

215 
	}
}

218 
	$io7_ªdúe˘_⁄e_lsi
(
io7
 *io7, 
which
, 
whîe
)

220 
vÆ
;

225 
vÆ
 = 
io7
->
c§s
->
PO7_LSI_CTL
[
which
].
c§
;

226 
vÆ
 &= ~(0x1ffUL << 14);

227 
vÆ
 |(()
whîe
 << 14);

229 
io7
->
c§s
->
PO7_LSI_CTL
[
which
].
c§
 = 
vÆ
;

230 
	`mb
();

231 
io7
->
c§s
->
PO7_LSI_CTL
[
which
].
c§
;

232 
	}
}

235 
	$io7_ªdúe˘_⁄e_msi
(
io7
 *io7, 
which
, 
whîe
)

237 
vÆ
;

242 
vÆ
 = 
io7
->
c§s
->
PO7_MSI_CTL
[
which
].
c§
;

243 
vÆ
 &= ~(0x1ffUL << 14);

244 
vÆ
 |(()
whîe
 << 14);

246 
io7
->
c§s
->
PO7_MSI_CTL
[
which
].
c§
 = 
vÆ
;

247 
	`mb
();

248 
io7
->
c§s
->
PO7_MSI_CTL
[
which
].
c§
;

249 
	}
}

251 
__öô


252 
	$öô_⁄e_io7_lsi
(
io7
 *io7, 
which
, 
whîe
)

257 
io7
->
c§s
->
PO7_LSI_CTL
[
which
].
c§
 = (()
whîe
 << 14);

258 
	`mb
();

259 
io7
->
c§s
->
PO7_LSI_CTL
[
which
].
c§
;

260 
	}
}

262 
__öô


263 
	$öô_⁄e_io7_msi
(
io7
 *io7, 
which
, 
whîe
)

268 
io7
->
c§s
->
PO7_MSI_CTL
[
which
].
c§
 = (()
whîe
 << 14);

269 
	`mb
();

270 
io7
->
c§s
->
PO7_MSI_CTL
[
which
].
c§
;

271 
	}
}

273 
__öô


274 
	$öô_io7_úqs
(
io7
 *io7,

275 
hw_öãºu±_ty≥
 *
lsi_›s
,

276 
hw_öãºu±_ty≥
 *
msi_›s
)

278 
ba£
 = (
io7
->
≥
 << 
MARVEL_IRQ_VEC_PE_SHIFT
) + 16;

279 
i
;

281 
	`¥ötk
("Initializing interrupts for IO7át PE %u - base %lx\n",

282 
io7
->
≥
, 
ba£
);

293 
	`¥ötk
(" I¡îru±†ªp‹ãdÅÿCPUáàPE %u\n", 
boŸ_˝uid
);

295 
	`•ö_lock
(&
io7
->
úq_lock
);

298 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HLT_CTL
.
c§
, 
boŸ_˝uid
);

299 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HPI_CTL
.
c§
, 
boŸ_˝uid
);

300 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
CRD_CTL
.
c§
, 
boŸ_˝uid
);

301 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
STV_CTL
.
c§
, 
boŸ_˝uid
);

302 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HEI_CTL
.
c§
, 
boŸ_˝uid
);

305 
i
 = 0; i < 128; ++i) {

306 
úq_desc
[
ba£
 + 
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

307 
úq_desc
[
ba£
 + 
i
].
chù
 = 
lsi_›s
;

311 
i
 = 0; i < 0x60; ++i)

312 
	`öô_⁄e_io7_lsi
(
io7
, 
i
, 
boŸ_˝uid
);

314 
	`öô_⁄e_io7_lsi
(
io7
, 0x74, 
boŸ_˝uid
);

315 
	`öô_⁄e_io7_lsi
(
io7
, 0x75, 
boŸ_˝uid
);

319 
i
 = 128; i < (128 + 512); ++i) {

320 
úq_desc
[
ba£
 + 
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

321 
úq_desc
[
ba£
 + 
i
].
chù
 = 
msi_›s
;

324 
i
 = 0; i < 16; ++i)

325 
	`öô_⁄e_io7_msi
(
io7
, 
i
, 
boŸ_˝uid
);

327 
	`•ö_u∆ock
(&
io7
->
úq_lock
);

328 
	}
}

330 
__öô


331 
	$m¨vñ_öô_úq
()

333 
i
;

334 
io7
 *io7 = 
NULL
;

337 
i
 = 0; i < 16; ++i) {

338 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
;

339 
úq_desc
[
i
].
chù
 = &
m¨vñ_Àgacy_úq_ty≥
;

343 
io7
 = 
NULL
; (io7 = 
	`m¨vñ_√xt_io7
(io7)) != NULL; )

344 
	`öô_io7_úqs
(
io7
, &
io7_lsi_úq_ty≥
, &
io7_msi_úq_ty≥
);

345 
	}
}

348 
	$m¨vñ_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

350 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

351 
io7_p‹t
 *io7_p‹à
ho£
->
sysd©a
;

352 
io7
 *io7 = 
io7_p‹t
->io7;

353 
msi_loc
, 
msi_d©a_off
;

354 
u16
 
msg_˘l
;

355 
u16
 
msg_d©
;

356 
u8
 
öéöe
;

357 
úq
;

359 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
öéöe
);

360 
úq
 = 
öéöe
;

362 
msi_loc
 = 
	`pci_föd_ˇ∑bûôy
(
dev
, 
PCI_CAP_ID_MSI
);

363 
msg_˘l
 = 0;

364 i‡(
msi_loc
)

365 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
msi_loc
 + 
PCI_MSI_FLAGS
, &
msg_˘l
);

367 i‡(
msg_˘l
 & 
PCI_MSI_FLAGS_ENABLE
) {

368 
msi_d©a_off
 = 
PCI_MSI_DATA_32
;

369 i‡(
msg_˘l
 & 
PCI_MSI_FLAGS_64BIT
)

370 
msi_d©a_off
 = 
PCI_MSI_DATA_64
;

371 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
msi_loc
 + 
msi_d©a_off
, &
msg_d©
);

373 
úq
 = 
msg_d©
 & 0x1ff;

374 
úq
 += 0x80;

377 
	`¥ötk
("PCI:%d:%d:%d (hose %d) is using MSI\n",

378 
dev
->
bus
->
numbî
,

379 
	`PCI_SLOT
(
dev
->
dev‚
),

380 
	`PCI_FUNC
(
dev
->
dev‚
),

381 
ho£
->
ödex
);

382 
	`¥ötk
(" %d message(s) from 0x%04x\n",

383 1 << ((
msg_˘l
 & 
PCI_MSI_FLAGS_QSIZE
) >> 4),

384 
msg_d©
);

385 
	`¥ötk
("Ñeporting on %d IRQ(s) from %d (0x%x)\n",

386 1 << ((
msg_˘l
 & 
PCI_MSI_FLAGS_QSIZE
) >> 4),

387 (
úq
 + 16Ë| (
io7
->
≥
 << 
MARVEL_IRQ_VEC_PE_SHIFT
),

388 (
úq
 + 16Ë| (
io7
->
≥
 << 
MARVEL_IRQ_VEC_PE_SHIFT
));

392 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
msi_loc
 + 
PCI_MSI_FLAGS
,

393 
msg_˘l
 & ~
PCI_MSI_FLAGS_ENABLE
);

394 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
öéöe
);

395 
úq
 = 
öéöe
;

397 
	`¥ötk
(" f‹cög LSI i¡îru± o¿úq %d [0x%x]\n", 
úq
, irq);

401 
úq
 += 16;

402 
úq
 |
io7
->
≥
 << 
MARVEL_IRQ_VEC_PE_SHIFT
;

404  
úq
;

405 
	}
}

407 
__öô


408 
	$m¨vñ_öô_pci
()

410 
io7
 *io7;

412 
	`m¨vñ_ªgi°î_îr‹_h™dÀrs
();

414 
pci_¥obe_⁄ly
 = 1;

415 
	`comm⁄_öô_pci
();

416 
	`loˇã_™d_öô_vga
(
NULL
);

419 
io7
 = 
NULL
; (io7 = 
	`m¨vñ_√xt_io7
(io7)) != NULL; )

420 
	`io7_˛ór_îr‹s
(
io7
);

421 
	}
}

424 
	$m¨vñ_öô_πc
()

426 
	`öô_πc_úq
();

427 
	}
}

430 
	$m¨vñ_smp_ˇŒö
()

432 
˝uid
 = 
	`h¨d_smp_¥o˚ss‹_id
();

433 
io7
 *io7 = 
	`m¨vñ_föd_io7
(
˝uid
);

434 
i
;

436 i‡(!
io7
)

442 
	`¥ötk
("Redúe˘ög IO7 i¡îru±†tÿloˇ»CPUáàPE %u\n", 
˝uid
);

445 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HLT_CTL
.
c§
, 
˝uid
);

446 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HPI_CTL
.
c§
, 
˝uid
);

447 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
CRD_CTL
.
c§
, 
˝uid
);

448 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
STV_CTL
.
c§
, 
˝uid
);

449 
	`io7_ªdúe˘_úq
(
io7
, &io7->
c§s
->
HEI_CTL
.
c§
, 
˝uid
);

452 
i
 = 0; i < 0x60; ++i)

453 
	`io7_ªdúe˘_⁄e_lsi
(
io7
, 
i
, 
˝uid
);

455 
	`io7_ªdúe˘_⁄e_lsi
(
io7
, 0x74, 
˝uid
);

456 
	`io7_ªdúe˘_⁄e_lsi
(
io7
, 0x75, 
˝uid
);

459 
i
 = 0; i < 16; ++i)

460 
	`io7_ªdúe˘_⁄e_msi
(
io7
, 
i
, 
˝uid
);

461 
	}
}

466 
Æpha_machöe_ve˘‹
 
m¨vñ_ev7_mv
 
	g__öômv
 = {

467 .
ve˘‹_«me
 = "MARVEL/EV7",

468 
	gDO_EV7_MMU
,

469 
	gDO_DEFAULT_RTC
,

470 
	gDO_MARVEL_IO
,

471 .
	gmachöe_check
 = 
m¨vñ_machöe_check
,

472 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

473 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

474 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

475 .
	gpci_dac_off£t
 = 
IO7_DAC_OFFSET
,

477 .
	gƒ_úqs
 = 
MARVEL_NR_IRQS
,

478 .
	gdevi˚_öãºu±
 = 
io7_devi˚_öãºu±
,

480 .
	gagp_öfo
 = 
m¨vñ_agp_öfo
,

482 .
	gsmp_ˇŒö
 = 
m¨vñ_smp_ˇŒö
,

483 .
	göô_¨ch
 = 
m¨vñ_öô_¨ch
,

484 .
	göô_úq
 = 
m¨vñ_öô_úq
,

485 .
	göô_πc
 = 
m¨vñ_öô_πc
,

486 .
	göô_pci
 = 
m¨vñ_öô_pci
,

487 .
	gkûl_¨ch
 = 
m¨vñ_kûl_¨ch
,

488 .
	gpci_m≠_úq
 = 
m¨vñ_m≠_úq
,

489 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

491 .
	g∑_to_nid
 = 
m¨vñ_∑_to_nid
,

492 .
	g˝uid_to_nid
 = 
m¨vñ_˝uid_to_nid
,

493 .
	gnode_mem_°¨t
 = 
m¨vñ_node_mem_°¨t
,

494 .
	gnode_mem_size
 = 
m¨vñ_node_mem_size
,

496 
ALIAS_MV
(
m¨vñ_ev7
)

	@arch/alpha/kernel/sys_miata.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/ªboŸ.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_cü.h
>

27 
	~<asm/ébÊush.h
>

29 
	~"¥Ÿo.h
"

30 
	~"úq_im∂.h
"

31 
	~"pci_im∂.h
"

32 
	~"machvec_im∂.h
"

36 
	$müè_§m_devi˚_öãºu±
(
ve˘‹
)

38 
úq
;

40 
úq
 = (
ve˘‹
 - 0x800) >> 4;

56 i‡(
úq
 >= 16)

57 
úq
 = irq + 8;

59 
	`h™dÀ_úq
(
úq
);

60 
	}
}

62 
__öô


63 
	$müè_öô_úq
()

65 i‡(
Æpha_usög_§m
)

66 
Æpha_mv
.
devi˚_öãºu±
 = 
müè_§m_devi˚_öãºu±
;

70 *(
vuÕ
)
PYXIS_INT_HILO
 = 0x000000B2UL; 
	`mb
();

71 *(
vuÕ
)
PYXIS_RT_COUNT
 = 0UL; 
	`mb
();

74 
	`öô_i8259a_úqs
();

81 
	`öô_pyxis_úqs
(0x63b0000);

83 
	`comm⁄_öô_iß_dma
();

84 
	`£tup_úq
(16+2, &
hÆt_swôch_úqa˘i⁄
);

85 
	`£tup_úq
(16+6, &
timî_ˇsˇde_úqa˘i⁄
);

86 
	}
}

153 
__öô


154 
	$müè_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

156 
úq_èb
[18][5] 
__öôd©a
 = {

179 c⁄° 
mö_id£l
 = 3, 
max_id£l
 = 20, 
úqs_≥r_¶Ÿ
 = 5;

184 if((
¶Ÿ
 =7Ë&& (
	`PCI_FUNC
(
dev
->
dev‚
) == 3)) {

185 
u8
 
úq
=0;

186 
pci_dev
 *
pdev
 = 
	`pci_gë_¶Ÿ
(
dev
->
bus
, dev->
dev‚
 & ~7);

187 if(
pdev
 =
NULL
 || 
	`pci_ªad_c⁄fig_byã
’dev, 0x40,&
úq
Ë!
PCIBIOS_SUCCESSFUL
) {

188 
	`pci_dev_put
(
pdev
);

192 
	`pci_dev_put
(
pdev
);

193  
úq
;

197  
COMMON_TABLE_LOOKUP
;

198 
	}
}

200 
u8
 
__öô


201 
	$müè_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

203 
¶Ÿ
, 
pö
 = *
pöp
;

205 i‡(
dev
->
bus
->
numbî
 == 0) {

206 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

209 i‡((
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) ||

210 (
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 20)) {

211 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 9;

217 i‡((
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) ||

218 (
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 20)) {

219 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 9;

222 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
));

225 
dev
 = dev->
bus
->
£lf
;

227 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

228 } 
dev
->
bus
->
£lf
);

230 *
pöp
 = 
pö
;

231  
¶Ÿ
;

232 
	}
}

234 
__öô


235 
	$müè_öô_pci
()

237 
	`cü_öô_pci
();

238 
	`SMC669_Inô
(0);

239 
	`es1888_öô
();

240 
	}
}

243 
	$müè_kûl_¨ch
(
mode
)

245 
	`cü_kûl_¨ch
(
mode
);

247 #i‚de‡
ALPHA_RESTORE_SRM_SETUP


248 
mode
) {

249 
LINUX_REBOOT_CMD_RESTART
:

251 i‡(
Æpha_usög_§m
) {

252 *(
vuù
Ë
PYXIS_RESET
 = 0x0000dead;

253 
	`mb
();

256 
LINUX_REBOOT_CMD_HALT
:

258 
LINUX_REBOOT_CMD_POWER_OFF
:

262 
	`hÆt
();

264 
	}
}

271 
Æpha_machöe_ve˘‹
 
müè_mv
 
	g__öômv
 = {

272 .
ve˘‹_«me
 = "Miata",

273 
	gDO_EV5_MMU
,

274 
	gDO_DEFAULT_RTC
,

275 
	gDO_PYXIS_IO
,

276 .
	gmachöe_check
 = 
cü_machöe_check
,

277 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

278 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

279 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

280 .
	gpci_dac_off£t
 = 
PYXIS_DAC_OFFSET
,

282 .
	gƒ_úqs
 = 48,

283 .
	gdevi˚_öãºu±
 = 
pyxis_devi˚_öãºu±
,

285 .
	göô_¨ch
 = 
pyxis_öô_¨ch
,

286 .
	göô_úq
 = 
müè_öô_úq
,

287 .
	göô_πc
 = 
comm⁄_öô_πc
,

288 .
	göô_pci
 = 
müè_öô_pci
,

289 .
	gkûl_¨ch
 = 
müè_kûl_¨ch
,

290 .
	gpci_m≠_úq
 = 
müè_m≠_úq
,

291 .
	gpci_swizzÀ
 = 
müè_swizzÀ
,

293 
ALIAS_MV
(
müè
)

	@arch/alpha/kernel/sys_mikasa.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/bô›s.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_≠ecs.h
>

27 
	~<asm/c‹e_cü.h
>

28 
	~<asm/ébÊush.h
>

30 
	~"¥Ÿo.h
"

31 
	~"úq_im∂.h
"

32 
	~"pci_im∂.h
"

33 
	~"machvec_im∂.h
"

37 
	gˇched_úq_mask
;

39 
ölöe
 

40 
	$mikaß_upd©e_úq_hw
(
mask
)

42 
	`outw
(
mask
, 0x536);

43 
	}
}

45 
ölöe
 

46 
	$mikaß_íabÀ_úq
(
úq
)

48 
	`mikaß_upd©e_úq_hw
(
ˇched_úq_mask
 |1 << (
úq
 - 16));

49 
	}
}

52 
	$mikaß_dißbÀ_úq
(
úq
)

54 
	`mikaß_upd©e_úq_hw
(
ˇched_úq_mask
 &~(1 << (
úq
 - 16)));

55 
	}
}

58 
	$mikaß_°¨tup_úq
(
úq
)

60 
	`mikaß_íabÀ_úq
(
úq
);

62 
	}
}

65 
	$mikaß_íd_úq
(
úq
)

67 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

68 
	`mikaß_íabÀ_úq
(
úq
);

69 
	}
}

71 
hw_öãºu±_ty≥
 
	gmikaß_úq_ty≥
 = {

72 .
ty≥«me
 = "MIKASA",

73 .
	g°¨tup
 = 
mikaß_°¨tup_úq
,

74 .
	gshutdown
 = 
mikaß_dißbÀ_úq
,

75 .
	gíabÀ
 = 
mikaß_íabÀ_úq
,

76 .
	gdißbÀ
 = 
mikaß_dißbÀ_úq
,

77 .
	gack
 = 
mikaß_dißbÀ_úq
,

78 .
	gíd
 = 
mikaß_íd_úq
,

82 
	$mikaß_devi˚_öãºu±
(
ve˘‹
)

84 
∂d
;

85 
i
;

88 
∂d
 = (((~
	`öw
(0x534) & 0x0000ffffUL) << 16)

89 | (((Ë
	`öb
(0xa0)) << 8)

90 | 
	`öb
(0x20));

96 
∂d
) {

97 
i
 = 
	`ffz
(~
∂d
);

98 
∂d
 &=Öld - 1;

99 i‡(
i
 < 16) {

100 
	`iß_devi˚_öãºu±
(
ve˘‹
);

102 
	`h™dÀ_úq
(
i
);

105 
	}
}

107 
__öô


108 
	$mikaß_öô_úq
()

110 
i
;

112 i‡(
Æpha_usög_§m
)

113 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
;

115 
	`mikaß_upd©e_úq_hw
(0);

117 
i
 = 16; i < 32; ++i) {

118 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

119 
úq_desc
[
i
].
chù
 = &
mikaß_úq_ty≥
;

122 
	`öô_i8259a_úqs
();

123 
	`comm⁄_öô_iß_dma
();

124 
	}
}

164 
__öô


165 
	$mikaß_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

167 
úq_èb
[8][5] 
__öôd©a
 = {

178 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 13, 
úqs_≥r_¶Ÿ
 = 5;

179  
COMMON_TABLE_LOOKUP
;

180 
	}
}

183 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| !deföed(
CONFIG_ALPHA_PRIMO
)

185 
	$mikaß_≠ecs_machöe_check
(
ve˘‹
, 
œ_±r
)

187 
	#MCHK_NO_DEVSEL
 0x205U

	)

188 
	#MCHK_NO_TABT
 0x204U

	)

190 
ñ_comm⁄
 *
mchk_hódî
;

191 
code
;

193 
mchk_hódî
 = (
ñ_comm⁄
 *)
œ_±r
;

196 
	`mb
();

197 
	`mb
();

198 
	`døöa
();

199 
	`≠ecs_pci_˛r_îr
();

200 
	`wrm˚s
(0x7);

201 
	`mb
();

203 
code
 = 
mchk_hódî
->code;

204 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "MIKASA APECS",

205 (
	`mcheck_ex≥˘ed
(0)

206 && (
code
 =
MCHK_NO_DEVSEL


207 || 
code
 =
MCHK_NO_TABT
)));

208 
	}
}

216 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| !deföed(
CONFIG_ALPHA_PRIMO
)

217 
Æpha_machöe_ve˘‹
 
mikaß_mv
 
	g__öômv
 = {

218 .
ve˘‹_«me
 = "Mikasa",

219 
	gDO_EV4_MMU
,

220 
	gDO_DEFAULT_RTC
,

221 
	gDO_APECS_IO
,

222 .
	gmachöe_check
 = 
mikaß_≠ecs_machöe_check
,

223 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

224 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

225 .
	gmö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

227 .
	gƒ_úqs
 = 32,

228 .
	gdevi˚_öãºu±
 = 
mikaß_devi˚_öãºu±
,

230 .
	göô_¨ch
 = 
≠ecs_öô_¨ch
,

231 .
	göô_úq
 = 
mikaß_öô_úq
,

232 .
	göô_πc
 = 
comm⁄_öô_πc
,

233 .
	göô_pci
 = 
comm⁄_öô_pci
,

234 .
	gpci_m≠_úq
 = 
mikaß_m≠_úq
,

235 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

237 
	$ALIAS_MV
(
mikaß
)

240 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_PRIMO
)

241 
Æpha_machöe_ve˘‹
 
mikaß_¥imo_mv
 
__öômv
 = {

242 .
ve˘‹_«me
 = "Mikasa-Primo",

243 
DO_EV5_MMU
,

244 
DO_DEFAULT_RTC
,

245 
DO_CIA_IO
,

246 .
machöe_check
 = 
cü_machöe_check
,

247 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

248 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

249 .
mö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

251 .
ƒ_úqs
 = 32,

252 .
devi˚_öãºu±
 = 
mikaß_devi˚_öãºu±
,

254 .
öô_¨ch
 = 
cü_öô_¨ch
,

255 .
öô_úq
 = 
mikaß_öô_úq
,

256 .
öô_πc
 = 
comm⁄_öô_πc
,

257 .
öô_pci
 = 
cü_öô_pci
,

258 .
kûl_¨ch
 = 
cü_kûl_¨ch
,

259 .
pci_m≠_úq
 = 
mikaß_m≠_úq
,

260 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

261 
	}
};

262 
	$ALIAS_MV
(
mikaß_¥imo
)

	@arch/alpha/kernel/sys_nautilus.c

27 
	~<löux/kî√l.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/sched.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/öô.h
>

33 
	~<löux/ªboŸ.h
>

34 
	~<löux/boŸmem.h
>

35 
	~<löux/bô›s.h
>

37 
	~<asm/±ø˚.h
>

38 
	~<asm/sy°em.h
>

39 
	~<asm/dma.h
>

40 
	~<asm/úq.h
>

41 
	~<asm/mmu_c⁄ãxt.h
>

42 
	~<asm/io.h
>

43 
	~<asm/pci.h
>

44 
	~<asm/pgèbÀ.h
>

45 
	~<asm/c‹e_ú⁄g©e.h
>

46 
	~<asm/hwΩb.h
>

47 
	~<asm/ébÊush.h
>

49 
	~"¥Ÿo.h
"

50 
	~"îr_im∂.h
"

51 
	~"úq_im∂.h
"

52 
	~"pci_im∂.h
"

53 
	~"machvec_im∂.h
"

56 
__öô


57 
	$«utûus_öô_úq
()

59 i‡(
Æpha_usög_§m
) {

60 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
;

63 
	`öô_i8259a_úqs
();

64 
	`comm⁄_öô_iß_dma
();

65 
	}
}

67 
__öô


68 
	$«utûus_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

72 
u8
 
úq
;

76 i‡(
¶Ÿ
 =1 && 
pö
 == 2 &&

77 
dev
->
bus
->
£lf
 && dev->bus->£lf->
devi˚
 == 0x700f)

79 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
úq
);

80  
úq
;

81 
	}
}

84 
	$«utûus_kûl_¨ch
(
mode
)

86 
pci_bus
 *
bus
 = 
pci_iß_ho£
->bus;

87 
u32
 
pmup‹t
;

88 
off
;

90 
mode
) {

91 
LINUX_REBOOT_CMD_RESTART
:

92 i‡(! 
Æpha_usög_§m
) {

93 
u8
 
t8
;

94 
	`pci_bus_ªad_c⁄fig_byã
(
bus
, 0x38, 0x43, &
t8
);

95 
	`pci_bus_wrôe_c⁄fig_byã
(
bus
, 0x38, 0x43, 
t8
 | 0x80);

96 
	`outb
(1, 0x92);

97 
	`outb
(0, 0x92);

102 
LINUX_REBOOT_CMD_POWER_OFF
:

104 
off
 = 0x2000;

105 
	`pci_bus_ªad_c⁄fig_dw‹d
(
bus
, 0x88, 0x10, &
pmup‹t
);

106 i‡(!
pmup‹t
) {

108 
off
 = 0x3400;

109 
	`pci_bus_ªad_c⁄fig_dw‹d
(
bus
, 0x88, 0xe0, &
pmup‹t
);

111 
pmup‹t
 &= 0xfffe;

112 
	`outw
(0xffff, 
pmup‹t
);

113 
	`outw
(
off
, 
pmup‹t
 + 4);

117 
	}
}

122 
	$«ut_sys_machöe_check
(
ve˘‹
, 
œ_±r
,

123 
±_ªgs
 *
ªgs
)

125 
	`¥ötk
("PC %lx RA %lx\n", 
ªgs
->
pc
,Ñegs->
r26
);

126 
	`ú⁄g©e_pci_˛r_îr
();

127 
	}
}

133 
	$«utûus_machöe_check
(
ve˘‹
, 
œ_±r
)

135 *
mchk_˛ass
;

141 i‡(
ve˘‹
 =
SCB_Q_SYSMCHK


142 && ((
IRONGATE0
->
dømms
 & 0x300) == 0x300)) {

143 
nmi_˘l
;

146 
nmi_˘l
 = 
	`öb
(0x61);

147 
nmi_˘l
 |= 0x0c;

148 
	`outb
(
nmi_˘l
, 0x61);

149 
nmi_˘l
 &= ~0x0c;

150 
	`outb
(
nmi_˘l
, 0x61);

153 
IRONGATE0
->
°©_cmd
 = IRONGATE0->stat_cmd & ~0x100;

154 
	`mb
();

155 
IRONGATE0
->
°©_cmd
;

158 
IRONGATE0
->
dømms
 = IRONGATE0->dramms;

159 
	`mb
();

160 
IRONGATE0
->
dømms
;

162 
	`døöa
();

163 
	`wrm˚s
(0x7);

164 
	`mb
();

168 i‡(
ve˘‹
 =
SCB_Q_SYSERR
)

169 
mchk_˛ass
 = "Correctable";

170 i‡(
ve˘‹
 =
SCB_Q_SYSMCHK
)

171 
mchk_˛ass
 = "Fatal";

173 
	`ev6_machöe_check
(
ve˘‹
, 
œ_±r
);

177 
	`¥ötk
(
KERN_CRIT
 "NAUTILUS Machine check 0x%lx "

179 
ve˘‹
, 
mchk_˛ass
);

181 
	`«ut_sys_machöe_check
(
ve˘‹
, 
œ_±r
, 
	`gë_úq_ªgs
());

184 
	`døöa
();

185 
	`wrm˚s
(0x7);

186 
	`mb
();

187 
	}
}

189 
‰ì_ª£rved_mem
(*, *);

191 
ªsour˚
 
	gú⁄g©e_mem
 = {

192 .
«me
 = "Irongate PCI MEM",

193 .
	gÊags
 = 
IORESOURCE_MEM
,

196 
__öô


197 
	$«utûus_öô_pci
()

199 
pci_c⁄åﬁÀr
 *
ho£
 = 
ho£_hód
;

200 
pci_bus
 *
bus
;

201 
pci_dev
 *
ú⁄g©e
;

202 
bus_Æign
, 
bus_size
, 
pci_mem
;

203 
memt›
 = 
max_low_p‚
 << 
PAGE_SHIFT
;

206 
bus
 = 
	`pci_sˇn_bus
(0, 
Æpha_mv
.
pci_›s
, 
ho£
);

207 
ho£
->
bus
 = bus;

209 
ú⁄g©e
 = 
	`pci_gë_bus_™d_¶Ÿ
(0, 0);

210 
bus
->
£lf
 = 
ú⁄g©e
;

211 
bus
->
ªsour˚
[1] = &
ú⁄g©e_mem
;

213 
	`pci_bus_size_bridges
(
bus
);

216 
bus
->
ªsour˚
[0]->
°¨t
 = 0;

217 
bus
->
ªsour˚
[0]->
íd
 = 0xffff;

221 
bus_Æign
 = 
bus
->
ªsour˚
[1]->
°¨t
;

222 
bus_size
 = 
bus
->
ªsour˚
[1]->
íd
 + 1 - 
bus_Æign
;

223 i‡(
bus_Æign
 < 0x1000000UL)

224 
bus_Æign
 = 0x1000000UL;

226 
pci_mem
 = (0x100000000UL - 
bus_size
Ë& -
bus_Æign
;

228 
bus
->
ªsour˚
[1]->
°¨t
 = 
pci_mem
;

229 
bus
->
ªsour˚
[1]->
íd
 = 0xffffffffUL;

230 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
bus
->
ªsour˚
[1]) < 0)

231 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest MEM on hose 0\n");

233 i‡(
pci_mem
 < 
memt›
)

234 
memt›
 = 
pci_mem
;

235 i‡(
memt›
 > 
Æpha_mv
.
mö_mem_addªss
) {

236 
	`‰ì_ª£rved_mem
(
	`__va
(
Æpha_mv
.
mö_mem_addªss
),

237 
	`__va
(
memt›
));

238 
	`¥ötk
("nautilus_init_pci: %ldk freed\n",

239 (
memt›
 - 
Æpha_mv
.
mö_mem_addªss
) >> 10);

242 i‡((
IRONGATE0
->
dev_víd‹
 >> 16) > 0x7006)

243 
IRONGATE0
->
pci_mem
 =Öci_mem;

245 
	`pci_bus_assign_ªsour˚s
(
bus
);

246 
	`pci_fixup_úqs
(
Æpha_mv
.
pci_swizzÀ
,áÕha_mv.
pci_m≠_úq
);

247 
	}
}

253 
Æpha_machöe_ve˘‹
 
«utûus_mv
 
	g__öômv
 = {

254 .
ve˘‹_«me
 = "Nautilus",

255 
	gDO_EV6_MMU
,

256 
	gDO_DEFAULT_RTC
,

257 
	gDO_IRONGATE_IO
,

258 .
	gmachöe_check
 = 
«utûus_machöe_check
,

259 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

260 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

261 .
	gmö_mem_addªss
 = 
IRONGATE_DEFAULT_MEM_BASE
,

263 .
	gƒ_úqs
 = 16,

264 .
	gdevi˚_öãºu±
 = 
iß_devi˚_öãºu±
,

266 .
	göô_¨ch
 = 
ú⁄g©e_öô_¨ch
,

267 .
	göô_úq
 = 
«utûus_öô_úq
,

268 .
	göô_πc
 = 
comm⁄_öô_πc
,

269 .
	göô_pci
 = 
«utûus_öô_pci
,

270 .
	gkûl_¨ch
 = 
«utûus_kûl_¨ch
,

271 .
	gpci_m≠_úq
 = 
«utûus_m≠_úq
,

272 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

274 
ALIAS_MV
(
«utûus
)

	@arch/alpha/kernel/sys_noritake.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/pci.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/bô›s.h
>

20 
	~<asm/±ø˚.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/dma.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/mmu_c⁄ãxt.h
>

25 
	~<asm/io.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/c‹e_≠ecs.h
>

28 
	~<asm/c‹e_cü.h
>

29 
	~<asm/ébÊush.h
>

31 
	~"¥Ÿo.h
"

32 
	~"úq_im∂.h
"

33 
	~"pci_im∂.h
"

34 
	~"machvec_im∂.h
"

37 
	gˇched_úq_mask
;

39 
ölöe
 

40 
	$n‹ôake_upd©e_úq_hw
(
úq
, 
mask
)

42 
p‹t
 = 0x54a;

43 i‡(
úq
 >= 32) {

44 
mask
 >>= 16;

45 
p‹t
 = 0x54c;

47 
	`outw
(
mask
, 
p‹t
);

48 
	}
}

51 
	$n‹ôake_íabÀ_úq
(
úq
)

53 
	`n‹ôake_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 |= 1 << (irq - 16));

54 
	}
}

57 
	$n‹ôake_dißbÀ_úq
(
úq
)

59 
	`n‹ôake_upd©e_úq_hw
(
úq
, 
ˇched_úq_mask
 &= ~(1 << (irq - 16)));

60 
	}
}

63 
	$n‹ôake_°¨tup_úq
(
úq
)

65 
	`n‹ôake_íabÀ_úq
(
úq
);

67 
	}
}

70 
	$n‹ôake_íd_úq
(
úq
)

72 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

73 
	`n‹ôake_íabÀ_úq
(
úq
);

74 
	}
}

76 
hw_öãºu±_ty≥
 
	gn‹ôake_úq_ty≥
 = {

77 .
ty≥«me
 = "NORITAKE",

78 .
	g°¨tup
 = 
n‹ôake_°¨tup_úq
,

79 .
	gshutdown
 = 
n‹ôake_dißbÀ_úq
,

80 .
	gíabÀ
 = 
n‹ôake_íabÀ_úq
,

81 .
	gdißbÀ
 = 
n‹ôake_dißbÀ_úq
,

82 .
	gack
 = 
n‹ôake_dißbÀ_úq
,

83 .
	gíd
 = 
n‹ôake_íd_úq
,

87 
	$n‹ôake_devi˚_öãºu±
(
ve˘‹
)

89 
∂d
;

90 
i
;

93 
∂d
 = (((Ë
	`öw
(0x54c) << 32)

94 | ((Ë
	`öw
(0x54a) << 16)

95 | ((Ë
	`öb
(0xa0) << 8)

96 | 
	`öb
(0x20));

102 
∂d
) {

103 
i
 = 
	`ffz
(~
∂d
);

104 
∂d
 &=Öld - 1;

105 i‡(
i
 < 16) {

106 
	`iß_devi˚_öãºu±
(
ve˘‹
);

108 
	`h™dÀ_úq
(
i
);

111 
	}
}

114 
	$n‹ôake_§m_devi˚_öãºu±
(
ve˘‹
)

116 
úq
;

118 
úq
 = (
ve˘‹
 - 0x800) >> 4;

129 i‡(
úq
 >= 16)

130 
úq
 = irq + 1;

132 
	`h™dÀ_úq
(
úq
);

133 
	}
}

135 
__öô


136 
	$n‹ôake_öô_úq
()

138 
i
;

140 i‡(
Æpha_usög_§m
)

141 
Æpha_mv
.
devi˚_öãºu±
 = 
n‹ôake_§m_devi˚_öãºu±
;

143 
	`outw
(0, 0x54a);

144 
	`outw
(0, 0x54c);

146 
i
 = 16; i < 48; ++i) {

147 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

148 
úq_desc
[
i
].
chù
 = &
n‹ôake_úq_ty≥
;

151 
	`öô_i8259a_úqs
();

152 
	`comm⁄_öô_iß_dma
();

153 
	}
}

212 
__öô


213 
	$n‹ôake_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

215 
úq_èb
[15][5] 
__öôd©a
 = {

236 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 19, 
úqs_≥r_¶Ÿ
 = 5;

237  
COMMON_TABLE_LOOKUP
;

238 
	}
}

240 
u8
 
__öô


241 
	$n‹ôake_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

243 
¶Ÿ
, 
pö
 = *
pöp
;

245 i‡(
dev
->
bus
->
numbî
 == 0) {

246 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

249 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) {

250 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 15;

256 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 8) {

257 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 15;

260 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
)) ;

263 
dev
 = dev->
bus
->
£lf
;

265 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

266 } 
dev
->
bus
->
£lf
);

268 *
pöp
 = 
pö
;

269  
¶Ÿ
;

270 
	}
}

272 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| !deföed(
CONFIG_ALPHA_PRIMO
)

274 
	$n‹ôake_≠ecs_machöe_check
(
ve˘‹
, 
œ_±r
)

276 
	#MCHK_NO_DEVSEL
 0x205U

	)

277 
	#MCHK_NO_TABT
 0x204U

	)

279 
ñ_comm⁄
 *
mchk_hódî
;

280 
code
;

282 
mchk_hódî
 = (
ñ_comm⁄
 *)
œ_±r
;

285 
	`mb
();

286 
	`mb
();

287 
	`døöa
();

288 
	`≠ecs_pci_˛r_îr
();

289 
	`wrm˚s
(0x7);

290 
	`mb
();

292 
code
 = 
mchk_hódî
->code;

293 
	`¥o˚ss_mcheck_öfo
(
ve˘‹
, 
œ_±r
, "NORITAKE APECS",

294 (
	`mcheck_ex≥˘ed
(0)

295 && (
code
 =
MCHK_NO_DEVSEL


296 || 
code
 =
MCHK_NO_TABT
)));

297 
	}
}

305 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| !deföed(
CONFIG_ALPHA_PRIMO
)

306 
Æpha_machöe_ve˘‹
 
n‹ôake_mv
 
	g__öômv
 = {

307 .
ve˘‹_«me
 = "Noritake",

308 
	gDO_EV4_MMU
,

309 
	gDO_DEFAULT_RTC
,

310 
	gDO_APECS_IO
,

311 .
	gmachöe_check
 = 
n‹ôake_≠ecs_machöe_check
,

312 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

313 .
	gmö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

314 .
	gmö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

316 .
	gƒ_úqs
 = 48,

317 .
	gdevi˚_öãºu±
 = 
n‹ôake_devi˚_öãºu±
,

319 .
	göô_¨ch
 = 
≠ecs_öô_¨ch
,

320 .
	göô_úq
 = 
n‹ôake_öô_úq
,

321 .
	göô_πc
 = 
comm⁄_öô_πc
,

322 .
	göô_pci
 = 
comm⁄_öô_pci
,

323 .
	gpci_m≠_úq
 = 
n‹ôake_m≠_úq
,

324 .
	gpci_swizzÀ
 = 
n‹ôake_swizzÀ
,

326 
	$ALIAS_MV
(
n‹ôake
)

329 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_PRIMO
)

330 
Æpha_machöe_ve˘‹
 
n‹ôake_¥imo_mv
 
__öômv
 = {

331 .
ve˘‹_«me
 = "Noritake-Primo",

332 
DO_EV5_MMU
,

333 
DO_DEFAULT_RTC
,

334 
DO_CIA_IO
,

335 .
machöe_check
 = 
cü_machöe_check
,

336 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

337 .
mö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

338 .
mö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

340 .
ƒ_úqs
 = 48,

341 .
devi˚_öãºu±
 = 
n‹ôake_devi˚_öãºu±
,

343 .
öô_¨ch
 = 
cü_öô_¨ch
,

344 .
öô_úq
 = 
n‹ôake_öô_úq
,

345 .
öô_πc
 = 
comm⁄_öô_πc
,

346 .
öô_pci
 = 
cü_öô_pci
,

347 .
kûl_¨ch
 = 
cü_kûl_¨ch
,

348 .
pci_m≠_úq
 = 
n‹ôake_m≠_úq
,

349 .
pci_swizzÀ
 = 
n‹ôake_swizzÀ
,

350 
	}
};

351 
	$ALIAS_MV
(
n‹ôake_¥imo
)

	@arch/alpha/kernel/sys_rawhide.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/±ø˚.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/dma.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mmu_c⁄ãxt.h
>

23 
	~<asm/io.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/c‹e_m˝cü.h
>

26 
	~<asm/ébÊush.h
>

28 
	~"¥Ÿo.h
"

29 
	~"úq_im∂.h
"

30 
	~"pci_im∂.h
"

31 
	~"machvec_im∂.h
"

41 
	gho£_úq_masks
[4] = {

44 
	gˇched_úq_masks
[4];

45 
DEFINE_SPINLOCK
(
øwhide_úq_lock
);

47 
ölöe
 

48 
	$øwhide_upd©e_úq_hw
(
ho£
, 
mask
)

50 *(
vuù
)
	`MCPCIA_INT_MASK0
(
	`MCPCIA_HOSE2MID
(
ho£
)Ë
mask
;

51 
	`mb
();

52 *(
vuù
)
	`MCPCIA_INT_MASK0
(
	`MCPCIA_HOSE2MID
(
ho£
));

53 
	}
}

55 
	#ho£_exi°s
(
h
) \

56 (((
h
Ë< 
MCPCIA_MAX_HOSES
Ë&& (
ˇched_úq_masks
[(h)] !0))

	)

58 
ölöe
 

59 
	$øwhide_íabÀ_úq
(
úq
)

61 
mask
, 
ho£
;

63 
úq
 -= 16;

64 
ho£
 = 
úq
 / 24;

65 i‡(!
	`ho£_exi°s
(
ho£
))

68 
úq
 -
ho£
 * 24;

69 
mask
 = 1 << 
úq
;

71 
	`•ö_lock
(&
øwhide_úq_lock
);

72 
mask
 |
ˇched_úq_masks
[
ho£
];

73 
ˇched_úq_masks
[
ho£
] = 
mask
;

74 
	`øwhide_upd©e_úq_hw
(
ho£
, 
mask
);

75 
	`•ö_u∆ock
(&
øwhide_úq_lock
);

76 
	}
}

79 
	$øwhide_dißbÀ_úq
(
úq
)

81 
mask
, 
ho£
;

83 
úq
 -= 16;

84 
ho£
 = 
úq
 / 24;

85 i‡(!
	`ho£_exi°s
(
ho£
))

88 
úq
 -
ho£
 * 24;

89 
mask
 = ~(1 << 
úq
Ë| 
ho£_úq_masks
[
ho£
];

91 
	`•ö_lock
(&
øwhide_úq_lock
);

92 
mask
 &
ˇched_úq_masks
[
ho£
];

93 
ˇched_úq_masks
[
ho£
] = 
mask
;

94 
	`øwhide_upd©e_úq_hw
(
ho£
, 
mask
);

95 
	`•ö_u∆ock
(&
øwhide_úq_lock
);

96 
	}
}

99 
	$øwhide_mask_™d_ack_úq
(
úq
)

101 
mask
, 
mask1
, 
ho£
;

103 
úq
 -= 16;

104 
ho£
 = 
úq
 / 24;

105 i‡(!
	`ho£_exi°s
(
ho£
))

108 
úq
 -
ho£
 * 24;

109 
mask1
 = 1 << 
úq
;

110 
mask
 = ~
mask1
 | 
ho£_úq_masks
[
ho£
];

112 
	`•ö_lock
(&
øwhide_úq_lock
);

114 
mask
 &
ˇched_úq_masks
[
ho£
];

115 
ˇched_úq_masks
[
ho£
] = 
mask
;

116 
	`øwhide_upd©e_úq_hw
(
ho£
, 
mask
);

119 *(
vuù
)
	`MCPCIA_INT_REQ
(
	`MCPCIA_HOSE2MID
(
ho£
)Ë
mask1
;

121 
	`•ö_u∆ock
(&
øwhide_úq_lock
);

122 
	}
}

125 
	$øwhide_°¨tup_úq
(
úq
)

127 
	`øwhide_íabÀ_úq
(
úq
);

129 
	}
}

132 
	$øwhide_íd_úq
(
úq
)

134 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

135 
	`øwhide_íabÀ_úq
(
úq
);

136 
	}
}

138 
hw_öãºu±_ty≥
 
	gøwhide_úq_ty≥
 = {

139 .
ty≥«me
 = "RAWHIDE",

140 .
	g°¨tup
 = 
øwhide_°¨tup_úq
,

141 .
	gshutdown
 = 
øwhide_dißbÀ_úq
,

142 .
	gíabÀ
 = 
øwhide_íabÀ_úq
,

143 .
	gdißbÀ
 = 
øwhide_dißbÀ_úq
,

144 .
	gack
 = 
øwhide_mask_™d_ack_úq
,

145 .
	gíd
 = 
øwhide_íd_úq
,

149 
	$øwhide_§m_devi˚_öãºu±
(
ve˘‹
)

151 
úq
;

153 
úq
 = (
ve˘‹
 - 0x800) >> 4;

165 i‡(
úq
 == 52) {

167 
úq
 = 72;

171 
úq
 -= ((irq + 16) >> 2) & 0x38;

173 
	`h™dÀ_úq
(
úq
);

174 
	}
}

176 
__öô


177 
	$øwhide_öô_úq
()

179 
pci_c⁄åﬁÀr
 *
ho£
;

180 
i
;

182 
	`m˝cü_öô_ho£s
();

185 
i
 = 0; i < 
MCPCIA_MAX_HOSES
; i++Ë
ˇched_úq_masks
[i] = 0;

187 
ho£
 = 
ho£_hód
; ho£; ho£ = ho£->
√xt
) {

188 
h
 = 
ho£
->
ödex
;

189 
mask
 = 
ho£_úq_masks
[
h
];

191 
ˇched_úq_masks
[
h
] = 
mask
;

192 *(
vuù
)
	`MCPCIA_INT_MASK0
(
	`MCPCIA_HOSE2MID
(
h
)Ë
mask
;

193 *(
vuù
)
	`MCPCIA_INT_MASK1
(
	`MCPCIA_HOSE2MID
(
h
)) = 0;

196 
i
 = 16; i < 128; ++i) {

197 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

198 
úq_desc
[
i
].
chù
 = &
øwhide_úq_ty≥
;

201 
	`öô_i8259a_úqs
();

202 
	`comm⁄_öô_iß_dma
();

203 
	}
}

238 
__öô


239 
	$øwhide_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

241 
úq_èb
[5][5] 
__öôd©a
 = {

249 c⁄° 
mö_id£l
 = 1, 
max_id£l
 = 5, 
úqs_≥r_¶Ÿ
 = 5;

251 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

252 
úq
 = 
COMMON_TABLE_LOOKUP
;

253 i‡(
úq
 >= 0)

254 
úq
 +24 * 
ho£
->
ödex
;

255  
úq
;

256 
	}
}

263 
Æpha_machöe_ve˘‹
 
øwhide_mv
 
	g__öômv
 = {

264 .
ve˘‹_«me
 = "Rawhide",

265 
	gDO_EV5_MMU
,

266 
	gDO_DEFAULT_RTC
,

267 
	gDO_MCPCIA_IO
,

268 .
	gmachöe_check
 = 
m˝cü_machöe_check
,

269 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

270 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

271 .
	gmö_mem_addªss
 = 
MCPCIA_DEFAULT_MEM_BASE
,

272 .
	gpci_dac_off£t
 = 
MCPCIA_DAC_OFFSET
,

274 .
	gƒ_úqs
 = 128,

275 .
	gdevi˚_öãºu±
 = 
øwhide_§m_devi˚_öãºu±
,

277 .
	göô_¨ch
 = 
m˝cü_öô_¨ch
,

278 .
	göô_úq
 = 
øwhide_öô_úq
,

279 .
	göô_πc
 = 
comm⁄_öô_πc
,

280 .
	göô_pci
 = 
comm⁄_öô_pci
,

281 .
	gkûl_¨ch
 = 
NULL
,

282 .
	gpci_m≠_úq
 = 
øwhide_m≠_úq
,

283 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

285 
ALIAS_MV
(
øwhide
)

	@arch/alpha/kernel/sys_ruffian.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/i›‹t.h
>

17 
	~<löux/öô.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_cü.h
>

27 
	~<asm/ébÊush.h
>

28 
	~<asm/8253pô.h
>

30 
	~"¥Ÿo.h
"

31 
	~"úq_im∂.h
"

32 
	~"pci_im∂.h
"

33 
	~"machvec_im∂.h
"

36 
__öô


37 
	$ruffün_öô_úq
()

40 *(
vuÕ
)
PYXIS_INT_HILO
 = 0x000000c0UL; 
	`mb
();

41 *(
vuÕ
)
PYXIS_INT_CNFG
 = 0x00002064UL; 
	`mb
();

43 
	`outb
(0x11,0xA0);

44 
	`outb
(0x08,0xA1);

45 
	`outb
(0x02,0xA1);

46 
	`outb
(0x01,0xA1);

47 
	`outb
(0xFF,0xA1);

49 
	`outb
(0x11,0x20);

50 
	`outb
(0x00,0x21);

51 
	`outb
(0x04,0x21);

52 
	`outb
(0x01,0x21);

53 
	`outb
(0xFF,0x21);

56 
	`outb
(0x20,0xA0);

57 
	`outb
(0x20,0x20);

59 
	`öô_i8259a_úqs
();

63 
	`öô_pyxis_úqs
(0x16f0000);

65 
	`comm⁄_öô_iß_dma
();

66 
	}
}

68 
	#RUFFIAN_LATCH
 ((
PIT_TICK_RATE
 + 
HZ
 / 2Ë/ HZ)

	)

70 
__öô


71 
	$ruffün_öô_πc
()

77 
	`outb
(0x34, 0x43);

78 
	`outb
(
RUFFIAN_LATCH
 & 0xff, 0x40);

79 
	`outb
(
RUFFIAN_LATCH
 >> 8, 0x40);

81 
	`outb
(0xb6, 0x43);

82 
	`outb
(0x31, 0x42);

83 
	`outb
(0x13, 0x42);

85 
	`£tup_úq
(0, &
timî_úqa˘i⁄
);

86 
	}
}

89 
	$ruffün_kûl_¨ch
 (
mode
)

91 
	`cü_kûl_¨ch
(
mode
);

95 *(
vuù
Ë
PYXIS_RESET
 = 0x0000dead;

96 
	`mb
();

98 
	}
}

121 
__öô


122 
	$ruffün_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

124 
úq_èb
[11][5] 
__öôd©a
 = {

139 c⁄° 
mö_id£l
 = 13, 
max_id£l
 = 23, 
úqs_≥r_¶Ÿ
 = 5;

140  
COMMON_TABLE_LOOKUP
;

141 
	}
}

143 
u8
 
__öô


144 
	$ruffün_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

146 
¶Ÿ
, 
pö
 = *
pöp
;

148 i‡(
dev
->
bus
->
numbî
 == 0) {

149 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

152 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 13) {

153 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 10;

159 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 13) {

160 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 10;

163 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
));

166 
dev
 = dev->
bus
->
£lf
;

168 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

169 } 
dev
->
bus
->
£lf
);

171 *
pöp
 = 
pö
;

172  
¶Ÿ
;

173 
	}
}

175 #ifde‡
BUILDING_FOR_MILO


181 
__öô


182 
	$ruffün_gë_b™k_size
(
off£t
)

184 
b™k_addr
, 
b™k
, 
ªt
 = 0;

188 
b™k_addr
 = ()
PYXIS_MCR
 + 
off£t
;

189 
b™k
 = *(
vuÕ
)
b™k_addr
;

192 i‡(
b™k
 & 0x01) {

193 
size
[] 
__öôd©a
 = {

205 
b™k
 = (bank & 0x1e) >> 1;

206 i‡(
b™k
 < 
	`ARRAY_SIZE
(
size
))

207 
ªt
 = 
size
[
b™k
];

210  
ªt
;

211 
	}
}

218 
Æpha_machöe_ve˘‹
 
ruffün_mv
 
	g__öômv
 = {

219 .
ve˘‹_«me
 = "Ruffian",

220 
	gDO_EV5_MMU
,

221 
	gDO_DEFAULT_RTC
,

222 
	gDO_PYXIS_IO
,

223 .
	gmachöe_check
 = 
cü_machöe_check
,

224 .
	gmax_iß_dma_addªss
 = 
ALPHA_RUFFIAN_MAX_ISA_DMA_ADDRESS
,

225 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

226 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

227 .
	gpci_dac_off£t
 = 
PYXIS_DAC_OFFSET
,

229 .
	gƒ_úqs
 = 48,

230 .
	gdevi˚_öãºu±
 = 
pyxis_devi˚_öãºu±
,

232 .
	göô_¨ch
 = 
pyxis_öô_¨ch
,

233 .
	göô_úq
 = 
ruffün_öô_úq
,

234 .
	göô_πc
 = 
ruffün_öô_πc
,

235 .
	göô_pci
 = 
cü_öô_pci
,

236 .
	gkûl_¨ch
 = 
ruffün_kûl_¨ch
,

237 .
	gpci_m≠_úq
 = 
ruffün_m≠_úq
,

238 .
	gpci_swizzÀ
 = 
ruffün_swizzÀ
,

240 
ALIAS_MV
(
ruffün
)

	@arch/alpha/kernel/sys_rx164.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/bô›s.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_pﬁ¨is.h
>

27 
	~<asm/ébÊush.h
>

29 
	~"¥Ÿo.h
"

30 
	~"úq_im∂.h
"

31 
	~"pci_im∂.h
"

32 
	~"machvec_im∂.h
"

36 
	gˇched_úq_mask
;

38 
ölöe
 

39 
	$rx164_upd©e_úq_hw
(
mask
)

41 vﬁ©ûê*
úq_mask
;

43 
úq_mask
 = (*)(
POLARIS_DENSE_CONFIG_BASE
 + 0x74);

44 *
úq_mask
 = 
mask
;

45 
	`mb
();

46 *
úq_mask
;

47 
	}
}

49 
ölöe
 

50 
	$rx164_íabÀ_úq
(
úq
)

52 
	`rx164_upd©e_úq_hw
(
ˇched_úq_mask
 |1UL << (
úq
 - 16));

53 
	}
}

56 
	$rx164_dißbÀ_úq
(
úq
)

58 
	`rx164_upd©e_úq_hw
(
ˇched_úq_mask
 &~(1UL << (
úq
 - 16)));

59 
	}
}

62 
	$rx164_°¨tup_úq
(
úq
)

64 
	`rx164_íabÀ_úq
(
úq
);

66 
	}
}

69 
	$rx164_íd_úq
(
úq
)

71 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

72 
	`rx164_íabÀ_úq
(
úq
);

73 
	}
}

75 
hw_öãºu±_ty≥
 
	grx164_úq_ty≥
 = {

76 .
ty≥«me
 = "RX164",

77 .
	g°¨tup
 = 
rx164_°¨tup_úq
,

78 .
	gshutdown
 = 
rx164_dißbÀ_úq
,

79 .
	gíabÀ
 = 
rx164_íabÀ_úq
,

80 .
	gdißbÀ
 = 
rx164_dißbÀ_úq
,

81 .
	gack
 = 
rx164_dißbÀ_úq
,

82 .
	gíd
 = 
rx164_íd_úq
,

86 
	$rx164_devi˚_öãºu±
(
ve˘‹
)

88 
∂d
;

89 vﬁ©ûê*
dúr
;

90 
i
;

94 
dúr
 = (*)(
POLARIS_DENSE_CONFIG_BASE
 + 0x84);

95 
∂d
 = *
dúr
;

101 
∂d
) {

102 
i
 = 
	`ffz
(~
∂d
);

103 
∂d
 &=Öld - 1;

104 i‡(
i
 == 20) {

105 
	`iß_no_ück_sc_devi˚_öãºu±
(
ve˘‹
);

107 
	`h™dÀ_úq
(16+
i
);

110 
	}
}

112 
__öô


113 
	$rx164_öô_úq
()

115 
i
;

117 
	`rx164_upd©e_úq_hw
(0);

118 
i
 = 16; i < 40; ++i) {

119 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

120 
úq_desc
[
i
].
chù
 = &
rx164_úq_ty≥
;

123 
	`öô_i8259a_úqs
();

124 
	`comm⁄_öô_iß_dma
();

126 
	`£tup_úq
(16+20, &
iß_ˇsˇde_úqa˘i⁄
);

127 
	}
}

163 
__öô


164 
	$rx164_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

167 
úq_èb_∑ss1
[6][5] 
__öôd©a
 = {

177 
úq_èb
[6][5] 
__öôd©a
 = {

187 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 10, 
úqs_≥r_¶Ÿ
 = 5;

191  
COMMON_TABLE_LOOKUP
;

192 
	}
}

199 
Æpha_machöe_ve˘‹
 
rx164_mv
 
	g__öômv
 = {

200 .
ve˘‹_«me
 = "RX164",

201 
	gDO_EV5_MMU
,

202 
	gDO_DEFAULT_RTC
,

203 
	gDO_POLARIS_IO
,

204 .
	gmachöe_check
 = 
pﬁ¨is_machöe_check
,

205 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

206 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

207 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

209 .
	gƒ_úqs
 = 40,

210 .
	gdevi˚_öãºu±
 = 
rx164_devi˚_öãºu±
,

212 .
	göô_¨ch
 = 
pﬁ¨is_öô_¨ch
,

213 .
	göô_úq
 = 
rx164_öô_úq
,

214 .
	göô_πc
 = 
comm⁄_öô_πc
,

215 .
	göô_pci
 = 
comm⁄_öô_pci
,

216 .
	gkûl_¨ch
 = 
NULL
,

217 .
	gpci_m≠_úq
 = 
rx164_m≠_úq
,

218 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

220 
ALIAS_MV
(
rx164
)

	@arch/alpha/kernel/sys_sable.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/±ø˚.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/dma.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mmu_c⁄ãxt.h
>

23 
	~<asm/io.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/c‹e_t2.h
>

26 
	~<asm/ébÊush.h
>

28 
	~"¥Ÿo.h
"

29 
	~"úq_im∂.h
"

30 
	~"pci_im∂.h
"

31 
	~"machvec_im∂.h
"

33 
DEFINE_SPINLOCK
(
ßbÀ_lynx_úq_lock
);

35 
	súq_swizzÀ_°ru˘


37 
	múq_to_mask
[64];

38 
	mmask_to_úq
[64];

41 
	mshadow_mask
;

43 (*
	mupd©e_úq_hw
)(
	mbô
, 
	mmask
);

44 (*
	mack_úq_hw
)(
	mbô
);

46 } 
	túq_swizzÀ_t
;

48 
úq_swizzÀ_t
 *
	gßbÀ_lynx_úq_swizzÀ
;

50 
ßbÀ_lynx_öô_úq
(
ƒ_úqs
);

52 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_SABLE
)

94 
	$ßbÀ_upd©e_úq_hw
(
bô
, 
mask
)

96 
p‹t
 = 0x537;

98 i‡(
bô
 >= 16) {

99 
p‹t
 = 0x53d;

100 
mask
 >>= 16;

101 } i‡(
bô
 >= 8) {

102 
p‹t
 = 0x53b;

103 
mask
 >>= 8;

106 
	`outb
(
mask
, 
p‹t
);

107 
	}
}

110 
	$ßbÀ_ack_úq_hw
(
bô
)

112 
p‹t
, 
vÆ1
, 
vÆ2
;

114 i‡(
bô
 >= 16) {

115 
p‹t
 = 0x53c;

116 
vÆ1
 = 0xE0 | (
bô
 - 16);

117 
vÆ2
 = 0xE0 | 4;

118 } i‡(
bô
 >= 8) {

119 
p‹t
 = 0x53a;

120 
vÆ1
 = 0xE0 | (
bô
 - 8);

121 
vÆ2
 = 0xE0 | 3;

123 
p‹t
 = 0x536;

124 
vÆ1
 = 0xE0 | (
bô
 - 0);

125 
vÆ2
 = 0xE0 | 1;

128 
	`outb
(
vÆ1
, 
p‹t
);

129 
	`outb
(
vÆ2
, 0x534);

130 
	}
}

132 
úq_swizzÀ_t
 
	gßbÀ_úq_swizzÀ
 = {

154 
ßbÀ_upd©e_úq_hw
,

155 
ßbÀ_ack_úq_hw


158 
__öô


159 
	$ßbÀ_öô_úq
()

161 
	`outb
(-1, 0x537);

162 
	`outb
(-1, 0x53b);

163 
	`outb
(-1, 0x53d);

164 
	`outb
(0x44, 0x535);

166 
ßbÀ_lynx_úq_swizzÀ
 = &
ßbÀ_úq_swizzÀ
;

167 
	`ßbÀ_lynx_öô_úq
(40);

168 
	}
}

196 
__öô


197 
	$ßbÀ_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

199 
úq_èb
[9][5] 
__öôd©a
 = {

211 
mö_id£l
 = 0, 
max_id£l
 = 8, 
úqs_≥r_¶Ÿ
 = 5;

212  
COMMON_TABLE_LOOKUP
;

213 
	}
}

216 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_LYNX
)

293 
	$lynx_upd©e_úq_hw
(
bô
, 
mask
)

299 *(
vuÕ
)
T2_AIR
 = 0x40;

300 
	`mb
();

301 *(
vuÕ
)
T2_AIR
;

302 
	`mb
();

303 *(
vuÕ
)
T2_DIR
 = 
mask
;

304 
	`mb
();

305 
	`mb
();

306 
	}
}

309 
	$lynx_ack_úq_hw
(
bô
)

311 *(
vuÕ
)
T2_VAR
 = (
u_l⁄g
Ë
bô
;

312 
	`mb
();

313 
	`mb
();

314 
	}
}

316 
úq_swizzÀ_t
 
	glynx_úq_swizzÀ
 = {

338 
lynx_upd©e_úq_hw
,

339 
lynx_ack_úq_hw


342 
__öô


343 
	$lynx_öô_úq
()

345 
ßbÀ_lynx_úq_swizzÀ
 = &
lynx_úq_swizzÀ
;

346 
	`ßbÀ_lynx_öô_úq
(64);

347 
	}
}

378 
__öô


379 
	$lynx_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

381 
úq_èb
[19][5] 
__öôd©a
 = {

404 c⁄° 
mö_id£l
 = 2, 
max_id£l
 = 20, 
úqs_≥r_¶Ÿ
 = 5;

405  
COMMON_TABLE_LOOKUP
;

406 
	}
}

408 
u8
 
__öô


409 
	$lynx_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

411 
¶Ÿ
, 
pö
 = *
pöp
;

413 i‡(
dev
->
bus
->
numbî
 == 0) {

414 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

417 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 3) {

418 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 11;

424 i‡(
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
) == 3) {

425 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
) + 11;

428 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
)) ;

431 
dev
 = dev->
bus
->
£lf
;

433 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

434 } 
dev
->
bus
->
£lf
);

436 *
pöp
 = 
pö
;

437  
¶Ÿ
;

438 
	}
}

445 
ölöe
 

446 
	$ßbÀ_lynx_íabÀ_úq
(
úq
)

448 
bô
, 
mask
;

450 
bô
 = 
ßbÀ_lynx_úq_swizzÀ
->
úq_to_mask
[
úq
];

451 
	`•ö_lock
(&
ßbÀ_lynx_úq_lock
);

452 
mask
 = 
ßbÀ_lynx_úq_swizzÀ
->
shadow_mask
 &~(1UL << 
bô
);

453 
ßbÀ_lynx_úq_swizzÀ
->
	`upd©e_úq_hw
(
bô
, 
mask
);

454 
	`•ö_u∆ock
(&
ßbÀ_lynx_úq_lock
);

456 
	`¥ötk
("%s: mask 0x%lx bit 0x%x irq 0x%x\n",

457 
__FUNCTION__
, 
mask
, 
bô
, 
úq
);

459 
	}
}

462 
	$ßbÀ_lynx_dißbÀ_úq
(
úq
)

464 
bô
, 
mask
;

466 
bô
 = 
ßbÀ_lynx_úq_swizzÀ
->
úq_to_mask
[
úq
];

467 
	`•ö_lock
(&
ßbÀ_lynx_úq_lock
);

468 
mask
 = 
ßbÀ_lynx_úq_swizzÀ
->
shadow_mask
 |1UL << 
bô
;

469 
ßbÀ_lynx_úq_swizzÀ
->
	`upd©e_úq_hw
(
bô
, 
mask
);

470 
	`•ö_u∆ock
(&
ßbÀ_lynx_úq_lock
);

472 
	`¥ötk
("%s: mask 0x%lx bit 0x%x irq 0x%x\n",

473 
__FUNCTION__
, 
mask
, 
bô
, 
úq
);

475 
	}
}

478 
	$ßbÀ_lynx_°¨tup_úq
(
úq
)

480 
	`ßbÀ_lynx_íabÀ_úq
(
úq
);

482 
	}
}

485 
	$ßbÀ_lynx_íd_úq
(
úq
)

487 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

488 
	`ßbÀ_lynx_íabÀ_úq
(
úq
);

489 
	}
}

492 
	$ßbÀ_lynx_mask_™d_ack_úq
(
úq
)

494 
bô
, 
mask
;

496 
bô
 = 
ßbÀ_lynx_úq_swizzÀ
->
úq_to_mask
[
úq
];

497 
	`•ö_lock
(&
ßbÀ_lynx_úq_lock
);

498 
mask
 = 
ßbÀ_lynx_úq_swizzÀ
->
shadow_mask
 |1UL << 
bô
;

499 
ßbÀ_lynx_úq_swizzÀ
->
	`upd©e_úq_hw
(
bô
, 
mask
);

500 
ßbÀ_lynx_úq_swizzÀ
->
	`ack_úq_hw
(
bô
);

501 
	`•ö_u∆ock
(&
ßbÀ_lynx_úq_lock
);

502 
	}
}

504 
hw_öãºu±_ty≥
 
	gßbÀ_lynx_úq_ty≥
 = {

505 .
ty≥«me
 = "SABLE/LYNX",

506 .
	g°¨tup
 = 
ßbÀ_lynx_°¨tup_úq
,

507 .
	gshutdown
 = 
ßbÀ_lynx_dißbÀ_úq
,

508 .
	gíabÀ
 = 
ßbÀ_lynx_íabÀ_úq
,

509 .
	gdißbÀ
 = 
ßbÀ_lynx_dißbÀ_úq
,

510 .
	gack
 = 
ßbÀ_lynx_mask_™d_ack_úq
,

511 .
	gíd
 = 
ßbÀ_lynx_íd_úq
,

515 
	$ßbÀ_lynx_§m_devi˚_öãºu±
(
ve˘‹
)

521 
bô
, 
úq
;

523 
bô
 = (
ve˘‹
 - 0x800) >> 4;

524 
úq
 = 
ßbÀ_lynx_úq_swizzÀ
->
mask_to_úq
[
bô
];

526 
	`¥ötk
("%s: vector 0x%lx bit 0x%x irq 0x%x\n",

527 
__FUNCTION__
, 
ve˘‹
, 
bô
, 
úq
);

529 
	`h™dÀ_úq
(
úq
);

530 
	}
}

532 
__öô


533 
	$ßbÀ_lynx_öô_úq
(
ƒ_úqs
)

535 
i
;

537 
i
 = 0; i < 
ƒ_úqs
; ++i) {

538 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

539 
úq_desc
[
i
].
chù
 = &
ßbÀ_lynx_úq_ty≥
;

542 
	`comm⁄_öô_iß_dma
();

543 
	}
}

545 
__öô


546 
	$ßbÀ_lynx_öô_pci
()

548 
	`comm⁄_öô_pci
();

549 
	}
}

559 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
) || \

560 (
deföed
(
CONFIG_ALPHA_SABLE
Ë&& !
	$deföed
(
CONFIG_ALPHA_GAMMA
))

561 #unde‡
GAMMA_BIAS


562 
	#GAMMA_BIAS
 0

	)

563 
Æpha_machöe_ve˘‹
 
ßbÀ_mv
 
__öômv
 = {

564 .
ve˘‹_«me
 = "Sable",

565 
DO_EV4_MMU
,

566 
DO_DEFAULT_RTC
,

567 
DO_T2_IO
,

568 .
machöe_check
 = 
t2_machöe_check
,

569 .
max_iß_dma_addªss
 = 
ALPHA_SABLE_MAX_ISA_DMA_ADDRESS
,

570 .
mö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

571 .
mö_mem_addªss
 = 
T2_DEFAULT_MEM_BASE
,

573 .
ƒ_úqs
 = 40,

574 .
devi˚_öãºu±
 = 
ßbÀ_lynx_§m_devi˚_öãºu±
,

576 .
öô_¨ch
 = 
t2_öô_¨ch
,

577 .
öô_úq
 = 
ßbÀ_öô_úq
,

578 .
öô_πc
 = 
comm⁄_öô_πc
,

579 .
öô_pci
 = 
ßbÀ_lynx_öô_pci
,

580 .
kûl_¨ch
 = 
t2_kûl_¨ch
,

581 .
pci_m≠_úq
 = 
ßbÀ_m≠_úq
,

582 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

584 .
sys
 = { .
t2
 = {

585 .
gamma_büs
 = 0

587 
	}
};

588 
	$ALIAS_MV
(
ßbÀ
)

591 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
) || \

592 (
	`deföed
(
CONFIG_ALPHA_SABLE
Ë&& 
	$deföed
(
CONFIG_ALPHA_GAMMA
))

593 #unde‡
GAMMA_BIAS


594 
	#GAMMA_BIAS
 
_GAMMA_BIAS


	)

595 
Æpha_machöe_ve˘‹
 
ßbÀ_gamma_mv
 
__öômv
 = {

596 .
ve˘‹_«me
 = "Sable-Gamma",

597 
DO_EV5_MMU
,

598 
DO_DEFAULT_RTC
,

599 
DO_T2_IO
,

600 .
machöe_check
 = 
t2_machöe_check
,

601 .
max_iß_dma_addªss
 = 
ALPHA_SABLE_MAX_ISA_DMA_ADDRESS
,

602 .
mö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

603 .
mö_mem_addªss
 = 
T2_DEFAULT_MEM_BASE
,

605 .
ƒ_úqs
 = 40,

606 .
devi˚_öãºu±
 = 
ßbÀ_lynx_§m_devi˚_öãºu±
,

608 .
öô_¨ch
 = 
t2_öô_¨ch
,

609 .
öô_úq
 = 
ßbÀ_öô_úq
,

610 .
öô_πc
 = 
comm⁄_öô_πc
,

611 .
öô_pci
 = 
ßbÀ_lynx_öô_pci
,

612 .
kûl_¨ch
 = 
t2_kûl_¨ch
,

613 .
pci_m≠_úq
 = 
ßbÀ_m≠_úq
,

614 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

616 .
sys
 = { .
t2
 = {

617 .
gamma_büs
 = 
_GAMMA_BIAS


619 
	}
};

620 
	$ALIAS_MV
(
ßbÀ_gamma
)

623 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_LYNX
)

624 #unde‡
GAMMA_BIAS


625 
	#GAMMA_BIAS
 
_GAMMA_BIAS


	)

626 
Æpha_machöe_ve˘‹
 
lynx_mv
 
__öômv
 = {

627 .
ve˘‹_«me
 = "Lynx",

628 
DO_EV4_MMU
,

629 
DO_DEFAULT_RTC
,

630 
DO_T2_IO
,

631 .
machöe_check
 = 
t2_machöe_check
,

632 .
max_iß_dma_addªss
 = 
ALPHA_SABLE_MAX_ISA_DMA_ADDRESS
,

633 .
mö_io_addªss
 = 
EISA_DEFAULT_IO_BASE
,

634 .
mö_mem_addªss
 = 
T2_DEFAULT_MEM_BASE
,

636 .
ƒ_úqs
 = 64,

637 .
devi˚_öãºu±
 = 
ßbÀ_lynx_§m_devi˚_öãºu±
,

639 .
öô_¨ch
 = 
t2_öô_¨ch
,

640 .
öô_úq
 = 
lynx_öô_úq
,

641 .
öô_πc
 = 
comm⁄_öô_πc
,

642 .
öô_pci
 = 
ßbÀ_lynx_öô_pci
,

643 .
kûl_¨ch
 = 
t2_kûl_¨ch
,

644 .
pci_m≠_úq
 = 
lynx_m≠_úq
,

645 .
pci_swizzÀ
 = 
lynx_swizzÀ
,

647 .
sys
 = { .
t2
 = {

648 .
gamma_büs
 = 
_GAMMA_BIAS


650 
	}
};

651 
	$ALIAS_MV
(
lynx
)

	@arch/alpha/kernel/sys_sio.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/pci.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/s¸ìn_öfo.h
>

21 
	~<asm/compûî.h
>

22 
	~<asm/±ø˚.h
>

23 
	~<asm/sy°em.h
>

24 
	~<asm/dma.h
>

25 
	~<asm/úq.h
>

26 
	~<asm/mmu_c⁄ãxt.h
>

27 
	~<asm/io.h
>

28 
	~<asm/pgèbÀ.h
>

29 
	~<asm/c‹e_≠ecs.h
>

30 
	~<asm/c‹e_lˇ.h
>

31 
	~<asm/ébÊush.h
>

33 
	~"¥Ÿo.h
"

34 
	~"úq_im∂.h
"

35 
	~"pci_im∂.h
"

36 
	~"machvec_im∂.h
"

38 #i‡
deföed
(
ALPHA_RESTORE_SRM_SETUP
)

42 
	m‹ig_rouã_èb
;

43 } 
ßved_c⁄fig
 
__©åibuã
((
comm⁄
));

47 
__öô


48 
	$sio_öô_úq
()

50 i‡(
Æpha_usög_§m
)

51 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
;

53 
	`öô_i8259a_úqs
();

54 
	`comm⁄_öô_iß_dma
();

55 
	}
}

57 
ölöe
 
__öô


58 
	$Æphabook1_öô_¨ch
()

62 
s¸ìn_öfo
.
‹ig_y
 = 37;

63 
s¸ìn_öfo
.
‹ig_video_cﬁs
 = 100;

64 
s¸ìn_öfo
.
‹ig_video_löes
 = 37;

66 
	`lˇ_öô_¨ch
();

67 
	}
}

84 
__öô


85 
	$sio_pci_rouã
()

87 
‹ig_rouã_èb
;

90 
	`pci_bus_ªad_c⁄fig_dw‹d
(
pci_iß_ho£
->
bus
, 
	`PCI_DEVFN
(7, 0), 0x60,

91 &
‹ig_rouã_èb
);

92 
	`¥ötk
("%s: PIRQ origöÆ 0x%xÇew 0x%x\n", 
__FUNCTION__
,

93 
‹ig_rouã_èb
, 
Æpha_mv
.
sys
.
sio
.
rouã_èb
);

95 #i‡
	`deföed
(
ALPHA_RESTORE_SRM_SETUP
)

96 
ßved_c⁄fig
.
‹ig_rouã_èb
 = orig_route_tab;

100 
	`pci_bus_wrôe_c⁄fig_dw‹d
(
pci_iß_ho£
->
bus
, 
	`PCI_DEVFN
(7, 0), 0x60,

101 
Æpha_mv
.
sys
.
sio
.
rouã_èb
);

102 
	}
}

104 
__öô


105 
	$sio_cﬁÀ˘_úq_Àvñs
()

107 
Àvñ_bôs
 = 0;

108 
pci_dev
 *
dev
 = 
NULL
;

111 
	`f‹_óch_pci_dev
(
dev
) {

112 i‡((
dev
->
˛ass
 >> 16 =
PCI_BASE_CLASS_BRIDGE
) &&

113 (
dev
->
˛ass
 >> 8 !
PCI_CLASS_BRIDGE_PCMCIA
))

116 i‡(
dev
->
úq
)

117 
Àvñ_bôs
 |(1 << 
dev
->
úq
);

119  
Àvñ_bôs
;

120 
	}
}

122 
__öô


123 
	$sio_fixup_úq_Àvñs
(
Àvñ_bôs
)

125 
ﬁd_Àvñ_bôs
;

139 
ﬁd_Àvñ_bôs
 = 
	`öb
(0x4d0) | (inb(0x4d1) << 8);

141 
Àvñ_bôs
 |(
ﬁd_Àvñ_bôs
 & 0x71ff);

143 
	`outb
((
Àvñ_bôs
 >> 0) & 0xff, 0x4d0);

144 
	`outb
((
Àvñ_bôs
 >> 8) & 0xff, 0x4d1);

145 
	}
}

147 
ölöe
 
__öô


148 
	$n⁄ame_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

168 
úq_èb
[][5] 
__öôd©a
 = {

180 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 14, 
úqs_≥r_¶Ÿ
 = 5;

181 
úq
 = 
COMMON_TABLE_LOOKUP
, 
tmp
;

182 
tmp
 = 
	`__kî√l_extbl
(
Æpha_mv
.
sys
.
sio
.
rouã_èb
, 
úq
);

183  
úq
 >0 ? 
tmp
 : -1;

184 
	}
}

186 
ölöe
 
__öô


187 
	$p2k_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

189 
úq_èb
[][5] 
__öôd©a
 = {

199 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 12, 
úqs_≥r_¶Ÿ
 = 5;

200 
úq
 = 
COMMON_TABLE_LOOKUP
, 
tmp
;

201 
tmp
 = 
	`__kî√l_extbl
(
Æpha_mv
.
sys
.
sio
.
rouã_èb
, 
úq
);

202  
úq
 >0 ? 
tmp
 : -1;

203 
	}
}

205 
ölöe
 
__öô


206 
	$n⁄ame_öô_pci
()

208 
	`comm⁄_öô_pci
();

209 
	`sio_pci_rouã
();

210 
	`sio_fixup_úq_Àvñs
(
	`sio_cﬁÀ˘_úq_Àvñs
());

211 
	`ns87312_íabÀ_ide
(0x26e);

212 
	}
}

214 
ölöe
 
__öô


215 
	$Æphabook1_öô_pci
()

217 
pci_dev
 *
dev
;

218 
‹ig
, 
c⁄fig
;

220 
	`comm⁄_öô_pci
();

221 
	`sio_pci_rouã
();

234 
dev
 = 
NULL
;

235 (
dev
 = 
	`pci_gë_devi˚
(
PCI_VENDOR_ID_NCR
, 
PCI_ANY_ID
, dev))) {

236 i‡(
dev
->
devi˚
 =
PCI_DEVICE_ID_NCR_53C810


237 || 
dev
->
devi˚
 =
PCI_DEVICE_ID_NCR_53C815


238 || 
dev
->
devi˚
 =
PCI_DEVICE_ID_NCR_53C820


239 || 
dev
->
devi˚
 =
PCI_DEVICE_ID_NCR_53C825
) {

240 
io_p‹t
;

241 
˘e°4
;

243 
io_p‹t
 = 
dev
->
ªsour˚
[0].
°¨t
;

244 
˘e°4
 = 
	`öb
(
io_p‹t
+0x21);

245 i‡(!(
˘e°4
 & 0x80)) {

246 
	`¥ötk
("AlphaBook1 NCR init: setting"

248 
	`outb
(
˘e°4
 | 0x80, 
io_p‹t
+0x21);

254 
	`sio_fixup_úq_Àvñs
(0);

257 
	`outb
(0x0f, 0x3˚); 
‹ig
 = 
	`öb
(0x3cf);

258 
	`outb
(0x0f, 0x3ce); outb(0x05, 0x3cf);

259 
	`outb
(0x0b, 0x3˚); 
c⁄fig
 = 
	`öb
(0x3cf);

260 i‡((
c⁄fig
 & 0xc0) != 0xc0) {

261 
	`¥ötk
("AlphaBook1 VGA init: setting 1Mb memory\n");

262 
c⁄fig
 |= 0xc0;

263 
	`outb
(0x0b, 0x3˚); outb(
c⁄fig
, 0x3cf);

265 
	`outb
(0x0f, 0x3˚); outb(
‹ig
, 0x3cf);

266 
	}
}

269 
	$sio_kûl_¨ch
(
mode
)

271 #i‡
	`deföed
(
ALPHA_RESTORE_SRM_SETUP
)

278 
	`pci_bus_wrôe_c⁄fig_dw‹d
(
pci_iß_ho£
->
bus
, 
	`PCI_DEVFN
(7, 0), 0x60,

279 
ßved_c⁄fig
.
‹ig_rouã_èb
);

281 
	}
}

288 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_BOOK1
)

289 
Æpha_machöe_ve˘‹
 
Æphabook1_mv
 
	g__öômv
 = {

290 .
ve˘‹_«me
 = "AlphaBook1",

291 
	gDO_EV4_MMU
,

292 
	gDO_DEFAULT_RTC
,

293 
	gDO_LCA_IO
,

294 .
	gmachöe_check
 = 
lˇ_machöe_check
,

295 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

296 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

297 .
	gmö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

299 .
	gƒ_úqs
 = 16,

300 .
	gdevi˚_öãºu±
 = 
iß_devi˚_öãºu±
,

302 .
	göô_¨ch
 = 
Æphabook1_öô_¨ch
,

303 .
	göô_úq
 = 
sio_öô_úq
,

304 .
	göô_πc
 = 
comm⁄_öô_πc
,

305 .
	göô_pci
 = 
Æphabook1_öô_pci
,

306 .
	gkûl_¨ch
 = 
sio_kûl_¨ch
,

307 .
	gpci_m≠_úq
 = 
n⁄ame_m≠_úq
,

308 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

310 .
	gsys
 = { .
sio
 = {

312 .
rouã_èb
 = 0x0e0f0a0a,

315 
	$ALIAS_MV
(
Æphabook1
)

318 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_AVANTI
)

319 
Æpha_machöe_ve˘‹
 
av™ti_mv
 
__öômv
 = {

320 .
ve˘‹_«me
 = "Avanti",

321 
DO_EV4_MMU
,

322 
DO_DEFAULT_RTC
,

323 
DO_APECS_IO
,

324 .
machöe_check
 = 
≠ecs_machöe_check
,

325 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

326 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

327 .
mö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

329 .
ƒ_úqs
 = 16,

330 .
devi˚_öãºu±
 = 
iß_devi˚_öãºu±
,

332 .
öô_¨ch
 = 
≠ecs_öô_¨ch
,

333 .
öô_úq
 = 
sio_öô_úq
,

334 .
öô_πc
 = 
comm⁄_öô_πc
,

335 .
öô_pci
 = 
n⁄ame_öô_pci
,

336 .
kûl_¨ch
 = 
sio_kûl_¨ch
,

337 .
pci_m≠_úq
 = 
n⁄ame_m≠_úq
,

338 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

340 .
sys
 = { .
sio
 = {

341 .
rouã_èb
 = 0x0b0a050f,

343 
	}
};

344 
	$ALIAS_MV
(
av™ti
)

347 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_NONAME
)

348 
Æpha_machöe_ve˘‹
 
n⁄ame_mv
 
__öômv
 = {

349 .
ve˘‹_«me
 = "Noname",

350 
DO_EV4_MMU
,

351 
DO_DEFAULT_RTC
,

352 
DO_LCA_IO
,

353 .
machöe_check
 = 
lˇ_machöe_check
,

354 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

355 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

356 .
mö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

358 .
ƒ_úqs
 = 16,

359 .
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
,

361 .
öô_¨ch
 = 
lˇ_öô_¨ch
,

362 .
öô_úq
 = 
sio_öô_úq
,

363 .
öô_πc
 = 
comm⁄_öô_πc
,

364 .
öô_pci
 = 
n⁄ame_öô_pci
,

365 .
kûl_¨ch
 = 
sio_kûl_¨ch
,

366 .
pci_m≠_úq
 = 
n⁄ame_m≠_úq
,

367 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

369 .
sys
 = { .
sio
 = {

379 .
rouã_èb
 = 0x0b0a0f0d,

381 
	}
};

382 
	$ALIAS_MV
(
n⁄ame
)

385 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_P2K
)

386 
Æpha_machöe_ve˘‹
 
p2k_mv
 
__öômv
 = {

387 .
ve˘‹_«me
 = "Platform2000",

388 
DO_EV4_MMU
,

389 
DO_DEFAULT_RTC
,

390 
DO_LCA_IO
,

391 .
machöe_check
 = 
lˇ_machöe_check
,

392 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

393 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

394 .
mö_mem_addªss
 = 
APECS_AND_LCA_DEFAULT_MEM_BASE
,

396 .
ƒ_úqs
 = 16,

397 .
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
,

399 .
öô_¨ch
 = 
lˇ_öô_¨ch
,

400 .
öô_úq
 = 
sio_öô_úq
,

401 .
öô_πc
 = 
comm⁄_öô_πc
,

402 .
öô_pci
 = 
n⁄ame_öô_pci
,

403 .
kûl_¨ch
 = 
sio_kûl_¨ch
,

404 .
pci_m≠_úq
 = 
p2k_m≠_úq
,

405 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

407 .
sys
 = { .
sio
 = {

408 .
rouã_èb
 = 0x0b0a090f,

410 
	}
};

411 
	$ALIAS_MV
(
p2k
)

414 #i‡
	`deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_XL
)

415 
Æpha_machöe_ve˘‹
 
xl_mv
 
__öômv
 = {

416 .
ve˘‹_«me
 = "XL",

417 
DO_EV4_MMU
,

418 
DO_DEFAULT_RTC
,

419 
DO_APECS_IO
,

420 .
machöe_check
 = 
≠ecs_machöe_check
,

421 .
max_iß_dma_addªss
 = 
ALPHA_XL_MAX_ISA_DMA_ADDRESS
,

422 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

423 .
mö_mem_addªss
 = 
XL_DEFAULT_MEM_BASE
,

425 .
ƒ_úqs
 = 16,

426 .
devi˚_öãºu±
 = 
iß_devi˚_öãºu±
,

428 .
öô_¨ch
 = 
≠ecs_öô_¨ch
,

429 .
öô_úq
 = 
sio_öô_úq
,

430 .
öô_πc
 = 
comm⁄_öô_πc
,

431 .
öô_pci
 = 
n⁄ame_öô_pci
,

432 .
kûl_¨ch
 = 
sio_kûl_¨ch
,

433 .
pci_m≠_úq
 = 
n⁄ame_m≠_úq
,

434 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

436 .
sys
 = { .
sio
 = {

437 .
rouã_èb
 = 0x0b0a090f,

439 
	}
};

440 
	$ALIAS_MV
(
xl
)

	@arch/alpha/kernel/sys_sx164.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/bô›s.h
>

19 
	~<asm/±ø˚.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mmu_c⁄ãxt.h
>

24 
	~<asm/io.h
>

25 
	~<asm/pgèbÀ.h
>

26 
	~<asm/c‹e_cü.h
>

27 
	~<asm/hwΩb.h
>

28 
	~<asm/ébÊush.h
>

30 
	~"¥Ÿo.h
"

31 
	~"úq_im∂.h
"

32 
	~"pci_im∂.h
"

33 
	~"machvec_im∂.h
"

36 
__öô


37 
	$sx164_öô_úq
()

39 
	`outb
(0, 
DMA1_RESET_REG
);

40 
	`outb
(0, 
DMA2_RESET_REG
);

41 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
);

42 
	`outb
(0, 
DMA2_MASK_REG
);

44 i‡(
Æpha_usög_§m
)

45 
Æpha_mv
.
devi˚_öãºu±
 = 
§m_devi˚_öãºu±
;

47 
	`öô_i8259a_úqs
();

51 i‡(
Æpha_usög_§m
)

52 
	`öô_§m_úqs
(40, 0x3f0000);

54 
	`öô_pyxis_úqs
(0xff00003f0000UL);

56 
	`£tup_úq
(16+6, &
timî_ˇsˇde_úqa˘i⁄
);

57 
	}
}

97 
__öô


98 
	$sx164_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

100 
úq_èb
[5][5] 
__öôd©a
 = {

108 c⁄° 
mö_id£l
 = 5, 
max_id£l
 = 9, 
úqs_≥r_¶Ÿ
 = 5;

109  
COMMON_TABLE_LOOKUP
;

110 
	}
}

112 
__öô


113 
	$sx164_öô_pci
()

115 
	`cü_öô_pci
();

116 
	`SMC669_Inô
(0);

117 
	}
}

119 
__öô


120 
	$sx164_öô_¨ch
()

130 
≥r˝u_°ru˘
 *
˝u
 = (percpu_struct*)

131 ((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

133 i‡(
	`amask
(
AMASK_MAX
) != 0

134 && 
Æpha_usög_§m


135 && (
˝u
->
∑l_ªvisi⁄
 & 0xffff) <= 0x117) {

136 
__asm__
 
	`__vﬁ©ûe__
(

146 
	`¥ötk
("PCA56 MVI setÉnabled\n");

149 
	`pyxis_öô_¨ch
();

150 
	}
}

156 
Æpha_machöe_ve˘‹
 
sx164_mv
 
	g__öômv
 = {

157 .
ve˘‹_«me
 = "SX164",

158 
	gDO_EV5_MMU
,

159 
	gDO_DEFAULT_RTC
,

160 
	gDO_PYXIS_IO
,

161 .
	gmachöe_check
 = 
cü_machöe_check
,

162 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

163 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

164 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

165 .
	gpci_dac_off£t
 = 
PYXIS_DAC_OFFSET
,

167 .
	gƒ_úqs
 = 48,

168 .
	gdevi˚_öãºu±
 = 
pyxis_devi˚_öãºu±
,

170 .
	göô_¨ch
 = 
sx164_öô_¨ch
,

171 .
	göô_úq
 = 
sx164_öô_úq
,

172 .
	göô_πc
 = 
comm⁄_öô_πc
,

173 .
	göô_pci
 = 
sx164_öô_pci
,

174 .
	gkûl_¨ch
 = 
cü_kûl_¨ch
,

175 .
	gpci_m≠_úq
 = 
sx164_m≠_úq
,

176 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

178 
ALIAS_MV
(
sx164
)

	@arch/alpha/kernel/sys_takara.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/pci.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/±ø˚.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/dma.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mmu_c⁄ãxt.h
>

23 
	~<asm/io.h
>

24 
	~<asm/pgèbÀ.h
>

25 
	~<asm/c‹e_cü.h
>

26 
	~<asm/ébÊush.h
>

28 
	~"¥Ÿo.h
"

29 
	~"úq_im∂.h
"

30 
	~"pci_im∂.h
"

31 
	~"machvec_im∂.h
"

35 
	gˇched_úq_mask
[2] = { -1, -1 };

37 
ölöe
 

38 
	$èk¨a_upd©e_úq_hw
(
úq
, 
mask
)

40 
ªgaddr
;

42 
mask
 = (
úq
 >= 64 ? mask << 16 : mask >> ((irq - 16) & 0x30));

43 
ªgaddr
 = 0x510 + (((
úq
 - 16) >> 2) & 0x0c);

44 
	`oué
(
mask
 & 0xffff0000UL, 
ªgaddr
);

45 
	}
}

47 
ölöe
 

48 
	$èk¨a_íabÀ_úq
(
úq
)

50 
mask
;

51 
mask
 = (
ˇched_úq_mask
[
úq
 >= 64] &= ~(1UL << (irq & 63)));

52 
	`èk¨a_upd©e_úq_hw
(
úq
, 
mask
);

53 
	}
}

56 
	$èk¨a_dißbÀ_úq
(
úq
)

58 
mask
;

59 
mask
 = (
ˇched_úq_mask
[
úq
 >= 64] |= 1UL << (irq & 63));

60 
	`èk¨a_upd©e_úq_hw
(
úq
, 
mask
);

61 
	}
}

64 
	$èk¨a_°¨tup_úq
(
úq
)

66 
	`èk¨a_íabÀ_úq
(
úq
);

68 
	}
}

71 
	$èk¨a_íd_úq
(
úq
)

73 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

74 
	`èk¨a_íabÀ_úq
(
úq
);

75 
	}
}

77 
hw_öãºu±_ty≥
 
	gèk¨a_úq_ty≥
 = {

78 .
ty≥«me
 = "TAKARA",

79 .
	g°¨tup
 = 
èk¨a_°¨tup_úq
,

80 .
	gshutdown
 = 
èk¨a_dißbÀ_úq
,

81 .
	gíabÀ
 = 
èk¨a_íabÀ_úq
,

82 .
	gdißbÀ
 = 
èk¨a_dißbÀ_úq
,

83 .
	gack
 = 
èk¨a_dißbÀ_úq
,

84 .
	gíd
 = 
èk¨a_íd_úq
,

88 
	$èk¨a_devi˚_öãºu±
(
ve˘‹
)

90 
öt°©us
;

108 
öt°©us
 = 
	`öw
(0x500) & 15;

109 i‡(
öt°©us
) {

115 i‡(
öt°©us
 & 8Ë
	`h™dÀ_úq
(16+3);

116 i‡(
öt°©us
 & 4Ë
	`h™dÀ_úq
(16+2);

117 i‡(
öt°©us
 & 2Ë
	`h™dÀ_úq
(16+1);

118 i‡(
öt°©us
 & 1Ë
	`h™dÀ_úq
(16+0);

120 
	`iß_devi˚_öãºu±
 (
ve˘‹
);

122 
	}
}

125 
	$èk¨a_§m_devi˚_öãºu±
(
ve˘‹
)

127 
úq
 = (
ve˘‹
 - 0x800) >> 4;

128 
	`h™dÀ_úq
(
úq
);

129 
	}
}

131 
__öô


132 
	$èk¨a_öô_úq
()

134 
i
;

136 
	`öô_i8259a_úqs
();

138 i‡(
Æpha_usög_§m
) {

139 
Æpha_mv
.
devi˚_öãºu±
 = 
èk¨a_§m_devi˚_öãºu±
;

141 
˘Ãeg
 = 
	`öl
(0x500);

144 
˘Ãeg
 &= ~0x8000;

145 
	`oué
(
˘Ãeg
, 0x500);

148 
˘Ãeg
 = 0x05107c00;

149 
	`oué
(
˘Ãeg
, 0x500);

152 
i
 = 16; i < 128; i += 16)

153 
	`èk¨a_upd©e_úq_hw
(
i
, -1);

155 
i
 = 16; i < 128; ++i) {

156 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

157 
úq_desc
[
i
].
chù
 = &
èk¨a_úq_ty≥
;

160 
	`comm⁄_öô_iß_dma
();

161 
	}
}

173 
__öô


174 
	$èk¨a_m≠_úq_§m
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

176 
úq_èb
[15][5] 
__öôd©a
 = {

194 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 20, 
úqs_≥r_¶Ÿ
 = 5;

195 
úq
 = 
COMMON_TABLE_LOOKUP
;

196 i‡(
úq
 >= 0 && irq < 16) {

198 
bus¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
);

199 
úq
 +
úq_èb
[
bus¶Ÿ
-
mö_id£l
][0];

201  
úq
;

202 
	}
}

204 
__öô


205 
	$èk¨a_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

207 
úq_èb
[15][5] 
__öôd©a
 = {

224 c⁄° 
mö_id£l
 = 6, 
max_id£l
 = 20, 
úqs_≥r_¶Ÿ
 = 5;

225  
COMMON_TABLE_LOOKUP
;

226 
	}
}

228 
u8
 
__öô


229 
	$èk¨a_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

231 
¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
dev‚
);

232 
pö
 = *
pöp
;

233 
˘Ãeg
 = 
	`öl
(0x500);

234 
bus¶Ÿ
;

236 i‡(!
dev
->
bus
->
£lf
)

237  
¶Ÿ
;

239 
bus¶Ÿ
 = 
	`PCI_SLOT
(
dev
->
bus
->
£lf
->
dev‚
);

241 i‡(
dev
->
bus
->
numbî
 != 0

242 && 
bus¶Ÿ
 > 16

243 && ((1<<(36-
bus¶Ÿ
)Ë& 
˘Ãeg
)) {

244 i‡(
pö
 == 1)

245 
pö
 +(20 - 
bus¶Ÿ
);

247 
	`¥ötk
(
KERN_WARNING
 "takara_swizzle: can only "

252 
	`¥ötk
(
KERN_WARNING
 "takara_swizzle: cannot handle "

256 *
pöp
 = 
pö
;

257  
¶Ÿ
;

258 
	}
}

260 
__öô


261 
	$èk¨a_öô_pci
()

263 i‡(
Æpha_usög_§m
)

264 
Æpha_mv
.
pci_m≠_úq
 = 
èk¨a_m≠_úq_§m
;

266 
	`cü_öô_pci
();

267 
	`ns87312_íabÀ_ide
(0x26e);

268 
	}
}

275 
Æpha_machöe_ve˘‹
 
èk¨a_mv
 
	g__öômv
 = {

276 .
ve˘‹_«me
 = "Takara",

277 
	gDO_EV5_MMU
,

278 
	gDO_DEFAULT_RTC
,

279 
	gDO_CIA_IO
,

280 .
	gmachöe_check
 = 
cü_machöe_check
,

281 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

282 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

283 .
	gmö_mem_addªss
 = 
CIA_DEFAULT_MEM_BASE
,

285 .
	gƒ_úqs
 = 128,

286 .
	gdevi˚_öãºu±
 = 
èk¨a_devi˚_öãºu±
,

288 .
	göô_¨ch
 = 
cü_öô_¨ch
,

289 .
	göô_úq
 = 
èk¨a_öô_úq
,

290 .
	göô_πc
 = 
comm⁄_öô_πc
,

291 .
	göô_pci
 = 
èk¨a_öô_pci
,

292 .
	gkûl_¨ch
 = 
cü_kûl_¨ch
,

293 .
	gpci_m≠_úq
 = 
èk¨a_m≠_úq
,

294 .
	gpci_swizzÀ
 = 
èk¨a_swizzÀ
,

296 
ALIAS_MV
(
èk¨a
)

	@arch/alpha/kernel/sys_titan.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/ty≥s.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/sched.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/bô›s.h
>

23 
	~<asm/±ø˚.h
>

24 
	~<asm/sy°em.h
>

25 
	~<asm/dma.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/mmu_c⁄ãxt.h
>

28 
	~<asm/io.h
>

29 
	~<asm/pgèbÀ.h
>

30 
	~<asm/c‹e_tô™.h
>

31 
	~<asm/hwΩb.h
>

32 
	~<asm/ébÊush.h
>

34 
	~"¥Ÿo.h
"

35 
	~"úq_im∂.h
"

36 
	~"pci_im∂.h
"

37 
	~"machvec_im∂.h
"

38 
	~"îr_im∂.h
"

48 
	gtô™_˝u_úq_afföôy
[4] = { ~0UL, ~0UL, ~0UL, ~0UL };

53 
	gtô™_ˇched_úq_mask
;

58 
DEFINE_SPINLOCK
(
tô™_úq_lock
);

61 
	$tô™_upd©e_úq_hw
(
mask
)

63 
tô™_cchù
 *
cchù
 = 
TITAN_cchù
;

64 
iß_íabÀ
 = 1UL << 55;

65 
b˝u
 = 
boŸ_˝uid
;

67 #ifde‡
CONFIG_SMP


68 
˝umask_t
 
˝m
 = 
˝u_¥e£¡_m≠
;

69 vﬁ©ûê*
dim0
, *
dim1
, *
dim2
, *
dim3
;

70 
mask0
, 
mask1
, 
mask2
, 
mask3
, 
dummy
;

72 
mask
 &~
iß_íabÀ
;

73 
mask0
 = 
mask
 & 
tô™_˝u_úq_afföôy
[0];

74 
mask1
 = 
mask
 & 
tô™_˝u_úq_afföôy
[1];

75 
mask2
 = 
mask
 & 
tô™_˝u_úq_afföôy
[2];

76 
mask3
 = 
mask
 & 
tô™_˝u_úq_afföôy
[3];

78 i‡(
b˝u
 =0Ë
mask0
 |
iß_íabÀ
;

79 i‡(
b˝u
 =1Ë
mask1
 |
iß_íabÀ
;

80 i‡(
b˝u
 =2Ë
mask2
 |
iß_íabÀ
;

81 
mask3
 |
iß_íabÀ
;

83 
dim0
 = &
cchù
->dim0.
c§
;

84 
dim1
 = &
cchù
->dim1.
c§
;

85 
dim2
 = &
cchù
->dim2.
c§
;

86 
dim3
 = &
cchù
->dim3.
c§
;

87 i‡(!
	`˝u_is£t
(0, 
˝m
)Ë
dim0
 = &
dummy
;

88 i‡(!
	`˝u_is£t
(1, 
˝m
)Ë
dim1
 = &
dummy
;

89 i‡(!
	`˝u_is£t
(2, 
˝m
)Ë
dim2
 = &
dummy
;

90 i‡(!
	`˝u_is£t
(3, 
˝m
)Ë
dim3
 = &
dummy
;

92 *
dim0
 = 
mask0
;

93 *
dim1
 = 
mask1
;

94 *
dim2
 = 
mask2
;

95 *
dim3
 = 
mask3
;

96 
	`mb
();

97 *
dim0
;

98 *
dim1
;

99 *
dim2
;

100 *
dim3
;

102 vﬁ©ûê*
dimB
;

103 
dimB
 = &
cchù
->
dim0
.
c§
;

104 i‡(
b˝u
 =1Ë
dimB
 = &
cchù
->
dim1
.
c§
;

105 i‡(
b˝u
 =2Ë
dimB
 = &
cchù
->
dim2
.
c§
;

106 i‡(
b˝u
 =3Ë
dimB
 = &
cchù
->
dim3
.
c§
;

108 *
dimB
 = 
mask
 | 
iß_íabÀ
;

109 
	`mb
();

110 *
dimB
;

112 
	}
}

114 
ölöe
 

115 
	$tô™_íabÀ_úq
(
úq
)

117 
	`•ö_lock
(&
tô™_úq_lock
);

118 
tô™_ˇched_úq_mask
 |1UL << (
úq
 - 16);

119 
	`tô™_upd©e_úq_hw
(
tô™_ˇched_úq_mask
);

120 
	`•ö_u∆ock
(&
tô™_úq_lock
);

121 
	}
}

123 
ölöe
 

124 
	$tô™_dißbÀ_úq
(
úq
)

126 
	`•ö_lock
(&
tô™_úq_lock
);

127 
tô™_ˇched_úq_mask
 &~(1UL << (
úq
 - 16));

128 
	`tô™_upd©e_úq_hw
(
tô™_ˇched_úq_mask
);

129 
	`•ö_u∆ock
(&
tô™_úq_lock
);

130 
	}
}

133 
	$tô™_°¨tup_úq
(
úq
)

135 
	`tô™_íabÀ_úq
(
úq
);

137 
	}
}

140 
	$tô™_íd_úq
(
úq
)

142 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

143 
	`tô™_íabÀ_úq
(
úq
);

144 
	}
}

147 
	$tô™_˝u_£t_úq_afföôy
(
úq
, 
˝umask_t
 
afföôy
)

149 
˝u
;

151 
˝u
 = 0; cpu < 4; cpu++) {

152 i‡(
	`˝u_is£t
(
˝u
, 
afföôy
))

153 
tô™_˝u_úq_afföôy
[
˝u
] |1UL << 
úq
;

155 
tô™_˝u_úq_afföôy
[
˝u
] &~(1UL << 
úq
);

158 
	}
}

161 
	$tô™_£t_úq_afföôy
(
úq
, 
˝umask_t
 
afföôy
)

163 
	`•ö_lock
(&
tô™_úq_lock
);

164 
	`tô™_˝u_£t_úq_afföôy
(
úq
 - 16, 
afföôy
);

165 
	`tô™_upd©e_úq_hw
(
tô™_ˇched_úq_mask
);

166 
	`•ö_u∆ock
(&
tô™_úq_lock
);

167 
	}
}

170 
	$tô™_devi˚_öãºu±
(
ve˘‹
)

172 
	`¥ötk
("titan_device_interrupt: NOT IMPLEMENTED YET!! \n");

173 
	}
}

176 
	$tô™_§m_devi˚_öãºu±
(
ve˘‹
)

178 
úq
;

180 
úq
 = (
ve˘‹
 - 0x800) >> 4;

181 
	`h™dÀ_úq
(
úq
);

182 
	}
}

185 
__öô


186 
	$öô_tô™_úqs
(
hw_öãºu±_ty≥
 * 
›s
, 
imö
, 
imax
)

188 
i
;

189 
i
 = 
imö
; i <
imax
; ++i) {

190 
úq_desc
[
i
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

191 
úq_desc
[
i
].
chù
 = 
›s
;

193 
	}
}

195 
hw_öãºu±_ty≥
 
	gtô™_úq_ty≥
 = {

196 .
ty≥«me
 = "TITAN",

197 .
	g°¨tup
 = 
tô™_°¨tup_úq
,

198 .
	gshutdown
 = 
tô™_dißbÀ_úq
,

199 .
	gíabÀ
 = 
tô™_íabÀ_úq
,

200 .
	gdißbÀ
 = 
tô™_dißbÀ_úq
,

201 .
	gack
 = 
tô™_dißbÀ_úq
,

202 .
	gíd
 = 
tô™_íd_úq
,

203 .
	g£t_afföôy
 = 
tô™_£t_úq_afföôy
,

206 
úqªtu∫_t


207 
	$tô™_öå_n›
(
úq
, *
dev_id
)

213  
IRQ_HANDLED
;

214 
	}
}

216 
__öô


217 
	$tô™_öô_úq
()

219 i‡(
Æpha_usög_§m
 && !
Æpha_mv
.
devi˚_öãºu±
)

220 
Æpha_mv
.
devi˚_öãºu±
 = 
tô™_§m_devi˚_öãºu±
;

221 i‡(!
Æpha_mv
.
devi˚_öãºu±
)

222 
Æpha_mv
.
devi˚_öãºu±
 = 
tô™_devi˚_öãºu±
;

224 
	`tô™_upd©e_úq_hw
(0);

226 
	`öô_tô™_úqs
(&
tô™_úq_ty≥
, 16, 63 + 16);

227 
	}
}

229 
__öô


230 
	$tô™_Àgacy_öô_úq
()

233 
	`outb
(0, 
DMA1_RESET_REG
);

234 
	`outb
(0, 
DMA2_RESET_REG
);

235 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
);

236 
	`outb
(0, 
DMA2_MASK_REG
);

239 
	`öô_i8259a_úqs
();

242 
	`tô™_öô_úq
();

243 
	}
}

246 
	$tô™_di•©ch_úqs
(
u64
 
mask
)

248 
ve˘‹
;

253 
mask
 &
tô™_˝u_úq_afföôy
[
	`smp_¥o˚ss‹_id
()];

258 
mask
) {

260 
ve˘‹
 = 63 - 
	`__kî√l_˘lz
(
mask
);

261 
mask
 &~(1UL << 
ve˘‹
);

262 
ve˘‹
 = 0x900 + (vector << 4);

265 
Æpha_mv
.
	`devi˚_öãºu±
(
ve˘‹
);

267 
	}
}

273 
__öô


274 
	$tô™_œã_öô
()

281 
	`ªque°_úq
(63+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

282 "CChù Eº‹", 
NULL
);

283 
	`ªque°_úq
(62+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

284 "PChù 0 H_Eº‹", 
NULL
);

285 
	`ªque°_úq
(61+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

286 "PChù 1 H_Eº‹", 
NULL
);

287 
	`ªque°_úq
(60+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

288 "PChù 0 C_Eº‹", 
NULL
);

289 
	`ªque°_úq
(59+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

290 "PChù 1 C_Eº‹", 
NULL
);

295 
	`tô™_ªgi°î_îr‹_h™dÀrs
();

300 
	`cdl_check_c⁄sﬁe_d©a_log
();

302 
	}
}

304 
__devöô


305 
	$tô™_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

307 
u8
 
öéöe
;

308 
úq
;

311 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
öéöe
);

312 
úq
 = 
öéöe
;

315 i‡((
úq
 & 0xF0) == 0xE0)

316  
úq
;

319  
úq
 + 16;

320 
	}
}

322 
__öô


323 
	$tô™_öô_pci
()

329 
	`tô™_œã_öô
();

331 
pci_¥obe_⁄ly
 = 1;

332 
	`comm⁄_öô_pci
();

333 
	`SMC669_Inô
(0);

334 
	`loˇã_™d_öô_vga
(
NULL
);

335 
	}
}

341 
__öô


342 
	$¥iv©ìr_öô_pci
()

348 
	`ªque°_úq
(53+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

349 "NMI", 
NULL
);

350 
	`ªque°_úq
(50+16, 
tô™_öå_n›
, 
IRQF_DISABLED
,

351 "Tem≥øtuª W¨nög", 
NULL
);

356  
	`tô™_öô_pci
();

357 
	}
}

363 
Æpha_machöe_ve˘‹
 
tô™_mv
 
	g__öômv
 = {

364 .
ve˘‹_«me
 = "TITAN",

365 
	gDO_EV6_MMU
,

366 
	gDO_DEFAULT_RTC
,

367 
	gDO_TITAN_IO
,

368 .
	gmachöe_check
 = 
tô™_machöe_check
,

369 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

370 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

371 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

372 .
	gpci_dac_off£t
 = 
TITAN_DAC_OFFSET
,

374 .
	gƒ_úqs
 = 80,

377 .
	gagp_öfo
 = 
tô™_agp_öfo
,

379 .
	göô_¨ch
 = 
tô™_öô_¨ch
,

380 .
	göô_úq
 = 
tô™_Àgacy_öô_úq
,

381 .
	göô_πc
 = 
comm⁄_öô_πc
,

382 .
	göô_pci
 = 
tô™_öô_pci
,

384 .
	gkûl_¨ch
 = 
tô™_kûl_¨ch
,

385 .
	gpci_m≠_úq
 = 
tô™_m≠_úq
,

386 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

388 
	$ALIAS_MV
(
tô™
)

390 
Æpha_machöe_ve˘‹
 
¥iv©ìr_mv
 
__öômv
 = {

391 .
ve˘‹_«me
 = "PRIVATEER",

392 
DO_EV6_MMU
,

393 
DO_DEFAULT_RTC
,

394 
DO_TITAN_IO
,

395 .
machöe_check
 = 
¥iv©ìr_machöe_check
,

396 .
max_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

397 .
mö_io_addªss
 = 
DEFAULT_IO_BASE
,

398 .
mö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

399 .
pci_dac_off£t
 = 
TITAN_DAC_OFFSET
,

401 .
ƒ_úqs
 = 80,

404 .
agp_öfo
 = 
tô™_agp_öfo
,

406 .
öô_¨ch
 = 
tô™_öô_¨ch
,

407 .
öô_úq
 = 
tô™_Àgacy_öô_úq
,

408 .
öô_πc
 = 
comm⁄_öô_πc
,

409 .
öô_pci
 = 
¥iv©ìr_öô_pci
,

411 .
kûl_¨ch
 = 
tô™_kûl_¨ch
,

412 .
pci_m≠_úq
 = 
tô™_m≠_úq
,

413 .
pci_swizzÀ
 = 
comm⁄_swizzÀ
,

414 
	}
};

	@arch/alpha/kernel/sys_wildfire.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/mm.h
>

12 
	~<löux/sched.h
>

13 
	~<löux/pci.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/bô›s.h
>

17 
	~<asm/±ø˚.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/dma.h
>

20 
	~<asm/úq.h
>

21 
	~<asm/mmu_c⁄ãxt.h
>

22 
	~<asm/io.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/c‹e_wûdfúe.h
>

25 
	~<asm/hwΩb.h
>

26 
	~<asm/ébÊush.h
>

28 
	~"¥Ÿo.h
"

29 
	~"úq_im∂.h
"

30 
	~"pci_im∂.h
"

31 
	~"machvec_im∂.h
"

33 
	gˇched_úq_mask
[
WILDFIRE_NR_IRQS
/(()*8)];

35 
DEFINE_SPINLOCK
(
wûdfúe_úq_lock
);

37 
	gdoög_öô_úq_hw
 = 0;

40 
	$wûdfúe_upd©e_úq_hw
(
úq
)

42 
qbbno
 = (
úq
 >> 8Ë& (
WILDFIRE_MAX_QBB
 - 1);

43 
pˇno
 = (
úq
 >> 6Ë& (
WILDFIRE_PCA_PER_QBB
 - 1);

44 
wûdfúe_pˇ
 *
pˇ
;

45 vﬁ©ûê* 
íabÀ0
;

47 i‡(!
	`WILDFIRE_PCA_EXISTS
(
qbbno
, 
pˇno
)) {

48 i‡(!
doög_öô_úq_hw
) {

49 
	`¥ötk
(
KERN_ERR
 "wildfire_update_irq_hw:"

52 
úq
, 
pˇno
, 
qbbno
);

57 
pˇ
 = 
	`WILDFIRE_pˇ
(
qbbno
, 
pˇno
);

58 
íabÀ0
 = (*Ë&
pˇ
->
pˇ_öt
[0].
íabÀ
;

60 *
íabÀ0
 = 
ˇched_úq_mask
[
qbbno
 * 
WILDFIRE_PCA_PER_QBB
 + 
pˇno
];

61 
	`mb
();

62 *
íabÀ0
;

63 
	}
}

65 
__öô


66 
	$wûdfúe_öô_úq_hw
()

69 
wûdfúe_pˇ
 * 
pˇ
 = 
	`WILDFIRE_pˇ
(0, 0);

70 vﬁ©ûê* 
íabÀ0
, * 
íabÀ1
, * 
íabÀ2
, *
íabÀ3
;

71 vﬁ©ûê* 
èrgë0
, * 
èrgë1
, * 
èrgë2
, *
èrgë3
;

73 
íabÀ0
 = (*Ë&
pˇ
->
pˇ_öt
[0].
íabÀ
;

74 
íabÀ1
 = (*Ë&
pˇ
->
pˇ_öt
[1].
íabÀ
;

75 
íabÀ2
 = (*Ë&
pˇ
->
pˇ_öt
[2].
íabÀ
;

76 
íabÀ3
 = (*Ë&
pˇ
->
pˇ_öt
[3].
íabÀ
;

78 
èrgë0
 = (*Ë&
pˇ
->
pˇ_öt
[0].
èrgë
;

79 
èrgë1
 = (*Ë&
pˇ
->
pˇ_öt
[1].
èrgë
;

80 
èrgë2
 = (*Ë&
pˇ
->
pˇ_öt
[2].
èrgë
;

81 
èrgë3
 = (*Ë&
pˇ
->
pˇ_öt
[3].
èrgë
;

83 *
íabÀ0
 = *
íabÀ1
 = *
íabÀ2
 = *
íabÀ3
 = 0;

85 *
èrgë0
 = (1UL<<8Ë| 
	`WILDFIRE_QBB
(0);

86 *
èrgë1
 = *
èrgë2
 = *
èrgë3
 = 0;

88 
	`mb
();

90 *
íabÀ0
; *
íabÀ1
; *
íabÀ2
; *
íabÀ3
;

91 *
èrgë0
; *
èrgë1
; *
èrgë2
; *
èrgë3
;

94 
i
;

96 
doög_öô_úq_hw
 = 1;

99 
i
 = 0; i < 
WILDFIRE_NR_IRQS
; i+=
WILDFIRE_IRQ_PER_PCA
)

100 
	`wûdfúe_upd©e_úq_hw
(
i
);

102 
doög_öô_úq_hw
 = 0;

104 
	}
}

107 
	$wûdfúe_íabÀ_úq
(
úq
)

109 i‡(
úq
 < 16)

110 
	`i8259a_íabÀ_úq
(
úq
);

112 
	`•ö_lock
(&
wûdfúe_úq_lock
);

113 
	`£t_bô
(
úq
, &
ˇched_úq_mask
);

114 
	`wûdfúe_upd©e_úq_hw
(
úq
);

115 
	`•ö_u∆ock
(&
wûdfúe_úq_lock
);

116 
	}
}

119 
	$wûdfúe_dißbÀ_úq
(
úq
)

121 i‡(
úq
 < 16)

122 
	`i8259a_dißbÀ_úq
(
úq
);

124 
	`•ö_lock
(&
wûdfúe_úq_lock
);

125 
	`˛ór_bô
(
úq
, &
ˇched_úq_mask
);

126 
	`wûdfúe_upd©e_úq_hw
(
úq
);

127 
	`•ö_u∆ock
(&
wûdfúe_úq_lock
);

128 
	}
}

131 
	$wûdfúe_mask_™d_ack_úq
(
úq
)

133 i‡(
úq
 < 16)

134 
	`i8259a_mask_™d_ack_úq
(
úq
);

136 
	`•ö_lock
(&
wûdfúe_úq_lock
);

137 
	`˛ór_bô
(
úq
, &
ˇched_úq_mask
);

138 
	`wûdfúe_upd©e_úq_hw
(
úq
);

139 
	`•ö_u∆ock
(&
wûdfúe_úq_lock
);

140 
	}
}

143 
	$wûdfúe_°¨tup_úq
(
úq
)

145 
	`wûdfúe_íabÀ_úq
(
úq
);

147 
	}
}

150 
	$wûdfúe_íd_úq
(
úq
)

153 i‡(!
úq_desc
[
úq
].
a˘i⁄
)

154 
	`¥ötk
("gŸ irq %d\n", 
úq
);

156 i‡(!(
úq_desc
[
úq
].
°©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

157 
	`wûdfúe_íabÀ_úq
(
úq
);

158 
	}
}

160 
hw_öãºu±_ty≥
 
	gwûdfúe_úq_ty≥
 = {

161 .
ty≥«me
 = "WILDFIRE",

162 .
	g°¨tup
 = 
wûdfúe_°¨tup_úq
,

163 .
	gshutdown
 = 
wûdfúe_dißbÀ_úq
,

164 .
	gíabÀ
 = 
wûdfúe_íabÀ_úq
,

165 .
	gdißbÀ
 = 
wûdfúe_dißbÀ_úq
,

166 .
	gack
 = 
wûdfúe_mask_™d_ack_úq
,

167 .
	gíd
 = 
wûdfúe_íd_úq
,

170 
__öô


171 
	$wûdfúe_öô_úq_≥r_pˇ
(
qbbno
, 
pˇno
)

173 
i
, 
úq_büs
;

174 
io_büs
;

175 
úqa˘i⁄
 
iß_íabÀ
 = {

176 .
h™dÀr
 = 
no_a˘i⁄
,

177 .
«me
 = "isa_enable",

180 
úq_büs
 = 
qbbno
 * (
WILDFIRE_PCA_PER_QBB
 * 
WILDFIRE_IRQ_PER_PCA
)

181 + 
pˇno
 * 
WILDFIRE_IRQ_PER_PCA
;

184 
io_büs
 = 
	`WILDFIRE_IO
(
qbbno
, 
pˇno
<<1Ë- 
WILDFIRE_IO_BIAS
;

187 
	`outb
(0, 
DMA1_RESET_REG
 + 
io_büs
);

188 
	`outb
(0, 
DMA2_RESET_REG
 + 
io_büs
);

189 
	`outb
(
DMA_MODE_CASCADE
, 
DMA2_MODE_REG
 + 
io_büs
);

190 
	`outb
(0, 
DMA2_MASK_REG
 + 
io_büs
);

195 
	`öô_i8259a_úqs
();

198 
i
 = 0; i < 16; ++i) {

199 i‡(
i
 == 2)

201 
úq_desc
[
i
+
úq_büs
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

202 
úq_desc
[
i
+
úq_büs
].
chù
 = &
wûdfúe_úq_ty≥
;

205 
úq_desc
[36+
úq_büs
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

206 
úq_desc
[36+
úq_büs
].
chù
 = &
wûdfúe_úq_ty≥
;

207 
i
 = 40; i < 64; ++i) {

208 
úq_desc
[
i
+
úq_büs
].
°©us
 = 
IRQ_DISABLED
 | 
IRQ_LEVEL
;

209 
úq_desc
[
i
+
úq_büs
].
chù
 = &
wûdfúe_úq_ty≥
;

212 
	`£tup_úq
(32+
úq_büs
, &
iß_íabÀ
);

213 
	}
}

215 
__öô


216 
	$wûdfúe_öô_úq
()

218 
qbbno
, 
pˇno
;

221 
	`wûdfúe_öô_úq_hw
();

222 
	`öô_i8259a_úqs
();

225 
qbbno
 = 0; qbbnÿ< 
WILDFIRE_MAX_QBB
; qbbno++) {

226 i‡(
	`WILDFIRE_QBB_EXISTS
(
qbbno
)) {

227 
pˇno
 = 0;Öˇnÿ< 
WILDFIRE_PCA_PER_QBB
;Öcano++) {

228 i‡(
	`WILDFIRE_PCA_EXISTS
(
qbbno
, 
pˇno
)) {

229 
	`wûdfúe_öô_úq_≥r_pˇ
(
qbbno
, 
pˇno
);

234 
	}
}

237 
	$wûdfúe_devi˚_öãºu±
(
ve˘‹
)

239 
úq
;

241 
úq
 = (
ve˘‹
 - 0x800) >> 4;

249 
	`h™dÀ_úq
(
úq
);

251 
	}
}

303 
__öô


304 
	$wûdfúe_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

306 
úq_èb
[8][5] 
__öôd©a
 = {

317 
mö_id£l
 = 0, 
max_id£l
 = 7, 
úqs_≥r_¶Ÿ
 = 5;

319 
pci_c⁄åﬁÀr
 *
ho£
 = 
dev
->
sysd©a
;

320 
úq
 = 
COMMON_TABLE_LOOKUP
;

322 i‡(
úq
 > 0) {

323 
qbbno
 = 
ho£
->
ödex
 >> 3;

324 
pˇno
 = (
ho£
->
ödex
 >> 1) & 3;

325 
úq
 +(
qbbno
 << 8Ë+ (
pˇno
 << 6);

327  
úq
;

328 
	}
}

335 
Æpha_machöe_ve˘‹
 
wûdfúe_mv
 
	g__öômv
 = {

336 .
ve˘‹_«me
 = "WILDFIRE",

337 
	gDO_EV6_MMU
,

338 
	gDO_DEFAULT_RTC
,

339 
	gDO_WILDFIRE_IO
,

340 .
	gmachöe_check
 = 
wûdfúe_machöe_check
,

341 .
	gmax_iß_dma_addªss
 = 
ALPHA_MAX_ISA_DMA_ADDRESS
,

342 .
	gmö_io_addªss
 = 
DEFAULT_IO_BASE
,

343 .
	gmö_mem_addªss
 = 
DEFAULT_MEM_BASE
,

345 .
	gƒ_úqs
 = 
WILDFIRE_NR_IRQS
,

346 .
	gdevi˚_öãºu±
 = 
wûdfúe_devi˚_öãºu±
,

348 .
	göô_¨ch
 = 
wûdfúe_öô_¨ch
,

349 .
	göô_úq
 = 
wûdfúe_öô_úq
,

350 .
	göô_πc
 = 
comm⁄_öô_πc
,

351 .
	göô_pci
 = 
comm⁄_öô_pci
,

352 .
	gkûl_¨ch
 = 
wûdfúe_kûl_¨ch
,

353 .
	gpci_m≠_úq
 = 
wûdfúe_m≠_úq
,

354 .
	gpci_swizzÀ
 = 
comm⁄_swizzÀ
,

356 .
	g∑_to_nid
 = 
wûdfúe_∑_to_nid
,

357 .
	g˝uid_to_nid
 = 
wûdfúe_˝uid_to_nid
,

358 .
	gnode_mem_°¨t
 = 
wûdfúe_node_mem_°¨t
,

359 .
	gnode_mem_size
 = 
wûdfúe_node_mem_size
,

361 
ALIAS_MV
(
wûdfúe
)

	@arch/alpha/kernel/time.c

30 
	~<löux/î∫o.h
>

31 
	~<löux/moduÀ.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/kî√l.h
>

34 
	~<löux/∑øm.h
>

35 
	~<löux/°rög.h
>

36 
	~<löux/mm.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/i›‹t.h
>

39 
	~<löux/úq.h
>

40 
	~<löux/öãºu±.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/bcd.h
>

43 
	~<löux/¥ofûe.h
>

45 
	~<asm/uac˚ss.h
>

46 
	~<asm/io.h
>

47 
	~<asm/hwΩb.h
>

48 
	~<asm/8253pô.h
>

50 
	~<löux/mc146818πc.h
>

51 
	~<löux/time.h
>

52 
	~<löux/timex.h
>

54 
	~"¥Ÿo.h
"

55 
	~"úq_im∂.h
"

57 
£t_πc_mmss
();

59 
DEFINE_SPINLOCK
(
πc_lock
);

60 
EXPORT_SYMBOL
(
πc_lock
);

62 
	#TICK_SIZE
 (
tick_n£c
 / 1000)

	)

69 
	#FIX_SHIFT
 48

	)

74 
__u32
 
	mœ°_time
;

76 
	msˇÀd_ticks_≥r_cy˛e
;

78 
time_t
 
	mœ°_πc_upd©e
;

80 
	m∑πül_tick
;

81 } 
	g°©e
;

83 
	ge°_cy˛e_‰eq
;

86 
ölöe
 
__u32
 
	$Ωcc
()

88 
__u32
 
ªsu…
;

89 
asm
 vﬁ©ûê("Ωc¯%0" : "Ù"(
ªsu…
));

90  
ªsu…
;

91 
	}
}

97 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev
)

99 
dñè
;

100 
__u32
 
now
;

101 
¡icks
;

103 #i‚de‡
CONFIG_SMP


105 
	`¥ofûe_tick
(
CPU_PROFILING
);

108 
	`wrôe_£qlock
(&
xtime_lock
);

115 
now
 = 
	`Ωcc
();

116 
dñè
 = 
now
 - 
°©e
.
œ°_time
;

117 
°©e
.
œ°_time
 = 
now
;

118 
dñè
 = dñè * 
°©e
.
sˇÀd_ticks_≥r_cy˛e
 + sèã.
∑πül_tick
;

119 
°©e
.
∑πül_tick
 = 
dñè
 & ((1UL << 
FIX_SHIFT
) - 1);

120 
¡icks
 = 
dñè
 >> 
FIX_SHIFT
;

122 
¡icks
 > 0) {

123 
	`do_timî
(1);

124 #i‚de‡
CONFIG_SMP


125 
	`upd©e_¥o˚ss_times
(
	`u£r_mode
(
	`gë_úq_ªgs
()));

127 
¡icks
--;

135 i‡(
	`¡p_syn˚d
()

136 && 
xtime
.
tv_£c
 > 
°©e
.
œ°_πc_upd©e
 + 660

137 && 
xtime
.
tv_n£c
 >500000 - ((Ë
TICK_SIZE
) / 2

138 && 
xtime
.
tv_n£c
 <500000 + ((Ë
TICK_SIZE
) / 2) {

139 
tmp
 = 
	`£t_πc_mmss
(
xtime
.
tv_£c
);

140 
°©e
.
œ°_πc_upd©e
 = 
xtime
.
tv_£c
 - (
tmp
 ? 600 : 0);

143 
	`wrôe_£qu∆ock
(&
xtime_lock
);

144  
IRQ_HANDLED
;

145 
	}
}

148 
	$comm⁄_öô_πc
()

150 
x
;

153 
x
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
) & 0x3f;

156 i‡(
x
 != 0x26 && x != 0x25 && x != 0x19 && x != 0x06) {

157 
	`¥ötk
("Sëtög RTC_FREQÅÿ1024 Hz (%x)\n", 
x
);

158 
	`CMOS_WRITE
(0x26, 
RTC_FREQ_SELECT
);

162 
x
 = 
	`CMOS_READ
(
RTC_CONTROL
);

163 i‡(!(
x
 & 
RTC_PIE
)) {

164 
	`¥ötk
("Turning on RTC interrupts.\n");

165 
x
 |
RTC_PIE
;

166 
x
 &~(
RTC_AIE
 | 
RTC_UIE
);

167 
	`CMOS_WRITE
(
x
, 
RTC_CONTROL
);

169 (Ë
	`CMOS_READ
(
RTC_INTR_FLAGS
);

171 
	`outb
(0x36, 0x43);

172 
	`outb
(0x00, 0x40);

173 
	`outb
(0x00, 0x40);

175 
	`outb
(0xb6, 0x43);

176 
	`outb
(0x31, 0x42);

177 
	`outb
(0x13, 0x42);

179 
	`öô_πc_úq
();

180 
	}
}

189 
__öô


190 
	$vÆid©e_cc_vÆue
(
cc
)

192 
	sbounds
 {

193 
mö
, 
max
;

194 } 
˝u_hz
[] 
__öôd©a
 = {

195 [
EV3_CPU
] = { 50000000, 200000000 },

196 [
EV4_CPU
] = { 100000000, 300000000 },

197 [
LCA4_CPU
] = { 100000000, 300000000 },

198 [
EV45_CPU
] = { 200000000, 300000000 },

199 [
EV5_CPU
] = { 250000000, 433000000 },

200 [
EV56_CPU
] = { 333000000, 667000000 },

201 [
PCA56_CPU
] = { 400000000, 600000000 },

202 [
PCA57_CPU
] = { 500000000, 600000000 },

203 [
EV6_CPU
] = { 466000000, 600000000 },

204 [
EV67_CPU
] = { 600000000, 750000000 },

205 [
EV68AL_CPU
] = { 750000000, 940000000 },

206 [
EV68CB_CPU
] = { 1000000000, 1333333333 },

208 [
EV68CX_CPU
] = { 1000000000, 1700000000 },

209 [
EV69_CPU
] = { 1000000000, 1700000000 },

210 [
EV7_CPU
] = { 800000000, 1400000000 },

211 [
EV79_CPU
] = { 1000000000, 2000000000 },

215 c⁄° 
devüti⁄
 = 10000000;

217 
≥r˝u_°ru˘
 *
˝u
;

218 
ödex
;

220 
˝u
 = (
≥r˝u_°ru˘
 *)((*)
hwΩb
 + hwΩb->
¥o˚ss‹_off£t
);

221 
ödex
 = 
˝u
->
ty≥
 & 0xffffffff;

224 i‡(
ödex
 >
	`ARRAY_SIZE
(
˝u_hz
))

225  
cc
;

228 i‡(
˝u_hz
[
ödex
].
max
 == 0)

229  
cc
;

231 i‡(
cc
 < 
˝u_hz
[
ödex
].
mö
 - 
devüti⁄


232 || 
cc
 > 
˝u_hz
[
ödex
].
max
 + 
devüti⁄
)

235  
cc
;

236 
	}
}

244 
	#CALIBRATE_LATCH
 0xffff

	)

245 
	#TIMEOUT_COUNT
 0x100000

	)

247 
__öô


248 
	$ˇlibøã_cc_wôh_pô
()

250 
cc
, 
cou¡
 = 0;

253 
	`outb
((
	`öb
(0x61) & ~0x02) | 0x01, 0x61);

262 
	`outb
(0xb0, 0x43);

263 
	`outb
(
CALIBRATE_LATCH
 & 0xff, 0x42);

264 
	`outb
(
CALIBRATE_LATCH
 >> 8, 0x42);

266 
cc
 = 
	`Ωcc
();

268 
cou¡
++;

269 } (
	`öb
(0x61Ë& 0x20Ë=0 && 
cou¡
 < 
TIMEOUT_COUNT
);

270 
cc
 = 
	`Ωcc
() - cc;

273 i‡(
cou¡
 <1 || cou¡ =
TIMEOUT_COUNT
)

276  (()
cc
 * 
PIT_TICK_RATE
Ë/ (
CALIBRATE_LATCH
 + 1);

277 
	}
}

284 
__öô


285 
	$Ωcc_a·î_upd©e_ö_¥ogªss
()

287 dÿ{ } !(
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
));

288 dÿ{ } 
	`CMOS_READ
(
RTC_FREQ_SELECT
Ë& 
RTC_UIP
);

290  
	`Ωcc
();

291 
	}
}

293 
__öô


294 
	$time_öô
()

296 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
, 
cc1
, 
cc2
, 
ïoch
;

297 
cy˛e_‰eq
, 
tﬁî™˚
;

298 
diff
;

301 i‡(!
e°_cy˛e_‰eq
)

302 
e°_cy˛e_‰eq
 = 
	`vÆid©e_cc_vÆue
(
	`ˇlibøã_cc_wôh_pô
());

304 
cc1
 = 
	`Ωcc
();

307 i‡(!
e°_cy˛e_‰eq
) {

308 
cc1
 = 
	`Ωcc_a·î_upd©e_ö_¥ogªss
();

309 
cc2
 = 
	`Ωcc_a·î_upd©e_ö_¥ogªss
();

310 
e°_cy˛e_‰eq
 = 
	`vÆid©e_cc_vÆue
(
cc2
 - 
cc1
);

311 
cc1
 = 
cc2
;

314 
cy˛e_‰eq
 = 
hwΩb
->cycle_freq;

315 i‡(
e°_cy˛e_‰eq
) {

318 
tﬁî™˚
 = 
cy˛e_‰eq
 / 4000;

319 
diff
 = 
cy˛e_‰eq
 - 
e°_cy˛e_‰eq
;

320 i‡(
diff
 < 0)

321 
diff
 = -diff;

322 i‡(()
diff
 > 
tﬁî™˚
) {

323 
cy˛e_‰eq
 = 
e°_cy˛e_‰eq
;

324 
	`¥ötk
("HWRPB cycle frequency bogus. "

325 "E°im©ed %lu Hz\n", 
cy˛e_‰eq
);

327 
e°_cy˛e_‰eq
 = 0;

329 } i‡(! 
	`vÆid©e_cc_vÆue
 (
cy˛e_‰eq
)) {

330 
	`¥ötk
("HWRPB cycle frequency bogus, "

338 
	`__dñay
(1000000);

340 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

341 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

342 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

343 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

344 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

345 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

347 i‡(!(
	`CMOS_READ
(
RTC_CONTROL
Ë& 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

348 
	`BCD_TO_BIN
(
£c
);

349 
	`BCD_TO_BIN
(
mö
);

350 
	`BCD_TO_BIN
(
hour
);

351 
	`BCD_TO_BIN
(
day
);

352 
	`BCD_TO_BIN
(
m⁄
);

353 
	`BCD_TO_BIN
(
yór
);

357 
ïoch
 = 1900;

358 i‡(
yór
 < 20)

359 
ïoch
 = 2000;

360 i‡(
yór
 >= 20 && year < 48)

362 
ïoch
 = 1980;

363 i‡(
yór
 >= 48 && year < 70)

365 
ïoch
 = 1952;

367 
	`¥ötk
(
KERN_INFO
 "UsögÉpoch = %d\n", 
ïoch
);

369 i‡((
yór
 +
ïoch
) < 1970)

370 
yór
 += 100;

372 
xtime
.
tv_£c
 = 
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

373 
xtime
.
tv_n£c
 = 0;

375 
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
 -
xtime
.tv_sec;

376 
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
 = 0;

378 i‡(
HZ
 > (1<<16)) {

379 
	`__you_loo£
 ();

380 
	`__you_loo£
();

383 
°©e
.
œ°_time
 = 
cc1
;

384 
°©e
.
sˇÀd_ticks_≥r_cy˛e


385 ((Ë
HZ
 << 
FIX_SHIFT
Ë/ 
cy˛e_‰eq
;

386 
°©e
.
œ°_πc_upd©e
 = 0;

387 
°©e
.
∑πül_tick
 = 0L;

390 
Æpha_mv
.
	`öô_πc
();

391 
	}
}

401 
	$do_gëtimeofday
(
timevÆ
 *
tv
)

403 
Êags
;

404 
£c
, 
u£c
, 
£q
;

405 
dñè_cy˛es
, 
dñè_u£c
, 
∑πül_tick
;

408 
£q
 = 
	`ªad_£qbegö_úqßve
(&
xtime_lock
, 
Êags
);

410 
dñè_cy˛es
 = 
	`Ωcc
(Ë- 
°©e
.
œ°_time
;

411 
£c
 = 
xtime
.
tv_£c
;

412 
u£c
 = (
xtime
.
tv_n£c
 / 1000);

413 
∑πül_tick
 = 
°©e
.partial_tick;

415 } 
	`ªad_£qªåy_úqª°‹e
(&
xtime_lock
, 
£q
, 
Êags
));

417 #ifde‡
CONFIG_SMP


420 
dñè_u£c
 = 0;

435 
dñè_u£c
 = (
dñè_cy˛es
 * 
°©e
.
sˇÀd_ticks_≥r_cy˛e


436 + 
∑πül_tick
) * 15625;

437 
dñè_u£c
 = ((dñè_u£¯/ ((1UL << (
FIX_SHIFT
-6-1)Ë* 
HZ
)) + 1) / 2;

440 
u£c
 +
dñè_u£c
;

441 i‡(
u£c
 >= 1000000) {

442 
£c
 += 1;

443 
u£c
 -= 1000000;

446 
tv
->
tv_£c
 = 
£c
;

447 
tv
->
tv_u£c
 = 
u£c
;

448 
	}
}

450 
EXPORT_SYMBOL
(
do_gëtimeofday
);

453 
	$do_£âimeofday
(
time•ec
 *
tv
)

455 
time_t
 
wtm_£c
, 
£c
 = 
tv
->
tv_£c
;

456 
wtm_n£c
, 
n£c
 = 
tv
->
tv_n£c
;

457 
dñè_n£c
;

459 i‡(()
tv
->
tv_n£c
 >
NSEC_PER_SEC
)

460  -
EINVAL
;

462 
	`wrôe_£qlock_úq
(&
xtime_lock
);

468 #ifde‡
CONFIG_SMP


469 
dñè_n£c
 = 0;

471 
dñè_n£c
 = 
	`Ωcc
(Ë- 
°©e
.
œ°_time
;

472 
dñè_n£c
 = (dñè_n£¯* 
°©e
.
sˇÀd_ticks_≥r_cy˛e


473 + 
°©e
.
∑πül_tick
) * 15625;

474 
dñè_n£c
 = ((dñè_n£¯/ ((1UL << (
FIX_SHIFT
-6-1)Ë* 
HZ
)) + 1) / 2;

475 
dñè_n£c
 *= 1000;

478 
n£c
 -
dñè_n£c
;

480 
wtm_£c
 = 
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
 + (
xtime
.tv_£¯- 
£c
);

481 
wtm_n£c
 = 
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
 + (
xtime
.tv_n£¯- 
n£c
);

483 
	`£t_n‹mÆized_time•ec
(&
xtime
, 
£c
, 
n£c
);

484 
	`£t_n‹mÆized_time•ec
(&
wÆl_to_m⁄Ÿ⁄ic
, 
wtm_£c
, 
wtm_n£c
);

486 
	`¡p_˛ór
();

488 
	`wrôe_£qu∆ock_úq
(&
xtime_lock
);

489 
	`˛ock_was_£t
();

491 
	}
}

493 
EXPORT_SYMBOL
(
do_£âimeofday
);

509 
	$£t_πc_mmss
(
nowtime
)

511 
ªtvÆ
 = 0;

512 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

513 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

516 
	`•ö_lock
(&
πc_lock
);

518 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

519 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

522 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

523 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

525 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

526 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

527 
	`BCD_TO_BIN
(
cmos_möuãs
);

535 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

536 
ªÆ_möuãs
 = 
nowtime
 / 60;

537 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1) {

539 
ªÆ_möuãs
 += 30;

541 
ªÆ_möuãs
 %= 60;

543 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

544 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

545 
	`BIN_TO_BCD
(
ªÆ_£c⁄ds
);

546 
	`BIN_TO_BCD
(
ªÆ_möuãs
);

548 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
,
RTC_SECONDS
);

549 
	`CMOS_WRITE
(
ªÆ_möuãs
,
RTC_MINUTES
);

551 
	`¥ötk
(
KERN_WARNING


553 
cmos_möuãs
, 
ªÆ_möuãs
);

554 
ªtvÆ
 = -1;

564 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

565 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

566 
	`•ö_u∆ock
(&
πc_lock
);

568  
ªtvÆ
;

569 
	}
}

	@arch/alpha/kernel/traps.c

11 
	~<löux/mm.h
>

12 
	~<löux/sched.h
>

13 
	~<löux/ây.h
>

14 
	~<löux/dñay.h
>

15 
	~<löux/smp_lock.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kÆlsyms.h
>

20 
	~<asm/gíå≠.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/u«lig√d.h
>

23 
	~<asm/sysöfo.h
>

24 
	~<asm/hwΩb.h
>

25 
	~<asm/mmu_c⁄ãxt.h
>

27 
	~"¥Ÿo.h
"

31 
	g›DEC_fix
;

33 
__öô


34 
	$›DEC_check
()

36 
__asm__
 
	`__vﬁ©ûe__
 (

54 : [
fix
] "Ù" (
›DEC_fix
)

55 : [
πi
] "n" (
PAL_πi
), [
wª¡
] "n" (
PAL_wª¡
)

58 i‡(
›DEC_fix
)

59 
	`¥ötk
("opDEC fixupÉnabled.\n");

60 
	}
}

63 
	$dik_show_ªgs
(
±_ªgs
 *
ªgs
, *
r9_15
)

65 
	`¥ötk
("pc = [<%016lx>]Ña = [<%016lx>]Ös = %04lx %s\n",

66 
ªgs
->
pc
,Ñegs->
r26
,Ñegs->
ps
, 
	`¥öt_èöãd
());

67 
	`¥öt_symbﬁ
("p¯i†© %s\n", 
ªgs
->
pc
);

68 
	`¥öt_symbﬁ
("ø i†© %s\n", 
ªgs
->
r26
 );

69 
	`¥ötk
("v0 = %016lxÅ0 = %016lxÅ1 = %016lx\n",

70 
ªgs
->
r0
,Ñegs->
r1
,Ñegs->
r2
);

71 
	`¥ötk
("t2 = %016lxÅ3 = %016lxÅ4 = %016lx\n",

72 
ªgs
->
r3
,Ñegs->
r4
,Ñegs->
r5
);

73 
	`¥ötk
("t5 = %016lxÅ6 = %016lxÅ7 = %016lx\n",

74 
ªgs
->
r6
,Ñegs->
r7
,Ñegs->
r8
);

76 i‡(
r9_15
) {

77 
	`¥ötk
("s0 = %016lx s1 = %016lx s2 = %016lx\n",

78 
r9_15
[9],Ñ9_15[10],Ñ9_15[11]);

79 
	`¥ötk
("s3 = %016lx s4 = %016lx s5 = %016lx\n",

80 
r9_15
[12],Ñ9_15[13],Ñ9_15[14]);

81 
	`¥ötk
("s6 = %016lx\n", 
r9_15
[15]);

84 
	`¥ötk
("a0 = %016lxá1 = %016lxá2 = %016lx\n",

85 
ªgs
->
r16
,Ñegs->
r17
,Ñegs->
r18
);

86 
	`¥ötk
("a3 = %016lxá4 = %016lxá5 = %016lx\n",

87 
ªgs
->
r19
,Ñegs->
r20
,Ñegs->
r21
);

88 
	`¥ötk
("t8 = %016lxÅ9 = %016lxÅ10= %016lx\n",

89 
ªgs
->
r22
,Ñegs->
r23
,Ñegs->
r24
);

90 
	`¥ötk
("t11= %016lxÖv = %016lxát = %016lx\n",

91 
ªgs
->
r25
,Ñegs->
r27
,Ñegs->
r28
);

92 
	`¥ötk
("g∞%016lx s∞%p\n", 
ªgs
->
gp
,Ñegs+1);

94 
	`__hÆt
();

96 
	}
}

99 * 
	gúeg_«me
[] = {"v0", "t0", "t1", "t2", "t3", "t4", "t5", "t6",

106 
	$dik_show_code
(*
pc
)

108 
i
;

110 
	`¥ötk
("Code:");

111 
i
 = -6; i < 2; i++) {

112 
ö¢
;

113 i‡(
	`__gë_u£r
(
ö¢
, (
__u£r
 *)
pc
 + 
i
))

115 
	`¥ötk
("%c%08x%c", 
i
 ? ' ' : '<', 
ö¢
, i ? ' ' : '>');

117 
	`¥ötk
("\n");

118 
	}
}

121 
	$dik_show_åa˚
(*
•
)

123 
i
 = 0;

124 
	`¥ötk
("Trace:\n");

125 0x1ff8 & (Ë
•
) {

126 
_°ext
[], 
_ëext
[];

127 
tmp
 = *
•
;

128 
•
++;

129 i‡(
tmp
 < (Ë&
_°ext
)

131 i‡(
tmp
 >(Ë&
_ëext
)

133 
	`¥ötk
("[<%lx>]", 
tmp
);

134 
	`¥öt_symbﬁ
(" %s", 
tmp
);

135 
	`¥ötk
("\n");

136 i‡(
i
 > 40) {

137 
	`¥ötk
(" ...");

141 
	`¥ötk
("\n");

142 
	}
}

144 
	gk°ack_dïth_to_¥öt
 = 24;

146 
	$show_°ack
(
èsk_°ru˘
 *
èsk
, *
•
)

148 *
°ack
;

149 
i
;

155 if(
•
==
NULL
)

156 
•
=(*)&sp;

158 
°ack
 = 
•
;

159 
i
=0; i < 
k°ack_dïth_to_¥öt
; i++) {

160 i‡(((Ë
°ack
 & (
THREAD_SIZE
-1)) == 0)

162 i‡(
i
 && ((i % 4) == 0))

163 
	`¥ötk
("\n ");

164 
	`¥ötk
("%016lx ", *
°ack
++);

166 
	`¥ötk
("\n");

167 
	`dik_show_åa˚
(
•
);

168 
	}
}

170 
	$dump_°ack
()

172 
	`show_°ack
(
NULL
, NULL);

173 
	}
}

175 
EXPORT_SYMBOL
(
dump_°ack
);

178 
	$dõ_if_kî√l
(* 
°r
, 
±_ªgs
 *
ªgs
, 
îr
, *
r9_15
)

180 i‡(
ªgs
->
ps
 & 8)

182 #ifde‡
CONFIG_SMP


183 
	`¥ötk
("CPU %d ", 
	`h¨d_smp_¥o˚ss‹_id
());

185 
	`¥ötk
("%s(%d): %†%ld\n", 
cuºít
->
comm
, cuºít->
pid
, 
°r
, 
îr
);

186 
	`dik_show_ªgs
(
ªgs
, 
r9_15
);

187 
	`dik_show_åa˚
((*)(
ªgs
+1));

188 
	`dik_show_code
((*)
ªgs
->
pc
);

190 i‡(
	`ã°_™d_£t_thªad_Êag
 (
TIF_DIE_IF_KERNEL
)) {

191 
	`¥ötk
("die_if_kernelÑecursion detected.\n");

192 
	`loˇl_úq_íabÀ
();

195 
	`do_exô
(
SIGSEGV
);

196 
	}
}

198 #i‚de‡
CONFIG_MATHEMU


199 
	$dummy_emul
(Ë{  0; 
	}
}

200 (*
Æpha_Â_emul_im¥eci£
)(
±_ªgs
 *
ªgs
, 
wrôemask
)

201 (*)
dummy_emul
;

202 (*
Æpha_Â_emul
Ë(
pc
)

203 (*)
dummy_emul
;

205 
	`Æpha_Â_emul_im¥eci£
(
±_ªgs
 *
ªgs
, 
wrôemask
);

206 
	`Æpha_Â_emul
 (
pc
);

209 
asmlökage
 

210 
	$do_ítArôh
(
summ¨y
, 
wrôe_mask
,

211 
±_ªgs
 *
ªgs
)

213 
si_code
 = 
FPE_FLTINV
;

214 
sigöfo_t
 
öfo
;

216 i‡(
summ¨y
 & 1) {

220 i‡(!
	`amask
(
AMASK_PRECISE_TRAP
))

221 
si_code
 = 
	`Æpha_Â_emul
(
ªgs
->
pc
 - 4);

223 
si_code
 = 
	`Æpha_Â_emul_im¥eci£
(
ªgs
, 
wrôe_mask
);

224 i‡(
si_code
 == 0)

227 
	`dõ_if_kî√l
("Arôhmëi¯Áu…", 
ªgs
, 0, 
NULL
);

229 
öfo
.
si_signo
 = 
SIGFPE
;

230 
öfo
.
si_î∫o
 = 0;

231 
öfo
.
si_code
 = si_code;

232 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

233 
	`£nd_sig_öfo
(
SIGFPE
, &
öfo
, 
cuºít
);

234 
	}
}

236 
asmlökage
 

237 
	$do_ítIF
(
ty≥
, 
±_ªgs
 *
ªgs
)

239 
sigöfo_t
 
öfo
;

240 
signo
, 
code
;

242 i‡((
ªgs
->
ps
 & ~
IPL_MAX
) == 0) {

243 i‡(
ty≥
 == 1) {

244 c⁄° *
d©a


245 (c⁄° *Ë
ªgs
->
pc
;

246 
	`¥ötk
("Kernel bugát %s:%d\n",

247 (c⁄° *)(
d©a
[1] | ()data[2] << 32),

248 
d©a
[0]);

250 
	`dõ_if_kî√l
((
ty≥
 == 1 ? "Kernel Bug" : "Instruction fault"),

251 
ªgs
, 
ty≥
, 
NULL
);

254 
ty≥
) {

256 
öfo
.
si_signo
 = 
SIGTRAP
;

257 
öfo
.
si_î∫o
 = 0;

258 
öfo
.
si_code
 = 
TRAP_BRKPT
;

259 
öfo
.
si_å≠no
 = 0;

260 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

262 i‡(
	`±ø˚_ˇn˚l_b±
(
cuºít
)) {

263 
ªgs
->
pc
 -= 4;

266 
	`£nd_sig_öfo
(
SIGTRAP
, &
öfo
, 
cuºít
);

270 
öfo
.
si_signo
 = 
SIGTRAP
;

271 
öfo
.
si_î∫o
 = 0;

272 
öfo
.
si_code
 = 
__SI_FAULT
;

273 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

274 
öfo
.
si_å≠no
 = 0;

275 
	`£nd_sig_öfo
(
SIGTRAP
, &
öfo
, 
cuºít
);

279 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

280 
öfo
.
si_å≠no
 = 
ªgs
->
r16
;

281 (Ë
ªgs
->
r16
) {

282 
GEN_INTOVF
:

283 
signo
 = 
SIGFPE
;

284 
code
 = 
FPE_INTOVF
;

286 
GEN_INTDIV
:

287 
signo
 = 
SIGFPE
;

288 
code
 = 
FPE_INTDIV
;

290 
GEN_FLTOVF
:

291 
signo
 = 
SIGFPE
;

292 
code
 = 
FPE_FLTOVF
;

294 
GEN_FLTDIV
:

295 
signo
 = 
SIGFPE
;

296 
code
 = 
FPE_FLTDIV
;

298 
GEN_FLTUND
:

299 
signo
 = 
SIGFPE
;

300 
code
 = 
FPE_FLTUND
;

302 
GEN_FLTINV
:

303 
signo
 = 
SIGFPE
;

304 
code
 = 
FPE_FLTINV
;

306 
GEN_FLTINE
:

307 
signo
 = 
SIGFPE
;

308 
code
 = 
FPE_FLTRES
;

310 
GEN_ROPRAND
:

311 
signo
 = 
SIGFPE
;

312 
code
 = 
__SI_FAULT
;

315 
GEN_DECOVF
:

316 
GEN_DECDIV
:

317 
GEN_DECINV
:

318 
GEN_ASSERTERR
:

319 
GEN_NULPTRERR
:

320 
GEN_STKOVF
:

321 
GEN_STRLENERR
:

322 
GEN_SUBSTRERR
:

323 
GEN_RANGERR
:

324 
GEN_SUBRNG
:

325 
GEN_SUBRNG1
:

326 
GEN_SUBRNG2
:

327 
GEN_SUBRNG3
:

328 
GEN_SUBRNG4
:

329 
GEN_SUBRNG5
:

330 
GEN_SUBRNG6
:

331 
GEN_SUBRNG7
:

333 
signo
 = 
SIGTRAP
;

334 
code
 = 
__SI_FAULT
;

338 
öfo
.
si_signo
 = 
signo
;

339 
öfo
.
si_î∫o
 = 0;

340 
öfo
.
si_code
 = 
code
;

341 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

342 
	`£nd_sig_öfo
(
signo
, &
öfo
, 
cuºít
);

346 i‡(
	`im∂vî
(Ë=
IMPLVER_EV4
) {

347 
si_code
;

357 
ªgs
->
pc
 +
›DEC_fix
;

362 
si_code
 = 
	`Æpha_Â_emul
(
ªgs
->
pc
 - 4);

363 i‡(
si_code
 == 0)

365 i‡(
si_code
 > 0) {

366 
öfo
.
si_signo
 = 
SIGFPE
;

367 
öfo
.
si_î∫o
 = 0;

368 
öfo
.
si_code
 = si_code;

369 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

370 
	`£nd_sig_öfo
(
SIGFPE
, &
öfo
, 
cuºít
);

386 
	`cuºít_thªad_öfo
()->
pcb
.
Êags
 |= 1;

387 
	`__ªlﬂd_thªad
(&
	`cuºít_thªad_öfo
()->
pcb
);

395 
öfo
.
si_signo
 = 
SIGILL
;

396 
öfo
.
si_î∫o
 = 0;

397 
öfo
.
si_code
 = 
ILL_ILLOPC
;

398 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

399 
	`£nd_sig_öfo
(
SIGILL
, &
öfo
, 
cuºít
);

400 
	}
}

409 
asmlökage
 

410 
	$do_ítDbg
(
±_ªgs
 *
ªgs
)

412 
sigöfo_t
 
öfo
;

414 
	`dõ_if_kî√l
("In°ru˘i⁄ fau…", 
ªgs
, 0, 
NULL
);

416 
öfo
.
si_signo
 = 
SIGILL
;

417 
öfo
.
si_î∫o
 = 0;

418 
öfo
.
si_code
 = 
ILL_ILLOPC
;

419 
öfo
.
si_addr
 = (
__u£r
 *Ë
ªgs
->
pc
;

420 
	`f‹˚_sig_öfo
(
SIGILL
, &
öfo
, 
cuºít
);

421 
	}
}

437 
	sÆÃegs
 {

438 
	mªgs
[32];

439 
	mps
, 
	mpc
, 
	mgp
, 
	ma0
, 
	ma1
, 
	ma2
;

442 
	su«lig√d_°©
 {

443 
	mcou¡
, 
	mva
, 
	mpc
;

444 } 
	gu«lig√d
[2];

448 
	#u«_ªg
(
r
Ë(
ªgs
->ªgs[‘Ë>16 && (rË<18 ? (r)+19 : (r)])

	)

451 
asmlökage
 

452 
	$do_ítU«
(* 
va
, 
›code
, 
ªg
,

453 
ÆÃegs
 *
ªgs
)

455 
îr‹
, 
tmp1
, 
tmp2
, 
tmp3
, 
tmp4
;

456 
pc
 = 
ªgs
->pc - 4;

457 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

459 
u«lig√d
[0].
cou¡
++;

460 
u«lig√d
[0].
va
 = () va;

461 
u«lig√d
[0].
pc
 =Öc;

467 
›code
) {

469 
__asm__
 
	`__vﬁ©ûe__
(

481 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

482 : "r"(
va
), "0"(0));

483 i‡(
îr‹
)

484 
gŸ_ex˚±i⁄
;

485 
	`u«_ªg
(
ªg
Ë
tmp1
|
tmp2
;

489 
__asm__
 
	`__vﬁ©ûe__
(

501 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

502 : "r"(
va
), "0"(0));

503 i‡(
îr‹
)

504 
gŸ_ex˚±i⁄
;

505 
	`u«_ªg
(
ªg
Ë()(
tmp1
|
tmp2
);

509 
__asm__
 
	`__vﬁ©ûe__
(

521 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

522 : "r"(
va
), "0"(0));

523 i‡(
îr‹
)

524 
gŸ_ex˚±i⁄
;

525 
	`u«_ªg
(
ªg
Ë
tmp1
|
tmp2
;

532 
__asm__
 
	`__vﬁ©ûe__
(

554 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

555 "=&r"(
tmp3
), "=&r"(
tmp4
)

556 : "r"(
va
), "r"(
	`u«_ªg
(
ªg
)), "0"(0));

557 i‡(
îr‹
)

558 
gŸ_ex˚±i⁄
;

562 
__asm__
 
	`__vﬁ©ûe__
(

584 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

585 "=&r"(
tmp3
), "=&r"(
tmp4
)

586 : "r"(
va
), "r"(
	`u«_ªg
(
ªg
)), "0"(0));

587 i‡(
îr‹
)

588 
gŸ_ex˚±i⁄
;

592 
__asm__
 
	`__vﬁ©ûe__
(

614 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

615 "=&r"(
tmp3
), "=&r"(
tmp4
)

616 : "r"(
va
), "r"(
	`u«_ªg
(
ªg
)), "0"(0));

617 i‡(
îr‹
)

618 
gŸ_ex˚±i⁄
;

622 
	`lock_kî√l
();

623 
	`¥ötk
("Bad unaligned kerneláccessát %016lx: %p %lx %ld\n",

624 
pc
, 
va
, 
›code
, 
ªg
);

625 
	`do_exô
(
SIGSEGV
);

627 
gŸ_ex˚±i⁄
:

630 i‡((
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
pc
)) != 0) {

631 
√wpc
;

632 
√wpc
 = 
	`fixup_ex˚±i⁄
(
u«_ªg
, 
fixup
, 
pc
);

634 
	`¥ötk
("Forwarding unalignedÉxceptionát %lx (%lx)\n",

635 
pc
, 
√wpc
);

637 
ªgs
->
pc
 = 
√wpc
;

645 
	`lock_kî√l
();

647 
	`¥ötk
("%s(%d): unhandled unalignedÉxception\n",

648 
cuºít
->
comm
, cuºít->
pid
);

650 
	`¥ötk
("pc = [<%016lx>]Ña = [<%016lx>]Ös = %04lx\n",

651 
pc
, 
	`u«_ªg
(26), 
ªgs
->
ps
);

652 
	`¥ötk
("r0 = %016lxÑ1 = %016lxÑ2 = %016lx\n",

653 
	`u«_ªg
(0), una_reg(1), una_reg(2));

654 
	`¥ötk
("r3 = %016lxÑ4 = %016lxÑ5 = %016lx\n",

655 
	`u«_ªg
(3), una_reg(4), una_reg(5));

656 
	`¥ötk
("r6 = %016lxÑ7 = %016lxÑ8 = %016lx\n",

657 
	`u«_ªg
(6), una_reg(7), una_reg(8));

658 
	`¥ötk
("r9 = %016lxÑ10= %016lxÑ11= %016lx\n",

659 
	`u«_ªg
(9), una_reg(10), una_reg(11));

660 
	`¥ötk
("r12= %016lxÑ13= %016lxÑ14= %016lx\n",

661 
	`u«_ªg
(12), una_reg(13), una_reg(14));

662 
	`¥ötk
("r15%016lx\n", 
	`u«_ªg
(15));

663 
	`¥ötk
("r16= %016lxÑ17= %016lxÑ18= %016lx\n",

664 
	`u«_ªg
(16), una_reg(17), una_reg(18));

665 
	`¥ötk
("r19= %016lxÑ20= %016lxÑ21= %016lx\n",

666 
	`u«_ªg
(19), una_reg(20), una_reg(21));

667 
	`¥ötk
("r22= %016lxÑ23= %016lxÑ24= %016lx\n",

668 
	`u«_ªg
(22), una_reg(23), una_reg(24));

669 
	`¥ötk
("r25= %016lxÑ27= %016lxÑ28= %016lx\n",

670 
	`u«_ªg
(25), una_reg(27), una_reg(28));

671 
	`¥ötk
("g∞%016lx s∞%p\n", 
ªgs
->
gp
,Ñegs+1);

673 
	`dik_show_code
((*)
pc
);

674 
	`dik_show_åa˚
((*)(
ªgs
+1));

676 i‡(
	`ã°_™d_£t_thªad_Êag
 (
TIF_DIE_IF_KERNEL
)) {

677 
	`¥ötk
("die_if_kernelÑecursion detected.\n");

678 
	`loˇl_úq_íabÀ
();

681 
	`do_exô
(
SIGSEGV
);

682 
	}
}

690 
ölöe
 

691 
	$s_mem_to_ªg
 (
s_mem
)

693 
‰ac
 = (
s_mem
 >> 0) & 0x7fffff;

694 
sign
 = (
s_mem
 >> 31) & 0x1;

695 
exp_msb
 = (
s_mem
 >> 30) & 0x1;

696 
exp_low
 = (
s_mem
 >> 23) & 0x7f;

697 
exp
;

699 
exp
 = (
exp_msb
 << 10Ë| 
exp_low
;

700 i‡(
exp_msb
) {

701 i‡(
exp_low
 == 0x7f) {

702 
exp
 = 0x7ff;

705 i‡(
exp_low
 == 0x00) {

706 
exp
 = 0x000;

708 
exp
 |= (0x7 << 7);

711  (
sign
 << 63Ë| (
exp
 << 52Ë| (
‰ac
 << 29);

712 
	}
}

718 
ölöe
 

719 
	$s_ªg_to_mem
 (
s_ªg
)

721  ((
s_ªg
 >> 62) << 30) | ((s_reg << 5) >> 34);

722 
	}
}

744 
	#OP_INT_MASK
 ( 1L << 0x28 | 1L << 0x2c \

747 | 1L << 0x0®| 1L << 0x0êË

	)

749 
	#OP_WRITE_MASK
 ( 1L << 0x26 | 1L << 0x27 \

751 | 1L << 0x0d | 1L << 0x0êË

	)

753 
	#R
(
x
Ë((
size_t
Ë&((
±_ªgs
 *)0)->x)

	)

755 
	gu«u£r_ªg_off£ts
[32] = {

756 
R
(
r0
), R(
r1
), R(
r2
), R(
r3
), R(
r4
), R(
r5
), R(
r6
), R(
r7
), R(
r8
),

759 
R
(
r16
), R(
r17
), R(
r18
),

760 
R
(
r19
), R(
r20
), R(
r21
), R(
r22
), R(
r23
), R(
r24
), R(
r25
), R(
r26
),

761 
R
(
r27
), R(
r28
), R(
gp
),

765 #unde‡
R


767 
asmlökage
 

768 
	$do_ítU«U£r
(
__u£r
 * 
va
, 
›code
,

769 
ªg
, 
±_ªgs
 *
ªgs
)

771 
˙t
 = 0;

772 
œ°_time
 = 0;

774 
tmp1
, 
tmp2
, 
tmp3
, 
tmp4
;

775 
Áke_ªg
, *
ªg_addr
 = &fake_reg;

776 
sigöfo_t
 
öfo
;

777 
îr‹
;

782 i‡(!
	`ã°_thªad_Êag
 (
TIF_UAC_NOPRINT
)) {

783 i‡(
˙t
 >5 && 
jiffõs
 - 
œ°_time
 > 5*
HZ
) {

784 
˙t
 = 0;

786 i‡(++
˙t
 < 5) {

787 
	`¥ötk
("%s(%d): unalignedÅrapát %016lx: %p %lx %ld\n",

788 
cuºít
->
comm
, cuºít->
pid
,

789 
ªgs
->
pc
 - 4, 
va
, 
›code
, 
ªg
);

791 
œ°_time
 = 
jiffõs
;

793 i‡(
	`ã°_thªad_Êag
 (
TIF_UAC_SIGBUS
))

794 
give_sigbus
;

796 i‡(
	`ã°_thªad_Êag
 (
TIF_UAC_NOFIX
))

802 i‡(!
	`__ac˚ss_ok
(()
va
, 0, 
USER_DS
))

803 
give_sig£gv
;

805 ++
u«lig√d
[1].
cou¡
;

806 
u«lig√d
[1].
va
 = ()va;

807 
u«lig√d
[1].
pc
 = 
ªgs
->pc - 4;

809 i‡((1L << 
›code
Ë& 
OP_INT_MASK
) {

811 i‡(
ªg
 < 30) {

812 
ªg_addr
 = (*)

813 ((*)
ªgs
 + 
u«u£r_ªg_off£ts
[
ªg
]);

814 } i‡(
ªg
 == 30) {

816 
Áke_ªg
 = 
	`rdu•
();

819 
Áke_ªg
 = 0;

827 
›code
) {

829 
__asm__
 
	`__vﬁ©ûe__
(

841 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

842 : "r"(
va
), "0"(0));

843 i‡(
îr‹
)

844 
give_sig£gv
;

845 *
ªg_addr
 = 
tmp1
|
tmp2
;

849 
__asm__
 
	`__vﬁ©ûe__
(

861 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

862 : "r"(
va
), "0"(0));

863 i‡(
îr‹
)

864 
give_sig£gv
;

865 
	`Æpha_wrôe_Â_ªg
(
ªg
, 
	`s_mem_to_ªg
(()(
tmp1
|
tmp2
)));

869 
__asm__
 
	`__vﬁ©ûe__
(

881 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

882 : "r"(
va
), "0"(0));

883 i‡(
îr‹
)

884 
give_sig£gv
;

885 
	`Æpha_wrôe_Â_ªg
(
ªg
, 
tmp1
|
tmp2
);

889 
__asm__
 
	`__vﬁ©ûe__
(

901 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

902 : "r"(
va
), "0"(0));

903 i‡(
îr‹
)

904 
give_sig£gv
;

905 *
ªg_addr
 = ()(
tmp1
|
tmp2
);

909 
__asm__
 
	`__vﬁ©ûe__
(

921 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
)

922 : "r"(
va
), "0"(0));

923 i‡(
îr‹
)

924 
give_sig£gv
;

925 *
ªg_addr
 = 
tmp1
|
tmp2
;

932 
__asm__
 
	`__vﬁ©ûe__
(

954 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

955 "=&r"(
tmp3
), "=&r"(
tmp4
)

956 : "r"(
va
), "r"(*
ªg_addr
), "0"(0));

957 i‡(
îr‹
)

958 
give_sig£gv
;

962 
Áke_ªg
 = 
	`s_ªg_to_mem
(
	`Æpha_ªad_Â_ªg
(
ªg
));

966 
__asm__
 
	`__vﬁ©ûe__
(

988 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

989 "=&r"(
tmp3
), "=&r"(
tmp4
)

990 : "r"(
va
), "r"(*
ªg_addr
), "0"(0));

991 i‡(
îr‹
)

992 
give_sig£gv
;

996 
Áke_ªg
 = 
	`Æpha_ªad_Â_ªg
(
ªg
);

1000 
__asm__
 
	`__vﬁ©ûe__
(

1022 : "Ù"(
îr‹
), "=&r"(
tmp1
), "=&r"(
tmp2
),

1023 "=&r"(
tmp3
), "=&r"(
tmp4
)

1024 : "r"(
va
), "r"(*
ªg_addr
), "0"(0));

1025 i‡(
îr‹
)

1026 
give_sig£gv
;

1031 
give_sigbus
;

1035 i‡(
ªg
 == 30)

1036 
	`wru•
(
Áke_ªg
);

1039 
give_sig£gv
:

1040 
ªgs
->
pc
 -= 4;

1041 
öfo
.
si_signo
 = 
SIGSEGV
;

1042 
öfo
.
si_î∫o
 = 0;

1047 i‡(!
	`__ac˚ss_ok
(()
va
, 0, 
USER_DS
))

1048 
öfo
.
si_code
 = 
SEGV_ACCERR
;

1050 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

1051 
	`down_ªad
(&
mm
->
mm≠_£m
);

1052 i‡(
	`föd_vma
(
mm
, ()
va
))

1053 
öfo
.
si_code
 = 
SEGV_ACCERR
;

1055 
öfo
.
si_code
 = 
SEGV_MAPERR
;

1056 
	`up_ªad
(&
mm
->
mm≠_£m
);

1058 
öfo
.
si_addr
 = 
va
;

1059 
	`£nd_sig_öfo
(
SIGSEGV
, &
öfo
, 
cuºít
);

1062 
give_sigbus
:

1063 
ªgs
->
pc
 -= 4;

1064 
öfo
.
si_signo
 = 
SIGBUS
;

1065 
öfo
.
si_î∫o
 = 0;

1066 
öfo
.
si_code
 = 
BUS_ADRALN
;

1067 
öfo
.
si_addr
 = 
va
;

1068 
	`£nd_sig_öfo
(
SIGBUS
, &
öfo
, 
cuºít
);

1070 
	}
}

1072 
__öô


1073 
	$å≠_öô
()

1076 
g±r
 
	`__asm__
("$29");

1077 
	`wrkgp
(
g±r
);

1081 i‡(
	`im∂vî
(Ë=
IMPLVER_EV4
)

1082 
	`›DEC_check
();

1084 
	`wª¡
(
ítArôh
, 1);

1085 
	`wª¡
(
ítMM
, 2);

1086 
	`wª¡
(
ítIF
, 3);

1087 
	`wª¡
(
ítU«
, 4);

1088 
	`wª¡
(
ítSys
, 5);

1089 
	`wª¡
(
ítDbg
, 6);

1090 
	}
}

	@arch/alpha/lib/checksum.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/°rög.h
>

15 
	~<asm/byã‹dî.h
>

17 
ölöe
 
	$‰om64to16
(
x
)

23 
ul
;

24 
ui
[2];

25 
us
[4];

26 } 
ö_v
, 
tmp_v
, 
out_v
;

28 
ö_v
.
ul
 = 
x
;

29 
tmp_v
.
ul
 = (Ë
ö_v
.
ui
[0] + () in_v.ui[1];

33 
out_v
.
ul
 = (Ë
tmp_v
.
us
[0] + ()Åmp_v.us[1]

34 + (Ë
tmp_v
.
us
[2];

37  
out_v
.
us
[0] + out_v.us[1];

38 
	}
}

44 
__sum16
 
	$csum_t˝udp_magic
(
__be32
 
ßddr
, __be32 
daddr
,

45 
Àn
,

46 
¥Ÿo
,

47 
__wsum
 
sum
)

49  (
__f‹˚
 
__sum16
)~
	`‰om64to16
(

50 (
__f‹˚
 
u64
)
ßddr
 + (__f‹˚ u64)
daddr
 +

51 (
__f‹˚
 
u64
)
sum
 + ((
Àn
 + 
¥Ÿo
) << 8));

52 
	}
}

54 
__wsum
 
	$csum_t˝udp_nofﬁd
(
__be32
 
ßddr
, __be32 
daddr
,

55 
Àn
,

56 
¥Ÿo
,

57 
__wsum
 
sum
)

59 
ªsu…
;

61 
ªsu…
 = (
__f‹˚
 
u64
)
ßddr
 + (__f‹˚ u64)
daddr
 +

62 (
__f‹˚
 
u64
)
sum
 + ((
Àn
 + 
¥Ÿo
) << 8);

67 
ªsu…
 = (result & 0xffffffff) + (result >> 32);

69 
ªsu…
 = (result & 0xffffffff) + (result >> 32);

70  (
__f‹˚
 
__wsum
)
ªsu…
;

71 
	}
}

80 
ölöe
 
	$do_csum
(c⁄° * 
buff
, 
Àn
)

82 
odd
, 
cou¡
;

83 
ªsu…
 = 0;

85 i‡(
Àn
 <= 0)

86 
out
;

87 
odd
 = 1 & (Ë
buff
;

88 i‡(
odd
) {

89 
ªsu…
 = *
buff
 << 8;

90 
Àn
--;

91 
buff
++;

93 
cou¡
 = 
Àn
 >> 1;

94 i‡(
cou¡
) {

95 i‡(2 & (Ë
buff
) {

96 
ªsu…
 +*(*Ë
buff
;

97 
cou¡
--;

98 
Àn
 -= 2;

99 
buff
 += 2;

101 
cou¡
 >>= 1;

102 i‡(
cou¡
) {

103 i‡(4 & (Ë
buff
) {

104 
ªsu…
 +*(*Ë
buff
;

105 
cou¡
--;

106 
Àn
 -= 4;

107 
buff
 += 4;

109 
cou¡
 >>= 1;

110 i‡(
cou¡
) {

111 
ˇºy
 = 0;

113 
w
 = *(*Ë
buff
;

114 
cou¡
--;

115 
buff
 += 8;

116 
ªsu…
 +
ˇºy
;

117 
ªsu…
 +
w
;

118 
ˇºy
 = (
w
 > 
ªsu…
);

119 } 
cou¡
);

120 
ªsu…
 +
ˇºy
;

121 
ªsu…
 = (result & 0xffffffff) + (result >> 32);

123 i‡(
Àn
 & 4) {

124 
ªsu…
 +*(*Ë
buff
;

125 
buff
 += 4;

128 i‡(
Àn
 & 2) {

129 
ªsu…
 +*(*Ë
buff
;

130 
buff
 += 2;

133 i‡(
Àn
 & 1)

134 
ªsu…
 +*
buff
;

135 
ªsu…
 = 
	`‰om64to16
(result);

136 i‡(
odd
)

137 
ªsu…
 = ((result >> 8) & 0xff) | ((result & 0xff) << 8);

138 
out
:

139  
ªsu…
;

140 
	}
}

146 
__sum16
 
	$ù_Á°_csum
(c⁄° *
ùh
, 
ihl
)

148  (
__f‹˚
 
__sum16
)~
	`do_csum
(
ùh
,
ihl
*4);

149 
	}
}

163 
__wsum
 
	$csum_∑πül
(c⁄° *
buff
, 
Àn
, 
__wsum
 
sum
)

165 
ªsu…
 = 
	`do_csum
(
buff
, 
Àn
);

168 
ªsu…
 +(
__f‹˚
 
u32
)
sum
;

170 
ªsu…
 = (result & 0xffffffff) + (result >> 32);

171  (
__f‹˚
 
__wsum
)
ªsu…
;

172 
	}
}

174 
EXPORT_SYMBOL
(
csum_∑πül
);

180 
__sum16
 
	$ù_compuã_csum
(c⁄° *
buff
, 
Àn
)

182  (
__f‹˚
 
__sum16
)~
	`‰om64to16
(
	`do_csum
(
buff
,
Àn
));

183 
	}
}

	@arch/alpha/lib/csum_partial_copy.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/°rög.h
>

14 
	~<asm/uac˚ss.h
>

17 
	#ldq_u
(
x
,
y
) \

18 
__asm__
 
	`__vﬁ©ûe__
("ldq_u %0,%1":"Ù" (
x
):"m" (*(c⁄° *)(
y
)))

	)

20 
	#°q_u
(
x
,
y
) \

21 
__asm__
 
	`__vﬁ©ûe__
("°q_u %1,%0":"=m" (*(*)(
y
)):"r" (
x
))

	)

23 
	#extql
(
x
,
y
,
z
) \

24 
__asm__
 
	`__vﬁ©ûe__
("extq»%1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

26 
	#extqh
(
x
,
y
,
z
) \

27 
__asm__
 
	`__vﬁ©ûe__
("extqh %1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

29 
	#mskql
(
x
,
y
,
z
) \

30 
__asm__
 
	`__vﬁ©ûe__
("mskq»%1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

32 
	#mskqh
(
x
,
y
,
z
) \

33 
__asm__
 
	`__vﬁ©ûe__
("mskqh %1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

35 
	#ösql
(
x
,
y
,
z
) \

36 
__asm__
 
	`__vﬁ©ûe__
("ösq»%1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

38 
	#ösqh
(
x
,
y
,
z
) \

39 
__asm__
 
	`__vﬁ©ûe__
("ösqh %1,%2,%0":"Ù" (
z
):"r" (
x
),"r" (
y
))

	)

42 
	#__gë_u£r_u
(
x
,
±r
) \

44 
__guu_îr
; \

45 
__asm__
 
	`__vﬁ©ûe__
( \

52 : "Ù"(
x
), "Ù"(
__guu_îr
) \

53 : "m"(
	`__m
(
±r
)), "1"(0)); \

54 
__guu_îr
; \

55 })

	)

57 
	#__put_u£r_u
(
x
,
±r
) \

59 
__puu_îr
; \

60 
__asm__
 
	`__vﬁ©ûe__
( \

67 : "Ù"(
__puu_îr
) \

68 : "m"(
	`__m
(
addr
)), "rJ"(
x
), "0"(0)); \

69 
__puu_îr
; \

70 })

	)

73 
ölöe
 
	$‰om64to16
(
x
)

79 
ul
;

80 
ui
[2];

81 
us
[4];

82 } 
ö_v
, 
tmp_v
, 
out_v
;

84 
ö_v
.
ul
 = 
x
;

85 
tmp_v
.
ul
 = (Ë
ö_v
.
ui
[0] + () in_v.ui[1];

89 
out_v
.
ul
 = (Ë
tmp_v
.
us
[0] + ()Åmp_v.us[1]

90 + (Ë
tmp_v
.
us
[2];

93  
out_v
.
us
[0] + out_v.us[1];

94 
	}
}

101 
ölöe
 

102 
	$csum_∑πül_cfu_Æig√d
(c⁄° 
__u£r
 *
§c
, *
d°
,

103 
Àn
, 
checksum
,

104 *
îΩ
)

106 
ˇºy
 = 0;

107 
îr
 = 0;

109 
Àn
 >= 0) {

110 
w‹d
;

111 
îr
 |
	`__gë_u£r
(
w‹d
, 
§c
);

112 
checksum
 +
ˇºy
;

113 
§c
++;

114 
checksum
 +
w‹d
;

115 
Àn
 -= 8;

116 
ˇºy
 = 
checksum
 < 
w‹d
;

117 *
d°
 = 
w‹d
;

118 
d°
++;

120 
Àn
 += 8;

121 
checksum
 +
ˇºy
;

122 i‡(
Àn
) {

123 
w‹d
, 
tmp
;

124 
îr
 |
	`__gë_u£r
(
w‹d
, 
§c
);

125 
tmp
 = *
d°
;

126 
	`mskql
(
w‹d
, 
Àn
, word);

127 
checksum
 +
w‹d
;

128 
	`mskqh
(
tmp
, 
Àn
,Åmp);

129 
ˇºy
 = 
checksum
 < 
w‹d
;

130 *
d°
 = 
w‹d
 | 
tmp
;

131 
checksum
 +
ˇºy
;

133 i‡(
îr
Ë*
îΩ
 =Érr;

134  
checksum
;

135 
	}
}

141 
ölöe
 

142 
	$csum_∑πül_cfu_de°_Æig√d
(c⁄° 
__u£r
 *
§c
,

143 *
d°
,

144 
soff
,

145 
Àn
, 
checksum
,

146 *
îΩ
)

148 
fú°
;

149 
w‹d
, 
ˇºy
;

150 
œ°§c
 = 7+
Àn
+()
§c
;

151 
îr
 = 0;

153 
îr
 |
	`__gë_u£r_u
(
fú°
,
§c
);

154 
ˇºy
 = 0;

155 
Àn
 >= 0) {

156 
£c⁄d
;

158 
îr
 |
	`__gë_u£r_u
(
£c⁄d
, 
§c
+1);

159 
	`extql
(
fú°
, 
soff
, 
w‹d
);

160 
Àn
 -= 8;

161 
§c
++;

162 
	`extqh
(
£c⁄d
, 
soff
, 
fú°
);

163 
checksum
 +
ˇºy
;

164 
w‹d
 |
fú°
;

165 
fú°
 = 
£c⁄d
;

166 
checksum
 +
w‹d
;

167 *
d°
 = 
w‹d
;

168 
d°
++;

169 
ˇºy
 = 
checksum
 < 
w‹d
;

171 
Àn
 += 8;

172 
checksum
 +
ˇºy
;

173 i‡(
Àn
) {

174 
tmp
;

175 
£c⁄d
;

176 
îr
 |
	`__gë_u£r_u
(
£c⁄d
, 
œ°§c
);

177 
tmp
 = *
d°
;

178 
	`extql
(
fú°
, 
soff
, 
w‹d
);

179 
	`extqh
(
£c⁄d
, 
soff
, 
fú°
);

180 
w‹d
 |
fú°
;

181 
	`mskql
(
w‹d
, 
Àn
, word);

182 
checksum
 +
w‹d
;

183 
	`mskqh
(
tmp
, 
Àn
,Åmp);

184 
ˇºy
 = 
checksum
 < 
w‹d
;

185 *
d°
 = 
w‹d
 | 
tmp
;

186 
checksum
 +
ˇºy
;

188 i‡(
îr
Ë*
îΩ
 =Érr;

189  
checksum
;

190 
	}
}

195 
ölöe
 

196 
	$csum_∑πül_cfu_§c_Æig√d
(c⁄° 
__u£r
 *
§c
,

197 *
d°
,

198 
doff
,

199 
Àn
, 
checksum
,

200 
∑πül_de°
,

201 *
îΩ
)

203 
ˇºy
 = 0;

204 
w‹d
;

205 
£c⁄d_de°
;

206 
îr
 = 0;

208 
	`mskql
(
∑πül_de°
, 
doff
,Öartial_dest);

209 
Àn
 >= 0) {

210 
îr
 |
	`__gë_u£r
(
w‹d
, 
§c
);

211 
Àn
 -= 8;

212 
	`ösql
(
w‹d
, 
doff
, 
£c⁄d_de°
);

213 
checksum
 +
ˇºy
;

214 
	`°q_u
(
∑πül_de°
 | 
£c⁄d_de°
, 
d°
);

215 
§c
++;

216 
checksum
 +
w‹d
;

217 
	`ösqh
(
w‹d
, 
doff
, 
∑πül_de°
);

218 
ˇºy
 = 
checksum
 < 
w‹d
;

219 
d°
++;

221 
Àn
 += 8;

222 i‡(
Àn
) {

223 
checksum
 +
ˇºy
;

224 
îr
 |
	`__gë_u£r
(
w‹d
, 
§c
);

225 
	`mskql
(
w‹d
, 
Àn
, word);

226 
Àn
 -= 8;

227 
checksum
 +
w‹d
;

228 
	`ösql
(
w‹d
, 
doff
, 
£c⁄d_de°
);

229 
Àn
 +
doff
;

230 
ˇºy
 = 
checksum
 < 
w‹d
;

231 
∑πül_de°
 |
£c⁄d_de°
;

232 i‡(
Àn
 >= 0) {

233 
	`°q_u
(
∑πül_de°
, 
d°
);

234 i‡(!
Àn
Ë
out
;

235 
d°
++;

236 
	`ösqh
(
w‹d
, 
doff
, 
∑πül_de°
);

238 
doff
 = 
Àn
;

240 
	`ldq_u
(
£c⁄d_de°
, 
d°
);

241 
	`mskqh
(
£c⁄d_de°
, 
doff
, second_dest);

242 
	`°q_u
(
∑πül_de°
 | 
£c⁄d_de°
, 
d°
);

243 
out
:

244 
checksum
 +
ˇºy
;

245 i‡(
îr
Ë*
îΩ
 =Érr;

246  
checksum
;

247 
	}
}

253 
ölöe
 

254 
	$csum_∑πül_cfu_u«lig√d
(c⁄° 
__u£r
 * 
§c
,

255 * 
d°
,

256 
soff
, 
doff
,

257 
Àn
, 
checksum
,

258 
∑πül_de°
,

259 *
îΩ
)

261 
ˇºy
 = 0;

262 
fú°
;

263 
œ°§c
;

264 
îr
 = 0;

266 
îr
 |
	`__gë_u£r_u
(
fú°
, 
§c
);

267 
œ°§c
 = 7+
Àn
+()
§c
;

268 
	`mskql
(
∑πül_de°
, 
doff
,Öartial_dest);

269 
Àn
 >= 0) {

270 
£c⁄d
, 
w‹d
;

271 
£c⁄d_de°
;

273 
îr
 |
	`__gë_u£r_u
(
£c⁄d
, 
§c
+1);

274 
	`extql
(
fú°
, 
soff
, 
w‹d
);

275 
checksum
 +
ˇºy
;

276 
Àn
 -= 8;

277 
	`extqh
(
£c⁄d
, 
soff
, 
fú°
);

278 
§c
++;

279 
w‹d
 |
fú°
;

280 
fú°
 = 
£c⁄d
;

281 
	`ösql
(
w‹d
, 
doff
, 
£c⁄d_de°
);

282 
checksum
 +
w‹d
;

283 
	`°q_u
(
∑πül_de°
 | 
£c⁄d_de°
, 
d°
);

284 
ˇºy
 = 
checksum
 < 
w‹d
;

285 
	`ösqh
(
w‹d
, 
doff
, 
∑πül_de°
);

286 
d°
++;

288 
Àn
 +
doff
;

289 
checksum
 +
ˇºy
;

290 i‡(
Àn
 >= 0) {

291 
£c⁄d
, 
w‹d
;

292 
£c⁄d_de°
;

294 
îr
 |
	`__gë_u£r_u
(
£c⁄d
, 
œ°§c
);

295 
	`extql
(
fú°
, 
soff
, 
w‹d
);

296 
	`extqh
(
£c⁄d
, 
soff
, 
fú°
);

297 
w‹d
 |
fú°
;

298 
fú°
 = 
£c⁄d
;

299 
	`mskql
(
w‹d
, 
Àn
-
doff
, word);

300 
checksum
 +
w‹d
;

301 
	`ösql
(
w‹d
, 
doff
, 
£c⁄d_de°
);

302 
ˇºy
 = 
checksum
 < 
w‹d
;

303 
	`°q_u
(
∑πül_de°
 | 
£c⁄d_de°
, 
d°
);

304 i‡(
Àn
) {

305 
	`ldq_u
(
£c⁄d_de°
, 
d°
+1);

306 
	`ösqh
(
w‹d
, 
doff
, 
∑πül_de°
);

307 
	`mskqh
(
£c⁄d_de°
, 
Àn
, second_dest);

308 
	`°q_u
(
∑πül_de°
 | 
£c⁄d_de°
, 
d°
+1);

310 
checksum
 +
ˇºy
;

312 
£c⁄d
, 
w‹d
;

313 
£c⁄d_de°
;

315 
îr
 |
	`__gë_u£r_u
(
£c⁄d
, 
œ°§c
);

316 
	`extql
(
fú°
, 
soff
, 
w‹d
);

317 
	`extqh
(
£c⁄d
, 
soff
, 
fú°
);

318 
w‹d
 |
fú°
;

319 
	`ldq_u
(
£c⁄d_de°
, 
d°
);

320 
	`mskql
(
w‹d
, 
Àn
-
doff
, word);

321 
checksum
 +
w‹d
;

322 
	`mskqh
(
£c⁄d_de°
, 
Àn
, second_dest);

323 
ˇºy
 = 
checksum
 < 
w‹d
;

324 
	`ösql
(
w‹d
, 
doff
, word);

325 
	`°q_u
(
∑πül_de°
 | 
w‹d
 | 
£c⁄d_de°
, 
d°
);

326 
checksum
 +
ˇºy
;

328 i‡(
îr
Ë*
îΩ
 =Érr;

329  
checksum
;

330 
	}
}

332 
__wsum


333 
	$csum_∑πül_c›y_‰om_u£r
(c⁄° 
__u£r
 *
§c
, *
d°
, 
Àn
,

334 
__wsum
 
sum
, *
îΩ
)

336 
checksum
 = (
__f‹˚
 
u32
Ë
sum
;

337 
soff
 = 7 & (Ë
§c
;

338 
doff
 = 7 & (Ë
d°
;

340 i‡(
Àn
) {

341 i‡(!
doff
) {

342 i‡(!
soff
)

343 
checksum
 = 
	`csum_∑πül_cfu_Æig√d
(

344 (c⁄° 
__u£r
 *Ë
§c
,

345 (*Ë
d°
,

346 
Àn
-8, 
checksum
, 
îΩ
);

348 
checksum
 = 
	`csum_∑πül_cfu_de°_Æig√d
(

349 (c⁄° 
__u£r
 *Ë
§c
,

350 (*Ë
d°
,

351 
soff
, 
Àn
-8, 
checksum
, 
îΩ
);

353 
∑πül_de°
;

354 
	`ldq_u
(
∑πül_de°
, 
d°
);

355 i‡(!
soff
)

356 
checksum
 = 
	`csum_∑πül_cfu_§c_Æig√d
(

357 (c⁄° 
__u£r
 *Ë
§c
,

358 (*Ë
d°
,

359 
doff
, 
Àn
-8, 
checksum
,

360 
∑πül_de°
, 
îΩ
);

362 
checksum
 = 
	`csum_∑πül_cfu_u«lig√d
(

363 (c⁄° 
__u£r
 *Ë
§c
,

364 (*Ë
d°
,

365 
soff
, 
doff
, 
Àn
-8, 
checksum
,

366 
∑πül_de°
, 
îΩ
);

368 
checksum
 = 
	`‰om64to16
 (checksum);

370  (
__f‹˚
 
__wsum
)
checksum
;

371 
	}
}

373 
__wsum


374 
	$csum_∑πül_c›y_nocheck
(c⁄° *
§c
, *
d°
, 
Àn
, 
__wsum
 
sum
)

376  
	`csum_∑πül_c›y_‰om_u£r
((
__f‹˚
 c⁄° 
__u£r
 *)
§c
,

377 
d°
, 
Àn
, 
sum
, 
NULL
);

378 
	}
}

	@arch/alpha/lib/dec_and_lock.c

8 
	~<löux/•ölock.h
>

9 
	~<asm/©omic.h
>

11 
asm
 (".text \n\
.global _atomic_dec_and_lock \n\
.ent _atomic_dec_and_lock \n\
.align 4 \n\
_atomic_dec_and_lock: \n\
.prologue 0 \n\
1:Üdl_l $1, 0($16) \n\
 $1, 1, $1 \n\
 $1, 2f \n\
_c $1, 0($16) \n\
 $1, 4f \n\
 \n\
 $0 \n\
 \n\
2: br $29, 3f \n\
3:Üdgp $29, 0($29) \n\
 $atomic_dec_and_lock_1..ng \n\
.subsection 2 \n\
4: br 1b \n\
.previous \n\
.end _atomic_dec_and_lock");

33 
__©åibuã_u£d__


34 
	$©omic_dec_™d_lock_1
(
©omic_t
 *
©omic
, 
•ölock_t
 *
lock
)

37 
	`•ö_lock
(
lock
);

38 i‡(
	`©omic_dec_™d_ã°
(
©omic
))

40 
	`•ö_u∆ock
(
lock
);

42 
	}
}

	@arch/alpha/lib/fls.c

5 
	~<löux/moduÀ.h
>

6 
	~<asm/bô›s.h
>

11 c⁄° 
	g__Êsm1_èb
[256] =

38 
EXPORT_SYMBOL
(
__Êsm1_èb
);

	@arch/alpha/lib/fpreg.c

7 #i‡
deföed
(
CONFIG_ALPHA_EV6
Ë|| deföed(
CONFIG_ALPHA_EV67
)

8 
	#STT
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("·oô $f"#ªg",%0" : "Ù"(vÆ));

	)

10 
	#STT
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("°à$f"#ªg",%0" : "=m"(vÆ));

	)

14 
	$Æpha_ªad_Â_ªg
 (
ªg
)

16 
vÆ
;

18 
ªg
) {

19 0: 
	`STT
–0, 
vÆ
); ;

20 1: 
	`STT
–1, 
vÆ
); ;

21 2: 
	`STT
–2, 
vÆ
); ;

22 3: 
	`STT
–3, 
vÆ
); ;

23 4: 
	`STT
–4, 
vÆ
); ;

24 5: 
	`STT
–5, 
vÆ
); ;

25 6: 
	`STT
–6, 
vÆ
); ;

26 7: 
	`STT
–7, 
vÆ
); ;

27 8: 
	`STT
–8, 
vÆ
); ;

28 9: 
	`STT
–9, 
vÆ
); ;

29 10: 
	`STT
(10, 
vÆ
); ;

30 11: 
	`STT
(11, 
vÆ
); ;

31 12: 
	`STT
(12, 
vÆ
); ;

32 13: 
	`STT
(13, 
vÆ
); ;

33 14: 
	`STT
(14, 
vÆ
); ;

34 15: 
	`STT
(15, 
vÆ
); ;

35 16: 
	`STT
(16, 
vÆ
); ;

36 17: 
	`STT
(17, 
vÆ
); ;

37 18: 
	`STT
(18, 
vÆ
); ;

38 19: 
	`STT
(19, 
vÆ
); ;

39 20: 
	`STT
(20, 
vÆ
); ;

40 21: 
	`STT
(21, 
vÆ
); ;

41 22: 
	`STT
(22, 
vÆ
); ;

42 23: 
	`STT
(23, 
vÆ
); ;

43 24: 
	`STT
(24, 
vÆ
); ;

44 25: 
	`STT
(25, 
vÆ
); ;

45 26: 
	`STT
(26, 
vÆ
); ;

46 27: 
	`STT
(27, 
vÆ
); ;

47 28: 
	`STT
(28, 
vÆ
); ;

48 29: 
	`STT
(29, 
vÆ
); ;

49 30: 
	`STT
(30, 
vÆ
); ;

50 31: 
	`STT
(31, 
vÆ
); ;

53  
vÆ
;

54 
	}
}

56 #i‡
deföed
(
CONFIG_ALPHA_EV6
Ë|| deföed(
CONFIG_ALPHA_EV67
)

57 
	#LDT
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("ôo· %0,$f"#ªg : : "r"(vÆ));

	)

59 
	#LDT
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("ldà$f"#ªg",%0" : : "m"(vÆ));

	)

63 
	$Æpha_wrôe_Â_ªg
 (
ªg
, 
vÆ
)

65 
ªg
) {

66 0: 
	`LDT
–0, 
vÆ
); ;

67 1: 
	`LDT
–1, 
vÆ
); ;

68 2: 
	`LDT
–2, 
vÆ
); ;

69 3: 
	`LDT
–3, 
vÆ
); ;

70 4: 
	`LDT
–4, 
vÆ
); ;

71 5: 
	`LDT
–5, 
vÆ
); ;

72 6: 
	`LDT
–6, 
vÆ
); ;

73 7: 
	`LDT
–7, 
vÆ
); ;

74 8: 
	`LDT
–8, 
vÆ
); ;

75 9: 
	`LDT
–9, 
vÆ
); ;

76 10: 
	`LDT
(10, 
vÆ
); ;

77 11: 
	`LDT
(11, 
vÆ
); ;

78 12: 
	`LDT
(12, 
vÆ
); ;

79 13: 
	`LDT
(13, 
vÆ
); ;

80 14: 
	`LDT
(14, 
vÆ
); ;

81 15: 
	`LDT
(15, 
vÆ
); ;

82 16: 
	`LDT
(16, 
vÆ
); ;

83 17: 
	`LDT
(17, 
vÆ
); ;

84 18: 
	`LDT
(18, 
vÆ
); ;

85 19: 
	`LDT
(19, 
vÆ
); ;

86 20: 
	`LDT
(20, 
vÆ
); ;

87 21: 
	`LDT
(21, 
vÆ
); ;

88 22: 
	`LDT
(22, 
vÆ
); ;

89 23: 
	`LDT
(23, 
vÆ
); ;

90 24: 
	`LDT
(24, 
vÆ
); ;

91 25: 
	`LDT
(25, 
vÆ
); ;

92 26: 
	`LDT
(26, 
vÆ
); ;

93 27: 
	`LDT
(27, 
vÆ
); ;

94 28: 
	`LDT
(28, 
vÆ
); ;

95 29: 
	`LDT
(29, 
vÆ
); ;

96 30: 
	`LDT
(30, 
vÆ
); ;

97 31: 
	`LDT
(31, 
vÆ
); ;

99 
	}
}

101 #i‡
deföed
(
CONFIG_ALPHA_EV6
Ë|| deföed(
CONFIG_ALPHA_EV67
)

102 
	#STS
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("·oi†$f"#ªg",%0" : "Ù"(vÆ));

	)

104 
	#STS
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("°†$f"#ªg",%0" : "=m"(vÆ));

	)

108 
	$Æpha_ªad_Â_ªg_s
 (
ªg
)

110 
vÆ
;

112 
ªg
) {

113 0: 
	`STS
–0, 
vÆ
); ;

114 1: 
	`STS
–1, 
vÆ
); ;

115 2: 
	`STS
–2, 
vÆ
); ;

116 3: 
	`STS
–3, 
vÆ
); ;

117 4: 
	`STS
–4, 
vÆ
); ;

118 5: 
	`STS
–5, 
vÆ
); ;

119 6: 
	`STS
–6, 
vÆ
); ;

120 7: 
	`STS
–7, 
vÆ
); ;

121 8: 
	`STS
–8, 
vÆ
); ;

122 9: 
	`STS
–9, 
vÆ
); ;

123 10: 
	`STS
(10, 
vÆ
); ;

124 11: 
	`STS
(11, 
vÆ
); ;

125 12: 
	`STS
(12, 
vÆ
); ;

126 13: 
	`STS
(13, 
vÆ
); ;

127 14: 
	`STS
(14, 
vÆ
); ;

128 15: 
	`STS
(15, 
vÆ
); ;

129 16: 
	`STS
(16, 
vÆ
); ;

130 17: 
	`STS
(17, 
vÆ
); ;

131 18: 
	`STS
(18, 
vÆ
); ;

132 19: 
	`STS
(19, 
vÆ
); ;

133 20: 
	`STS
(20, 
vÆ
); ;

134 21: 
	`STS
(21, 
vÆ
); ;

135 22: 
	`STS
(22, 
vÆ
); ;

136 23: 
	`STS
(23, 
vÆ
); ;

137 24: 
	`STS
(24, 
vÆ
); ;

138 25: 
	`STS
(25, 
vÆ
); ;

139 26: 
	`STS
(26, 
vÆ
); ;

140 27: 
	`STS
(27, 
vÆ
); ;

141 28: 
	`STS
(28, 
vÆ
); ;

142 29: 
	`STS
(29, 
vÆ
); ;

143 30: 
	`STS
(30, 
vÆ
); ;

144 31: 
	`STS
(31, 
vÆ
); ;

147  
vÆ
;

148 
	}
}

150 #i‡
deföed
(
CONFIG_ALPHA_EV6
Ë|| deföed(
CONFIG_ALPHA_EV67
)

151 
	#LDS
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("ôof†%0,$f"#ªg : : "r"(vÆ));

	)

153 
	#LDS
(
ªg
,
vÆ
Ë
asm
 vﬁ©ûê("ld†$f"#ªg",%0" : : "m"(vÆ));

	)

157 
	$Æpha_wrôe_Â_ªg_s
 (
ªg
, 
vÆ
)

159 
ªg
) {

160 0: 
	`LDS
–0, 
vÆ
); ;

161 1: 
	`LDS
–1, 
vÆ
); ;

162 2: 
	`LDS
–2, 
vÆ
); ;

163 3: 
	`LDS
–3, 
vÆ
); ;

164 4: 
	`LDS
–4, 
vÆ
); ;

165 5: 
	`LDS
–5, 
vÆ
); ;

166 6: 
	`LDS
–6, 
vÆ
); ;

167 7: 
	`LDS
–7, 
vÆ
); ;

168 8: 
	`LDS
–8, 
vÆ
); ;

169 9: 
	`LDS
–9, 
vÆ
); ;

170 10: 
	`LDS
(10, 
vÆ
); ;

171 11: 
	`LDS
(11, 
vÆ
); ;

172 12: 
	`LDS
(12, 
vÆ
); ;

173 13: 
	`LDS
(13, 
vÆ
); ;

174 14: 
	`LDS
(14, 
vÆ
); ;

175 15: 
	`LDS
(15, 
vÆ
); ;

176 16: 
	`LDS
(16, 
vÆ
); ;

177 17: 
	`LDS
(17, 
vÆ
); ;

178 18: 
	`LDS
(18, 
vÆ
); ;

179 19: 
	`LDS
(19, 
vÆ
); ;

180 20: 
	`LDS
(20, 
vÆ
); ;

181 21: 
	`LDS
(21, 
vÆ
); ;

182 22: 
	`LDS
(22, 
vÆ
); ;

183 23: 
	`LDS
(23, 
vÆ
); ;

184 24: 
	`LDS
(24, 
vÆ
); ;

185 25: 
	`LDS
(25, 
vÆ
); ;

186 26: 
	`LDS
(26, 
vÆ
); ;

187 27: 
	`LDS
(27, 
vÆ
); ;

188 28: 
	`LDS
(28, 
vÆ
); ;

189 29: 
	`LDS
(29, 
vÆ
); ;

190 30: 
	`LDS
(30, 
vÆ
); ;

191 31: 
	`LDS
(31, 
vÆ
); ;

193 
	}
}

	@arch/alpha/lib/memcpy.c

18 
	~<löux/ty≥s.h
>

24 
	#ALIGN_DEST_TO8_UP
(
d
,
s
,
n
) \

25 
d
 & 7) { \

26 i‡(
n
 <= 0) ; \

27 
n
--; \

28 *(*Ë
d
 = *(*Ë
s
; \

29 
d
++; 
s
++; \

30 }

	)

31 
	#ALIGN_DEST_TO8_DN
(
d
,
s
,
n
) \

32 
d
 & 7) { \

33 i‡(
n
 <= 0) ; \

34 
n
--; \

35 
d
--; 
s
--; \

36 *(*Ë
d
 = *(*Ë
s
; \

37 }

	)

43 
	#DO_REST_UP
(
d
,
s
,
n
) \

44 
n
 > 0) { \

45 
n
--; \

46 *(*Ë
d
 = *(*Ë
s
; \

47 
d
++; 
s
++; \

48 }

	)

49 
	#DO_REST_DN
(
d
,
s
,
n
) \

50 
n
 > 0) { \

51 
n
--; \

52 
d
--; 
s
--; \

53 *(*Ë
d
 = *(*Ë
s
; \

54 }

	)

60 
	#DO_REST_ALIGNED_UP
(
d
,
s
,
n
Ë
	`DO_REST_UP
(d,s,n)

	)

61 
	#DO_REST_ALIGNED_DN
(
d
,
s
,
n
Ë
	`DO_REST_DN
(d,s,n)

	)

70 
ölöe
 
	$__mem˝y_u«lig√d_up
 (
d
, 
s
,

71 
n
)

73 
	`ALIGN_DEST_TO8_UP
(
d
,
s
,
n
);

74 
n
 -= 8;

75 i‡(
n
 >= 0) {

76 
low_w‹d
, 
high_w‹d
;

77 
	`__asm__
("ldq_u %0,%1":"Ù" (
low_w‹d
):"m" (*(*Ë
s
));

79 
tmp
;

80 
	`__asm__
("ldq_u %0,%1":"Ù" (
high_w‹d
):"m" (*(*)(
s
+8)));

81 
n
 -= 8;

82 
	`__asm__
("extql %1,%2,%0"

83 :"Ù" (
low_w‹d
)

84 :"r" (
low_w‹d
), "r" (
s
));

85 
	`__asm__
("extqh %1,%2,%0"

86 :"Ù" (
tmp
)

87 :"r" (
high_w‹d
), "r" (
s
));

88 
s
 += 8;

89 *(*Ë
d
 = 
low_w‹d
 | 
tmp
;

90 
d
 += 8;

91 
low_w‹d
 = 
high_w‹d
;

92 } 
n
 >= 0);

94 
n
 += 8;

95 
	`DO_REST_UP
(
d
,
s
,
n
);

96 
	}
}

98 
ölöe
 
	$__mem˝y_u«lig√d_dn
 (
d
, 
s
,

99 
n
)

102 
s
 +
n
;

103 
d
 +
n
;

104 
n
--)

105 * (*Ë--
d
 = * (*Ë--
s
;

106 
	}
}

116 
ölöe
 
	$__mem˝y_Æig√d_up
 (
d
, 
s
,

117 
n
)

119 
	`ALIGN_DEST_TO8_UP
(
d
,
s
,
n
);

120 
n
 -= 8;

121 
n
 >= 0) {

122 
tmp
;

123 
	`__asm__
("ldq %0,%1":"Ù" (
tmp
):"m" (*(*Ë
s
));

124 
n
 -= 8;

125 
s
 += 8;

126 *(*Ë
d
 = 
tmp
;

127 
d
 += 8;

129 
n
 += 8;

130 
	`DO_REST_ALIGNED_UP
(
d
,
s
,
n
);

131 
	}
}

132 
ölöe
 
	$__mem˝y_Æig√d_dn
 (
d
, 
s
,

133 
n
)

135 
s
 +
n
;

136 
d
 +
n
;

137 
	`ALIGN_DEST_TO8_DN
(
d
,
s
,
n
);

138 
n
 -= 8;

139 
n
 >= 0) {

140 
tmp
;

141 
s
 -= 8;

142 
	`__asm__
("ldq %0,%1":"Ù" (
tmp
):"m" (*(*Ë
s
));

143 
n
 -= 8;

144 
d
 -= 8;

145 *(*Ë
d
 = 
tmp
;

147 
n
 += 8;

148 
	`DO_REST_ALIGNED_DN
(
d
,
s
,
n
);

149 
	}
}

151 * 
	$mem˝y
(* 
de°
, c⁄° *
§c
, 
size_t
 
n
)

153 i‡(!(((Ë
de°
 ^ (Ë
§c
) & 7)) {

154 
	`__mem˝y_Æig√d_up
 ((Ë
de°
, (Ë
§c
,

155 
n
);

156  
de°
;

158 
	`__mem˝y_u«lig√d_up
 ((Ë
de°
, (Ë
§c
, 
n
);

159  
de°
;

160 
	}
}

163 
asm
("__memcpy = memcpy; .globl __memcpy");

	@arch/alpha/lib/srm_printk.c

5 
	~<löux/kî√l.h
>

6 
	~<asm/c⁄sﬁe.h
>

9 
	$§m_¥ötk
(c⁄° *
fmt
, ...)

11 
buf
[1024];

12 
va_li°
 
¨gs
;

13 
Àn
, 
num_lf
;

14 *
§c
, *
d°
;

16 
	`va_°¨t
(
¨gs
, 
fmt
);

17 
Àn
 = 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

18 
	`va_íd
(
¨gs
);

22 
num_lf
 = 0;

23 
§c
 = 
buf
; *src; ++src) {

24 i‡(*
§c
 == '\n') {

25 ++
num_lf
;

29 i‡(
num_lf
) {

31 
d°
 = 
§c
 + 
num_lf
; sr¯>
buf
; ) {

32 i‡(*
§c
 == '\n') {

33 *
d°
-- = '\r';

35 *
d°
-- = *
§c
--;

39 
	`§m_puts
(
buf
, 
num_lf
+
Àn
);

40  
Àn
;

41 
	}
}

	@arch/alpha/lib/srm_puts.c

5 
	~<löux/°rög.h
>

6 
	~<asm/c⁄sﬁe.h
>

9 
	$§m_puts
(c⁄° *
°r
, 
Àn
)

11 
ªmaöög
, 
wrôãn
;

13 i‡(!
ˇŒback_öô_d⁄e
)

14  
Àn
;

16 
ªmaöög
 = 
Àn
;Ñemaöög > 0;Ñemaöög -
wrôãn
)

18 
wrôãn
 = 
	`ˇŒback_puts
(0, 
°r
, 
ªmaöög
);

19 
wrôãn
 &= 0xffffffff;

20 
°r
 +
wrôãn
;

22  
Àn
;

23 
	}
}

	@arch/alpha/lib/stacktrace.c

1 
	~<löux/kî√l.h
>

2 
	~<asm/sy°em.h
>

4 
	tö°r
;

6 
	#MAJOR_OP
 0xfc000000

	)

7 
	#LDA_OP
 0x20000000

	)

8 
	#STQ_OP
 0xb4000000

	)

9 
	#BR_OP
 0xc0000000

	)

11 
	#STK_ALLOC_1
 0x23de8000

	)

12 
	#STK_ALLOC_1M
 0xffff8000

	)

13 
	#STK_ALLOC_2
 0x43c0153ê

	)

14 
	#STK_ALLOC_2M
 0xf„01fff

	)

16 
	#MEM_REG
 0x03e00000

	)

17 
	#MEM_BASE
 0x001f0000

	)

18 
	#MEM_OFF
 0x0000ffff

	)

19 
	#MEM_OFF_SIGN
 0x00008000

	)

20 
	#BASE_SP
 0x001e0000

	)

22 
	#STK_ALLOC_MATCH
(
INSTR
) \

23 (((
INSTR
Ë& 
STK_ALLOC_1M
Ë=
STK_ALLOC_1
 \

24 || ((
INSTR
Ë& 
STK_ALLOC_2M
Ë=
STK_ALLOC_2
)

	)

25 
	#STK_PUSH_MATCH
(
INSTR
) \

26 (((
INSTR
Ë& (
MAJOR_OP
 | 
MEM_BASE
 | 
MEM_OFF_SIGN
)Ë=(
STQ_OP
 | 
BASE_SP
))

	)

27 
	#MEM_OP_OFFSET
(
INSTR
) \

28 ((()((
INSTR
Ë& 
MEM_OFF
Ë<< 48Ë>> 48)

	)

29 
	#MEM_OP_REG
(
INSTR
) \

30 (((
INSTR
Ë& 
MEM_REG
Ë>> 22)

	)

33 
	#BB_END
(
INSTR
) \

34 (((
ö°r
)(
INSTR
Ë>
BR_OP
Ë| ((ö°r)(INSTRË< 
LDA_OP
) | \

35 ((((
ö°r
)(
INSTR
) ^ 0x60000000) < 0x20000000) & \

36 (((
ö°r
)(
INSTR
Ë& 0x0c000000Ë!0)))

	)

38 
	#IS_KERNEL_TEXT
(
PC
Ë(()(PCË> 
START_ADDR
)

	)

40 
	gªg_«me
[][4] = {

48 
ö°r
 *

49 
	$di•œy_°‹ed_ªgs
(
ö°r
 * 
¥o_pc
, * 
•
)

51 
ö°r
 * 
ªt_pc
 = 0;

52 
ªg
;

53 
vÆue
;

55 
	`¥ötk
("Prﬁoguê[<%p>], Fømê%p:\n", 
¥o_pc
, 
•
);

56 !
	`BB_END
(*
¥o_pc
))

57 i‡(
	`STK_PUSH_MATCH
(*
¥o_pc
)) {

58 
ªg
 = (*
¥o_pc
 & 
MEM_REG
) >> 21;

59 
vÆue
 = *(*)(
•
 + (*
¥o_pc
 & 
MEM_OFF
));

60 i‡(
ªg
 == 26)

61 
ªt_pc
 = (
ö°r
 *)
vÆue
;

62 
	`¥ötk
("\t\t%†/ 0x%016lx\n", 
ªg_«me
[
ªg
], 
vÆue
);

64  
ªt_pc
;

65 
	}
}

67 
ö°r
 *

68 
	$£ek_¥ﬁogue
(
ö°r
 * 
pc
)

70 !
	`STK_ALLOC_MATCH
(*
pc
))

71 --
pc
;

72 !
	`BB_END
(*(
pc
 - 1)))

73 --
pc
;

74  
pc
;

75 
	}
}

78 
	$°ack_ö¸emít
(
ö°r
 * 
¥ﬁogue_pc
)

80 !
	`STK_ALLOC_MATCH
(*
¥ﬁogue_pc
))

81 ++
¥ﬁogue_pc
;

84 i‡((*
¥ﬁogue_pc
 & 
STK_ALLOC_1M
) == STK_ALLOC_1M)

85  -((()(*
¥ﬁogue_pc
) << 48) >> 48);

87  (*
¥ﬁogue_pc
 >> 13) & 0xff;

88 
	}
}

91 
	$°ackåa˚
()

93 
ö°r
 * 
ªt_pc
;

94 
ö°r
 * 
¥ﬁogue
 = (ö°∏*)
°ackåa˚
;

95 * 
•
 
	`__asm__
 ("$30");

97 
	`¥ötk
("\tstackÅrace:\n");

99 
ªt_pc
 = 
	`di•œy_°‹ed_ªgs
(
¥ﬁogue
, 
•
);

100 
•
 +
	`°ack_ö¸emít
(
¥ﬁogue
);

101 
¥ﬁogue
 = 
	`£ek_¥ﬁogue
(
ªt_pc
);

102 } 
	`IS_KERNEL_TEXT
(
ªt_pc
));

103 
	}
}

	@arch/alpha/lib/udelay.c

7 
	~<löux/moduÀ.h
>

8 
	~<löux/sched.h
>

9 
	~<asm/∑øm.h
>

10 
	~<asm/smp.h
>

11 
	~<löux/dñay.h
>

22 
	$__dñay
(
lo›s
)

24 
tmp
;

25 
__asm__
 
	`__vﬁ©ûe__
(

31 : "=&r" (
tmp
), "Ù" (
lo›s
) : "1"(loops));

32 
	}
}

34 #ifde‡
CONFIG_SMP


35 
	#LPJ
 
˝u_d©a
[
	`smp_¥o˚ss‹_id
()].
lo›s_≥r_jiffy


	)

37 
	#LPJ
 
lo›s_≥r_jiffy


	)

41 
	$udñay
(
u£cs
)

43 
u£cs
 *((()
HZ
 << 32Ë/ 1000000Ë* 
LPJ
;

44 
	`__dñay
(()
u£cs
 >> 32);

45 
	}
}

46 
EXPORT_SYMBOL
(
udñay
);

49 
	$ndñay
(
n£cs
)

51 
n£cs
 *((()
HZ
 << 32Ë/ 1000000000Ë* 
LPJ
;

52 
	`__dñay
(()
n£cs
 >> 32);

53 
	}
}

54 
EXPORT_SYMBOL
(
ndñay
);

	@arch/alpha/math-emu/math.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ty≥s.h
>

3 
	~<löux/kî√l.h
>

4 
	~<löux/sched.h
>

6 
	~<asm/uac˚ss.h
>

8 
	~"sÂ-utû.h
"

9 
	~<m©h-emu/so·-Â.h
>

10 
	~<m©h-emu/sögÀ.h
>

11 
	~<m©h-emu/doubÀ.h
>

13 
	#OPC_PAL
 0x00

	)

14 
	#OPC_INTA
 0x10

	)

15 
	#OPC_INTL
 0x11

	)

16 
	#OPC_INTS
 0x12

	)

17 
	#OPC_INTM
 0x13

	)

18 
	#OPC_FLTC
 0x14

	)

19 
	#OPC_FLTV
 0x15

	)

20 
	#OPC_FLTI
 0x16

	)

21 
	#OPC_FLTL
 0x17

	)

22 
	#OPC_MISC
 0x18

	)

23 
	#OPC_JSR
 0x1a

	)

25 
	#FOP_SRC_S
 0

	)

26 
	#FOP_SRC_T
 2

	)

27 
	#FOP_SRC_Q
 3

	)

29 
	#FOP_FNC_ADDx
 0

	)

30 
	#FOP_FNC_CVTQL
 0

	)

31 
	#FOP_FNC_SUBx
 1

	)

32 
	#FOP_FNC_MULx
 2

	)

33 
	#FOP_FNC_DIVx
 3

	)

34 
	#FOP_FNC_CMPxUN
 4

	)

35 
	#FOP_FNC_CMPxEQ
 5

	)

36 
	#FOP_FNC_CMPxLT
 6

	)

37 
	#FOP_FNC_CMPxLE
 7

	)

38 
	#FOP_FNC_SQRTx
 11

	)

39 
	#FOP_FNC_CVTxS
 12

	)

40 
	#FOP_FNC_CVTxT
 14

	)

41 
	#FOP_FNC_CVTxQ
 15

	)

43 
	#MISC_TRAPB
 0x0000

	)

44 
	#MISC_EXCB
 0x0400

	)

46 
Æpha_ªad_Â_ªg
 (
ªg
);

47 
Æpha_wrôe_Â_ªg
 (
ªg
, 
vÆ
);

48 
Æpha_ªad_Â_ªg_s
 (
ªg
);

49 
Æpha_wrôe_Â_ªg_s
 (
ªg
, 
vÆ
);

52 #ifde‡
MODULE


54 
MODULE_DESCRIPTION
("FP Software completion module");

56 (*
Æpha_Â_emul_im¥eci£
)(
±_ªgs
 *, );

57 (*
Æpha_Â_emul
Ë(
pc
);

59 (*
ßve_emul_im¥eci£
)(
±_ªgs
 *, );

60 (*
ßve_emul
Ë(
pc
);

62 
	`do_Æpha_Â_emul_im¥eci£
(
±_ªgs
 *, );

63 
	`do_Æpha_Â_emul
();

65 
	$öô_moduÀ
()

67 
ßve_emul_im¥eci£
 = 
Æpha_Â_emul_im¥eci£
;

68 
ßve_emul
 = 
Æpha_Â_emul
;

69 
Æpha_Â_emul_im¥eci£
 = 
do_Æpha_Â_emul_im¥eci£
;

70 
Æpha_Â_emul
 = 
do_Æpha_Â_emul
;

72 
	}
}

74 
	$˛ónup_moduÀ
()

76 
Æpha_Â_emul_im¥eci£
 = 
ßve_emul_im¥eci£
;

77 
Æpha_Â_emul
 = 
ßve_emul
;

78 
	}
}

80 #unde‡
Æpha_Â_emul_im¥eci£


81 
	#Æpha_Â_emul_im¥eci£
 
do_Æpha_Â_emul_im¥eci£


	)

82 #unde‡
Æpha_Â_emul


83 
	#Æpha_Â_emul
 
do_Æpha_Â_emul


	)

98 
	$Æpha_Â_emul
 (
pc
)

100 
FP_DECL_EX
;

101 
	`FP_DECL_S
(
SA
); FP_DECL_S(
SB
); FP_DECL_S(
SR
);

102 
	`FP_DECL_D
(
DA
); FP_DECL_D(
DB
); FP_DECL_D(
DR
);

104 
Á
, 
fb
, 
fc
, 
func
, 
mode
, 
§c
;

105 
ªs
, 
va
, 
vb
, 
vc
, 
sw¸
, 
Â¸
;

106 
__u32
 
ö¢
;

107 
si_code
;

109 
	`gë_u£r
(
ö¢
, (
__u32
 
__u£r
 *)
pc
);

110 
fc
 = (
ö¢
 >> 0) & 0x1f;

111 
fb
 = (
ö¢
 >> 16) & 0x1f;

112 
Á
 = (
ö¢
 >> 21) & 0x1f;

113 
func
 = (
ö¢
 >> 5) & 0xf;

114 
§c
 = (
ö¢
 >> 9) & 0x3;

115 
mode
 = (
ö¢
 >> 11) & 0x3;

117 
Â¸
 = 
	`rdÂ¸
();

118 
sw¸
 = 
	`sw¸_upd©e_°©us
(
	`cuºít_thªad_öfo
()->
õì_°©e
, 
Â¸
);

120 i‡(
mode
 == 3) {

122 
mode
 = (
Â¸
 >> 
FPCR_DYN_SHIFT
) & 3;

125 
§c
) {

126 
FOP_SRC_S
:

127 
va
 = 
	`Æpha_ªad_Â_ªg_s
(
Á
);

128 
vb
 = 
	`Æpha_ªad_Â_ªg_s
(
fb
);

130 
	`FP_UNPACK_SP
(
SA
, &
va
);

131 
	`FP_UNPACK_SP
(
SB
, &
vb
);

133 
func
) {

134 
FOP_FNC_SUBx
:

135 
	`FP_SUB_S
(
SR
, 
SA
, 
SB
);

136 
∑ck_s
;

138 
FOP_FNC_ADDx
:

139 
	`FP_ADD_S
(
SR
, 
SA
, 
SB
);

140 
∑ck_s
;

142 
FOP_FNC_MULx
:

143 
	`FP_MUL_S
(
SR
, 
SA
, 
SB
);

144 
∑ck_s
;

146 
FOP_FNC_DIVx
:

147 
	`FP_DIV_S
(
SR
, 
SA
, 
SB
);

148 
∑ck_s
;

150 
FOP_FNC_SQRTx
:

151 
	`FP_SQRT_S
(
SR
, 
SB
);

152 
∑ck_s
;

154 
bad_ö¢
;

156 
FOP_SRC_T
:

157 
va
 = 
	`Æpha_ªad_Â_ªg
(
Á
);

158 
vb
 = 
	`Æpha_ªad_Â_ªg
(
fb
);

160 i‡((
func
 & ~3Ë=
FOP_FNC_CMPxUN
) {

161 
	`FP_UNPACK_RAW_DP
(
DA
, &
va
);

162 
	`FP_UNPACK_RAW_DP
(
DB
, &
vb
);

163 i‡(!
DA_e
 && !
	`_FP_FRAC_ZEROP_1
(
DA
)) {

164 
	`FP_SET_EXCEPTION
(
FP_EX_DENORM
);

165 i‡(
FP_DENORM_ZERO
)

166 
	`_FP_FRAC_SET_1
(
DA
, 
_FP_ZEROFRAC_1
);

168 i‡(!
DB_e
 && !
	`_FP_FRAC_ZEROP_1
(
DB
)) {

169 
	`FP_SET_EXCEPTION
(
FP_EX_DENORM
);

170 i‡(
FP_DENORM_ZERO
)

171 
	`_FP_FRAC_SET_1
(
DB
, 
_FP_ZEROFRAC_1
);

173 
	`FP_CMP_D
(
ªs
, 
DA
, 
DB
, 3);

174 
vc
 = 0x4000000000000000UL;

177 i‡(
ªs
 == 3

178 && ((
func
 & 3) >= 2

179 || 
	`FP_ISSIGNAN_D
(
DA
)

180 || 
	`FP_ISSIGNAN_D
(
DB
))) {

181 
	`FP_SET_EXCEPTION
(
FP_EX_INVALID
);

183 
func
) {

184 
FOP_FNC_CMPxUN
: i‡(
ªs
 !3Ë
vc
 = 0; ;

185 
FOP_FNC_CMPxEQ
: i‡(
ªs
Ë
vc
 = 0; ;

186 
FOP_FNC_CMPxLT
: i‡(
ªs
 !-1Ë
vc
 = 0; ;

187 
FOP_FNC_CMPxLE
: i‡(()
ªs
 > 0Ë
vc
 = 0; ;

189 
d⁄e_d
;

192 
	`FP_UNPACK_DP
(
DA
, &
va
);

193 
	`FP_UNPACK_DP
(
DB
, &
vb
);

195 
func
) {

196 
FOP_FNC_SUBx
:

197 
	`FP_SUB_D
(
DR
, 
DA
, 
DB
);

198 
∑ck_d
;

200 
FOP_FNC_ADDx
:

201 
	`FP_ADD_D
(
DR
, 
DA
, 
DB
);

202 
∑ck_d
;

204 
FOP_FNC_MULx
:

205 
	`FP_MUL_D
(
DR
, 
DA
, 
DB
);

206 
∑ck_d
;

208 
FOP_FNC_DIVx
:

209 
	`FP_DIV_D
(
DR
, 
DA
, 
DB
);

210 
∑ck_d
;

212 
FOP_FNC_SQRTx
:

213 
	`FP_SQRT_D
(
DR
, 
DB
);

214 
∑ck_d
;

216 
FOP_FNC_CVTxS
:

220 i‡(
ö¢
 & 0x2000) {

221 
	`FP_CONV
(
S
,
D
,1,1,
SR
,
DB
);

222 
∑ck_s
;

224 
vb
 = 
	`Æpha_ªad_Â_ªg_s
(
fb
);

225 
	`FP_UNPACK_SP
(
SB
, &
vb
);

226 
DR_c
 = 
DB_c
;

227 
DR_s
 = 
DB_s
;

228 
DR_e
 = 
DB_e
;

229 
DR_f
 = 
SB_f
 << (52 - 23);

230 
∑ck_d
;

233 
FOP_FNC_CVTxQ
:

234 i‡(
DB_c
 =
FP_CLS_NAN


235 && (
	`_FP_FRAC_HIGH_RAW_D
(
DB
Ë& 
_FP_QNANBIT_D
)) {

237 
vc
 = 0;

239 
	`FP_TO_INT_ROUND_D
(
vc
, 
DB
, 64, 2);

240 
d⁄e_d
;

242 
bad_ö¢
;

244 
FOP_SRC_Q
:

245 
vb
 = 
	`Æpha_ªad_Â_ªg
(
fb
);

247 
func
) {

248 
FOP_FNC_CVTQL
:

253 
vc
 = ((
vb
 & 0xc0000000) << 32 |

254 (
vb
 & 0x3fffffff) << 29);

255 
	`FP_SET_EXCEPTION
 (
FP_EX_INVALID
);

256 
d⁄e_d
;

258 
FOP_FNC_CVTxS
:

259 
	`FP_FROM_INT_S
(
SR
, (()
vb
), 64, );

260 
∑ck_s
;

262 
FOP_FNC_CVTxT
:

263 
	`FP_FROM_INT_D
(
DR
, (()
vb
), 64, );

264 
∑ck_d
;

266 
bad_ö¢
;

268 
bad_ö¢
;

270 
∑ck_s
:

271 
	`FP_PACK_SP
(&
vc
, 
SR
);

272 i‡((
_„x
 & 
FP_EX_UNDERFLOW
Ë&& (
sw¸
 & 
IEEE_MAP_UMZ
))

273 
vc
 = 0;

274 
	`Æpha_wrôe_Â_ªg_s
(
fc
, 
vc
);

275 
d⁄e
;

277 
∑ck_d
:

278 
	`FP_PACK_DP
(&
vc
, 
DR
);

279 i‡((
_„x
 & 
FP_EX_UNDERFLOW
Ë&& (
sw¸
 & 
IEEE_MAP_UMZ
))

280 
vc
 = 0;

281 
d⁄e_d
:

282 
	`Æpha_wrôe_Â_ªg
(
fc
, 
vc
);

283 
d⁄e
;

297 
d⁄e
:

298 i‡(
_„x
) {

300 
sw¸
 |(
_„x
 << 
IEEE_STATUS_TO_EXCSUM_SHIFT
);

301 
	`cuºít_thªad_öfo
()->
õì_°©e


302 |(
_„x
 << 
IEEE_STATUS_TO_EXCSUM_SHIFT
);

305 
Â¸
 &(~
FPCR_MASK
 | 
FPCR_DYN_MASK
);

306 
Â¸
 |
	`õì_sw¸_to_Â¸
(
sw¸
);

307 
	`wrÂ¸
(
Â¸
);

310 
_„x
 = _„x & 
sw¸
 & 
IEEE_TRAP_ENABLE_MASK
;

311 
si_code
 = 0;

312 i‡(
_„x
) {

313 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_DNO
Ë
si_code
 = 
FPE_FLTUND
;

314 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_INE
Ë
si_code
 = 
FPE_FLTRES
;

315 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_UNF
Ë
si_code
 = 
FPE_FLTUND
;

316 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_OVF
Ë
si_code
 = 
FPE_FLTOVF
;

317 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_DZE
Ë
si_code
 = 
FPE_FLTDIV
;

318 i‡(
_„x
 & 
IEEE_TRAP_ENABLE_INV
Ë
si_code
 = 
FPE_FLTINV
;

321  
si_code
;

330 
bad_ö¢
:

331 
	`¥ötk
(
KERN_ERR
 "alpha_fp_emul: Invalid FP insn %#xát %#lx\n",

332 
ö¢
, 
pc
);

334 
	}
}

337 
	$Æpha_Â_emul_im¥eci£
 (
±_ªgs
 *
ªgs
, 
wrôe_mask
)

339 
åiggî_pc
 = 
ªgs
->
pc
 - 4;

340 
ö¢
, 
›code
, 
rc
, 
si_code
 = 0;

353 
wrôe_mask
) {

354 
	`gë_u£r
(
ö¢
, (
__u32
 
__u£r
 *)(
åiggî_pc
));

355 
›code
 = 
ö¢
 >> 26;

356 
rc
 = 
ö¢
 & 0x1f;

358 
›code
) {

359 
OPC_PAL
:

360 
OPC_JSR
:

362 
egªss
;

364 
OPC_MISC
:

365 
ö¢
 & 0xffff) {

366 
MISC_TRAPB
:

367 
MISC_EXCB
:

368 
egªss
;

375 
OPC_INTA
:

376 
OPC_INTL
:

377 
OPC_INTS
:

378 
OPC_INTM
:

379 
wrôe_mask
 &~(1UL << 
rc
);

382 
OPC_FLTC
:

383 
OPC_FLTV
:

384 
OPC_FLTI
:

385 
OPC_FLTL
:

386 
wrôe_mask
 &~(1UL << (
rc
 + 32));

389 i‡(!
wrôe_mask
) {

391 
ªgs
->
pc
 = 
åiggî_pc
 + 4;

392 
si_code
 = 
	`Æpha_Â_emul
(
åiggî_pc
);

393 
egªss
;

395 
åiggî_pc
 -= 4;

398 
egªss
:

399  
si_code
;

400 
	}
}

	@arch/alpha/math-emu/sfp-util.h

1 
	~<löux/kî√l.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/ty≥s.h
>

4 
	~<asm/byã‹dî.h
>

5 
	~<asm/Âu.h
>

7 
	#add_sßØa
(
sh
, 
¶
, 
ah
, 
Æ
, 
bh
, 
bl
) \

8 ((
¶
Ë(
Æ
Ë+ (
bl
), (
sh
Ë(
ah
Ë+ (
bh
Ë+ ((¶Ë< (Æ)))

	)

10 
	#sub_ddmmss
(
sh
, 
¶
, 
ah
, 
Æ
, 
bh
, 
bl
) \

11 ((
¶
Ë(
Æ
Ë- (
bl
), (
sh
Ë(
ah
Ë- (
bh
Ë- (◊lË< (bl)))

	)

13 
	#umul_µmm
(
wh
, 
wl
, 
u
, 
v
) \

14 
	`__asm__
 ("mulq %2,%3,%1; umulh %2,%3,%0" \

15 : "Ù" ((
UDIty≥
)(
wh
)), \

16 "=&r" ((
UDIty≥
)(
wl
)) \

17 : "r" ((
UDIty≥
)(
u
)), \

18 "r" ((
UDIty≥
)(
v
)))

	)

20 
	#udiv_q∫nd
(
q
, 
r
, 
n1
, 
n0
, 
d
) \

21 dÿ{ 
__r
; \

22 (
q
Ë
	`__udiv_q∫nd
 (&
__r
, (
n1
), (
n0
), (
d
)); \

23 (
r
Ë
__r
; \

24 } 0)

	)

25 
__udiv_q∫nd
 (*, ,

28 
	#UDIV_NEEDS_NORMALIZATION
 1

	)

30 
	#ab‹t
(Ë
bad_ö¢


	)

32 #i‚de‡
__LITTLE_ENDIAN


33 
	#__LITTLE_ENDIAN
 -1

	)

35 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@arch/alpha/mm/extable.c

5 
	~<löux/moduÀ.h
>

6 
	~<asm/uac˚ss.h
>

8 
	$s‹t_exèbÀ
(
ex˚±i⁄_èbÀ_íåy
 *
°¨t
,

9 
ex˚±i⁄_èbÀ_íåy
 *
föish
)

11 
	}
}

13 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *

14 
	$£¨ch_exèbÀ
(c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fú°
,

15 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
œ°
,

16 
vÆue
)

18 
fú°
 <
œ°
) {

19 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
mid
;

20 
mid_vÆue
;

22 
mid
 = (
œ°
 - 
fú°
) / 2 + first;

23 
mid_vÆue
 = ()&
mid
->
ö¢
 + mid->insn;

24 i‡(
mid_vÆue
 =
vÆue
)

25  
mid
;

26 i‡(
mid_vÆue
 < 
vÆue
)

27 
fú°
 = 
mid
+1;

29 
œ°
 = 
mid
-1;

32  
NULL
;

33 
	}
}

	@arch/alpha/mm/fault.c

7 
	~<löux/sched.h
>

8 
	~<löux/kî√l.h
>

9 
	~<löux/mm.h
>

10 
	~<asm/io.h
>

12 
	#__EXTERN_INLINE
 
ölöe


	)

13 
	~<asm/mmu_c⁄ãxt.h
>

14 
	~<asm/ébÊush.h
>

15 #unde‡
__EXTERN_INLINE


17 
	~<löux/sig«l.h
>

18 
	~<löux/î∫o.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/ty≥s.h
>

21 
	~<löux/±ø˚.h
>

22 
	~<löux/mm™.h
>

23 
	~<löux/smp.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/moduÀ.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/uac˚ss.h
>

30 
dõ_if_kî√l
(*,
±_ªgs
 *,, *);

37 #i‚de‡
CONFIG_SMP


38 
	gœ°_a¢
 = 
ASN_FIRST_VERSION
;

42 
	$__lﬂd_√w_mm_c⁄ãxt
(
mm_°ru˘
 *
√xt_mm
)

44 
mmc
;

45 
pcb_°ru˘
 *
pcb
;

47 
mmc
 = 
	`__gë_√w_mm_c⁄ãxt
(
√xt_mm
, 
	`smp_¥o˚ss‹_id
());

48 
√xt_mm
->
c⁄ãxt
[
	`smp_¥o˚ss‹_id
()] = 
mmc
;

50 
pcb
 = &
	`cuºít_thªad_öfo
()->pcb;

51 
pcb
->
a¢
 = 
mmc
 & 
HARDWARE_ASN_MASK
;

52 
pcb
->
±br
 = ((Ë
√xt_mm
->
pgd
 - 
IDENT_ADDR
Ë>> 
PAGE_SHIFT
;

54 
	`__ªlﬂd_thªad
(
pcb
);

55 
	}
}

80 
	#dpf_ªg
(
r
) \

81 (((*)
ªgs
)[(
r
) <= 8 ? (r) : (r) <= 15 ? (r)-16 : \

82 (
r
Ë<18 ? (r)+8 : (r)-10])

	)

84 
asmlökage
 

85 
	$do_∑ge_Áu…
(
addªss
, 
mmc§
,

86 
ˇu£
, 
±_ªgs
 *
ªgs
)

88 
vm_¨ó_°ru˘
 * 
vma
;

89 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

90 c⁄° 
ex˚±i⁄_èbÀ_íåy
 *
fixup
;

91 
Áu…
, 
si_code
 = 
SEGV_MAPERR
;

92 
sigöfo_t
 
öfo
;

97 i‡(
ˇu£
 == 0) {

98 
ö¢
;

99 
	`__gë_u£r
(
ö¢
, (
__u£r
 *)
ªgs
->
pc
);

100 i‡((
ö¢
 >> 21 & 0x1f) == 0x1f &&

102 (1u»<< (
ö¢
 >> 26) & 0x30f00001400ul)) {

103 
ªgs
->
pc
 += 4;

110 i‡(!
mm
 || 
	`ö_©omic
())

111 
no_c⁄ãxt
;

113 #ifde‡
CONFIG_ALPHA_LARGE_VMALLOC


114 i‡(
addªss
 >
TASK_SIZE
)

115 
vmÆloc_Áu…
;

118 
	`down_ªad
(&
mm
->
mm≠_£m
);

119 
vma
 = 
	`föd_vma
(
mm
, 
addªss
);

120 i‡(!
vma
)

121 
bad_¨ó
;

122 i‡(
vma
->
vm_°¨t
 <
addªss
)

123 
good_¨ó
;

124 i‡(!(
vma
->
vm_Êags
 & 
VM_GROWSDOWN
))

125 
bad_¨ó
;

126 i‡(
	`ex∑nd_°ack
(
vma
, 
addªss
))

127 
bad_¨ó
;

131 
good_¨ó
:

132 
si_code
 = 
SEGV_ACCERR
;

133 i‡(
ˇu£
 < 0) {

134 i‡(!(
vma
->
vm_Êags
 & 
VM_EXEC
))

135 
bad_¨ó
;

136 } i‡(!
ˇu£
) {

138 i‡(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_WRITE
)))

139 
bad_¨ó
;

141 i‡(!(
vma
->
vm_Êags
 & 
VM_WRITE
))

142 
bad_¨ó
;

145 
survive
:

149 
Áu…
 = 
	`h™dÀ_mm_Áu…
(
mm
, 
vma
, 
addªss
, 
ˇu£
 > 0);

150 
	`up_ªad
(&
mm
->
mm≠_£m
);

152 
Áu…
) {

153 
VM_FAULT_MINOR
:

154 
cuºít
->
mö_Êt
++;

156 
VM_FAULT_MAJOR
:

157 
cuºít
->
maj_Êt
++;

159 
VM_FAULT_SIGBUS
:

160 
do_sigbus
;

161 
VM_FAULT_OOM
:

162 
out_of_mem‹y
;

164 
	`BUG
();

170 
bad_¨ó
:

171 
	`up_ªad
(&
mm
->
mm≠_£m
);

173 i‡(
	`u£r_mode
(
ªgs
))

174 
do_sig£gv
;

176 
no_c⁄ãxt
:

178 i‡((
fixup
 = 
	`£¨ch_ex˚±i⁄_èbÀs
(
ªgs
->
pc
)) != 0) {

179 
√wpc
;

180 
√wpc
 = 
	`fixup_ex˚±i⁄
(
dpf_ªg
, 
fixup
, 
ªgs
->
pc
);

181 
ªgs
->
pc
 = 
√wpc
;

187 
	`¥ötk
(
KERN_ALERT
 "UnableÅo handle kernelÖagingÑequestát "

188 "vútuÆáddªs†%016lx\n", 
addªss
);

189 
	`dõ_if_kî√l
("O›s", 
ªgs
, 
ˇu£
, (*)regs - 16);

190 
	`do_exô
(
SIGKILL
);

194 
out_of_mem‹y
:

195 i‡(
	`is_öô
(
cuºít
)) {

196 
	`yõld
();

197 
	`down_ªad
(&
mm
->
mm≠_£m
);

198 
survive
;

200 
	`¥ötk
(
KERN_ALERT
 "VM: killingÖrocess %s(%d)\n",

201 
cuºít
->
comm
, cuºít->
pid
);

202 i‡(!
	`u£r_mode
(
ªgs
))

203 
no_c⁄ãxt
;

204 
	`do_exô
(
SIGKILL
);

206 
do_sigbus
:

209 
öfo
.
si_signo
 = 
SIGBUS
;

210 
öfo
.
si_î∫o
 = 0;

211 
öfo
.
si_code
 = 
BUS_ADRERR
;

212 
öfo
.
si_addr
 = (
__u£r
 *Ë
addªss
;

213 
	`f‹˚_sig_öfo
(
SIGBUS
, &
öfo
, 
cuºít
);

214 i‡(!
	`u£r_mode
(
ªgs
))

215 
no_c⁄ãxt
;

218 
do_sig£gv
:

219 
öfo
.
si_signo
 = 
SIGSEGV
;

220 
öfo
.
si_î∫o
 = 0;

221 
öfo
.
si_code
 = si_code;

222 
öfo
.
si_addr
 = (
__u£r
 *Ë
addªss
;

223 
	`f‹˚_sig_öfo
(
SIGSEGV
, &
öfo
, 
cuºít
);

226 #ifde‡
CONFIG_ALPHA_LARGE_VMALLOC


227 
vmÆloc_Áu…
:

228 i‡(
	`u£r_mode
(
ªgs
))

229 
do_sig£gv
;

233 
ödex
 = 
	`pgd_ödex
(
addªss
);

234 
pgd_t
 *
pgd
, *
pgd_k
;

236 
pgd
 = 
cuºít
->
a˘ive_mm
->pgd + 
ödex
;

237 
pgd_k
 = 
sw≠≥r_pg_dú
 + 
ödex
;

238 i‡(!
	`pgd_¥e£¡
(*
pgd
Ë&&Ögd_¥e£¡(*
pgd_k
)) {

239 
	`pgd_vÆ
(*
pgd
Ëpgd_vÆ(*
pgd_k
);

242 
no_c⁄ãxt
;

245 
	}
}

	@arch/alpha/mm/init.c

9 
	~<löux/∑gem≠.h
>

10 
	~<löux/sig«l.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/î∫o.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/mm™.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sw≠.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/boŸmem.h
>

22 
	~<löux/vmÆloc.h
>

24 
	~<asm/sy°em.h
>

25 
	~<asm/uac˚ss.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/pgÆloc.h
>

28 
	~<asm/hwΩb.h
>

29 
	~<asm/dma.h
>

30 
	~<asm/mmu_c⁄ãxt.h
>

31 
	~<asm/c⁄sﬁe.h
>

32 
	~<asm/éb.h
>

34 
DEFINE_PER_CPU
(
mmu_g©hî
, 
mmu_g©hîs
);

36 
dõ_if_kî√l
(*,
±_ªgs
 *,);

38 
pcb_°ru˘
 
	g‹igöÆ_pcb
;

40 
pgd_t
 *

41 
	$pgd_Æloc
(
mm_°ru˘
 *
mm
)

43 
pgd_t
 *
ªt
, *
öô
;

45 
ªt
 = (
pgd_t
 *)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
 | 
__GFP_ZERO
);

46 
öô
 = 
	`pgd_off£t
(&
öô_mm
, 0UL);

47 i‡(
ªt
) {

48 #ifde‡
CONFIG_ALPHA_LARGE_VMALLOC


49 
	`mem˝y
 (
ªt
 + 
USER_PTRS_PER_PGD
, 
öô
 + USER_PTRS_PER_PGD,

50 (
PTRS_PER_PGD
 - 
USER_PTRS_PER_PGD
 - 1)*(
pgd_t
));

52 
	`pgd_vÆ
(
ªt
[
PTRS_PER_PGD
-2]Ëpgd_vÆ(
öô
[PTRS_PER_PGD-2]);

56 
	`pgd_vÆ
(
ªt
[
PTRS_PER_PGD
-1])

57 
	`±e_vÆ
(
	`mk_±e
(
	`vút_to_∑ge
(
ªt
), 
PAGE_KERNEL
));

59  
ªt
;

60 
	}
}

62 
±e_t
 *

63 
	$±e_Æloc_⁄e_kî√l
(
mm_°ru˘
 *
mm
, 
addªss
)

65 
±e_t
 *
±e
 = (±e_à*)
	`__gë_‰ì_∑ge
(
GFP_KERNEL
|
__GFP_REPEAT
|
__GFP_ZERO
);

66  
±e
;

67 
	}
}

83 
pmd_t
 *

84 
	$__bad_∑gëabÀ
()

86 
	`mem£t
((*Ë
EMPTY_PGT
, 0, 
PAGE_SIZE
);

87  (
pmd_t
 *Ë
EMPTY_PGT
;

88 
	}
}

90 
±e_t


91 
	$__bad_∑ge
()

93 
	`mem£t
((*Ë
EMPTY_PGE
, 0, 
PAGE_SIZE
);

94  
	`±e_mkdúty
(
	`mk_±e
(
	`vút_to_∑ge
(
EMPTY_PGE
), 
PAGE_SHARED
));

95 
	}
}

97 #i‚de‡
CONFIG_DISCONTIGMEM


99 
	$show_mem
()

101 
i
,
‰ì
 = 0,
tŸÆ
 = 0,
ª£rved
 = 0;

102 
sh¨ed
 = 0, 
ˇched
 = 0;

104 
	`¥ötk
("\nMem-info:\n");

105 
	`show_‰ì_¨ós
();

106 
	`¥ötk
("Fªêsw≠: %6ldkB\n", 
ƒ_sw≠_∑ges
<<(
PAGE_SHIFT
-10));

107 
i
 = 
max_m≠ƒ
;

108 
i
-- > 0) {

109 
tŸÆ
++;

110 i‡(
	`PageRe£rved
(
mem_m≠
+
i
))

111 
ª£rved
++;

112 i‡(
	`PageSw≠Cache
(
mem_m≠
+
i
))

113 
ˇched
++;

114 i‡(!
	`∑ge_cou¡
(
mem_m≠
+
i
))

115 
‰ì
++;

117 
sh¨ed
 +
	`∑ge_cou¡
(
mem_m≠
 + 
i
) - 1;

119 
	`¥ötk
("%ldÖage†o‡RAM\n",
tŸÆ
);

120 
	`¥ötk
("%ld fªê∑ges\n",
‰ì
);

121 
	`¥ötk
("%ldÑe£rvedÖages\n",
ª£rved
);

122 
	`¥ötk
("%ldÖage†sh¨ed\n",
sh¨ed
);

123 
	`¥ötk
("%ldÖage†sw≠ cached\n",
ˇched
);

124 
	}
}

127 
ölöe
 

128 
	$lﬂd_PCB
(
pcb_°ru˘
 *
pcb
)

130 
•
 
	`__asm__
("$30");

131 
pcb
->
k•
 = 
•
;

132  
	`__ªlﬂd_thªad
(
pcb
);

133 
	}
}

137 
ölöe
 

138 
	$swôch_to_sy°em_m≠
()

140 
√w±br
;

141 
‹igöÆ_pcb_±r
;

145 
	`mem£t
(
sw≠≥r_pg_dú
, 0, 
PAGE_SIZE
);

146 
√w±br
 = ((Ë
sw≠≥r_pg_dú
 - 
PAGE_OFFSET
Ë>> 
PAGE_SHIFT
;

147 
	`pgd_vÆ
(
sw≠≥r_pg_dú
[1023]) =

148 (
√w±br
 << 32Ë| 
	`pg¥Ÿ_vÆ
(
PAGE_KERNEL
);

152 i‡(
hwΩb
->
v±b
 != 0xfffffffe00000000UL) {

153 
	`wrv±±r
(0xfffffffe00000000UL);

154 
hwΩb
->
v±b
 = 0xfffffffe00000000UL;

155 
	`hwΩb_upd©e_checksum
(
hwΩb
);

159 
öô_thªad_öfo
.
pcb
.
±br
 = 
√w±br
;

160 
öô_thªad_öfo
.
pcb
.
Êags
 = 1;

161 
‹igöÆ_pcb_±r
 = 
	`lﬂd_PCB
(&
öô_thªad_öfo
.
pcb
);

162 
	`tbü
();

171 i‡(
‹igöÆ_pcb_±r
 < 
PAGE_OFFSET
) {

172 
‹igöÆ_pcb_±r
 = ()

173 
	`phys_to_vút
(
‹igöÆ_pcb_±r
);

175 
‹igöÆ_pcb
 = *(
pcb_°ru˘
 *Ë
‹igöÆ_pcb_±r
;

176 
	}
}

178 
	gˇŒback_öô_d⁄e
;

180 * 
__öô


181 
	$ˇŒback_öô
(* 
kî√l_íd
)

183 
¸b_°ru˘
 * 
¸b
;

184 
pgd_t
 *
pgd
;

185 
pmd_t
 *
pmd
;

186 *
two_∑ges
;

189 
¸b
 = (
¸b_°ru˘
 *)((*)
hwΩb
 + hwΩb->
¸b_off£t
);

191 i‡(
Æpha_usög_§m
) {

193 i‡(
	`§m_fixup
(
VMALLOC_START
, ()
hwΩb
))

194 
	`__hÆt
();

197 
¸b
->
di•©ch_va
 = (
¥ocdesc_°ru˘
 *)

198 (
VMALLOC_START
 + ()
¸b
->
di•©ch_va


199 - 
¸b
->
m≠
[0].
va
);

200 
¸b
->
fixup_va
 = (
¥ocdesc_°ru˘
 *)

201 (
VMALLOC_START
 + ()
¸b
->
fixup_va


202 - 
¸b
->
m≠
[0].
va
);

205 
	`swôch_to_sy°em_m≠
();

217 
two_∑ges
 = (*)

218 ((()
kî√l_íd
 + ~
PAGE_MASK
) & PAGE_MASK);

219 
kî√l_íd
 = 
two_∑ges
 + 2*
PAGE_SIZE
;

220 
	`mem£t
(
two_∑ges
, 0, 2*
PAGE_SIZE
);

222 
pgd
 = 
	`pgd_off£t_k
(
VMALLOC_START
);

223 
	`pgd_£t
(
pgd
, (
pmd_t
 *)
two_∑ges
);

224 
pmd
 = 
	`pmd_off£t
(
pgd
, 
VMALLOC_START
);

225 
	`pmd_£t
(
pmd
, (
±e_t
 *)(
two_∑ges
 + 
PAGE_SIZE
));

227 i‡(
Æpha_usög_§m
) {

228 
vm_°ru˘
 
c⁄sﬁe_ªm≠_vm
;

229 
vaddr
 = 
VMALLOC_START
;

230 
i
, 
j
;

234 
i
 = 0; i < 
¸b
->
m≠_íåõs
; ++i) {

235 
p‚
 = 
¸b
->
m≠
[
i
].
∑
 >> 
PAGE_SHIFT
;

236 
¸b
->
m≠
[
i
].
va
 = 
vaddr
;

237 
j
 = 0; j < 
¸b
->
m≠
[
i
].
cou¡
; ++j) {

241 i‡(
pmd
 !
	`pmd_off£t
(
pgd
, 
vaddr
)) {

242 
	`mem£t
(
kî√l_íd
, 0, 
PAGE_SIZE
);

243 
pmd
 = 
	`pmd_off£t
(
pgd
, 
vaddr
);

244 
	`pmd_£t
(
pmd
, (
±e_t
 *)
kî√l_íd
);

245 
kî√l_íd
 +
PAGE_SIZE
;

247 
	`£t_±e
(
	`±e_off£t_kî√l
(
pmd
, 
vaddr
),

248 
	`p‚_±e
(
p‚
, 
PAGE_KERNEL
));

249 
p‚
++;

250 
vaddr
 +
PAGE_SIZE
;

255 
c⁄sﬁe_ªm≠_vm
.
Êags
 = 
VM_ALLOC
;

256 
c⁄sﬁe_ªm≠_vm
.
addr
 = (*Ë
VMALLOC_START
;

257 
c⁄sﬁe_ªm≠_vm
.
size
 = 
vaddr
 - 
VMALLOC_START
;

258 
vmli°
 = &
c⁄sﬁe_ªm≠_vm
;

261 
ˇŒback_öô_d⁄e
 = 1;

262  
kî√l_íd
;

263 
	}
}

266 #i‚de‡
CONFIG_DISCONTIGMEM


271 
	$∑gög_öô
()

273 
z⁄es_size
[
MAX_NR_ZONES
] = {0, };

274 
dma_p‚
, 
high_p‚
;

276 
dma_p‚
 = 
	`vút_to_phys
((*)
MAX_DMA_ADDRESS
Ë>> 
PAGE_SHIFT
;

277 
high_p‚
 = 
max_p‚
 = 
max_low_p‚
;

279 i‡(
dma_p‚
 >
high_p‚
)

280 
z⁄es_size
[
ZONE_DMA
] = 
high_p‚
;

282 
z⁄es_size
[
ZONE_DMA
] = 
dma_p‚
;

283 
z⁄es_size
[
ZONE_NORMAL
] = 
high_p‚
 - 
dma_p‚
;

287 
	`‰ì_¨ó_öô
(
z⁄es_size
);

290 
	`mem£t
((*)
ZERO_PGE
, 0, 
PAGE_SIZE
);

291 
	}
}

294 #i‡
deföed
(
CONFIG_ALPHA_GENERIC
Ë|| deföed(
CONFIG_ALPHA_SRM
)

296 
	$§m_∑gög_°›
 ()

299 
sw≠≥r_pg_dú
[1] = swapper_pg_dir[1023];

300 
	`tbü
();

301 
	`wrv±±r
(0x200000000UL);

302 
hwΩb
->
v±b
 = 0x200000000UL;

303 
	`hwΩb_upd©e_checksum
(
hwΩb
);

306 
	`lﬂd_PCB
(&
‹igöÆ_pcb
);

307 
	`tbü
();

308 
	}
}

311 #i‚de‡
CONFIG_DISCONTIGMEM


312 
__öô


313 
	$¥ötk_mem‹y_öfo
()

315 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
, 
tmp
;

316 
	`∑ge_is_øm
(Ë
__öô
;

317 
_ãxt
, 
_ëext
, 
_d©a
, 
_ed©a
;

318 
__öô_begö
, 
__öô_íd
;

321 
ª£rved∑ges
 = 0;

322 
tmp
 = 0;Åm∞< 
max_low_p‚
;Åmp++)

326 i‡(
	`∑ge_is_øm
(
tmp
Ë&& 
	`PageRe£rved
(
mem_m≠
+tmp))

327 
ª£rved∑ges
++;

329 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

330 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_d©a
;

331 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

333 
	`¥ötk
("Memory: %luk/%lukávailable (%luk kernel code, %lukÑeserved, %luk data, %luk init)\n",

334 (Ë
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

335 
max_m≠ƒ
 << (
PAGE_SHIFT
-10),

336 
codesize
 >> 10,

337 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

338 
d©asize
 >> 10,

339 
öôsize
 >> 10);

340 
	}
}

342 
__öô


343 
	$mem_öô
()

345 
max_m≠ƒ
 = 
num_phy•ages
 = 
max_low_p‚
;

346 
tŸÆøm_∑ges
 +
	`‰ì_Æl_boŸmem
();

347 
high_mem‹y
 = (*Ë
	`__va
(
max_low_p‚
 * 
PAGE_SIZE
);

349 
	`¥ötk_mem‹y_öfo
();

350 
	}
}

354 
	$‰ì_ª£rved_mem
(*
°¨t
, *
íd
)

356 *
__°¨t
 = 
°¨t
;

357 ; 
__°¨t
 < 
íd
; __°¨à+
PAGE_SIZE
) {

358 
	`CÀ¨PageRe£rved
(
	`vút_to_∑ge
(
__°¨t
));

359 
	`öô_∑ge_cou¡
(
	`vút_to_∑ge
(
__°¨t
));

360 
	`‰ì_∑ge
(()
__°¨t
);

361 
tŸÆøm_∑ges
++;

363 
	}
}

366 
	$‰ì_öômem
()

368 
__öô_begö
, 
__öô_íd
;

370 
	`‰ì_ª£rved_mem
(&
__öô_begö
, &
__öô_íd
);

371 
	`¥ötk
 ("Freeing unused kernel memory: %ldk freed\n",

372 (&
__öô_íd
 - &
__öô_begö
) >> 10);

373 
	}
}

375 #ifde‡
CONFIG_BLK_DEV_INITRD


377 
	$‰ì_öôrd_mem
(
°¨t
, 
íd
)

379 
	`‰ì_ª£rved_mem
((*)
°¨t
, (*)
íd
);

380 
	`¥ötk
 ("Fªeög inôrd mem‹y: %ldk fªed\n", (
íd
 - 
°¨t
) >> 10);

381 
	}
}

	@arch/alpha/mm/numa.c

9 
	~<löux/ty≥s.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/mm.h
>

12 
	~<löux/boŸmem.h
>

13 
	~<löux/sw≠.h
>

14 
	~<löux/öôrd.h
>

15 
	~<löux/p‚.h
>

16 
	~<löux/moduÀ.h
>

18 
	~<asm/hwΩb.h
>

19 
	~<asm/pgÆloc.h
>

21 
pg_d©a_t
 
	gnode_d©a
[
MAX_NUMNODES
];

22 
boŸmem_d©a_t
 
	gnode_bd©a
[
MAX_NUMNODES
];

23 
EXPORT_SYMBOL
(
node_d©a
);

25 #unde‡
DEBUG_DISCONTIG


26 #ifde‡
DEBUG_DISCONTIG


27 
	#DBGDCONT
(
¨gs
...Ë
	`¥ötk
◊rgs)

	)

29 
	#DBGDCONT
(
¨gs
...)

	)

32 
	#f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) \

33 (
˛u°î
Ë(
memdesc
)->˛u°î, (
i
) = 0; \

34 (
i
Ë< (
memdesc
)->
num˛u°îs
; (i)++, (
˛u°î
)++)

	)

36 
__öô
 
	$show_mem_œyout
()

38 
mem˛u°_°ru˘
 * 
˛u°î
;

39 
memdesc_°ru˘
 * 
memdesc
;

40 
i
;

43 
memdesc
 = (
memdesc_°ru˘
 *)

44 (
hwΩb
->
mddt_off£t
 + () hwrpb);

46 
	`¥ötk
("Raw memoryÜayout:\n");

47 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

48 
	`¥ötk
(" memcluster %2d, usage %1lx, start %8lu,Énd %8lu\n",

49 
i
, 
˛u°î
->
ußge
, clu°î->
°¨t_p‚
,

50 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
);

52 
	}
}

54 
__öô


55 
	$£tup_mem‹y_node
(
nid
, *
kî√l_íd
)

57 
mem_size_limô
;

58 
mem˛u°_°ru˘
 * 
˛u°î
;

59 
memdesc_°ru˘
 * 
memdesc
;

60 
°¨t_kî√l_p‚
, 
íd_kî√l_p‚
;

61 
boŸm≠_size
, 
boŸm≠_∑ges
, 
boŸm≠_°¨t
;

62 
°¨t
, 
íd
;

63 
node_p‚_°¨t
, 
node_p‚_íd
;

64 
node_mö_p‚
, 
node_max_p‚
;

65 
i
;

66 
node_d©asz
 = 
	`PFN_UP
((
pg_d©a_t
));

67 
show_öô
 = 0;

70 
node_p‚_°¨t
 = (
	`node_mem_°¨t
(
nid
)Ë>> 
PAGE_SHIFT
;

71 
node_p‚_íd
 = 
node_p‚_°¨t
 + (
	`node_mem_size
(
nid
Ë>> 
PAGE_SHIFT
);

74 
memdesc
 = (
memdesc_°ru˘
 *)

75 (
hwΩb
->
mddt_off£t
 + () hwrpb);

78 
node_mö_p‚
 = ~0UL;

79 
node_max_p‚
 = 0UL;

80 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

84 i‡(
˛u°î
->
ußge
 & 3)

87 
°¨t
 = 
˛u°î
->
°¨t_p‚
;

88 
íd
 = 
°¨t
 + 
˛u°î
->
num∑ges
;

90 i‡(
°¨t
 >
node_p‚_íd
 || 
íd
 <
node_p‚_°¨t
)

93 i‡(!
show_öô
) {

94 
show_öô
 = 1;

95 
	`¥ötk
("Inôülizög boŸmemáŒoˇt‹ o¿NodêID %d\n", 
nid
);

97 
	`¥ötk
(" memcluster %2d, usage %1lx, start %8lu,Énd %8lu\n",

98 
i
, 
˛u°î
->
ußge
, clu°î->
°¨t_p‚
,

99 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
);

101 i‡(
°¨t
 < 
node_p‚_°¨t
)

102 
°¨t
 = 
node_p‚_°¨t
;

103 i‡(
íd
 > 
node_p‚_íd
)

104 
íd
 = 
node_p‚_íd
;

106 i‡(
°¨t
 < 
node_mö_p‚
)

107 
node_mö_p‚
 = 
°¨t
;

108 i‡(
íd
 > 
node_max_p‚
)

109 
node_max_p‚
 = 
íd
;

112 i‡(
mem_size_limô
 && 
node_max_p‚
 > mem_size_limit) {

113 
msg_shown
 = 0;

114 i‡(!
msg_shown
) {

115 
msg_shown
 = 1;

116 
	`¥ötk
("setup: forcing memory sizeÅo %ldK (from %ldK).\n",

117 
mem_size_limô
 << (
PAGE_SHIFT
 - 10),

118 
node_max_p‚
 << (
PAGE_SHIFT
 - 10));

120 
node_max_p‚
 = 
mem_size_limô
;

123 i‡(
node_mö_p‚
 >
node_max_p‚
)

127 i‡(
node_mö_p‚
 < 
mö_low_p‚
)

128 
mö_low_p‚
 = 
node_mö_p‚
;

129 i‡(
node_max_p‚
 > 
max_low_p‚
)

130 
max_p‚
 = 
max_low_p‚
 = 
node_max_p‚
;

132 
num_phy•ages
 +
node_max_p‚
 - 
node_mö_p‚
;

136 
node_d©a
[
nid
] = (
pg_d©a_t
 *)(
	`__va
(
node_mö_p‚
 << 
PAGE_SHIFT
));

139 
node_mö_p‚
 +
node_d©asz
;

140 i‡(
node_mö_p‚
 >
node_max_p‚
) {

141 
	`¥ötk
("ÇotÉnough memÅoÑeserve NODE_DATA");

144 
	`NODE_DATA
(
nid
)->
bd©a
 = &
node_bd©a
[nid];

146 
	`¥ötk
(" DetectedÇode memory: start %8lu,Énd %8lu\n",

147 
node_mö_p‚
, 
node_max_p‚
);

149 
	`DBGDCONT
(" DISCONTIG:Çode_d©a[%d] i†© 0x%p\n", 
nid
, 
	`NODE_DATA
(nid));

150 
	`DBGDCONT
(" DISCONTIG: NODE_DATA(%d)->bd©®i†© 0x%p\n", 
nid
, 
	`NODE_DATA
“id)->
bd©a
);

153 
°¨t_kî√l_p‚
 = 
	`PFN_DOWN
(
KERNEL_START_PHYS
);

154 
íd_kî√l_p‚
 = 
	`PFN_UP
(
	`vút_to_phys
(
kî√l_íd
));

155 
boŸm≠_°¨t
 = -1;

157 i‡(!
nid
 && (
node_max_p‚
 < 
íd_kî√l_p‚
 || 
node_mö_p‚
 > 
°¨t_kî√l_p‚
))

158 
	`∑nic
("kernelÜoaded out ofÑam");

163 
node_mö_p‚
 &~((1UL << (
MAX_ORDER
-1))-1);

167 
boŸm≠_∑ges
 = 
	`boŸmem_boŸm≠_∑ges
(
node_max_p‚
-
node_mö_p‚
);

170 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

171 i‡(
˛u°î
->
ußge
 & 3)

174 
°¨t
 = 
˛u°î
->
°¨t_p‚
;

175 
íd
 = 
°¨t
 + 
˛u°î
->
num∑ges
;

177 i‡(
°¨t
 >
node_max_p‚
 || 
íd
 <
node_mö_p‚
)

180 i‡(
íd
 > 
node_max_p‚
)

181 
íd
 = 
node_max_p‚
;

182 i‡(
°¨t
 < 
node_mö_p‚
)

183 
°¨t
 = 
node_mö_p‚
;

185 i‡(
°¨t
 < 
°¨t_kî√l_p‚
) {

186 i‡(
íd
 > 
íd_kî√l_p‚


187 && 
íd
 - 
íd_kî√l_p‚
 >
boŸm≠_∑ges
) {

188 
boŸm≠_°¨t
 = 
íd_kî√l_p‚
;

190 } i‡(
íd
 > 
°¨t_kî√l_p‚
)

191 
íd
 = 
°¨t_kî√l_p‚
;

192 } i‡(
°¨t
 < 
íd_kî√l_p‚
)

193 
°¨t
 = 
íd_kî√l_p‚
;

194 i‡(
íd
 - 
°¨t
 >
boŸm≠_∑ges
) {

195 
boŸm≠_°¨t
 = 
°¨t
;

200 i‡(
boŸm≠_°¨t
 == -1)

201 
	`∑nic
("couldn't findá contigousÖlace forÅhe bootmap");

204 
boŸm≠_size
 = 
	`öô_boŸmem_node
(
	`NODE_DATA
(
nid
), 
boŸm≠_°¨t
,

205 
node_mö_p‚
, 
node_max_p‚
);

206 
	`DBGDCONT
(" bootmap_start %lu, bootmap_size %lu, bootmap_pages %lu\n",

207 
boŸm≠_°¨t
, 
boŸm≠_size
, 
boŸm≠_∑ges
);

210 
	`f‹_óch_mem_˛u°î
(
memdesc
, 
˛u°î
, 
i
) {

211 i‡(
˛u°î
->
ußge
 & 3)

214 
°¨t
 = 
˛u°î
->
°¨t_p‚
;

215 
íd
 = 
˛u°î
->
°¨t_p‚
 + clu°î->
num∑ges
;

217 i‡(
°¨t
 >
node_max_p‚
 || 
íd
 <
node_mö_p‚
)

220 i‡(
íd
 > 
node_max_p‚
)

221 
íd
 = 
node_max_p‚
;

222 i‡(
°¨t
 < 
node_mö_p‚
)

223 
°¨t
 = 
node_mö_p‚
;

225 i‡(
°¨t
 < 
°¨t_kî√l_p‚
) {

226 i‡(
íd
 > 
íd_kî√l_p‚
) {

227 
	`‰ì_boŸmem_node
(
	`NODE_DATA
(
nid
), 
	`PFN_PHYS
(
°¨t
),

228 (
	`PFN_PHYS
(
°¨t_kî√l_p‚
)

229 - 
	`PFN_PHYS
(
°¨t
)));

230 
	`¥ötk
(" freeingÖages %ld:%ld\n",

231 
°¨t
, 
°¨t_kî√l_p‚
);

232 
°¨t
 = 
íd_kî√l_p‚
;

233 } i‡(
íd
 > 
°¨t_kî√l_p‚
)

234 
íd
 = 
°¨t_kî√l_p‚
;

235 } i‡(
°¨t
 < 
íd_kî√l_p‚
)

236 
°¨t
 = 
íd_kî√l_p‚
;

237 i‡(
°¨t
 >
íd
)

240 
	`‰ì_boŸmem_node
(
	`NODE_DATA
(
nid
), 
	`PFN_PHYS
(
°¨t
), PFN_PHYS(
íd
) - PFN_PHYS(start));

241 
	`¥ötk
(" fªeögÖage†%ld:%ld\n", 
°¨t
, 
íd
);

245 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
), 
	`PFN_PHYS
(
boŸm≠_°¨t
), 
boŸm≠_size
);

246 
	`¥ötk
("Ñe£rvögÖage†%ld:%ld\n", 
boŸm≠_°¨t
, boŸm≠_°¨t+
	`PFN_UP
(
boŸm≠_size
));

248 
	`node_£t_⁄löe
(
nid
);

249 
	}
}

251 
__öô


252 
	$£tup_mem‹y
(*
kî√l_íd
)

254 
nid
;

256 
	`show_mem_œyout
();

258 
	`nodes_˛ór
(
node_⁄löe_m≠
);

260 
mö_low_p‚
 = ~0UL;

261 
max_low_p‚
 = 0UL;

262 
nid
 = 0;Çid < 
MAX_NUMNODES
;Çid++)

263 
	`£tup_mem‹y_node
(
nid
, 
kî√l_íd
);

265 #ifde‡
CONFIG_BLK_DEV_INITRD


266 
öôrd_°¨t
 = 
INITRD_START
;

267 i‡(
öôrd_°¨t
) {

268 *
	`move_öôrd
();

270 
öôrd_íd
 = 
öôrd_°¨t
+
INITRD_SIZE
;

271 
	`¥ötk
("InitialÑamdiskát: 0x%p (%lu bytes)\n",

272 (*Ë
öôrd_°¨t
, 
INITRD_SIZE
);

274 i‡((*)
öôrd_íd
 > 
	`phys_to_vút
(
	`PFN_PHYS
(
max_low_p‚
))) {

275 i‡(!
	`move_öôrd
(
	`PFN_PHYS
(
max_low_p‚
)))

276 
	`¥ötk
("initrdÉxtends beyondÉnd of memory "

278 
öôrd_íd
,

279 
	`phys_to_vút
(
	`PFN_PHYS
(
max_low_p‚
)));

281 
nid
 = 
	`kvaddr_to_nid
(
öôrd_°¨t
);

282 
	`ª£rve_boŸmem_node
(
	`NODE_DATA
(
nid
),

283 
	`vút_to_phys
((*)
öôrd_°¨t
),

284 
INITRD_SIZE
);

288 
	}
}

290 
__öô
 
	$∑gög_öô
()

292 
nid
;

293 
z⁄es_size
[
MAX_NR_ZONES
] = {0, };

294 
dma_loˇl_p‚
;

303 
dma_loˇl_p‚
 = 
	`vút_to_phys
((*)
MAX_DMA_ADDRESS
Ë>> 
PAGE_SHIFT
;

305 
	`f‹_óch_⁄löe_node
(
nid
) {

306 
°¨t_p‚
 = 
node_bd©a
[
nid
].
node_boŸ_°¨t
 >> 
PAGE_SHIFT
;

307 
íd_p‚
 = 
node_bd©a
[
nid
].
node_low_p‚
;

309 i‡(
dma_loˇl_p‚
 >
íd_p‚
 - 
°¨t_p‚
)

310 
z⁄es_size
[
ZONE_DMA
] = 
íd_p‚
 - 
°¨t_p‚
;

312 
z⁄es_size
[
ZONE_DMA
] = 
dma_loˇl_p‚
;

313 
z⁄es_size
[
ZONE_NORMAL
] = (
íd_p‚
 - 
°¨t_p‚
Ë- 
dma_loˇl_p‚
;

315 
	`‰ì_¨ó_öô_node
(
nid
, 
	`NODE_DATA
“id), 
z⁄es_size
, 
°¨t_p‚
, 
NULL
);

319 
	`mem£t
((*)
ZERO_PGE
, 0, 
PAGE_SIZE
);

320 
	}
}

322 
__öô
 
	$mem_öô
()

324 
codesize
, 
ª£rved∑ges
, 
d©asize
, 
öôsize
, 
p‚
;

325 
	`∑ge_is_øm
(Ë
__öô
;

326 
_ãxt
, 
_ëext
, 
_d©a
, 
_ed©a
;

327 
__öô_begö
, 
__öô_íd
;

328 
nid
, 
i
;

329 
high_mem‹y
 = (*Ë
	`__va
(
max_low_p‚
 << 
PAGE_SHIFT
);

331 
ª£rved∑ges
 = 0;

332 
	`f‹_óch_⁄löe_node
(
nid
) {

336 
tŸÆøm_∑ges
 +
	`‰ì_Æl_boŸmem_node
(
	`NODE_DATA
(
nid
));

338 
p‚
 = 
	`NODE_DATA
(
nid
)->
node_°¨t_p‚
;

339 
i
 = 0; i < 
	`node_•™√d_∑ges
(
nid
); i++, 
p‚
++)

340 i‡(
	`∑ge_is_øm
(
p‚
) &&

341 
	`PageRe£rved
(
	`nid_∑ge_ƒ
(
nid
, 
i
)))

342 
ª£rved∑ges
++;

345 
codesize
 = (Ë&
_ëext
 - (Ë&
_ãxt
;

346 
d©asize
 = (Ë&
_ed©a
 - (Ë&
_d©a
;

347 
öôsize
 = (Ë&
__öô_íd
 - (Ë&
__öô_begö
;

349 
	`¥ötk
("Memory: %luk/%lukávailable (%luk kernel code, %lukÑeserved, "

351 ()
	`ƒ_‰ì_∑ges
(Ë<< (
PAGE_SHIFT
-10),

352 
num_phy•ages
 << (
PAGE_SHIFT
-10),

353 
codesize
 >> 10,

354 
ª£rved∑ges
 << (
PAGE_SHIFT
-10),

355 
d©asize
 >> 10,

356 
öôsize
 >> 10);

358 
	`mem_°ªss
();

360 
	}
}

363 
	$show_mem
()

365 
i
,
‰ì
 = 0,
tŸÆ
 = 0,
ª£rved
 = 0;

366 
sh¨ed
 = 0, 
ˇched
 = 0;

367 
nid
;

369 
	`¥ötk
("\nMem-info:\n");

370 
	`show_‰ì_¨ós
();

371 
	`¥ötk
("Fªêsw≠: %6ldkB\n", 
ƒ_sw≠_∑ges
<<(
PAGE_SHIFT
-10));

372 
	`f‹_óch_⁄löe_node
(
nid
) {

373 
Êags
;

374 
	`pgd©_ªsize_lock
(
	`NODE_DATA
(
nid
), &
Êags
);

375 
i
 = 
	`node_•™√d_∑ges
(
nid
);

376 
i
-- > 0) {

377 
∑ge
 *∑gê
	`nid_∑ge_ƒ
(
nid
, 
i
);

378 
tŸÆ
++;

379 i‡(
	`PageRe£rved
(
∑ge
))

380 
ª£rved
++;

381 i‡(
	`PageSw≠Cache
(
∑ge
))

382 
ˇched
++;

383 i‡(!
	`∑ge_cou¡
(
∑ge
))

384 
‰ì
++;

386 
sh¨ed
 +
	`∑ge_cou¡
(
∑ge
) - 1;

388 
	`pgd©_ªsize_u∆ock
(
	`NODE_DATA
(
nid
), &
Êags
);

390 
	`¥ötk
("%ldÖage†o‡RAM\n",
tŸÆ
);

391 
	`¥ötk
("%ld fªê∑ges\n",
‰ì
);

392 
	`¥ötk
("%ldÑe£rvedÖages\n",
ª£rved
);

393 
	`¥ötk
("%ldÖage†sh¨ed\n",
sh¨ed
);

394 
	`¥ötk
("%ldÖage†sw≠ cached\n",
ˇched
);

395 
	}
}

	@arch/alpha/oprofile/common.c

10 
	~<löux/›rofûe.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/smp.h
>

13 
	~<löux/î∫o.h
>

14 
	~<asm/±ø˚.h
>

15 
	~<asm/sy°em.h
>

17 
	~"›_im∂.h
"

19 
›_axp_modñ
 
›_modñ_ev4
 
__©åibuã__
((
wók
));

20 
›_axp_modñ
 
›_modñ_ev5
 
__©åibuã__
((
wók
));

21 
›_axp_modñ
 
›_modñ_pˇ56
 
__©åibuã__
((
wók
));

22 
›_axp_modñ
 
›_modñ_ev6
 
__©åibuã__
((
wók
));

23 
›_axp_modñ
 
›_modñ_ev67
 
__©åibuã__
((
wók
));

25 
›_axp_modñ
 *
	gmodñ
;

27 (*
≥rf_úq
)(, 
±_ªgs
 *);

28 (*
ßve_≥rf_úq
)(, 
±_ªgs
 *);

30 
›_cou¡î_c⁄fig
 
˘r
[20];

31 
›_sy°em_c⁄fig
 
sys
;

32 
›_ªgi°î_c⁄fig
 
ªg
;

37 
	$›_h™dÀ_öãºu±
(
which
, 
±_ªgs
 *
ªgs
)

39 
modñ
->
	`h™dÀ_öãºu±
(
which
, 
ªgs
, 
˘r
);

45 i‡((
ªg
.
√ed_ª£t
 >> 
which
) & 1)

46 
modñ
->
	`ª£t_˘r
(&
ªg
, 
which
);

47 
	}
}

50 
	$›_axp_£tup
()

52 
i
, 
e
;

55 
ßve_≥rf_úq
 = 
≥rf_úq
;

56 
≥rf_úq
 = 
›_h™dÀ_öãºu±
;

59 
i
 = 
e
 = 0; i < 
modñ
->
num_cou¡îs
; ++i)

60 i‡(
˘r
[
i
].
íabÀd
)

61 
e
 |1 << 
i
;

62 
ªg
.
íabÀ
 = 
e
;

65 
modñ
->
	`ªg_£tup
(&
ªg
, 
˘r
, &
sys
);

68 ()
	`smp_ˇŒ_fun˘i⁄
(
modñ
->
˝u_£tup
, &
ªg
, 0, 1);

69 
modñ
->
	`˝u_£tup
(&
ªg
);

71 
	}
}

74 
	$›_axp_shutdown
()

77 
≥rf_úq
 = 
ßve_≥rf_úq
;

78 
	}
}

81 
	$›_axp_˝u_°¨t
(*
dummy
)

83 
	`wΩîfm⁄
(1, 
ªg
.
íabÀ
);

84 
	}
}

87 
	$›_axp_°¨t
()

89 ()
	`smp_ˇŒ_fun˘i⁄
(
›_axp_˝u_°¨t
, 
NULL
, 0, 1);

90 
	`›_axp_˝u_°¨t
(
NULL
);

92 
	}
}

94 
ölöe
 

95 
	$›_axp_˝u_°›
(*
dummy
)

98 
	`wΩîfm⁄
(0, -1);

99 
	}
}

102 
	$›_axp_°›
()

104 ()
	`smp_ˇŒ_fun˘i⁄
(
›_axp_˝u_°›
, 
NULL
, 0, 1);

105 
	`›_axp_˝u_°›
(
NULL
);

106 
	}
}

109 
	$›_axp_¸óã_fûes
(
su≥r_block
 * 
sb
, 
díåy
 * 
roŸ
)

111 
i
;

113 
i
 = 0; i < 
modñ
->
num_cou¡îs
; ++i) {

114 
díåy
 *
dú
;

115 
buf
[4];

117 
	`¢¥ötf
(
buf
,  buf, "%d", 
i
);

118 
dú
 = 
	`›rofûefs_mkdú
(
sb
, 
roŸ
, 
buf
);

120 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "íabÀd", &
˘r
[
i
].
íabÀd
);

121 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "evít", &
˘r
[
i
].
evít
);

122 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "cou¡", &
˘r
[
i
].
cou¡
);

124 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "kî√l", &
˘r
[
i
].
kî√l
);

125 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "u£r", &
˘r
[
i
].
u£r
);

126 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
dú
, "unô_mask", &
˘r
[
i
].
unô_mask
);

129 i‡(
modñ
->
ˇn_£t_¥oc_mode
) {

130 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
roŸ
, "enable_pal",

131 &
sys
.
íabÀ_∑l
);

132 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
roŸ
, "enable_kernel",

133 &
sys
.
íabÀ_kî√l
);

134 
	`›rofûefs_¸óã_ul⁄g
(
sb
, 
roŸ
, "enable_user",

135 &
sys
.
íabÀ_u£r
);

139 
	}
}

141 
__öô


142 
	$›rofûe_¨ch_öô
(
›rofûe_›î©i⁄s
 *
›s
)

144 
›_axp_modñ
 *
lmodñ
 = 
NULL
;

146 
	`im∂vî
()) {

147 
IMPLVER_EV4
:

148 
lmodñ
 = &
›_modñ_ev4
;

150 
IMPLVER_EV5
:

153 i‡(!
	`amask
(
AMASK_MAX
))

154 
lmodñ
 = &
›_modñ_pˇ56
;

156 
lmodñ
 = &
›_modñ_ev5
;

158 
IMPLVER_EV6
:

161 i‡(!
	`amask
(
AMASK_CIX
))

162 
lmodñ
 = &
›_modñ_ev67
;

164 
lmodñ
 = &
›_modñ_ev6
;

168 i‡(!
lmodñ
)

169  -
ENODEV
;

170 
modñ
 = 
lmodñ
;

172 
›s
->
¸óã_fûes
 = 
›_axp_¸óã_fûes
;

173 
›s
->
£tup
 = 
›_axp_£tup
;

174 
›s
->
shutdown
 = 
›_axp_shutdown
;

175 
›s
->
°¨t
 = 
›_axp_°¨t
;

176 
›s
->
°›
 = 
›_axp_°›
;

177 
›s
->
˝u_ty≥
 = 
lmodñ
->cpu_type;

179 
	`¥ötk
(
KERN_INFO
 "oprofile: using %sÖerformance monitoring.\n",

180 
lmodñ
->
˝u_ty≥
);

183 
	}
}

187 
	$›rofûe_¨ch_exô
()

189 
	}
}

	@arch/alpha/oprofile/op_impl.h

10 #i‚de‡
OP_IMPL_H


11 
	#OP_IMPL_H
 1

	)

14 
	s›_cou¡î_c⁄fig
 {

15 
	míabÀd
;

16 
	mevít
;

17 
	mcou¡
;

19 
	mkî√l
;

20 
	mu£r
;

21 
	munô_mask
;

25 
	s›_sy°em_c⁄fig
 {

26 
	míabÀ_∑l
;

27 
	míabÀ_kî√l
;

28 
	míabÀ_u£r
;

32 
	s›_ªgi°î_c⁄fig
 {

33 
	míabÀ
;

34 
	mmux_£À˘
;

35 
	m¥oc_mode
;

36 
	m‰eq
;

37 
	mª£t_vÆues
;

38 
	m√ed_ª£t
;

42 
	s›_axp_modñ
 {

43 (*
	mªg_£tup
Ë(
	m›_ªgi°î_c⁄fig
 *,

44 
	m›_cou¡î_c⁄fig
 *,

45 
	m›_sy°em_c⁄fig
 *);

46 (*
	m˝u_£tup
) (*);

47 (*
	mª£t_˘r
Ë(
	m›_ªgi°î_c⁄fig
 *, );

48 (*
	mh™dÀ_öãºu±
Ë(, 
	m±_ªgs
 *,

49 
	m›_cou¡î_c⁄fig
 *);

50 *
	m˝u_ty≥
;

51 
	mnum_cou¡îs
;

52 
	mˇn_£t_¥oc_mode
;

	@arch/alpha/oprofile/op_model_ev4.c

10 
	~<löux/›rofûe.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/smp.h
>

13 
	~<asm/±ø˚.h
>

14 
	~<asm/sy°em.h
>

16 
	~"›_im∂.h
"

22 
	$ev4_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

23 
›_cou¡î_c⁄fig
 *
˘r
,

24 
›_sy°em_c⁄fig
 *
sys
)

26 
˘l
 = 0, 
cou¡
, 
hûo
;

41 
˘l
 |(
˘r
[0].
íabÀd
 ? cå[0].
evít
 << 8 : 14 << 8);

42 
˘l
 |(
˘r
[1].
íabÀd
 ? (˘r[1].
evít
 - 16) << 32 : 7ul << 32);

50 
cou¡
 = 
˘r
[0].count;

51 i‡(
cou¡
 <= 4096)

52 
cou¡
 = 4096, 
hûo
 = 1;

54 
cou¡
 = 65536, 
hûo
 = 0;

55 
˘r
[0].
cou¡
 = count;

56 
˘l
 |(
˘r
[0].
íabÀd
 && 
hûo
) << 3;

58 
cou¡
 = 
˘r
[1].count;

59 i‡(
cou¡
 <= 256)

60 
cou¡
 = 256, 
hûo
 = 1;

62 
cou¡
 = 4096, 
hûo
 = 0;

63 
˘r
[1].
cou¡
 = count;

64 
˘l
 |(
˘r
[1].
íabÀd
 && 
hûo
);

66 
ªg
->
mux_£À˘
 = 
˘l
;

72 
ªg
->
¥oc_mode
 = 0;

75 
ªg
->
‰eq
 = 0;

78 
ªg
->
ª£t_vÆues
 = 0;

79 
ªg
->
√ed_ª£t
 = 0;

81 
	}
}

86 
	$ev4_˝u_£tup
(*
x
)

88 
›_ªgi°î_c⁄fig
 *
ªg
 = 
x
;

90 
	`wΩîfm⁄
(2, 
ªg
->
mux_£À˘
);

91 
	`wΩîfm⁄
(3, 
ªg
->
¥oc_mode
);

92 
	}
}

95 
	$ev4_h™dÀ_öãºu±
(
which
, 
±_ªgs
 *
ªgs
,

96 
›_cou¡î_c⁄fig
 *
˘r
)

100 i‡(!
˘r
[
which
].
íabÀd
)

104 
	`›rofûe_add_ßm∂e
(
ªgs
, 
which
);

105 
	}
}

108 
›_axp_modñ
 
	g›_modñ_ev4
 = {

109 .
ªg_£tup
 = 
ev4_ªg_£tup
,

110 .
	g˝u_£tup
 = 
ev4_˝u_£tup
,

111 .
	gª£t_˘r
 = 
NULL
,

112 .
	gh™dÀ_öãºu±
 = 
ev4_h™dÀ_öãºu±
,

113 .
	g˝u_ty≥
 = "alpha/ev4",

114 .
	gnum_cou¡îs
 = 2,

115 .
	gˇn_£t_¥oc_mode
 = 0,

	@arch/alpha/oprofile/op_model_ev5.c

10 
	~<löux/›rofûe.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/smp.h
>

13 
	~<asm/±ø˚.h
>

14 
	~<asm/sy°em.h
>

16 
	~"›_im∂.h
"

27 
	$comm⁄_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

28 
›_cou¡î_c⁄fig
 *
˘r
,

29 
›_sy°em_c⁄fig
 *
sys
,

30 
cbox1_ofs
, 
cbox2_ofs
)

32 
i
, 
˘l
, 
ª£t
, 
√ed_ª£t
;

47 
˘l
 = 0;

48 
i
 = 0; i < 3; ++i) {

49 
evít
 = 
˘r
[
i
].event;

50 i‡(!
˘r
[
i
].
íabÀd
)

54 i‡(
i
 == 2) {

55 i‡(
evít
 == 0)

56 
evít
 = 12+48;

57 i‡(
evít
 == 2+41)

58 
evít
 = 4+65;

62 i‡(
evít
 < 2)

63 
˘l
 |
evít
 << 31;

64 i‡(
evít
 < 24)

66 i‡(
evít
 < 40)

67 
˘l
 |(
evít
 - 24) << 4;

68 i‡(
evít
 < 48)

69 
˘l
 |(
evít
 - 40Ë<< 
cbox1_ofs
 | 15 << 4;

70 i‡(
evít
 < 64)

71 
˘l
 |
evít
 - 48;

72 i‡(
evít
 < 72)

73 
˘l
 |(
evít
 - 64Ë<< 
cbox2_ofs
 | 15;

75 
ªg
->
mux_£À˘
 = 
˘l
;

80 
˘l
 = 0;

81 
˘l
 |!
sys
->
íabÀ_∑l
 << 9;

82 
˘l
 |!
sys
->
íabÀ_kî√l
 << 8;

83 
˘l
 |!
sys
->
íabÀ_u£r
 << 30;

84 
ªg
->
¥oc_mode
 = 
˘l
;

91 
˘l
 = 
ª£t
 = 
√ed_ª£t
 = 0;

92 
i
 = 0; i < 3; ++i) {

93 
max
, 
hûo
, 
cou¡
 = 
˘r
[
i
].count;

94 i‡(!
˘r
[
i
].
íabÀd
)

97 i‡(
cou¡
 <= 256)

98 
cou¡
 = 256, 
hûo
 = 3, 
max
 = 256;

100 
max
 = (
i
 == 2 ? 16384 : 65536);

101 
hûo
 = 2;

102 i‡(
cou¡
 > 
max
)

103 
cou¡
 = 
max
;

105 
˘r
[
i
].
cou¡
 = count;

107 
˘l
 |
hûo
 << (8 - 
i
*2);

108 
ª£t
 |(
max
 - 
cou¡
Ë<< (48 - 16*
i
);

109 i‡(
cou¡
 !
max
)

110 
√ed_ª£t
 |1 << 
i
;

112 
ªg
->
‰eq
 = 
˘l
;

113 
ªg
->
ª£t_vÆues
 = 
ª£t
;

114 
ªg
->
√ed_ª£t
 =Çeed_reset;

115 
	}
}

118 
	$ev5_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

119 
›_cou¡î_c⁄fig
 *
˘r
,

120 
›_sy°em_c⁄fig
 *
sys
)

122 
	`comm⁄_ªg_£tup
(
ªg
, 
˘r
, 
sys
, 19, 22);

123 
	}
}

126 
	$pˇ56_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

127 
›_cou¡î_c⁄fig
 *
˘r
,

128 
›_sy°em_c⁄fig
 *
sys
)

130 
	`comm⁄_ªg_£tup
(
ªg
, 
˘r
, 
sys
, 8, 11);

131 
	}
}

136 
	$ev5_˝u_£tup
 (*
x
)

138 
›_ªgi°î_c⁄fig
 *
ªg
 = 
x
;

140 
	`wΩîfm⁄
(2, 
ªg
->
mux_£À˘
);

141 
	`wΩîfm⁄
(3, 
ªg
->
¥oc_mode
);

142 
	`wΩîfm⁄
(4, 
ªg
->
‰eq
);

143 
	`wΩîfm⁄
(6, 
ªg
->
ª£t_vÆues
);

144 
	}
}

159 
	$ev5_ª£t_˘r
(
›_ªgi°î_c⁄fig
 *
ªg
, 
˘r
)

161 
vÆues
, 
mask
, 
nŸ_pk
, 
ª£t_vÆues
;

163 
mask
 = (
˘r
 == 0 ? 0xfffful << 48

164 : 
˘r
 == 1 ? 0xfffful << 32

167 
nŸ_pk
 = 1 << 9 | 1 << 8;

169 
ª£t_vÆues
 = 
ªg
->reset_values;

171 i‡((
ªg
->
¥oc_mode
 & 
nŸ_pk
) ==Çot_pk) {

172 
vÆues
 = 
	`wΩîfm⁄
(5, 0);

173 
vÆues
 = (
ª£t_vÆues
 & 
mask
) | (values & ~mask & -2);

174 
	`wΩîfm⁄
(6, 
vÆues
);

176 
	`wΩîfm⁄
(0, -1);

177 
vÆues
 = 
	`wΩîfm⁄
(5, 0);

178 
vÆues
 = (
ª£t_vÆues
 & 
mask
) | (values & ~mask & -2);

179 
	`wΩîfm⁄
(6, 
vÆues
);

180 
	`wΩîfm⁄
(1, 
ªg
->
íabÀ
);

182 
	}
}

185 
	$ev5_h™dÀ_öãºu±
(
which
, 
±_ªgs
 *
ªgs
,

186 
›_cou¡î_c⁄fig
 *
˘r
)

189 
	`›rofûe_add_ßm∂e
(
ªgs
, 
which
);

190 
	}
}

193 
›_axp_modñ
 
	g›_modñ_ev5
 = {

194 .
ªg_£tup
 = 
ev5_ªg_£tup
,

195 .
	g˝u_£tup
 = 
ev5_˝u_£tup
,

196 .
	gª£t_˘r
 = 
ev5_ª£t_˘r
,

197 .
	gh™dÀ_öãºu±
 = 
ev5_h™dÀ_öãºu±
,

198 .
	g˝u_ty≥
 = "alpha/ev5",

199 .
	gnum_cou¡îs
 = 3,

200 .
	gˇn_£t_¥oc_mode
 = 1,

203 
›_axp_modñ
 
	g›_modñ_pˇ56
 = {

204 .
ªg_£tup
 = 
pˇ56_ªg_£tup
,

205 .
	g˝u_£tup
 = 
ev5_˝u_£tup
,

206 .
	gª£t_˘r
 = 
ev5_ª£t_˘r
,

207 .
	gh™dÀ_öãºu±
 = 
ev5_h™dÀ_öãºu±
,

208 .
	g˝u_ty≥
 = "alpha/pca56",

209 .
	gnum_cou¡îs
 = 3,

210 .
	gˇn_£t_¥oc_mode
 = 1,

	@arch/alpha/oprofile/op_model_ev6.c

10 
	~<löux/›rofûe.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/smp.h
>

13 
	~<asm/±ø˚.h
>

14 
	~<asm/sy°em.h
>

16 
	~"›_im∂.h
"

22 
	$ev6_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

23 
›_cou¡î_c⁄fig
 *
˘r
,

24 
›_sy°em_c⁄fig
 *
sys
)

26 
˘l
, 
ª£t
, 
√ed_ª£t
, 
i
;

30 
˘l
 = 0;

31 i‡(
˘r
[0].
íabÀd
 && cå[0].
evít
)

32 
˘l
 |(
˘r
[0].
evít
 & 1) << 4;

33 i‡(
˘r
[1].
íabÀd
)

34 
˘l
 |(
˘r
[1].
evít
 - 2) & 15;

35 
ªg
->
mux_£À˘
 = 
˘l
;

41 
ªg
->
¥oc_mode
 = 0;

47 
ª£t
 = 
√ed_ª£t
 = 0;

48 
i
 = 0; i < 2; ++i) {

49 
cou¡
 = 
˘r
[
i
].count;

50 i‡(!
˘r
[
i
].
íabÀd
)

53 i‡(
cou¡
 > 0x100000)

54 
cou¡
 = 0x100000;

55 
˘r
[
i
].
cou¡
 = count;

56 
ª£t
 |(0x100000 - 
cou¡
Ë<< (
i
 ? 6 : 28);

57 i‡(
cou¡
 != 0x100000)

58 
√ed_ª£t
 |1 << 
i
;

60 
ªg
->
ª£t_vÆues
 = 
ª£t
;

61 
ªg
->
√ed_ª£t
 =Çeed_reset;

62 
	}
}

67 
	$ev6_˝u_£tup
 (*
x
)

69 
›_ªgi°î_c⁄fig
 *
ªg
 = 
x
;

71 
	`wΩîfm⁄
(2, 
ªg
->
mux_£À˘
);

72 
	`wΩîfm⁄
(3, 
ªg
->
¥oc_mode
);

73 
	`wΩîfm⁄
(6, 
ªg
->
ª£t_vÆues
 | 3);

74 
	}
}

81 
	$ev6_ª£t_˘r
(
›_ªgi°î_c⁄fig
 *
ªg
, 
˘r
)

83 
	`wΩîfm⁄
(6, 
ªg
->
ª£t_vÆues
 | (1 << 
˘r
));

84 
	}
}

87 
	$ev6_h™dÀ_öãºu±
(
which
, 
±_ªgs
 *
ªgs
,

88 
›_cou¡î_c⁄fig
 *
˘r
)

91 
	`›rofûe_add_ßm∂e
(
ªgs
, 
which
);

92 
	}
}

95 
›_axp_modñ
 
	g›_modñ_ev6
 = {

96 .
ªg_£tup
 = 
ev6_ªg_£tup
,

97 .
	g˝u_£tup
 = 
ev6_˝u_£tup
,

98 .
	gª£t_˘r
 = 
ev6_ª£t_˘r
,

99 .
	gh™dÀ_öãºu±
 = 
ev6_h™dÀ_öãºu±
,

100 .
	g˝u_ty≥
 = "alpha/ev6",

101 .
	gnum_cou¡îs
 = 2,

102 .
	gˇn_£t_¥oc_mode
 = 0,

	@arch/alpha/oprofile/op_model_ev67.c

11 
	~<löux/›rofûe.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/smp.h
>

14 
	~<asm/±ø˚.h
>

15 
	~<asm/sy°em.h
>

17 
	~"›_im∂.h
"

23 
	$ev67_ªg_£tup
(
›_ªgi°î_c⁄fig
 *
ªg
,

24 
›_cou¡î_c⁄fig
 *
˘r
,

25 
›_sy°em_c⁄fig
 *
sys
)

27 
˘l
, 
ª£t
, 
√ed_ª£t
, 
i
;

30 
˘l
 = 1UL << 4;

34 i‡(
˘r
[1].
íabÀd
) {

35 
˘l
 |(
˘r
[1].
evít
 & 3) << 2;

37 i‡(
˘r
[0].
evít
 == 0)

38 
˘l
 |= 1UL << 2;

40 
ªg
->
mux_£À˘
 = 
˘l
;

46 
ªg
->
¥oc_mode
 = 0;

52 
ª£t
 = 
√ed_ª£t
 = 0;

53 
i
 = 0; i < 2; ++i) {

54 
cou¡
 = 
˘r
[
i
].count;

55 i‡(!
˘r
[
i
].
íabÀd
)

58 i‡(
cou¡
 > 0x100000)

59 
cou¡
 = 0x100000;

60 
˘r
[
i
].
cou¡
 = count;

61 
ª£t
 |(0x100000 - 
cou¡
Ë<< (
i
 ? 6 : 28);

62 i‡(
cou¡
 != 0x100000)

63 
√ed_ª£t
 |1 << 
i
;

65 
ªg
->
ª£t_vÆues
 = 
ª£t
;

66 
ªg
->
√ed_ª£t
 =Çeed_reset;

67 
	}
}

72 
	$ev67_˝u_£tup
 (*
x
)

74 
›_ªgi°î_c⁄fig
 *
ªg
 = 
x
;

76 
	`wΩîfm⁄
(2, 
ªg
->
mux_£À˘
);

77 
	`wΩîfm⁄
(3, 
ªg
->
¥oc_mode
);

78 
	`wΩîfm⁄
(6, 
ªg
->
ª£t_vÆues
 | 3);

79 
	}
}

86 
	$ev67_ª£t_˘r
(
›_ªgi°î_c⁄fig
 *
ªg
, 
˘r
)

88 
	`wΩîfm⁄
(6, 
ªg
->
ª£t_vÆues
 | (1 << 
˘r
));

89 
	}
}

119 
	e¥ofûeme_cou¡îs
 {

120 
	mPM_STALLED
,

122 
	mPM_TAKEN
,

123 
	mPM_MISPREDICT
,

124 
	mPM_ITB_MISS
,

125 
	mPM_DTB_MISS
,

126 
	mPM_REPLAY
,

127 
	mPM_LOAD_STORE
,

128 
	mPM_ICACHE_MISS
,

129 
	mPM_UNALIGNED
,

130 
	mPM_NUM_COUNTERS


133 
ölöe
 

134 
	$›_add_pm
(
pc
, 
kîn
, 
cou¡î
,

135 
›_cou¡î_c⁄fig
 *
˘r
, 
evít
)

137 
Áke_cou¡î
 = 2 + 
evít
;

138 i‡(
cou¡î
 == 1)

139 
Áke_cou¡î
 +
PM_NUM_COUNTERS
;

140 i‡(
˘r
[
Áke_cou¡î
].
íabÀd
)

141 
	`›rofûe_add_pc
(
pc
, 
kîn
, 
Áke_cou¡î
);

142 
	}
}

145 
	$ev67_h™dÀ_öãºu±
(
which
, 
±_ªgs
 *
ªgs
,

146 
›_cou¡î_c⁄fig
 *
˘r
)

148 
pmpc
, 
p˘r_˘l
;

149 
kîn
 = !
	`u£r_mode
(
ªgs
);

150 
mi•ªdi˘
 = 0;

152 
v
;

154 
ª£rved
: 30;

155 
ovîcou¡
: 3;

156 
iˇche_miss
: 1;

157 
å≠_ty≥
: 4;

158 
lﬂd_°‹e
: 1;

159 
å≠
: 1;

160 
mi•ªdi˘
: 1;

161 } 
fõlds
;

162 } 
i_°©
;

164 
	eå≠_ty≥s
 {

165 
TRAP_REPLAY
,

166 
TRAP_INVALID0
,

167 
TRAP_DTB_DOUBLE_MISS_3
,

168 
TRAP_DTB_DOUBLE_MISS_4
,

169 
TRAP_FP_DISABLED
,

170 
TRAP_UNALIGNED
,

171 
TRAP_DTB_SINGLE_MISS
,

172 
TRAP_DSTREAM_FAULT
,

173 
TRAP_OPCDEC
,

174 
TRAP_INVALID1
,

175 
TRAP_MACHINE_CHECK
,

176 
TRAP_INVALID2
,

177 
TRAP_ARITHMETIC
,

178 
TRAP_INVALID3
,

179 
TRAP_MT_FPCR
,

180 
TRAP_RESET


183 
pmpc
 = 
	`wΩîfm⁄
(9, 0);

185 i‡(
pmpc
 & 1)

187 
pmpc
 &= ~2;

189 
i_°©
.
v
 = 
	`wΩîfm⁄
(8, 0);

190 i‡(
i_°©
.
fõlds
.
å≠
) {

191 
i_°©
.
fõlds
.
å≠_ty≥
) {

192 
TRAP_INVALID1
:

193 
TRAP_INVALID2
:

194 
TRAP_INVALID3
:

199 
	`›rofûe_add_pc
(
ªgs
->
pc
, 
kîn
, 
which
);

200 i‡((
pmpc
 & ((1 << 15) - 1)) == 581)

201 
	`›_add_pm
(
ªgs
->
pc
, 
kîn
, 
which
,

202 
˘r
, 
PM_ITB_MISS
);

207 
TRAP_REPLAY
:

208 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
,

209 (
i_°©
.
fõlds
.
lﬂd_°‹e


210 ? 
PM_LOAD_STORE
 : 
PM_REPLAY
));

212 
TRAP_DTB_DOUBLE_MISS_3
:

213 
TRAP_DTB_DOUBLE_MISS_4
:

214 
TRAP_DTB_SINGLE_MISS
:

215 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
, 
PM_DTB_MISS
);

217 
TRAP_UNALIGNED
:

218 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
, 
PM_UNALIGNED
);

220 
TRAP_INVALID0
:

221 
TRAP_FP_DISABLED
:

222 
TRAP_DSTREAM_FAULT
:

223 
TRAP_OPCDEC
:

224 
TRAP_MACHINE_CHECK
:

225 
TRAP_ARITHMETIC
:

226 
TRAP_MT_FPCR
:

227 
TRAP_RESET
:

236 i‡(
i_°©
.
fõlds
.
mi•ªdi˘
) {

237 
mi•ªdi˘
 = 1;

238 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
, 
PM_MISPREDICT
);

242 
	`›rofûe_add_pc
(
pmpc
, 
kîn
, 
which
);

244 
p˘r_˘l
 = 
	`wΩîfm⁄
(5, 0);

245 i‡(
p˘r_˘l
 & (1UL << 27))

246 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
, 
PM_STALLED
);

251 i‡(!
mi•ªdi˘
 && 
p˘r_˘l
 & (1UL << 0))

252 
	`›_add_pm
(
pmpc
, 
kîn
, 
which
, 
˘r
, 
PM_TAKEN
);

253 
	}
}

255 
›_axp_modñ
 
	g›_modñ_ev67
 = {

256 .
ªg_£tup
 = 
ev67_ªg_£tup
,

257 .
	g˝u_£tup
 = 
ev67_˝u_£tup
,

258 .
	gª£t_˘r
 = 
ev67_ª£t_˘r
,

259 .
	gh™dÀ_öãºu±
 = 
ev67_h™dÀ_öãºu±
,

260 .
	g˝u_ty≥
 = "alpha/ev67",

261 .
	gnum_cou¡îs
 = 20,

262 .
	gˇn_£t_¥oc_mode
 = 0,

	@arch/arm/boot/compressed/misc.c

19 
	g__machöe_¨ch_ty≥
;

21 
	~<löux/°rög.h
>

23 #ifde‡
STANDALONE_DEBUG


24 
	#put°r
 
¥ötf


	)

27 
put°r
(c⁄° *
±r
);

29 
	~<löux/compûî.h
>

30 
	~<asm/¨ch/uncom¥ess.h
>

32 #ifde‡
CONFIG_DEBUG_ICEDCC


34 #ifde‡
CONFIG_CPU_V6


36 
	$i˚dcc_putc
(
ch
)

38 
°©us
, 
i
 = 0x4000000;

41 i‡(--
i
 < 0)

44 
asm
 vﬁ©ûê("mr¯p14, 0, %0, c0, c1, 0" : "Ù" (
°©us
));

45 } 
°©us
 & (1 << 29));

47 
	`asm
("m¸Ö14, 0, %0, c0, c5, 0" : : "r" (
ch
));

48 
	}
}

52 
	$i˚dcc_putc
(
ch
)

54 
°©us
, 
i
 = 0x4000000;

57 i‡(--
i
 < 0)

60 
asm
 vﬁ©ûê("mr¯p14, 0, %0, c0, c0, 0" : "Ù" (
°©us
));

61 } 
°©us
 & 2);

63 
	`asm
("m¸Ö14, 0, %0, c1, c0, 0" : : "r" (
ch
));

64 
	}
}

68 
	#putc
(
ch
Ë
	`i˚dcc_putc
(ch)

	)

69 
	#Êush
(Ëdÿ{ } 0)

	)

72 
	$put°r
(c⁄° *
±r
)

74 
c
;

76 (
c
 = *
±r
++) != '\0') {

77 i‡(
c
 == '\n')

78 
	`putc
('\r');

79 
	`putc
(
c
);

82 
	`Êush
();

83 
	}
}

87 
	#__±r_t
 *

	)

92 
	$__memzîo
 (
__±r_t
 
s
, 
size_t
 
n
)

94 uni⁄ { *
vp
; *
uÕ
; *
u˝
; } 
u
;

95 
i
;

97 
u
.
vp
 = 
s
;

99 
i
 = 
n
 >> 5; i > 0; i--) {

100 *
u
.
uÕ
++ = 0;

101 *
u
.
uÕ
++ = 0;

102 *
u
.
uÕ
++ = 0;

103 *
u
.
uÕ
++ = 0;

104 *
u
.
uÕ
++ = 0;

105 *
u
.
uÕ
++ = 0;

106 *
u
.
uÕ
++ = 0;

107 *
u
.
uÕ
++ = 0;

110 i‡(
n
 & 1 << 4) {

111 *
u
.
uÕ
++ = 0;

112 *
u
.
uÕ
++ = 0;

113 *
u
.
uÕ
++ = 0;

114 *
u
.
uÕ
++ = 0;

117 i‡(
n
 & 1 << 3) {

118 *
u
.
uÕ
++ = 0;

119 *
u
.
uÕ
++ = 0;

122 i‡(
n
 & 1 << 2)

123 *
u
.
uÕ
++ = 0;

125 i‡(
n
 & 1 << 1) {

126 *
u
.
u˝
++ = 0;

127 *
u
.
u˝
++ = 0;

130 i‡(
n
 & 1)

131 *
u
.
u˝
++ = 0;

132 
	}
}

134 
ölöe
 
__±r_t
 
	$mem˝y
(
__±r_t
 
__de°
, 
__c⁄°
 __±r_à
__§c
,

135 
size_t
 
__n
)

137 
i
 = 0;

138 *
d
 = (*)
__de°
, *
s
 = (*)
__§c
;

140 
i
 = 
__n
 >> 3; i > 0; i--) {

141 *
d
++ = *
s
++;

142 *
d
++ = *
s
++;

143 *
d
++ = *
s
++;

144 *
d
++ = *
s
++;

145 *
d
++ = *
s
++;

146 *
d
++ = *
s
++;

147 *
d
++ = *
s
++;

148 *
d
++ = *
s
++;

151 i‡(
__n
 & 1 << 2) {

152 *
d
++ = *
s
++;

153 *
d
++ = *
s
++;

154 *
d
++ = *
s
++;

155 *
d
++ = *
s
++;

158 i‡(
__n
 & 1 << 1) {

159 *
d
++ = *
s
++;

160 *
d
++ = *
s
++;

163 i‡(
__n
 & 1)

164 *
d
++ = *
s
++;

166  
__de°
;

167 
	}
}

172 
	#OF
(
¨gs
Ë
	)
args

173 
	#STATIC
 

	)

175 
	tuch
;

176 
	tush
;

177 
	tulg
;

179 
	#WSIZE
 0x8000

	)

182 
uch
 *
	göbuf
;

183 
uch
 
	gwödow
[
WSIZE
];

185 
	gösize
;

186 
	gö±r
;

187 
	gout˙t
;

190 
	#ASCII_FLAG
 0x01

	)

191 
	#CONTINUATION
 0x02

	)

192 
	#EXTRA_FIELD
 0x04

	)

193 
	#ORIG_NAME
 0x08

	)

194 
	#COMMENT
 0x10

	)

195 
	#ENCRYPTED
 0x20

	)

196 
	#RESERVED
 0xC0

	)

198 
	#gë_byã
(Ë(
ö±r
 < 
ösize
 ? 
öbuf
[ö±r++] : 
	`fûl_öbuf
())

	)

201 #ifde‡
DEBUG


202 
	#As£π
(
c⁄d
,
msg
Ë{if(!(c⁄d)Ë
	`îr‹
(msg);}

	)

203 
	#Tø˚
(
x
Ë
Ârötf
 
	)
x

204 
	#Tø˚v
(
x
Ë{i‡(
vîbo£
Ë
Ârötf
 x ;}

	)

205 
	#Tø˚vv
(
x
Ë{i‡(
vîbo£
>1Ë
Ârötf
 x ;}

	)

206 
	#Tø˚c
(
c
,
x
Ë{i‡(
vîbo£
 && (c)Ë
Ârötf
 x ;}

	)

207 
	#Tø˚cv
(
c
,
x
Ë{i‡(
vîbo£
>1 && (c)Ë
Ârötf
 x ;}

	)

209 
	#As£π
(
c⁄d
,
msg
)

	)

210 
	#Tø˚
(
x
)

	)

211 
	#Tø˚v
(
x
)

	)

212 
	#Tø˚vv
(
x
)

	)

213 
	#Tø˚c
(
c
,
x
)

	)

214 
	#Tø˚cv
(
c
,
x
)

	)

217 
fûl_öbuf
();

218 
Êush_wödow
();

219 
îr‹
(*
m
);

220 
gzù_m¨k
(**);

221 
gzù_ªÀa£
(**);

223 
öput_d©a
[];

224 
öput_d©a_íd
[];

226 
uch
 *
	gouçut_d©a
;

227 
ulg
 
	gouçut_±r
;

228 
ulg
 
	gbyãs_out
;

230 *
mÆloc
(
size
);

231 
‰ì
(*
whîe
);

232 
îr‹
(*
m
);

233 
gzù_m¨k
(**);

234 
gzù_ªÀa£
(**);

236 
put°r
(const *);

238 
íd
;

239 
ulg
 
	g‰ì_mem_±r
;

240 
ulg
 
	g‰ì_mem_±r_íd
;

242 
	#HEAP_SIZE
 0x3000

	)

244 
	~"../../../../lib/öÊ©e.c
"

246 #i‚de‡
STANDALONE_DEBUG


247 *
	$mÆloc
(
size
)

249 *
p
;

251 i‡(
size
 <0Ë
	`îr‹
("MallocÉrror");

252 i‡(
‰ì_mem_±r
 <0Ë
	`îr‹
("MemoryÉrror");

254 
‰ì_mem_±r
 = (free_mem_ptr + 3) & ~3;

256 
p
 = (*)
‰ì_mem_±r
;

257 
‰ì_mem_±r
 +
size
;

259 i‡(
‰ì_mem_±r
 >
‰ì_mem_±r_íd
)

260 
	`îr‹
("Out of memory");

261  
p
;

262 
	}
}

264 
	$‰ì
(*
whîe
)

266 
	}
}

268 
	$gzù_m¨k
(**
±r
)

270 
	`¨ch_decomp_wdog
();

271 *
±r
 = (*Ë
‰ì_mem_±r
;

272 
	}
}

274 
	$gzù_ªÀa£
(**
±r
)

276 
	`¨ch_decomp_wdog
();

277 
‰ì_mem_±r
 = (Ë*
±r
;

278 
	}
}

280 
	$gzù_m¨k
(**
±r
)

282 
	}
}

284 
	$gzù_ªÀa£
(**
±r
)

286 
	}
}

293 
	$fûl_öbuf
()

295 i‡(
ösize
 != 0)

296 
	`îr‹
("ran out of input data");

298 
öbuf
 = 
öput_d©a
;

299 
ösize
 = &
öput_d©a_íd
[0] - &
öput_d©a
[0];

301 
ö±r
 = 1;

302  
öbuf
[0];

303 
	}
}

309 
	$Êush_wödow
()

311 
ulg
 
c
 = 
¸c
;

312 
n
;

313 
uch
 *
ö
, *
out
, 
ch
;

315 
ö
 = 
wödow
;

316 
out
 = &
ouçut_d©a
[
ouçut_±r
];

317 
n
 = 0;Ç < 
out˙t
;Ç++) {

318 
ch
 = *
out
++ = *
ö
++;

319 
c
 = 
¸c_32_èb
[(()¯^ 
ch
) & 0xff] ^ (c >> 8);

321 
¸c
 = 
c
;

322 
byãs_out
 +(
ulg
)
out˙t
;

323 
ouçut_±r
 +(
ulg
)
out˙t
;

324 
out˙t
 = 0;

325 
	`put°r
(".");

326 
	}
}

328 #i‚de‡
¨ch_îr‹


329 
	#¨ch_îr‹
(
x
)

	)

332 
	$îr‹
(*
x
)

334 
	`¨ch_îr‹
(
x
);

336 
	`put°r
("\n\n");

337 
	`put°r
(
x
);

338 
	`put°r
("\n\n -- System halted");

341 
	}
}

343 #i‚de‡
STANDALONE_DEBUG


345 
ulg


346 
	$decom¥ess_kî√l
(
ulg
 
ouçut_°¨t
, ulg 
‰ì_mem_±r_p
, ulg 
‰ì_mem_±r_íd_p
,

347 
¨ch_id
)

349 
ouçut_d©a
 = (
uch
 *)
ouçut_°¨t
;

350 
‰ì_mem_±r
 = 
‰ì_mem_±r_p
;

351 
‰ì_mem_±r_íd
 = 
‰ì_mem_±r_íd_p
;

352 
__machöe_¨ch_ty≥
 = 
¨ch_id
;

354 
	`¨ch_decomp_£tup
();

356 
	`make¸c
();

357 
	`put°r
("Uncompressing Linux...");

358 
	`gunzù
();

359 
	`put°r
(" done, bootingÅhe kernel.\n");

360  
ouçut_±r
;

361 
	}
}

364 
	gouçut_buf„r
[1500*1024];

366 
	$maö
()

368 
ouçut_d©a
 = 
ouçut_buf„r
;

370 
	`make¸c
();

371 
	`put°r
("Uncompressing Linux...");

372 
	`gunzù
();

373 
	`put°r
("done.\n");

375 
	}
}

	@arch/arm/boot/compressed/ofw-shark.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

15 
	~<asm/£tup.h
>

16 
	~<asm/∑ge.h
>

19 
asmlökage
 

20 
	$¸óã_∑øms
 (*
buf„r
)

23 
èg
 *tag = (tag *) 0x08003000;

24 
j
,
i
,
m
,
k
,
ƒ_b™ks
,
size
;

25 *
c
;

27 
k
 = 0;

30 
èg
->
hdr
.èg = 
ATAG_CORE
;

31 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_c‹e
);

32 
èg
->
u
.
c‹e
.
Êags
 = 1;

33 
èg
->
u
.
c‹e
.
∑gesize
 = 
PAGE_SIZE
;

34 
èg
->
u
.
c‹e
.
roŸdev
 = 0;

37 
size
=0;

38 
ƒ_b™ks
=(Ë
buf„r
[0];

39 
j
=0;j<
ƒ_b™ks
;j++){

43 
m
=0xffffffff;

44 
i
=0;i<(Ë
buf„r
[0];i++){

45 i‡(
buf„r
[2*
i
+1]<
m
) {

46 
m
=
buf„r
[2*
i
+1];

47 
k
=
i
;

51 
èg
 = 
	`èg_√xt
(tag);

52 
èg
->
hdr
.èg = 
ATAG_MEM
;

53 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_mem32
);

54 
èg
->
u
.
mem
.
size
 = 
buf„r
[2*
k
+2];

55 
èg
->
u
.
mem
.
°¨t
 = 
buf„r
[2*
k
+1];

57 
size
 +
buf„r
[2*
k
+2];

59 
buf„r
[2*
k
+1]=0xffffffff;

63 
èg
 = 
	`èg_√xt
(tag);

64 
èg
->
hdr
.èg = 
ATAG_CMDLINE
;

66 
c
=(*)(&
buf„r
[34]);

67 
j
=0;

68 *
c
Ë
èg
->
u
.
cmdlöe
.cmdlöe[
j
++]=*c++;

70 
èg
->
u
.
cmdlöe
.cmdlöe[
j
]=0;

71 
èg
->
hdr
.
size
 = (
j
 + 7 + (
èg_hódî
)) >> 2;

74 
èg
 = 
	`èg_√xt
(tag);

75 
èg
->
hdr
.èg = 
ATAG_REVISION
;

76 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_ªvisi⁄
);

77 
èg
->
u
.
ªvisi⁄
.
ªv
 = ((Ë
buf„r
[33])-'0';

80 
èg
 = 
	`èg_√xt
(tag);

81 
èg
->
hdr
.tag = 0;

82 
èg
->
hdr
.
size
 = 0;

83 
	}
}

86 (*
	tofw_h™dÀ_t
)(*);

95 
	$of_decode_öt
(c⁄° *
p
)

97 
i
 = *
p
++ << 8;

98 
i
 = (ò+ *
p
++) << 8;

99 
i
 = (ò+ *
p
++) << 8;

100  (
i
 + *
p
);

101 
	}
}

104 
	$OF_föddevi˚
(
ofw_h™dÀ_t
 
›ífúmw¨e
, *
«me
)

106 
¨gs
[8];

107 
£rvi˚
[12];

109 
£rvi˚
[0]='f';

110 
£rvi˚
[1]='i';

111 
£rvi˚
[2]='n';

112 
£rvi˚
[3]='d';

113 
£rvi˚
[4]='d';

114 
£rvi˚
[5]='e';

115 
£rvi˚
[6]='v';

116 
£rvi˚
[7]='i';

117 
£rvi˚
[8]='c';

118 
£rvi˚
[9]='e';

119 
£rvi˚
[10]='\0';

121 
¨gs
[0]=()
£rvi˚
;

122 
¨gs
[1]=1;

123 
¨gs
[2]=1;

124 
¨gs
[3]=()
«me
;

126 i‡(
	`›ífúmw¨e
(
¨gs
) == -1)

128  
¨gs
[4];

129 
	}
}

132 
	$OF_gë¥›Àn
(
ofw_h™dÀ_t
 
›ífúmw¨e
, 
h™dÀ
, *
¥›
)

134 
¨gs
[8];

135 
£rvi˚
[12];

137 
£rvi˚
[0]='g';

138 
£rvi˚
[1]='e';

139 
£rvi˚
[2]='t';

140 
£rvi˚
[3]='p';

141 
£rvi˚
[4]='r';

142 
£rvi˚
[5]='o';

143 
£rvi˚
[6]='p';

144 
£rvi˚
[7]='l';

145 
£rvi˚
[8]='e';

146 
£rvi˚
[9]='n';

147 
£rvi˚
[10]='\0';

149 
¨gs
[0] = ()
£rvi˚
;

150 
¨gs
[1] = 2;

151 
¨gs
[2] = 1;

152 
¨gs
[3] = ()
h™dÀ
;

153 
¨gs
[4] = ()
¥›
;

155 i‡(
	`›ífúmw¨e
(
¨gs
) == -1)

157  
¨gs
[5];

158 
	}
}

161 
	$OF_gë¥›
(
ofw_h™dÀ_t
 
›ífúmw¨e
, 
h™dÀ
, *
¥›
, *
buf
, 
buÊí
)

163 
¨gs
[8];

164 
£rvi˚
[8];

166 
£rvi˚
[0]='g';

167 
£rvi˚
[1]='e';

168 
£rvi˚
[2]='t';

169 
£rvi˚
[3]='p';

170 
£rvi˚
[4]='r';

171 
£rvi˚
[5]='o';

172 
£rvi˚
[6]='p';

173 
£rvi˚
[7]='\0';

175 
¨gs
[0] = ()
£rvi˚
;

176 
¨gs
[1] = 4;

177 
¨gs
[2] = 1;

178 
¨gs
[3] = ()
h™dÀ
;

179 
¨gs
[4] = ()
¥›
;

180 
¨gs
[5] = ()
buf
;

181 
¨gs
[6] = 
buÊí
;

183 i‡(
	`›ífúmw¨e
(
¨gs
) == -1)

185  
¨gs
[7];

186 
	}
}

188 
asmlökage
 
	$ofw_öô
(
ofw_h™dÀ_t
 
o
, *
nomr
, *
poöãr
)

190 
ph™dÀ
,
i
,
mem_Àn
,
buf„r
[32];

191 
ãmp
[15];

193 
ãmp
[0]='/';

194 
ãmp
[1]='m';

195 
ãmp
[2]='e';

196 
ãmp
[3]='m';

197 
ãmp
[4]='o';

198 
ãmp
[5]='r';

199 
ãmp
[6]='y';

200 
ãmp
[7]='\0';

202 
ph™dÀ
=
	`OF_föddevi˚
(
o
,
ãmp
);

204 
ãmp
[0]='r';

205 
ãmp
[1]='e';

206 
ãmp
[2]='g';

207 
ãmp
[3]='\0';

209 
mem_Àn
 = 
	`OF_gë¥›Àn
(
o
,
ph™dÀ
, 
ãmp
);

210 
	`OF_gë¥›
(
o
,
ph™dÀ
, 
ãmp
, 
buf„r
, 
mem_Àn
);

211 *
nomr
=
mem_Àn
 >> 3;

213 
i
=0; i<=
mem_Àn
/4; i++Ë
poöãr
[i]=
	`of_decode_öt
((c⁄° *)&
buf„r
[i]);

215 
ãmp
[0]='/';

216 
ãmp
[1]='c';

217 
ãmp
[2]='h';

218 
ãmp
[3]='o';

219 
ãmp
[4]='s';

220 
ãmp
[5]='e';

221 
ãmp
[6]='n';

222 
ãmp
[7]='\0';

224 
ph™dÀ
=
	`OF_föddevi˚
(
o
,
ãmp
);

226 
ãmp
[0]='b';

227 
ãmp
[1]='o';

228 
ãmp
[2]='o';

229 
ãmp
[3]='t';

230 
ãmp
[4]='a';

231 
ãmp
[5]='r';

232 
ãmp
[6]='g';

233 
ãmp
[7]='s';

234 
ãmp
[8]='\0';

236 
mem_Àn
 = 
	`OF_gë¥›Àn
(
o
,
ph™dÀ
, 
ãmp
);

237 
	`OF_gë¥›
(
o
,
ph™dÀ
, 
ãmp
, 
buf„r
, 
mem_Àn
);

238 i‡(
mem_Àn
 > 128) mem_len=128;

239 
i
=0; i<=
mem_Àn
/4; i++Ë
poöãr
[i+33]=
buf„r
[i];

240 
poöãr
[
i
+33]=0;

242 
ãmp
[0]='/';

243 
ãmp
[1]='\0';

244 
ph™dÀ
=
	`OF_föddevi˚
(
o
,
ãmp
);

245 
ãmp
[0]='b';

246 
ãmp
[1]='a';

247 
ãmp
[2]='n';

248 
ãmp
[3]='n';

249 
ãmp
[4]='e';

250 
ãmp
[5]='r';

251 
ãmp
[6]='-';

252 
ãmp
[7]='n';

253 
ãmp
[8]='a';

254 
ãmp
[9]='m';

255 
ãmp
[10]='e';

256 
ãmp
[11]='\0';

257 
mem_Àn
 = 
	`OF_gë¥›Àn
(
o
,
ph™dÀ
, 
ãmp
);

258 
	`OF_gë¥›
(
o
,
ph™dÀ
, 
ãmp
, 
buf„r
, 
mem_Àn
);

259 * ((*Ë&
poöãr
[32]Ë((*Ë
buf„r
)[
mem_Àn
-2];

260 
	}
}

	@arch/arm/common/dmabounce.c

25 
	~<löux/moduÀ.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/devi˚.h
>

29 
	~<löux/dma-m≠pög.h
>

30 
	~<löux/dm≠oﬁ.h
>

31 
	~<löux/li°.h
>

33 
	~<asm/ˇcheÊush.h
>

35 #unde‡
STATS


37 #ifde‡
STATS


38 
	#DO_STATS
(
X
Ëdÿ{ X ; } 0)

	)

40 
	#DO_STATS
(
X
Ëdÿ{ } 0)

	)

45 
	sß„_buf„r
 {

46 
li°_hód
 
	mnode
;

49 *
	m±r
;

50 
size_t
 
	msize
;

51 
	mdúe˘i⁄
;

54 
dmaboun˚_poﬁ
 *
	mpoﬁ
;

55 *
	mß„
;

56 
dma_addr_t
 
	mß„_dma_addr
;

59 
	sdmaboun˚_poﬁ
 {

60 
	msize
;

61 
dma_poﬁ
 *
	mpoﬁ
;

62 #ifde‡
STATS


63 
	mÆlocs
;

67 
	sdmaboun˚_devi˚_öfo
 {

68 
devi˚
 *
	mdev
;

69 
li°_hód
 
	mß„_buf„rs
;

70 #ifde‡
STATS


71 
	mtŸÆ_Ælocs
;

72 
	mm≠_›_cou¡
;

73 
	mboun˚_cou¡
;

74 
	m©å_ªs
;

76 
dmaboun˚_poﬁ
 
	msmÆl
;

77 
dmaboun˚_poﬁ
 
	mœrge
;

79 
rwlock_t
 
	mlock
;

82 #ifde‡
STATS


83 
ssize_t
 
	$dmaboun˚_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

84 *
buf
)

86 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
 = 
dev
->
¨chd©a
.
dmaboun˚
;

87  
	`•rötf
(
buf
, "%lu %lu %lu %lu %lu %lu\n",

88 
devi˚_öfo
->
smÆl
.
Ælocs
,

89 
devi˚_öfo
->
œrge
.
Ælocs
,

90 
devi˚_öfo
->
tŸÆ_Ælocs
 - devi˚_öfo->
smÆl
.
Ælocs
 -

91 
devi˚_öfo
->
œrge
.
Ælocs
,

92 
devi˚_öfo
->
tŸÆ_Ælocs
,

93 
devi˚_öfo
->
m≠_›_cou¡
,

94 
devi˚_öfo
->
boun˚_cou¡
);

95 
	}
}

97 
DEVICE_ATTR
(
dmaboun˚_°©s
, 0400, 
dmaboun˚_show
, 
NULL
);

102 
ölöe
 
ß„_buf„r
 *

103 
	$Æloc_ß„_buf„r
(
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
, *
±r
,

104 
size_t
 
size
, 
dma_d©a_dúe˘i⁄
 
dú
)

106 
ß„_buf„r
 *
buf
;

107 
dmaboun˚_poﬁ
 *
poﬁ
;

108 
devi˚
 *
dev
 = 
devi˚_öfo
->dev;

109 
Êags
;

111 
	`dev_dbg
(
dev
, "%s(ptr=%p, size=%d, dir=%d)\n",

112 
__func__
, 
±r
, 
size
, 
dú
);

114 i‡(
size
 <
devi˚_öfo
->
smÆl
.size) {

115 
poﬁ
 = &
devi˚_öfo
->
smÆl
;

116 } i‡(
size
 <
devi˚_öfo
->
œrge
.size) {

117 
poﬁ
 = &
devi˚_öfo
->
œrge
;

119 
poﬁ
 = 
NULL
;

122 
buf
 = 
	`kmÆloc
((
ß„_buf„r
), 
GFP_ATOMIC
);

123 i‡(
buf
 =
NULL
) {

124 
	`dev_w¨n
(
dev
, "%s: kmÆlo¯Áûed\n", 
__func__
);

125  
NULL
;

128 
buf
->
±r
 =Ötr;

129 
buf
->
size
 = size;

130 
buf
->
dúe˘i⁄
 = 
dú
;

131 
buf
->
poﬁ
 =Öool;

133 i‡(
poﬁ
) {

134 
buf
->
ß„
 = 
	`dma_poﬁ_Æloc
(
poﬁ
->poﬁ, 
GFP_ATOMIC
,

135 &
buf
->
ß„_dma_addr
);

137 
buf
->
ß„
 = 
	`dma_Æloc_cohîít
(
dev
, 
size
, &buf->
ß„_dma_addr
,

138 
GFP_ATOMIC
);

141 i‡(
buf
->
ß„
 =
NULL
) {

142 
	`dev_w¨n
(
dev
,

144 
__func__
, 
size
);

145 
	`k‰ì
(
buf
);

146  
NULL
;

149 #ifde‡
STATS


150 i‡(
poﬁ
)

151 
poﬁ
->
Ælocs
++;

152 
devi˚_öfo
->
tŸÆ_Ælocs
++;

155 
	`wrôe_lock_úqßve
(&
devi˚_öfo
->
lock
, 
Êags
);

157 
	`li°_add
(&
buf
->
node
, &
devi˚_öfo
->
ß„_buf„rs
);

159 
	`wrôe_u∆ock_úqª°‹e
(&
devi˚_öfo
->
lock
, 
Êags
);

161  
buf
;

162 
	}
}

165 
ölöe
 
ß„_buf„r
 *

166 
	$föd_ß„_buf„r
(
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
, 
dma_addr_t
 
ß„_dma_addr
)

168 
ß„_buf„r
 *
b
, *
rb
 = 
NULL
;

169 
Êags
;

171 
	`ªad_lock_úqßve
(&
devi˚_öfo
->
lock
, 
Êags
);

173 
	`li°_f‹_óch_íåy
(
b
, &
devi˚_öfo
->
ß„_buf„rs
, 
node
)

174 i‡(
b
->
ß„_dma_addr
 == safe_dma_addr) {

175 
rb
 = 
b
;

179 
	`ªad_u∆ock_úqª°‹e
(&
devi˚_öfo
->
lock
, 
Êags
);

180  
rb
;

181 
	}
}

183 
ölöe
 

184 
	$‰ì_ß„_buf„r
(
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
, 
ß„_buf„r
 *
buf
)

186 
Êags
;

188 
	`dev_dbg
(
devi˚_öfo
->
dev
, "%s(buf=%p)\n", 
__func__
, 
buf
);

190 
	`wrôe_lock_úqßve
(&
devi˚_öfo
->
lock
, 
Êags
);

192 
	`li°_dñ
(&
buf
->
node
);

194 
	`wrôe_u∆ock_úqª°‹e
(&
devi˚_öfo
->
lock
, 
Êags
);

196 i‡(
buf
->
poﬁ
)

197 
	`dma_poﬁ_‰ì
(
buf
->
poﬁ
->poﬁ, buf->
ß„
, buf->
ß„_dma_addr
);

199 
	`dma_‰ì_cohîít
(
devi˚_öfo
->
dev
, 
buf
->
size
, buf->
ß„
,

200 
buf
->
ß„_dma_addr
);

202 
	`k‰ì
(
buf
);

203 
	}
}

207 
ölöe
 
dma_addr_t


208 
	$m≠_sögÀ
(
devi˚
 *
dev
, *
±r
, 
size_t
 
size
,

209 
dma_d©a_dúe˘i⁄
 
dú
)

211 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
 = 
dev
->
¨chd©a
.
dmaboun˚
;

212 
dma_addr_t
 
dma_addr
;

213 
√eds_boun˚
 = 0;

215 i‡(
devi˚_öfo
)

216 
	`DO_STATS
 ( 
devi˚_öfo
->
m≠_›_cou¡
++ );

218 
dma_addr
 = 
	`vút_to_dma
(
dev
, 
±r
);

220 i‡(
dev
->
dma_mask
) {

221 
mask
 = *
dev
->
dma_mask
;

222 
limô
;

224 
limô
 = (
mask
 + 1) & ~mask;

225 i‡(
limô
 && 
size
 >Üimit) {

226 
	`dev_îr
(
dev
, "DMA mappingÅoo big (requested %#x "

227 "mask %#Lx)\n", 
size
, *
dev
->
dma_mask
);

234 
√eds_boun˚
 = (
dma_addr
 | (dma_add∏+ 
size
 - 1)Ë& ~
mask
;

237 i‡(
devi˚_öfo
 && (
√eds_boun˚
 || 
	`dma_√eds_boun˚
(
dev
, 
dma_addr
, 
size
))) {

238 
ß„_buf„r
 *
buf
;

240 
buf
 = 
	`Æloc_ß„_buf„r
(
devi˚_öfo
, 
±r
, 
size
, 
dú
);

241 i‡(
buf
 == 0) {

242 
	`dev_îr
(
dev
, "%s: unableÅo map unsafe buffer %p!\n",

243 
__func__
, 
±r
);

247 
	`dev_dbg
(
dev
,

249 
__func__
, 
buf
->
±r
, (*Ë
	`vút_to_dma
(
dev
, buf->ptr),

250 
buf
->
ß„
, (*Ëbuf->
ß„_dma_addr
);

252 i‡((
dú
 =
DMA_TO_DEVICE
) ||

253 (
dú
 =
DMA_BIDIRECTIONAL
)) {

254 
	`dev_dbg
(
dev
, "%s: copy unsafe %pÅo safe %p, size %d\n",

255 
__func__
, 
±r
, 
buf
->
ß„
, 
size
);

256 
	`mem˝y
(
buf
->
ß„
, 
±r
, 
size
);

258 
±r
 = 
buf
->
ß„
;

260 
dma_addr
 = 
buf
->
ß„_dma_addr
;

266 
	`c⁄si°ít_sync
(
±r
, 
size
, 
dú
);

269  
dma_addr
;

270 
	}
}

272 
ölöe
 

273 
	$unm≠_sögÀ
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

274 
dma_d©a_dúe˘i⁄
 
dú
)

276 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
 = 
dev
->
¨chd©a
.
dmaboun˚
;

277 
ß„_buf„r
 *
buf
 = 
NULL
;

282 i‡(
	`dma_m≠pög_îr‹
(
dma_addr
)) {

283 
	`dev_îr
(
dev
, "TryingÅo unmap invalid mapping\n");

287 i‡(
devi˚_öfo
)

288 
buf
 = 
	`föd_ß„_buf„r
(
devi˚_öfo
, 
dma_addr
);

290 i‡(
buf
) {

291 
	`BUG_ON
(
buf
->
size
 != size);

293 
	`dev_dbg
(
dev
,

295 
__func__
, 
buf
->
±r
, (*Ë
	`vút_to_dma
(
dev
, buf->ptr),

296 
buf
->
ß„
, (*Ëbuf->
ß„_dma_addr
);

298 
	`DO_STATS
 ( 
devi˚_öfo
->
boun˚_cou¡
++ );

300 i‡(
dú
 =
DMA_FROM_DEVICE
 || dú =
DMA_BIDIRECTIONAL
) {

301 *
±r
 = 
buf
->ptr;

303 
	`dev_dbg
(
dev
,

305 
__func__
, 
buf
->
ß„
, 
±r
, 
size
);

306 
	`mem˝y
(
±r
, 
buf
->
ß„
, 
size
);

316 
	`dmac_˛ón_ønge
(
±r
,Öå + 
size
);

317 
	`ouãr_˛ón_ønge
(
	`__∑
(
±r
), __∑’åË+ 
size
);

319 
	`‰ì_ß„_buf„r
(
devi˚_öfo
, 
buf
);

321 
	}
}

323 
ölöe
 

324 
	$sync_sögÀ
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

325 
dma_d©a_dúe˘i⁄
 
dú
)

327 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
 = 
dev
->
¨chd©a
.
dmaboun˚
;

328 
ß„_buf„r
 *
buf
 = 
NULL
;

330 i‡(
devi˚_öfo
)

331 
buf
 = 
	`föd_ß„_buf„r
(
devi˚_öfo
, 
dma_addr
);

333 i‡(
buf
) {

356 
	`dev_dbg
(
dev
,

358 
__func__
, 
buf
->
±r
, (*Ë
	`vút_to_dma
(
dev
, buf->ptr),

359 
buf
->
ß„
, (*Ëbuf->
ß„_dma_addr
);

361 
	`DO_STATS
 ( 
devi˚_öfo
->
boun˚_cou¡
++ );

363 
dú
) {

364 
DMA_FROM_DEVICE
:

365 
	`dev_dbg
(
dev
,

367 
__func__
, 
buf
->
ß„
, buf->
±r
, 
size
);

368 
	`mem˝y
(
buf
->
±r
, buf->
ß„
, 
size
);

370 
DMA_TO_DEVICE
:

371 
	`dev_dbg
(
dev
,

373 
__func__
,
buf
->
±r
, buf->
ß„
, 
size
);

374 
	`mem˝y
(
buf
->
ß„
, buf->
±r
, 
size
);

376 
DMA_BIDIRECTIONAL
:

377 
	`BUG
();

379 
	`BUG
();

386 
	`c⁄si°ít_sync
(
	`dma_to_vút
(
dev
, 
dma_addr
), 
size
, 
dú
);

388 
	}
}

398 
dma_addr_t


399 
	$dma_m≠_sögÀ
(
devi˚
 *
dev
, *
±r
, 
size_t
 
size
,

400 
dma_d©a_dúe˘i⁄
 
dú
)

402 
dma_addr_t
 
dma_addr
;

404 
	`dev_dbg
(
dev
, "%s(ptr=%p,size=%d,dir=%x)\n",

405 
__func__
, 
±r
, 
size
, 
dú
);

407 
	`BUG_ON
(
dú
 =
DMA_NONE
);

409 
dma_addr
 = 
	`m≠_sögÀ
(
dev
, 
±r
, 
size
, 
dú
);

411  
dma_addr
;

412 
	}
}

422 
	$dma_unm≠_sögÀ
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

423 
dma_d©a_dúe˘i⁄
 
dú
)

425 
	`dev_dbg
(
dev
, "%s(ptr=%p,size=%d,dir=%x)\n",

426 
__func__
, (*Ë
dma_addr
, 
size
, 
dú
);

428 
	`BUG_ON
(
dú
 =
DMA_NONE
);

430 
	`unm≠_sögÀ
(
dev
, 
dma_addr
, 
size
, 
dú
);

431 
	}
}

434 
	$dma_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

435 
dma_d©a_dúe˘i⁄
 
dú
)

437 
i
;

439 
	`dev_dbg
(
dev
, "%s(sg=%p,nents=%d,dir=%x)\n",

440 
__func__
, 
sg
, 
√¡s
, 
dú
);

442 
	`BUG_ON
(
dú
 =
DMA_NONE
);

444 
i
 = 0; i < 
√¡s
; i++, 
sg
++) {

445 
∑ge
 *∑gê
sg
->page;

446 
off£t
 = 
sg
->offset;

447 
Àngth
 = 
sg
->length;

448 *
±r
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
;

450 
sg
->
dma_addªss
 =

451 
	`m≠_sögÀ
(
dev
, 
±r
, 
Àngth
, 
dú
);

454  
√¡s
;

455 
	}
}

458 
	$dma_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

459 
dma_d©a_dúe˘i⁄
 
dú
)

461 
i
;

463 
	`dev_dbg
(
dev
, "%s(sg=%p,nents=%d,dir=%x)\n",

464 
__func__
, 
sg
, 
√¡s
, 
dú
);

466 
	`BUG_ON
(
dú
 =
DMA_NONE
);

468 
i
 = 0; i < 
√¡s
; i++, 
sg
++) {

469 
dma_addr_t
 
dma_addr
 = 
sg
->
dma_addªss
;

470 
Àngth
 = 
sg
->length;

472 
	`unm≠_sögÀ
(
dev
, 
dma_addr
, 
Àngth
, 
dú
);

474 
	}
}

477 
	$dma_sync_sögÀ_f‹_˝u
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

478 
dma_d©a_dúe˘i⁄
 
dú
)

480 
	`dev_dbg
(
dev
, "%s(ptr=%p,size=%d,dir=%x)\n",

481 
__func__
, (*Ë
dma_addr
, 
size
, 
dú
);

483 
	`sync_sögÀ
(
dev
, 
dma_addr
, 
size
, 
dú
);

484 
	}
}

487 
	$dma_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
,

488 
dma_d©a_dúe˘i⁄
 
dú
)

490 
	`dev_dbg
(
dev
, "%s(ptr=%p,size=%d,dir=%x)\n",

491 
__func__
, (*Ë
dma_addr
, 
size
, 
dú
);

493 
	`sync_sögÀ
(
dev
, 
dma_addr
, 
size
, 
dú
);

494 
	}
}

497 
	$dma_sync_sg_f‹_˝u
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

498 
dma_d©a_dúe˘i⁄
 
dú
)

500 
i
;

502 
	`dev_dbg
(
dev
, "%s(sg=%p,nents=%d,dir=%x)\n",

503 
__func__
, 
sg
, 
√¡s
, 
dú
);

505 
	`BUG_ON
(
dú
 =
DMA_NONE
);

507 
i
 = 0; i < 
√¡s
; i++, 
sg
++) {

508 
dma_addr_t
 
dma_addr
 = 
sg
->
dma_addªss
;

509 
Àngth
 = 
sg
->length;

511 
	`sync_sögÀ
(
dev
, 
dma_addr
, 
Àngth
, 
dú
);

513 
	}
}

516 
	$dma_sync_sg_f‹_devi˚
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

517 
dma_d©a_dúe˘i⁄
 
dú
)

519 
i
;

521 
	`dev_dbg
(
dev
, "%s(sg=%p,nents=%d,dir=%x)\n",

522 
__func__
, 
sg
, 
√¡s
, 
dú
);

524 
	`BUG_ON
(
dú
 =
DMA_NONE
);

526 
i
 = 0; i < 
√¡s
; i++, 
sg
++) {

527 
dma_addr_t
 
dma_addr
 = 
sg
->
dma_addªss
;

528 
Àngth
 = 
sg
->length;

530 
	`sync_sögÀ
(
dev
, 
dma_addr
, 
Àngth
, 
dú
);

532 
	}
}

535 
	$dmaboun˚_öô_poﬁ
(
dmaboun˚_poﬁ
 *
poﬁ
, 
devi˚
 *
dev
, c⁄° *
«me
,

536 
size
)

538 
poﬁ
->
size
 = size;

539 
	`DO_STATS
(
poﬁ
->
Ælocs
 = 0);

540 
poﬁ
->poﬁ = 
	`dma_poﬁ_¸óã
(
«me
, 
dev
, 
size
,

544  
poﬁ
->poﬁ ? 0 : -
ENOMEM
;

545 
	}
}

548 
	$dmaboun˚_ªgi°î_dev
(
devi˚
 *
dev
, 
smÆl_buf„r_size
,

549 
œrge_buf„r_size
)

551 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
;

552 
ªt
;

554 
devi˚_öfo
 = 
	`kmÆloc
((
dmaboun˚_devi˚_öfo
), 
GFP_ATOMIC
);

555 i‡(!
devi˚_öfo
) {

556 
	`¥ötk
(
KERN_ERR


558 
dev
->
bus_id
);

559  -
ENOMEM
;

562 
ªt
 = 
	`dmaboun˚_öô_poﬁ
(&
devi˚_öfo
->
smÆl
, 
dev
,

563 "smÆl_dmaboun˚_poﬁ", 
smÆl_buf„r_size
);

564 i‡(
ªt
) {

565 
	`dev_îr
(
dev
,

567 
smÆl_buf„r_size
);

568 
îr_‰ì
;

571 i‡(
œrge_buf„r_size
) {

572 
ªt
 = 
	`dmaboun˚_öô_poﬁ
(&
devi˚_öfo
->
œrge
, 
dev
,

574 
œrge_buf„r_size
);

575 i‡(
ªt
) {

576 
	`dev_îr
(
dev
,

578 
œrge_buf„r_size
);

579 
îr_de°roy
;

583 
devi˚_öfo
->
dev
 = dev;

584 
	`INIT_LIST_HEAD
(&
devi˚_öfo
->
ß„_buf„rs
);

585 
	`rwlock_öô
(&
devi˚_öfo
->
lock
);

587 #ifde‡
STATS


588 
devi˚_öfo
->
tŸÆ_Ælocs
 = 0;

589 
devi˚_öfo
->
m≠_›_cou¡
 = 0;

590 
devi˚_öfo
->
boun˚_cou¡
 = 0;

591 
devi˚_öfo
->
©å_ªs
 = 
	`devi˚_¸óã_fûe
(
dev
, &
dev_©å_dmaboun˚_°©s
);

594 
dev
->
¨chd©a
.
dmaboun˚
 = 
devi˚_öfo
;

596 
	`¥ötk
(
KERN_INFO
 "dmabounce:Ñegistered device %s on %s bus\n",

597 
dev
->
bus_id
, dev->
bus
->
«me
);

601 
îr_de°roy
:

602 
	`dma_poﬁ_de°roy
(
devi˚_öfo
->
smÆl
.
poﬁ
);

603 
îr_‰ì
:

604 
	`k‰ì
(
devi˚_öfo
);

605  
ªt
;

606 
	}
}

609 
	$dmaboun˚_uƒegi°î_dev
(
devi˚
 *
dev
)

611 
dmaboun˚_devi˚_öfo
 *
devi˚_öfo
 = 
dev
->
¨chd©a
.
dmaboun˚
;

613 
dev
->
¨chd©a
.
dmaboun˚
 = 
NULL
;

615 i‡(!
devi˚_öfo
) {

616 
	`¥ötk
(
KERN_WARNING


618 "tÿuƒegi°î!\n", 
dev
->
bus_id
);

622 i‡(!
	`li°_em±y
(&
devi˚_öfo
->
ß„_buf„rs
)) {

623 
	`¥ötk
(
KERN_ERR


625 
dev
->
bus_id
);

626 
	`BUG
();

629 i‡(
devi˚_öfo
->
smÆl
.
poﬁ
)

630 
	`dma_poﬁ_de°roy
(
devi˚_öfo
->
smÆl
.
poﬁ
);

631 i‡(
devi˚_öfo
->
œrge
.
poﬁ
)

632 
	`dma_poﬁ_de°roy
(
devi˚_öfo
->
œrge
.
poﬁ
);

634 #ifde‡
STATS


635 i‡(
devi˚_öfo
->
©å_ªs
 == 0)

636 
	`devi˚_ªmove_fûe
(
dev
, &
dev_©å_dmaboun˚_°©s
);

639 
	`k‰ì
(
devi˚_öfo
);

641 
	`¥ötk
(
KERN_INFO
 "dmabounce: device %s on %s bus unregistered\n",

642 
dev
->
bus_id
, dev->
bus
->
«me
);

643 
	}
}

646 
EXPORT_SYMBOL
(
dma_m≠_sögÀ
);

647 
EXPORT_SYMBOL
(
dma_unm≠_sögÀ
);

648 
EXPORT_SYMBOL
(
dma_m≠_sg
);

649 
EXPORT_SYMBOL
(
dma_unm≠_sg
);

650 
EXPORT_SYMBOL
(
dma_sync_sögÀ_f‹_˝u
);

651 
EXPORT_SYMBOL
(
dma_sync_sögÀ_f‹_devi˚
);

652 
EXPORT_SYMBOL
(
dma_sync_sg
);

653 
EXPORT_SYMBOL
(
dmaboun˚_ªgi°î_dev
);

654 
EXPORT_SYMBOL
(
dmaboun˚_uƒegi°î_dev
);

656 
MODULE_AUTHOR
("Christopher Hoover <ch@hpl.hp.com>, Deepak Saxena <dsaxena@plexity.net>");

657 
MODULE_DESCRIPTION
("Special dma_{map/unmap/dma_sync}_*Ñoutines for systems withÜimited DMA windows");

658 
MODULE_LICENSE
("GPL");

	@arch/arm/common/gic.c

25 
	~<löux/öô.h
>

26 
	~<löux/kî√l.h
>

27 
	~<löux/li°.h
>

28 
	~<löux/smp.h
>

29 
	~<löux/˝umask.h
>

31 
	~<asm/úq.h
>

32 
	~<asm/io.h
>

33 
	~<asm/mach/úq.h
>

34 
	~<asm/h¨dw¨e/gic.h
>

36 
DEFINE_SPINLOCK
(
úq_c⁄åﬁÀr_lock
);

38 
	sgic_chù_d©a
 {

39 
	múq_off£t
;

40 
__iomem
 *
	mdi°_ba£
;

41 
__iomem
 *
	m˝u_ba£
;

44 #i‚de‡
MAX_GIC_NR


45 
	#MAX_GIC_NR
 1

	)

48 
gic_chù_d©a
 
	ggic_d©a
[
MAX_GIC_NR
];

50 
ölöe
 
__iomem
 *
	$gic_di°_ba£
(
úq
)

52 
gic_chù_d©a
 *
gic_d©a
 = 
	`gë_úq_chù_d©a
(
úq
);

53  
gic_d©a
->
di°_ba£
;

54 
	}
}

56 
ölöe
 
__iomem
 *
	$gic_˝u_ba£
(
úq
)

58 
gic_chù_d©a
 *
gic_d©a
 = 
	`gë_úq_chù_d©a
(
úq
);

59  
gic_d©a
->
˝u_ba£
;

60 
	}
}

62 
ölöe
 
	$gic_úq
(
úq
)

64 
gic_chù_d©a
 *
gic_d©a
 = 
	`gë_úq_chù_d©a
(
úq
);

65  
úq
 - 
gic_d©a
->
úq_off£t
;

66 
	}
}

83 
	$gic_ack_úq
(
úq
)

85 
u32
 
mask
 = 1 << (
úq
 % 32);

87 
	`•ö_lock
(&
úq_c⁄åﬁÀr_lock
);

88 
	`wrôñ
(
mask
, 
	`gic_di°_ba£
(
úq
Ë+ 
GIC_DIST_ENABLE_CLEAR
 + (
	`gic_úq
(irq) / 32) * 4);

89 
	`wrôñ
(
	`gic_úq
(
úq
), 
	`gic_˝u_ba£
(úqË+ 
GIC_CPU_EOI
);

90 
	`•ö_u∆ock
(&
úq_c⁄åﬁÀr_lock
);

91 
	}
}

93 
	$gic_mask_úq
(
úq
)

95 
u32
 
mask
 = 1 << (
úq
 % 32);

97 
	`•ö_lock
(&
úq_c⁄åﬁÀr_lock
);

98 
	`wrôñ
(
mask
, 
	`gic_di°_ba£
(
úq
Ë+ 
GIC_DIST_ENABLE_CLEAR
 + (
	`gic_úq
(irq) / 32) * 4);

99 
	`•ö_u∆ock
(&
úq_c⁄åﬁÀr_lock
);

100 
	}
}

102 
	$gic_unmask_úq
(
úq
)

104 
u32
 
mask
 = 1 << (
úq
 % 32);

106 
	`•ö_lock
(&
úq_c⁄åﬁÀr_lock
);

107 
	`wrôñ
(
mask
, 
	`gic_di°_ba£
(
úq
Ë+ 
GIC_DIST_ENABLE_SET
 + (
	`gic_úq
(irq) / 32) * 4);

108 
	`•ö_u∆ock
(&
úq_c⁄åﬁÀr_lock
);

109 
	}
}

111 #ifde‡
CONFIG_SMP


112 
	$gic_£t_˝u
(
úq
, 
˝umask_t
 
mask_vÆ
)

114 
__iomem
 *
ªg
 = 
	`gic_di°_ba£
(
úq
Ë+ 
GIC_DIST_TARGET
 + (
	`gic_úq
(irq) & ~3);

115 
shi·
 = (
úq
 % 4) * 8;

116 
˝u
 = 
	`fú°_˝u
(
mask_vÆ
);

117 
u32
 
vÆ
;

119 
	`•ö_lock
(&
úq_c⁄åﬁÀr_lock
);

120 
úq_desc
[
úq
].
˝u
 = cpu;

121 
vÆ
 = 
	`ªadl
(
ªg
Ë& ~(0xf‡<< 
shi·
);

122 
vÆ
 |1 << (
˝u
 + 
shi·
);

123 
	`wrôñ
(
vÆ
, 
ªg
);

124 
	`•ö_u∆ock
(&
úq_c⁄åﬁÀr_lock
);

125 
	}
}

128 
	$gic_h™dÀ_ˇsˇde_úq
(
úq
, 
úq_desc
 *
desc
)

130 
gic_chù_d©a
 *
chù_d©a
 = 
	`gë_úq_d©a
(
úq
);

131 
úq_chù
 *
chù
 = 
	`gë_úq_chù
(
úq
);

132 
ˇsˇde_úq
, 
gic_úq
;

133 
°©us
;

136 
chù
->
	`ack
(
úq
);

138 
	`•ö_lock
(&
úq_c⁄åﬁÀr_lock
);

139 
°©us
 = 
	`ªadl
(
chù_d©a
->
˝u_ba£
 + 
GIC_CPU_INTACK
);

140 
	`•ö_u∆ock
(&
úq_c⁄åﬁÀr_lock
);

142 
gic_úq
 = (
°©us
 & 0x3ff);

143 i‡(
gic_úq
 == 1023)

144 
out
;

146 
ˇsˇde_úq
 = 
gic_úq
 + 
chù_d©a
->
úq_off£t
;

147 i‡(
	`u∆ikñy
(
gic_úq
 < 32 || gic_úq > 1020 || 
ˇsˇde_úq
 >
NR_IRQS
))

148 
	`do_bad_IRQ
(
ˇsˇde_úq
, 
desc
);

150 
	`gíîic_h™dÀ_úq
(
ˇsˇde_úq
);

152 
out
:

154 
chù
->
	`unmask
(
úq
);

155 
	}
}

157 
úq_chù
 
	ggic_chù
 = {

158 .
«me
 = "GIC",

159 .
	gack
 = 
gic_ack_úq
,

160 .
	gmask
 = 
gic_mask_úq
,

161 .
	gunmask
 = 
gic_unmask_úq
,

162 #ifde‡
CONFIG_SMP


163 .
	g£t_afföôy
 = 
gic_£t_˝u
,

167 
__öô
 
	$gic_ˇsˇde_úq
(
gic_ƒ
, 
úq
)

169 i‡(
gic_ƒ
 >
MAX_GIC_NR
)

170 
	`BUG
();

171 i‡(
	`£t_úq_d©a
(
úq
, &
gic_d©a
[
gic_ƒ
]) != 0)

172 
	`BUG
();

173 
	`£t_úq_chaöed_h™dÀr
(
úq
, 
gic_h™dÀ_ˇsˇde_úq
);

174 
	}
}

176 
__öô
 
	$gic_di°_öô
(
gic_ƒ
, 
__iomem
 *
ba£
,

177 
úq_°¨t
)

179 
max_úq
, 
i
;

180 
u32
 
˝umask
 = 1 << 
	`smp_¥o˚ss‹_id
();

182 i‡(
gic_ƒ
 >
MAX_GIC_NR
)

183 
	`BUG
();

185 
˝umask
 |= cpumask << 8;

186 
˝umask
 |= cpumask << 16;

188 
gic_d©a
[
gic_ƒ
].
di°_ba£
 = 
ba£
;

189 
gic_d©a
[
gic_ƒ
].
úq_off£t
 = (
úq_°¨t
 - 1) & ~31;

191 
	`wrôñ
(0, 
ba£
 + 
GIC_DIST_CTRL
);

196 
max_úq
 = 
	`ªadl
(
ba£
 + 
GIC_DIST_CTR
) & 0x1f;

197 
max_úq
 = (max_irq + 1) * 32;

204 i‡(
max_úq
 > 
	`max
(1020, 
NR_IRQS
))

205 
max_úq
 = 
	`max
(1020, 
NR_IRQS
);

210 
i
 = 32; i < 
max_úq
; i += 16)

211 
	`wrôñ
(0, 
ba£
 + 
GIC_DIST_CONFIG
 + 
i
 * 4 / 16);

216 
i
 = 32; i < 
max_úq
; i += 4)

217 
	`wrôñ
(
˝umask
, 
ba£
 + 
GIC_DIST_TARGET
 + 
i
 * 4 / 4);

222 
i
 = 0; i < 
max_úq
; i += 4)

223 
	`wrôñ
(0xa0a0a0a0, 
ba£
 + 
GIC_DIST_PRI
 + 
i
 * 4 / 4);

228 
i
 = 0; i < 
max_úq
; i += 32)

229 
	`wrôñ
(0xffffffff, 
ba£
 + 
GIC_DIST_ENABLE_CLEAR
 + 
i
 * 4 / 32);

234 
i
 = 
úq_°¨t
; i < 
gic_d©a
[
gic_ƒ
].
úq_off£t
 + 
max_úq
; i++) {

235 
	`£t_úq_chù
(
i
, &
gic_chù
);

236 
	`£t_úq_chù_d©a
(
i
, &
gic_d©a
[
gic_ƒ
]);

237 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

238 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

241 
	`wrôñ
(1, 
ba£
 + 
GIC_DIST_CTRL
);

242 
	}
}

244 
__˝uöô
 
	$gic_˝u_öô
(
gic_ƒ
, 
__iomem
 *
ba£
)

246 i‡(
gic_ƒ
 >
MAX_GIC_NR
)

247 
	`BUG
();

249 
gic_d©a
[
gic_ƒ
].
˝u_ba£
 = 
ba£
;

251 
	`wrôñ
(0xf0, 
ba£
 + 
GIC_CPU_PRIMASK
);

252 
	`wrôñ
(1, 
ba£
 + 
GIC_CPU_CTRL
);

253 
	}
}

255 #ifde‡
CONFIG_SMP


256 
	$gic_øi£_so·úq
(
˝umask_t
 
˝umask
, 
úq
)

258 
m≠
 = *
	`˝us_addr
(
˝umask
);

261 
	`wrôñ
(
m≠
 << 16 | 
úq
, 
gic_d©a
[0].
di°_ba£
 + 
GIC_DIST_SOFTINT
);

262 
	}
}

	@arch/arm/common/icst307.c

17 
	~<löux/moduÀ.h
>

18 
	~<löux/kî√l.h
>

20 
	~<asm/h¨dw¨e/ic°307.h
>

25 
	gs2div
[8] = { 10, 2, 8, 4, 5, 7, 3, 6 };

27 
	$ic°307_khz
(c⁄° 
ic°307_∑øms
 *
p
, 
ic°307_vco
 
vco
)

29  
p
->
ªf
 * 2 * (
vco
.
v
 + 8Ë/ ((vco.
r
 + 2Ë* 
s2div
[vco.
s
]);

30 
	}
}

32 
EXPORT_SYMBOL
(
ic°307_khz
);

37 
	gidx2s
[8] = { 1, 6, 3, 4, 7, 5, 2, 0 };

39 
ic°307_vco


40 
	$ic°307_khz_to_vco
(c⁄° 
ic°307_∑øms
 *
p
, 
‰eq
)

42 
ic°307_vco
 
vco
 = { .
s
 = 1, .
v
 = 
p
->
vd_max
, .
r
 =Ö->
rd_max
 };

43 
f
;

44 
i
 = 0, 
rd
, 
be°
 = ()-1;

51 
f
 = 
‰eq
 * 
s2div
[
idx2s
[
i
]];

56 i‡(
f
 > 6000 && f <
p
->
vco_max
)

58 } 
i
 < 
	`ARRAY_SIZE
(
idx2s
));

60 i‡(
i
 >
	`ARRAY_SIZE
(
idx2s
))

61  
vco
;

63 
vco
.
s
 = 
idx2s
[
i
];

69 
rd
 = 
p
->
rd_mö
;Ñd <p->
rd_max
;Ñd++) {

70 
‰ef_div
, 
f_∂l
;

71 
vd
;

72 
f_diff
;

74 
‰ef_div
 = (2 * 
p
->
ªf
Ë/ 
rd
;

76 
vd
 = (
f
 + 
‰ef_div
 / 2) / fref_div;

77 i‡(
vd
 < 
p
->
vd_mö
 || vd >Ö->
vd_max
)

80 
f_∂l
 = 
‰ef_div
 * 
vd
;

81 
f_diff
 = 
f_∂l
 - 
f
;

82 i‡(
f_diff
 < 0)

83 
f_diff
 = -f_diff;

85 i‡(()
f_diff
 < 
be°
) {

86 
vco
.
v
 = 
vd
 - 8;

87 
vco
.
r
 = 
rd
 - 2;

88 i‡(
f_diff
 == 0)

90 
be°
 = 
f_diff
;

94  
vco
;

95 
	}
}

97 
EXPORT_SYMBOL
(
ic°307_khz_to_vco
);

99 
ic°307_vco


100 
	$ic°307_ps_to_vco
(c⁄° 
ic°307_∑øms
 *
p
, 
≥riod
)

102 
ic°307_vco
 
vco
 = { .
s
 = 1, .
v
 = 
p
->
vd_max
, .
r
 =Ö->
rd_max
 };

103 
f
, 
ps
;

104 
i
 = 0, 
rd
, 
be°
 = ()-1;

106 
ps
 = 1000000000UL / 
p
->
vco_max
;

113 
f
 = 
≥riod
 / 
s2div
[
idx2s
[
i
]];

118 i‡(
f
 >
ps
 && f < 1000000000UL / 6000 + 1)

120 } 
i
 < 
	`ARRAY_SIZE
(
idx2s
));

122 i‡(
i
 >
	`ARRAY_SIZE
(
idx2s
))

123  
vco
;

125 
vco
.
s
 = 
idx2s
[
i
];

127 
ps
 = 500000000UL / 
p
->
ªf
;

133 
rd
 = 
p
->
rd_mö
;Ñd <p->
rd_max
;Ñd++) {

134 
f_ö_div
, 
f_∂l
;

135 
vd
;

136 
f_diff
;

138 
f_ö_div
 = 
ps
 * 
rd
;

140 
vd
 = (
f_ö_div
 + 
f
 / 2) / f;

141 i‡(
vd
 < 
p
->
vd_mö
 || vd >Ö->
vd_max
)

144 
f_∂l
 = (
f_ö_div
 + 
vd
 / 2) / vd;

145 
f_diff
 = 
f_∂l
 - 
f
;

146 i‡(
f_diff
 < 0)

147 
f_diff
 = -f_diff;

149 i‡(()
f_diff
 < 
be°
) {

150 
vco
.
v
 = 
vd
 - 8;

151 
vco
.
r
 = 
rd
 - 2;

152 i‡(
f_diff
 == 0)

154 
be°
 = 
f_diff
;

158  
vco
;

159 
	}
}

161 
EXPORT_SYMBOL
(
ic°307_ps_to_vco
);

	@arch/arm/common/icst525.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

17 
	~<asm/h¨dw¨e/ic°525.h
>

22 
	gs2div
[8] = { 10, 2, 8, 4, 5, 7, 9, 6 };

24 
	$ic°525_khz
(c⁄° 
ic°525_∑øms
 *
p
, 
ic°525_vco
 
vco
)

26  
p
->
ªf
 * 2 * (
vco
.
v
 + 8Ë/ ((vco.
r
 + 2Ë* 
s2div
[vco.
s
]);

27 
	}
}

29 
EXPORT_SYMBOL
(
ic°525_khz
);

34 
	gidx2s
[] = { 1, 3, 4, 7, 5, 2, 6, 0 };

36 
ic°525_vco


37 
	$ic°525_khz_to_vco
(c⁄° 
ic°525_∑øms
 *
p
, 
‰eq
)

39 
ic°525_vco
 
vco
 = { .
s
 = 1, .
v
 = 
p
->
vd_max
, .
r
 =Ö->
rd_max
 };

40 
f
;

41 
i
 = 0, 
rd
, 
be°
 = ()-1;

48 
f
 = 
‰eq
 * 
s2div
[
idx2s
[
i
]];

54 i‡(
f
 > 10000 && f <
p
->
vco_max
)

56 } 
i
 < 
	`ARRAY_SIZE
(
idx2s
));

58 i‡(
i
 >
	`ARRAY_SIZE
(
idx2s
))

59  
vco
;

61 
vco
.
s
 = 
idx2s
[
i
];

67 
rd
 = 
p
->
rd_mö
;Ñd <p->
rd_max
;Ñd++) {

68 
‰ef_div
, 
f_∂l
;

69 
vd
;

70 
f_diff
;

72 
‰ef_div
 = (2 * 
p
->
ªf
Ë/ 
rd
;

74 
vd
 = (
f
 + 
‰ef_div
 / 2) / fref_div;

75 i‡(
vd
 < 
p
->
vd_mö
 || vd >Ö->
vd_max
)

78 
f_∂l
 = 
‰ef_div
 * 
vd
;

79 
f_diff
 = 
f_∂l
 - 
f
;

80 i‡(
f_diff
 < 0)

81 
f_diff
 = -f_diff;

83 i‡(()
f_diff
 < 
be°
) {

84 
vco
.
v
 = 
vd
 - 8;

85 
vco
.
r
 = 
rd
 - 2;

86 i‡(
f_diff
 == 0)

88 
be°
 = 
f_diff
;

92  
vco
;

93 
	}
}

95 
EXPORT_SYMBOL
(
ic°525_khz_to_vco
);

97 
ic°525_vco


98 
	$ic°525_ps_to_vco
(c⁄° 
ic°525_∑øms
 *
p
, 
≥riod
)

100 
ic°525_vco
 
vco
 = { .
s
 = 1, .
v
 = 
p
->
vd_max
, .
r
 =Ö->
rd_max
 };

101 
f
, 
ps
;

102 
i
 = 0, 
rd
, 
be°
 = ()-1;

104 
ps
 = 1000000000UL / 
p
->
vco_max
;

111 
f
 = 
≥riod
 / 
s2div
[
idx2s
[
i
]];

117 i‡(
f
 >
ps
 && f < 100000)

119 } 
i
 < 
	`ARRAY_SIZE
(
idx2s
));

121 i‡(
i
 >
	`ARRAY_SIZE
(
idx2s
))

122  
vco
;

124 
vco
.
s
 = 
idx2s
[
i
];

126 
ps
 = 500000000UL / 
p
->
ªf
;

132 
rd
 = 
p
->
rd_mö
;Ñd <p->
rd_max
;Ñd++) {

133 
f_ö_div
, 
f_∂l
;

134 
vd
;

135 
f_diff
;

137 
f_ö_div
 = 
ps
 * 
rd
;

139 
vd
 = (
f_ö_div
 + 
f
 / 2) / f;

140 i‡(
vd
 < 
p
->
vd_mö
 || vd >Ö->
vd_max
)

143 
f_∂l
 = (
f_ö_div
 + 
vd
 / 2) / vd;

144 
f_diff
 = 
f_∂l
 - 
f
;

145 i‡(
f_diff
 < 0)

146 
f_diff
 = -f_diff;

148 i‡(()
f_diff
 < 
be°
) {

149 
vco
.
v
 = 
vd
 - 8;

150 
vco
.
r
 = 
rd
 - 2;

151 i‡(
f_diff
 == 0)

153 
be°
 = 
f_diff
;

157  
vco
;

158 
	}
}

160 
EXPORT_SYMBOL
(
ic°525_ps_to_vco
);

	@arch/arm/common/locomo.c

18 
	~<löux/moduÀ.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/î∫o.h
>

23 
	~<löux/i›‹t.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/•ölock.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/io.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/mach/úq.h
>

33 
	~<asm/h¨dw¨e/locomo.h
>

36 
	#M62332_EVR_CH
 1

	)

39 
	#M62332_SLAVE_ADDR
 0x4ê

	)

40 
	#M62332_W_BIT
 0x00

	)

41 
	#M62332_SUB_ADDR
 0x00

	)

42 
	#M62332_A_BIT
 0x00

	)

45 
	#DAC_BUS_FREE_TIME
 5

	)

46 
	#DAC_START_SETUP_TIME
 5

	)

47 
	#DAC_STOP_SETUP_TIME
 4

	)

48 
	#DAC_START_HOLD_TIME
 5

	)

49 
	#DAC_SCL_LOW_HOLD_TIME
 5

	)

50 
	#DAC_SCL_HIGH_HOLD_TIME
 4

	)

51 
	#DAC_DATA_SETUP_TIME
 1

	)

52 
	#DAC_DATA_HOLD_TIME
 1

	)

53 
	#DAC_LOW_SETUP_TIME
 1

	)

54 
	#DAC_HIGH_SETUP_TIME
 1

	)

57 
	slocomo
 {

58 
devi˚
 *
	mdev
;

59 
	mphys
;

60 
	múq
;

61 
•ölock_t
 
	mlock
;

62 
__iomem
 *
	mba£
;

65 
	slocomo_dev_öfo
 {

66 
	moff£t
;

67 
	mÀngth
;

68 
	mdevid
;

69 
	múq
[1];

70 c⁄° * 
	m«me
;

78 
locomo_dev_öfo
 
	glocomo_devi˚s
[] = {

80 .
devid
 = 
LOCOMO_DEVID_KEYBOARD
,

81 .
	gúq
 = {

82 
IRQ_LOCOMO_KEY
,

84 .
	g«me
 = "locomo-keyboard",

85 .
	goff£t
 = 
LOCOMO_KEYBOARD
,

86 .
	gÀngth
 = 16,

89 .
	gdevid
 = 
LOCOMO_DEVID_FRONTLIGHT
,

90 .
	gúq
 = {},

91 .
	g«me
 = "locomo-frontlight",

92 .
	goff£t
 = 
LOCOMO_FRONTLIGHT
,

93 .
	gÀngth
 = 8,

97 .
	gdevid
 = 
LOCOMO_DEVID_BACKLIGHT
,

98 .
	gúq
 = {},

99 .
	g«me
 = "locomo-backlight",

100 .
	goff£t
 = 
LOCOMO_BACKLIGHT
,

101 .
	gÀngth
 = 8,

104 .
	gdevid
 = 
LOCOMO_DEVID_AUDIO
,

105 .
	gúq
 = {},

106 .
	g«me
 = "locomo-audio",

107 .
	goff£t
 = 
LOCOMO_AUDIO
,

108 .
	gÀngth
 = 4,

111 .
	gdevid
 = 
LOCOMO_DEVID_LED
,

112 .
	gúq
 = {},

113 .
	g«me
 = "locomo-led",

114 .
	goff£t
 = 
LOCOMO_LED
,

115 .
	gÀngth
 = 8,

118 .
	gdevid
 = 
LOCOMO_DEVID_UART
,

119 .
	gúq
 = {},

120 .
	g«me
 = "locomo-uart",

121 .
	goff£t
 = 0,

122 .
	gÀngth
 = 0,

125 .
	gdevid
 = 
LOCOMO_DEVID_SPI
,

126 .
	gúq
 = {},

127 .
	g«me
 = "locomo-spi",

128 .
	goff£t
 = 
LOCOMO_SPI
,

129 .
	gÀngth
 = 0x30,

160 
	#LOCOMO_IRQ_START
 (
IRQ_LOCOMO_KEY_BASE
)

	)

161 
	#LOCOMO_IRQ_KEY_START
 (
IRQ_LOCOMO_KEY
)

	)

162 
	#LOCOMO_IRQ_GPIO_START
 (
IRQ_LOCOMO_GPIO0
)

	)

163 
	#LOCOMO_IRQ_LT_START
 (
IRQ_LOCOMO_LT
)

	)

164 
	#LOCOMO_IRQ_SPI_START
 (
IRQ_LOCOMO_SPI_RFR
)

	)

166 
	$locomo_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

168 
ªq
, 
i
;

169 
úq_desc
 *
d
;

170 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

173 
desc
->
chù
->
	`ack
(
úq
);

176 
ªq
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_ICR
) & 0x0f00;

178 i‡(
ªq
) {

180 
úq
 = 
LOCOMO_IRQ_START
;

181 
d
 = 
úq_desc
 + 
úq
;

182 
i
 = 0; i <3; i++, 
d
++, 
úq
++) {

183 i‡(
ªq
 & (0x0100 << 
i
)) {

184 
	`desc_h™dÀ_úq
(
úq
, 
d
);

189 
	}
}

191 
	$locomo_ack_úq
(
úq
)

193 
	}
}

195 
	$locomo_mask_úq
(
úq
)

197 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

198 
r
;

199 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_ICR
);

200 
r
 &~(0x0010 << (
úq
 - 
LOCOMO_IRQ_START
));

201 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_ICR
);

202 
	}
}

204 
	$locomo_unmask_úq
(
úq
)

206 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

207 
r
;

208 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_ICR
);

209 
r
 |(0x0010 << (
úq
 - 
LOCOMO_IRQ_START
));

210 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_ICR
);

211 
	}
}

213 
úq_chù
 
	glocomo_chù
 = {

214 .
«me
 = "LOCOMO",

215 .
	gack
 = 
locomo_ack_úq
,

216 .
	gmask
 = 
locomo_mask_úq
,

217 .
	gunmask
 = 
locomo_unmask_úq
,

220 
	$locomo_key_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

222 
úq_desc
 *
d
;

223 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

225 i‡(
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
) & 0x0001) {

226 
d
 = 
úq_desc
 + 
LOCOMO_IRQ_KEY_START
;

227 
	`desc_h™dÀ_úq
(
LOCOMO_IRQ_KEY_START
, 
d
);

229 
	}
}

231 
	$locomo_key_ack_úq
(
úq
)

233 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

234 
r
;

235 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

236 
r
 &~(0x0100 << (
úq
 - 
LOCOMO_IRQ_KEY_START
));

237 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

238 
	}
}

240 
	$locomo_key_mask_úq
(
úq
)

242 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

243 
r
;

244 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

245 
r
 &~(0x0010 << (
úq
 - 
LOCOMO_IRQ_KEY_START
));

246 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

247 
	}
}

249 
	$locomo_key_unmask_úq
(
úq
)

251 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

252 
r
;

253 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

254 
r
 |(0x0010 << (
úq
 - 
LOCOMO_IRQ_KEY_START
));

255 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

256 
	}
}

258 
úq_chù
 
	glocomo_key_chù
 = {

259 .
«me
 = "LOCOMO-key",

260 .
	gack
 = 
locomo_key_ack_úq
,

261 .
	gmask
 = 
locomo_key_mask_úq
,

262 .
	gunmask
 = 
locomo_key_unmask_úq
,

265 
	$locomo_gpio_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

267 
ªq
, 
i
;

268 
úq_desc
 *
d
;

269 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

271 
ªq
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GIR
) &

272 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GPD
) &

275 i‡(
ªq
) {

276 
úq
 = 
LOCOMO_IRQ_GPIO_START
;

277 
d
 = 
úq_desc
 + 
LOCOMO_IRQ_GPIO_START
;

278 
i
 = 0; i <15; i++, 
úq
++, 
d
++) {

279 i‡(
ªq
 & (0x0001 << 
i
)) {

280 
	`desc_h™dÀ_úq
(
úq
, 
d
);

284 
	}
}

286 
	$locomo_gpio_ack_úq
(
úq
)

288 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

289 
r
;

290 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GWE
);

291 
r
 |(0x0001 << (
úq
 - 
LOCOMO_IRQ_GPIO_START
));

292 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_GWE
);

294 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GIS
);

295 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_GPIO_START
));

296 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_GIS
);

298 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GWE
);

299 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_GPIO_START
));

300 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_GWE
);

301 
	}
}

303 
	$locomo_gpio_mask_úq
(
úq
)

305 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

306 
r
;

307 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GIE
);

308 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_GPIO_START
));

309 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_GIE
);

310 
	}
}

312 
	$locomo_gpio_unmask_úq
(
úq
)

314 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

315 
r
;

316 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_GIE
);

317 
r
 |(0x0001 << (
úq
 - 
LOCOMO_IRQ_GPIO_START
));

318 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_GIE
);

319 
	}
}

321 
úq_chù
 
	glocomo_gpio_chù
 = {

322 .
«me
 = "LOCOMO-gpio",

323 .
	gack
 = 
locomo_gpio_ack_úq
,

324 .
	gmask
 = 
locomo_gpio_mask_úq
,

325 .
	gunmask
 = 
locomo_gpio_unmask_úq
,

328 
	$locomo_…_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

330 
úq_desc
 *
d
;

331 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

333 i‡(
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_LTINT
) & 0x0001) {

334 
d
 = 
úq_desc
 + 
LOCOMO_IRQ_LT_START
;

335 
	`desc_h™dÀ_úq
(
LOCOMO_IRQ_LT_START
, 
d
);

337 
	}
}

339 
	$locomo_…_ack_úq
(
úq
)

341 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

342 
r
;

343 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_LTINT
);

344 
r
 &~(0x0100 << (
úq
 - 
LOCOMO_IRQ_LT_START
));

345 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_LTINT
);

346 
	}
}

348 
	$locomo_…_mask_úq
(
úq
)

350 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

351 
r
;

352 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_LTINT
);

353 
r
 &~(0x0010 << (
úq
 - 
LOCOMO_IRQ_LT_START
));

354 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_LTINT
);

355 
	}
}

357 
	$locomo_…_unmask_úq
(
úq
)

359 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

360 
r
;

361 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_LTINT
);

362 
r
 |(0x0010 << (
úq
 - 
LOCOMO_IRQ_LT_START
));

363 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_LTINT
);

364 
	}
}

366 
úq_chù
 
	glocomo_…_chù
 = {

367 .
«me
 = "LOCOMO-lt",

368 .
	gack
 = 
locomo_…_ack_úq
,

369 .
	gmask
 = 
locomo_…_mask_úq
,

370 .
	gunmask
 = 
locomo_…_unmask_úq
,

373 
	$locomo_•i_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

375 
ªq
, 
i
;

376 
úq_desc
 *
d
;

377 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

379 
ªq
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIR
) & 0x000F;

380 i‡(
ªq
) {

381 
úq
 = 
LOCOMO_IRQ_SPI_START
;

382 
d
 = 
úq_desc
 + 
úq
;

384 
i
 = 0; i <3; i++, 
úq
++, 
d
++) {

385 i‡(
ªq
 & (0x0001 << 
i
)) {

386 
	`desc_h™dÀ_úq
(
úq
, 
d
);

390 
	}
}

392 
	$locomo_•i_ack_úq
(
úq
)

394 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

395 
r
;

396 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIWE
);

397 
r
 |(0x0001 << (
úq
 - 
LOCOMO_IRQ_SPI_START
));

398 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIWE
);

400 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIS
);

401 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_SPI_START
));

402 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIS
);

404 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIWE
);

405 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_SPI_START
));

406 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIWE
);

407 
	}
}

409 
	$locomo_•i_mask_úq
(
úq
)

411 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

412 
r
;

413 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIE
);

414 
r
 &~(0x0001 << (
úq
 - 
LOCOMO_IRQ_SPI_START
));

415 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIE
);

416 
	}
}

418 
	$locomo_•i_unmask_úq
(
úq
)

420 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

421 
r
;

422 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIE
);

423 
r
 |(0x0001 << (
úq
 - 
LOCOMO_IRQ_SPI_START
));

424 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_SPI
 + 
LOCOMO_SPIIE
);

425 
	}
}

427 
úq_chù
 
	glocomo_•i_chù
 = {

428 .
«me
 = "LOCOMO-spi",

429 .
	gack
 = 
locomo_•i_ack_úq
,

430 .
	gmask
 = 
locomo_•i_mask_úq
,

431 .
	gunmask
 = 
locomo_•i_unmask_úq
,

434 
	$locomo_£tup_úq
(
locomo
 *
lchù
)

436 
úq
;

437 
__iomem
 *
úqba£
 = 
lchù
->
ba£
;

442 
	`£t_úq_ty≥
(
lchù
->
úq
, 
IRQT_FALLING
);

443 
	`£t_úq_chù_d©a
(
lchù
->
úq
, 
úqba£
);

444 
	`£t_úq_chaöed_h™dÀr
(
lchù
->
úq
, 
locomo_h™dÀr
);

447 
	`£t_úq_chù
(
IRQ_LOCOMO_KEY_BASE
, &
locomo_chù
);

448 
	`£t_úq_chù_d©a
(
IRQ_LOCOMO_KEY_BASE
, 
úqba£
);

449 
	`£t_úq_chaöed_h™dÀr
(
IRQ_LOCOMO_KEY_BASE
, 
locomo_key_h™dÀr
);

450 
	`£t_úq_Êags
(
IRQ_LOCOMO_KEY_BASE
, 
IRQF_VALID
 | 
IRQF_PROBE
);

452 
	`£t_úq_chù
(
IRQ_LOCOMO_GPIO_BASE
, &
locomo_chù
);

453 
	`£t_úq_chù_d©a
(
IRQ_LOCOMO_GPIO_BASE
, 
úqba£
);

454 
	`£t_úq_chaöed_h™dÀr
(
IRQ_LOCOMO_GPIO_BASE
, 
locomo_gpio_h™dÀr
);

455 
	`£t_úq_Êags
(
IRQ_LOCOMO_GPIO_BASE
, 
IRQF_VALID
 | 
IRQF_PROBE
);

457 
	`£t_úq_chù
(
IRQ_LOCOMO_LT_BASE
, &
locomo_chù
);

458 
	`£t_úq_chù_d©a
(
IRQ_LOCOMO_LT_BASE
, 
úqba£
);

459 
	`£t_úq_chaöed_h™dÀr
(
IRQ_LOCOMO_LT_BASE
, 
locomo_…_h™dÀr
);

460 
	`£t_úq_Êags
(
IRQ_LOCOMO_LT_BASE
, 
IRQF_VALID
 | 
IRQF_PROBE
);

462 
	`£t_úq_chù
(
IRQ_LOCOMO_SPI_BASE
, &
locomo_chù
);

463 
	`£t_úq_chù_d©a
(
IRQ_LOCOMO_SPI_BASE
, 
úqba£
);

464 
	`£t_úq_chaöed_h™dÀr
(
IRQ_LOCOMO_SPI_BASE
, 
locomo_•i_h™dÀr
);

465 
	`£t_úq_Êags
(
IRQ_LOCOMO_SPI_BASE
, 
IRQF_VALID
 | 
IRQF_PROBE
);

468 
	`£t_úq_chù
(
LOCOMO_IRQ_KEY_START
, &
locomo_key_chù
);

469 
	`£t_úq_chù_d©a
(
LOCOMO_IRQ_KEY_START
, 
úqba£
);

470 
	`£t_úq_h™dÀr
(
LOCOMO_IRQ_KEY_START
, 
h™dÀ_edge_úq
);

471 
	`£t_úq_Êags
(
LOCOMO_IRQ_KEY_START
, 
IRQF_VALID
 | 
IRQF_PROBE
);

474 
úq
 = 
LOCOMO_IRQ_GPIO_START
; irq < LOCOMO_IRQ_GPIO_START + 16; irq++) {

475 
	`£t_úq_chù
(
úq
, &
locomo_gpio_chù
);

476 
	`£t_úq_chù_d©a
(
úq
, 
úqba£
);

477 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

478 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

482 
	`£t_úq_chù
(
LOCOMO_IRQ_LT_START
, &
locomo_…_chù
);

483 
	`£t_úq_chù_d©a
(
LOCOMO_IRQ_LT_START
, 
úqba£
);

484 
	`£t_úq_h™dÀr
(
LOCOMO_IRQ_LT_START
, 
h™dÀ_edge_úq
);

485 
	`£t_úq_Êags
(
LOCOMO_IRQ_LT_START
, 
IRQF_VALID
 | 
IRQF_PROBE
);

488 
úq
 = 
LOCOMO_IRQ_SPI_START
; irq < LOCOMO_IRQ_SPI_START + 3; irq++) {

489 
	`£t_úq_chù
(
úq
, &
locomo_•i_chù
);

490 
	`£t_úq_chù_d©a
(
úq
, 
úqba£
);

491 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

492 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

494 
	}
}

497 
	$locomo_dev_ªÀa£
(
devi˚
 *
_dev
)

499 
locomo_dev
 *
dev
 = 
	`LOCOMO_DEV
(
_dev
);

501 
	`k‰ì
(
dev
);

502 
	}
}

505 
	$locomo_öô_⁄e_chûd
(
locomo
 *
lchù
, 
locomo_dev_öfo
 *
öfo
)

507 
locomo_dev
 *
dev
;

508 
ªt
;

510 
dev
 = 
	`kzÆloc
((
locomo_dev
), 
GFP_KERNEL
);

511 i‡(!
dev
) {

512 
ªt
 = -
ENOMEM
;

513 
out
;

516 
	`°∫˝y
(
dev
->dev.
bus_id
, 
öfo
->
«me
, (dev->dev.bus_id));

521 i‡(
lchù
->
dev
->
dma_mask
) {

522 
dev
->
dma_mask
 = *
lchù
->dev->dma_mask;

523 
dev
->dev.
dma_mask
 = &dev->dma_mask;

526 
dev
->
devid
 = 
öfo
->devid;

527 
dev
->dev.
∑ª¡
 = 
lchù
->dev;

528 
dev
->dev.
bus
 = &
locomo_bus_ty≥
;

529 
dev
->dev.
ªÀa£
 = 
locomo_dev_ªÀa£
;

530 
dev
->dev.
cohîít_dma_mask
 = 
lchù
->dev->coherent_dma_mask;

532 i‡(
öfo
->
off£t
)

533 
dev
->
m≠ba£
 = 
lchù
->
ba£
 + 
öfo
->
off£t
;

535 
dev
->
m≠ba£
 = 0;

536 
dev
->
Àngth
 = 
öfo
->length;

538 
	`memmove
(
dev
->
úq
, 
öfo
->irq, (dev->irq));

540 
ªt
 = 
	`devi˚_ªgi°î
(&
dev
->dev);

541 i‡(
ªt
) {

542 
out
:

543 
	`k‰ì
(
dev
);

545  
ªt
;

546 
	}
}

548 #ifde‡
CONFIG_PM


550 
	slocomo_ßve_d©a
 {

551 
u16
 
	mLCM_GPO
;

552 
u16
 
	mLCM_SPICT
;

553 
u16
 
	mLCM_GPE
;

554 
u16
 
	mLCM_ASD
;

555 
u16
 
	mLCM_SPIMD
;

558 
	$locomo_su•íd
(
∂©f‹m_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

560 
locomo
 *
lchù
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

561 
locomo_ßve_d©a
 *
ßve
;

562 
Êags
;

564 
ßve
 = 
	`kmÆloc
((
locomo_ßve_d©a
), 
GFP_KERNEL
);

565 i‡(!
ßve
)

566  -
ENOMEM
;

568 
dev
->dev.
powî
.
ßved_°©e
 = (*Ë
ßve
;

570 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

572 
ßve
->
LCM_GPO
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPO
);

573 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_GPO
);

574 
ßve
->
LCM_SPICT
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_SPICT
);

575 
	`locomo_wrôñ
(0x40, 
lchù
->
ba£
 + 
LOCOMO_SPICT
);

576 
ßve
->
LCM_GPE
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPE
);

577 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_GPE
);

578 
ßve
->
LCM_ASD
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_ASD
);

579 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_ASD
);

580 
ßve
->
LCM_SPIMD
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_SPIMD
);

581 
	`locomo_wrôñ
(0x3C14, 
lchù
->
ba£
 + 
LOCOMO_SPIMD
);

583 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_PAIF
);

584 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_DAC
);

585 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_BACKLIGHT
 + 
LOCOMO_TC
);

587 i‡–(
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_LED
 + 
LOCOMO_LPT0
Ë& 0x88Ë&& (locomo_ªadl÷chù->ba£ + LOCOMO_LED + 
LOCOMO_LPT1
) & 0x88) )

588 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_C32K
);

591 
	`locomo_wrôñ
(0xc1, 
lchù
->
ba£
 + 
LOCOMO_C32K
);

593 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_TADC
);

594 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_AUDIO
 + 
LOCOMO_ACC
);

595 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALS
);

597 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

600 
	}
}

602 
	$locomo_ªsume
(
∂©f‹m_devi˚
 *
dev
)

604 
locomo
 *
lchù
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

605 
locomo_ßve_d©a
 *
ßve
;

606 
r
;

607 
Êags
;

609 
ßve
 = (
locomo_ßve_d©a
 *Ë
dev
->dev.
powî
.
ßved_°©e
;

610 i‡(!
ßve
)

613 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

615 
	`locomo_wrôñ
(
ßve
->
LCM_GPO
, 
lchù
->
ba£
 + 
LOCOMO_GPO
);

616 
	`locomo_wrôñ
(
ßve
->
LCM_SPICT
, 
lchù
->
ba£
 + 
LOCOMO_SPICT
);

617 
	`locomo_wrôñ
(
ßve
->
LCM_GPE
, 
lchù
->
ba£
 + 
LOCOMO_GPE
);

618 
	`locomo_wrôñ
(
ßve
->
LCM_ASD
, 
lchù
->
ba£
 + 
LOCOMO_ASD
);

619 
	`locomo_wrôñ
(
ßve
->
LCM_SPIMD
, 
lchù
->
ba£
 + 
LOCOMO_SPIMD
);

621 
	`locomo_wrôñ
(0x00, 
lchù
->
ba£
 + 
LOCOMO_C32K
);

622 
	`locomo_wrôñ
(0x90, 
lchù
->
ba£
 + 
LOCOMO_TADC
);

624 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KSC
);

625 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

626 
r
 &= 0xFEFF;

627 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

628 
	`locomo_wrôñ
(0x1, 
lchù
->
ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KCMD
);

630 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

631 
	`k‰ì
(
ßve
);

634 
	}
}

651 
	$__locomo_¥obe
(
devi˚
 *
me
, 
ªsour˚
 *
mem
, 
úq
)

653 
locomo
 *
lchù
;

654 
r
;

655 
i
, 
ªt
 = -
ENODEV
;

657 
lchù
 = 
	`kzÆloc
((
locomo
), 
GFP_KERNEL
);

658 i‡(!
lchù
)

659  -
ENOMEM
;

661 
	`•ö_lock_öô
(&
lchù
->
lock
);

663 
lchù
->
dev
 = 
me
;

664 
	`dev_£t_drvd©a
(
lchù
->
dev
,Üchip);

666 
lchù
->
phys
 = 
mem
->
°¨t
;

667 
lchù
->
úq
 = irq;

673 
lchù
->
ba£
 = 
	`i‹em≠
(
mem
->
°¨t
, 
PAGE_SIZE
);

674 i‡(!
lchù
->
ba£
) {

675 
ªt
 = -
ENOMEM
;

676 
out
;

680 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_ICR
);

682 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_KEYBOARD
 + 
LOCOMO_KIC
);

685 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_GPO
);

686 
	`locomo_wrôñ
–(
	`LOCOMO_GPIO
(2) | LOCOMO_GPIO(3) | LOCOMO_GPIO(13) | LOCOMO_GPIO(14))

687 , 
lchù
->
ba£
 + 
LOCOMO_GPE
);

688 
	`locomo_wrôñ
–(
	`LOCOMO_GPIO
(2) | LOCOMO_GPIO(3) | LOCOMO_GPIO(13) | LOCOMO_GPIO(14))

689 , 
lchù
->
ba£
 + 
LOCOMO_GPD
);

690 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_GIE
);

693 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALS
);

694 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALD
);

697 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_LTINT
);

699 
	`locomo_wrôñ
(0, 
lchù
->
ba£
 + 
LOCOMO_SPIIE
);

701 
	`locomo_wrôñ
(6 + 8 + 320 + 30 - 10, 
lchù
->
ba£
 + 
LOCOMO_ASD
);

702 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_ASD
);

703 
r
 |= 0x8000;

704 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_ASD
);

706 
	`locomo_wrôñ
(6 + 8 + 320 + 30 - 10 - 128 + 4, 
lchù
->
ba£
 + 
LOCOMO_HSD
);

707 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_HSD
);

708 
r
 |= 0x8000;

709 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_HSD
);

711 
	`locomo_wrôñ
(128 / 8, 
lchù
->
ba£
 + 
LOCOMO_HSC
);

714 
	`locomo_wrôñ
(0x80, 
lchù
->
ba£
 + 
LOCOMO_TADC
);

715 
	`udñay
(1000);

717 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_TADC
);

718 
r
 |= 0x10;

719 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_TADC
);

720 
	`udñay
(100);

723 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_DAC
);

724 
r
 |
LOCOMO_DAC_SCLOEB
 | 
LOCOMO_DAC_SDAOEB
;

725 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_DAC
);

727 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_VER
);

728 
	`¥ötk
(
KERN_INFO
 "LoCoMÿChù: %lu%lu\n", (
r
 >> 8), (r & 0xff));

734 i‡(
lchù
->
úq
 !
NO_IRQ
)

735 
	`locomo_£tup_úq
(
lchù
);

737 
i
 = 0; i < 
	`ARRAY_SIZE
(
locomo_devi˚s
); i++)

738 
	`locomo_öô_⁄e_chûd
(
lchù
, &
locomo_devi˚s
[
i
]);

741 
out
:

742 
	`k‰ì
(
lchù
);

743  
ªt
;

744 
	}
}

746 
	$locomo_ªmove_chûd
(
devi˚
 *
dev
, *
d©a
)

748 
	`devi˚_uƒegi°î
(
dev
);

750 
	}
}

752 
	$__locomo_ªmove
(
locomo
 *
lchù
)

754 
	`devi˚_f‹_óch_chûd
(
lchù
->
dev
, 
NULL
, 
locomo_ªmove_chûd
);

756 i‡(
lchù
->
úq
 !
NO_IRQ
) {

757 
	`£t_úq_chaöed_h™dÀr
(
lchù
->
úq
, 
NULL
);

758 
	`£t_úq_d©a
(
lchù
->
úq
, 
NULL
);

761 
	`iounm≠
(
lchù
->
ba£
);

762 
	`k‰ì
(
lchù
);

763 
	}
}

765 
	$locomo_¥obe
(
∂©f‹m_devi˚
 *
dev
)

767 
ªsour˚
 *
mem
;

768 
úq
;

770 
mem
 = 
	`∂©f‹m_gë_ªsour˚
(
dev
, 
IORESOURCE_MEM
, 0);

771 i‡(!
mem
)

772  -
EINVAL
;

773 
úq
 = 
	`∂©f‹m_gë_úq
(
dev
, 0);

774 i‡(
úq
 < 0)

775  -
ENXIO
;

777  
	`__locomo_¥obe
(&
dev
->dev, 
mem
, 
úq
);

778 
	}
}

780 
	$locomo_ªmove
(
∂©f‹m_devi˚
 *
dev
)

782 
locomo
 *
lchù
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

784 i‡(
lchù
) {

785 
	`__locomo_ªmove
(
lchù
);

786 
	`∂©f‹m_£t_drvd©a
(
dev
, 
NULL
);

790 
	}
}

798 
∂©f‹m_drivî
 
	glocomo_devi˚_drivî
 = {

799 .
¥obe
 = 
locomo_¥obe
,

800 .
	gªmove
 = 
locomo_ªmove
,

801 #ifde‡
CONFIG_PM


802 .
	gsu•íd
 = 
locomo_su•íd
,

803 .
	gªsume
 = 
locomo_ªsume
,

805 .
	gdrivî
 = {

806 .
«me
 = "locomo",

814 
ölöe
 
locomo
 *
	$locomo_chù_drivî
(
locomo_dev
 *
ldev
)

816  (
locomo
 *)
	`dev_gë_drvd©a
(
ldev
->
dev
.
∑ª¡
);

817 
	}
}

819 
	$locomo_gpio_£t_dú
(
devi˚
 *
dev
, 
bôs
, 
dú
)

821 
locomo
 *
lchù
 = 
	`dev_gë_drvd©a
(
dev
);

822 
Êags
;

823 
r
;

825 i‡(!
lchù
)

828 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

830 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPD
);

831 
r
 &~
bôs
;

832 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_GPD
);

834 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPE
);

835 i‡(
dú
)

836 
r
 |
bôs
;

838 
r
 &~
bôs
;

839 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_GPE
);

841 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

842 
	}
}

844 
	$locomo_gpio_ªad_Àvñ
(
devi˚
 *
dev
, 
bôs
)

846 
locomo
 *
lchù
 = 
	`dev_gë_drvd©a
(
dev
);

847 
Êags
;

848 
ªt
;

850 i‡(!
lchù
)

851  -
ENODEV
;

853 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

854 
ªt
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPL
);

855 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

857 
ªt
 &
bôs
;

858  
ªt
;

859 
	}
}

861 
	$locomo_gpio_ªad_ouçut
(
devi˚
 *
dev
, 
bôs
)

863 
locomo
 *
lchù
 = 
	`dev_gë_drvd©a
(
dev
);

864 
Êags
;

865 
ªt
;

867 i‡(!
lchù
)

868  -
ENODEV
;

870 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

871 
ªt
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPO
);

872 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

874 
ªt
 &
bôs
;

875  
ªt
;

876 
	}
}

878 
	$locomo_gpio_wrôe
(
devi˚
 *
dev
, 
bôs
, 
£t
)

880 
locomo
 *
lchù
 = 
	`dev_gë_drvd©a
(
dev
);

881 
Êags
;

882 
r
;

884 i‡(!
lchù
)

887 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

889 
r
 = 
	`locomo_ªadl
(
lchù
->
ba£
 + 
LOCOMO_GPO
);

890 i‡(
£t
)

891 
r
 |
bôs
;

893 
r
 &~
bôs
;

894 
	`locomo_wrôñ
(
r
, 
lchù
->
ba£
 + 
LOCOMO_GPO
);

896 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

897 
	}
}

899 
	$locomo_m62332_£ndbô
(*
m≠ba£
, 
bô
)

901 
r
;

903 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

904 
r
 &~(
LOCOMO_DAC_SCLOEB
);

905 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

906 
	`udñay
(
DAC_LOW_SETUP_TIME
);

907 
	`udñay
(
DAC_DATA_HOLD_TIME
);

908 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

909 
r
 &~(
LOCOMO_DAC_SCLOEB
);

910 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

911 
	`udñay
(
DAC_LOW_SETUP_TIME
);

912 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

914 i‡(
bô
 & 1) {

915 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

916 
r
 |
LOCOMO_DAC_SDAOEB
;

917 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

918 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

920 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

921 
r
 &~(
LOCOMO_DAC_SDAOEB
);

922 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

923 
	`udñay
(
DAC_LOW_SETUP_TIME
);

926 
	`udñay
(
DAC_DATA_SETUP_TIME
);

927 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

928 
r
 |
LOCOMO_DAC_SCLOEB
;

929 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

930 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

931 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

932 
	}
}

934 
	$locomo_m62332_£ndd©a
(
locomo_dev
 *
ldev
, 
dac_d©a
, 
ch™√l
)

936 
locomo
 *
lchù
 = 
	`locomo_chù_drivî
(
ldev
);

937 
i
;

938 
d©a
;

939 
r
;

940 *
m≠ba£
 = 
lchù
->
ba£
;

941 
Êags
;

943 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

946 
	`udñay
(
DAC_BUS_FREE_TIME
);

947 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

948 
r
 |
LOCOMO_DAC_SCLOEB
 | 
LOCOMO_DAC_SDAOEB
;

949 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

950 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

951 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

952 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

953 
r
 &~(
LOCOMO_DAC_SDAOEB
);

954 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

955 
	`udñay
(
DAC_START_HOLD_TIME
);

956 
	`udñay
(
DAC_DATA_HOLD_TIME
);

959 
d©a
 = (
M62332_SLAVE_ADDR
 << 1Ë| 
M62332_W_BIT
;

960 
i
 = 1; i <= 8; i++) {

961 
	`locomo_m62332_£ndbô
(
m≠ba£
, 
d©a
 >> (8 - 
i
));

965 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

966 
r
 &~(
LOCOMO_DAC_SCLOEB
);

967 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

968 
	`udñay
(
DAC_LOW_SETUP_TIME
);

969 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

970 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

971 
r
 &~(
LOCOMO_DAC_SDAOEB
);

972 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

973 
	`udñay
(
DAC_LOW_SETUP_TIME
);

974 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

975 
r
 |
LOCOMO_DAC_SCLOEB
;

976 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

977 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

978 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

979 i‡(
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
Ë& 
LOCOMO_DAC_SDAOEB
) {

980 
	`¥ötk
(
KERN_WARNING
 "locomo: m62332_senddata Error 1\n");

987 
d©a
 = 
M62332_SUB_ADDR
 + 
ch™√l
;

988 
i
 = 1; i <= 8; i++) {

989 
	`locomo_m62332_£ndbô
(
m≠ba£
, 
d©a
 >> (8 - 
i
));

993 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

994 
r
 &~(
LOCOMO_DAC_SCLOEB
);

995 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

996 
	`udñay
(
DAC_LOW_SETUP_TIME
);

997 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

998 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

999 
r
 &~(
LOCOMO_DAC_SDAOEB
);

1000 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1001 
	`udñay
(
DAC_LOW_SETUP_TIME
);

1002 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1003 
r
 |
LOCOMO_DAC_SCLOEB
;

1004 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1005 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

1006 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

1007 i‡(
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
Ë& 
LOCOMO_DAC_SDAOEB
) {

1008 
	`¥ötk
(
KERN_WARNING
 "locomo: m62332_senddata Error 2\n");

1013 
i
 = 1; i <= 8; i++) {

1014 
	`locomo_m62332_£ndbô
(
m≠ba£
, 
dac_d©a
 >> (8 - 
i
));

1018 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1019 
r
 &~(
LOCOMO_DAC_SCLOEB
);

1020 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1021 
	`udñay
(
DAC_LOW_SETUP_TIME
);

1022 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

1023 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1024 
r
 &~(
LOCOMO_DAC_SDAOEB
);

1025 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1026 
	`udñay
(
DAC_LOW_SETUP_TIME
);

1027 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1028 
r
 |
LOCOMO_DAC_SCLOEB
;

1029 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1030 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

1031 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

1032 i‡(
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
Ë& 
LOCOMO_DAC_SDAOEB
) {

1033 
	`¥ötk
(
KERN_WARNING
 "locomo: m62332_senddata Error 3\n");

1038 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1039 
r
 &~(
LOCOMO_DAC_SCLOEB
);

1040 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1041 
	`udñay
(
DAC_LOW_SETUP_TIME
);

1042 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

1043 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1044 
r
 |
LOCOMO_DAC_SCLOEB
;

1045 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1046 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

1047 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

1048 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1049 
r
 |
LOCOMO_DAC_SDAOEB
;

1050 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1051 
	`udñay
(
DAC_HIGH_SETUP_TIME
);

1052 
	`udñay
(
DAC_SCL_HIGH_HOLD_TIME
);

1054 
r
 = 
	`locomo_ªadl
(
m≠ba£
 + 
LOCOMO_DAC
);

1055 
r
 |
LOCOMO_DAC_SCLOEB
 | 
LOCOMO_DAC_SDAOEB
;

1056 
	`locomo_wrôñ
(
r
, 
m≠ba£
 + 
LOCOMO_DAC
);

1057 
	`udñay
(
DAC_LOW_SETUP_TIME
);

1058 
	`udñay
(
DAC_SCL_LOW_HOLD_TIME
);

1060 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

1061 
	}
}

1067 
locomo
 *
locomo_chù_drivî
(
locomo_dev
 *
ldev
);

1069 
	$locomo_‰⁄éight_£t
(
locomo_dev
 *
dev
, 
duty
, 
vr
, 
bpwf
)

1071 
Êags
;

1072 
locomo
 *
lchù
 = 
	`locomo_chù_drivî
(
dev
);

1074 i‡(
vr
)

1075 
	`locomo_gpio_wrôe
(
dev
->dev.
∑ª¡
, 
LOCOMO_GPIO_FL_VR
, 1);

1077 
	`locomo_gpio_wrôe
(
dev
->dev.
∑ª¡
, 
LOCOMO_GPIO_FL_VR
, 0);

1079 
	`•ö_lock_úqßve
(&
lchù
->
lock
, 
Êags
);

1080 
	`locomo_wrôñ
(
bpwf
, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALS
);

1081 
	`udñay
(100);

1082 
	`locomo_wrôñ
(
duty
, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALD
);

1083 
	`locomo_wrôñ
(
bpwf
 | 
LOCOMO_ALC_EN
, 
lchù
->
ba£
 + 
LOCOMO_FRONTLIGHT
 + 
LOCOMO_ALS
);

1084 
	`•ö_u∆ock_úqª°‹e
(&
lchù
->
lock
, 
Êags
);

1085 
	}
}

1093 
	$locomo_m©ch
(
devi˚
 *
_dev
, 
devi˚_drivî
 *
_drv
)

1095 
locomo_dev
 *
dev
 = 
	`LOCOMO_DEV
(
_dev
);

1096 
locomo_drivî
 *
drv
 = 
	`LOCOMO_DRV
(
_drv
);

1098  
dev
->
devid
 =
drv
->devid;

1099 
	}
}

1101 
	$locomo_bus_su•íd
(
devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1103 
locomo_dev
 *
ldev
 = 
	`LOCOMO_DEV
(
dev
);

1104 
locomo_drivî
 *
drv
 = 
	`LOCOMO_DRV
(
dev
->
drivî
);

1105 
ªt
 = 0;

1107 i‡(
drv
 && drv->
su•íd
)

1108 
ªt
 = 
drv
->
	`su•íd
(
ldev
, 
°©e
);

1109  
ªt
;

1110 
	}
}

1112 
	$locomo_bus_ªsume
(
devi˚
 *
dev
)

1114 
locomo_dev
 *
ldev
 = 
	`LOCOMO_DEV
(
dev
);

1115 
locomo_drivî
 *
drv
 = 
	`LOCOMO_DRV
(
dev
->
drivî
);

1116 
ªt
 = 0;

1118 i‡(
drv
 && drv->
ªsume
)

1119 
ªt
 = 
drv
->
	`ªsume
(
ldev
);

1120  
ªt
;

1121 
	}
}

1123 
	$locomo_bus_¥obe
(
devi˚
 *
dev
)

1125 
locomo_dev
 *
ldev
 = 
	`LOCOMO_DEV
(
dev
);

1126 
locomo_drivî
 *
drv
 = 
	`LOCOMO_DRV
(
dev
->
drivî
);

1127 
ªt
 = -
ENODEV
;

1129 i‡(
drv
->
¥obe
)

1130 
ªt
 = 
drv
->
	`¥obe
(
ldev
);

1131  
ªt
;

1132 
	}
}

1134 
	$locomo_bus_ªmove
(
devi˚
 *
dev
)

1136 
locomo_dev
 *
ldev
 = 
	`LOCOMO_DEV
(
dev
);

1137 
locomo_drivî
 *
drv
 = 
	`LOCOMO_DRV
(
dev
->
drivî
);

1138 
ªt
 = 0;

1140 i‡(
drv
->
ªmove
)

1141 
ªt
 = 
drv
->
	`ªmove
(
ldev
);

1142  
ªt
;

1143 
	}
}

1145 
bus_ty≥
 
	glocomo_bus_ty≥
 = {

1146 .
«me
 = "locomo-bus",

1147 .
	gm©ch
 = 
locomo_m©ch
,

1148 .
	g¥obe
 = 
locomo_bus_¥obe
,

1149 .
	gªmove
 = 
locomo_bus_ªmove
,

1150 .
	gsu•íd
 = 
locomo_bus_su•íd
,

1151 .
	gªsume
 = 
locomo_bus_ªsume
,

1154 
	$locomo_drivî_ªgi°î
(
locomo_drivî
 *
drivî
)

1156 
drivî
->
drv
.
bus
 = &
locomo_bus_ty≥
;

1157  
	`drivî_ªgi°î
(&
drivî
->
drv
);

1158 
	}
}

1160 
	$locomo_drivî_uƒegi°î
(
locomo_drivî
 *
drivî
)

1162 
	`drivî_uƒegi°î
(&
drivî
->
drv
);

1163 
	}
}

1165 
__öô
 
	$locomo_öô
()

1167 
ªt
 = 
	`bus_ªgi°î
(&
locomo_bus_ty≥
);

1168 i‡(
ªt
 == 0)

1169 
	`∂©f‹m_drivî_ªgi°î
(&
locomo_devi˚_drivî
);

1170  
ªt
;

1171 
	}
}

1173 
__exô
 
	$locomo_exô
()

1175 
	`∂©f‹m_drivî_uƒegi°î
(&
locomo_devi˚_drivî
);

1176 
	`bus_uƒegi°î
(&
locomo_bus_ty≥
);

1177 
	}
}

1179 
moduÀ_öô
(
locomo_öô
);

1180 
moduÀ_exô
(
locomo_exô
);

1182 
MODULE_DESCRIPTION
("Sharp LoCoMo core driver");

1183 
MODULE_LICENSE
("GPL");

1184 
MODULE_AUTHOR
("John Lenz <lenz@cs.wisc.edu>");

1186 
EXPORT_SYMBOL
(
locomo_drivî_ªgi°î
);

1187 
EXPORT_SYMBOL
(
locomo_drivî_uƒegi°î
);

1188 
EXPORT_SYMBOL
(
locomo_gpio_£t_dú
);

1189 
EXPORT_SYMBOL
(
locomo_gpio_ªad_Àvñ
);

1190 
EXPORT_SYMBOL
(
locomo_gpio_ªad_ouçut
);

1191 
EXPORT_SYMBOL
(
locomo_gpio_wrôe
);

1192 
EXPORT_SYMBOL
(
locomo_m62332_£ndd©a
);

	@arch/arm/common/rtctime.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/time.h
>

15 
	~<löux/πc.h
>

16 
	~<löux/pﬁl.h
>

17 
	~<löux/¥oc_fs.h
>

18 
	~<löux/miscdevi˚.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/ˇ∑bûôy.h
>

21 
	~<löux/devi˚.h
>

22 
	~<löux/muãx.h
>

23 
	~<löux/πc.h
>

25 
	~<asm/πc.h
>

26 
	~<asm/£m≠h‹e.h
>

28 
DECLARE_WAIT_QUEUE_HEAD
(
πc_waô
);

29 
Ásync_°ru˘
 *
	gπc_async_queue
;

34 
DEFINE_SPINLOCK
(
πc_lock
);

35 
	gπc_úq_d©a
;

40 
DEFINE_MUTEX
(
πc_muãx
);

41 
	gπc_öu£
;

42 
πc_›s
 *
	gπc_›s
;

44 
	#πc_ïoch
 1900UL

	)

50 
	$πc_√xt_Æ¨m_time
(
πc_time
 *
√xt
, πc_timê*
now
, πc_timê*
Ærm
)

52 
√xt_time
;

53 
now_time
;

55 
√xt
->
tm_yór
 = 
now
->tm_year;

56 
√xt
->
tm_m⁄
 = 
now
->tm_mon;

57 
√xt
->
tm_mday
 = 
now
->tm_mday;

58 
√xt
->
tm_hour
 = 
Ærm
->tm_hour;

59 
√xt
->
tm_mö
 = 
Ærm
->tm_min;

60 
√xt
->
tm_£c
 = 
Ærm
->tm_sec;

62 
	`πc_tm_to_time
(
now
, &
now_time
);

63 
	`πc_tm_to_time
(
√xt
, &
√xt_time
);

65 i‡(
√xt_time
 < 
now_time
) {

67 
√xt_time
 += 60 * 60 * 24;

68 
	`πc_time_to_tm
(
√xt_time
, 
√xt
);

70 
	}
}

71 
EXPORT_SYMBOL
(
πc_√xt_Æ¨m_time
);

73 
ölöe
 
	$πc_¨m_ªad_time
(
πc_›s
 *
›s
, 
πc_time
 *
tm
)

75 
	`mem£t
(
tm
, 0, (
πc_time
));

76  
›s
->
	`ªad_time
(
tm
);

77 
	}
}

79 
ölöe
 
	$πc_¨m_£t_time
(
πc_›s
 *
›s
, 
πc_time
 *
tm
)

81 
ªt
;

83 
ªt
 = 
	`πc_vÆid_tm
(
tm
);

84 i‡(
ªt
 == 0)

85 
ªt
 = 
›s
->
	`£t_time
(
tm
);

87  
ªt
;

88 
	}
}

90 
ölöe
 
	$πc_¨m_ªad_Æ¨m
(
πc_›s
 *
›s
, 
πc_wkÆrm
 *
Ærm
)

92 
ªt
 = -
EINVAL
;

93 i‡(
›s
->
ªad_Æ¨m
) {

94 
	`mem£t
(
Ærm
, 0, (
πc_wkÆrm
));

95 
ªt
 = 
›s
->
	`ªad_Æ¨m
(
Ærm
);

97  
ªt
;

98 
	}
}

100 
ölöe
 
	$πc_¨m_£t_Æ¨m
(
πc_›s
 *
›s
, 
πc_wkÆrm
 *
Ærm
)

102 
ªt
 = -
EINVAL
;

103 i‡(
›s
->
£t_Æ¨m
)

104 
ªt
 = 
›s
->
	`£t_Æ¨m
(
Ærm
);

105  
ªt
;

106 
	}
}

108 
	$πc_upd©e
(
num
, 
evíts
)

110 
	`•ö_lock
(&
πc_lock
);

111 
πc_úq_d©a
 = (πc_úq_d©®+ (
num
 << 8)Ë| 
evíts
;

112 
	`•ö_u∆ock
(&
πc_lock
);

114 
	`wake_up_öãºu±ibÀ
(&
πc_waô
);

115 
	`kûl_Ásync
(&
πc_async_queue
, 
SIGIO
, 
POLL_IN
);

116 
	}
}

117 
EXPORT_SYMBOL
(
πc_upd©e
);

120 
ssize_t


121 
	$πc_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

123 
	`DECLARE_WAITQUEUE
(
waô
, 
cuºít
);

124 
d©a
;

125 
ssize_t
 
ªt
;

127 i‡(
cou¡
 < ())

128  -
EINVAL
;

130 
	`add_waô_queue
(&
πc_waô
, &
waô
);

132 
	`__£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

134 
	`•ö_lock_úq
(&
πc_lock
);

135 
d©a
 = 
πc_úq_d©a
;

136 
πc_úq_d©a
 = 0;

137 
	`•ö_u∆ock_úq
(&
πc_lock
);

139 i‡(
d©a
 != 0) {

140 
ªt
 = 0;

143 i‡(
fûe
->
f_Êags
 & 
O_NONBLOCK
) {

144 
ªt
 = -
EAGAIN
;

147 i‡(
	`sig«l_≥ndög
(
cuºít
)) {

148 
ªt
 = -
ERESTARTSYS
;

151 
	`scheduÀ
();

153 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

154 
	`ªmove_waô_queue
(&
πc_waô
, &
waô
);

156 i‡(
ªt
 == 0) {

157 
ªt
 = 
	`put_u£r
(
d©a
, (
__u£r
 *)
buf
);

158 i‡(
ªt
 == 0)

159 
ªt
 = ();

161  
ªt
;

162 
	}
}

164 
	$πc_pﬁl
(
fûe
 *fûe, 
pﬁl_èbÀ
 *
waô
)

166 
d©a
;

168 
	`pﬁl_waô
(
fûe
, &
πc_waô
, 
waô
);

170 
	`•ö_lock_úq
(&
πc_lock
);

171 
d©a
 = 
πc_úq_d©a
;

172 
	`•ö_u∆ock_úq
(&
πc_lock
);

174  
d©a
 !0 ? 
POLLIN
 | 
POLLRDNORM
 : 0;

175 
	}
}

177 
	$πc_io˘l
(
öode
 *öode, 
fûe
 *fûe, 
cmd
,

178 
¨g
)

180 
πc_›s
 *
›s
 = 
fûe
->
¥iv©e_d©a
;

181 
πc_time
 
tm
;

182 
πc_wkÆrm
 
Ærm
;

183 
__u£r
 *
u¨g
 = (__u£∏*)
¨g
;

184 
ªt
 = -
EINVAL
;

186 
cmd
) {

187 
RTC_ALM_READ
:

188 
ªt
 = 
	`πc_¨m_ªad_Æ¨m
(
›s
, &
Ærm
);

189 i‡(
ªt
)

191 
ªt
 = 
	`c›y_to_u£r
(
u¨g
, &
Ærm
.
time
, (
tm
));

192 i‡(
ªt
)

193 
ªt
 = -
EFAULT
;

196 
RTC_ALM_SET
:

197 
ªt
 = 
	`c›y_‰om_u£r
(&
Ærm
.
time
, 
u¨g
, (
tm
));

198 i‡(
ªt
) {

199 
ªt
 = -
EFAULT
;

202 
Ærm
.
íabÀd
 = 0;

203 
Ærm
.
≥ndög
 = 0;

204 
Ærm
.
time
.
tm_mday
 = -1;

205 
Ærm
.
time
.
tm_m⁄
 = -1;

206 
Ærm
.
time
.
tm_yór
 = -1;

207 
Ærm
.
time
.
tm_wday
 = -1;

208 
Ærm
.
time
.
tm_yday
 = -1;

209 
Ærm
.
time
.
tm_isd°
 = -1;

210 
ªt
 = 
	`πc_¨m_£t_Æ¨m
(
›s
, &
Ærm
);

213 
RTC_RD_TIME
:

214 
ªt
 = 
	`πc_¨m_ªad_time
(
›s
, &
tm
);

215 i‡(
ªt
)

217 
ªt
 = 
	`c›y_to_u£r
(
u¨g
, &
tm
, (tm));

218 i‡(
ªt
)

219 
ªt
 = -
EFAULT
;

222 
RTC_SET_TIME
:

223 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_TIME
)) {

224 
ªt
 = -
EACCES
;

227 
ªt
 = 
	`c›y_‰om_u£r
(&
tm
, 
u¨g
, (tm));

228 i‡(
ªt
) {

229 
ªt
 = -
EFAULT
;

232 
ªt
 = 
	`πc_¨m_£t_time
(
›s
, &
tm
);

235 
RTC_EPOCH_SET
:

236 #i‚de‡
πc_ïoch


240 i‡(
¨g
 < 1900) {

241 
ªt
 = -
EINVAL
;

244 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_TIME
)) {

245 
ªt
 = -
EACCES
;

248 
πc_ïoch
 = 
¨g
;

249 
ªt
 = 0;

253 
RTC_EPOCH_READ
:

254 
ªt
 = 
	`put_u£r
(
πc_ïoch
, (
__u£r
 *)
u¨g
);

257 
RTC_WKALM_SET
:

258 
ªt
 = 
	`c›y_‰om_u£r
(&
Ærm
, 
u¨g
, (alrm));

259 i‡(
ªt
) {

260 
ªt
 = -
EFAULT
;

263 
ªt
 = 
	`πc_¨m_£t_Æ¨m
(
›s
, &
Ærm
);

266 
RTC_WKALM_RD
:

267 
ªt
 = 
	`πc_¨m_ªad_Æ¨m
(
›s
, &
Ærm
);

268 i‡(
ªt
)

270 
ªt
 = 
	`c›y_to_u£r
(
u¨g
, &
Ærm
, (alrm));

271 i‡(
ªt
)

272 
ªt
 = -
EFAULT
;

276 i‡(
›s
->
io˘l
)

277 
ªt
 = 
›s
->
	`io˘l
(
cmd
, 
¨g
);

280  
ªt
;

281 
	}
}

283 
	$πc_›í
(
öode
 *öode, 
fûe
 *file)

285 
ªt
;

287 
	`muãx_lock
(&
πc_muãx
);

289 i‡(
πc_öu£
) {

290 
ªt
 = -
EBUSY
;

291 } i‡(!
πc_›s
 || !
	`åy_moduÀ_gë
‘tc_›s->
ow√r
)) {

292 
ªt
 = -
ENODEV
;

294 
fûe
->
¥iv©e_d©a
 = 
πc_›s
;

296 
ªt
 = 
πc_›s
->
›í
 ?Ñtc_›s->
	`›í
() : 0;

297 i‡(
ªt
 == 0) {

298 
	`•ö_lock_úq
(&
πc_lock
);

299 
πc_úq_d©a
 = 0;

300 
	`•ö_u∆ock_úq
(&
πc_lock
);

302 
πc_öu£
 = 1;

305 
	`muãx_u∆ock
(&
πc_muãx
);

307  
ªt
;

308 
	}
}

310 
	$πc_ªÀa£
(
öode
 *öode, 
fûe
 *file)

312 
πc_›s
 *
›s
 = 
fûe
->
¥iv©e_d©a
;

314 i‡(
›s
->
ªÀa£
)

315 
›s
->
	`ªÀa£
();

317 
	`•ö_lock_úq
(&
πc_lock
);

318 
πc_úq_d©a
 = 0;

319 
	`•ö_u∆ock_úq
(&
πc_lock
);

321 
	`moduÀ_put
(
πc_›s
->
ow√r
);

322 
πc_öu£
 = 0;

325 
	}
}

327 
	$πc_Ásync
(
fd
, 
fûe
 *fûe, 
⁄
)

329  
	`Ásync_hñ≥r
(
fd
, 
fûe
, 
⁄
, &
πc_async_queue
);

330 
	}
}

332 c⁄° 
fûe_›î©i⁄s
 
	gπc_f›s
 = {

333 .
ow√r
 = 
THIS_MODULE
,

334 .
	gŒ£ek
 = 
no_Œ£ek
,

335 .
	gªad
 = 
πc_ªad
,

336 .
	gpﬁl
 = 
πc_pﬁl
,

337 .
	gio˘l
 = 
πc_io˘l
,

338 .
	g›í
 = 
πc_›í
,

339 .
	gªÀa£
 = 
πc_ªÀa£
,

340 .
	gÁsync
 = 
πc_Ásync
,

343 
miscdevi˚
 
	gπc_miscdev
 = {

344 .
mö‹
 = 
RTC_MINOR
,

345 .
	g«me
 = "rtc",

346 .
	gf›s
 = &
πc_f›s
,

350 
	$πc_ªad_¥oc
(*
∑ge
, **
°¨t
, 
off_t
 
off
, 
cou¡
, *
eof
, *
d©a
)

352 
πc_›s
 *
›s
 = 
d©a
;

353 
πc_wkÆrm
 
Ærm
;

354 
πc_time
 
tm
;

355 *
p
 = 
∑ge
;

357 i‡(
	`πc_¨m_ªad_time
(
›s
, &
tm
) == 0) {

358 
p
 +
	`•rötf
(p,

362 
tm
.
tm_hour
,Åm.
tm_mö
,Åm.
tm_£c
,

363 
tm
.
tm_yór
 + 1900,Åm.
tm_m⁄
 + 1,Åm.
tm_mday
,

364 
πc_ïoch
);

367 i‡(
	`πc_¨m_ªad_Æ¨m
(
›s
, &
Ærm
) == 0) {

368 
p
 +
	`•rötf
(p, "alrm_time\t: ");

369 i‡(()
Ærm
.
time
.
tm_hour
 <= 24)

370 
p
 +
	`•rötf
’, "%02d:", 
Ærm
.
time
.
tm_hour
);

372 
p
 +
	`•rötf
(p, "**:");

373 i‡(()
Ærm
.
time
.
tm_mö
 <= 59)

374 
p
 +
	`•rötf
’, "%02d:", 
Ærm
.
time
.
tm_mö
);

376 
p
 +
	`•rötf
(p, "**:");

377 i‡(()
Ærm
.
time
.
tm_£c
 <= 59)

378 
p
 +
	`•rötf
’, "%02d\n", 
Ærm
.
time
.
tm_£c
);

380 
p
 +
	`•rötf
(p, "**\n");

382 
p
 +
	`•rötf
(p, "alrm_date\t: ");

383 i‡(()
Ærm
.
time
.
tm_yór
 <= 200)

384 
p
 +
	`•rötf
’, "%04d-", 
Ærm
.
time
.
tm_yór
 + 1900);

386 
p
 +
	`•rötf
(p, "****-");

387 i‡(()
Ærm
.
time
.
tm_m⁄
 <= 11)

388 
p
 +
	`•rötf
’, "%02d-", 
Ærm
.
time
.
tm_m⁄
 + 1);

390 
p
 +
	`•rötf
(p, "**-");

391 i‡(()
Ærm
.
time
.
tm_mday
 <= 31)

392 
p
 +
	`•rötf
’, "%02d\n", 
Ærm
.
time
.
tm_mday
);

394 
p
 +
	`•rötf
(p, "**\n");

395 
p
 +
	`•rötf
(p, "alrm_wakeup\t: %s\n",

396 
Ærm
.
íabÀd
 ? "yes" : "no");

397 
p
 +
	`•rötf
(p, "alrm_pending\t: %s\n",

398 
Ærm
.
≥ndög
 ? "yes" : "no");

401 i‡(
›s
->
¥oc
)

402 
p
 +
›s
->
	`¥oc
(p);

404  
p
 - 
∑ge
;

405 
	}
}

407 
	$ªgi°î_πc
(
πc_›s
 *
›s
)

409 
ªt
 = -
EBUSY
;

411 
	`muãx_lock
(&
πc_muãx
);

412 i‡(
πc_›s
 =
NULL
) {

413 
πc_›s
 = 
›s
;

415 
ªt
 = 
	`misc_ªgi°î
(&
πc_miscdev
);

416 i‡(
ªt
 == 0)

417 
	`¸óã_¥oc_ªad_íåy
("drivî/πc", 0, 
NULL
,

418 
πc_ªad_¥oc
, 
›s
);

420 
	`muãx_u∆ock
(&
πc_muãx
);

422  
ªt
;

423 
	}
}

424 
EXPORT_SYMBOL
(
ªgi°î_πc
);

426 
	$uƒegi°î_πc
(
πc_›s
 *
πc
)

428 
	`muãx_lock
(&
πc_muãx
);

429 i‡(
πc
 =
πc_›s
) {

430 
	`ªmove_¥oc_íåy
("drivî/πc", 
NULL
);

431 
	`misc_dîegi°î
(&
πc_miscdev
);

432 
πc_›s
 = 
NULL
;

434 
	`muãx_u∆ock
(&
πc_muãx
);

435 
	}
}

436 
EXPORT_SYMBOL
(
uƒegi°î_πc
);

	@arch/arm/common/sa1111.c

17 
	~<löux/moduÀ.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/i›‹t.h
>

23 
	~<löux/∂©f‹m_devi˚.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/•ölock.h
>

26 
	~<löux/dma-m≠pög.h
>

27 
	~<löux/˛k.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/io.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/mach/úq.h
>

34 
	~<asm/sizes.h
>

36 
	~<asm/h¨dw¨e/ß1111.h
>

38 
__öô
 
ß1110_mb_íabÀ
();

47 
	sß1111
 {

48 
devi˚
 *
	mdev
;

49 
˛k
 *
	m˛k
;

50 
	mphys
;

51 
	múq
;

52 
•ölock_t
 
	mlock
;

53 
__iomem
 *
	mba£
;

60 
ß1111
 *
	gg_ß1111
;

62 
	sß1111_dev_öfo
 {

63 
	moff£t
;

64 
	mskp¸_mask
;

65 
	mdevid
;

66 
	múq
[6];

69 
ß1111_dev_öfo
 
	gß1111_devi˚s
[] = {

71 .
off£t
 = 
SA1111_USB
,

72 .
	gskp¸_mask
 = 
SKPCR_UCLKEN
,

73 .
	gdevid
 = 
SA1111_DEVID_USB
,

74 .
	gúq
 = {

75 
IRQ_USBPWR
,

76 
IRQ_HCIM
,

77 
IRQ_HCIBUFFACC
,

78 
IRQ_HCIRMTWKP
,

79 
IRQ_NHCIMFCIR
,

80 
IRQ_USB_PORT_RESUME


84 .
	goff£t
 = 0x0600,

85 .
	gskp¸_mask
 = 
SKPCR_I2SCLKEN
 | 
SKPCR_L3CLKEN
,

86 .
	gdevid
 = 
SA1111_DEVID_SAC
,

87 .
	gúq
 = {

88 
AUDXMTDMADONEA
,

89 
AUDXMTDMADONEB
,

90 
AUDRCVDMADONEA
,

91 
AUDRCVDMADONEB


95 .
	goff£t
 = 0x0800,

96 .
	gskp¸_mask
 = 
SKPCR_SCLKEN
,

97 .
	gdevid
 = 
SA1111_DEVID_SSP
,

100 .
	goff£t
 = 
SA1111_KBD
,

101 .
	gskp¸_mask
 = 
SKPCR_PTCLKEN
,

102 .
	gdevid
 = 
SA1111_DEVID_PS2
,

103 .
	gúq
 = {

104 
IRQ_TPRXINT
,

105 
IRQ_TPTXINT


109 .
	goff£t
 = 
SA1111_MSE
,

110 .
	gskp¸_mask
 = 
SKPCR_PMCLKEN
,

111 .
	gdevid
 = 
SA1111_DEVID_PS2
,

112 .
	gúq
 = {

113 
IRQ_MSRXINT
,

114 
IRQ_MSTXINT


118 .
	goff£t
 = 0x1800,

119 .
	gskp¸_mask
 = 0,

120 .
	gdevid
 = 
SA1111_DEVID_PCMCIA
,

121 .
	gúq
 = {

122 
IRQ_S0_READY_NINT
,

123 
IRQ_S0_CD_VALID
,

124 
IRQ_S0_BVD1_STSCHG
,

125 
IRQ_S1_READY_NINT
,

126 
IRQ_S1_CD_VALID
,

127 
IRQ_S1_BVD1_STSCHG
,

132 
__öô
 
	$ß1111_adju°_z⁄es
(
node
, *
size
, *
hﬁes
)

134 
sz
 = 
SZ_1M
 >> 
PAGE_SHIFT
;

136 i‡(
node
 != 0)

137 
sz
 = 0;

139 
size
[1] = size[0] - 
sz
;

140 
size
[0] = 
sz
;

141 
	}
}

149 
	$ß1111_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

151 
°©0
, 
°©1
, 
i
;

152 
__iomem
 *
ba£
 = 
	`gë_úq_d©a
(
úq
);

154 
°©0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTSTATCLR0
);

155 
°©1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTSTATCLR1
);

157 
	`ß1111_wrôñ
(
°©0
, 
ba£
 + 
SA1111_INTSTATCLR0
);

159 
desc
->
chù
->
	`ack
(
úq
);

161 
	`ß1111_wrôñ
(
°©1
, 
ba£
 + 
SA1111_INTSTATCLR1
);

163 i‡(
°©0
 =0 && 
°©1
 == 0) {

164 
	`do_bad_IRQ
(
úq
, 
desc
);

168 
i
 = 
IRQ_SA1111_START
; 
°©0
; i++, stat0 >>= 1)

169 i‡(
°©0
 & 1)

170 
	`h™dÀ_edge_úq
(
i
, 
úq_desc
 + i);

172 
i
 = 
IRQ_SA1111_START
 + 32; 
°©1
; i++, stat1 >>= 1)

173 i‡(
°©1
 & 1)

174 
	`h™dÀ_edge_úq
(
i
, 
úq_desc
 + i);

177 
desc
->
chù
->
	`unmask
(
úq
);

178 
	}
}

180 
	#SA1111_IRQMASK_LO
(
x
Ë(1 << (x - 
IRQ_SA1111_START
))

	)

181 
	#SA1111_IRQMASK_HI
(
x
Ë(1 << (x - 
IRQ_SA1111_START
 - 32))

	)

183 
	$ß1111_ack_úq
(
úq
)

185 
	}
}

187 
	$ß1111_mask_lowúq
(
úq
)

189 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

190 
õ0
;

192 
õ0
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTEN0
);

193 
õ0
 &~
	`SA1111_IRQMASK_LO
(
úq
);

194 
	`wrôñ
(
õ0
, 
m≠ba£
 + 
SA1111_INTEN0
);

195 
	}
}

197 
	$ß1111_unmask_lowúq
(
úq
)

199 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

200 
õ0
;

202 
õ0
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTEN0
);

203 
õ0
 |
	`SA1111_IRQMASK_LO
(
úq
);

204 
	`ß1111_wrôñ
(
õ0
, 
m≠ba£
 + 
SA1111_INTEN0
);

205 
	}
}

214 
	$ß1111_ªåiggî_lowúq
(
úq
)

216 
mask
 = 
	`SA1111_IRQMASK_LO
(
úq
);

217 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

218 
ù0
;

219 
i
;

221 
ù0
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTPOL0
);

222 
i
 = 0; i < 8; i++) {

223 
	`ß1111_wrôñ
(
ù0
 ^ 
mask
, 
m≠ba£
 + 
SA1111_INTPOL0
);

224 
	`ß1111_wrôñ
(
ù0
, 
m≠ba£
 + 
SA1111_INTPOL0
);

225 i‡(
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTSTATCLR1
Ë& 
mask
)

229 i‡(
i
 == 8)

230 
	`¥ötk
(
KERN_ERR
 "Danger Will Robinson: failedÅo "

231 "ª-åiggî IRQ%d\n", 
úq
);

232  
i
 == 8 ? -1 : 0;

233 
	}
}

235 
	$ß1111_ty≥_lowúq
(
úq
, 
Êags
)

237 
mask
 = 
	`SA1111_IRQMASK_LO
(
úq
);

238 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

239 
ù0
;

241 i‡(
Êags
 =
IRQT_PROBE
)

244 i‡((!(
Êags
 & 
__IRQT_RISEDGE
Ë^ !(Êag†& 
__IRQT_FALEDGE
)) == 0)

245  -
EINVAL
;

247 
ù0
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTPOL0
);

248 i‡(
Êags
 & 
__IRQT_RISEDGE
)

249 
ù0
 &~
mask
;

251 
ù0
 |
mask
;

252 
	`ß1111_wrôñ
(
ù0
, 
m≠ba£
 + 
SA1111_INTPOL0
);

253 
	`ß1111_wrôñ
(
ù0
, 
m≠ba£
 + 
SA1111_WAKEPOL0
);

256 
	}
}

258 
	$ß1111_wake_lowúq
(
úq
, 
⁄
)

260 
mask
 = 
	`SA1111_IRQMASK_LO
(
úq
);

261 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

262 
we0
;

264 
we0
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_WAKEEN0
);

265 i‡(
⁄
)

266 
we0
 |
mask
;

268 
we0
 &~
mask
;

269 
	`ß1111_wrôñ
(
we0
, 
m≠ba£
 + 
SA1111_WAKEEN0
);

272 
	}
}

274 
úq_chù
 
	gß1111_low_chù
 = {

275 .
«me
 = "SA1111-l",

276 .
	gack
 = 
ß1111_ack_úq
,

277 .
	gmask
 = 
ß1111_mask_lowúq
,

278 .
	gunmask
 = 
ß1111_unmask_lowúq
,

279 .
	gªåiggî
 = 
ß1111_ªåiggî_lowúq
,

280 .
	g£t_ty≥
 = 
ß1111_ty≥_lowúq
,

281 .
	g£t_wake
 = 
ß1111_wake_lowúq
,

284 
	$ß1111_mask_highúq
(
úq
)

286 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

287 
õ1
;

289 
õ1
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTEN1
);

290 
õ1
 &~
	`SA1111_IRQMASK_HI
(
úq
);

291 
	`ß1111_wrôñ
(
õ1
, 
m≠ba£
 + 
SA1111_INTEN1
);

292 
	}
}

294 
	$ß1111_unmask_highúq
(
úq
)

296 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

297 
õ1
;

299 
õ1
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTEN1
);

300 
õ1
 |
	`SA1111_IRQMASK_HI
(
úq
);

301 
	`ß1111_wrôñ
(
õ1
, 
m≠ba£
 + 
SA1111_INTEN1
);

302 
	}
}

311 
	$ß1111_ªåiggî_highúq
(
úq
)

313 
mask
 = 
	`SA1111_IRQMASK_HI
(
úq
);

314 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

315 
ù1
;

316 
i
;

318 
ù1
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTPOL1
);

319 
i
 = 0; i < 8; i++) {

320 
	`ß1111_wrôñ
(
ù1
 ^ 
mask
, 
m≠ba£
 + 
SA1111_INTPOL1
);

321 
	`ß1111_wrôñ
(
ù1
, 
m≠ba£
 + 
SA1111_INTPOL1
);

322 i‡(
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTSTATCLR1
Ë& 
mask
)

326 i‡(
i
 == 8)

327 
	`¥ötk
(
KERN_ERR
 "Danger Will Robinson: failedÅo "

328 "ª-åiggî IRQ%d\n", 
úq
);

329  
i
 == 8 ? -1 : 0;

330 
	}
}

332 
	$ß1111_ty≥_highúq
(
úq
, 
Êags
)

334 
mask
 = 
	`SA1111_IRQMASK_HI
(
úq
);

335 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

336 
ù1
;

338 i‡(
Êags
 =
IRQT_PROBE
)

341 i‡((!(
Êags
 & 
__IRQT_RISEDGE
Ë^ !(Êag†& 
__IRQT_FALEDGE
)) == 0)

342  -
EINVAL
;

344 
ù1
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_INTPOL1
);

345 i‡(
Êags
 & 
__IRQT_RISEDGE
)

346 
ù1
 &~
mask
;

348 
ù1
 |
mask
;

349 
	`ß1111_wrôñ
(
ù1
, 
m≠ba£
 + 
SA1111_INTPOL1
);

350 
	`ß1111_wrôñ
(
ù1
, 
m≠ba£
 + 
SA1111_WAKEPOL1
);

353 
	}
}

355 
	$ß1111_wake_highúq
(
úq
, 
⁄
)

357 
mask
 = 
	`SA1111_IRQMASK_HI
(
úq
);

358 
__iomem
 *
m≠ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

359 
we1
;

361 
we1
 = 
	`ß1111_ªadl
(
m≠ba£
 + 
SA1111_WAKEEN1
);

362 i‡(
⁄
)

363 
we1
 |
mask
;

365 
we1
 &~
mask
;

366 
	`ß1111_wrôñ
(
we1
, 
m≠ba£
 + 
SA1111_WAKEEN1
);

369 
	}
}

371 
úq_chù
 
	gß1111_high_chù
 = {

372 .
«me
 = "SA1111-h",

373 .
	gack
 = 
ß1111_ack_úq
,

374 .
	gmask
 = 
ß1111_mask_highúq
,

375 .
	gunmask
 = 
ß1111_unmask_highúq
,

376 .
	gªåiggî
 = 
ß1111_ªåiggî_highúq
,

377 .
	g£t_ty≥
 = 
ß1111_ty≥_highúq
,

378 .
	g£t_wake
 = 
ß1111_wake_highúq
,

381 
	$ß1111_£tup_úq
(
ß1111
 *
ßchù
)

383 
__iomem
 *
úqba£
 = 
ßchù
->
ba£
 + 
SA1111_INTC
;

384 
úq
;

389 
	`ªque°_mem_ªgi⁄
(
ßchù
->
phys
 + 
SA1111_INTC
, 512, "irq");

392 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_INTEN0
);

393 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_INTEN1
);

394 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_WAKEEN0
);

395 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_WAKEEN1
);

401 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_INTPOL0
);

402 
	`ß1111_wrôñ
(
	`SA1111_IRQMASK_HI
(
IRQ_S0_READY_NINT
) |

403 
	`SA1111_IRQMASK_HI
(
IRQ_S1_READY_NINT
),

404 
úqba£
 + 
SA1111_INTPOL1
);

407 
	`ß1111_wrôñ
(~0, 
úqba£
 + 
SA1111_INTSTATCLR0
);

408 
	`ß1111_wrôñ
(~0, 
úqba£
 + 
SA1111_INTSTATCLR1
);

410 
úq
 = 
IRQ_GPAIN0
; irq <
SSPROR
; irq++) {

411 
	`£t_úq_chù
(
úq
, &
ß1111_low_chù
);

412 
	`£t_úq_chù_d©a
(
úq
, 
úqba£
);

413 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

414 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

417 
úq
 = 
AUDXMTDMADONEA
; irq <
IRQ_S1_BVD1_STSCHG
; irq++) {

418 
	`£t_úq_chù
(
úq
, &
ß1111_high_chù
);

419 
	`£t_úq_chù_d©a
(
úq
, 
úqba£
);

420 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

421 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

427 
	`£t_úq_ty≥
(
ßchù
->
úq
, 
IRQT_RISING
);

428 
	`£t_úq_d©a
(
ßchù
->
úq
, 
úqba£
);

429 
	`£t_úq_chaöed_h™dÀr
(
ßchù
->
úq
, 
ß1111_úq_h™dÀr
);

430 
	}
}

446 
	$ß1111_wake
(
ß1111
 *
ßchù
)

448 
Êags
, 
r
;

450 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

452 
	`˛k_íabÀ
(
ßchù
->
˛k
);

457 
r
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKCR
);

458 
r
 &~
SKCR_VCO_OFF
;

459 
	`ß1111_wrôñ
(
r
, 
ßchù
->
ba£
 + 
SA1111_SKCR
);

460 
r
 |
SKCR_PLL_BYPASS
 | 
SKCR_OE_EN
;

461 
	`ß1111_wrôñ
(
r
, 
ßchù
->
ba£
 + 
SA1111_SKCR
);

467 
	`udñay
(100);

472 
r
 |
SKCR_RCLKEN
 | 
SKCR_RDYEN
;

473 
	`ß1111_wrôñ
(
r
, 
ßchù
->
ba£
 + 
SA1111_SKCR
);

479 
	`udñay
(1);

484 
	`ß1111_wrôñ
(0, 
ßchù
->
ba£
 + 
SA1111_SKPCR
);

486 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

487 
	}
}

489 #ifde‡
CONFIG_ARCH_SA1100


491 
u32
 
	gß1111_dma_mask
[] = {

506 
	$ß1111_c⁄figuª_smc
(
ß1111
 *
ßchù
, 
sdøm
, 
døc
,

507 
ˇs_œãncy
)

509 
sm¸
 = 
SMCR_DTIM
 | 
SMCR_MBGE
 | 
	`FIn§t
(
døc
, 
SMCR_DRAC
);

511 i‡(
ˇs_œãncy
 == 3)

512 
sm¸
 |
SMCR_CLAT
;

514 
	`ß1111_wrôñ
(
sm¸
, 
ßchù
->
ba£
 + 
SA1111_SMCR
);

521 i‡(
ßchù
->
dev
->
dma_mask
)

522 *
ßchù
->
dev
->
dma_mask
 &
ß1111_dma_mask
[
døc
 >> 2];

524 
ßchù
->
dev
->
cohîít_dma_mask
 &
ß1111_dma_mask
[
døc
 >> 2];

525 
	}
}

529 
	$ß1111_dev_ªÀa£
(
devi˚
 *
_dev
)

531 
ß1111_dev
 *
dev
 = 
	`SA1111_DEV
(
_dev
);

533 
	`ªÀa£_ªsour˚
(&
dev
->
ªs
);

534 
	`k‰ì
(
dev
);

535 
	}
}

538 
	$ß1111_öô_⁄e_chûd
(
ß1111
 *
ßchù
, 
ªsour˚
 *
∑ª¡
,

539 
ß1111_dev_öfo
 *
öfo
)

541 
ß1111_dev
 *
dev
;

542 
ªt
;

544 
dev
 = 
	`kzÆloc
((
ß1111_dev
), 
GFP_KERNEL
);

545 i‡(!
dev
) {

546 
ªt
 = -
ENOMEM
;

547 
out
;

550 
	`¢¥ötf
(
dev
->dev.
bus_id
, (dev->dev.bus_id),

551 "%4.4lx", 
öfo
->
off£t
);

553 
dev
->
devid
 = 
öfo
->devid;

554 
dev
->dev.
∑ª¡
 = 
ßchù
->dev;

555 
dev
->dev.
bus
 = &
ß1111_bus_ty≥
;

556 
dev
->dev.
ªÀa£
 = 
ß1111_dev_ªÀa£
;

557 
dev
->dev.
cohîít_dma_mask
 = 
ßchù
->dev->coherent_dma_mask;

558 
dev
->
ªs
.
°¨t
 = 
ßchù
->
phys
 + 
öfo
->
off£t
;

559 
dev
->
ªs
.
íd
 = dev->ªs.
°¨t
 + 511;

560 
dev
->
ªs
.
«me
 = dev->dev.
bus_id
;

561 
dev
->
ªs
.
Êags
 = 
IORESOURCE_MEM
;

562 
dev
->
m≠ba£
 = 
ßchù
->
ba£
 + 
öfo
->
off£t
;

563 
dev
->
skp¸_mask
 = 
öfo
->skpcr_mask;

564 
	`memmove
(
dev
->
úq
, 
öfo
->irq, (dev->irq));

566 
ªt
 = 
	`ªque°_ªsour˚
(
∑ª¡
, &
dev
->
ªs
);

567 i‡(
ªt
) {

568 
	`¥ötk
("SA1111: failedÅoállocateÑesource for %s\n",

569 
dev
->
ªs
.
«me
);

570 
	`k‰ì
(
dev
);

571 
out
;

575 
ªt
 = 
	`devi˚_ªgi°î
(&
dev
->dev);

576 i‡(
ªt
) {

577 
	`ªÀa£_ªsour˚
(&
dev
->
ªs
);

578 
	`k‰ì
(
dev
);

579 
out
;

586 i‡(
ßchù
->
dev
->
dma_mask
) {

587 
dev
->
dma_mask
 = *
ßchù
->dev->dma_mask;

588 
dev
->dev.
dma_mask
 = &dev->dma_mask;

590 i‡(
dev
->
dma_mask
 != 0xffffffffUL) {

591 
ªt
 = 
	`dmaboun˚_ªgi°î_dev
(&
dev
->dev, 1024, 4096);

592 i‡(
ªt
) {

593 
	`¥ötk
("SA1111: FaûedÅÿªgi°î %†wôh dmaboun˚", 
dev
->dev.
bus_id
);

594 
	`devi˚_uƒegi°î
(&
dev
->dev);

599 
out
:

600  
ªt
;

601 
	}
}

616 
	$__ß1111_¥obe
(
devi˚
 *
me
, 
ªsour˚
 *
mem
, 
úq
)

618 
ß1111
 *
ßchù
;

619 
id
;

620 
has_devs
;

621 
i
, 
ªt
 = -
ENODEV
;

623 
ßchù
 = 
	`kzÆloc
((
ß1111
), 
GFP_KERNEL
);

624 i‡(!
ßchù
)

625  -
ENOMEM
;

627 
ßchù
->
˛k
 = 
	`˛k_gë
(
me
, "GPIO27_CLK");

628 i‡(!
ßchù
->
˛k
) {

629 
ªt
 = 
	`PTR_ERR
(
ßchù
->
˛k
);

630 
îr_‰ì
;

633 
	`•ö_lock_öô
(&
ßchù
->
lock
);

635 
ßchù
->
dev
 = 
me
;

636 
	`dev_£t_drvd©a
(
ßchù
->
dev
, sachip);

638 
ßchù
->
phys
 = 
mem
->
°¨t
;

639 
ßchù
->
úq
 = irq;

645 
ßchù
->
ba£
 = 
	`i‹em≠
(
mem
->
°¨t
, 
PAGE_SIZE
 * 2);

646 i‡(!
ßchù
->
ba£
) {

647 
ªt
 = -
ENOMEM
;

648 
îr_˛kput
;

654 
id
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKID
);

655 i‡((
id
 & 
SKID_ID_MASK
Ë!
SKID_SA1111_ID
) {

656 
	`¥ötk
(
KERN_DEBUG
 "SA1111ÇŸ dëe˘ed: ID = %08lx\n", 
id
);

657 
ªt
 = -
ENODEV
;

658 
îr_unm≠
;

661 
	`¥ötk
(
KERN_INFO
 "SA1111 Microprocessor Companion Chip: "

663 (
id
 & 
SKID_SIREV_MASK
)>>4, (id & 
SKID_MTREV_MASK
));

668 
	`ß1111_wake
(
ßchù
);

670 #ifde‡
CONFIG_ARCH_SA1100


672 
vÆ
;

681 
	`ß1111_c⁄figuª_smc
(
ßchù
, 1,

682 
	`FExå
(
MDCNFG
, 
MDCNFG_SA1110_DRAC0
),

683 
	`FExå
(
MDCNFG
, 
MDCNFG_SA1110_TDL0
));

690 
vÆ
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKPCR
);

691 
	`ß1111_wrôñ
(
vÆ
 | 
SKPCR_DCLKEN
, 
ßchù
->
ba£
 + 
SA1111_SKPCR
);

696 
	`ß1110_mb_íabÀ
();

704 i‡(
ßchù
->
úq
 !
NO_IRQ
)

705 
	`ß1111_£tup_úq
(
ßchù
);

707 
g_ß1111
 = 
ßchù
;

709 
has_devs
 = ~0;

710 i‡(
	`machöe_is_asßbë
(Ë|| 
	`machöe_is_j‹«da720
() ||

711 
	`machöe_is_badge4
())

712 
has_devs
 &= ~(1 << 4);

714 
has_devs
 &= ~(1 << 1);

716 
i
 = 0; i < 
	`ARRAY_SIZE
(
ß1111_devi˚s
); i++)

717 i‡(
has_devs
 & (1 << 
i
))

718 
	`ß1111_öô_⁄e_chûd
(
ßchù
, 
mem
, &
ß1111_devi˚s
[
i
]);

722 
îr_unm≠
:

723 
	`iounm≠
(
ßchù
->
ba£
);

724 
îr_˛kput
:

725 
	`˛k_put
(
ßchù
->
˛k
);

726 
îr_‰ì
:

727 
	`k‰ì
(
ßchù
);

728  
ªt
;

729 
	}
}

731 
	$ß1111_ªmove_⁄e
(
devi˚
 *
dev
, *
d©a
)

733 
	`devi˚_uƒegi°î
(
dev
);

735 
	}
}

737 
	$__ß1111_ªmove
(
ß1111
 *
ßchù
)

739 
__iomem
 *
úqba£
 = 
ßchù
->
ba£
 + 
SA1111_INTC
;

741 
	`devi˚_f‹_óch_chûd
(
ßchù
->
dev
, 
NULL
, 
ß1111_ªmove_⁄e
);

744 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_INTEN0
);

745 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_INTEN1
);

746 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_WAKEEN0
);

747 
	`ß1111_wrôñ
(0, 
úqba£
 + 
SA1111_WAKEEN1
);

749 
	`˛k_dißbÀ
(
ßchù
->
˛k
);

751 i‡(
ßchù
->
úq
 !
NO_IRQ
) {

752 
	`£t_úq_chaöed_h™dÀr
(
ßchù
->
úq
, 
NULL
);

753 
	`£t_úq_d©a
(
ßchù
->
úq
, 
NULL
);

755 
	`ªÀa£_mem_ªgi⁄
(
ßchù
->
phys
 + 
SA1111_INTC
, 512);

758 
	`iounm≠
(
ßchù
->
ba£
);

759 
	`˛k_put
(
ßchù
->
˛k
);

760 
	`k‰ì
(
ßchù
);

761 
	}
}

778 
	$dma_√eds_boun˚
(
devi˚
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
)

787  ((
	`machöe_is_asßbë
(Ë|| 
	`machöe_is_pfs168
()) &&

788 (
addr
 >0xc8000000 || (add∏+ 
size
) >= 0xc8000000));

789 
	}
}

791 
	sß1111_ßve_d©a
 {

792 
	msk¸
;

793 
	mskp¸
;

794 
	mskcdr
;

795 
	mskaud
;

796 
	mskpwm0
;

797 
	mskpwm1
;

802 
	möçﬁ0
;

803 
	möçﬁ1
;

804 
	möãn0
;

805 
	möãn1
;

806 
	mwakïﬁ0
;

807 
	mwakïﬁ1
;

808 
	mwakìn0
;

809 
	mwakìn1
;

812 #ifde‡
CONFIG_PM


814 
	$ß1111_su•íd
(
∂©f‹m_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

816 
ß1111
 *
ßchù
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

817 
ß1111_ßve_d©a
 *
ßve
;

818 
Êags
;

819 
vÆ
;

820 
__iomem
 *
ba£
;

822 
ßve
 = 
	`kmÆloc
((
ß1111_ßve_d©a
), 
GFP_KERNEL
);

823 i‡(!
ßve
)

824  -
ENOMEM
;

825 
dev
->dev.
powî
.
ßved_°©e
 = 
ßve
;

827 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

832 
ba£
 = 
ßchù
->base;

833 
ßve
->
sk¸
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKCR
);

834 
ßve
->
skp¸
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKPCR
);

835 
ßve
->
skcdr
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKCDR
);

836 
ßve
->
skaud
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKAUD
);

837 
ßve
->
skpwm0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKPWM0
);

838 
ßve
->
skpwm1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_SKPWM1
);

840 
ba£
 = 
ßchù
->ba£ + 
SA1111_INTC
;

841 
ßve
->
öçﬁ0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTPOL0
);

842 
ßve
->
öçﬁ1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTPOL1
);

843 
ßve
->
öãn0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTEN0
);

844 
ßve
->
öãn1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_INTEN1
);

845 
ßve
->
wakïﬁ0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_WAKEPOL0
);

846 
ßve
->
wakïﬁ1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_WAKEPOL1
);

847 
ßve
->
wakìn0
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_WAKEEN0
);

848 
ßve
->
wakìn1
 = 
	`ß1111_ªadl
(
ba£
 + 
SA1111_WAKEEN1
);

853 
vÆ
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKCR
);

854 
	`ß1111_wrôñ
(
vÆ
 | 
SKCR_SLEEP
, 
ßchù
->
ba£
 + 
SA1111_SKCR
);

855 
	`ß1111_wrôñ
(0, 
ßchù
->
ba£
 + 
SA1111_SKPWM0
);

856 
	`ß1111_wrôñ
(0, 
ßchù
->
ba£
 + 
SA1111_SKPWM1
);

858 
	`˛k_dißbÀ
(
ßchù
->
˛k
);

860 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

863 
	}
}

874 
	$ß1111_ªsume
(
∂©f‹m_devi˚
 *
dev
)

876 
ß1111
 *
ßchù
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

877 
ß1111_ßve_d©a
 *
ßve
;

878 
Êags
, 
id
;

879 
__iomem
 *
ba£
;

881 
ßve
 = (
ß1111_ßve_d©a
 *)
dev
->dev.
powî
.
ßved_°©e
;

882 i‡(!
ßve
)

885 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

891 
id
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKID
);

892 i‡((
id
 & 
SKID_ID_MASK
Ë!
SKID_SA1111_ID
) {

893 
	`__ß1111_ªmove
(
ßchù
);

894 
	`∂©f‹m_£t_drvd©a
(
dev
, 
NULL
);

895 
	`k‰ì
(
ßve
);

902 
	`ß1111_wake
(
ßchù
);

903 
	`ß1111_wrôñ
(0, 
ßchù
->
ba£
 + 
SA1111_INTC
 + 
SA1111_INTEN0
);

904 
	`ß1111_wrôñ
(0, 
ßchù
->
ba£
 + 
SA1111_INTC
 + 
SA1111_INTEN1
);

906 
ba£
 = 
ßchù
->base;

907 
	`ß1111_wrôñ
(
ßve
->
sk¸
, 
ba£
 + 
SA1111_SKCR
);

908 
	`ß1111_wrôñ
(
ßve
->
skp¸
, 
ba£
 + 
SA1111_SKPCR
);

909 
	`ß1111_wrôñ
(
ßve
->
skcdr
, 
ba£
 + 
SA1111_SKCDR
);

910 
	`ß1111_wrôñ
(
ßve
->
skaud
, 
ba£
 + 
SA1111_SKAUD
);

911 
	`ß1111_wrôñ
(
ßve
->
skpwm0
, 
ba£
 + 
SA1111_SKPWM0
);

912 
	`ß1111_wrôñ
(
ßve
->
skpwm1
, 
ba£
 + 
SA1111_SKPWM1
);

914 
ba£
 = 
ßchù
->ba£ + 
SA1111_INTC
;

915 
	`ß1111_wrôñ
(
ßve
->
öçﬁ0
, 
ba£
 + 
SA1111_INTPOL0
);

916 
	`ß1111_wrôñ
(
ßve
->
öçﬁ1
, 
ba£
 + 
SA1111_INTPOL1
);

917 
	`ß1111_wrôñ
(
ßve
->
öãn0
, 
ba£
 + 
SA1111_INTEN0
);

918 
	`ß1111_wrôñ
(
ßve
->
öãn1
, 
ba£
 + 
SA1111_INTEN1
);

919 
	`ß1111_wrôñ
(
ßve
->
wakïﬁ0
, 
ba£
 + 
SA1111_WAKEPOL0
);

920 
	`ß1111_wrôñ
(
ßve
->
wakïﬁ1
, 
ba£
 + 
SA1111_WAKEPOL1
);

921 
	`ß1111_wrôñ
(
ßve
->
wakìn0
, 
ba£
 + 
SA1111_WAKEEN0
);

922 
	`ß1111_wrôñ
(
ßve
->
wakìn1
, 
ba£
 + 
SA1111_WAKEEN1
);

924 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

926 
dev
->dev.
powî
.
ßved_°©e
 = 
NULL
;

927 
	`k‰ì
(
ßve
);

930 
	}
}

933 
	#ß1111_su•íd
 
NULL


	)

934 
	#ß1111_ªsume
 
NULL


	)

937 
	$ß1111_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

939 
ªsour˚
 *
mem
;

940 
úq
;

942 
mem
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_MEM
, 0);

943 i‡(!
mem
)

944  -
EINVAL
;

945 
úq
 = 
	`∂©f‹m_gë_úq
(
pdev
, 0);

946 i‡(
úq
 < 0)

947  -
ENXIO
;

949  
	`__ß1111_¥obe
(&
pdev
->
dev
, 
mem
, 
úq
);

950 
	}
}

952 
	$ß1111_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

954 
ß1111
 *
ßchù
 = 
	`∂©f‹m_gë_drvd©a
(
pdev
);

956 i‡(
ßchù
) {

957 
	`__ß1111_ªmove
(
ßchù
);

958 
	`∂©f‹m_£t_drvd©a
(
pdev
, 
NULL
);

960 #ifde‡
CONFIG_PM


961 
	`k‰ì
(
pdev
->
dev
.
powî
.
ßved_°©e
);

962 
pdev
->
dev
.
powî
.
ßved_°©e
 = 
NULL
;

967 
	}
}

978 
∂©f‹m_drivî
 
	gß1111_devi˚_drivî
 = {

979 .
¥obe
 = 
ß1111_¥obe
,

980 .
	gªmove
 = 
ß1111_ªmove
,

981 .
	gsu•íd
 = 
ß1111_su•íd
,

982 .
	gªsume
 = 
ß1111_ªsume
,

983 .
	gdrivî
 = {

984 .
«me
 = "sa1111",

992 
ölöe
 
ß1111
 *
	$ß1111_chù_drivî
(
ß1111_dev
 *
ßdev
)

994  (
ß1111
 *)
	`dev_gë_drvd©a
(
ßdev
->
dev
.
∑ª¡
);

995 
	}
}

1000 
	g›div_èbÀ
[] = { 1, 4, 2, 8 };

1002 
	$__ß1111_∂l_˛ock
(
ß1111
 *
ßchù
)

1004 
skcdr
, 
fbdiv
, 
ùdiv
, 
›div
;

1006 
skcdr
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKCDR
);

1008 
fbdiv
 = (
skcdr
 & 0x007f) + 2;

1009 
ùdiv
 = ((
skcdr
 & 0x0f80) >> 7) + 2;

1010 
›div
 = 
›div_èbÀ
[(
skcdr
 & 0x3000) >> 12];

1012  3686400 * 
fbdiv
 / (
ùdiv
 * 
›div
);

1013 
	}
}

1024 
	$ß1111_∂l_˛ock
(
ß1111_dev
 *
ßdev
)

1026 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1028  
	`__ß1111_∂l_˛ock
(
ßchù
);

1029 
	}
}

1039 
	$ß1111_£À˘_audio_mode
(
ß1111_dev
 *
ßdev
, 
mode
)

1041 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1042 
Êags
;

1043 
vÆ
;

1045 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1047 
vÆ
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKCR
);

1048 i‡(
mode
 =
SA1111_AUDIO_I2S
) {

1049 
vÆ
 &~
SKCR_SELAC
;

1051 
vÆ
 |
SKCR_SELAC
;

1053 
	`ß1111_wrôñ
(
vÆ
, 
ßchù
->
ba£
 + 
SA1111_SKCR
);

1055 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1056 
	}
}

1063 
	$ß1111_£t_audio_øã
(
ß1111_dev
 *
ßdev
, 
øã
)

1065 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1066 
div
;

1068 i‡(
ßdev
->
devid
 !
SA1111_DEVID_SAC
)

1069  -
EINVAL
;

1071 
div
 = (
	`__ß1111_∂l_˛ock
(
ßchù
Ë/ 256 + 
øã
 / 2) /Ñate;

1072 i‡(
div
 == 0)

1073 
div
 = 1;

1074 i‡(
div
 > 128)

1075 
div
 = 128;

1077 
	`ß1111_wrôñ
(
div
 - 1, 
ßchù
->
ba£
 + 
SA1111_SKAUD
);

1080 
	}
}

1086 
	$ß1111_gë_audio_øã
(
ß1111_dev
 *
ßdev
)

1088 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1089 
div
;

1091 i‡(
ßdev
->
devid
 !
SA1111_DEVID_SAC
)

1092  -
EINVAL
;

1094 
div
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKAUD
) + 1;

1096  
	`__ß1111_∂l_˛ock
(
ßchù
Ë/ (256 * 
div
);

1097 
	}
}

1099 
	$ß1111_£t_io_dú
(
ß1111_dev
 *
ßdev
,

1100 
bôs
, 
dú
,

1101 
¶ìp_dú
)

1103 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1104 
Êags
;

1105 
vÆ
;

1106 
__iomem
 *
gpio
 = 
ßchù
->
ba£
 + 
SA1111_GPIO
;

1108 
	#MODIFY_BITS
(
p‹t
, 
mask
, 
dú
) \

1109 i‡(
mask
) { \

1110 
vÆ
 = 
	`ß1111_ªadl
(
p‹t
); \

1111 
vÆ
 &~(
mask
); \

1112 
vÆ
 |(
dú
Ë& (
mask
); \

1113 
	`ß1111_wrôñ
(
vÆ
, 
p‹t
); \

1114 }

	)

1116 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1117 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PADDR
, 
bôs
 & 15, 
dú
);

1118 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PBDDR
, (
bôs
 >> 8Ë& 255, 
dú
 >> 8);

1119 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PCDDR
, (
bôs
 >> 16Ë& 255, 
dú
 >> 16);

1121 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PASDR
, 
bôs
 & 15, 
¶ìp_dú
);

1122 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PBSDR
, (
bôs
 >> 8Ë& 255, 
¶ìp_dú
 >> 8);

1123 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PCSDR
, (
bôs
 >> 16Ë& 255, 
¶ìp_dú
 >> 16);

1124 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1125 
	}
}

1127 
	$ß1111_£t_io
(
ß1111_dev
 *
ßdev
, 
bôs
, 
v
)

1129 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1130 
Êags
;

1131 
vÆ
;

1132 
__iomem
 *
gpio
 = 
ßchù
->
ba£
 + 
SA1111_GPIO
;

1134 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1135 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PADWR
, 
bôs
 & 15, 
v
);

1136 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PBDWR
, (
bôs
 >> 8Ë& 255, 
v
 >> 8);

1137 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PCDWR
, (
bôs
 >> 16Ë& 255, 
v
 >> 16);

1138 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1139 
	}
}

1141 
	$ß1111_£t_¶ìp_io
(
ß1111_dev
 *
ßdev
, 
bôs
, 
v
)

1143 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1144 
Êags
;

1145 
vÆ
;

1146 
__iomem
 *
gpio
 = 
ßchù
->
ba£
 + 
SA1111_GPIO
;

1148 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1149 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PASSR
, 
bôs
 & 15, 
v
);

1150 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PBSSR
, (
bôs
 >> 8Ë& 255, 
v
 >> 8);

1151 
	`MODIFY_BITS
(
gpio
 + 
SA1111_GPIO_PCSSR
, (
bôs
 >> 16Ë& 255, 
v
 >> 16);

1152 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1153 
	}
}

1163 
	$ß1111_íabÀ_devi˚
(
ß1111_dev
 *
ßdev
)

1165 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1166 
Êags
;

1167 
vÆ
;

1169 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1170 
vÆ
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKPCR
);

1171 
	`ß1111_wrôñ
(
vÆ
 | 
ßdev
->
skp¸_mask
, 
ßchù
->
ba£
 + 
SA1111_SKPCR
);

1172 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1173 
	}
}

1179 
	$ß1111_dißbÀ_devi˚
(
ß1111_dev
 *
ßdev
)

1181 
ß1111
 *
ßchù
 = 
	`ß1111_chù_drivî
(
ßdev
);

1182 
Êags
;

1183 
vÆ
;

1185 
	`•ö_lock_úqßve
(&
ßchù
->
lock
, 
Êags
);

1186 
vÆ
 = 
	`ß1111_ªadl
(
ßchù
->
ba£
 + 
SA1111_SKPCR
);

1187 
	`ß1111_wrôñ
(
vÆ
 & ~
ßdev
->
skp¸_mask
, 
ßchù
->
ba£
 + 
SA1111_SKPCR
);

1188 
	`•ö_u∆ock_úqª°‹e
(&
ßchù
->
lock
, 
Êags
);

1189 
	}
}

1197 
	$ß1111_m©ch
(
devi˚
 *
_dev
, 
devi˚_drivî
 *
_drv
)

1199 
ß1111_dev
 *
dev
 = 
	`SA1111_DEV
(
_dev
);

1200 
ß1111_drivî
 *
drv
 = 
	`SA1111_DRV
(
_drv
);

1202  
dev
->
devid
 =
drv
->devid;

1203 
	}
}

1205 
	$ß1111_bus_su•íd
(
devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

1207 
ß1111_dev
 *
ßdev
 = 
	`SA1111_DEV
(
dev
);

1208 
ß1111_drivî
 *
drv
 = 
	`SA1111_DRV
(
dev
->
drivî
);

1209 
ªt
 = 0;

1211 i‡(
drv
 && drv->
su•íd
)

1212 
ªt
 = 
drv
->
	`su•íd
(
ßdev
, 
°©e
);

1213  
ªt
;

1214 
	}
}

1216 
	$ß1111_bus_ªsume
(
devi˚
 *
dev
)

1218 
ß1111_dev
 *
ßdev
 = 
	`SA1111_DEV
(
dev
);

1219 
ß1111_drivî
 *
drv
 = 
	`SA1111_DRV
(
dev
->
drivî
);

1220 
ªt
 = 0;

1222 i‡(
drv
 && drv->
ªsume
)

1223 
ªt
 = 
drv
->
	`ªsume
(
ßdev
);

1224  
ªt
;

1225 
	}
}

1227 
	$ß1111_bus_¥obe
(
devi˚
 *
dev
)

1229 
ß1111_dev
 *
ßdev
 = 
	`SA1111_DEV
(
dev
);

1230 
ß1111_drivî
 *
drv
 = 
	`SA1111_DRV
(
dev
->
drivî
);

1231 
ªt
 = -
ENODEV
;

1233 i‡(
drv
->
¥obe
)

1234 
ªt
 = 
drv
->
	`¥obe
(
ßdev
);

1235  
ªt
;

1236 
	}
}

1238 
	$ß1111_bus_ªmove
(
devi˚
 *
dev
)

1240 
ß1111_dev
 *
ßdev
 = 
	`SA1111_DEV
(
dev
);

1241 
ß1111_drivî
 *
drv
 = 
	`SA1111_DRV
(
dev
->
drivî
);

1242 
ªt
 = 0;

1244 i‡(
drv
->
ªmove
)

1245 
ªt
 = 
drv
->
	`ªmove
(
ßdev
);

1246  
ªt
;

1247 
	}
}

1249 
bus_ty≥
 
	gß1111_bus_ty≥
 = {

1250 .
«me
 = "sa1111-rab",

1251 .
	gm©ch
 = 
ß1111_m©ch
,

1252 .
	g¥obe
 = 
ß1111_bus_¥obe
,

1253 .
	gªmove
 = 
ß1111_bus_ªmove
,

1254 .
	gsu•íd
 = 
ß1111_bus_su•íd
,

1255 .
	gªsume
 = 
ß1111_bus_ªsume
,

1258 
	$ß1111_drivî_ªgi°î
(
ß1111_drivî
 *
drivî
)

1260 
drivî
->
drv
.
bus
 = &
ß1111_bus_ty≥
;

1261  
	`drivî_ªgi°î
(&
drivî
->
drv
);

1262 
	}
}

1264 
	$ß1111_drivî_uƒegi°î
(
ß1111_drivî
 *
drivî
)

1266 
	`drivî_uƒegi°î
(&
drivî
->
drv
);

1267 
	}
}

1269 
__öô
 
	$ß1111_öô
()

1271 
ªt
 = 
	`bus_ªgi°î
(&
ß1111_bus_ty≥
);

1272 i‡(
ªt
 == 0)

1273 
	`∂©f‹m_drivî_ªgi°î
(&
ß1111_devi˚_drivî
);

1274  
ªt
;

1275 
	}
}

1277 
__exô
 
	$ß1111_exô
()

1279 
	`∂©f‹m_drivî_uƒegi°î
(&
ß1111_devi˚_drivî
);

1280 
	`bus_uƒegi°î
(&
ß1111_bus_ty≥
);

1281 
	}
}

1283 
subsys_öôˇŒ
(
ß1111_öô
);

1284 
moduÀ_exô
(
ß1111_exô
);

1286 
MODULE_DESCRIPTION
("Intel Corporation SA1111 core driver");

1287 
MODULE_LICENSE
("GPL");

1289 
EXPORT_SYMBOL
(
ß1111_£À˘_audio_mode
);

1290 
EXPORT_SYMBOL
(
ß1111_£t_audio_øã
);

1291 
EXPORT_SYMBOL
(
ß1111_gë_audio_øã
);

1292 
EXPORT_SYMBOL
(
ß1111_£t_io_dú
);

1293 
EXPORT_SYMBOL
(
ß1111_£t_io
);

1294 
EXPORT_SYMBOL
(
ß1111_£t_¶ìp_io
);

1295 
EXPORT_SYMBOL
(
ß1111_íabÀ_devi˚
);

1296 
EXPORT_SYMBOL
(
ß1111_dißbÀ_devi˚
);

1297 
EXPORT_SYMBOL
(
ß1111_∂l_˛ock
);

1298 
EXPORT_SYMBOL
(
ß1111_bus_ty≥
);

1299 
EXPORT_SYMBOL
(
ß1111_drivî_ªgi°î
);

1300 
EXPORT_SYMBOL
(
ß1111_drivî_uƒegi°î
);

	@arch/arm/common/scoop.c

14 
	~<löux/devi˚.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<asm/io.h
>

19 
	~<asm/h¨dw¨e/sco›.h
>

30 
sco›_pcmcü_c⁄fig
 *
	g∂©f‹m_sco›_c⁄fig
;

31 
EXPORT_SYMBOL
(
∂©f‹m_sco›_c⁄fig
);

33 
	#SCOOP_REG
(
d
,
adr
Ë(*(vﬁ©ûê*)(d +◊dr)))

	)

35 
	ssco›_dev
 {

36 *
	mba£
;

37 
•ölock_t
 
	msco›_lock
;

38 
	msu•íd_˛r
;

39 
	msu•íd_£t
;

40 
u32
 
	msco›_gpwr
;

43 
	$ª£t_sco›
(
devi˚
 *
dev
)

45 
sco›_dev
 *
sdev
 = 
	`dev_gë_drvd©a
(
dev
);

47 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_MCR
) = 0x0100;

48 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_CDR
) = 0x0000;

49 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_CCR
) = 0x0000;

50 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_IMR
) = 0x0000;

51 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_IRM
) = 0x00FF;

52 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_ISR
) = 0x0000;

53 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_IRM
) = 0x0000;

54 
	}
}

56 
	$£t_sco›_gpio
(
devi˚
 *
dev
, 
bô
)

58 
gpio_bô
;

59 
Êag
;

60 
sco›_dev
 *
sdev
 = 
	`dev_gë_drvd©a
(
dev
);

62 
	`•ö_lock_úqßve
(&
sdev
->
sco›_lock
, 
Êag
);

63 
gpio_bô
 = 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_GPWR
Ë| 
bô
;

64 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_GPWR
Ë
gpio_bô
;

65 
	`•ö_u∆ock_úqª°‹e
(&
sdev
->
sco›_lock
, 
Êag
);

67  
gpio_bô
;

68 
	}
}

70 
	$ª£t_sco›_gpio
(
devi˚
 *
dev
, 
bô
)

72 
gpio_bô
;

73 
Êag
;

74 
sco›_dev
 *
sdev
 = 
	`dev_gë_drvd©a
(
dev
);

76 
	`•ö_lock_úqßve
(&
sdev
->
sco›_lock
, 
Êag
);

77 
gpio_bô
 = 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_GPWR
Ë& ~
bô
;

78 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_GPWR
Ë
gpio_bô
;

79 
	`•ö_u∆ock_úqª°‹e
(&
sdev
->
sco›_lock
, 
Êag
);

81  
gpio_bô
;

82 
	}
}

84 
EXPORT_SYMBOL
(
£t_sco›_gpio
);

85 
EXPORT_SYMBOL
(
ª£t_sco›_gpio
);

87 
	$ªad_sco›_ªg
(
devi˚
 *
dev
, 
ªg
)

89 
sco›_dev
 *
sdev
 = 
	`dev_gë_drvd©a
(
dev
);

90  
	`SCOOP_REG
(
sdev
->
ba£
,
ªg
);

91 
	}
}

93 
	$wrôe_sco›_ªg
(
devi˚
 *
dev
, 
ªg
, 
d©a
)

95 
sco›_dev
 *
sdev
 = 
	`dev_gë_drvd©a
(
dev
);

96 
	`SCOOP_REG
(
sdev
->
ba£
,
ªg
)=
d©a
;

97 
	}
}

99 
EXPORT_SYMBOL
(
ª£t_sco›
);

100 
EXPORT_SYMBOL
(
ªad_sco›_ªg
);

101 
EXPORT_SYMBOL
(
wrôe_sco›_ªg
);

103 
	$check_sco›_ªg
(
sco›_dev
 *
sdev
)

105 
m¸
;

107 
m¸
 = 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_MCR
);

108 i‡((
m¸
 & 0x100) == 0)

109 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_MCR
) = 0x0101;

110 
	}
}

112 #ifde‡
CONFIG_PM


113 
	$sco›_su•íd
(
∂©f‹m_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

115 
sco›_dev
 *
sdev
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

117 
	`check_sco›_ªg
(
sdev
);

118 
sdev
->
sco›_gpwr
 = 
	`SCOOP_REG
(sdev->
ba£
, 
SCOOP_GPWR
);

119 
	`SCOOP_REG
(
sdev
->
ba£
, 
SCOOP_GPWR
Ë(sdev->
sco›_gpwr
 & ~sdev->
su•íd_˛r
Ë| sdev->
su•íd_£t
;

122 
	}
}

124 
	$sco›_ªsume
(
∂©f‹m_devi˚
 *
dev
)

126 
sco›_dev
 *
sdev
 = 
	`∂©f‹m_gë_drvd©a
(
dev
);

128 
	`check_sco›_ªg
(
sdev
);

129 
	`SCOOP_REG
(
sdev
->
ba£
,
SCOOP_GPWR
Ësdev->
sco›_gpwr
;

132 
	}
}

134 
	#sco›_su•íd
 
NULL


	)

135 
	#sco›_ªsume
 
NULL


	)

138 
__öô
 
	$sco›_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

140 
sco›_dev
 *
dev±r
;

141 
sco›_c⁄fig
 *
öf
;

142 
ªsour˚
 *
mem
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_MEM
, 0);

144 i‡(!
mem
)

145  -
EINVAL
;

147 
dev±r
 = 
	`kzÆloc
((
sco›_dev
), 
GFP_KERNEL
);

148 i‡(!
dev±r
)

149  -
ENOMEM
;

151 
	`•ö_lock_öô
(&
dev±r
->
sco›_lock
);

153 
öf
 = 
pdev
->
dev
.
∂©f‹m_d©a
;

154 
dev±r
->
ba£
 = 
	`i‹em≠
(
mem
->
°¨t
, mem->
íd
 - mem->start + 1);

156 i‡(!
dev±r
->
ba£
) {

157 
	`k‰ì
(
dev±r
);

158  -
ENOMEM
;

161 
	`∂©f‹m_£t_drvd©a
(
pdev
, 
dev±r
);

163 
	`¥ötk
("Sh¨∞Sco› Devi˚ foundáà0x%08x -> 0x%08x\n",()
mem
->
°¨t
,()
dev±r
->
ba£
);

165 
	`SCOOP_REG
(
dev±r
->
ba£
, 
SCOOP_MCR
) = 0x0140;

166 
	`ª£t_sco›
(&
pdev
->
dev
);

167 
	`SCOOP_REG
(
dev±r
->
ba£
, 
SCOOP_CPR
) = 0x0000;

168 
	`SCOOP_REG
(
dev±r
->
ba£
, 
SCOOP_GPCR
Ë
öf
->
io_dú
 & 0xffff;

169 
	`SCOOP_REG
(
dev±r
->
ba£
, 
SCOOP_GPWR
Ë
öf
->
io_out
 & 0xffff;

171 
dev±r
->
su•íd_˛r
 = 
öf
->suspend_clr;

172 
dev±r
->
su•íd_£t
 = 
öf
->suspend_set;

175 
	}
}

177 
	$sco›_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

179 
sco›_dev
 *
sdev
 = 
	`∂©f‹m_gë_drvd©a
(
pdev
);

180 i‡(
sdev
) {

181 
	`iounm≠
(
sdev
->
ba£
);

182 
	`k‰ì
(
sdev
);

183 
	`∂©f‹m_£t_drvd©a
(
pdev
, 
NULL
);

186 
	}
}

188 
∂©f‹m_drivî
 
	gsco›_drivî
 = {

189 .
¥obe
 = 
sco›_¥obe
,

190 .
	gªmove
 = 
sco›_ªmove
,

191 .
	gsu•íd
 = 
sco›_su•íd
,

192 .
	gªsume
 = 
sco›_ªsume
,

193 .
	gdrivî
 = {

194 .
«me
 = "sharp-scoop",

198 
__öô
 
	$sco›_öô
()

200  
	`∂©f‹m_drivî_ªgi°î
(&
sco›_drivî
);

201 
	}
}

203 
subsys_öôˇŒ
(
sco›_öô
);

	@arch/arm/common/sharpsl_param.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/°rög.h
>

16 
	~<asm/mach/sh¨p¶_∑øm.h
>

25 #ifde‡
CONFIG_ARCH_SA1100


26 
	#PARAM_BASE
 0xe8ffc000

	)

28 
	#PARAM_BASE
 0xa0000a00

	)

30 
	#MAGIC_CHG
(
a
,
b
,
c
,
d
Ë––d << 24 ) | ( c << 16 ) | ( b << 8 ) |á )

	)

32 
	#COMADJ_MAGIC
 
	`MAGIC_CHG
('C','M','A','D')

	)

33 
	#UUID_MAGIC
 
	`MAGIC_CHG
('U','U','I','D')

	)

34 
	#TOUCH_MAGIC
 
	`MAGIC_CHG
('T','U','C','H')

	)

35 
	#AD_MAGIC
 
	`MAGIC_CHG
('B','V','A','D')

	)

36 
	#PHAD_MAGIC
 
	`MAGIC_CHG
('P','H','A','D')

	)

38 
sh¨p¶_∑øm_öfo
 
	gsh¨p¶_∑øm
;

40 
	$sh¨p¶_ßve_∑øm
()

42 
	`mem˝y
(&
sh¨p¶_∑øm
, (*)
PARAM_BASE
, (
sh¨p¶_∑øm_öfo
));

44 i‡(
sh¨p¶_∑øm
.
comadj_keyw‹d
 !
COMADJ_MAGIC
)

45 
sh¨p¶_∑øm
.
comadj
=-1;

47 i‡(
sh¨p¶_∑øm
.
phad_keyw‹d
 !
PHAD_MAGIC
)

48 
sh¨p¶_∑øm
.
phadadj
=-1;

50 i‡(
sh¨p¶_∑øm
.
uuid_keyw‹d
 !
UUID_MAGIC
)

51 
sh¨p¶_∑øm
.
uuid
[0]=-1;

53 i‡(
sh¨p¶_∑øm
.
touch_keyw‹d
 !
TOUCH_MAGIC
)

54 
sh¨p¶_∑øm
.
touch_xp
=-1;

56 i‡(
sh¨p¶_∑øm
.
adadj_keyw‹d
 !
AD_MAGIC
)

57 
sh¨p¶_∑øm
.
adadj
=-1;

58 
	}
}

	@arch/arm/common/sharpsl_pm.c

15 #unde‡
DEBUG


17 
	~<löux/moduÀ.h
>

18 
	~<löux/timî.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/≠m_bios.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/Àds.h
>

26 
	~<löux/≠m-emuœti⁄.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/¨ch/pm.h
>

32 
	~<asm/¨ch/pxa-ªgs.h
>

33 
	~<asm/¨ch/sh¨p¶.h
>

34 
	~<asm/h¨dw¨e/sh¨p¶_pm.h
>

39 
	#SHARPSL_CHARGE_ON_TIME_INTERVAL
 (
	`m£cs_to_jiffõs
(1*60*1000)Ë

	)

40 
	#SHARPSL_CHARGE_FINISH_TIME
 (
	`m£cs_to_jiffõs
(10*60*1000)Ë

	)

41 
	#SHARPSL_BATCHK_TIME
 (
	`m£cs_to_jiffõs
(15*1000)Ë

	)

42 
	#SHARPSL_BATCHK_TIME_SUSPEND
 (60*10Ë

	)

44 
	#SHARPSL_WAIT_CO_TIME
 15

	)

45 
	#SHARPSL_WAIT_DISCHARGE_ON
 100

	)

46 
	#SHARPSL_CHECK_BATTERY_WAIT_TIME_TEMP
 10

	)

47 
	#SHARPSL_CHECK_BATTERY_WAIT_TIME_VOLT
 10

	)

48 
	#SHARPSL_CHECK_BATTERY_WAIT_TIME_ACIN
 10

	)

49 
	#SHARPSL_CHARGE_WAIT_TIME
 15

	)

50 
	#SHARPSL_CHARGE_CO_CHECK_TIME
 5

	)

51 
	#SHARPSL_CHARGE_RETRY_CNT
 1

	)

56 
sh¨p¶_off_ch¨ge_b©ãry
();

57 
sh¨p¶_check_b©ãry_ãmp
();

58 
sh¨p¶_check_b©ãry_vﬁège
();

59 
sh¨p¶_ac_check
();

60 
sh¨p¶_Áèl_check
();

61 
sh¨p¶_avîage_vÆue
(
ad
);

62 
sh¨p¶_avîage_˛ór
();

63 
sh¨p¶_ch¨ge_toggÀ
(
w‹k_°ru˘
 *
¥iv©e_
);

64 
sh¨p¶_b©ãry_thªad
(
w‹k_°ru˘
 *
¥iv©e_
);

70 
sh¨p¶_pm_°©us
 
	gsh¨p¶_pm
;

71 
DECLARE_DELAYED_WORK
(
toggÀ_ch¨gî
, 
sh¨p¶_ch¨ge_toggÀ
);

72 
DECLARE_DELAYED_WORK
(
sh¨p¶_b©
, 
sh¨p¶_b©ãry_thªad
);

73 
DEFINE_LED_TRIGGER
(
sh¨p¶_ch¨ge_Àd_åiggî
);

76 
	$gë_≥r˚¡age
(
vﬁège
)

78 
i
 = 
sh¨p¶_pm
.
machöfo
->
b©_Àvñs
 - 1;

79 
bl_°©us
 = 
sh¨p¶_pm
.
machöfo
->
backlight_gë_°©us
 ? sh¨p¶_pm.machöfo->
	`backlight_gë_°©us
() : 0;

80 
b©ãry_thªsh
 *
thªsh
;

82 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)

83 
thªsh
 = 
bl_°©us
 ? 
sh¨p¶_pm
.
machöfo
->
b©_Àvñs_acö_bl
 : sh¨p¶_pm.machöfo->
b©_Àvñs_acö
;

85 
thªsh
 = 
bl_°©us
 ? 
sh¨p¶_pm
.
machöfo
->
b©_Àvñs_nﬂc_bl
 : sh¨p¶_pm.machöfo->
b©_Àvñs_nﬂc
;

87 
i
 > 0 && (
vﬁège
 > 
thªsh
[i].voltage))

88 
i
--;

90  
thªsh
[
i
].
≥r˚¡age
;

91 
	}
}

93 
	$gë_≠m_°©us
(
vﬁège
)

95 
low_thªsh
, 
high_thªsh
;

97 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
) {

98 
high_thªsh
 = 
sh¨p¶_pm
.
machöfo
->
°©us_high_acö
;

99 
low_thªsh
 = 
sh¨p¶_pm
.
machöfo
->
°©us_low_acö
;

101 
high_thªsh
 = 
sh¨p¶_pm
.
machöfo
->
°©us_high_nﬂc
;

102 
low_thªsh
 = 
sh¨p¶_pm
.
machöfo
->
°©us_low_nﬂc
;

105 i‡(
vﬁège
 >
high_thªsh
)

106  
APM_BATTERY_STATUS_HIGH
;

107 i‡(
vﬁège
 >
low_thªsh
)

108  
APM_BATTERY_STATUS_LOW
;

109  
APM_BATTERY_STATUS_CRITICAL
;

110 
	}
}

112 
	$sh¨p¶_b©ãry_kick
()

114 
	`scheduÀ_dñayed_w‹k
(&
sh¨p¶_b©
, 
	`m£cs_to_jiffõs
(125));

115 
	}
}

116 
EXPORT_SYMBOL
(
sh¨p¶_b©ãry_kick
);

119 
	$sh¨p¶_b©ãry_thªad
(
w‹k_°ru˘
 *
¥iv©e_
)

121 
vﬁège
, 
≥r˚¡
, 
≠m_°©us
, 
i
 = 0;

123 i‡(!
sh¨p¶_pm
.
machöfo
)

126 
sh¨p¶_pm
.
b©t°©
.
ac_°©us
 = (sh¨p¶_pm.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
Ë? 
APM_AC_ONLINE
 : 
APM_AC_OFFLINE
);

129 i‡(!
sh¨p¶_pm
.
machöfo
->
b©fuŒ_úq
 && (sh¨p¶_pm.
ch¨ge_mode
 =
CHRG_ON
)

130 && 
	`time_a·î
(
jiffõs
, 
sh¨p¶_pm
.
ch¨ge_°¨t_time
 + 
SHARPSL_CHARGE_ON_TIME_INTERVAL
))

131 
	`scheduÀ_dñayed_w‹k
(&
toggÀ_ch¨gî
, 0);

134 
vﬁège
 = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_BATT_VOLT
);

136 i‡(
vﬁège
 > 0) ;

137 i‡(
i
++ > 5) {

138 
vﬁège
 = 
sh¨p¶_pm
.
machöfo
->
b©_Àvñs_nﬂc
[0].voltage;

139 
	`dev_w¨n
(
sh¨p¶_pm
.
dev
, "Warning: CannotÑead main battery!\n");

144 
vﬁège
 = 
	`sh¨p¶_avîage_vÆue
(voltage);

145 
≠m_°©us
 = 
	`gë_≠m_°©us
(
vﬁège
);

146 
≥r˚¡
 = 
	`gë_≥r˚¡age
(
vﬁège
);

150 i‡((
sh¨p¶_pm
.
b©t°©
.
ac_°©us
 =
APM_AC_ONLINE
Ë|| (
≠m_°©us
 =
APM_BATTERY_STATUS_HIGH
Ë|| 
≥r˚¡
 <sh¨p¶_pm.b©t°©.
maöb©_≥r˚¡
) {

151 
sh¨p¶_pm
.
b©t°©
.
maöb©_vﬁège
 = 
vﬁège
;

152 
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
 = 
≠m_°©us
;

153 
sh¨p¶_pm
.
b©t°©
.
maöb©_≥r˚¡
 = 
≥r˚¡
;

156 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "B©ãry: vﬁège: %d, sètus: %d,Öî˚¡age: %d,Åime: %ld\n", 
vﬁège
,

157 
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
, sh¨p¶_pm.b©t°©.
maöb©_≥r˚¡
, 
jiffõs
);

160 i‡((
sh¨p¶_pm
.
b©t°©
.
ac_°©us
 !
APM_AC_ONLINE
)

161 && ((
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
 =
APM_BATTERY_STATUS_LOW
) ||

162 (
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
 =
APM_BATTERY_STATUS_CRITICAL
))) {

163 i‡(!(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_BL_LIMIT
)) {

164 
sh¨p¶_pm
.
machöfo
->
	`backlight_limô
(1);

165 
sh¨p¶_pm
.
Êags
 |
SHARPSL_BL_LIMIT
;

167 } i‡(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_BL_LIMIT
) {

168 
sh¨p¶_pm
.
machöfo
->
	`backlight_limô
(0);

169 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_BL_LIMIT
;

173 i‡((
sh¨p¶_pm
.
b©t°©
.
ac_°©us
 !
APM_AC_ONLINE
)

174 && (
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
 =
APM_BATTERY_STATUS_CRITICAL
)

175 && !(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_APM_QUEUED
)) {

176 
sh¨p¶_pm
.
Êags
 |
SHARPSL_APM_QUEUED
;

177 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Fatal Off\n");

178 
	`≠m_queue_evít
(
APM_CRITICAL_SUSPEND
);

181 
	`scheduÀ_dñayed_w‹k
(&
sh¨p¶_b©
, 
SHARPSL_BATCHK_TIME
);

182 
	}
}

184 
	$sh¨p¶_pm_Àd
(
vÆ
)

186 i‡(
vÆ
 =
SHARPSL_LED_ERROR
) {

187 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Charging Error!\n");

188 } i‡(
vÆ
 =
SHARPSL_LED_ON
) {

189 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge LED On\n");

190 
	`Àd_åiggî_evít
(
sh¨p¶_ch¨ge_Àd_åiggî
, 
LED_FULL
);

192 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge LED Off\n");

193 
	`Àd_åiggî_evít
(
sh¨p¶_ch¨ge_Àd_åiggî
, 
LED_OFF
);

195 
	}
}

197 
	$sh¨p¶_ch¨ge_⁄
()

199 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Turning Charger On\n");

201 
sh¨p¶_pm
.
fuŒ_cou¡
 = 0;

202 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_ON
;

203 
	`scheduÀ_dñayed_w‹k
(&
toggÀ_ch¨gî
, 
	`m£cs_to_jiffõs
(250));

204 
	`scheduÀ_dñayed_w‹k
(&
sh¨p¶_b©
, 
	`m£cs_to_jiffõs
(500));

205 
	}
}

207 
	$sh¨p¶_ch¨ge_off
()

209 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Turning Charger Off\n");

211 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

212 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_OFF
);

213 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_OFF
;

215 
	`scheduÀ_dñayed_w‹k
(&
sh¨p¶_b©
, 0);

216 
	}
}

218 
	$sh¨p¶_ch¨ge_îr‹
()

220 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_ERROR
);

221 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

222 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_ERROR
;

223 
	}
}

225 
	$sh¨p¶_ch¨ge_toggÀ
(
w‹k_°ru˘
 *
¥iv©e_
)

227 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Tooglög Ch¨gîáàtime: %lx\n", 
jiffõs
);

229 i‡(!
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
)) {

230 
	`sh¨p¶_ch¨ge_off
();

232 } i‡((
	`sh¨p¶_check_b©ãry_ãmp
(Ë< 0Ë|| (
	`sh¨p¶_ac_check
() < 0)) {

233 
	`sh¨p¶_ch¨ge_îr‹
();

237 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_ON
);

238 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

239 
	`mdñay
(
SHARPSL_CHARGE_WAIT_TIME
);

240 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(1);

242 
sh¨p¶_pm
.
ch¨ge_°¨t_time
 = 
jiffõs
;

243 
	}
}

245 
	$sh¨p¶_ac_timî
(
d©a
)

247 
acö
 = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
);

249 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "AC Sètus: %d\n",
acö
);

251 
	`sh¨p¶_avîage_˛ór
();

252 i‡(
acö
 && (
sh¨p¶_pm
.
ch¨ge_mode
 !
CHRG_ON
))

253 
	`sh¨p¶_ch¨ge_⁄
();

254 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)

255 
	`sh¨p¶_ch¨ge_off
();

257 
	`scheduÀ_dñayed_w‹k
(&
sh¨p¶_b©
, 0);

258 
	}
}

261 
úqªtu∫_t
 
	$sh¨p¶_ac_i§
(
úq
, *
dev_id
)

265 
	`mod_timî
(&
sh¨p¶_pm
.
ac_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(250));

267  
IRQ_HANDLED
;

268 
	}
}

270 
	$sh¨p¶_chrg_fuŒ_timî
(
d©a
)

272 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Ch¨gêFuŒáàtime: %lx\n", 
jiffõs
);

274 
sh¨p¶_pm
.
fuŒ_cou¡
++;

276 i‡(!
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
)) {

277 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge Full: ACÑemoved - stop charging!\n");

278 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)

279 
	`sh¨p¶_ch¨ge_off
();

280 } i‡(
sh¨p¶_pm
.
fuŒ_cou¡
 < 2) {

281 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge Full: CountÅooÜow\n");

282 
	`scheduÀ_dñayed_w‹k
(&
toggÀ_ch¨gî
, 0);

283 } i‡(
	`time_a·î
(
jiffõs
, 
sh¨p¶_pm
.
ch¨ge_°¨t_time
 + 
SHARPSL_CHARGE_FINISH_TIME
)) {

284 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge Full: Interrupt generatedÅoo slowly -Ñetry.\n");

285 
	`scheduÀ_dñayed_w‹k
(&
toggÀ_ch¨gî
, 0);

287 
	`sh¨p¶_ch¨ge_off
();

288 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_DONE
;

289 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge Full: Charging Finished\n");

291 
	}
}

296 
úqªtu∫_t
 
	$sh¨p¶_chrg_fuŒ_i§
(
úq
, *
dev_id
)

298 i‡(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_SUSPENDED
)

299  
IRQ_HANDLED
;

302 
	`mod_timî
(&
sh¨p¶_pm
.
chrg_fuŒ_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(500));

304  
IRQ_HANDLED
;

305 
	}
}

307 
úqªtu∫_t
 
	$sh¨p¶_Áèl_i§
(
úq
, *
dev_id
)

309 
is_Áèl
 = 0;

311 i‡(!
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_LOCK
)) {

312 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "BatteryÇow Unlocked! Suspending.\n");

313 
is_Áèl
 = 1;

316 i‡(!
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_FATAL
)) {

317 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Fatal Batt Error! Suspending.\n");

318 
is_Áèl
 = 1;

321 i‡(!(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_APM_QUEUED
Ë&& 
is_Áèl
) {

322 
sh¨p¶_pm
.
Êags
 |
SHARPSL_APM_QUEUED
;

323 
	`≠m_queue_evít
(
APM_CRITICAL_SUSPEND
);

326  
IRQ_HANDLED
;

327 
	}
}

332 
	#SHARPSL_CNV_VALUE_NUM
 10

	)

333 
	gsh¨p¶_ad_ödex
;

335 
	$sh¨p¶_avîage_˛ór
()

337 
sh¨p¶_ad_ödex
 = 0;

338 
	}
}

340 
	$sh¨p¶_avîage_vÆue
(
ad
)

342 
i
, 
ad_vÆ
 = 0;

343 
sh¨p¶_ad
[
SHARPSL_CNV_VALUE_NUM
+1];

345 i‡(
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
 !
APM_BATTERY_STATUS_HIGH
) {

346 
sh¨p¶_ad_ödex
 = 0;

347  
ad
;

350 
sh¨p¶_ad
[
sh¨p¶_ad_ödex
] = 
ad
;

351 
sh¨p¶_ad_ödex
++;

352 i‡(
sh¨p¶_ad_ödex
 >
SHARPSL_CNV_VALUE_NUM
) {

353 
i
=0; i < (
SHARPSL_CNV_VALUE_NUM
-1); i++)

354 
sh¨p¶_ad
[
i
] = sharpsl_ad[i+1];

355 
sh¨p¶_ad_ödex
 = 
SHARPSL_CNV_VALUE_NUM
 - 1;

357 
i
=0; i < 
sh¨p¶_ad_ödex
; i++)

358 
ad_vÆ
 +
sh¨p¶_ad
[
i
];

360  (
ad_vÆ
 / 
sh¨p¶_ad_ödex
);

361 
	}
}

367 
	$gë_£À˘_vÆ
(*
vÆ
)

369 
i
, 
j
, 
k
, 
ãmp
, 
sum
 = 0;

372 
ãmp
 = 
vÆ
[0];

373 
j
=0;

374 
i
=1; i<5; i++) {

375 i‡(
ãmp
 < 
vÆ
[
i
]) {

376 
ãmp
 = 
vÆ
[
i
];

377 
j
 = 
i
;

382 
ãmp
 = 
vÆ
[4];

383 
k
=4;

384 
i
=3; i>=0; i--) {

385 i‡(
ãmp
 > 
vÆ
[
i
]) {

386 
ãmp
 = 
vÆ
[
i
];

387 
k
 = 
i
;

391 
i
=0; i<5; i++)

392 i‡(
i
 !
j
 && i !
k
 )

393 
sum
 +
vÆ
[
i
];

395 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Avîage: %d from vÆues: %d, %d, %d, %d, %d\n", 
sum
/3, 
vÆ
[0], val[1], val[2], val[3], val[4]);

397  (
sum
/3);

398 
	}
}

400 
	$sh¨p¶_check_b©ãry_ãmp
()

402 
vÆ
, 
i
, 
buff
[5];

405 
i
=0; i<5; i++) {

406 
	`mdñay
(
SHARPSL_CHECK_BATTERY_WAIT_TIME_TEMP
);

407 
sh¨p¶_pm
.
machöfo
->
	`mósuª_ãmp
(1);

408 
	`mdñay
(
SHARPSL_CHECK_BATTERY_WAIT_TIME_TEMP
);

409 
buff
[
i
] = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_BATT_TEMP
);

410 
sh¨p¶_pm
.
machöfo
->
	`mósuª_ãmp
(0);

413 
vÆ
 = 
	`gë_£À˘_vÆ
(
buff
);

415 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Tem≥øtuª: %d\n", 
vÆ
);

416 i‡(
vÆ
 > 
sh¨p¶_pm
.
machöfo
->
ch¨ge_⁄_ãmp
) {

417 
	`¥ötk
(
KERN_WARNING
 "Not charging:Åemperature out ofÜimits.\n");

422 
	}
}

424 
	$sh¨p¶_check_b©ãry_vﬁège
()

426 
vÆ
, 
i
, 
buff
[5];

429 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

430 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge
(1);

431 
	`mdñay
(
SHARPSL_WAIT_DISCHARGE_ON
);

433 i‡(
sh¨p¶_pm
.
machöfo
->
disch¨ge1
)

434 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge1
(1);

437 
i
=0; i<5; i++) {

438 
buff
[
i
] = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_BATT_VOLT
);

439 
	`mdñay
(
SHARPSL_CHECK_BATTERY_WAIT_TIME_VOLT
);

442 i‡(
sh¨p¶_pm
.
machöfo
->
disch¨ge1
)

443 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge1
(0);

445 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge
(0);

447 
vÆ
 = 
	`gë_£À˘_vÆ
(
buff
);

448 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "B©ãry Vﬁège: %d\n", 
vÆ
);

450 i‡(
vÆ
 < 
sh¨p¶_pm
.
machöfo
->
ch¨ge_⁄_vﬁt
)

454 
	}
}

456 
	$sh¨p¶_ac_check
()

458 
ãmp
, 
i
, 
buff
[5];

460 
i
=0; i<5; i++) {

461 
buff
[
i
] = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_ACIN_VOLT
);

462 
	`mdñay
(
SHARPSL_CHECK_BATTERY_WAIT_TIME_ACIN
);

465 
ãmp
 = 
	`gë_£À˘_vÆ
(
buff
);

466 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "AC Vﬁège: %d\n",
ãmp
);

468 i‡((
ãmp
 > 
sh¨p¶_pm
.
machöfo
->
ch¨ge_acö_high
Ë|| (ãm∞< sh¨p¶_pm.machöfo->
ch¨ge_acö_low
)) {

469 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Error: AC check failed.\n");

474 
	}
}

476 #ifde‡
CONFIG_PM


477 
	$sh¨p¶_pm_su•íd
(
∂©f‹m_devi˚
 *
pdev
, 
pm_mesßge_t
 
°©e
)

479 
sh¨p¶_pm
.
Êags
 |
SHARPSL_SUSPENDED
;

480 
	`Êush_scheduÀd_w‹k
();

482 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)

483 
sh¨p¶_pm
.
Êags
 |
SHARPSL_DO_OFFLINE_CHRG
;

485 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_DO_OFFLINE_CHRG
;

488 
	}
}

490 
	$sh¨p¶_pm_ªsume
(
∂©f‹m_devi˚
 *
pdev
)

493 
RCSR
 = 0x0f;

494 
	`sh¨p¶_avîage_˛ór
();

495 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_APM_QUEUED
;

496 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_SUSPENDED
;

499 
	}
}

501 
	$c‹gi_gŸo_¶ìp
(
Æ¨m_time
, 
Æ¨m_íabÀ
, 
su•íd_°©e_t
 
°©e
)

503 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Timêis: %08x\n",
RCNR
);

505 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "OfÊöêCh¨gêA˘iv©ê%d\n",sh¨p¶_pm.
Êags
 & 
SHARPSL_DO_OFFLINE_CHRG
);

508 i‡((
sh¨p¶_pm
.
Êags
 & 
SHARPSL_DO_OFFLINE_CHRG
Ë&& (sh¨p¶_pm.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
))) {

509 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Activating Offline Charger...\n");

510 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_OFF
;

511 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_DO_OFFLINE_CHRG
;

512 
	`sh¨p¶_off_ch¨ge_b©ãry
();

515 
sh¨p¶_pm
.
machöfo
->
	`¥esu•íd
();

517 
PEDR
 = 0xffffffff;

519 
sh¨p¶_pm
.
Êags
 &~
SHARPSL_ALARM_ACTIVE
;

520 i‡((
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
Ë&& ((
Æ¨m_íabÀ
 && ((
Æ¨m_time
 - 
RCNR
Ë> (
SHARPSL_BATCHK_TIME_SUSPEND
 + 30))) || !alarm_enable)) {

521 
RTSR
 &
RTSR_ALE
;

522 
RTAR
 = 
RCNR
 + 
SHARPSL_BATCHK_TIME_SUSPEND
;

523 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Ch¨gögáœrmát: %08x\n",
RTAR
);

524 
sh¨p¶_pm
.
Êags
 |
SHARPSL_ALARM_ACTIVE
;

525 } i‡(
Æ¨m_íabÀ
) {

526 
RTSR
 &
RTSR_ALE
;

527 
RTAR
 = 
Æ¨m_time
;

528 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "U£∏Æ¨mát: %08x\n",
RTAR
);

530 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Noálarms set.\n");

533 
	`pxa_pm_íãr
(
°©e
);

535 
sh¨p¶_pm
.
machöfo
->
	`po°su•íd
();

537 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "C‹gòwokí u∞‰om su•íd: %08x\n",
PEDR
);

538 
	}
}

540 
	$c‹gi_íãr_su•íd
(
Æ¨m_time
, 
Æ¨m_íabÀ
, 
su•íd_°©e_t
 
°©e
)

542 i‡(!
sh¨p¶_pm
.
machöfo
->
	`should_wakeup
(!(sh¨p¶_pm.
Êags
 & 
SHARPSL_ALARM_ACTIVE
Ë&& 
Æ¨m_íabÀ
) )

544 i‡(!(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_ALARM_ACTIVE
)) {

545 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "No userÅriggered wakeupÉventsándÇot charging. Strange. Suspend.\n");

546 
	`c‹gi_gŸo_¶ìp
(
Æ¨m_time
, 
Æ¨m_íabÀ
, 
°©e
);

549 if(
	`sh¨p¶_off_ch¨ge_b©ãry
()) {

550 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charging. Suspend...\n");

551 
	`c‹gi_gŸo_¶ìp
(
Æ¨m_time
, 
Æ¨m_íabÀ
, 
°©e
);

554 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "UserÅriggered wakeup in offline charger.\n");

557 i‡((!
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_LOCK
)Ë|| (
	`sh¨p¶_Áèl_check
() < 0) )

559 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Fatal condition. Suspend.\n");

560 
	`c‹gi_gŸo_¶ìp
(
Æ¨m_time
, 
Æ¨m_íabÀ
, 
°©e
);

565 
	}
}

567 
	$c‹gi_pxa_pm_íãr
(
su•íd_°©e_t
 
°©e
)

569 
Æ¨m_time
 = 
RTAR
;

570 
Æ¨m_°©us
 = ((
RTSR
 & 
RTSR_ALE
) != 0);

572 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "SharpSL suspending for firstÅime.\n");

574 
	`c‹gi_gŸo_¶ìp
(
Æ¨m_time
, 
Æ¨m_°©us
, 
°©e
);

576 
	`c‹gi_íãr_su•íd
(
Æ¨m_time
,
Æ¨m_°©us
,
°©e
))

579 i‡(
sh¨p¶_pm
.
machöfo
->
óæyªsume
)

580 
sh¨p¶_pm
.
machöfo
->
	`óæyªsume
();

582 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "SharpSLÑesuming...\n");

585 
	}
}

593 
	$sh¨p¶_Áèl_check
()

595 
buff
[5], 
ãmp
, 
i
, 
acö
;

597 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "sharpsl_fatal_checkÉntered\n");

600 
acö
 = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
);

602 i‡(
acö
 && (
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)) {

603 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

604 
	`udñay
(100);

605 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge
(1);

606 
	`mdñay
(
SHARPSL_WAIT_DISCHARGE_ON
);

609 i‡(
sh¨p¶_pm
.
machöfo
->
disch¨ge1
)

610 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge1
(1);

613 
i
=0; i<5; i++) {

614 
buff
[
i
] = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_BATT_VOLT
);

615 
	`mdñay
(
SHARPSL_CHECK_BATTERY_WAIT_TIME_VOLT
);

618 i‡(
sh¨p¶_pm
.
machöfo
->
disch¨ge1
)

619 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge1
(0);

621 i‡(
acö
 && (
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)) {

622 
	`udñay
(100);

623 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(1);

624 
sh¨p¶_pm
.
machöfo
->
	`disch¨ge
(0);

627 
ãmp
 = 
	`gë_£À˘_vÆ
(
buff
);

628 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "sh¨p¶_Áèl_check:ácö: %d, disch¨gêvﬁège: %d,Çÿdisch¨ge: %ld\n", 
acö
, 
ãmp
, sh¨p¶_pm.
machöfo
->
	`ªad_devd©a
(
SHARPSL_BATT_VOLT
));

630 i‡((
acö
 && (
ãmp
 < 
sh¨p¶_pm
.
machöfo
->
Áèl_acö_vﬁt
)) ||

631 (!
acö
 && (
ãmp
 < 
sh¨p¶_pm
.
machöfo
->
Áèl_nﬂcö_vﬁt
)))

634 
	}
}

636 
	$sh¨p¶_off_ch¨ge_îr‹
()

638 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "Offline Charger: Error occurred.\n");

639 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

640 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_ERROR
);

641 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_ERROR
;

643 
	}
}

650 
	$sh¨p¶_off_ch¨ge_b©ãry
()

652 
time
;

654 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Ch¨gêMode: %d\n", sh¨p¶_pm.
ch¨ge_mode
);

656 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_OFF
) {

657 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Step 1\n");

660 i‡((
	`sh¨p¶_ac_check
(Ë< 0Ë|| (
	`sh¨p¶_check_b©ãry_ãmp
() < 0))

661  
	`sh¨p¶_off_ch¨ge_îr‹
();

664 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_ON
);

665 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

666 
	`mdñay
(
SHARPSL_CHARGE_WAIT_TIME
);

667 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(1);

669 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_ON
;

670 
sh¨p¶_pm
.
fuŒ_cou¡
 = 0;

673 } i‡(
sh¨p¶_pm
.
ch¨ge_mode
 !
CHRG_ON
) {

677 i‡(
sh¨p¶_pm
.
fuŒ_cou¡
 == 0) {

678 
time
;

680 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Step 2\n");

682 i‡((
	`sh¨p¶_check_b©ãry_ãmp
(Ë< 0Ë|| (
	`sh¨p¶_check_b©ãry_vﬁège
() < 0))

683  
	`sh¨p¶_off_ch¨ge_îr‹
();

685 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

686 
	`mdñay
(
SHARPSL_CHARGE_WAIT_TIME
);

687 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(1);

688 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_ON
;

690 
	`mdñay
(
SHARPSL_CHARGE_CO_CHECK_TIME
);

692 
time
 = 
RCNR
;

695 i‡(
sh¨p¶_pm
.
machöfo
->
	`ch¨gî_wakeup
() != 0)

698 i‡((
RCNR
 - 
time
Ë> 
SHARPSL_WAIT_CO_TIME
)

700 i‡(
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_CHRGFULL
)) {

701 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Charge full occurred. RetryingÅo check\n");

702 
sh¨p¶_pm
.
fuŒ_cou¡
++;

703 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

704 
	`mdñay
(
SHARPSL_CHARGE_WAIT_TIME
);

705 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(1);

711 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Step 3\n");

713 
	`mdñay
(
SHARPSL_CHARGE_CO_CHECK_TIME
);

715 
time
 = 
RCNR
;

718 i‡(
sh¨p¶_pm
.
machöfo
->
	`ch¨gî_wakeup
() != 0)

721 i‡((
RCNR
-
time
Ë> 
SHARPSL_WAIT_CO_TIME
) {

722 i‡(
sh¨p¶_pm
.
fuŒ_cou¡
 > 
SHARPSL_CHARGE_RETRY_CNT
) {

723 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Not charged sufficiently. Retrying.\n");

724 
sh¨p¶_pm
.
fuŒ_cou¡
 = 0;

726 
sh¨p¶_pm
.
fuŒ_cou¡
++;

729 i‡(
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_CHRGFULL
)) {

730 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Offline Charger: Charging complete.\n");

731 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_OFF
);

732 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

733 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_DONE
;

737 
	}
}

740 
ssize_t
 
	$b©ãry_≥r˚¡age_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

742  
	`•rötf
(
buf
, "%d\n",
sh¨p¶_pm
.
b©t°©
.
maöb©_≥r˚¡
);

743 
	}
}

745 
ssize_t
 
	$b©ãry_vﬁège_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

747  
	`•rötf
(
buf
, "%d\n",
sh¨p¶_pm
.
b©t°©
.
maöb©_vﬁège
);

748 
	}
}

750 
DEVICE_ATTR
(
b©ãry_≥r˚¡age
, 0444, 
b©ãry_≥r˚¡age_show
, 
NULL
);

751 
DEVICE_ATTR
(
b©ãry_vﬁège
, 0444, 
b©ãry_vﬁège_show
, 
NULL
);

753 (*
≠m_gë_powî_°©us
)(
≠m_powî_öfo
 *);

755 
	$sh¨p¶_≠m_gë_powî_°©us
(
≠m_powî_öfo
 *
öfo
)

757 
öfo
->
ac_löe_°©us
 = 
sh¨p¶_pm
.
b©t°©
.
ac_°©us
;

759 i‡(
sh¨p¶_pm
.
ch¨ge_mode
 =
CHRG_ON
)

760 
öfo
->
b©ãry_°©us
 = 
APM_BATTERY_STATUS_CHARGING
;

762 
öfo
->
b©ãry_°©us
 = 
sh¨p¶_pm
.
b©t°©
.
maöb©_°©us
;

764 
öfo
->
b©ãry_Êag
 = (1 << info->
b©ãry_°©us
);

765 
öfo
->
b©ãry_li„
 = 
sh¨p¶_pm
.
b©t°©
.
maöb©_≥r˚¡
;

766 
	}
}

768 
pm_›s
 
	gsh¨p¶_pm_›s
 = {

769 .
¥ï¨e
 = 
pxa_pm_¥ï¨e
,

770 .
	gíãr
 = 
c‹gi_pxa_pm_íãr
,

771 .
	gföish
 = 
pxa_pm_föish
,

772 .
	gvÆid
 = 
pm_vÆid_⁄ly_mem
,

775 
__öô
 
	$sh¨p¶_pm_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

777 
ªt
;

779 i‡(!
pdev
->
dev
.
∂©f‹m_d©a
)

780  -
EINVAL
;

782 
sh¨p¶_pm
.
dev
 = &
pdev
->dev;

783 
sh¨p¶_pm
.
machöfo
 = 
pdev
->
dev
.
∂©f‹m_d©a
;

784 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_OFF
;

785 
sh¨p¶_pm
.
Êags
 = 0;

787 
	`öô_timî
(&
sh¨p¶_pm
.
ac_timî
);

788 
sh¨p¶_pm
.
ac_timî
.
fun˘i⁄
 = 
sh¨p¶_ac_timî
;

790 
	`öô_timî
(&
sh¨p¶_pm
.
chrg_fuŒ_timî
);

791 
sh¨p¶_pm
.
chrg_fuŒ_timî
.
fun˘i⁄
 = 
sh¨p¶_chrg_fuŒ_timî
;

793 
	`Àd_åiggî_ªgi°î_sim∂e
("sh¨p¶-ch¨ge", &
sh¨p¶_ch¨ge_Àd_åiggî
);

795 
sh¨p¶_pm
.
machöfo
->
	`öô
();

797 
ªt
 = 
	`devi˚_¸óã_fûe
(&
pdev
->
dev
, &
dev_©å_b©ãry_≥r˚¡age
);

798 
ªt
 |
	`devi˚_¸óã_fûe
(&
pdev
->
dev
, &
dev_©å_b©ãry_vﬁège
);

799 i‡(
ªt
 != 0)

800 
	`dev_w¨n
(&
pdev
->
dev
, "FaûedÅÿªgi°îáâribuã†(%d)\n", 
ªt
);

802 
≠m_gë_powî_°©us
 = 
sh¨p¶_≠m_gë_powî_°©us
;

804 
	`pm_£t_›s
(&
sh¨p¶_pm_›s
);

806 
	`mod_timî
(&
sh¨p¶_pm
.
ac_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(250));

809 
	}
}

811 
	$sh¨p¶_pm_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

813 
	`pm_£t_›s
(
NULL
);

815 
	`devi˚_ªmove_fûe
(&
pdev
->
dev
, &
dev_©å_b©ãry_≥r˚¡age
);

816 
	`devi˚_ªmove_fûe
(&
pdev
->
dev
, &
dev_©å_b©ãry_vﬁège
);

818 
	`Àd_åiggî_uƒegi°î_sim∂e
(
sh¨p¶_ch¨ge_Àd_åiggî
);

820 
sh¨p¶_pm
.
machöfo
->
	`exô
();

822 
	`dñ_timî_sync
(&
sh¨p¶_pm
.
chrg_fuŒ_timî
);

823 
	`dñ_timî_sync
(&
sh¨p¶_pm
.
ac_timî
);

826 
	}
}

828 
∂©f‹m_drivî
 
	gsh¨p¶_pm_drivî
 = {

829 .
¥obe
 = 
sh¨p¶_pm_¥obe
,

830 .
	gªmove
 = 
sh¨p¶_pm_ªmove
,

831 .
	gsu•íd
 = 
sh¨p¶_pm_su•íd
,

832 .
	gªsume
 = 
sh¨p¶_pm_ªsume
,

833 .
	gdrivî
 = {

834 .
«me
 = "sharpsl-pm",

838 
__devöô
 
	$sh¨p¶_pm_öô
()

840  
	`∂©f‹m_drivî_ªgi°î
(&
sh¨p¶_pm_drivî
);

841 
	}
}

843 
	$sh¨p¶_pm_exô
()

845 
	`∂©f‹m_drivî_uƒegi°î
(&
sh¨p¶_pm_drivî
);

846 
	}
}

848 
œã_öôˇŒ
(
sh¨p¶_pm_öô
);

849 
moduÀ_exô
(
sh¨p¶_pm_exô
);

	@arch/arm/common/time-acorn.c

16 
	~<löux/timex.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/öãºu±.h
>

19 
	~<löux/úq.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/io.h
>

23 
	~<asm/h¨dw¨e/ioc.h
>

25 
	~<asm/mach/time.h
>

27 
	$ioc_timî_gëtimeoff£t
()

29 
cou¡1
, 
cou¡2
, 
°©us
;

30 
off£t
;

32 
	`ioc_wrôeb
 (0, 
IOC_T0LATCH
);

33 
	`b¨rõr
 ();

34 
cou¡1
 = 
	`ioc_ªadb
(
IOC_T0CNTL
Ë| (ioc_ªadb(
IOC_T0CNTH
) << 8);

35 
	`b¨rõr
 ();

36 
°©us
 = 
	`ioc_ªadb
(
IOC_IRQREQA
);

37 
	`b¨rõr
 ();

38 
	`ioc_wrôeb
 (0, 
IOC_T0LATCH
);

39 
	`b¨rõr
 ();

40 
cou¡2
 = 
	`ioc_ªadb
(
IOC_T0CNTL
Ë| (ioc_ªadb(
IOC_T0CNTH
) << 8);

42 
off£t
 = 
cou¡2
;

43 i‡(
cou¡2
 < 
cou¡1
) {

48 i‡(
°©us
 & (1 << 5))

49 
off£t
 -
LATCH
;

50 } i‡(
cou¡2
 > 
cou¡1
) {

55 
off£t
 -
LATCH
;

58 
off£t
 = (
LATCH
 - off£tË* (
tick_n£c
 / 1000);

59  (
off£t
 + 
LATCH
/2) / LATCH;

60 
	}
}

62 
__öô
 
	$io˘ime_öô
()

64 
	`ioc_wrôeb
(
LATCH
 & 255, 
IOC_T0LTCHL
);

65 
	`ioc_wrôeb
(
LATCH
 >> 8, 
IOC_T0LTCHH
);

66 
	`ioc_wrôeb
(0, 
IOC_T0GO
);

67 
	}
}

69 
úqªtu∫_t


70 
	$ioc_timî_öãºu±
(
úq
, *
dev_id
)

72 
	`wrôe_£qlock
(&
xtime_lock
);

73 
	`timî_tick
();

74 
	`wrôe_£qu∆ock
(&
xtime_lock
);

75  
IRQ_HANDLED
;

76 
	}
}

78 
úqa˘i⁄
 
	gioc_timî_úq
 = {

79 .
«me
 = "timer",

80 .
	gÊags
 = 
IRQF_DISABLED
,

81 .
	gh™dÀr
 = 
ioc_timî_öãºu±


87 
__öô
 
	$ioc_timî_öô
()

89 
	`io˘ime_öô
();

90 
	`£tup_úq
(
IRQ_TIMER
, &
ioc_timî_úq
);

91 
	}
}

93 
sys_timî
 
	gioc_timî
 = {

94 .
öô
 = 
ioc_timî_öô
,

95 .
	goff£t
 = 
ioc_timî_gëtimeoff£t
,

	@arch/arm/common/uengine.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/°rög.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/¨ch/h¨dw¨e.h
>

21 
	~<asm/h¨dw¨e/uígöe.h
>

22 
	~<asm/io.h
>

24 #i‡
deföed
(
CONFIG_ARCH_IXP2000
)

25 
	#IXP_UENGINE_CSR_VIRT_BASE
 
IXP2000_UENGINE_CSR_VIRT_BASE


	)

26 
	#IXP_PRODUCT_ID
 
IXP2000_PRODUCT_ID


	)

27 
	#IXP_MISC_CONTROL
 
IXP2000_MISC_CONTROL


	)

28 
	#IXP_RESET1
 
IXP2000_RESET1


	)

30 #i‡
deföed
(
CONFIG_ARCH_IXP23XX
)

31 
	#IXP_UENGINE_CSR_VIRT_BASE
 
IXP23XX_UENGINE_CSR_VIRT_BASE


	)

32 
	#IXP_PRODUCT_ID
 
IXP23XX_PRODUCT_ID


	)

33 
	#IXP_MISC_CONTROL
 
IXP23XX_MISC_CONTROL


	)

34 
	#IXP_RESET1
 
IXP23XX_RESET1


	)

36 #îr‹ 
unknown
 
∂©f‹m


40 
	#USTORE_ADDRESS
 0x000

	)

41 
	#USTORE_DATA_LOWER
 0x004

	)

42 
	#USTORE_DATA_UPPER
 0x008

	)

43 
	#CTX_ENABLES
 0x018

	)

44 
	#CC_ENABLE
 0x01c

	)

45 
	#CSR_CTX_POINTER
 0x020

	)

46 
	#INDIRECT_CTX_STS
 0x040

	)

47 
	#ACTIVE_CTX_STS
 0x044

	)

48 
	#INDIRECT_CTX_SIG_EVENTS
 0x048

	)

49 
	#INDIRECT_CTX_WAKEUP_EVENTS
 0x050

	)

50 
	#NN_PUT
 0x080

	)

51 
	#NN_GET
 0x084

	)

52 
	#TIMESTAMP_LOW
 0x0c0

	)

53 
	#TIMESTAMP_HIGH
 0x0c4

	)

54 
	#T_INDEX_BYTE_INDEX
 0x0f4

	)

55 
	#LOCAL_CSR_STATUS
 0x180

	)

57 
u32
 
	gixp2000_uígöe_mask
;

59 *
	$ixp2000_uígöe_c§_¨ó
(
uígöe
)

61  ((*)
IXP_UENGINE_CSR_VIRT_BASE
Ë+ (
uígöe
 << 10);

62 
	}
}

72 
u32
 
	$ixp2000_uígöe_c§_ªad
(
uígöe
, 
off£t
)

74 *
ueba£
;

75 
u32
 *
loˇl_c§_°©us
;

76 
u32
 *
ªg
;

77 
u32
 
vÆue
;

79 
ueba£
 = 
	`ixp2000_uígöe_c§_¨ó
(
uígöe
);

81 
loˇl_c§_°©us
 = (
u32
 *)(
ueba£
 + 
LOCAL_CSR_STATUS
);

82 
ªg
 = (
u32
 *)(
ueba£
 + 
off£t
);

84 
vÆue
 = 
	`ixp2000_ªg_ªad
(
ªg
);

85 } 
	`ixp2000_ªg_ªad
(
loˇl_c§_°©us
) & 1);

87  
vÆue
;

88 
	}
}

89 
EXPORT_SYMBOL
(
ixp2000_uígöe_c§_ªad
);

91 
	$ixp2000_uígöe_c§_wrôe
(
uígöe
, 
off£t
, 
u32
 
vÆue
)

93 *
ueba£
;

94 
u32
 *
loˇl_c§_°©us
;

95 
u32
 *
ªg
;

97 
ueba£
 = 
	`ixp2000_uígöe_c§_¨ó
(
uígöe
);

99 
loˇl_c§_°©us
 = (
u32
 *)(
ueba£
 + 
LOCAL_CSR_STATUS
);

100 
ªg
 = (
u32
 *)(
ueba£
 + 
off£t
);

102 
	`ixp2000_ªg_wrôe
(
ªg
, 
vÆue
);

103 } 
	`ixp2000_ªg_ªad
(
loˇl_c§_°©us
) & 1);

104 
	}
}

105 
EXPORT_SYMBOL
(
ixp2000_uígöe_c§_wrôe
);

107 
	$ixp2000_uígöe_ª£t
(
u32
 
uígöe_mask
)

109 
u32
 
vÆue
;

111 
vÆue
 = 
	`ixp2000_ªg_ªad
(
IXP_RESET1
Ë& ~
ixp2000_uígöe_mask
;

113 
uígöe_mask
 &
ixp2000_uígöe_mask
;

114 
	`ixp2000_ªg_wrb
(
IXP_RESET1
, 
vÆue
 | 
uígöe_mask
);

115 
	`ixp2000_ªg_wrb
(
IXP_RESET1
, 
vÆue
);

116 
	}
}

117 
EXPORT_SYMBOL
(
ixp2000_uígöe_ª£t
);

119 
	$ixp2000_uígöe_£t_mode
(
uígöe
, 
u32
 
mode
)

125 
mode
 |= 0x10000000;

126 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
CTX_ENABLES
, 
mode
);

131 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
CC_ENABLE
, 0x00002000);

136 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
NN_PUT
, 0x00);

137 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
NN_GET
, 0x00);

138 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
T_INDEX_BYTE_INDEX
, 0);

139 
	}
}

140 
EXPORT_SYMBOL
(
ixp2000_uígöe_£t_mode
);

142 
	$make_eví_∑rôy
(
u32
 
x
)

144  
	`hweight32
(
x
) & 1;

145 
	}
}

147 
	$u°‹e_wrôe
(
uígöe
, 
u64
 
ö¢
)

152 
ö¢
 |(
u64
)
	`make_eví_∑rôy
((insn >> 20) & 0x000fffff) << 41;

153 
ö¢
 |(
u64
)
	`make_eví_∑rôy
(insn & 0x000fffff) << 40;

159 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
USTORE_DATA_LOWER
, (
u32
)
ö¢
);

160 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
USTORE_DATA_UPPER
, (
u32
)(
ö¢
 >> 32));

161 
	}
}

163 
	$ixp2000_uígöe_lﬂd_mi¸ocode
(
uígöe
, 
u8
 *
ucode
, 
ö¢s
)

165 
i
;

170 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
USTORE_ADDRESS
, 0x80000000);

171 
i
 = 0; i < 
ö¢s
; i++) {

172 
u64
 
ö¢
;

174 
ö¢
 = (((
u64
)
ucode
[0]) << 32) |

175 (((
u64
)
ucode
[1]) << 24) |

176 (((
u64
)
ucode
[2]) << 16) |

177 (((
u64
)
ucode
[3]) << 8) |

178 ((
u64
)
ucode
[4]);

179 
ucode
 += 5;

181 
	`u°‹e_wrôe
(
uígöe
, 
ö¢
);

190 
i
 = 0; i < 4; i++) {

191 
u32
 
addr
;

193 
addr
 = 
	`ixp2000_uígöe_c§_ªad
(
uígöe
, 
USTORE_ADDRESS
);

194 i‡(
addr
 == 0x80000000)

196 
	`u°‹e_wrôe
(
uígöe
, 0xf0000c0300ULL);

202 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
USTORE_ADDRESS
, 0x00000000);

203 
	}
}

204 
EXPORT_SYMBOL
(
ixp2000_uígöe_lﬂd_mi¸ocode
);

206 
	$ixp2000_uígöe_öô_c⁄ãxt
(
uígöe
, 
c⁄ãxt
, 
pc
)

211 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
CSR_CTX_POINTER
, 
c⁄ãxt
);

216 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
INDIRECT_CTX_SIG_EVENTS
, 1);

217 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
INDIRECT_CTX_WAKEUP_EVENTS
, 1);

222 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
INDIRECT_CTX_STS
, 
pc
);

223 
	}
}

224 
EXPORT_SYMBOL
(
ixp2000_uígöe_öô_c⁄ãxt
);

226 
	$ixp2000_uígöe_°¨t_c⁄ãxts
(
uígöe
, 
u8
 
˘x_mask
)

228 
u32
 
mask
;

233 
mask
 = 
	`ixp2000_uígöe_c§_ªad
(
uígöe
, 
CTX_ENABLES
);

234 
mask
 |
˘x_mask
 << 8;

235 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
CTX_ENABLES
, 
mask
);

236 
	}
}

237 
EXPORT_SYMBOL
(
ixp2000_uígöe_°¨t_c⁄ãxts
);

239 
	$ixp2000_uígöe_°›_c⁄ãxts
(
uígöe
, 
u8
 
˘x_mask
)

241 
u32
 
mask
;

247 
mask
 = 
	`ixp2000_uígöe_c§_ªad
(
uígöe
, 
CTX_ENABLES
);

248 
mask
 &~(
˘x_mask
 << 8);

249 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
CTX_ENABLES
, 
mask
);

250 
	}
}

251 
EXPORT_SYMBOL
(
ixp2000_uígöe_°›_c⁄ãxts
);

253 
	$check_ixp_ty≥
(
ixp2000_uígöe_code
 *
c
)

255 
u32
 
¥odu˘_id
;

256 
u32
 
ªv
;

258 
¥odu˘_id
 = 
	`ixp2000_ªg_ªad
(
IXP_PRODUCT_ID
);

259 i‡(((
¥odu˘_id
 >> 16) & 0x1f) != 0)

262 (
¥odu˘_id
 >> 8) & 0xff) {

263 #ifde‡
CONFIG_ARCH_IXP2000


265 i‡(!(
c
->
˝u_modñ_bômask
 & 4))

270 i‡(!(
c
->
˝u_modñ_bômask
 & 8))

275 i‡(!(
c
->
˝u_modñ_bômask
 & 2))

280 #ifde‡
CONFIG_ARCH_IXP23XX


282 i‡(!(
c
->
˝u_modñ_bômask
 & 0x3f0))

291 
ªv
 = 
¥odu˘_id
 & 0xff;

292 i‡(
ªv
 < 
c
->
˝u_mö_ªvisi⁄
 ||Ñev > c->
˝u_max_ªvisi⁄
)

296 
	}
}

298 
	$gíî©e_ucode
(
u8
 *
ucode
, 
u32
 *
g¥_a
, u32 *
g¥_b
)

300 
off£t
;

301 
i
;

303 
off£t
 = 0;

305 
i
 = 0; i < 128; i++) {

306 
u8
 
b3
;

307 
u8
 
b2
;

308 
u8
 
b1
;

309 
u8
 
b0
;

311 
b3
 = (
g¥_a
[
i
] >> 24) & 0xff;

312 
b2
 = (
g¥_a
[
i
] >> 16) & 0xff;

313 
b1
 = (
g¥_a
[
i
] >> 8) & 0xff;

314 
b0
 = 
g¥_a
[
i
] & 0xff;

318 
ucode
[
off£t
++] = 0xf0;

319 
ucode
[
off£t
++] = (
b1
 >> 4);

320 
ucode
[
off£t
++] = (
b1
 << 4Ë| 0x0¯| (
b0
 >> 6);

321 
ucode
[
off£t
++] = (
b0
 << 2);

322 
ucode
[
off£t
++] = 0x80 | 
i
;

326 
ucode
[
off£t
++] = 0xf4;

327 
ucode
[
off£t
++] = 0x40 | (
b3
 >> 4);

328 
ucode
[
off£t
++] = (
b3
 << 4Ë| 0x0¯| (
b2
 >> 6);

329 
ucode
[
off£t
++] = (
b2
 << 2);

330 
ucode
[
off£t
++] = 0x80 | 
i
;

333 
i
 = 0; i < 128; i++) {

334 
u8
 
b3
;

335 
u8
 
b2
;

336 
u8
 
b1
;

337 
u8
 
b0
;

339 
b3
 = (
g¥_b
[
i
] >> 24) & 0xff;

340 
b2
 = (
g¥_b
[
i
] >> 16) & 0xff;

341 
b1
 = (
g¥_b
[
i
] >> 8) & 0xff;

342 
b0
 = 
g¥_b
[
i
] & 0xff;

346 
ucode
[
off£t
++] = 0xf0;

347 
ucode
[
off£t
++] = (
b1
 >> 4);

348 
ucode
[
off£t
++] = (
b1
 << 4Ë| 0x02 | (
i
 >> 6);

349 
ucode
[
off£t
++] = (
i
 << 2) | 0x03;

350 
ucode
[
off£t
++] = 
b0
;

354 
ucode
[
off£t
++] = 0xf4;

355 
ucode
[
off£t
++] = 0x40 | (
b3
 >> 4);

356 
ucode
[
off£t
++] = (
b3
 << 4Ë| 0x02 | (
i
 >> 6);

357 
ucode
[
off£t
++] = (
i
 << 2) | 0x03;

358 
ucode
[
off£t
++] = 
b2
;

362 
ucode
[
off£t
++] = 0xe0;

363 
ucode
[
off£t
++] = 0x00;

364 
ucode
[
off£t
++] = 0x01;

365 
ucode
[
off£t
++] = 0x00;

366 
ucode
[
off£t
++] = 0x00;

367 
	}
}

369 
	$£t_öôül_ªgi°îs
(
uígöe
, 
ixp2000_uígöe_code
 *
c
)

371 
≥r_˘x_ªgs
;

372 
u32
 *
g¥_a
;

373 
u32
 *
g¥_b
;

374 
u8
 *
ucode
;

375 
i
;

377 
g¥_a
 = 
	`kmÆloc
(128 * (
u32
), 
GFP_KERNEL
);

378 
g¥_b
 = 
	`kmÆloc
(128 * (
u32
), 
GFP_KERNEL
);

379 
ucode
 = 
	`kmÆloc
(513 * 5, 
GFP_KERNEL
);

380 i‡(
g¥_a
 =
NULL
 || 
g¥_b
 =NULL || 
ucode
 == NULL) {

381 
	`k‰ì
(
ucode
);

382 
	`k‰ì
(
g¥_b
);

383 
	`k‰ì
(
g¥_a
);

387 
≥r_˘x_ªgs
 = 16;

388 i‡(
c
->
uígöe_∑ømëîs
 & 
IXP2000_UENGINE_4_CONTEXTS
)

389 
≥r_˘x_ªgs
 = 32;

391 
	`mem£t
(
g¥_a
, 0, (gpr_a));

392 
	`mem£t
(
g¥_b
, 0, (gpr_b));

393 
i
 = 0; i < 256; i++) {

394 
ixp2000_ªg_vÆue
 *
r
 = 
c
->
öôül_ªg_vÆues
 + 
i
;

395 
u32
 *
b™k
;

396 
öc
;

397 
j
;

399 i‡(
r
->
ªg
 == -1)

402 
b™k
 = (
r
->
ªg
 & 0x400Ë? 
g¥_b
 : 
g¥_a
;

403 
öc
 = (
r
->
ªg
 & 0x80Ë? 128 : 
≥r_˘x_ªgs
;

405 
j
 = 
r
->
ªg
 & 0x7f;

406 
j
 < 128) {

407 
b™k
[
j
] = 
r
->
vÆue
;

408 
j
 +
öc
;

412 
	`gíî©e_ucode
(
ucode
, 
g¥_a
, 
g¥_b
);

413 
	`ixp2000_uígöe_lﬂd_mi¸ocode
(
uígöe
, 
ucode
, 513);

414 
	`ixp2000_uígöe_öô_c⁄ãxt
(
uígöe
, 0, 0);

415 
	`ixp2000_uígöe_°¨t_c⁄ãxts
(
uígöe
, 0x01);

416 
i
 = 0; i < 100; i++) {

417 
u32
 
°©us
;

419 
°©us
 = 
	`ixp2000_uígöe_c§_ªad
(
uígöe
, 
ACTIVE_CTX_STS
);

420 i‡(!(
°©us
 & 0x80000000))

423 
	`ixp2000_uígöe_°›_c⁄ãxts
(
uígöe
, 0x01);

425 
	`k‰ì
(
ucode
);

426 
	`k‰ì
(
g¥_b
);

427 
	`k‰ì
(
g¥_a
);

429  !!(
i
 == 100);

430 
	}
}

432 
	$ixp2000_uígöe_lﬂd
(
uígöe
, 
ixp2000_uígöe_code
 *
c
)

434 
˘x
;

436 i‡(!
	`check_ixp_ty≥
(
c
))

439 i‡(!(
ixp2000_uígöe_mask
 & (1 << 
uígöe
)))

442 
	`ixp2000_uígöe_ª£t
(1 << 
uígöe
);

443 
	`ixp2000_uígöe_£t_mode
(
uígöe
, 
c
->
uígöe_∑ømëîs
);

444 i‡(
	`£t_öôül_ªgi°îs
(
uígöe
, 
c
))

446 
	`ixp2000_uígöe_lﬂd_mi¸ocode
(
uígöe
, 
c
->
ö¢s
, c->
num_ö¢s
);

448 
˘x
 = 0; ctx < 8; ctx++)

449 
	`ixp2000_uígöe_öô_c⁄ãxt
(
uígöe
, 
˘x
, 0);

452 
	}
}

453 
EXPORT_SYMBOL
(
ixp2000_uígöe_lﬂd
);

456 
__öô
 
	$ixp2000_uígöe_öô
()

458 
uígöe
;

459 
u32
 
vÆue
;

464 (
	`ixp2000_ªg_ªad
(
IXP_PRODUCT_ID
) >> 8) & 0x1fff) {

465 #ifde‡
CONFIG_ARCH_IXP2000


468 
ixp2000_uígöe_mask
 = 0x00ff00ff;

472 
ixp2000_uígöe_mask
 = 0x000f000f;

476 #ifde‡
CONFIG_ARCH_IXP23XX


478 
ixp2000_uígöe_mask
 = (*
IXP23XX_EXP_CFG_FUSE
 >> 8) & 0xf;

483 
	`¥ötk
(
KERN_INFO
 "Detected unknown IXP2000 model (%.8x)\n",

484 ()
	`ixp2000_ªg_ªad
(
IXP_PRODUCT_ID
));

485 
ixp2000_uígöe_mask
 = 0x00000000;

492 
	`ixp2000_uígöe_ª£t
(
ixp2000_uígöe_mask
);

497 
vÆue
 = 
	`ixp2000_ªg_ªad
(
IXP_MISC_CONTROL
);

498 
	`ixp2000_ªg_wrb
(
IXP_MISC_CONTROL
, 
vÆue
 & ~0x80);

499 
uígöe
 = 0; uengine < 32; uengine++) {

500 i‡(
ixp2000_uígöe_mask
 & (1 << 
uígöe
)) {

501 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
TIMESTAMP_LOW
, 0);

502 
	`ixp2000_uígöe_c§_wrôe
(
uígöe
, 
TIMESTAMP_HIGH
, 0);

505 
	`ixp2000_ªg_wrb
(
IXP_MISC_CONTROL
, 
vÆue
 | 0x80);

508 
	}
}

510 
subsys_öôˇŒ
(
ixp2000_uígöe_öô
);

	@arch/arm/common/via82c505.c

1 
	~<löux/kî√l.h
>

2 
	~<löux/pci.h
>

3 
	~<löux/öãºu±.h
>

4 
	~<löux/mm.h
>

5 
	~<löux/öô.h
>

6 
	~<löux/i›‹t.h
>

8 
	~<asm/io.h
>

9 
	~<asm/sy°em.h
>

11 
	~<asm/mach/pci.h
>

13 
	#MAX_SLOTS
 7

	)

15 
	#CONFIG_CMD
(
bus
, 
dev‚
, 
whîe
Ë(0x80000000 | (bus->
numbî
 << 16Ë| (dev‚ << 8Ë| (whîê& ~3))

	)

18 
	$vü82c505_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

19 
size
, 
u32
 *
vÆue
)

21 
	`oué
(
	`CONFIG_CMD
(
bus
,
dev‚
,
whîe
),0xCF8);

22 
size
) {

24 *
vÆue
=
	`öb
(0xCFC + (
whîe
&3));

27 *
vÆue
=
	`öw
(0xCFC + (
whîe
&2));

30 *
vÆue
=
	`öl
(0xCFC);

33  
PCIBIOS_SUCCESSFUL
;

34 
	}
}

37 
	$vü82c505_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

38 
size
, 
u32
 
vÆue
)

40 
	`oué
(
	`CONFIG_CMD
(
bus
,
dev‚
,
whîe
),0xCF8);

41 
size
) {

43 
	`outb
(
vÆue
, 0xCFC + (
whîe
&3));

46 
	`outw
(
vÆue
, 0xCFC + (
whîe
&2));

49 
	`oué
(
vÆue
, 0xCFC);

52  
PCIBIOS_SUCCESSFUL
;

53 
	}
}

55 
pci_›s
 
	gvü82c505_›s
 = {

56 .
ªad
 = 
vü82c505_ªad_c⁄fig
,

57 .
	gwrôe
 = 
vü82c505_wrôe_c⁄fig
,

60 
__öô
 
	$vü82c505_¥eöô
()

62 
	`¥ötk
(
KERN_DEBUG
 "PCI: VIA 82c505\n");

63 i‡(!
	`ªque°_ªgi⁄
(0xA8,2,"via config")) {

64 
	`¥ötk
(
KERN_WARNING
"VIA 82c505: UnableÅoÑequestÑegion 0xA8\n");

67 i‡(!
	`ªque°_ªgi⁄
(0xCF8,8,"pci config")) {

68 
	`¥ötk
(
KERN_WARNING
"VIA 82c505: UnableÅoÑequestÑegion 0xCF8\n");

69 
	`ªÀa£_ªgi⁄
(0xA8, 2);

74 
	`outb
(0x96,0xA8);

75 
	`outb
(0x18,0xA9);

76 
	`outb
(0x93,0xA8);

77 
	`outb
(0xd0,0xA9);

79 
	}
}

81 
__öô
 
	$vü82c505_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

83  (
ƒ
 == 0);

84 
	}
}

86 
pci_bus
 * 
__öô
 
	$vü82c505_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sysd©a
)

88 i‡(
ƒ
 == 0)

89  
	`pci_sˇn_bus
(0, &
vü82c505_›s
, 
sysd©a
);

91  
NULL
;

92 
	}
}

	@arch/arm/common/vic.c

21 
	~<löux/öô.h
>

22 
	~<löux/li°.h
>

24 
	~<asm/io.h
>

25 
	~<asm/mach/úq.h
>

26 
	~<asm/h¨dw¨e/vic.h
>

28 
	$vic_mask_úq
(
úq
)

30 
__iomem
 *
ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

31 
úq
 &= 31;

32 
	`wrôñ
(1 << 
úq
, 
ba£
 + 
VIC_INT_ENABLE_CLEAR
);

33 
	}
}

35 
	$vic_unmask_úq
(
úq
)

37 
__iomem
 *
ba£
 = 
	`gë_úq_chù_d©a
(
úq
);

38 
úq
 &= 31;

39 
	`wrôñ
(1 << 
úq
, 
ba£
 + 
VIC_INT_ENABLE
);

40 
	}
}

42 
úq_chù
 
	gvic_chù
 = {

43 .
«me
 = "VIC",

44 .
	gack
 = 
vic_mask_úq
,

45 .
	gmask
 = 
vic_mask_úq
,

46 .
	gunmask
 = 
vic_unmask_úq
,

55 
__öô
 
	$vic_öô
(
__iomem
 *
ba£
, 
úq_°¨t
,

56 
u32
 
vic_sour˚s
)

58 
i
;

62 
	`wrôñ
(0, 
ba£
 + 
VIC_INT_SELECT
);

63 
	`wrôñ
(0, 
ba£
 + 
VIC_INT_ENABLE
);

64 
	`wrôñ
(~0, 
ba£
 + 
VIC_INT_ENABLE_CLEAR
);

65 
	`wrôñ
(0, 
ba£
 + 
VIC_IRQ_STATUS
);

66 
	`wrôñ
(0, 
ba£
 + 
VIC_ITCR
);

67 
	`wrôñ
(~0, 
ba£
 + 
VIC_INT_SOFT_CLEAR
);

72 
	`wrôñ
(0, 
ba£
 + 
VIC_VECT_ADDR
);

73 
i
 = 0; i < 19; i++) {

74 
vÆue
;

76 
vÆue
 = 
	`ªadl
(
ba£
 + 
VIC_VECT_ADDR
);

77 
	`wrôñ
(
vÆue
, 
ba£
 + 
VIC_VECT_ADDR
);

80 
i
 = 0; i < 16; i++) {

81 
__iomem
 *
ªg
 = 
ba£
 + 
VIC_VECT_CNTL0
 + (
i
 * 4);

82 
	`wrôñ
(
VIC_VECT_CNTL_ENABLE
 | 
i
, 
ªg
);

85 
	`wrôñ
(32, 
ba£
 + 
VIC_DEF_VECT_ADDR
);

87 
i
 = 0; i < 32; i++) {

88 
úq
 = 
úq_°¨t
 + 
i
;

90 
	`£t_úq_chù
(
úq
, &
vic_chù
);

91 
	`£t_úq_chù_d©a
(
úq
, 
ba£
);

93 i‡(
vic_sour˚s
 & (1 << 
i
)) {

94 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

95 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

98 
	}
}

	@arch/arm/kernel/armksyms.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/°rög.h
>

12 
	~<löux/¸y±ohash.h
>

13 
	~<löux/dñay.h
>

14 
	~<löux/ö6.h
>

15 
	~<löux/sysˇŒs.h
>

17 
	~<asm/checksum.h
>

18 
	~<asm/io.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/uac˚ss.h
>

27 
__ashldi3
();

28 
__ashrdi3
();

29 
__divsi3
();

30 
__lshrdi3
();

31 
__modsi3
();

32 
__muldi3
();

33 
__ucmpdi2
();

34 
__udivsi3
();

35 
__umodsi3
();

36 
__do_div64
();

38 
__´abi_idiv
();

39 
__´abi_idivmod
();

40 
__´abi_œ§
();

41 
__´abi_Œ¶
();

42 
__´abi_Œ§
();

43 
__´abi_lmul
();

44 
__´abi_uidiv
();

45 
__´abi_uidivmod
();

46 
__´abi_ulcmp
();

48 
Âundefö°r
();

49 
Â_íãr
();

55 
	#EXPORT_CRC_ALIAS
(
sym
Ë
	`__CRC_SYMBOL
(sym, "")

	)

57 
	#EXPORT_SYMBOL_ALIAS
(
sym
,
‹ig
) \

58 
	`EXPORT_CRC_ALIAS
(
sym
) \

59 c⁄° 
kî√l_symbﬁ
 
__ksymèb_
##
sym
 \

60 
__u£d
 
	`__©åibuã__
((
	`£˘i⁄
("__ksymtab"))) = \

61 { ()&
‹ig
, #sym };

	)

67 
EXPORT_SYMBOL_ALIAS
(
kîn_Â_íãr
,
Â_íãr
);

68 
EXPORT_SYMBOL_ALIAS
(
Â_¥ötk
,
¥ötk
);

69 
EXPORT_SYMBOL_ALIAS
(
Â_£nd_sig
,
£nd_sig
);

71 
EXPORT_SYMBOL
(
__backåa˚
);

74 
EXPORT_SYMBOL
(
__udñay
);

75 
EXPORT_SYMBOL
(
__c⁄°_udñay
);

78 
EXPORT_SYMBOL
(
csum_∑πül
);

79 
EXPORT_SYMBOL
(
csum_∑πül_c›y_‰om_u£r
);

80 
EXPORT_SYMBOL
(
csum_∑πül_c›y_nocheck
);

81 
EXPORT_SYMBOL
(
__csum_ùv6_magic
);

84 #i‚de‡
__øw_ªadsb


85 
EXPORT_SYMBOL
(
__øw_ªadsb
);

87 #i‚de‡
__øw_ªadsw


88 
EXPORT_SYMBOL
(
__øw_ªadsw
);

90 #i‚de‡
__øw_ªad¶


91 
EXPORT_SYMBOL
(
__øw_ªad¶
);

93 #i‚de‡
__øw_wrôesb


94 
EXPORT_SYMBOL
(
__øw_wrôesb
);

96 #i‚de‡
__øw_wrôesw


97 
EXPORT_SYMBOL
(
__øw_wrôesw
);

99 #i‚de‡
__øw_wrôe¶


100 
EXPORT_SYMBOL
(
__øw_wrôe¶
);

104 
EXPORT_SYMBOL
(
°rchr
);

105 
EXPORT_SYMBOL
(
°ºchr
);

106 
EXPORT_SYMBOL
(
mem£t
);

107 
EXPORT_SYMBOL
(
mem˝y
);

108 
EXPORT_SYMBOL
(
memmove
);

109 
EXPORT_SYMBOL
(
memchr
);

110 
EXPORT_SYMBOL
(
__memzîo
);

113 
EXPORT_SYMBOL
(
__°∫Àn_u£r
);

114 
EXPORT_SYMBOL
(
__°∫˝y_‰om_u£r
);

116 #ifde‡
CONFIG_MMU


117 
EXPORT_SYMBOL
(
__c›y_‰om_u£r
);

118 
EXPORT_SYMBOL
(
__c›y_to_u£r
);

119 
EXPORT_SYMBOL
(
__˛ór_u£r
);

121 
EXPORT_SYMBOL
(
__gë_u£r_1
);

122 
EXPORT_SYMBOL
(
__gë_u£r_2
);

123 
EXPORT_SYMBOL
(
__gë_u£r_4
);

125 
EXPORT_SYMBOL
(
__put_u£r_1
);

126 
EXPORT_SYMBOL
(
__put_u£r_2
);

127 
EXPORT_SYMBOL
(
__put_u£r_4
);

128 
EXPORT_SYMBOL
(
__put_u£r_8
);

132 
EXPORT_SYMBOL
(
sha_å™sf‹m
);

135 
EXPORT_SYMBOL
(
__ashldi3
);

136 
EXPORT_SYMBOL
(
__ashrdi3
);

137 
EXPORT_SYMBOL
(
__divsi3
);

138 
EXPORT_SYMBOL
(
__lshrdi3
);

139 
EXPORT_SYMBOL
(
__modsi3
);

140 
EXPORT_SYMBOL
(
__muldi3
);

141 
EXPORT_SYMBOL
(
__ucmpdi2
);

142 
EXPORT_SYMBOL
(
__udivsi3
);

143 
EXPORT_SYMBOL
(
__umodsi3
);

144 
EXPORT_SYMBOL
(
__do_div64
);

146 #ifde‡
CONFIG_AEABI


147 
EXPORT_SYMBOL
(
__´abi_idiv
);

148 
EXPORT_SYMBOL
(
__´abi_idivmod
);

149 
EXPORT_SYMBOL
(
__´abi_œ§
);

150 
EXPORT_SYMBOL
(
__´abi_Œ¶
);

151 
EXPORT_SYMBOL
(
__´abi_Œ§
);

152 
EXPORT_SYMBOL
(
__´abi_lmul
);

153 
EXPORT_SYMBOL
(
__´abi_uidiv
);

154 
EXPORT_SYMBOL
(
__´abi_uidivmod
);

155 
EXPORT_SYMBOL
(
__´abi_ulcmp
);

159 
EXPORT_SYMBOL
(
_£t_bô_À
);

160 
EXPORT_SYMBOL
(
_ã°_™d_£t_bô_À
);

161 
EXPORT_SYMBOL
(
_˛ór_bô_À
);

162 
EXPORT_SYMBOL
(
_ã°_™d_˛ór_bô_À
);

163 
EXPORT_SYMBOL
(
_ch™ge_bô_À
);

164 
EXPORT_SYMBOL
(
_ã°_™d_ch™ge_bô_À
);

165 
EXPORT_SYMBOL
(
_föd_fú°_zîo_bô_À
);

166 
EXPORT_SYMBOL
(
_föd_√xt_zîo_bô_À
);

167 
EXPORT_SYMBOL
(
_föd_fú°_bô_À
);

168 
EXPORT_SYMBOL
(
_föd_√xt_bô_À
);

170 #ifde‡
__ARMEB__


171 
EXPORT_SYMBOL
(
_£t_bô_be
);

172 
EXPORT_SYMBOL
(
_ã°_™d_£t_bô_be
);

173 
EXPORT_SYMBOL
(
_˛ór_bô_be
);

174 
EXPORT_SYMBOL
(
_ã°_™d_˛ór_bô_be
);

175 
EXPORT_SYMBOL
(
_ch™ge_bô_be
);

176 
EXPORT_SYMBOL
(
_ã°_™d_ch™ge_bô_be
);

177 
EXPORT_SYMBOL
(
_föd_fú°_zîo_bô_be
);

178 
EXPORT_SYMBOL
(
_föd_√xt_zîo_bô_be
);

179 
EXPORT_SYMBOL
(
_föd_fú°_bô_be
);

180 
EXPORT_SYMBOL
(
_föd_√xt_bô_be
);

	@arch/arm/kernel/arthur.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/≥rs⁄Æôy.h
>

18 
	~<löux/°ddef.h
>

19 
	~<löux/sig«l.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/sched.h
>

23 
	~<asm/±ø˚.h
>

28 
	#ARTHUR_SIGABRT
 1

	)

29 
	#ARTHUR_SIGFPE
 2

	)

30 
	#ARTHUR_SIGILL
 3

	)

31 
	#ARTHUR_SIGINT
 4

	)

32 
	#ARTHUR_SIGSEGV
 5

	)

33 
	#ARTHUR_SIGTERM
 6

	)

34 
	#ARTHUR_SIGSTAK
 7

	)

35 
	#ARTHUR_SIGUSR1
 8

	)

36 
	#ARTHUR_SIGUSR2
 9

	)

37 
	#ARTHUR_SIGOSERROR
 10

	)

39 
	g¨thur_to_löux_sig«ls
[32] = {

46 
	glöux_to_¨thur_sig«ls
[32] = {

47 0, -1, 
ARTHUR_SIGINT
, -1,

48 
ARTHUR_SIGILL
, 5, 
ARTHUR_SIGABRT
, 7,

49 
ARTHUR_SIGFPE
, 9, 
ARTHUR_SIGUSR1
, 
ARTHUR_SIGSEGV
,

50 
ARTHUR_SIGUSR2
, 13, 14, 
ARTHUR_SIGTERM
,

57 
	$¨thur_lˇŒ7
(
ƒ
, 
±_ªgs
 *
ªgs
)

59 
sigöfo
 
öfo
;

60 
öfo
.
si_signo
 = 
SIGSWI
;

61 
öfo
.
si_î∫o
 = 
ƒ
;

63 
	`£nd_sig_öfo
(
SIGSWI
, &
öfo
, 
cuºít
);

64 
	}
}

66 
exec_domaö
 
	g¨thur_exec_domaö
 = {

67 .
«me
 = "Arthur",

68 .
	gh™dÀr
 = 
¨thur_lˇŒ7
,

69 .
	g≥rs_low
 = 
PER_RISCOS
,

70 .
	g≥rs_high
 = 
PER_RISCOS
,

71 .
	gsig«l_m≠
 = 
¨thur_to_löux_sig«ls
,

72 .
	gsig«l_övm≠
 = 
löux_to_¨thur_sig«ls
,

73 .
	gmoduÀ
 = 
THIS_MODULE
,

81 
__öô
 
	$¨thur_öô
()

83  
	`ªgi°î_exec_domaö
(&
¨thur_exec_domaö
);

84 
	}
}

86 
__exô
 
	$¨thur_exô
()

88 
	`uƒegi°î_exec_domaö
(&
¨thur_exec_domaö
);

89 
	}
}

91 
moduÀ_öô
(
¨thur_öô
);

92 
moduÀ_exô
(
¨thur_exô
);

	@arch/arm/kernel/asm-offsets.c

13 
	~<löux/sched.h
>

14 
	~<löux/mm.h
>

15 
	~<asm/mach/¨ch.h
>

16 
	~<asm/thªad_öfo.h
>

17 
	~<asm/mem‹y.h
>

18 
	~<asm/¥ocöfo.h
>

23 #i‡
deföed
(
__APCS_26__
)

24 #îr‹ 
S‹ry
, 
your
 
compûî
 
èrgës
 
APCS
-26 
but
 
this
 
kî√l
 
ªquúes
 APCS-32

33 #i‡(
__GNUC__
 =3 && 
__GNUC_MINOR__
 < 3)

34 #îr‹ 
Your
 
compûî
 
is
 
too
 
buggy
; 
ô
 i†
known
 
to
 
miscompûe
 
kî√ls
.

35 #îr‹ 
Known
 
good
 
compûîs
: 3.3

40 
	#DEFINE
(
sym
, 
vÆ
) \

41 
asm
 vﬁ©ûe("\n->" #sym " %0 " #vÆ : : "i" (
vÆ
))

	)

43 
	#BLANK
(Ë
asm
 vﬁ©ûe("\n->" : : )

	)

45 
	$maö
()

47 
	`DEFINE
(
TSK_ACTIVE_MM
, 
	`off£tof
(
èsk_°ru˘
, 
a˘ive_mm
));

48 
	`BLANK
();

49 
	`DEFINE
(
TI_FLAGS
, 
	`off£tof
(
thªad_öfo
, 
Êags
));

50 
	`DEFINE
(
TI_PREEMPT
, 
	`off£tof
(
thªad_öfo
, 
¥ìm±_cou¡
));

51 
	`DEFINE
(
TI_ADDR_LIMIT
, 
	`off£tof
(
thªad_öfo
, 
addr_limô
));

52 
	`DEFINE
(
TI_TASK
, 
	`off£tof
(
thªad_öfo
, 
èsk
));

53 
	`DEFINE
(
TI_EXEC_DOMAIN
, 
	`off£tof
(
thªad_öfo
, 
exec_domaö
));

54 
	`DEFINE
(
TI_CPU
, 
	`off£tof
(
thªad_öfo
, 
˝u
));

55 
	`DEFINE
(
TI_CPU_DOMAIN
, 
	`off£tof
(
thªad_öfo
, 
˝u_domaö
));

56 
	`DEFINE
(
TI_CPU_SAVE
, 
	`off£tof
(
thªad_öfo
, 
˝u_c⁄ãxt
));

57 
	`DEFINE
(
TI_USED_CP
, 
	`off£tof
(
thªad_öfo
, 
u£d_˝
));

58 
	`DEFINE
(
TI_TP_VALUE
, 
	`off£tof
(
thªad_öfo
, 
ç_vÆue
));

59 
	`DEFINE
(
TI_FPSTATE
, 
	`off£tof
(
thªad_öfo
, 
Â°©e
));

60 
	`DEFINE
(
TI_VFPSTATE
, 
	`off£tof
(
thªad_öfo
, 
vÂ°©e
));

61 #ifde‡
CONFIG_IWMMXT


62 
	`DEFINE
(
TI_IWMMXT_STATE
, 
	`off£tof
(
thªad_öfo
, 
Â°©e
.
iwmmxt
));

64 #ifde‡
CONFIG_CRUNCH


65 
	`DEFINE
(
TI_CRUNCH_STATE
, 
	`off£tof
(
thªad_öfo
, 
¸unch°©e
));

67 
	`BLANK
();

68 
	`DEFINE
(
S_R0
, 
	`off£tof
(
±_ªgs
, 
ARM_r0
));

69 
	`DEFINE
(
S_R1
, 
	`off£tof
(
±_ªgs
, 
ARM_r1
));

70 
	`DEFINE
(
S_R2
, 
	`off£tof
(
±_ªgs
, 
ARM_r2
));

71 
	`DEFINE
(
S_R3
, 
	`off£tof
(
±_ªgs
, 
ARM_r3
));

72 
	`DEFINE
(
S_R4
, 
	`off£tof
(
±_ªgs
, 
ARM_r4
));

73 
	`DEFINE
(
S_R5
, 
	`off£tof
(
±_ªgs
, 
ARM_r5
));

74 
	`DEFINE
(
S_R6
, 
	`off£tof
(
±_ªgs
, 
ARM_r6
));

75 
	`DEFINE
(
S_R7
, 
	`off£tof
(
±_ªgs
, 
ARM_r7
));

76 
	`DEFINE
(
S_R8
, 
	`off£tof
(
±_ªgs
, 
ARM_r8
));

77 
	`DEFINE
(
S_R9
, 
	`off£tof
(
±_ªgs
, 
ARM_r9
));

78 
	`DEFINE
(
S_R10
, 
	`off£tof
(
±_ªgs
, 
ARM_r10
));

79 
	`DEFINE
(
S_FP
, 
	`off£tof
(
±_ªgs
, 
ARM_Â
));

80 
	`DEFINE
(
S_IP
, 
	`off£tof
(
±_ªgs
, 
ARM_ù
));

81 
	`DEFINE
(
S_SP
, 
	`off£tof
(
±_ªgs
, 
ARM_•
));

82 
	`DEFINE
(
S_LR
, 
	`off£tof
(
±_ªgs
, 
ARM_Ã
));

83 
	`DEFINE
(
S_PC
, 
	`off£tof
(
±_ªgs
, 
ARM_pc
));

84 
	`DEFINE
(
S_PSR
, 
	`off£tof
(
±_ªgs
, 
ARM_˝§
));

85 
	`DEFINE
(
S_OLD_R0
, 
	`off£tof
(
±_ªgs
, 
ARM_ORIG_r0
));

86 
	`DEFINE
(
S_FRAME_SIZE
, (
±_ªgs
));

87 
	`BLANK
();

88 #ifde‡
CONFIG_CPU_HAS_ASID


89 
	`DEFINE
(
MM_CONTEXT_ID
, 
	`off£tof
(
mm_°ru˘
, 
c⁄ãxt
.
id
));

90 
	`BLANK
();

92 
	`DEFINE
(
VMA_VM_MM
, 
	`off£tof
(
vm_¨ó_°ru˘
, 
vm_mm
));

93 
	`DEFINE
(
VMA_VM_FLAGS
, 
	`off£tof
(
vm_¨ó_°ru˘
, 
vm_Êags
));

94 
	`BLANK
();

95 
	`DEFINE
(
VM_EXEC
, VM_EXEC);

96 
	`BLANK
();

97 
	`DEFINE
(
PAGE_SZ
, 
PAGE_SIZE
);

98 
	`BLANK
();

99 
	`DEFINE
(
SYS_ERROR0
, 0x9f0000);

100 
	`BLANK
();

101 
	`DEFINE
(
SIZEOF_MACHINE_DESC
, (
machöe_desc
));

102 
	`DEFINE
(
MACHINFO_TYPE
, 
	`off£tof
(
machöe_desc
, 
ƒ
));

103 
	`DEFINE
(
MACHINFO_NAME
, 
	`off£tof
(
machöe_desc
, 
«me
));

104 
	`DEFINE
(
MACHINFO_PHYSIO
, 
	`off£tof
(
machöe_desc
, 
phys_io
));

105 
	`DEFINE
(
MACHINFO_PGOFFIO
, 
	`off£tof
(
machöe_desc
, 
io_pg_off°
));

106 
	`BLANK
();

107 
	`DEFINE
(
PROC_INFO_SZ
, (
¥oc_öfo_li°
));

108 
	`DEFINE
(
PROCINFO_INITFUNC
, 
	`off£tof
(
¥oc_öfo_li°
, 
__˝u_Êush
));

109 
	`DEFINE
(
PROCINFO_MM_MMUFLAGS
, 
	`off£tof
(
¥oc_öfo_li°
, 
__˝u_mm_mmu_Êags
));

110 
	`DEFINE
(
PROCINFO_IO_MMUFLAGS
, 
	`off£tof
(
¥oc_öfo_li°
, 
__˝u_io_mmu_Êags
));

112 
	}
}

	@arch/arm/kernel/bios32.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/kî√l.h
>

10 
	~<löux/pci.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/öô.h
>

14 
	~<asm/io.h
>

15 
	~<asm/mach-ty≥s.h
>

16 
	~<asm/mach/pci.h
>

18 
	gdebug_pci
;

19 
	gu£_fúmw¨e
;

25 
	$pcibios_bus_ªp‹t_°©us
(
pci_bus
 *
bus
, 
u_öt
 
°©us_mask
, 
w¨n
)

27 
pci_dev
 *
dev
;

29 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
) {

30 
u16
 
°©us
;

36 i‡(
dev
->
bus
->
numbî
 =0 && dev->
dev‚
 == 0)

39 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_STATUS
, &
°©us
);

40 i‡(
°©us
 == 0xffff)

43 i‡((
°©us
 & 
°©us_mask
) == 0)

47 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_STATUS
, 
°©us
 & 
°©us_mask
);

49 i‡(
w¨n
)

50 
	`¥ötk
("(%s: %04XË", 
	`pci_«me
(
dev
), 
°©us
);

53 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
)

54 i‡(
dev
->
sub‹dö©e
)

55 
	`pcibios_bus_ªp‹t_°©us
(
dev
->
sub‹dö©e
, 
°©us_mask
, 
w¨n
);

56 
	}
}

58 
	$pcibios_ªp‹t_°©us
(
u_öt
 
°©us_mask
, 
w¨n
)

60 
li°_hód
 *
l
;

62 
	`li°_f‹_óch
(
l
, &
pci_roŸ_bu£s
) {

63 
pci_bus
 *
bus
 = 
	`pci_bus_b
(
l
);

65 
	`pcibios_bus_ªp‹t_°©us
(
bus
, 
°©us_mask
, 
w¨n
);

67 
	}
}

81 
__devöô
 
	$pci_fixup_83c553
(
pci_dev
 *
dev
)

86 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
PCI_BASE_ADDRESS_0
, 
PCI_BASE_ADDRESS_SPACE_MEMORY
);

87 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, 
PCI_COMMAND_IO
);

89 
dev
->
ªsour˚
[0].
íd
 -dev->ªsour˚[0].
°¨t
;

90 
dev
->
ªsour˚
[0].
°¨t
 = 0;

95 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x48, 0xff);

102 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x42, 0x01);

107 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x40, 0x22);

115 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x83, 0x02);

121 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x80, 0x11);

122 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x81, 0x00);

128 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 0x44, 0xb000);

129 
	`outb
(0x08, 0x4d1);

130 
	}
}

131 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_WINBOND
, 
PCI_DEVICE_ID_WINBOND_83C553
, 
pci_fixup_83c553
);

133 
__devöô
 
	$pci_fixup_u«ssign
(
pci_dev
 *
dev
)

135 
dev
->
ªsour˚
[0].
íd
 -dev->ªsour˚[0].
°¨t
;

136 
dev
->
ªsour˚
[0].
°¨t
 = 0;

137 
	}
}

138 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_WINBOND2
, 
PCI_DEVICE_ID_WINBOND2_89C940F
, 
pci_fixup_u«ssign
);

145 
__devöô
 
	$pci_fixup_dec21285
(
pci_dev
 *
dev
)

147 
i
;

149 i‡(
dev
->
dev‚
 == 0) {

150 
dev
->
˛ass
 &= 0xff;

151 
dev
->
˛ass
 |
PCI_CLASS_BRIDGE_HOST
 << 8;

152 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

153 
dev
->
ªsour˚
[
i
].
°¨t
 = 0;

154 
dev
->
ªsour˚
[
i
].
íd
 = 0;

155 
dev
->
ªsour˚
[
i
].
Êags
 = 0;

158 
	}
}

159 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_DEC
, 
PCI_DEVICE_ID_DEC_21285
, 
pci_fixup_dec21285
);

170 
__devöô
 
	$pci_fixup_¥pmc1100
(
pci_dev
 *
dev
)

172 
i
;

174 i‡(
	`machöe_is_¥pmc1100
()) {

175 
dev
->
˛ass
 &= 0xff;

176 
dev
->
˛ass
 |
PCI_CLASS_BRIDGE_HOST
 << 8;

177 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

178 
dev
->
ªsour˚
[
i
].
°¨t
 = 0;

179 
dev
->
ªsour˚
[
i
].
íd
 = 0;

180 
dev
->
ªsour˚
[
i
].
Êags
 = 0;

183 
	}
}

184 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_IXP4XX
, 
pci_fixup_¥pmc1100
);

189 
__devöô
 
	$pci_fixup_ide_ba£s
(
pci_dev
 *
dev
)

191 
ªsour˚
 *
r
;

192 
i
;

194 i‡((
dev
->
˛ass
 >> 8Ë!
PCI_CLASS_STORAGE_IDE
)

197 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

198 
r
 = 
dev
->
ªsour˚
 + 
i
;

199 i‡((
r
->
°¨t
 & ~0x80) == 0x374) {

200 
r
->
°¨t
 |= 2;

201 
r
->
íd
 =Ñ->
°¨t
;

204 
	}
}

205 
DECLARE_PCI_FIXUP_HEADER
(
PCI_ANY_ID
, PCI_ANY_ID, 
pci_fixup_ide_ba£s
);

210 
__devöô
 
	$pci_fixup_dec21142
(
pci_dev
 *
dev
)

212 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 0x40, 0x80000000);

213 
	}
}

214 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_DEC
, 
PCI_DEVICE_ID_DEC_21142
, 
pci_fixup_dec21142
);

232 
__devöô
 
	$pci_fixup_cy82c693
(
pci_dev
 *
dev
)

234 i‡((
dev
->
˛ass
 >> 8Ë=
PCI_CLASS_STORAGE_IDE
) {

235 
u32
 
ba£0
, 
ba£1
;

237 i‡(
dev
->
˛ass
 & 0x80) {

238 
ba£0
 = 0x1f0;

239 
ba£1
 = 0x3f4;

241 
ba£0
 = 0x170;

242 
ba£1
 = 0x374;

245 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
PCI_BASE_ADDRESS_0
,

246 
ba£0
 | 
PCI_BASE_ADDRESS_SPACE_IO
);

247 
	`pci_wrôe_c⁄fig_dw‹d
(
dev
, 
PCI_BASE_ADDRESS_1
,

248 
ba£1
 | 
PCI_BASE_ADDRESS_SPACE_IO
);

250 
dev
->
ªsour˚
[0].
°¨t
 = 0;

251 
dev
->
ªsour˚
[0].
íd
 = 0;

252 
dev
->
ªsour˚
[0].
Êags
 = 0;

254 
dev
->
ªsour˚
[1].
°¨t
 = 0;

255 
dev
->
ªsour˚
[1].
íd
 = 0;

256 
dev
->
ªsour˚
[1].
Êags
 = 0;

257 } i‡(
	`PCI_FUNC
(
dev
->
dev‚
) == 0) {

261 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x4b, 14);

262 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x4c, 15);

267 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x4d, 0x41);

272 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x44, 0x17);

277 
	`pci_wrôe_c⁄fig_byã
(
dev
, 0x45, 0x03);

279 
	}
}

280 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_CONTAQ
, 
PCI_DEVICE_ID_CONTAQ_82C693
, 
pci_fixup_cy82c693
);

282 
__devöô
 
	$pcibios_upd©e_úq
(
pci_dev
 *
dev
, 
úq
)

284 i‡(
debug_pci
)

285 
	`¥ötk
("PCI: Assignög IRQ %02dÅÿ%s\n", 
úq
, 
	`pci_«me
(
dev
));

286 
	`pci_wrôe_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, 
úq
);

287 
	}
}

293 
ölöe
 
	$pdev_bad_f‹_∑rôy
(
pci_dev
 *
dev
)

295  (
dev
->
víd‹
 =
PCI_VENDOR_ID_INTERG
 &&

296 (
dev
->
devi˚
 =
PCI_DEVICE_ID_INTERG_2000
 ||

297 
dev
->
devi˚
 =
PCI_DEVICE_ID_INTERG_2010
));

298 
	}
}

303 
__devöô


304 
	$pdev_fixup_devi˚_ªsour˚s
(
pci_sys_d©a
 *
roŸ
, 
pci_dev
 *
dev
)

306 
ªsour˚_size_t
 
off£t
;

307 
i
;

309 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

310 i‡(
dev
->
ªsour˚
[
i
].
°¨t
 == 0)

312 i‡(
dev
->
ªsour˚
[
i
].
Êags
 & 
IORESOURCE_MEM
)

313 
off£t
 = 
roŸ
->
mem_off£t
;

315 
off£t
 = 
roŸ
->
io_off£t
;

317 
dev
->
ªsour˚
[
i
].
°¨t
 +
off£t
;

318 
dev
->
ªsour˚
[
i
].
íd
 +
off£t
;

320 
	}
}

322 
__devöô


323 
	$pbus_assign_bus_ªsour˚s
(
pci_bus
 *
bus
, 
pci_sys_d©a
 *
roŸ
)

325 
pci_dev
 *
dev
 = 
bus
->
£lf
;

326 
i
;

328 i‡(!
dev
) {

332 
i
 = 0; i < 3; i++)

333 
bus
->
ªsour˚
[
i
] = 
roŸ
->resource[i];

335 
	}
}

341 
__devöô
 
	$pcibios_fixup_bus
(
pci_bus
 *
bus
)

343 
pci_sys_d©a
 *
roŸ
 = 
bus
->
sysd©a
;

344 
pci_dev
 *
dev
;

345 
u16
 
„©uªs
 = 
PCI_COMMAND_SERR
 | 
PCI_COMMAND_PARITY
 | 
PCI_COMMAND_FAST_BACK
;

347 
	`pbus_assign_bus_ªsour˚s
(
bus
, 
roŸ
);

353 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
) {

354 
u16
 
°©us
;

356 
	`pdev_fixup_devi˚_ªsour˚s
(
roŸ
, 
dev
);

358 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_STATUS
, &
°©us
);

366 i‡(!(
°©us
 & 
PCI_STATUS_FAST_BACK
))

367 
„©uªs
 &~
PCI_COMMAND_FAST_BACK
;

369 i‡(
	`pdev_bad_f‹_∑rôy
(
dev
))

370 
„©uªs
 &~(
PCI_COMMAND_SERR
 | 
PCI_COMMAND_PARITY
);

372 
dev
->
˛ass
 >> 8) {

373 
PCI_CLASS_BRIDGE_PCI
:

374 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_BRIDGE_CONTROL
, &
°©us
);

375 
°©us
 |
PCI_BRIDGE_CTL_PARITY
|
PCI_BRIDGE_CTL_MASTER_ABORT
;

376 
°©us
 &~(
PCI_BRIDGE_CTL_BUS_RESET
|
PCI_BRIDGE_CTL_FAST_BACK
);

377 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_BRIDGE_CONTROL
, 
°©us
);

380 
PCI_CLASS_BRIDGE_CARDBUS
:

381 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_CB_BRIDGE_CONTROL
, &
°©us
);

382 
°©us
 |
PCI_CB_BRIDGE_CTL_PARITY
|
PCI_CB_BRIDGE_CTL_MASTER_ABORT
;

383 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_CB_BRIDGE_CONTROL
, 
°©us
);

391 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
) {

392 
u16
 
cmd
;

394 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, &
cmd
);

395 
cmd
 |
„©uªs
;

396 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, 
cmd
);

398 
	`pci_wrôe_c⁄fig_byã
(
dev
, 
PCI_CACHE_LINE_SIZE
,

399 
L1_CACHE_BYTES
 >> 2);

405 i‡(
bus
->
£lf
 && bus->£lf->
hdr_ty≥
 =
PCI_HEADER_TYPE_BRIDGE
) {

406 i‡(
„©uªs
 & 
PCI_COMMAND_FAST_BACK
)

407 
bus
->
bridge_˘l
 |
PCI_BRIDGE_CTL_FAST_BACK
;

408 i‡(
„©uªs
 & 
PCI_COMMAND_PARITY
)

409 
bus
->
bridge_˘l
 |
PCI_BRIDGE_CTL_PARITY
;

415 
	`¥ötk
(
KERN_INFO
 "PCI: bus%d: Fast backÅo backÅransfers %sabled\n",

416 
bus
->
numbî
, (
„©uªs
 & 
PCI_COMMAND_FAST_BACK
) ? "en" : "dis");

417 
	}
}

422 
__devöô


423 
	$pcibios_ªsour˚_to_bus
(
pci_dev
 *
dev
, 
pci_bus_ªgi⁄
 *
ªgi⁄
,

424 
ªsour˚
 *
ªs
)

426 
pci_sys_d©a
 *
roŸ
 = 
dev
->
sysd©a
;

427 
off£t
 = 0;

429 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
)

430 
off£t
 = 
roŸ
->
io_off£t
;

431 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

432 
off£t
 = 
roŸ
->
mem_off£t
;

434 
ªgi⁄
->
°¨t
 = 
ªs
->°¨à- 
off£t
;

435 
ªgi⁄
->
íd
 = 
ªs
->íd - 
off£t
;

436 
	}
}

438 
__devöô


439 
	$pcibios_bus_to_ªsour˚
(
pci_dev
 *
dev
, 
ªsour˚
 *
ªs
,

440 
pci_bus_ªgi⁄
 *
ªgi⁄
)

442 
pci_sys_d©a
 *
roŸ
 = 
dev
->
sysd©a
;

443 
off£t
 = 0;

445 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
)

446 
off£t
 = 
roŸ
->
io_off£t
;

447 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

448 
off£t
 = 
roŸ
->
mem_off£t
;

450 
ªs
->
°¨t
 = 
ªgi⁄
->°¨à+ 
off£t
;

451 
ªs
->
íd
 = 
ªgi⁄
->íd + 
off£t
;

452 
	}
}

454 #ifde‡
CONFIG_HOTPLUG


455 
EXPORT_SYMBOL
(
pcibios_fixup_bus
);

456 
EXPORT_SYMBOL
(
pcibios_ªsour˚_to_bus
);

457 
EXPORT_SYMBOL
(
pcibios_bus_to_ªsour˚
);

470 
u8
 
__devöô
 
	$pci_°d_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

472 
pö
 = *
pöp
 - 1;

474 
dev
->
bus
->
£lf
) {

475 
pö
 = (pö + 
	`PCI_SLOT
(
dev
->
dev‚
)) & 3;

480 
dev
 = dev->
bus
->
£lf
;

482 *
pöp
 = 
pö
 + 1;

484  
	`PCI_SLOT
(
dev
->
dev‚
);

485 
	}
}

491 
u8
 
__devöô
 
	$pcibios_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pö
)

493 
pci_sys_d©a
 *
sys
 = 
dev
->
sysd©a
;

494 
¶Ÿ
 = 0, 
ﬁdpö
 = *
pö
;

496 i‡(
sys
->
swizzÀ
)

497 
¶Ÿ
 = 
sys
->
	`swizzÀ
(
dev
, 
pö
);

499 i‡(
debug_pci
)

500 
	`¥ötk
("PCI: %s swizzlingÖin %d =>Öin %d slot %d\n",

501 
	`pci_«me
(
dev
), 
ﬁdpö
, *
pö
, 
¶Ÿ
);

503  
¶Ÿ
;

504 
	}
}

509 
	$pcibios_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

511 
pci_sys_d©a
 *
sys
 = 
dev
->
sysd©a
;

512 
úq
 = -1;

514 i‡(
sys
->
m≠_úq
)

515 
úq
 = 
sys
->
	`m≠_úq
(
dev
, 
¶Ÿ
, 
pö
);

517 i‡(
debug_pci
)

518 
	`¥ötk
("PCI: %s mapping slot %dÖin %d => irq %d\n",

519 
	`pci_«me
(
dev
), 
¶Ÿ
, 
pö
, 
úq
);

521  
úq
;

522 
	}
}

524 
__öô
 
	$pcibios_öô_hw
(
hw_pci
 *
hw
)

526 
pci_sys_d©a
 *
sys
 = 
NULL
;

527 
ªt
;

528 
ƒ
, 
bu¢r
;

530 
ƒ
 = 
bu¢r
 = 0;Ç∏< 
hw
->
ƒ_c⁄åﬁÀrs
;Çr++) {

531 
sys
 = 
	`kzÆloc
((
pci_sys_d©a
), 
GFP_KERNEL
);

532 i‡(!
sys
)

533 
	`∑nic
("PCI: unableÅoállocate sys data!");

535 
sys
->
hw
 = hw;

536 
sys
->
bu¢r
 = busnr;

537 
sys
->
swizzÀ
 = 
hw
->swizzle;

538 
sys
->
m≠_úq
 = 
hw
->map_irq;

539 
sys
->
ªsour˚
[0] = &
i›‹t_ªsour˚
;

540 
sys
->
ªsour˚
[1] = &
iomem_ªsour˚
;

542 
ªt
 = 
hw
->
	`£tup
(
ƒ
, 
sys
);

544 i‡(
ªt
 > 0) {

545 
sys
->
bus
 = 
hw
->
	`sˇn
(
ƒ
, sys);

547 i‡(!
sys
->
bus
)

548 
	`∑nic
("PCI: unableÅo scan bus!");

550 
bu¢r
 = 
sys
->
bus
->
sub‹dö©e
 + 1;

552 
	`li°_add
(&
sys
->
node
, &
hw
->
bu£s
);

554 
	`k‰ì
(
sys
);

555 i‡(
ªt
 < 0)

559 
	}
}

561 
__öô
 
	$pci_comm⁄_öô
(
hw_pci
 *
hw
)

563 
pci_sys_d©a
 *
sys
;

565 
	`INIT_LIST_HEAD
(&
hw
->
bu£s
);

567 i‡(
hw
->
¥eöô
)

568 
hw
->
	`¥eöô
();

569 
	`pcibios_öô_hw
(
hw
);

570 i‡(
hw
->
po°öô
)

571 
hw
->
	`po°öô
();

573 
	`pci_fixup_úqs
(
pcibios_swizzÀ
, 
pcibios_m≠_úq
);

575 
	`li°_f‹_óch_íåy
(
sys
, &
hw
->
bu£s
, 
node
) {

576 
pci_bus
 *
bus
 = 
sys
->bus;

578 i‡(!
u£_fúmw¨e
) {

582 
	`pci_bus_size_bridges
(
bus
);

587 
	`pci_bus_assign_ªsour˚s
(
bus
);

593 
	`pci_bus_add_devi˚s
(
bus
);

595 
	}
}

597 * 
__öô
 
	$pcibios_£tup
(*
°r
)

599 i‡(!
	`°rcmp
(
°r
, "debug")) {

600 
debug_pci
 = 1;

601  
NULL
;

602 } i‡(!
	`°rcmp
(
°r
, "firmware")) {

603 
u£_fúmw¨e
 = 1;

604  
NULL
;

606  
°r
;

607 
	}
}

624 
	$pcibios_Æign_ªsour˚
(*
d©a
, 
ªsour˚
 *
ªs
,

625 
ªsour˚_size_t
 
size
,Ñesour˚_size_à
Æign
)

627 
ªsour˚_size_t
 
°¨t
 = 
ªs
->start;

629 i‡(
ªs
->
Êags
 & 
IORESOURCE_IO
 && 
°¨t
 & 0x300)

630 
°¨t
 = (start + 0x3ff) & ~0x3ff;

632 
ªs
->
°¨t
 = (°¨à+ 
Æign
 - 1) & ~(align - 1);

633 
	}
}

639 
	$pcibios_íabÀ_devi˚
(
pci_dev
 *
dev
, 
mask
)

641 
u16
 
cmd
, 
ﬁd_cmd
;

642 
idx
;

643 
ªsour˚
 *
r
;

645 
	`pci_ªad_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, &
cmd
);

646 
ﬁd_cmd
 = 
cmd
;

647 
idx
 = 0; idx < 6; idx++) {

649 i‡(!(
mask
 & (1 << 
idx
)))

652 
r
 = 
dev
->
ªsour˚
 + 
idx
;

653 i‡(!
r
->
°¨t
 &&Ñ->
íd
) {

654 
	`¥ötk
(
KERN_ERR
 "PCI: Device %sÇotávailable because"

655 " o‡ªsour˚ cﬁlisi⁄s\n", 
	`pci_«me
(
dev
));

656  -
EINVAL
;

658 i‡(
r
->
Êags
 & 
IORESOURCE_IO
)

659 
cmd
 |
PCI_COMMAND_IO
;

660 i‡(
r
->
Êags
 & 
IORESOURCE_MEM
)

661 
cmd
 |
PCI_COMMAND_MEMORY
;

667 i‡((
dev
->
˛ass
 >> 16Ë=
PCI_BASE_CLASS_BRIDGE
)

668 
cmd
 |
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
;

670 i‡(
cmd
 !
ﬁd_cmd
) {

671 
	`¥ötk
("PCI:Énabling device %s (%04x -> %04x)\n",

672 
	`pci_«me
(
dev
), 
ﬁd_cmd
, 
cmd
);

673 
	`pci_wrôe_c⁄fig_w‹d
(
dev
, 
PCI_COMMAND
, 
cmd
);

676 
	}
}

678 
	$pci_mm≠_∑ge_ønge
(
pci_dev
 *
dev
, 
vm_¨ó_°ru˘
 *
vma
,

679 
pci_mm≠_°©e
 
mm≠_°©e
, 
wrôe_comböe
)

681 
pci_sys_d©a
 *
roŸ
 = 
dev
->
sysd©a
;

682 
phys
;

684 i‡(
mm≠_°©e
 =
pci_mm≠_io
) {

685  -
EINVAL
;

687 
phys
 = 
vma
->
vm_pgoff
 + (
roŸ
->
mem_off£t
 >> 
PAGE_SHIFT
);

693 
vma
->
vm_∑ge_¥Ÿ
 = 
	`pg¥Ÿ_n⁄ˇched
(vma->vm_page_prot);

695 i‡(
	`ªm≠_p‚_ønge
(
vma
, vma->
vm_°¨t
, 
phys
,

696 
vma
->
vm_íd
 - vma->
vm_°¨t
,

697 
vma
->
vm_∑ge_¥Ÿ
))

698  -
EAGAIN
;

701 
	}
}

	@arch/arm/kernel/compat.c

18 
	~<löux/ty≥s.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/öô.h
>

23 
	~<asm/£tup.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/∑ge.h
>

27 
	~<asm/mach/¨ch.h
>

29 
	~"com∑t.h
"

42 
	s∑øm_°ru˘
 {

45 
	m∑ge_size
;

46 
	mƒ_∑ges
;

47 
	mømdisk_size
;

48 
	mÊags
;

49 
	#FLAG_READONLY
 1

	)

50 
	#FLAG_RDLOAD
 4

	)

51 
	#FLAG_RDPROMPT
 8

	)

52 
	mroŸdev
;

53 
	mvideo_num_cﬁs
;

54 
	mvideo_num_rows
;

55 
	mvideo_x
;

56 
	mvideo_y
;

57 
	mmemc_c⁄åﬁ_ªg
;

58 
	msounddeÁu…
;

59 
	madfsdrives
;

60 
	mbyãs_≥r_ch¨_h
;

61 
	mbyãs_≥r_ch¨_v
;

62 
	m∑ges_ö_b™k
[4];

63 
	m∑ges_ö_vøm
;

64 
	möôrd_°¨t
;

65 
	möôrd_size
;

66 
	mrd_°¨t
;

67 
	msy°em_ªv
;

68 
	msy°em_£rül_low
;

69 
	msy°em_£rül_high
;

70 
	mmem_f˛k_21285
;

71 } 
	ms
;

72 
	munu£d
[256];

73 } 
	mu1
;

75 
	m∑ths
[8][128];

77 
	mmagic
;

78 
	mn
[1024 - ()];

79 } 
	ms
;

80 } 
	mu2
;

81 
	mcomm™dlöe
[
COMMAND_LINE_SIZE
];

84 
èg
 * 
__öô
 
	$memèg
(
èg
 *èg, 
°¨t
, 
size
)

86 
èg
 = 
	`èg_√xt
(tag);

87 
èg
->
hdr
.èg = 
ATAG_MEM
;

88 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_mem32
);

89 
èg
->
u
.
mem
.
size
 = size;

90 
èg
->
u
.
mem
.
°¨t
 = start;

92  
èg
;

93 
	}
}

95 
__öô
 
	$buûd_èg_li°
(
∑øm_°ru˘
 *
∑øms
, *
ègli°
)

97 
èg
 *èg = 
ègli°
;

99 i‡(
∑øms
->
u1
.
s
.
∑ge_size
 !
PAGE_SIZE
) {

100 
	`¥ötk
(
KERN_WARNING
 "Warning: bad configurationÖage, "

105 
	`¥ötk
(
KERN_DEBUG
 "Converting old-styleÖaram structÅoÅaglist\n");

107 #ifde‡
CONFIG_ARCH_NETWINDER


108 i‡(
∑øms
->
u1
.
s
.
ƒ_∑ges
 != 0x02000 &&

109 
∑øms
->
u1
.
s
.
ƒ_∑ges
 != 0x04000 &&

110 
∑øms
->
u1
.
s
.
ƒ_∑ges
 != 0x08000 &&

111 
∑øms
->
u1
.
s
.
ƒ_∑ges
 != 0x10000) {

112 
	`¥ötk
(
KERN_WARNING
 "Warning: bad NeTTromÖarameters "

115 
∑øms
->
u1
.
s
.
ƒ_∑ges
 = 0x1000;

116 
∑øms
->
u1
.
s
.
ømdisk_size
 = 0;

117 
∑øms
->
u1
.
s
.
Êags
 = 
FLAG_READONLY
;

118 
∑øms
->
u1
.
s
.
öôrd_°¨t
 = 0;

119 
∑øms
->
u1
.
s
.
öôrd_size
 = 0;

120 
∑øms
->
u1
.
s
.
rd_°¨t
 = 0;

124 
èg
->
hdr
.èg = 
ATAG_CORE
;

125 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_c‹e
);

126 
èg
->
u
.
c‹e
.
Êags
 = 
∑øms
->
u1
.
s
.Êag†& 
FLAG_READONLY
;

127 
èg
->
u
.
c‹e
.
∑gesize
 = 
∑øms
->
u1
.
s
.
∑ge_size
;

128 
èg
->
u
.
c‹e
.
roŸdev
 = 
∑øms
->
u1
.
s
.rootdev;

130 
èg
 = 
	`èg_√xt
(tag);

131 
èg
->
hdr
.èg = 
ATAG_RAMDISK
;

132 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_ømdisk
);

133 
èg
->
u
.
ømdisk
.
Êags
 = (
∑øms
->
u1
.
s
.Êag†& 
FLAG_RDLOAD
 ? 1 : 0) |

134 (
∑øms
->
u1
.
s
.
Êags
 & 
FLAG_RDPROMPT
 ? 2 : 0);

135 
èg
->
u
.
ømdisk
.
size
 = 
∑øms
->
u1
.
s
.
ømdisk_size
;

136 
èg
->
u
.
ømdisk
.
°¨t
 = 
∑øms
->
u1
.
s
.
rd_°¨t
;

138 
èg
 = 
	`èg_√xt
(tag);

139 
èg
->
hdr
.èg = 
ATAG_INITRD
;

140 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_öôrd
);

141 
èg
->
u
.
öôrd
.
°¨t
 = 
∑øms
->
u1
.
s
.
öôrd_°¨t
;

142 
èg
->
u
.
öôrd
.
size
 = 
∑øms
->
u1
.
s
.
öôrd_size
;

144 
èg
 = 
	`èg_√xt
(tag);

145 
èg
->
hdr
.èg = 
ATAG_SERIAL
;

146 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_£rü r
);

147 
èg
->
u
.
£rü r
.
low
 = 
∑øms
->
u1
.
s
.
sy°em_£rül_low
;

148 
èg
->
u
.
£rü r
.
high
 = 
∑øms
->
u1
.
s
.
sy°em_£rül_high
;

150 
èg
 = 
	`èg_√xt
(tag);

151 
èg
->
hdr
.èg = 
ATAG_REVISION
;

152 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_ªvisi⁄
);

153 
èg
->
u
.
ªvisi⁄
.
ªv
 = 
∑øms
->
u1
.
s
.
sy°em_ªv
;

155 #ifde‡
CONFIG_ARCH_ACORN


156 i‡(
	`machöe_is_ris˝c
()) {

157 
i
;

158 
i
 = 0; i < 4; i++)

159 
èg
 = 
	`memèg
—ag, 
PHYS_OFFSET
 + (
i
 << 26),

160 
∑øms
->
u1
.
s
.
∑ges_ö_b™k
[
i
] * 
PAGE_SIZE
);

163 
èg
 = 
	`memèg
—ag, 
PHYS_OFFSET
, 
∑øms
->
u1
.
s
.
ƒ_∑ges
 * 
PAGE_SIZE
);

165 #ifde‡
CONFIG_FOOTBRIDGE


166 i‡(
∑øms
->
u1
.
s
.
mem_f˛k_21285
) {

167 
èg
 = 
	`èg_√xt
(tag);

168 
èg
->
hdr
.èg = 
ATAG_MEMCLK
;

169 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_mem˛k
);

170 
èg
->
u
.
mem˛k
.
fmem˛k
 = 
∑øms
->
u1
.
s
.
mem_f˛k_21285
;

174 #ifde‡
CONFIG_ARCH_EBSA285


175 i‡(
	`machöe_is_ebß285
()) {

176 
èg
 = 
	`èg_√xt
(tag);

177 
èg
->
hdr
.èg = 
ATAG_VIDEOTEXT
;

178 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_videŸext
);

179 
èg
->
u
.
videŸext
.
x
 = 
∑øms
->
u1
.
s
.
video_x
;

180 
èg
->
u
.
videŸext
.
y
 = 
∑øms
->
u1
.
s
.
video_y
;

181 
èg
->
u
.
videŸext
.
video_∑ge
 = 0;

182 
èg
->
u
.
videŸext
.
video_mode
 = 0;

183 
èg
->
u
.
videŸext
.
video_cﬁs
 = 
∑øms
->
u1
.
s
.
video_num_cﬁs
;

184 
èg
->
u
.
videŸext
.
video_ega_bx
 = 0;

185 
èg
->
u
.
videŸext
.
video_löes
 = 
∑øms
->
u1
.
s
.
video_num_rows
;

186 
èg
->
u
.
videŸext
.
video_isvga
 = 1;

187 
èg
->
u
.
videŸext
.
video_poöts
 = 8;

191 #ifde‡
CONFIG_ARCH_ACORN


192 
èg
 = 
	`èg_√xt
(tag);

193 
èg
->
hdr
.èg = 
ATAG_ACORN
;

194 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_ac‹n
);

195 
èg
->
u
.
ac‹n
.
memc_c⁄åﬁ_ªg
 = 
∑øms
->
u1
.
s
.memc_control_reg;

196 
èg
->
u
.
ac‹n
.
vøm_∑ges
 = 
∑øms
->
u1
.
s
.
∑ges_ö_vøm
;

197 
èg
->
u
.
ac‹n
.
sounddeÁu…
 = 
∑øms
->
u1
.
s
.sounddefault;

198 
èg
->
u
.
ac‹n
.
adfsdrives
 = 
∑øms
->
u1
.
s
.adfsdrives;

201 
èg
 = 
	`èg_√xt
(tag);

202 
èg
->
hdr
.èg = 
ATAG_CMDLINE
;

203 
èg
->
hdr
.
size
 = (
	`°æí
(
∑øms
->
comm™dlöe
) + 3 +

204 (
èg_hódî
)) >> 2;

205 
	`°r˝y
(
èg
->
u
.
cmdlöe
.cmdlöe, 
∑øms
->
comm™dlöe
);

207 
èg
 = 
	`èg_√xt
(tag);

208 
èg
->
hdr
.èg = 
ATAG_NONE
;

209 
èg
->
hdr
.
size
 = 0;

211 
	`memmove
(
∑øms
, 
ègli°
, (()
èg
) - (()taglist) +

212 (
èg_hódî
));

213 
	}
}

215 
__öô
 
	$c⁄vît_to_èg_li°
(
èg
 *
ègs
)

217 
∑øm_°ru˘
 *
∑øms
 = (∑øm_°ru˘ *)
ègs
;

218 
	`buûd_èg_li°
(
∑øms
, &∑øms->
u2
);

219 
	}
}

221 
__öô
 
	$squash_mem_ègs
(
èg
 *tag)

223 ; 
èg
->
hdr
.
size
;Åag = 
	`èg_√xt
(tag))

224 i‡(
èg
->
hdr
.èg =
ATAG_MEM
)

225 
èg
->
hdr
.èg = 
ATAG_NONE
;

226 
	}
}

	@arch/arm/kernel/compat.h

11 
c⁄vît_to_èg_li°
(
èg
 *
ègs
);

13 
squash_mem_ègs
(
èg
 *tag);

	@arch/arm/kernel/crunch.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sig«l.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öô.h
>

18 
	~<asm/¨ch/ï93xx-ªgs.h
>

19 
	~<asm/thªad_nŸify.h
>

20 
	~<asm/io.h
>

22 
¸unch_°©e
 *
	g¸unch_ow√r
;

24 
	$¸unch_èsk_ªÀa£
(
thªad_öfo
 *
thªad
)

26 
	`loˇl_úq_dißbÀ
();

27 i‡(
¸unch_ow√r
 =&
thªad
->
¸unch°©e
)

28 
¸unch_ow√r
 = 
NULL
;

29 
	`loˇl_úq_íabÀ
();

30 
	}
}

32 
	$¸unch_íabÀd
(
u32
 
devcfg
)

34  !!(
devcfg
 & 
EP93XX_SYSCON_DEVICE_CONFIG_CRUNCH_ENABLE
);

35 
	}
}

37 
	$¸unch_do
(
nŸifõr_block
 *
£lf
, 
cmd
, *
t
)

39 
thªad_öfo
 *
thªad
 = (thªad_öfÿ*)
t
;

40 
¸unch_°©e
 *crunch_state;

41 
u32
 
devcfg
;

43 
¸unch_°©e
 = &
thªad
->
¸unch°©e
;

45 
cmd
) {

46 
THREAD_NOTIFY_FLUSH
:

47 
	`mem£t
(
¸unch_°©e
, 0, (*crunch_state));

54 
THREAD_NOTIFY_RELEASE
:

55 
	`¸unch_èsk_ªÀa£
(
thªad
);

58 
THREAD_NOTIFY_SWITCH
:

59 
devcfg
 = 
	`__øw_ªadl
(
EP93XX_SYSCON_DEVICE_CONFIG
);

60 i‡(
	`¸unch_íabÀd
(
devcfg
Ë|| 
¸unch_ow√r
 =
¸unch_°©e
) {

61 
devcfg
 ^
EP93XX_SYSCON_DEVICE_CONFIG_CRUNCH_ENABLE
;

62 
	`__øw_wrôñ
(0xØ, 
EP93XX_SYSCON_SWLOCK
);

63 
	`__øw_wrôñ
(
devcfg
, 
EP93XX_SYSCON_DEVICE_CONFIG
);

68  
NOTIFY_DONE
;

69 
	}
}

71 
nŸifõr_block
 
	g¸unch_nŸifõr_block
 = {

72 .
nŸifõr_ˇŒ
 = 
¸unch_do
,

75 
__öô
 
	$¸unch_öô
()

77 
	`thªad_ªgi°î_nŸifõr
(&
¸unch_nŸifõr_block
);

78 
ñf_hwˇp
 |
HWCAP_CRUNCH
;

81 
	}
}

83 
œã_öôˇŒ
(
¸unch_öô
);

	@arch/arm/kernel/dma-isa.c

19 
	~<löux/i›‹t.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/dma-m≠pög.h
>

23 
	~<asm/dma.h
>

24 
	~<asm/io.h
>

26 
	~<asm/mach/dma.h
>

28 
	#ISA_DMA_MODE_READ
 0x44

	)

29 
	#ISA_DMA_MODE_WRITE
 0x48

	)

30 
	#ISA_DMA_MODE_CASCADE
 0xc0

	)

31 
	#ISA_DMA_AUTOINIT
 0x10

	)

33 
	#ISA_DMA_MASK
 0

	)

34 
	#ISA_DMA_MODE
 1

	)

35 
	#ISA_DMA_CLRFF
 2

	)

36 
	#ISA_DMA_PGHI
 3

	)

37 
	#ISA_DMA_PGLO
 4

	)

38 
	#ISA_DMA_ADDR
 5

	)

39 
	#ISA_DMA_COUNT
 6

	)

41 
	giß_dma_p‹t
[8][7] = {

53 
	$iß_gë_dma_ªsidue
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

55 
io_p‹t
 = 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_COUNT
];

56 
cou¡
;

58 
cou¡
 = 1 + 
	`öb
(
io_p‹t
);

59 
cou¡
 |
	`öb
(
io_p‹t
) << 8;

61  
ch™√l
 < 4 ? 
cou¡
 : (count << 1);

62 
	}
}

64 
	$iß_íabÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

66 i‡(
dma
->
övÆid
) {

67 
addªss
, 
Àngth
;

68 
mode
;

69 
dma_d©a_dúe˘i⁄
 
dúe˘i⁄
;

71 
mode
 = 
ch™√l
 & 3;

72 
dma
->
dma_mode
 & 
DMA_MODE_MASK
) {

73 
DMA_MODE_READ
:

74 
mode
 |
ISA_DMA_MODE_READ
;

75 
dúe˘i⁄
 = 
DMA_FROM_DEVICE
;

78 
DMA_MODE_WRITE
:

79 
mode
 |
ISA_DMA_MODE_WRITE
;

80 
dúe˘i⁄
 = 
DMA_TO_DEVICE
;

83 
DMA_MODE_CASCADE
:

84 
mode
 |
ISA_DMA_MODE_CASCADE
;

85 
dúe˘i⁄
 = 
DMA_BIDIRECTIONAL
;

89 
dúe˘i⁄
 = 
DMA_NONE
;

93 i‡(!
dma
->
sg
) {

98 
dma
->
sg
 = &dma->
buf
;

99 
dma
->
sgcou¡
 = 1;

100 
dma
->
buf
.
Àngth
 = dma->
cou¡
;

101 
dma
->
buf
.
dma_addªss
 = 
	`dma_m≠_sögÀ
(
NULL
,

102 
dma
->
addr
, dma->
cou¡
,

103 
dúe˘i⁄
);

106 
addªss
 = 
dma
->
buf
.
dma_addªss
;

107 
Àngth
 = 
dma
->
buf
.length - 1;

109 
	`outb
(
addªss
 >> 16, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_PGLO
]);

110 
	`outb
(
addªss
 >> 24, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_PGHI
]);

112 i‡(
ch™√l
 >= 4) {

113 
addªss
 >>= 1;

114 
Àngth
 >>= 1;

117 
	`outb
(0, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_CLRFF
]);

119 
	`outb
(
addªss
, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_ADDR
]);

120 
	`outb
(
addªss
 >> 8, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_ADDR
]);

122 
	`outb
(
Àngth
, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_COUNT
]);

123 
	`outb
(
Àngth
 >> 8, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_COUNT
]);

125 i‡(
dma
->
dma_mode
 & 
DMA_AUTOINIT
)

126 
mode
 |
ISA_DMA_AUTOINIT
;

128 
	`outb
(
mode
, 
iß_dma_p‹t
[
ch™√l
][
ISA_DMA_MODE
]);

129 
dma
->
övÆid
 = 0;

131 
	`outb
(
ch™√l
 & 3, 
iß_dma_p‹t
[ch™√l][
ISA_DMA_MASK
]);

132 
	}
}

134 
	$iß_dißbÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

136 
	`outb
(
ch™√l
 | 4, 
iß_dma_p‹t
[ch™√l][
ISA_DMA_MASK
]);

137 
	}
}

139 
dma_›s
 
	giß_dma_›s
 = {

140 .
ty≥
 = "ISA",

141 .
	gíabÀ
 = 
iß_íabÀ_dma
,

142 .
	gdißbÀ
 = 
iß_dißbÀ_dma
,

143 .
	gªsidue
 = 
iß_gë_dma_ªsidue
,

146 
ªsour˚
 
	gdma_ªsour˚s
[] = { {

147 .
«me
 = "dma1",

148 .
	g°¨t
 = 0x0000,

149 .
	gíd
 = 0x000f

151 .
	g«me
 = "dmaÜowÖage",

152 .
	g°¨t
 = 0x0080,

153 .
	gíd
 = 0x008f

155 .
	g«me
 = "dma2",

156 .
	g°¨t
 = 0x00c0,

157 .
	gíd
 = 0x00df

159 .
	g«me
 = "dma highÖage",

160 .
	g°¨t
 = 0x0480,

161 .
	gíd
 = 0x048f

164 
__öô
 
	$iß_öô_dma
(
dma_t
 *
dma
)

171 
	`outb
(0xff, 0x0d);

172 
	`outb
(0xff, 0xda);

178 
	`outb
(0x55, 0x00);

179 
	`outb
(0xaa, 0x00);

181 i‡(
	`öb
(0) == 0x55 && inb(0) == 0xaa) {

182 
ch™√l
, 
i
;

184 
ch™√l
 = 0; channel < 8; channel++) {

185 
dma
[
ch™√l
].
d_›s
 = &
iß_dma_›s
;

186 
	`iß_dißbÀ_dma
(
ch™√l
, 
NULL
);

189 
	`outb
(0x40, 0x0b);

190 
	`outb
(0x41, 0x0b);

191 
	`outb
(0x42, 0x0b);

192 
	`outb
(0x43, 0x0b);

194 
	`outb
(0xc0, 0xd6);

195 
	`outb
(0x41, 0xd6);

196 
	`outb
(0x42, 0xd6);

197 
	`outb
(0x43, 0xd6);

199 
	`outb
(0, 0xd4);

201 
	`outb
(0x10, 0x08);

202 
	`outb
(0x10, 0xd0);

209 
	`outb
(0x30, 0x40b);

210 
	`outb
(0x31, 0x40b);

211 
	`outb
(0x32, 0x40b);

212 
	`outb
(0x33, 0x40b);

213 
	`outb
(0x31, 0x4d6);

214 
	`outb
(0x32, 0x4d6);

215 
	`outb
(0x33, 0x4d6);

217 
	`ªque°_dma
(
DMA_ISA_CASCADE
, "cascade");

219 
i
 = 0; i < (
dma_ªsour˚s
) / (dma_resources[0]); i++)

220 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, 
dma_ªsour˚s
 + 
i
);

222 
	}
}

	@arch/arm/kernel/dma.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/•ölock.h
>

17 
	~<löux/î∫o.h
>

19 
	~<asm/dma.h
>

21 
	~<asm/mach/dma.h
>

23 
DEFINE_SPINLOCK
(
dma_•ö_lock
);

24 
EXPORT_SYMBOL
(
dma_•ö_lock
);

26 
dma_t
 
	gdma_ch™
[
MAX_DMA_CHANNELS
];

31 
	$gë_dma_li°
(*
buf
)

33 
dma_t
 *
dma
;

34 *
p
 = 
buf
;

35 
i
;

37 
i
 = 0, 
dma
 = 
dma_ch™
; i < 
MAX_DMA_CHANNELS
; i++, dma++)

38 i‡(
dma
->
lock
)

39 
p
 +
	`•rötf
’, "%2d: %14†%s\n", 
i
,

40 
dma
->
d_›s
->
ty≥
, dma->
devi˚_id
);

42  
p
 - 
buf
;

43 
	}
}

50 
	$ªque°_dma
(
dmach_t
 
ch™√l
, c⁄° *
devi˚_id
)

52 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

53 
ªt
;

55 i‡(
ch™√l
 >
MAX_DMA_CHANNELS
 || !
dma
->
d_›s
)

56 
bad_dma
;

58 i‡(
	`xchg
(&
dma
->
lock
, 1) != 0)

59 
busy
;

61 
dma
->
devi˚_id
 = device_id;

62 
dma
->
a˘ive
 = 0;

63 
dma
->
övÆid
 = 1;

65 
ªt
 = 0;

66 i‡(
dma
->
d_›s
->
ªque°
)

67 
ªt
 = 
dma
->
d_›s
->
	`ªque°
(
ch™√l
, dma);

69 i‡(
ªt
)

70 
	`xchg
(&
dma
->
lock
, 0);

72  
ªt
;

74 
bad_dma
:

75 
	`¥ötk
(
KERN_ERR
 "dma:ÅryögÅÿÆloˇã DMA%d\n", 
ch™√l
);

76  -
EINVAL
;

78 
busy
:

79  -
EBUSY
;

80 
	}
}

81 
EXPORT_SYMBOL
(
ªque°_dma
);

88 
	$‰ì_dma
(
dmach_t
 
ch™√l
)

90 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

92 i‡(
ch™√l
 >
MAX_DMA_CHANNELS
 || !
dma
->
d_›s
)

93 
bad_dma
;

95 i‡(
dma
->
a˘ive
) {

96 
	`¥ötk
(
KERN_ERR
 "dma%d: fªeögá˘ivêDMA\n", 
ch™√l
);

97 
dma
->
d_›s
->
	`dißbÀ
(
ch™√l
, dma);

98 
dma
->
a˘ive
 = 0;

101 i‡(
	`xchg
(&
dma
->
lock
, 0) != 0) {

102 i‡(
dma
->
d_›s
->
‰ì
)

103 
dma
->
d_›s
->
	`‰ì
(
ch™√l
, dma);

107 
	`¥ötk
(
KERN_ERR
 "dma%d:ÅryögÅÿ‰ì fªêDMA\n", 
ch™√l
);

110 
bad_dma
:

111 
	`¥ötk
(
KERN_ERR
 "dma:ÅryögÅÿ‰ì DMA%d\n", 
ch™√l
);

112 
	}
}

113 
EXPORT_SYMBOL
(
‰ì_dma
);

117 
	$£t_dma_sg
 (
dmach_t
 
ch™√l
, 
sˇâîli°
 *
sg
, 
ƒ_sg
)

119 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

121 i‡(
dma
->
a˘ive
)

122 
	`¥ötk
(
KERN_ERR
 "dma%d:áltering DMA SG while "

123 "DMAá˘ive\n", 
ch™√l
);

125 
dma
->
sg
 = sg;

126 
dma
->
sgcou¡
 = 
ƒ_sg
;

127 
dma
->
övÆid
 = 1;

128 
	}
}

129 
EXPORT_SYMBOL
(
£t_dma_sg
);

135 
	$__£t_dma_addr
 (
dmach_t
 
ch™√l
, *
addr
)

137 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

139 i‡(
dma
->
a˘ive
)

140 
	`¥ötk
(
KERN_ERR
 "dma%d:áltering DMAáddress while "

141 "DMAá˘ive\n", 
ch™√l
);

143 
dma
->
sg
 = 
NULL
;

144 
dma
->
addr
 =áddr;

145 
dma
->
övÆid
 = 1;

146 
	}
}

147 
EXPORT_SYMBOL
(
__£t_dma_addr
);

153 
	$£t_dma_cou¡
 (
dmach_t
 
ch™√l
, 
cou¡
)

155 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

157 i‡(
dma
->
a˘ive
)

158 
	`¥ötk
(
KERN_ERR
 "dma%d:áltering DMA count while "

159 "DMAá˘ive\n", 
ch™√l
);

161 
dma
->
sg
 = 
NULL
;

162 
dma
->
cou¡
 = count;

163 
dma
->
övÆid
 = 1;

164 
	}
}

165 
EXPORT_SYMBOL
(
£t_dma_cou¡
);

169 
	$£t_dma_mode
 (
dmach_t
 
ch™√l
, 
dmamode_t
 
mode
)

171 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

173 i‡(
dma
->
a˘ive
)

174 
	`¥ötk
(
KERN_ERR
 "dma%d:áltering DMA mode while "

175 "DMAá˘ive\n", 
ch™√l
);

177 
dma
->
dma_mode
 = 
mode
;

178 
dma
->
övÆid
 = 1;

179 
	}
}

180 
EXPORT_SYMBOL
(
£t_dma_mode
);

184 
	$íabÀ_dma
 (
dmach_t
 
ch™√l
)

186 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

188 i‡(!
dma
->
lock
)

189 
‰ì_dma
;

191 i‡(
dma
->
a˘ive
 == 0) {

192 
dma
->
a˘ive
 = 1;

193 
dma
->
d_›s
->
	`íabÀ
(
ch™√l
, dma);

197 
‰ì_dma
:

198 
	`¥ötk
(
KERN_ERR
 "dma%d:ÅryögÅÿíabÀ fªêDMA\n", 
ch™√l
);

199 
	`BUG
();

200 
	}
}

201 
EXPORT_SYMBOL
(
íabÀ_dma
);

205 
	$dißbÀ_dma
 (
dmach_t
 
ch™√l
)

207 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

209 i‡(!
dma
->
lock
)

210 
‰ì_dma
;

212 i‡(
dma
->
a˘ive
 == 1) {

213 
dma
->
a˘ive
 = 0;

214 
dma
->
d_›s
->
	`dißbÀ
(
ch™√l
, dma);

218 
‰ì_dma
:

219 
	`¥ötk
(
KERN_ERR
 "dma%d:ÅryögÅÿdißbÀ fªêDMA\n", 
ch™√l
);

220 
	`BUG
();

221 
	}
}

222 
EXPORT_SYMBOL
(
dißbÀ_dma
);

227 
	$dma_ch™√l_a˘ive
(
dmach_t
 
ch™√l
)

229  
dma_ch™
[
ch™√l
].
a˘ive
;

230 
	}
}

231 
EXPORT_SYMBOL
(
dma_ch™√l_a˘ive
);

233 
	$£t_dma_∑ge
(
dmach_t
 
ch™√l
, 
∑gír
)

235 
	`¥ötk
(
KERN_ERR
 "dma%d:ÅryögÅÿ£t_dma_∑ge\n", 
ch™√l
);

236 
	}
}

237 
EXPORT_SYMBOL
(
£t_dma_∑ge
);

239 
	$£t_dma_•ìd
(
dmach_t
 
ch™√l
, 
cy˛e_ns
)

241 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

242 
ªt
 = 0;

244 i‡(
dma
->
d_›s
->
£t•ìd
)

245 
ªt
 = 
dma
->
d_›s
->
	`£t•ìd
(
ch™√l
, dma, 
cy˛e_ns
);

246 
dma
->
•ìd
 = 
ªt
;

247 
	}
}

248 
EXPORT_SYMBOL
(
£t_dma_•ìd
);

250 
	$gë_dma_ªsidue
(
dmach_t
 
ch™√l
)

252 
dma_t
 *
dma
 = 
dma_ch™
 + 
ch™√l
;

253 
ªt
 = 0;

255 i‡(
dma
->
d_›s
->
ªsidue
)

256 
ªt
 = 
dma
->
d_›s
->
	`ªsidue
(
ch™√l
, dma);

258  
ªt
;

259 
	}
}

260 
EXPORT_SYMBOL
(
gë_dma_ªsidue
);

262 
__öô
 
	$öô_dma
()

264 
	`¨ch_dma_öô
(
dma_ch™
);

266 
	}
}

268 
c‹e_öôˇŒ
(
öô_dma
);

	@arch/arm/kernel/ecard.c

28 
	#ECARD_C


	)

30 
	~<löux/moduÀ.h
>

31 
	~<löux/kî√l.h
>

32 
	~<löux/ty≥s.h
>

33 
	~<löux/sched.h
>

34 
	~<löux/öãºu±.h
>

35 
	~<löux/com∂ëi⁄.h
>

36 
	~<löux/ªboŸ.h
>

37 
	~<löux/mm.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/¥oc_fs.h
>

40 
	~<löux/devi˚.h
>

41 
	~<löux/öô.h
>

42 
	~<löux/muãx.h
>

43 
	~<löux/kthªad.h
>

44 
	~<löux/io.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/eˇrd.h
>

48 
	~<asm/h¨dw¨e.h
>

49 
	~<asm/úq.h
>

50 
	~<asm/mmu_c⁄ãxt.h
>

51 
	~<asm/mach/úq.h
>

52 
	~<asm/ébÊush.h
>

54 
	~"eˇrd.h
"

56 #i‚de‡
CONFIG_ARCH_RPC


57 
	#HAVE_EXPMASK


	)

60 
	seˇrd_ªque°
 {

61 (*
	m‚
)(
	meˇrd_ªque°
 *);

62 
eˇrd_t
 *
	mec
;

63 
	maddªss
;

64 
	mÀngth
;

65 
	mu£_lﬂdî
;

66 *
	mbuf„r
;

67 
com∂ëi⁄
 *
	mcom∂ëe
;

70 
	sexpˇrd_bœckli°
 {

71 
	mm™uÁ˘uªr
;

72 
	m¥odu˘
;

73 c⁄° *
	mty≥
;

76 
eˇrd_t
 *
	gˇrds
;

77 
eˇrd_t
 *
	g¶Ÿ_to_expˇrd
[
MAX_ECARDS
];

78 
	ge˘¸
;

79 #ifde‡
HAS_EXPMASK


80 
	ghave_expmask
;

86 
expˇrd_bœckli°
 
__öôd©a
 
	gbœckli°
[] = {

87 { 
MANU_ACORN
, 
PROD_ACORN_ETHER1
, "Acorn Ether1" }

90 
asmlökage
 

91 
eˇrd_lﬂdî_ª£t
(
ba£
, 
lﬂdî_t
 
lﬂdî
);

92 
asmlökage
 

93 
eˇrd_lﬂdî_ªad
(
off
, 
ba£
, 
lﬂdî_t
 
lﬂdî
);

95 
ölöe
 
	$eˇrd_gëu16
(*
v
)

97  
v
[0] | v[1] << 8;

98 
	}
}

100 
ölöe
 sig√d 
	$eˇrd_gës24
(*
v
)

102  
v
[0] | v[1] << 8 | v[2] << 16 | ((v[2] & 0x80) ? 0xff000000 : 0);

103 
	}
}

105 
ölöe
 
eˇrd_t
 *
	$¶Ÿ_to_eˇrd
(
¶Ÿ
)

107  
¶Ÿ
 < 
MAX_ECARDS
 ? 
¶Ÿ_to_expˇrd
[¶Ÿ] : 
NULL
;

108 
	}
}

122 
	$eˇrd_èsk_ª£t
(
eˇrd_ªque°
 *
ªq
)

124 
ex∑nsi⁄_ˇrd
 *
ec
 = 
ªq
->ec;

125 
ªsour˚
 *
ªs
;

127 
ªs
 = 
ec
->
¶Ÿ_no
 == 8

128 ? &
ec
->
ªsour˚
[
ECARD_RES_MEMC
]

129 : 
ec
->
ósi


130 ? &
ec
->
ªsour˚
[
ECARD_RES_EASI
]

131 : &
ec
->
ªsour˚
[
ECARD_RES_IOCSYNC
];

133 
	`eˇrd_lﬂdî_ª£t
(
ªs
->
°¨t
, 
ec
->
lﬂdî
);

134 
	}
}

136 
	$eˇrd_èsk_ªadbyãs
(
eˇrd_ªque°
 *
ªq
)

138 
ex∑nsi⁄_ˇrd
 *
ec
 = 
ªq
->ec;

139 *
buf
 = 
ªq
->
buf„r
;

140 
Àn
 = 
ªq
->
Àngth
;

141 
off
 = 
ªq
->
addªss
;

143 i‡(
ec
->
¶Ÿ_no
 == 8) {

144 
__iomem
 *
ba£
 = (__iomem *)

145 
ec
->
ªsour˚
[
ECARD_RES_MEMC
].
°¨t
;

152 
ödex
;

153 
∑ge
;

155 
∑ge
 = (
off
 >> 12) * 4;

156 i‡(
∑ge
 > 256 * 4)

159 
off
 &= 4095;

165 i‡(
off
 =0 || 
ödex
 > off) {

166 
	`wrôeb
(0, 
ba£
);

167 
ödex
 = 0;

174 
ödex
 < 
off
) {

175 
	`ªadb
(
ba£
 + 
∑ge
);

176 
ödex
 += 1;

179 
Àn
--) {

180 *
buf
++ = 
	`ªadb
(
ba£
 + 
∑ge
);

181 
ödex
 += 1;

184 
ba£
 = (
ec
->
ósi


185 ? &
ec
->
ªsour˚
[
ECARD_RES_EASI
]

186 : &
ec
->
ªsour˚
[
ECARD_RES_IOCSYNC
])->
°¨t
;

187 
__iomem
 *
pba£
 = (__iomem *)
ba£
;

189 i‡(!
ªq
->
u£_lﬂdî
 || !
ec
->
lﬂdî
) {

190 
off
 *= 4;

191 
Àn
--) {

192 *
buf
++ = 
	`ªadb
(
pba£
 + 
off
);

193 
off
 += 4;

196 
Àn
--) {

202 *
buf
++ = 
	`eˇrd_lﬂdî_ªad
(
off
++, 
ba£
,

203 
ec
->
lﬂdî
);

208 
	}
}

210 
DECLARE_WAIT_QUEUE_HEAD
(
eˇrd_waô
);

211 
eˇrd_ªque°
 *
	geˇrd_ªq
;

212 
DEFINE_MUTEX
(
eˇrd_muãx
);

217 
	$eˇrd_öô_pgèbÀs
(
mm_°ru˘
 *
mm
)

219 
vm_¨ó_°ru˘
 
vma
;

232 
pgd_t
 *
§c_pgd
, *
d°_pgd
;

234 
§c_pgd
 = 
	`pgd_off£t
(
mm
, ()
IO_BASE
);

235 
d°_pgd
 = 
	`pgd_off£t
(
mm
, 
IO_START
);

237 
	`mem˝y
(
d°_pgd
, 
§c_pgd
, (
pgd_t
Ë* (
IO_SIZE
 / 
PGDIR_SIZE
));

239 
§c_pgd
 = 
	`pgd_off£t
(
mm
, 
EASI_BASE
);

240 
d°_pgd
 = 
	`pgd_off£t
(
mm
, 
EASI_START
);

242 
	`mem˝y
(
d°_pgd
, 
§c_pgd
, (
pgd_t
Ë* (
EASI_SIZE
 / 
PGDIR_SIZE
));

244 
vma
.
vm_mm
 = 
mm
;

246 
	`Êush_éb_ønge
(&
vma
, 
IO_START
, IO_START + 
IO_SIZE
);

247 
	`Êush_éb_ønge
(&
vma
, 
EASI_START
, EASI_START + 
EASI_SIZE
);

248 
	}
}

250 
	$eˇrd_öô_mm
()

252 
mm_°ru˘
 * 
mm
 = 
	`mm_Æloc
();

253 
mm_°ru˘
 *
a˘ive_mm
 = 
cuºít
->active_mm;

255 i‡(!
mm
)

256  -
ENOMEM
;

258 
cuºít
->
mm
 = mm;

259 
cuºít
->
a˘ive_mm
 = 
mm
;

260 
	`a˘iv©e_mm
(
a˘ive_mm
, 
mm
);

261 
	`mmdr›
(
a˘ive_mm
);

262 
	`eˇrd_öô_pgèbÀs
(
mm
);

264 
	}
}

267 
	$eˇrd_èsk
(* 
unu£d
)

275 i‡(
	`eˇrd_öô_mm
())

276 
	`∑nic
("kecardd: unableÅoálloc mm\n");

279 
eˇrd_ªque°
 *
ªq
;

281 
	`waô_evít_öãºu±ibÀ
(
eˇrd_waô
, 
eˇrd_ªq
 !
NULL
);

283 
ªq
 = 
	`xchg
(&
eˇrd_ªq
, 
NULL
);

284 i‡(
ªq
 !
NULL
) {

285 
ªq
->
	`‚
(req);

286 
	`com∂ëe
(
ªq
->
com∂ëe
);

289 
	}
}

297 
	$eˇrd_ˇŒ
(
eˇrd_ªque°
 *
ªq
)

299 
	`DECLARE_COMPLETION_ONSTACK
(
com∂ëi⁄
);

301 
ªq
->
com∂ëe
 = &
com∂ëi⁄
;

303 
	`muãx_lock
(&
eˇrd_muãx
);

304 
eˇrd_ªq
 = 
ªq
;

305 
	`wake_up
(&
eˇrd_waô
);

310 
	`waô_f‹_com∂ëi⁄
(&
com∂ëi⁄
);

311 
	`muãx_u∆ock
(&
eˇrd_muãx
);

312 
	}
}

317 
	$eˇrd_ªadbyãs
(*
addr
, 
eˇrd_t
 *
ec
, 
off
, 
Àn
, 
u£ld
)

319 
eˇrd_ªque°
 
ªq
;

321 
ªq
.
‚
 = 
eˇrd_èsk_ªadbyãs
;

322 
ªq
.
ec
 =Éc;

323 
ªq
.
addªss
 = 
off
;

324 
ªq
.
Àngth
 = 
Àn
;

325 
ªq
.
u£_lﬂdî
 = 
u£ld
;

326 
ªq
.
buf„r
 = 
addr
;

328 
	`eˇrd_ˇŒ
(&
ªq
);

329 
	}
}

331 
	$eˇrd_ªadchunk
(
ö_chunk_dú
 *
cd
, 
eˇrd_t
 *
ec
, 
id
, 
num
)

333 
ex_chunk_dú
 
excd
;

334 
ödex
 = 16;

335 
u£ld
 = 0;

337 i‡(!
ec
->
cid
.
cd
)

341 
	`eˇrd_ªadbyãs
(&
excd
, 
ec
, 
ödex
, 8, 
u£ld
);

342 
ödex
 += 8;

343 i‡(
	`c_id
(&
excd
) == 0) {

344 i‡(!
u£ld
 && 
ec
->
lﬂdî
) {

345 
u£ld
 = 1;

346 
ödex
 = 0;

351 i‡(
	`c_id
(&
excd
) == 0xf0) {

352 
ödex
 = 
	`c_°¨t
(&
excd
);

355 i‡(
	`c_id
(&
excd
) == 0x80) {

356 i‡(!
ec
->
lﬂdî
) {

357 
ec
->
lﬂdî
 = 
	`kmÆloc
(
	`c_Àn
(&
excd
),

358 
GFP_KERNEL
);

359 i‡(
ec
->
lﬂdî
)

360 
	`eˇrd_ªadbyãs
(
ec
->
lﬂdî
,Éc,

361 ()
	`c_°¨t
(&
excd
),

362 
	`c_Àn
(&
excd
), 
u£ld
);

368 i‡(
	`c_id
(&
excd
Ë=
id
 && 
num
-- == 0)

372 i‡(
	`c_id
(&
excd
) & 0x80) {

373 
	`c_id
(&
excd
) & 0x70) {

375 
	`eˇrd_ªadbyãs
((*)
excd
.
d
.
°rög
, 
ec
,

376 ()
	`c_°¨t
(&
excd
), 
	`c_Àn
(&excd),

377 
u£ld
);

383 
cd
->
°¨t_off£t
 = 
	`c_°¨t
(&
excd
);

384 
	`mem˝y
(
cd
->
d
.
°rög
, 
excd
.d.string, 256);

386 
	}
}

390 
	$eˇrd_def_úq_íabÀ
(
eˇrd_t
 *
ec
, 
úqƒ
)

392 #ifde‡
HAS_EXPMASK


393 i‡(
úqƒ
 < 4 && 
have_expmask
) {

394 
have_expmask
 |1 << 
úqƒ
;

395 
	`__øw_wrôeb
(
have_expmask
, 
EXPMASK_ENABLE
);

398 
	}
}

400 
	$eˇrd_def_úq_dißbÀ
(
eˇrd_t
 *
ec
, 
úqƒ
)

402 #ifde‡
HAS_EXPMASK


403 i‡(
úqƒ
 < 4 && 
have_expmask
) {

404 
have_expmask
 &~(1 << 
úqƒ
);

405 
	`__øw_wrôeb
(
have_expmask
, 
EXPMASK_ENABLE
);

408 
	}
}

410 
	$eˇrd_def_úq_≥ndög
(
eˇrd_t
 *
ec
)

412  !
ec
->
úqmask
 || 
	`ªadb
”c->
úqaddr
) &Éc->irqmask;

413 
	}
}

415 
	$eˇrd_def_fiq_íabÀ
(
eˇrd_t
 *
ec
, 
fiqƒ
)

417 
	`∑nic
("ecard_def_fiq_enable called - impossible");

418 
	}
}

420 
	$eˇrd_def_fiq_dißbÀ
(
eˇrd_t
 *
ec
, 
fiqƒ
)

422 
	`∑nic
("ecard_def_fiq_disable called - impossible");

423 
	}
}

425 
	$eˇrd_def_fiq_≥ndög
(
eˇrd_t
 *
ec
)

427  !
ec
->
fiqmask
 || 
	`ªadb
”c->
fiqaddr
) &Éc->fiqmask;

428 
	}
}

430 
ex∑nsi⁄ˇrd_›s_t
 
	geˇrd_deÁu…_›s
 = {

431 
eˇrd_def_úq_íabÀ
,

432 
eˇrd_def_úq_dißbÀ
,

433 
eˇrd_def_úq_≥ndög
,

434 
eˇrd_def_fiq_íabÀ
,

435 
eˇrd_def_fiq_dißbÀ
,

436 
eˇrd_def_fiq_≥ndög


445 
	$eˇrd_úq_unmask
(
úqƒ
)

447 
eˇrd_t
 *
ec
 = 
	`¶Ÿ_to_eˇrd
(
úqƒ
 - 32);

449 i‡(
ec
) {

450 i‡(!
ec
->
›s
)

451 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

453 i‡(
ec
->
˛aimed
 &&Éc->
›s
->
úqíabÀ
)

454 
ec
->
›s
->
	`úqíabÀ
”c, 
úqƒ
);

456 
	`¥ötk
(
KERN_ERR
 "ecard:ÑejectingÑequestÅo "

457 "íabÀ IRQ†f‹ %d\n", 
úqƒ
);

459 
	}
}

461 
	$eˇrd_úq_mask
(
úqƒ
)

463 
eˇrd_t
 *
ec
 = 
	`¶Ÿ_to_eˇrd
(
úqƒ
 - 32);

465 i‡(
ec
) {

466 i‡(!
ec
->
›s
)

467 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

469 i‡(
ec
->
›s
 &&Éc->›s->
úqdißbÀ
)

470 
ec
->
›s
->
	`úqdißbÀ
”c, 
úqƒ
);

472 
	}
}

474 
úq_chù
 
	geˇrd_chù
 = {

475 .
«me
 = "ECARD",

476 .
	gack
 = 
eˇrd_úq_mask
,

477 .
	gmask
 = 
eˇrd_úq_mask
,

478 .
	gunmask
 = 
eˇrd_úq_unmask
,

481 
	$eˇrd_íabÀfiq
(
fiqƒ
)

483 
eˇrd_t
 *
ec
 = 
	`¶Ÿ_to_eˇrd
(
fiqƒ
);

485 i‡(
ec
) {

486 i‡(!
ec
->
›s
)

487 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

489 i‡(
ec
->
˛aimed
 &&Éc->
›s
->
fiqíabÀ
)

490 
ec
->
›s
->
	`fiqíabÀ
”c, 
fiqƒ
);

492 
	`¥ötk
(
KERN_ERR
 "ecard:ÑejectingÑequestÅo "

493 "íabÀ FIQ†f‹ %d\n", 
fiqƒ
);

495 
	}
}

497 
	$eˇrd_dißbÀfiq
(
fiqƒ
)

499 
eˇrd_t
 *
ec
 = 
	`¶Ÿ_to_eˇrd
(
fiqƒ
);

501 i‡(
ec
) {

502 i‡(!
ec
->
›s
)

503 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

505 i‡(
ec
->
›s
->
fiqdißbÀ
)

506 
ec
->
›s
->
	`fiqdißbÀ
”c, 
fiqƒ
);

508 
	}
}

510 
	$eˇrd_dump_úq_°©e
()

512 
eˇrd_t
 *
ec
;

514 
	`¥ötk
("Expansion card IRQ state:\n");

516 
ec
 = 
ˇrds
;Éc;É¯ec->
√xt
) {

517 i‡(
ec
->
¶Ÿ_no
 == 8)

520 
	`¥ötk
(" %d: %sclaimed, ",

521 
ec
->
¶Ÿ_no
,Éc->
˛aimed
 ? "" : "not ");

523 i‡(
ec
->
›s
 &&Éc->›s->
úq≥ndög
 &&

524 
ec
->
›s
 !&
eˇrd_deÁu…_›s
)

525 
	`¥ötk
("irq %spending\n",

526 
ec
->
›s
->
	`úq≥ndög
(ec) ? "" : "not ");

528 
	`¥ötk
("irqaddr %p, mask = %02X, status = %02X\n",

529 
ec
->
úqaddr
,Éc->
úqmask
, 
	`ªadb
(ec->irqaddr));

531 
	}
}

533 
	$eˇrd_check_lockup
(
úq_desc
 *
desc
)

535 
œ°
;

536 
lockup
;

547 i‡(
œ°
 =
jiffõs
) {

548 
lockup
 += 1;

549 i‡(
lockup
 > 1000000) {

550 
	`¥ötk
(
KERN_ERR
 "\nInterruptÜockup detected - "

553 
desc
->
chù
->
	`mask
(
IRQ_EXPANSIONCARD
);

554 
	`eˇrd_dump_úq_°©e
();

557 
lockup
 = 0;

563 i‡(!
œ°
 || 
	`time_a·î
(
jiffõs
,Üa° + 5*
HZ
)) {

564 
œ°
 = 
jiffõs
;

565 
	`¥ötk
(
KERN_WARNING
 "Unrecognised interrupt from backplane\n");

566 
	`eˇrd_dump_úq_°©e
();

568 
	}
}

571 
	$eˇrd_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

573 
eˇrd_t
 *
ec
;

574 
ˇŒed
 = 0;

576 
desc
->
chù
->
	`mask
(
úq
);

577 
ec
 = 
ˇrds
;Éc;É¯ec->
√xt
) {

578 
≥ndög
;

580 i‡(!
ec
->
˛aimed
 ||Éc->
úq
 =
NO_IRQ
 ||Éc->
¶Ÿ_no
 == 8)

583 i‡(
ec
->
›s
 &&Éc->›s->
úq≥ndög
)

584 
≥ndög
 = 
ec
->
›s
->
	`úq≥ndög
(ec);

586 
≥ndög
 = 
eˇrd_deÁu…_›s
.
	`úq≥ndög
(
ec
);

588 i‡(
≥ndög
) {

589 
úq_desc
 *
d
 = irq_des¯+ 
ec
->
úq
;

590 
	`desc_h™dÀ_úq
(
ec
->
úq
, 
d
);

591 
ˇŒed
 ++;

594 
desc
->
chù
->
	`unmask
(
úq
);

596 i‡(
ˇŒed
 == 0)

597 
	`eˇrd_check_lockup
(
desc
);

598 
	}
}

600 #ifde‡
HAS_EXPMASK


601 
	g¥i‹ôy_masks
[] =

606 
	gfú°_£t
[] =

613 
	$eˇrd_úqexp_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

615 c⁄° 
°©usmask
 = 15;

616 
°©us
;

618 
°©us
 = 
	`__øw_ªadb
(
EXPMASK_STATUS
Ë& 
°©usmask
;

619 i‡(
°©us
) {

620 
¶Ÿ
 = 
fú°_£t
[
°©us
];

621 
eˇrd_t
 *
ec
 = 
	`¶Ÿ_to_eˇrd
(
¶Ÿ
);

623 i‡(
ec
->
˛aimed
) {

624 
úq_desc
 *
d
 = irq_des¯+ 
ec
->
úq
;

637 
	`desc_h™dÀ_úq
(
ec
->
úq
, 
d
);

639 
	`¥ötk
(
KERN_WARNING
 "card%d: interrupt from unclaimed "

640 "ˇrd???\n", 
¶Ÿ
);

641 
have_expmask
 &~(1 << 
¶Ÿ
);

642 
	`__øw_wrôeb
(
have_expmask
, 
EXPMASK_ENABLE
);

645 
	`¥ötk
(
KERN_WARNING
 "Wild interrupt from backplane (masks)\n");

646 
	}
}

648 
__öô
 
	$eˇrd_¥obeúqhw
()

650 
eˇrd_t
 *
ec
;

651 
found
;

653 
	`__øw_wrôeb
(0x00, 
EXPMASK_ENABLE
);

654 
	`__øw_wrôeb
(0xff, 
EXPMASK_STATUS
);

655 
found
 = (
	`__øw_ªadb
(
EXPMASK_STATUS
) & 15) == 0;

656 
	`__øw_wrôeb
(0xff, 
EXPMASK_ENABLE
);

658 i‡(
found
) {

659 
	`¥ötk
(
KERN_DEBUG
 "Expansion card interrupt "

663 
have_expmask
 = 0x80000000;

665 
ec
 = 
ˇrds
;Éc;É¯ec->
√xt
)

666 
have_expmask
 |1 << 
ec
->
¶Ÿ_no
;

668 
	`__øw_wrôeb
(
have_expmask
, 
EXPMASK_ENABLE
);

671  
found
;

672 
	}
}

674 
	#eˇrd_úqexp_h™dÀr
 
NULL


	)

675 
	#eˇrd_¥obeúqhw
(Ë(0)

	)

678 #i‚de‡
IO_EC_MEMC8_BASE


679 
	#IO_EC_MEMC8_BASE
 0

	)

682 
	$__eˇrd_addªss
(
eˇrd_t
 *
ec
, 
ˇrd_ty≥_t
 
ty≥
, 
ˇrd_•ìd_t
 
•ìd
)

684 
addªss
 = 0;

685 
¶Ÿ
 = 
ec
->
¶Ÿ_no
;

687 i‡(
ec
->
¶Ÿ_no
 == 8)

688  
IO_EC_MEMC8_BASE
;

690 
e˘¸
 &~(1 << 
¶Ÿ
);

692 
ty≥
) {

693 
ECARD_MEMC
:

694 i‡(
¶Ÿ
 < 4)

695 
addªss
 = 
IO_EC_MEMC_BASE
 + (
¶Ÿ
 << 12);

698 
ECARD_IOC
:

699 i‡(
¶Ÿ
 < 4)

700 
addªss
 = 
IO_EC_IOC_BASE
 + (
¶Ÿ
 << 12);

701 #ifde‡
IO_EC_IOC4_BASE


703 
addªss
 = 
IO_EC_IOC4_BASE
 + ((
¶Ÿ
 - 4) << 12);

705 i‡(
addªss
)

706 
addªss
 +
•ìd
 << 17;

709 #ifde‡
IO_EC_EASI_BASE


710 
ECARD_EASI
:

711 
addªss
 = 
IO_EC_EASI_BASE
 + (
¶Ÿ
 << 22);

712 i‡(
•ìd
 =
ECARD_FAST
)

713 
e˘¸
 |1 << 
¶Ÿ
;

720 #ifde‡
IOMD_ECTCR


721 
	`iomd_wrôeb
(
e˘¸
, 
IOMD_ECTCR
);

723  
addªss
;

724 
	}
}

726 
	$eˇrd_¥öts
(*
buf„r
, 
eˇrd_t
 *
ec
)

728 *
°¨t
 = 
buf„r
;

730 
buf„r
 +
	`•rötf
(buf„r, " %d: %†", 
ec
->
¶Ÿ_no
,

731 
ec
->
ósi
 ? "EASI" : " ");

733 i‡(
ec
->
cid
.
id
 == 0) {

734 
ö_chunk_dú
 
öcd
;

736 
buf„r
 +
	`•rötf
(buffer, "[%04X:%04X] ",

737 
ec
->
cid
.
m™uÁ˘uªr
,Éc->cid.
¥odu˘
);

739 i‡(!
ec
->
ˇrd_desc
 &&Éc->
cid
.
cd
 &&

740 
	`eˇrd_ªadchunk
(&
öcd
, 
ec
, 0xf5, 0)) {

741 
ec
->
ˇrd_desc
 = 
	`kmÆloc
(
	`°æí
(
öcd
.
d
.
°rög
)+1, 
GFP_KERNEL
);

743 i‡(
ec
->
ˇrd_desc
)

744 
	`°r˝y
((*)
ec
->
ˇrd_desc
, 
öcd
.
d
.
°rög
);

747 
buf„r
 +
	`•rötf
(buf„r, "%s\n", 
ec
->
ˇrd_desc
 ?Éc->card_desc : "*unknown*");

749 
buf„r
 +
	`•rötf
(buf„r, "Sim∂êˇrd %d\n", 
ec
->
cid
.
id
);

751  
buf„r
 - 
°¨t
;

752 
	}
}

754 
	$gë_eˇrd_dev_öfo
(*
buf
, **
°¨t
, 
off_t
 
pos
, 
cou¡
)

756 
eˇrd_t
 *
ec
 = 
ˇrds
;

757 
off_t
 
©
 = 0;

758 
Àn
, 
˙t
;

760 
˙t
 = 0;

761 
ec
 && 
cou¡
 > 
˙t
) {

762 
Àn
 = 
	`eˇrd_¥öts
(
buf
, 
ec
);

763 
©
 +
Àn
;

764 i‡(
©
 >
pos
) {

765 i‡(!*
°¨t
) {

766 *
°¨t
 = 
buf
 + (
pos
 - (
©
 - 
Àn
));

767 
˙t
 = 
©
 - 
pos
;

769 
˙t
 +
Àn
;

770 
buf
 +
Àn
;

772 
ec
 =Éc->
√xt
;

774  (
cou¡
 > 
˙t
) ? cnt : count;

775 
	}
}

777 
¥oc_dú_íåy
 *
	g¥oc_bus_eˇrd_dú
 = 
NULL
;

779 
	$eˇrd_¥oc_öô
()

781 
¥oc_bus_eˇrd_dú
 = 
	`¥oc_mkdú
("eˇrd", 
¥oc_bus
);

782 
	`¸óã_¥oc_öfo_íåy
("devi˚s", 0, 
¥oc_bus_eˇrd_dú
,

783 
gë_eˇrd_dev_öfo
);

784 
	}
}

786 
	#ec_£t_ªsour˚
(
ec
,
ƒ
,
°
,
sz
) \

788 (
ec
)->
ªsour˚
[
ƒ
].
«me
 =Éc->
dev
.
bus_id
; \

789 (
ec
)->
ªsour˚
[
ƒ
].
°¨t
 = 
°
; \

790 (
ec
)->
ªsour˚
[
ƒ
].
íd
 = (
°
Ë+ (
sz
) - 1; \

791 (
ec
)->
ªsour˚
[
ƒ
].
Êags
 = 
IORESOURCE_MEM
; \

792 } 0)

	)

794 
__öô
 
	$eˇrd_‰ì_ˇrd
(
ex∑nsi⁄_ˇrd
 *
ec
)

796 
i
;

798 
i
 = 0; i < 
ECARD_NUM_RESOURCES
; i++)

799 i‡(
ec
->
ªsour˚
[
i
].
Êags
)

800 
	`ªÀa£_ªsour˚
(&
ec
->
ªsour˚
[
i
]);

802 
	`k‰ì
(
ec
);

803 
	}
}

805 
ex∑nsi⁄_ˇrd
 *
__öô
 
	$eˇrd_Æloc_ˇrd
(
ty≥
, 
¶Ÿ
)

807 
ex∑nsi⁄_ˇrd
 *
ec
;

808 
ba£
;

809 
i
;

811 
ec
 = 
	`kzÆloc
((
eˇrd_t
), 
GFP_KERNEL
);

812 i‡(!
ec
) {

813 
ec
 = 
	`ERR_PTR
(-
ENOMEM
);

814 
nomem
;

817 
ec
->
¶Ÿ_no
 = 
¶Ÿ
;

818 
ec
->
ósi
 = 
ty≥
 =
ECARD_EASI
;

819 
ec
->
úq
 = 
NO_IRQ
;

820 
ec
->
fiq
 = 
NO_IRQ
;

821 
ec
->
dma
 = 
NO_DMA
;

822 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

824 
	`¢¥ötf
(
ec
->
dev
.
bus_id
, ”c->dev.bus_id), "eˇrd%d", 
¶Ÿ
);

825 
ec
->
dev
.
∑ª¡
 = 
NULL
;

826 
ec
->
dev
.
bus
 = &
eˇrd_bus_ty≥
;

827 
ec
->
dev
.
dma_mask
 = &ec->dma_mask;

828 
ec
->
dma_mask
 = (
u64
)0xffffffff;

829 
ec
->
dev
.
cohîít_dma_mask
 =Éc->
dma_mask
;

831 i‡(
¶Ÿ
 < 4) {

832 
	`ec_£t_ªsour˚
(
ec
, 
ECARD_RES_MEMC
,

833 
PODSLOT_MEMC_BASE
 + (
¶Ÿ
 << 14),

834 
PODSLOT_MEMC_SIZE
);

835 
ba£
 = 
PODSLOT_IOC0_BASE
 + (
¶Ÿ
 << 14);

837 
ba£
 = 
PODSLOT_IOC4_BASE
 + ((
¶Ÿ
 - 4) << 14);

839 #ifde‡
CONFIG_ARCH_RPC


840 i‡(
¶Ÿ
 < 8) {

841 
	`ec_£t_ªsour˚
(
ec
, 
ECARD_RES_EASI
,

842 
PODSLOT_EASI_BASE
 + (
¶Ÿ
 << 24),

843 
PODSLOT_EASI_SIZE
);

846 i‡(
¶Ÿ
 == 8) {

847 
	`ec_£t_ªsour˚
(
ec
, 
ECARD_RES_MEMC
, 
NETSLOT_BASE
, 
NETSLOT_SIZE
);

851 
i
 = 0; i <
ECARD_RES_IOCSYNC
 - 
ECARD_RES_IOCSLOW
; i++)

852 
	`ec_£t_ªsour˚
(
ec
, 
i
 + 
ECARD_RES_IOCSLOW
,

853 
ba£
 + (
i
 << 19), 
PODSLOT_IOC_SIZE
);

855 
i
 = 0; i < 
ECARD_NUM_RESOURCES
; i++) {

856 i‡(
ec
->
ªsour˚
[
i
].
Êags
 &&

857 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
ec
->
ªsour˚
[
i
])) {

858 
	`¥ötk
(
KERN_ERR
 "%s:Ñesource(s)Çotávailable\n",

859 
ec
->
dev
.
bus_id
);

860 
ec
->
ªsour˚
[
i
].
íd
 -ec->ªsour˚[i].
°¨t
;

861 
ec
->
ªsour˚
[
i
].
°¨t
 = 0;

862 
ec
->
ªsour˚
[
i
].
Êags
 = 0;

866 
nomem
:

867  
ec
;

868 
	}
}

870 
ssize_t
 
	$eˇrd_show_úq
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

872 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

873  
	`•rötf
(
buf
, "%u\n", 
ec
->
úq
);

874 
	}
}

876 
ssize_t
 
	$eˇrd_show_dma
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

878 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

879  
	`•rötf
(
buf
, "%u\n", 
ec
->
dma
);

880 
	}
}

882 
ssize_t
 
	$eˇrd_show_ªsour˚s
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

884 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

885 *
°r
 = 
buf
;

886 
i
;

888 
i
 = 0; i < 
ECARD_NUM_RESOURCES
; i++)

889 
°r
 +
	`•rötf
(str, "%08x %08x %08lx\n",

890 
ec
->
ªsour˚
[
i
].
°¨t
,

891 
ec
->
ªsour˚
[
i
].
íd
,

892 
ec
->
ªsour˚
[
i
].
Êags
);

894  
°r
 - 
buf
;

895 
	}
}

897 
ssize_t
 
	$eˇrd_show_víd‹
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

899 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

900  
	`•rötf
(
buf
, "%u\n", 
ec
->
cid
.
m™uÁ˘uªr
);

901 
	}
}

903 
ssize_t
 
	$eˇrd_show_devi˚
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

905 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

906  
	`•rötf
(
buf
, "%u\n", 
ec
->
cid
.
¥odu˘
);

907 
	}
}

909 
ssize_t
 
	$eˇrd_show_ty≥
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

911 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

912  
	`•rötf
(
buf
, "%s\n", 
ec
->
ósi
 ? "EASI" : "IOC");

913 
	}
}

915 
devi˚_©åibuã
 
	geˇrd_dev_©ås
[] = {

916 
__ATTR
(
devi˚
, 
S_IRUGO
, 
eˇrd_show_devi˚
, 
NULL
),

917 
__ATTR
(
dma
, 
S_IRUGO
, 
eˇrd_show_dma
, 
NULL
),

918 
__ATTR
(
úq
, 
S_IRUGO
, 
eˇrd_show_úq
, 
NULL
),

919 
__ATTR
(
ªsour˚
, 
S_IRUGO
, 
eˇrd_show_ªsour˚s
, 
NULL
),

920 
__ATTR
(
ty≥
, 
S_IRUGO
, 
eˇrd_show_ty≥
, 
NULL
),

921 
__ATTR
(
víd‹
, 
S_IRUGO
, 
eˇrd_show_víd‹
, 
NULL
),

922 
__ATTR_NULL
,

926 
	$eˇrd_ªque°_ªsour˚s
(
ex∑nsi⁄_ˇrd
 *
ec
)

928 
i
, 
îr
 = 0;

930 
i
 = 0; i < 
ECARD_NUM_RESOURCES
; i++) {

931 i‡(
	`eˇrd_ªsour˚_íd
(
ec
, 
i
) &&

932 !
	`ªque°_mem_ªgi⁄
(
	`eˇrd_ªsour˚_°¨t
(
ec
, 
i
),

933 
	`eˇrd_ªsour˚_Àn
(
ec
, 
i
),

934 
ec
->
dev
.
drivî
->
«me
)) {

935 
îr
 = -
EBUSY
;

940 i‡(
îr
) {

941 
i
--)

942 i‡(
	`eˇrd_ªsour˚_íd
(
ec
, 
i
))

943 
	`ªÀa£_mem_ªgi⁄
(
	`eˇrd_ªsour˚_°¨t
(
ec
, 
i
),

944 
	`eˇrd_ªsour˚_Àn
(
ec
, 
i
));

946  
îr
;

947 
	}
}

948 
EXPORT_SYMBOL
(
eˇrd_ªque°_ªsour˚s
);

950 
	$eˇrd_ªÀa£_ªsour˚s
(
ex∑nsi⁄_ˇrd
 *
ec
)

952 
i
;

954 
i
 = 0; i < 
ECARD_NUM_RESOURCES
; i++)

955 i‡(
	`eˇrd_ªsour˚_íd
(
ec
, 
i
))

956 
	`ªÀa£_mem_ªgi⁄
(
	`eˇrd_ªsour˚_°¨t
(
ec
, 
i
),

957 
	`eˇrd_ªsour˚_Àn
(
ec
, 
i
));

958 
	}
}

959 
EXPORT_SYMBOL
(
eˇrd_ªÀa£_ªsour˚s
);

961 
	$eˇrd_£túq
(
ex∑nsi⁄_ˇrd
 *
ec
, c⁄° 
ex∑nsi⁄_ˇrd_›s
 *
›s
, *
úq_d©a
)

963 
ec
->
úq_d©a
 = irq_data;

964 
	`b¨rõr
();

965 
ec
->
›s
 = ops;

966 
	}
}

967 
EXPORT_SYMBOL
(
eˇrd_£túq
);

969 
__iomem
 *
	$eˇrdm_iom≠
(
ex∑nsi⁄_ˇrd
 *
ec
, 
ªs
,

970 
off£t
, 
maxsize
)

972 
°¨t
 = 
	`eˇrd_ªsour˚_°¨t
(
ec
, 
ªs
);

973 
íd
 = 
	`eˇrd_ªsour˚_íd
(
ec
, 
ªs
);

975 i‡(
off£t
 > (
íd
 - 
°¨t
))

976  
NULL
;

978 
°¨t
 +
off£t
;

979 i‡(
maxsize
 && 
íd
 - 
°¨t
 > maxsize)

980 
íd
 = 
°¨t
 + 
maxsize
;

982  
	`devm_i‹em≠
(&
ec
->
dev
, 
°¨t
, 
íd
 - start);

983 
	}
}

984 
EXPORT_SYMBOL
(
eˇrdm_iom≠
);

992 
__öô


993 
	$eˇrd_¥obe
(
¶Ÿ
, 
ˇrd_ty≥_t
 
ty≥
)

995 
eˇrd_t
 **
e˝
;

996 
eˇrd_t
 *
ec
;

997 
ex_ecid
 
cid
;

998 
i
, 
rc
;

1000 
ec
 = 
	`eˇrd_Æloc_ˇrd
(
ty≥
, 
¶Ÿ
);

1001 i‡(
	`IS_ERR
(
ec
)) {

1002 
rc
 = 
	`PTR_ERR
(
ec
);

1003 
nomem
;

1006 
rc
 = -
ENODEV
;

1007 i‡((
ec
->
podaddr
 = 
	`eˇrd_addªss
”c, 
ty≥
, 
ECARD_SYNC
)) == 0)

1008 
nodev
;

1010 
cid
.
r_zîo
 = 1;

1011 
	`eˇrd_ªadbyãs
(&
cid
, 
ec
, 0, 16, 0);

1012 i‡(
cid
.
r_zîo
)

1013 
nodev
;

1015 
ec
->
cid
.
id
 = cid.
r_id
;

1016 
ec
->
cid
.
cd
 = cid.
r_cd
;

1017 
ec
->
cid
.
is
 = cid.
r_is
;

1018 
ec
->
cid
.
w
 = cid.
r_w
;

1019 
ec
->
cid
.
m™uÁ˘uªr
 = 
	`eˇrd_gëu16
(cid.
r_m™u
);

1020 
ec
->
cid
.
¥odu˘
 = 
	`eˇrd_gëu16
(cid.
r_¥od
);

1021 
ec
->
cid
.
cou¡ry
 = cid.
r_cou¡ry
;

1022 
ec
->
cid
.
úqmask
 = cid.
r_úqmask
;

1023 
ec
->
cid
.
úqoff
 = 
	`eˇrd_gës24
(cid.
r_úqoff
);

1024 
ec
->
cid
.
fiqmask
 = cid.
r_fiqmask
;

1025 
ec
->
cid
.
fiqoff
 = 
	`eˇrd_gës24
(cid.
r_fiqoff
);

1026 
ec
->
fiqaddr
 =

1027 
ec
->
úqaddr
 = (
__iomem
 *)
	`iﬂddr
”c->
podaddr
);

1029 i‡(
ec
->
cid
.
is
) {

1030 
ec
->
úqmask
 =Éc->
cid
.irqmask;

1031 
ec
->
úqaddr
 +ec->
cid
.
úqoff
;

1032 
ec
->
fiqmask
 =Éc->
cid
.fiqmask;

1033 
ec
->
fiqaddr
 +ec->
cid
.
fiqoff
;

1035 
ec
->
úqmask
 = 1;

1036 
ec
->
fiqmask
 = 4;

1039 
i
 = 0; i < 
	`ARRAY_SIZE
(
bœckli°
); i++)

1040 i‡(
bœckli°
[
i
].
m™uÁ˘uªr
 =
ec
->
cid
.manufacturer &&

1041 
bœckli°
[
i
].
¥odu˘
 =
ec
->
cid
.product) {

1042 
ec
->
ˇrd_desc
 = 
bœckli°
[
i
].
ty≥
;

1049 i‡(
¶Ÿ
 < 8) {

1050 
ec
->
úq
 = 32 + 
¶Ÿ
;

1051 
	`£t_úq_chù
(
ec
->
úq
, &
eˇrd_chù
);

1052 
	`£t_úq_h™dÀr
(
ec
->
úq
, 
h™dÀ_Àvñ_úq
);

1053 
	`£t_úq_Êags
(
ec
->
úq
, 
IRQF_VALID
);

1056 #ifde‡
IO_EC_MEMC8_BASE


1057 i‡(
¶Ÿ
 == 8)

1058 
ec
->
úq
 = 11;

1060 #ifde‡
CONFIG_ARCH_RPC


1062 i‡(
¶Ÿ
 < 2)

1063 
ec
->
dma
 = 2 + 
¶Ÿ
;

1066 
e˝
 = &
ˇrds
; *e˝;É˝ = &(*e˝)->
√xt
);

1068 *
e˝
 = 
ec
;

1069 
¶Ÿ_to_expˇrd
[
¶Ÿ
] = 
ec
;

1071 
	`devi˚_ªgi°î
(&
ec
->
dev
);

1075 
nodev
:

1076 
	`eˇrd_‰ì_ˇrd
(
ec
);

1077 
nomem
:

1078  
rc
;

1079 
	}
}

1086 
__öô
 
	$eˇrd_öô
()

1088 
èsk_°ru˘
 *
èsk
;

1089 
¶Ÿ
, 
úqhw
;

1091 
èsk
 = 
	`kthªad_run
(
eˇrd_èsk
, 
NULL
, "kecardd");

1092 i‡(
	`IS_ERR
(
èsk
)) {

1093 
	`¥ötk
(
KERN_ERR
 "Ecard: unableÅo create kernelÅhread: %ld\n",

1094 
	`PTR_ERR
(
èsk
));

1095  
	`PTR_ERR
(
èsk
);

1098 
	`¥ötk
("ProbingÉxpansion cards\n");

1100 
¶Ÿ
 = 0; slot < 8; slot ++) {

1101 i‡(
	`eˇrd_¥obe
(
¶Ÿ
, 
ECARD_EASI
Ë=-
ENODEV
)

1102 
	`eˇrd_¥obe
(
¶Ÿ
, 
ECARD_IOC
);

1105 #ifde‡
IO_EC_MEMC8_BASE


1106 
	`eˇrd_¥obe
(8, 
ECARD_IOC
);

1109 
úqhw
 = 
	`eˇrd_¥obeúqhw
();

1111 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EXPANSIONCARD
,

1112 
úqhw
 ? 
eˇrd_úqexp_h™dÀr
 : 
eˇrd_úq_h™dÀr
);

1114 
	`eˇrd_¥oc_öô
();

1117 
	}
}

1119 
subsys_öôˇŒ
(
eˇrd_öô
);

1124 c⁄° 
eˇrd_id
 *

1125 
	$eˇrd_m©ch_devi˚
(c⁄° 
eˇrd_id
 *
ids
, 
ex∑nsi⁄_ˇrd
 *
ec
)

1127 
i
;

1129 
i
 = 0; 
ids
[i].
m™uÁ˘uªr
 != 65535; i++)

1130 i‡(
ec
->
cid
.
m™uÁ˘uªr
 =
ids
[
i
].manufacturer &&

1131 
ec
->
cid
.
¥odu˘
 =
ids
[
i
].product)

1132  
ids
 + 
i
;

1134  
NULL
;

1135 
	}
}

1137 
	$eˇrd_drv_¥obe
(
devi˚
 *
dev
)

1139 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

1140 
eˇrd_drivî
 *
drv
 = 
	`ECARD_DRV
(
dev
->
drivî
);

1141 c⁄° 
eˇrd_id
 *
id
;

1142 
ªt
;

1144 
id
 = 
	`eˇrd_m©ch_devi˚
(
drv
->
id_èbÀ
, 
ec
);

1146 
	`eˇrd_˛aim
(
ec
);

1147 
ªt
 = 
drv
->
	`¥obe
(
ec
, 
id
);

1148 i‡(
ªt
)

1149 
	`eˇrd_ªÀa£
(
ec
);

1150  
ªt
;

1151 
	}
}

1153 
	$eˇrd_drv_ªmove
(
devi˚
 *
dev
)

1155 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

1156 
eˇrd_drivî
 *
drv
 = 
	`ECARD_DRV
(
dev
->
drivî
);

1158 
drv
->
	`ªmove
(
ec
);

1159 
	`eˇrd_ªÀa£
(
ec
);

1165 
ec
->
›s
 = &
eˇrd_deÁu…_›s
;

1166 
	`b¨rõr
();

1167 
ec
->
úq_d©a
 = 
NULL
;

1170 
	}
}

1178 
	$eˇrd_drv_shutdown
(
devi˚
 *
dev
)

1180 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
dev
);

1181 
eˇrd_drivî
 *
drv
 = 
	`ECARD_DRV
(
dev
->
drivî
);

1182 
eˇrd_ªque°
 
ªq
;

1184 i‡(
dev
->
drivî
) {

1185 i‡(
drv
->
shutdown
)

1186 
drv
->
	`shutdown
(
ec
);

1187 
	`eˇrd_ªÀa£
(
ec
);

1193 i‡(
ec
->
lﬂdî
) {

1194 
ªq
.
‚
 = 
eˇrd_èsk_ª£t
;

1195 
ªq
.
ec
 =Éc;

1196 
	`eˇrd_ˇŒ
(&
ªq
);

1198 
	}
}

1200 
	$eˇrd_ªgi°î_drivî
(
eˇrd_drivî
 *
drv
)

1202 
drv
->drv.
bus
 = &
eˇrd_bus_ty≥
;

1204  
	`drivî_ªgi°î
(&
drv
->drv);

1205 
	}
}

1207 
	$eˇrd_ªmove_drivî
(
eˇrd_drivî
 *
drv
)

1209 
	`drivî_uƒegi°î
(&
drv
->drv);

1210 
	}
}

1212 
	$eˇrd_m©ch
(
devi˚
 *
_dev
, 
devi˚_drivî
 *
_drv
)

1214 
ex∑nsi⁄_ˇrd
 *
ec
 = 
	`ECARD_DEV
(
_dev
);

1215 
eˇrd_drivî
 *
drv
 = 
	`ECARD_DRV
(
_drv
);

1216 
ªt
;

1218 i‡(
drv
->
id_èbÀ
) {

1219 
ªt
 = 
	`eˇrd_m©ch_devi˚
(
drv
->
id_èbÀ
, 
ec
Ë!
NULL
;

1221 
ªt
 = 
ec
->
cid
.
id
 =
drv
->id;

1224  
ªt
;

1225 
	}
}

1227 
bus_ty≥
 
	geˇrd_bus_ty≥
 = {

1228 .
«me
 = "ecard",

1229 .
	gdev_©ås
 = 
eˇrd_dev_©ås
,

1230 .
	gm©ch
 = 
eˇrd_m©ch
,

1231 .
	g¥obe
 = 
eˇrd_drv_¥obe
,

1232 .
	gªmove
 = 
eˇrd_drv_ªmove
,

1233 .
	gshutdown
 = 
eˇrd_drv_shutdown
,

1236 
	$eˇrd_bus_öô
()

1238  
	`bus_ªgi°î
(&
eˇrd_bus_ty≥
);

1239 
	}
}

1241 
po°c‹e_öôˇŒ
(
eˇrd_bus_öô
);

1243 
EXPORT_SYMBOL
(
eˇrd_ªadchunk
);

1244 
EXPORT_SYMBOL
(
__eˇrd_addªss
);

1245 
EXPORT_SYMBOL
(
eˇrd_ªgi°î_drivî
);

1246 
EXPORT_SYMBOL
(
eˇrd_ªmove_drivî
);

1247 
EXPORT_SYMBOL
(
eˇrd_bus_ty≥
);

	@arch/arm/kernel/ecard.h

15 
	sex_ecid
 {

16 
	mr_úq
:1;

17 
	mr_zîo
:1;

18 
	mr_fiq
:1;

19 
	mr_id
:4;

20 
	mr_a
:1;

22 
	mr_cd
:1;

23 
	mr_is
:1;

24 
	mr_w
:2;

25 
	mr_r1
:4;

27 
	mr_r2
:8;

29 
	mr_¥od
[2];

31 
	mr_m™u
[2];

33 
	mr_cou¡ry
;

35 
	mr_fiqmask
;

36 
	mr_fiqoff
[3];

38 
	mr_úqmask
;

39 
	mr_úqoff
[3];

45 
	sex_chunk_dú
 {

46 
	mr_id
;

47 
	mr_Àn
[3];

48 
	mr_°¨t
;

50 
	m°rög
[256];

51 
	md©a
[1];

52 } 
	md
;

53 
	#c_id
(
x
Ë((x)->
r_id
)

	)

54 
	#c_Àn
(
x
Ë((x)->
r_Àn
[0]|((x)->r_Àn[1]<<8)|((x)->r_Àn[2]<<16))

	)

55 
	#c_°¨t
(
x
Ë((x)->
r_°¨t
)

	)

	@arch/arm/kernel/fiq.c

38 
	~<löux/moduÀ.h
>

39 
	~<löux/kî√l.h
>

40 
	~<löux/öô.h
>

41 
	~<löux/öãºu±.h
>

42 
	~<löux/£q_fûe.h
>

44 
	~<asm/ˇcheÊush.h
>

45 
	~<asm/fiq.h
>

46 
	~<asm/úq.h
>

47 
	~<asm/sy°em.h
>

48 
	~<asm/uac˚ss.h
>

50 
	gno_fiq_ö¢
;

56 
	$fiq_def_›
(*
ªf
, 
ªlöquish
)

58 i‡(!
ªlöquish
)

59 
	`£t_fiq_h™dÀr
(&
no_fiq_ö¢
, (no_fiq_insn));

62 
	}
}

64 
fiq_h™dÀr
 
	gdeÁu…_ow√r
 = {

65 .
«me
 = "default",

66 .
	gfiq_›
 = 
fiq_def_›
,

69 
fiq_h™dÀr
 *
	gcuºít_fiq
 = &
deÁu…_ow√r
;

71 
	$show_fiq_li°
(
£q_fûe
 *
p
, *
v
)

73 i‡(
cuºít_fiq
 !&
deÁu…_ow√r
)

74 
	`£q_¥ötf
(
p
, "FIQ: %s\n", 
cuºít_fiq
->
«me
);

77 
	}
}

79 
	$£t_fiq_h™dÀr
(*
°¨t
, 
Àngth
)

81 
	`mem˝y
((*)0xffff001c, 
°¨t
, 
Àngth
);

82 
	`Êush_iˇche_ønge
(0xffff001c, 0xffff001¯+ 
Àngth
);

83 i‡(!
	`ve˘‹s_high
())

84 
	`Êush_iˇche_ønge
(0x1c, 0x1¯+ 
Àngth
);

85 
	}
}

92 
__©åibuã__
((
«ked
)Ë
	$£t_fiq_ªgs
(
±_ªgs
 *
ªgs
)

94 
tmp
;

95 
asm
 volatile (

106 : "=&r" (
tmp
)

107 : "r" (&
ªgs
->
ARM_r8
), "I" (
PSR_I_BIT
 | 
PSR_F_BIT
 | 
FIQ_MODE
));

108 
	}
}

110 
__©åibuã__
((
«ked
)Ë
	$gë_fiq_ªgs
(
±_ªgs
 *
ªgs
)

112 
tmp
;

113 
asm
 volatile (

124 : "=&r" (
tmp
)

125 : "r" (&
ªgs
->
ARM_r8
), "I" (
PSR_I_BIT
 | 
PSR_F_BIT
 | 
FIQ_MODE
));

126 
	}
}

128 
	$˛aim_fiq
(
fiq_h™dÀr
 *
f
)

130 
ªt
 = 0;

132 i‡(
cuºít_fiq
) {

133 
ªt
 = -
EBUSY
;

135 i‡(
cuºít_fiq
->
fiq_›
 !
NULL
)

136 
ªt
 = 
cuºít_fiq
->
	`fiq_›
(cuºít_fiq->
dev_id
, 1);

139 i‡(!
ªt
) {

140 
f
->
√xt
 = 
cuºít_fiq
;

141 
cuºít_fiq
 = 
f
;

144  
ªt
;

145 
	}
}

147 
	$ªÀa£_fiq
(
fiq_h™dÀr
 *
f
)

149 i‡(
cuºít_fiq
 !
f
) {

150 
	`¥ötk
(
KERN_ERR
 "%s FIQÅryingÅoÑelease %s FIQ\n",

151 
f
->
«me
, 
cuºít_fiq
->name);

152 
	`dump_°ack
();

157 
cuºít_fiq
 = cuºít_fiq->
√xt
;

158 
cuºít_fiq
->
	`fiq_›
(cuºít_fiq->
dev_id
, 0));

159 
	}
}

161 
	$íabÀ_fiq
(
fiq
)

163 
	`íabÀ_úq
(
fiq
 + 
FIQ_START
);

164 
	}
}

166 
	$dißbÀ_fiq
(
fiq
)

168 
	`dißbÀ_úq
(
fiq
 + 
FIQ_START
);

169 
	}
}

171 
EXPORT_SYMBOL
(
£t_fiq_h™dÀr
);

172 
EXPORT_SYMBOL
(
£t_fiq_ªgs
);

173 
EXPORT_SYMBOL
(
gë_fiq_ªgs
);

174 
EXPORT_SYMBOL
(
˛aim_fiq
);

175 
EXPORT_SYMBOL
(
ªÀa£_fiq
);

176 
EXPORT_SYMBOL
(
íabÀ_fiq
);

177 
EXPORT_SYMBOL
(
dißbÀ_fiq
);

179 
__öô
 
	$öô_FIQ
()

181 
no_fiq_ö¢
 = *(*)0xffff001c;

182 
	}
}

	@arch/arm/kernel/init_task.c

4 
	~<löux/mm.h
>

5 
	~<löux/moduÀ.h
>

6 
	~<löux/fs.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/öô_èsk.h
>

10 
	~<löux/mqueue.h
>

12 
	~<asm/uac˚ss.h
>

13 
	~<asm/pgèbÀ.h
>

15 
fs_°ru˘
 
	göô_fs
 = 
INIT_FS
;

16 
fûes_°ru˘
 
	göô_fûes
 = 
INIT_FILES
;

17 
sig«l_°ru˘
 
	göô_sig«ls
 = 
INIT_SIGNALS
(
öô_sig«ls
);

18 
sigh™d_°ru˘
 
	göô_sigh™d
 = 
INIT_SIGHAND
(
öô_sigh™d
);

19 
mm_°ru˘
 
	göô_mm
 = 
INIT_MM
(
öô_mm
);

21 
EXPORT_SYMBOL
(
öô_mm
);

33 
thªad_uni⁄
 
öô_thªad_uni⁄


34 
__©åibuã__
((
__£˘i⁄__
(".data.init_task"))) =

35 { 
INIT_THREAD_INFO
(
öô_èsk
) };

42 
èsk_°ru˘
 
	göô_èsk
 = 
INIT_TASK
(
öô_èsk
);

44 
EXPORT_SYMBOL
(
öô_èsk
);

	@arch/arm/kernel/io.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/ty≥s.h
>

4 
	~<asm/io.h
>

10 
	$_mem˝y_‰omio
(*
to
, c⁄° vﬁ©ûê
__iomem
 *
‰om
, 
size_t
 
cou¡
)

12 *
t
 = 
to
;

13 
cou¡
) {

14 
cou¡
--;

15 *
t
 = 
	`ªadb
(
‰om
);

16 
t
++;

17 
‰om
++;

19 
	}
}

25 
	$_mem˝y_toio
(vﬁ©ûê
__iomem
 *
to
, c⁄° *
‰om
, 
size_t
 
cou¡
)

27 c⁄° *
f
 = 
‰om
;

28 
cou¡
) {

29 
cou¡
--;

30 
	`wrôeb
(*
f
, 
to
);

31 
f
++;

32 
to
++;

34 
	}
}

40 
	$_mem£t_io
(vﬁ©ûê
__iomem
 *
d°
, 
c
, 
size_t
 
cou¡
)

42 
cou¡
) {

43 
cou¡
--;

44 
	`wrôeb
(
c
, 
d°
);

45 
d°
++;

47 
	}
}

49 
EXPORT_SYMBOL
(
_mem˝y_‰omio
);

50 
EXPORT_SYMBOL
(
_mem˝y_toio
);

51 
EXPORT_SYMBOL
(
_mem£t_io
);

	@arch/arm/kernel/irq.c

24 
	~<löux/kî√l_°©.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/sig«l.h
>

27 
	~<löux/i›‹t.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/úq.h
>

30 
	~<löux/¶ab.h
>

31 
	~<löux/øndom.h
>

32 
	~<löux/smp.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/î∫o.h
>

36 
	~<löux/li°.h
>

37 
	~<löux/kÆlsyms.h
>

38 
	~<löux/¥oc_fs.h
>

40 
	~<asm/sy°em.h
>

41 
	~<asm/mach/time.h
>

46 #i‚de‡
úq_föish


47 
	#úq_föish
(
úq
Ëdÿ{ } 0)

	)

50 (*
öô_¨ch_úq
)(Ë
__öôd©a
 = 
NULL
;

51 
úq_îr_cou¡
;

53 
	$show_öãºu±s
(
£q_fûe
 *
p
, *
v
)

55 
i
 = *(
loff_t
 *Ë
v
, 
˝u
;

56 
úqa˘i⁄
 * 
a˘i⁄
;

57 
Êags
;

59 i‡(
i
 == 0) {

60 
˝u«me
[12];

62 
	`£q_¥ötf
(
p
, " ");

63 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

64 
	`•rötf
(
˝u«me
, "CPU%d", 
˝u
);

65 
	`£q_¥ötf
(
p
, " %10s", 
˝u«me
);

67 
	`£q_putc
(
p
, '\n');

70 i‡(
i
 < 
NR_IRQS
) {

71 
	`•ö_lock_úqßve
(&
úq_desc
[
i
].
lock
, 
Êags
);

72 
a˘i⁄
 = 
úq_desc
[
i
].action;

73 i‡(!
a˘i⁄
)

74 
u∆ock
;

76 
	`£q_¥ötf
(
p
, "%3d: ", 
i
);

77 
	`f‹_óch_¥e£¡_˝u
(
˝u
)

78 
	`£q_¥ötf
(
p
, "%10u ", 
	`k°©_˝u
(
˝u
).
úqs
[
i
]);

79 
	`£q_¥ötf
(
p
, " %10s", 
úq_desc
[
i
].
chù
->
«me
 ? : "-");

80 
	`£q_¥ötf
(
p
, " %s", 
a˘i⁄
->
«me
);

81 
a˘i⁄
 =á˘i⁄->
√xt
;áction;áction =áction->next)

82 
	`£q_¥ötf
(
p
, ", %s", 
a˘i⁄
->
«me
);

84 
	`£q_putc
(
p
, '\n');

85 
u∆ock
:

86 
	`•ö_u∆ock_úqª°‹e
(&
úq_desc
[
i
].
lock
, 
Êags
);

87 } i‡(
i
 =
NR_IRQS
) {

88 #ifde‡
CONFIG_ARCH_ACORN


89 
	`show_fiq_li°
(
p
, 
v
);

91 #ifde‡
CONFIG_SMP


92 
	`show_ùi_li°
(
p
);

93 
	`show_loˇl_úqs
(
p
);

95 
	`£q_¥ötf
(
p
, "Eº: %10lu\n", 
úq_îr_cou¡
);

98 
	}
}

101 
úq_desc
 
	gbad_úq_desc
 = {

102 .
h™dÀ_úq
 = 
h™dÀ_bad_úq
,

103 .
	glock
 = 
SPIN_LOCK_UNLOCKED


111 
asmlökage
 
__ex˚±i⁄
 
	$asm_do_IRQ
(
úq
, 
±_ªgs
 *
ªgs
)

113 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

114 
úq_desc
 *
desc
 = irq_des¯+ 
úq
;

120 i‡(
úq
 >
NR_IRQS
)

121 
desc
 = &
bad_úq_desc
;

123 
	`úq_íãr
();

125 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

128 
	`úq_föish
(
úq
);

130 
	`úq_exô
();

131 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

132 
	}
}

134 
	$£t_úq_Êags
(
úq
, 
iÊags
)

136 
úq_desc
 *
desc
;

137 
Êags
;

139 i‡(
úq
 >
NR_IRQS
) {

140 
	`¥ötk
(
KERN_ERR
 "TryögÅÿ£àúq fœg†f‹ IRQ%d\n", 
úq
);

144 
desc
 = 
úq_desc
 + 
úq
;

145 
	`•ö_lock_úqßve
(&
desc
->
lock
, 
Êags
);

146 
desc
->
°©us
 |
IRQ_NOREQUEST
 | 
IRQ_NOPROBE
 | 
IRQ_NOAUTOEN
;

147 i‡(
iÊags
 & 
IRQF_VALID
)

148 
desc
->
°©us
 &~
IRQ_NOREQUEST
;

149 i‡(
iÊags
 & 
IRQF_PROBE
)

150 
desc
->
°©us
 &~
IRQ_NOPROBE
;

151 i‡(!(
iÊags
 & 
IRQF_NOAUTOEN
))

152 
desc
->
°©us
 &~
IRQ_NOAUTOEN
;

153 
	`•ö_u∆ock_úqª°‹e
(&
desc
->
lock
, 
Êags
);

154 
	}
}

156 
__öô
 
	$öô_IRQ
()

158 
úq
;

160 
úq
 = 0; irq < 
NR_IRQS
; irq++)

161 
úq_desc
[
úq
].
°©us
 |
IRQ_NOREQUEST
 | 
IRQ_NOPROBE
;

163 #ifde‡
CONFIG_SMP


164 
bad_úq_desc
.
afföôy
 = 
CPU_MASK_ALL
;

165 
bad_úq_desc
.
˝u
 = 
	`smp_¥o˚ss‹_id
();

167 
	`öô_¨ch_úq
();

168 
	}
}

170 #ifde‡
CONFIG_HOTPLUG_CPU


172 
	$rouã_úq
(
úq_desc
 *
desc
, 
úq
, 
˝u
)

174 
	`¥_debug
("IRQ%u: movög from cpu%uÅÿ˝u%u\n", 
úq
, 
desc
->
˝u
, cpu);

176 
	`•ö_lock_úq
(&
desc
->
lock
);

177 
desc
->
chù
->
	`£t_afföôy
(
úq
, 
	`˝umask_of_˝u
(
˝u
));

178 
	`•ö_u∆ock_úq
(&
desc
->
lock
);

179 
	}
}

186 
	$migøã_úqs
()

188 
i
, 
˝u
 = 
	`smp_¥o˚ss‹_id
();

190 
i
 = 0; i < 
NR_IRQS
; i++) {

191 
úq_desc
 *
desc
 = irq_des¯+ 
i
;

193 i‡(
desc
->
˝u
 == cpu) {

194 
√w˝u
 = 
	`™y_⁄löe_˝u
(
desc
->
afföôy
);

196 i‡(
√w˝u
 =
NR_CPUS
) {

197 i‡(
	`¥ötk_øãlimô
())

198 
	`¥ötk
(
KERN_INFO
 "IRQ%uÇoÜongeráffineÅo CPU%u\n",

199 
i
, 
˝u
);

201 
	`˝us_£èŒ
(
desc
->
afföôy
);

202 
√w˝u
 = 
	`™y_⁄löe_˝u
(
desc
->
afföôy
);

205 
	`rouã_úq
(
desc
, 
i
, 
√w˝u
);

208 
	}
}

	@arch/arm/kernel/isa.c

14 
	~<löux/°ddef.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs.h
>

17 
	~<löux/sys˘l.h
>

18 
	~<löux/öô.h
>

20 
	giß_memba£
, 
	giß_p‹tba£
, 
	giß_p‹tshi·
;

22 
˘l_èbÀ
 
	g˘l_iß_v¨s
[4] = {

24 .
˘l_«me
 = 
BUS_ISA_MEM_BASE
,

25 .
	g¥o˙ame
 = "membase",

26 .
	gd©a
 = &
iß_memba£
,

27 .
	gmaxÀn
 = (
iß_memba£
),

28 .
	gmode
 = 0444,

29 .
	g¥oc_h™dÀr
 = &
¥oc_doötvec
,

31 .
	g˘l_«me
 = 
BUS_ISA_PORT_BASE
,

32 .
	g¥o˙ame
 = "portbase",

33 .
	gd©a
 = &
iß_p‹tba£
,

34 .
	gmaxÀn
 = (
iß_p‹tba£
),

35 .
	gmode
 = 0444,

36 .
	g¥oc_h™dÀr
 = &
¥oc_doötvec
,

38 .
	g˘l_«me
 = 
BUS_ISA_PORT_SHIFT
,

39 .
	g¥o˙ame
 = "portshift",

40 .
	gd©a
 = &
iß_p‹tshi·
,

41 .
	gmaxÀn
 = (
iß_p‹tshi·
),

42 .
	gmode
 = 0444,

43 .
	g¥oc_h™dÀr
 = &
¥oc_doötvec
,

47 
˘l_èbÀ_hódî
 *
	giß_sys˘l_hódî
;

49 
˘l_èbÀ
 
	g˘l_iß
[2] = {

51 .
˘l_«me
 = 
CTL_BUS_ISA
,

52 .
	g¥o˙ame
 = "isa",

53 .
	gmode
 = 0555,

54 .
	gchûd
 = 
˘l_iß_v¨s
,

58 
˘l_èbÀ
 
	g˘l_bus
[2] = {

60 .
˘l_«me
 = 
CTL_BUS
,

61 .
	g¥o˙ame
 = "bus",

62 .
	gmode
 = 0555,

63 .
	gchûd
 = 
˘l_iß
,

67 
__öô


68 
	$ªgi°î_iß_p‹ts
(
memba£
, 
p‹tba£
, 
p‹tshi·
)

70 
iß_memba£
 = 
memba£
;

71 
iß_p‹tba£
 = 
p‹tba£
;

72 
iß_p‹tshi·
 = 
p‹tshi·
;

73 
iß_sys˘l_hódî
 = 
	`ªgi°î_sys˘l_èbÀ
(
˘l_bus
);

74 
	}
}

	@arch/arm/kernel/machine_kexec.c

5 
	~<löux/mm.h
>

6 
	~<löux/kexec.h
>

7 
	~<löux/dñay.h
>

8 
	~<löux/ªboŸ.h
>

9 
	~<asm/pgèbÀ.h
>

10 
	~<asm/pgÆloc.h
>

11 
	~<asm/mmu_c⁄ãxt.h
>

12 
	~<asm/io.h
>

13 
	~<asm/ˇcheÊush.h
>

14 
	~<asm/mach-ty≥s.h
>

16 c⁄° 
ªloˇã_√w_kî√l
[];

17 c⁄° 
ªloˇã_√w_kî√l_size
;

19 
£tup_mm_f‹_ªboŸ
(
mode
);

21 
kexec_°¨t_addªss
;

22 
kexec_ödúe˘i⁄_∑ge
;

23 
kexec_mach_ty≥
;

30 
	$machöe_kexec_¥ï¨e
(
kimage
 *
image
)

33 
	}
}

35 
	$machöe_kexec_˛ónup
(
kimage
 *
image
)

37 
	}
}

39 
	$machöe_shutdown
()

41 
	}
}

43 
	$machöe_¸ash_shutdown
(
±_ªgs
 *
ªgs
)

45 
	}
}

47 
	$machöe_kexec
(
kimage
 *
image
)

49 
∑ge_li°
;

50 
ªboŸ_code_buf„r_phys
;

51 *
ªboŸ_code_buf„r
;

54 
∑ge_li°
 = 
image
->
hód
 & 
PAGE_MASK
;

57 
ªboŸ_code_buf„r_phys
 =

58 
	`∑ge_to_p‚
(
image
->
c⁄åﬁ_code_∑ge
Ë<< 
PAGE_SHIFT
;

59 
ªboŸ_code_buf„r
 = 
	`∑ge_addªss
(
image
->
c⁄åﬁ_code_∑ge
);

62 
kexec_°¨t_addªss
 = 
image
->
°¨t
;

63 
kexec_ödúe˘i⁄_∑ge
 = 
∑ge_li°
;

64 
kexec_mach_ty≥
 = 
machöe_¨ch_ty≥
;

67 
	`mem˝y
(
ªboŸ_code_buf„r
,

68 
ªloˇã_√w_kî√l
, 
ªloˇã_√w_kî√l_size
);

71 
	`Êush_iˇche_ønge
((Ë
ªboŸ_code_buf„r
,

72 (Ë
ªboŸ_code_buf„r
 + 
KEXEC_CONTROL_CODE_SIZE
);

73 
	`¥ötk
(
KERN_INFO
 "Bye!\n");

75 
	`˝u_¥oc_fö
();

76 
	`£tup_mm_f‹_ªboŸ
(0);

77 
	`˝u_ª£t
(
ªboŸ_code_buf„r_phys
);

78 
	}
}

	@arch/arm/kernel/module.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/moduÀlﬂdî.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/ñf.h
>

17 
	~<löux/vmÆloc.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/fs.h
>

20 
	~<löux/°rög.h
>

22 
	~<asm/pgèbÀ.h
>

24 #ifde‡
CONFIG_XIP_KERNEL


31 
_ëext
;

32 #unde‡
MODULE_START


33 
	#MODULE_START
 ((()&
_ëext
 + ~
PGDIR_MASK
Ë& PGDIR_MASK)

	)

36 #ifde‡
CONFIG_MMU


37 *
	$moduÀ_Æloc
(
size
)

39 
vm_°ru˘
 *
¨ó
;

41 
size
 = 
	`PAGE_ALIGN
(size);

42 i‡(!
size
)

43  
NULL
;

45 
¨ó
 = 
	`__gë_vm_¨ó
(
size
, 
VM_ALLOC
, 
MODULE_START
, 
MODULE_END
);

46 i‡(!
¨ó
)

47  
NULL
;

49  
	`__vmÆloc_¨ó
(
¨ó
, 
GFP_KERNEL
, 
PAGE_KERNEL
);

50 
	}
}

52 *
	$moduÀ_Æloc
(
size
)

54  
size
 =0 ? 
NULL
 : 
	`vmÆloc
(size);

55 
	}
}

58 
	$moduÀ_‰ì
(
moduÀ
 *moduÀ, *
ªgi⁄
)

60 
	`v‰ì
(
ªgi⁄
);

61 
	}
}

63 
	$moduÀ_‰ob_¨ch_£˘i⁄s
(
Elf_Ehdr
 *
hdr
,

64 
Elf_Shdr
 *
£chdrs
,

65 *
£c°rögs
,

66 
moduÀ
 *
mod
)

69 
	}
}

72 
	$≠∂y_ªloˇã
(
Elf32_Shdr
 *
£chdrs
, c⁄° *
°πab
, 
symödex
,

73 
ªlödex
, 
moduÀ
 *module)

75 
Elf32_Shdr
 *
sym£c
 = 
£chdrs
 + 
symödex
;

76 
Elf32_Shdr
 *
ªl£c
 = 
£chdrs
 + 
ªlödex
;

77 
Elf32_Shdr
 *
d°£c
 = 
£chdrs
 + 
ªl£c
->
sh_öfo
;

78 
Elf32_Rñ
 *
ªl
 = (*)
ªl£c
->
sh_addr
;

79 
i
;

81 
i
 = 0; i < 
ªl£c
->
sh_size
 / (
Elf32_Rñ
); i++, 
ªl
++) {

82 
loc
;

83 
Elf32_Sym
 *
sym
;

84 
s32
 
off£t
;

86 
off£t
 = 
	`ELF32_R_SYM
(
ªl
->
r_öfo
);

87 i‡(
off£t
 < 0 || off£à> (
sym£c
->
sh_size
 / (
Elf32_Sym
))) {

88 
	`¥ötk
(
KERN_ERR
 "%s: badÑelocation, section %dÑeloc %d\n",

89 
moduÀ
->
«me
, 
ªlödex
, 
i
);

90  -
ENOEXEC
;

93 
sym
 = ((
Elf32_Sym
 *)
sym£c
->
sh_addr
Ë+ 
off£t
;

95 i‡(
ªl
->
r_off£t
 < 0 ||Ññ->r_off£à> 
d°£c
->
sh_size
 - (
u32
)) {

96 
	`¥ötk
(
KERN_ERR
 "%s: out of boundsÑelocation, "

98 
moduÀ
->
«me
, 
ªlödex
, 
i
, 
ªl
->
r_off£t
,

99 
d°£c
->
sh_size
);

100  -
ENOEXEC
;

103 
loc
 = 
d°£c
->
sh_addr
 + 
ªl
->
r_off£t
;

105 
	`ELF32_R_TYPE
(
ªl
->
r_öfo
)) {

106 
R_ARM_ABS32
:

107 *(
u32
 *)
loc
 +
sym
->
°_vÆue
;

110 
R_ARM_PC24
:

111 
R_ARM_CALL
:

112 
R_ARM_JUMP24
:

113 
off£t
 = (*(
u32
 *)
loc
 & 0x00ffffff) << 2;

114 i‡(
off£t
 & 0x02000000)

115 
off£t
 -= 0x04000000;

117 
off£t
 +
sym
->
°_vÆue
 - 
loc
;

118 i‡(
off£t
 & 3 ||

119 
off£t
 <(
s32
)0xfe000000 ||

120 
off£t
 >(
s32
)0x02000000) {

121 
	`¥ötk
(
KERN_ERR


123 "%dÑño¯%d sym '%s'\n", 
moduÀ
->
«me
,

124 
ªlödex
, 
i
, 
°πab
 + 
sym
->
°_«me
);

125  -
ENOEXEC
;

128 
off£t
 >>= 2;

130 *(
u32
 *)
loc
 &= 0xff000000;

131 *(
u32
 *)
loc
 |
off£t
 & 0x00ffffff;

135 
	`¥ötk
(
KERN_ERR
 "%s: unknownÑelocation: %u\n",

136 
moduÀ
->
«me
, 
	`ELF32_R_TYPE
(
ªl
->
r_öfo
));

137  -
ENOEXEC
;

141 
	}
}

144 
	$≠∂y_ªloˇã_add
(
Elf32_Shdr
 *
£chdrs
, c⁄° *
°πab
,

145 
symödex
, 
ªl£c
, 
moduÀ
 *module)

147 
	`¥ötk
(
KERN_ERR
 "module %s: ADD RELOCATION unsupported\n",

148 
moduÀ
->
«me
);

149  -
ENOEXEC
;

150 
	}
}

153 
	$moduÀ_föÆize
(c⁄° 
Elf32_Ehdr
 *
hdr
, c⁄° 
Elf_Shdr
 *
£chdrs
,

154 
moduÀ
 *module)

157 
	}
}

160 
	$moduÀ_¨ch_˛ónup
(
moduÀ
 *
mod
)

162 
	}
}

	@arch/arm/kernel/process.c

11 
	~<°d¨g.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/°ddef.h
>

18 
	~<löux/uni°d.h
>

19 
	~<löux/¶ab.h
>

20 
	~<löux/u£r.h
>

21 
	~<löux/a.out.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/ªboŸ.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/kÆlsyms.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/˝u.h
>

28 
	~<löux/ñfc‹e.h
>

29 
	~<löux/pm.h
>

30 
	~<löux/tick.h
>

31 
	~<löux/ut¢ame.h
>

33 
	~<asm/Àds.h
>

34 
	~<asm/¥o˚ss‹.h
>

35 
	~<asm/sy°em.h
>

36 
	~<asm/thªad_nŸify.h
>

37 
	~<asm/uac˚ss.h
>

38 
	~<asm/mach/time.h
>

40 c⁄° *
	g¥o˚ss‹_modes
[] = {

47 
£tup_mm_f‹_ªboŸ
(
mode
);

49 vﬁ©ûê
	gh…_cou¡î
;

51 
	~<asm/¨ch/sy°em.h
>

53 
	$dißbÀ_h…
()

55 
h…_cou¡î
++;

56 
	}
}

58 
EXPORT_SYMBOL
(
dißbÀ_h…
);

60 
	$íabÀ_h…
()

62 
h…_cou¡î
--;

63 
	}
}

65 
EXPORT_SYMBOL
(
íabÀ_h…
);

67 
__öô
 
	$noh…_£tup
(*
__unu£d
)

69 
h…_cou¡î
 = 1;

71 
	}
}

73 
__öô
 
	$h…_£tup
(*
__unu£d
)

75 
h…_cou¡î
 = 0;

77 
	}
}

79 
__£tup
("noh…", 
noh…_£tup
);

80 
__£tup
("h…", 
h…_£tup
);

82 
	$¨m_machöe_ª°¨t
(
mode
)

87 
	`˝u_¥oc_fö
();

94 
	`£tup_mm_f‹_ªboŸ
(
mode
);

99 
	`¨ch_ª£t
(
mode
);

105 
	`mdñay
(1000);

106 
	`¥ötk
("Reboot failed -- System halted\n");

108 
	}
}

113 (*
pm_idÀ
)();

114 
	`EXPORT_SYMBOL
(
pm_idÀ
);

116 (*
pm_powî_off
)();

117 
	`EXPORT_SYMBOL
(
pm_powî_off
);

119 (*
¨m_pm_ª°¨t
)(
°r
Ë
¨m_machöe_ª°¨t
;

120 
	`EXPORT_SYMBOL_GPL
(
¨m_pm_ª°¨t
);

127 
	$deÁu…_idÀ
()

129 i‡(
h…_cou¡î
)

130 
	`˝u_ªœx
();

132 
	`loˇl_úq_dißbÀ
();

133 i‡(!
	`√ed_ªsched
()) {

134 
	`timî_dyn_ª¥ogøm
();

135 
	`¨ch_idÀ
();

137 
	`loˇl_úq_íabÀ
();

139 
	}
}

146 
	$˝u_idÀ
()

148 
	`loˇl_fiq_íabÀ
();

152 (*
idÀ
)(Ë
pm_idÀ
;

154 #ifde‡
CONFIG_HOTPLUG_CPU


155 i‡(
	`˝u_is_ofÊöe
(
	`smp_¥o˚ss‹_id
())) {

156 
	`Àds_evít
(
Àd_idÀ_°¨t
);

157 
	`˝u_dõ
();

161 i‡(!
idÀ
)

162 
idÀ
 = 
deÁu…_idÀ
;

163 
	`Àds_evít
(
Àd_idÀ_°¨t
);

164 
	`tick_nohz_°›_sched_tick
();

165 !
	`√ed_ªsched
())

166 
	`idÀ
();

167 
	`Àds_evít
(
Àd_idÀ_íd
);

168 
	`tick_nohz_ª°¨t_sched_tick
();

169 
	`¥ìm±_íabÀ_no_ªsched
();

170 
	`scheduÀ
();

171 
	`¥ìm±_dißbÀ
();

173 
	}
}

175 
	gªboŸ_mode
 = 'h';

177 
__öô
 
	$ªboŸ_£tup
(*
°r
)

179 
ªboŸ_mode
 = 
°r
[0];

181 
	}
}

183 
__£tup
("ªboŸ=", 
ªboŸ_£tup
);

185 
	$machöe_hÆt
()

187 
	}
}

190 
	$machöe_powî_off
()

192 i‡(
pm_powî_off
)

193 
	`pm_powî_off
();

194 
	}
}

196 
	$machöe_ª°¨t
(* 
__unu£d
)

198 
	`¨m_pm_ª°¨t
(
ªboŸ_mode
);

199 
	}
}

201 
	$__show_ªgs
(
±_ªgs
 *
ªgs
)

203 
Êags
;

204 
buf
[64];

206 
	`¥ötk
("CPU: %d %s (%s %.*s)\n",

207 
	`smp_¥o˚ss‹_id
(), 
	`¥öt_èöãd
(), 
	`öô_ut¢ame
()->
ªÀa£
,

208 ()
	`°rc•n
(
	`öô_ut¢ame
()->
vîsi⁄
, " "),

209 
	`öô_ut¢ame
()->
vîsi⁄
);

210 
	`¥öt_symbﬁ
("PC i†© %s\n", 
	`ö°ru˘i⁄_poöãr
(
ªgs
));

211 
	`¥öt_symbﬁ
("LR i†© %s\n", 
ªgs
->
ARM_Ã
);

212 
	`¥ötk
("pc : [<%08lx>]Ür : [<%08lx>]Ösr: %08lx\n"

214 
ªgs
->
ARM_pc
,Ñegs->
ARM_Ã
,Ñegs->
ARM_˝§
,

215 
ªgs
->
ARM_•
,Ñegs->
ARM_ù
,Ñegs->
ARM_Â
);

216 
	`¥ötk
("r10: %08lxÑ9 : %08lxÑ8 : %08lx\n",

217 
ªgs
->
ARM_r10
,Ñegs->
ARM_r9
,

218 
ªgs
->
ARM_r8
);

219 
	`¥ötk
("r7 : %08lxÑ6 : %08lxÑ5 : %08lxÑ4 : %08lx\n",

220 
ªgs
->
ARM_r7
,Ñegs->
ARM_r6
,

221 
ªgs
->
ARM_r5
,Ñegs->
ARM_r4
);

222 
	`¥ötk
("r3 : %08lxÑ2 : %08lxÑ1 : %08lxÑ0 : %08lx\n",

223 
ªgs
->
ARM_r3
,Ñegs->
ARM_r2
,

224 
ªgs
->
ARM_r1
,Ñegs->
ARM_r0
);

226 
Êags
 = 
ªgs
->
ARM_˝§
;

227 
buf
[0] = 
Êags
 & 
PSR_N_BIT
 ? 'N' : 'n';

228 
buf
[1] = 
Êags
 & 
PSR_Z_BIT
 ? 'Z' : 'z';

229 
buf
[2] = 
Êags
 & 
PSR_C_BIT
 ? 'C' : 'c';

230 
buf
[3] = 
Êags
 & 
PSR_V_BIT
 ? 'V' : 'v';

231 
buf
[4] = '\0';

233 
	`¥ötk
("Flags: %s IRQs o%s FIQs o%s Mode %s%s Segment %s\n",

234 
buf
, 
	`öãºu±s_íabÀd
(
ªgs
) ? "n" : "ff",

235 
	`Á°_öãºu±s_íabÀd
(
ªgs
) ? "n" : "ff",

236 
¥o˚ss‹_modes
[
	`¥o˚ss‹_mode
(
ªgs
)],

237 
	`thumb_mode
(
ªgs
) ? " (T)" : "",

238 
	`gë_fs
(Ë=
	`gë_ds
() ? "kernel" : "user");

239 #ifde‡
CONFIG_CPU_CP15


241 
˘æ
;

243 
buf
[0] = '\0';

244 #ifde‡
CONFIG_CPU_CP15_MMU


246 
å™sba£
, 
dac
;

247 
	`asm
("mrcÖ15, 0, %0, c2, c0\n\t"

249 : "Ù" (
å™sba£
), "Ù" (
dac
));

250 
	`¢¥ötf
(
buf
, (buf), " Table: %08x DAC: %08x",

251 
å™sba£
, 
dac
);

254 
	`asm
("mr¯p15, 0, %0, c1, c0\n" : "Ù" (
˘æ
));

256 
	`¥ötk
("C⁄åﬁ: %08x%s\n", 
˘æ
, 
buf
);

259 
	}
}

261 
	$show_ªgs
(
±_ªgs
 * 
ªgs
)

263 
	`¥ötk
("\n");

264 
	`¥ötk
("Pid: %d, comm: %20s\n", 
cuºít
->
pid
, cuºít->
comm
);

265 
	`__show_ªgs
(
ªgs
);

266 
	`__backåa˚
();

267 
	}
}

269 
	$show_Âªgs
(
u£r_Â
 *
ªgs
)

271 
i
;

273 
i
 = 0; i < 8; i++) {

274 *
p
;

275 
ty≥
;

277 
p
 = (*)(
ªgs
->
Âªgs
 + 
i
);

279 
ªgs
->
·y≥
[
i
]) {

280 1: 
ty≥
 = 'f'; ;

281 2: 
ty≥
 = 'd'; ;

282 3: 
ty≥
 = 'e'; ;

283 : 
ty≥
 = '?'; ;

285 i‡(
ªgs
->
öô_Êag
)

286 
ty≥
 = '?';

288 
	`¥ötk
(" f%d(%c): %08lx %08lx %08lx%c",

289 
i
, 
ty≥
, 
p
[0],Ö[1],Ö[2], i & 1 ? '\n' : ' ');

293 
	`¥ötk
("FPSR: %08lx FPCR: %08lx\n",

294 ()
ªgs
->
Â§
,

295 ()
ªgs
->
Â¸
);

296 
	}
}

301 
	$exô_thªad
()

303 
	}
}

305 
ATOMIC_NOTIFIER_HEAD
(
thªad_nŸify_hód
);

307 
EXPORT_SYMBOL_GPL
(
thªad_nŸify_hód
);

309 
	$Êush_thªad
()

311 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

312 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

314 
	`mem£t
(
thªad
->
u£d_˝
, 0, (thread->used_cp));

315 
	`mem£t
(&
tsk
->
thªad
.
debug
, 0, (
debug_öfo
));

316 
	`mem£t
(&
thªad
->
Â°©e
, 0, (
Â_°©e
));

318 
	`thªad_nŸify
(
THREAD_NOTIFY_FLUSH
, 
thªad
);

319 
	}
}

321 
	$ªÀa£_thªad
(
èsk_°ru˘
 *
dód_èsk
)

323 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
dód_èsk
);

325 
	`thªad_nŸify
(
THREAD_NOTIFY_RELEASE
, 
thªad
);

326 
	}
}

328 
asmlökage
 
	$ªt_‰om_f‹k
(Ë
	`__asm__
("ret_from_fork");

331 
	$c›y_thªad
(
ƒ
, 
˛⁄e_Êags
, 
°ack_°¨t
,

332 
°k_sz
, 
èsk_°ru˘
 *
p
, 
±_ªgs
 *
ªgs
)

334 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
p
);

335 
±_ªgs
 *
chûdªgs
 = 
	`èsk_±_ªgs
(
p
);

337 *
chûdªgs
 = *
ªgs
;

338 
chûdªgs
->
ARM_r0
 = 0;

339 
chûdªgs
->
ARM_•
 = 
°ack_°¨t
;

341 
	`mem£t
(&
thªad
->
˝u_c⁄ãxt
, 0, (
˝u_c⁄ãxt_ßve
));

342 
thªad
->
˝u_c⁄ãxt
.
•
 = ()
chûdªgs
;

343 
thªad
->
˝u_c⁄ãxt
.
pc
 = ()
ªt_‰om_f‹k
;

345 i‡(
˛⁄e_Êags
 & 
CLONE_SETTLS
)

346 
thªad
->
ç_vÆue
 = 
ªgs
->
ARM_r3
;

349 
	}
}

354 
	$dump_Âu
 (
±_ªgs
 *
ªgs
, 
u£r_Â
 *
Â
)

356 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

357 
u£d_m©h
 = 
thªad
->
u£d_˝
[1] |Åhread->used_cp[2];

359 i‡(
u£d_m©h
)

360 
	`mem˝y
(
Â
, &
thªad
->
Â°©e
.
so·
,  (*fp));

362  
u£d_m©h
 != 0;

363 
	}
}

364 
EXPORT_SYMBOL
(
dump_Âu
);

369 
	$dump_thªad
(
±_ªgs
 * 
ªgs
, 
u£r
 * 
dump
)

371 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

373 
dump
->
magic
 = 
CMAGIC
;

374 
dump
->
°¨t_code
 = 
tsk
->
mm
->start_code;

375 
dump
->
°¨t_°ack
 = 
ªgs
->
ARM_•
 & ~(
PAGE_SIZE
 - 1);

377 
dump
->
u_tsize
 = (
tsk
->
mm
->
íd_code
 -Åsk->mm->
°¨t_code
Ë>> 
PAGE_SHIFT
;

378 
dump
->
u_dsize
 = (
tsk
->
mm
->
brk
 -Åsk->mm->
°¨t_d©a
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

379 
dump
->
u_ssize
 = 0;

381 
dump
->
u_debugªg
[0] = 
tsk
->
thªad
.
debug
.
bp
[0].
addªss
;

382 
dump
->
u_debugªg
[1] = 
tsk
->
thªad
.
debug
.
bp
[1].
addªss
;

383 
dump
->
u_debugªg
[2] = 
tsk
->
thªad
.
debug
.
bp
[0].
ö¢
.
¨m
;

384 
dump
->
u_debugªg
[3] = 
tsk
->
thªad
.
debug
.
bp
[1].
ö¢
.
¨m
;

385 
dump
->
u_debugªg
[4] = 
tsk
->
thªad
.
debug
.
nßved
;

387 i‡(
dump
->
°¨t_°ack
 < 0x04000000)

388 
dump
->
u_ssize
 = (0x04000000 - dump->
°¨t_°ack
Ë>> 
PAGE_SHIFT
;

390 
dump
->
ªgs
 = *regs;

391 
dump
->
u_ÂvÆid
 = 
	`dump_Âu
 (
ªgs
, &dump->
u_Â
);

392 
	}
}

393 
EXPORT_SYMBOL
(
dump_thªad
);

400 
kî√l_thªad_hñ≥r
();

401 
asm
( ".section .text\n"

414 
pid_t
 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
Êags
)

416 
±_ªgs
 
ªgs
;

418 
	`mem£t
(&
ªgs
, 0, (regs));

420 
ªgs
.
ARM_r1
 = ()
¨g
;

421 
ªgs
.
ARM_r2
 = ()
‚
;

422 
ªgs
.
ARM_r3
 = ()
do_exô
;

423 
ªgs
.
ARM_pc
 = ()
kî√l_thªad_hñ≥r
;

424 
ªgs
.
ARM_˝§
 = 
SVC_MODE
;

426  
	`do_f‹k
(
Êags
|
CLONE_VM
|
CLONE_UNTRACED
, 0, &
ªgs
, 0, 
NULL
, NULL);

427 
	}
}

428 
EXPORT_SYMBOL
(
kî√l_thªad
);

430 
	$gë_wch™
(
èsk_°ru˘
 *
p
)

432 
Â
, 
Ã
;

433 
°ack_°¨t
, 
°ack_íd
;

434 
cou¡
 = 0;

435 i‡(!
p
 ||Ö =
cuºít
 ||Ö->
°©e
 =
TASK_RUNNING
)

438 
°ack_°¨t
 = ()
	`íd_of_°ack
(
p
);

439 
°ack_íd
 = ()
	`èsk_°ack_∑ge
(
p
Ë+ 
THREAD_SIZE
;

441 
Â
 = 
	`thªad_ßved_Â
(
p
);

443 i‡(
Â
 < 
°ack_°¨t
 || f∞> 
°ack_íd
)

445 
Ã
 = 
	`pc_poöãr
 (((*)
Â
)[-1]);

446 i‡(!
	`ö_sched_fun˘i⁄s
(
Ã
))

447  
Ã
;

448 
Â
 = *(*) (fp - 12);

449 } 
cou¡
 ++ < 16);

451 
	}
}

	@arch/arm/kernel/ptrace.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/sched.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/smp.h
>

16 
	~<löux/±ø˚.h
>

17 
	~<löux/u£r.h
>

18 
	~<löux/£curôy.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/sig«l.h
>

22 
	~<asm/uac˚ss.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/sy°em.h
>

25 
	~<asm/å≠s.h
>

27 
	~"±ø˚.h
"

29 
	#REG_PC
 15

	)

30 
	#REG_PSR
 16

	)

40 
	#BREAKINST_ARM
 0xef9f0001

	)

41 
	#BREAKINST_THUMB
 0xdf00

	)

51 
	#BREAKINST_ARM
 0xe7f001f0

	)

52 
	#BREAKINST_THUMB
 0xde01

	)

61 
ölöe
 
	$gë_u£r_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
)

63  
	`èsk_±_ªgs
(
èsk
)->
uªgs
[
off£t
];

64 
	}
}

72 
ölöe
 

73 
	$put_u£r_ªg
(
èsk_°ru˘
 *
èsk
, 
off£t
, 
d©a
)

75 
±_ªgs
 
√wªgs
, *
ªgs
 = 
	`èsk_±_ªgs
(
èsk
);

76 
ªt
 = -
EINVAL
;

78 
√wªgs
 = *
ªgs
;

79 
√wªgs
.
uªgs
[
off£t
] = 
d©a
;

81 i‡(
	`vÆid_u£r_ªgs
(&
√wªgs
)) {

82 
ªgs
->
uªgs
[
off£t
] = 
d©a
;

83 
ªt
 = 0;

86  
ªt
;

87 
	}
}

89 
ölöe
 

90 
	$ªad_u32
(
èsk_°ru˘
 *
èsk
, 
addr
, 
u32
 *
ªs
)

92 
ªt
;

94 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
, 
ªs
, (*res), 0);

96  
ªt
 =(*
ªs
Ë? 0 : -
EIO
;

97 
	}
}

99 
ölöe
 

100 
	$ªad_ö°r
(
èsk_°ru˘
 *
èsk
, 
addr
, 
u32
 *
ªs
)

102 
ªt
;

104 i‡(
addr
 & 1) {

105 
u16
 
vÆ
;

106 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
 & ~1, &
vÆ
, (val), 0);

107 
ªt
 =Ñë =(
vÆ
Ë? 0 : -
EIO
;

108 *
ªs
 = 
vÆ
;

110 
u32
 
vÆ
;

111 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
 & ~3, &
vÆ
, (val), 0);

112 
ªt
 =Ñë =(
vÆ
Ë? 0 : -
EIO
;

113 *
ªs
 = 
vÆ
;

115  
ªt
;

116 
	}
}

122 
	$±ø˚_gë∫
(
èsk_°ru˘
 *
chûd
, 
ö¢
)

124 
ªg
 = (
ö¢
 >> 16) & 15;

125 
vÆ
;

127 
vÆ
 = 
	`gë_u£r_ªg
(
chûd
, 
ªg
);

128 i‡(
ªg
 == 15)

129 
vÆ
 = 
	`pc_poöãr
(val + 8);

131  
vÆ
;

132 
	}
}

138 
	$±ø˚_gëÆu›2
(
èsk_°ru˘
 *
chûd
, 
ö¢
)

140 
vÆ
;

141 
shi·
;

142 
ty≥
;

144 i‡(
ö¢
 & 1 << 25) {

145 
vÆ
 = 
ö¢
 & 255;

146 
shi·
 = (
ö¢
 >> 8) & 15;

147 
ty≥
 = 3;

149 
vÆ
 = 
	`gë_u£r_ªg
 (
chûd
, 
ö¢
 & 15);

151 i‡(
ö¢
 & (1 << 4))

152 
shi·
 = ()
	`gë_u£r_ªg
 (
chûd
, (
ö¢
 >> 8) & 15);

154 
shi·
 = (
ö¢
 >> 7) & 31;

156 
ty≥
 = (
ö¢
 >> 5) & 3;

159 
ty≥
) {

160 0: 
vÆ
 <<
shi·
; ;

161 1: 
vÆ
 >>
shi·
; ;

163 
vÆ
 = (((sig√d )vÆË>> 
shi·
);

166 
vÆ
 = (vÆ >> 
shi·
) | (val << (32 - shift));

169  
vÆ
;

170 
	}
}

176 
	$±ø˚_gëldr›2
(
èsk_°ru˘
 *
chûd
, 
ö¢
)

178 
vÆ
;

179 
shi·
;

180 
ty≥
;

182 
vÆ
 = 
	`gë_u£r_ªg
(
chûd
, 
ö¢
 & 15);

183 
shi·
 = (
ö¢
 >> 7) & 31;

184 
ty≥
 = (
ö¢
 >> 5) & 3;

186 
ty≥
) {

187 0: 
vÆ
 <<
shi·
; ;

188 1: 
vÆ
 >>
shi·
; ;

190 
vÆ
 = (((sig√d )vÆË>> 
shi·
);

193 
vÆ
 = (vÆ >> 
shi·
) | (val << (32 - shift));

196  
vÆ
;

197 
	}
}

199 
	#OP_MASK
 0x01e00000

	)

200 
	#OP_AND
 0x00000000

	)

201 
	#OP_EOR
 0x00200000

	)

202 
	#OP_SUB
 0x00400000

	)

203 
	#OP_RSB
 0x00600000

	)

204 
	#OP_ADD
 0x00800000

	)

205 
	#OP_ADC
 0x00a00000

	)

206 
	#OP_SBC
 0x00c00000

	)

207 
	#OP_RSC
 0x00e00000

	)

208 
	#OP_ORR
 0x01800000

	)

209 
	#OP_MOV
 0x01a00000

	)

210 
	#OP_BIC
 0x01c00000

	)

211 
	#OP_MVN
 0x01e00000

	)

214 
	$gë_bønch_addªss
(
èsk_°ru˘
 *
chûd
, 
pc
, 
ö¢
)

216 
u32
 
Æt
 = 0;

218 
ö¢
 & 0x0e000000) {

224 
Æu›1
, 
Æu›2
, 
ccbô
;

226 i‡((
ö¢
 & 0x0fffffd0) == 0x012fff10) {

230 
Æt
 = 
	`gë_u£r_ªg
(
chûd
, 
ö¢
 & 15);

235 i‡((
ö¢
 & 0xf000) != 0xf000)

238 
Æu›1
 = 
	`±ø˚_gë∫
(
chûd
, 
ö¢
);

239 
Æu›2
 = 
	`±ø˚_gëÆu›2
(
chûd
, 
ö¢
);

240 
ccbô
 = 
	`gë_u£r_ªg
(
chûd
, 
REG_PSR
Ë& 
PSR_C_BIT
 ? 1 : 0;

242 
ö¢
 & 
OP_MASK
) {

243 
OP_AND
: 
Æt
 = 
Æu›1
 & 
Æu›2
; ;

244 
OP_EOR
: 
Æt
 = 
Æu›1
 ^ 
Æu›2
; ;

245 
OP_SUB
: 
Æt
 = 
Æu›1
 - 
Æu›2
; ;

246 
OP_RSB
: 
Æt
 = 
Æu›2
 - 
Æu›1
; ;

247 
OP_ADD
: 
Æt
 = 
Æu›1
 + 
Æu›2
; ;

248 
OP_ADC
: 
Æt
 = 
Æu›1
 + 
Æu›2
 + 
ccbô
; ;

249 
OP_SBC
: 
Æt
 = 
Æu›1
 - 
Æu›2
 + 
ccbô
; ;

250 
OP_RSC
: 
Æt
 = 
Æu›2
 - 
Æu›1
 + 
ccbô
; ;

251 
OP_ORR
: 
Æt
 = 
Æu›1
 | 
Æu›2
; ;

252 
OP_MOV
: 
Æt
 = 
Æu›2
; ;

253 
OP_BIC
: 
Æt
 = 
Æu›1
 & ~
Æu›2
; ;

254 
OP_MVN
: 
Æt
 = ~
Æu›2
; ;

264 i‡((
ö¢
 & 0x0010f000) == 0x0010f000) {

265 
ba£
;

267 
ba£
 = 
	`±ø˚_gë∫
(
chûd
, 
ö¢
);

268 i‡(
ö¢
 & 1 << 24) {

269 
Æu›2
;

271 i‡(
ö¢
 & 0x02000000)

272 
Æu›2
 = 
	`±ø˚_gëldr›2
(
chûd
, 
ö¢
);

274 
Æu›2
 = 
ö¢
 & 0xfff;

276 i‡(
ö¢
 & 1 << 23)

277 
ba£
 +
Æu›2
;

279 
ba£
 -
Æu›2
;

281 i‡(
	`ªad_u32
(
chûd
, 
ba£
, &
Æt
) == 0)

282 
Æt
 = 
	`pc_poöãr
(alt);

290 i‡((
ö¢
 & 0x00108000) == 0x00108000) {

291 
ba£
;

292 
ƒ_ªgs
;

294 i‡(
ö¢
 & (1 << 23)) {

295 
ƒ_ªgs
 = 
	`hweight16
(
ö¢
 & 65535) << 2;

297 i‡(!(
ö¢
 & (1 << 24)))

298 
ƒ_ªgs
 -= 4;

300 i‡(
ö¢
 & (1 << 24))

301 
ƒ_ªgs
 = -4;

303 
ƒ_ªgs
 = 0;

306 
ba£
 = 
	`±ø˚_gë∫
(
chûd
, 
ö¢
);

308 i‡(
	`ªad_u32
(
chûd
, 
ba£
 + 
ƒ_ªgs
, &
Æt
) == 0)

309 
Æt
 = 
	`pc_poöãr
(alt);

318 sig√d 
di•l
;

326 
di•l
 = (
ö¢
 & 0x00ffffff) << 8;

327 
di•l
 = (displ >> 6) + 8;

328 i‡(
di•l
 != 0 && displ != 4)

329 
Æt
 = 
pc
 + 
di•l
;

334  
Æt
;

335 
	}
}

338 
	$sw≠_ö¢
(
èsk_°ru˘
 *
èsk
, 
addr
,

339 *
ﬁd_ö¢
, *
√w_ö¢
, 
size
)

341 
ªt
;

343 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
, 
ﬁd_ö¢
, 
size
, 0);

344 i‡(
ªt
 =
size
)

345 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
èsk
, 
addr
, 
√w_ö¢
, 
size
, 1);

346  
ªt
;

347 
	}
}

350 
	$add_bªakpoöt
(
èsk_°ru˘
 *
èsk
, 
debug_öfo
 *
dbg
, 
addr
)

352 
ƒ
 = 
dbg
->
nßved
;

354 i‡(
ƒ
 < 2) {

355 
u32
 
√w_ö¢
 = 
BREAKINST_ARM
;

356 
ªs
;

358 
ªs
 = 
	`sw≠_ö¢
(
èsk
, 
addr
, &
dbg
->
bp
[
ƒ
].
ö¢
, &
√w_ö¢
, 4);

360 i‡(
ªs
 == 4) {

361 
dbg
->
bp
[
ƒ
].
addªss
 = 
addr
;

362 
dbg
->
nßved
 += 1;

365 
	`¥ötk
(
KERN_ERR
 "ptrace:Åoo many breakpoints\n");

366 
	}
}

373 
	$˛ór_bªakpoöt
(
èsk_°ru˘
 *
èsk
, 
debug_íåy
 *
bp
)

375 
addr
 = 
bp
->
addªss
;

376 
debug_ö¢
 
ﬁd_ö¢
;

377 
ªt
;

379 i‡(
addr
 & 1) {

380 
ªt
 = 
	`sw≠_ö¢
(
èsk
, 
addr
 & ~1, &
ﬁd_ö¢
.
thumb
,

381 &
bp
->
ö¢
.
thumb
, 2);

383 i‡(
ªt
 !2 || 
ﬁd_ö¢
.
thumb
 !
BREAKINST_THUMB
)

384 
	`¥ötk
(
KERN_ERR
 "%s:%d: corrupted Thumb breakpointát "

385 "0x%08lx (0x%04x)\n", 
èsk
->
comm
,Åask->
pid
,

386 
addr
, 
ﬁd_ö¢
.
thumb
);

388 
ªt
 = 
	`sw≠_ö¢
(
èsk
, 
addr
 & ~3, &
ﬁd_ö¢
.
¨m
,

389 &
bp
->
ö¢
.
¨m
, 4);

391 i‡(
ªt
 !4 || 
ﬁd_ö¢
.
¨m
 !
BREAKINST_ARM
)

392 
	`¥ötk
(
KERN_ERR
 "%s:%d: corrupted ARM breakpointát "

393 "0x%08lx (0x%08x)\n", 
èsk
->
comm
,Åask->
pid
,

394 
addr
, 
ﬁd_ö¢
.
¨m
);

396 
	}
}

398 
	$±ø˚_£t_b±
(
èsk_°ru˘
 *
chûd
)

400 
±_ªgs
 *
ªgs
;

401 
pc
;

402 
u32
 
ö¢
;

403 
ªs
;

405 
ªgs
 = 
	`èsk_±_ªgs
(
chûd
);

406 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

408 i‡(
	`thumb_mode
(
ªgs
)) {

409 
	`¥ötk
(
KERN_WARNING
 "ptrace: can't handleÅhumb mode\n");

413 
ªs
 = 
	`ªad_ö°r
(
chûd
, 
pc
, &
ö¢
);

414 i‡(!
ªs
) {

415 
debug_öfo
 *
dbg
 = &
chûd
->
thªad
.
debug
;

416 
Æt
;

418 
dbg
->
nßved
 = 0;

420 
Æt
 = 
	`gë_bønch_addªss
(
chûd
, 
pc
, 
ö¢
);

421 i‡(
Æt
)

422 
	`add_bªakpoöt
(
chûd
, 
dbg
, 
Æt
);

433 i‡(!
Æt
 || 
	`¥ediˇã
(
ö¢
Ë!
PREDICATE_ALWAYS
)

434 
	`add_bªakpoöt
(
chûd
, 
dbg
, 
pc
 + 4);

436 
	}
}

442 
	$±ø˚_ˇn˚l_b±
(
èsk_°ru˘
 *
chûd
)

444 
i
, 
nßved
 = 
chûd
->
thªad
.
debug
.nsaved;

446 
chûd
->
thªad
.
debug
.
nßved
 = 0;

448 i‡(
nßved
 > 2) {

449 
	`¥ötk
("±ø˚_ˇn˚l_b±: bogu†nßved: %d!\n", 
nßved
);

450 
nßved
 = 2;

453 
i
 = 0; i < 
nßved
; i++)

454 
	`˛ór_bªakpoöt
(
chûd
, &chûd->
thªad
.
debug
.
bp
[
i
]);

455 
	}
}

460 
	$±ø˚_dißbÀ
(
èsk_°ru˘
 *
chûd
)

462 
	`sögÀ_°ï_dißbÀ
(
chûd
);

463 
	}
}

468 
	$±ø˚_bªak
(
èsk_°ru˘
 *
tsk
, 
±_ªgs
 *
ªgs
)

470 
sigöfo_t
 
öfo
;

472 
	`±ø˚_ˇn˚l_b±
(
tsk
);

474 
öfo
.
si_signo
 = 
SIGTRAP
;

475 
öfo
.
si_î∫o
 = 0;

476 
öfo
.
si_code
 = 
TRAP_BRKPT
;

477 
öfo
.
si_addr
 = (
__u£r
 *)
	`ö°ru˘i⁄_poöãr
(
ªgs
);

479 
	`f‹˚_sig_öfo
(
SIGTRAP
, &
öfo
, 
tsk
);

480 
	}
}

482 
	$bªak_å≠
(
±_ªgs
 *
ªgs
, 
ö°r
)

484 
	`±ø˚_bªak
(
cuºít
, 
ªgs
);

486 
	}
}

488 
undef_hook
 
	g¨m_bªak_hook
 = {

489 .
ö°r_mask
 = 0x0fffffff,

490 .
	gö°r_vÆ
 = 0x07f001f0,

491 .
	g˝§_mask
 = 
PSR_T_BIT
,

492 .
	g˝§_vÆ
 = 0,

493 .
	g‚
 = 
bªak_å≠
,

496 
undef_hook
 
	gthumb_bªak_hook
 = {

497 .
ö°r_mask
 = 0xffff,

498 .
	gö°r_vÆ
 = 0xde01,

499 .
	g˝§_mask
 = 
PSR_T_BIT
,

500 .
	g˝§_vÆ
 = 
PSR_T_BIT
,

501 .
	g‚
 = 
bªak_å≠
,

504 
__öô
 
	$±ø˚_bªak_öô
()

506 
	`ªgi°î_undef_hook
(&
¨m_bªak_hook
);

507 
	`ªgi°î_undef_hook
(&
thumb_bªak_hook
);

509 
	}
}

511 
c‹e_öôˇŒ
(
±ø˚_bªak_öô
);

517 
	$±ø˚_ªad_u£r
(
èsk_°ru˘
 *
tsk
, 
off
,

518 
__u£r
 *
ªt
)

520 
tmp
;

522 i‡(
off
 & 3 || of‡>(
u£r
))

523  -
EIO
;

525 
tmp
 = 0;

526 i‡(
off
 < (
±_ªgs
))

527 
tmp
 = 
	`gë_u£r_ªg
(
tsk
, 
off
 >> 2);

529  
	`put_u£r
(
tmp
, 
ªt
);

530 
	}
}

536 
	$±ø˚_wrôe_u£r
(
èsk_°ru˘
 *
tsk
, 
off
,

537 
vÆ
)

539 i‡(
off
 & 3 || of‡>(
u£r
))

540  -
EIO
;

542 i‡(
off
 >(
±_ªgs
))

545  
	`put_u£r_ªg
(
tsk
, 
off
 >> 2, 
vÆ
);

546 
	}
}

551 
	$±ø˚_gëªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uªgs
)

553 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

555  
	`c›y_to_u£r
(
uªgs
, 
ªgs
, (
±_ªgs
)Ë? -
EFAULT
 : 0;

556 
	}
}

561 
	$±ø˚_£åegs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uªgs
)

563 
±_ªgs
 
√wªgs
;

564 
ªt
;

566 
ªt
 = -
EFAULT
;

567 i‡(
	`c›y_‰om_u£r
(&
√wªgs
, 
uªgs
, (
±_ªgs
)) == 0) {

568 
±_ªgs
 *
ªgs
 = 
	`èsk_±_ªgs
(
tsk
);

570 
ªt
 = -
EINVAL
;

571 i‡(
	`vÆid_u£r_ªgs
(&
√wªgs
)) {

572 *
ªgs
 = 
√wªgs
;

573 
ªt
 = 0;

577  
ªt
;

578 
	}
}

583 
	$±ø˚_gëÂªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

585  
	`c›y_to_u£r
(
uÂ
, &
	`èsk_thªad_öfo
(
tsk
)->
Â°©e
,

586 (
u£r_Â
)Ë? -
EFAULT
 : 0;

587 
	}
}

592 
	$±ø˚_£tÂªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

594 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
tsk
);

595 
thªad
->
u£d_˝
[1] =Åhread->used_cp[2] = 1;

596  
	`c›y_‰om_u£r
(&
thªad
->
Â°©e
, 
uÂ
,

597 (
u£r_Â
)Ë? -
EFAULT
 : 0;

598 
	}
}

600 #ifde‡
CONFIG_IWMMXT


605 
	$±ø˚_gëwmmxªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

607 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
tsk
);

609 i‡(!
	`ã°_ti_thªad_Êag
(
thªad
, 
TIF_USING_IWMMXT
))

610  -
ENODATA
;

611 
	`iwmmxt_èsk_dißbÀ
(
thªad
);

612  
	`c›y_to_u£r
(
uÂ
, &
thªad
->
Â°©e
.
iwmmxt
, 
IWMMXT_SIZE
)

613 ? -
EFAULT
 : 0;

614 
	}
}

619 
	$±ø˚_£twmmxªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

621 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
tsk
);

623 i‡(!
	`ã°_ti_thªad_Êag
(
thªad
, 
TIF_USING_IWMMXT
))

624  -
EACCES
;

625 
	`iwmmxt_èsk_ªÀa£
(
thªad
);

626  
	`c›y_‰om_u£r
(&
thªad
->
Â°©e
.
iwmmxt
, 
uÂ
, 
IWMMXT_SIZE
)

627 ? -
EFAULT
 : 0;

628 
	}
}

632 #ifde‡
CONFIG_CRUNCH


636 
	$±ø˚_gë¸unchªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

638 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
tsk
);

640 
	`¸unch_èsk_dißbÀ
(
thªad
);

641  
	`c›y_to_u£r
(
uÂ
, &
thªad
->
¸unch°©e
, 
CRUNCH_SIZE
)

642 ? -
EFAULT
 : 0;

643 
	}
}

648 
	$±ø˚_£t¸unchªgs
(
èsk_°ru˘
 *
tsk
, 
__u£r
 *
uÂ
)

650 
thªad_öfo
 *
thªad
 = 
	`èsk_thªad_öfo
(
tsk
);

652 
	`¸unch_èsk_ªÀa£
(
thªad
);

653  
	`c›y_‰om_u£r
(&
thªad
->
¸unch°©e
, 
uÂ
, 
CRUNCH_SIZE
)

654 ? -
EFAULT
 : 0;

655 
	}
}

658 
	$¨ch_±ø˚
(
èsk_°ru˘
 *
chûd
, 
ªque°
, 
addr
, 
d©a
)

660 
tmp
;

661 
ªt
;

663 
ªque°
) {

667 
PTRACE_PEEKTEXT
:

668 
PTRACE_PEEKDATA
:

669 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, &
tmp
,

671 i‡(
ªt
 == ())

672 
ªt
 = 
	`put_u£r
(
tmp
, (
__u£r
 *Ë
d©a
);

674 
ªt
 = -
EIO
;

677 
PTRACE_PEEKUSR
:

678 
ªt
 = 
	`±ø˚_ªad_u£r
(
chûd
, 
addr
, (
__u£r
 *)
d©a
);

684 
PTRACE_POKETEXT
:

685 
PTRACE_POKEDATA
:

686 
ªt
 = 
	`ac˚ss_¥o˚ss_vm
(
chûd
, 
addr
, &
d©a
,

688 i‡(
ªt
 == ())

689 
ªt
 = 0;

691 
ªt
 = -
EIO
;

694 
PTRACE_POKEUSR
:

695 
ªt
 = 
	`±ø˚_wrôe_u£r
(
chûd
, 
addr
, 
d©a
);

701 
PTRACE_SYSCALL
:

702 
PTRACE_CONT
:

703 
ªt
 = -
EIO
;

704 i‡(!
	`vÆid_sig«l
(
d©a
))

706 i‡(
ªque°
 =
PTRACE_SYSCALL
)

707 
	`£t_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

709 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

710 
chûd
->
exô_code
 = 
d©a
;

711 
	`sögÀ_°ï_dißbÀ
(
chûd
);

712 
	`wake_up_¥o˚ss
(
chûd
);

713 
ªt
 = 0;

721 
PTRACE_KILL
:

722 
	`sögÀ_°ï_dißbÀ
(
chûd
);

723 i‡(
chûd
->
exô_°©e
 !
EXIT_ZOMBIE
) {

724 
chûd
->
exô_code
 = 
SIGKILL
;

725 
	`wake_up_¥o˚ss
(
chûd
);

727 
ªt
 = 0;

733 
PTRACE_SINGLESTEP
:

734 
ªt
 = -
EIO
;

735 i‡(!
	`vÆid_sig«l
(
d©a
))

737 
	`sögÀ_°ï_íabÀ
(
chûd
);

738 
	`˛ór_tsk_thªad_Êag
(
chûd
, 
TIF_SYSCALL_TRACE
);

739 
chûd
->
exô_code
 = 
d©a
;

741 
	`wake_up_¥o˚ss
(
chûd
);

742 
ªt
 = 0;

745 
PTRACE_DETACH
:

746 
ªt
 = 
	`±ø˚_dëach
(
chûd
, 
d©a
);

749 
PTRACE_GETREGS
:

750 
ªt
 = 
	`±ø˚_gëªgs
(
chûd
, (
__u£r
 *)
d©a
);

753 
PTRACE_SETREGS
:

754 
ªt
 = 
	`±ø˚_£åegs
(
chûd
, (
__u£r
 *)
d©a
);

757 
PTRACE_GETFPREGS
:

758 
ªt
 = 
	`±ø˚_gëÂªgs
(
chûd
, (
__u£r
 *)
d©a
);

761 
PTRACE_SETFPREGS
:

762 
ªt
 = 
	`±ø˚_£tÂªgs
(
chûd
, (
__u£r
 *)
d©a
);

765 #ifde‡
CONFIG_IWMMXT


766 
PTRACE_GETWMMXREGS
:

767 
ªt
 = 
	`±ø˚_gëwmmxªgs
(
chûd
, (
__u£r
 *)
d©a
);

770 
PTRACE_SETWMMXREGS
:

771 
ªt
 = 
	`±ø˚_£twmmxªgs
(
chûd
, (
__u£r
 *)
d©a
);

775 
PTRACE_GET_THREAD_AREA
:

776 
ªt
 = 
	`put_u£r
(
	`èsk_thªad_öfo
(
chûd
)->
ç_vÆue
,

777 (
__u£r
 *Ë
d©a
);

780 
PTRACE_SET_SYSCALL
:

781 
	`èsk_thªad_öfo
(
chûd
)->
sysˇŒ
 = 
d©a
;

782 
ªt
 = 0;

785 #ifde‡
CONFIG_CRUNCH


786 
PTRACE_GETCRUNCHREGS
:

787 
ªt
 = 
	`±ø˚_gë¸unchªgs
(
chûd
, (
__u£r
 *)
d©a
);

790 
PTRACE_SETCRUNCHREGS
:

791 
ªt
 = 
	`±ø˚_£t¸unchªgs
(
chûd
, (
__u£r
 *)
d©a
);

796 
ªt
 = 
	`±ø˚_ªque°
(
chûd
, 
ªque°
, 
addr
, 
d©a
);

800  
ªt
;

801 
	}
}

803 
asmlökage
 
	$sysˇŒ_åa˚
(
why
, 
±_ªgs
 *
ªgs
, 
s˙o
)

805 
ù
;

807 i‡(!
	`ã°_thªad_Êag
(
TIF_SYSCALL_TRACE
))

808  
s˙o
;

809 i‡(!(
cuºít
->
±ø˚
 & 
PT_PTRACED
))

810  
s˙o
;

816 
ù
 = 
ªgs
->
ARM_ù
;

817 
ªgs
->
ARM_ù
 = 
why
;

819 
	`cuºít_thªad_öfo
()->
sysˇŒ
 = 
s˙o
;

823 
	`±ø˚_nŸify
(
SIGTRAP
 | ((
cuºít
->
±ø˚
 & 
PT_TRACESYSGOOD
)

830 i‡(
cuºít
->
exô_code
) {

831 
	`£nd_sig
(
cuºít
->
exô_code
, current, 1);

832 
cuºít
->
exô_code
 = 0;

834 
ªgs
->
ARM_ù
 = 
ù
;

836  
	`cuºít_thªad_öfo
()->
sysˇŒ
;

837 
	}
}

	@arch/arm/kernel/ptrace.h

10 
	~<löux/±ø˚.h
>

12 
±ø˚_ˇn˚l_b±
(
èsk_°ru˘
 *);

13 
±ø˚_£t_b±
(
èsk_°ru˘
 *);

14 
±ø˚_bªak
(
èsk_°ru˘
 *, 
±_ªgs
 *);

19 
ölöe
 
	$sögÀ_°ï_dißbÀ
(
èsk_°ru˘
 *
èsk
)

21 
èsk
->
±ø˚
 &~
PT_SINGLESTEP
;

22 
	`±ø˚_ˇn˚l_b±
(
èsk
);

23 
	}
}

25 
ölöe
 
	$sögÀ_°ï_íabÀ
(
èsk_°ru˘
 *
èsk
)

27 
èsk
->
±ø˚
 |
PT_SINGLESTEP
;

28 
	}
}

33 
ölöe
 
	$sögÀ_°ï_å≠
(
èsk_°ru˘
 *
èsk
)

35 i‡(
èsk
->
±ø˚
 & 
PT_SINGLESTEP
) {

36 
	`±ø˚_ˇn˚l_b±
(
èsk
);

37 
	`£nd_sig
(
SIGTRAP
, 
èsk
, 1);

39 
	}
}

41 
ölöe
 
	$sögÀ_°ï_˛ór
(
èsk_°ru˘
 *
èsk
)

43 i‡(
èsk
->
±ø˚
 & 
PT_SINGLESTEP
)

44 
	`±ø˚_ˇn˚l_b±
(
èsk
);

45 
	}
}

47 
ölöe
 
	$sögÀ_°ï_£t
(
èsk_°ru˘
 *
èsk
)

49 i‡(
èsk
->
±ø˚
 & 
PT_SINGLESTEP
)

50 
	`±ø˚_£t_b±
(
èsk
);

51 
	}
}

	@arch/arm/kernel/semaphore.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/öô.h
>

19 
	~<asm/£m≠h‹e.h
>

52 
	$__up
(
£m≠h‹e
 *
£m
)

54 
	`wake_up
(&
£m
->
waô
);

55 
	}
}

57 
DEFINE_SPINLOCK
(
£m≠h‹e_lock
);

59 
__sched
 
	$__down
(
£m≠h‹e
 * 
£m
)

61 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

62 
	`DECLARE_WAITQUEUE
(
waô
, 
tsk
);

63 
tsk
->
°©e
 = 
TASK_UNINTERRUPTIBLE
;

64 
	`add_waô_queue_ex˛usive
(&
£m
->
waô
, &wait);

66 
	`•ö_lock_úq
(&
£m≠h‹e_lock
);

67 
£m
->
¶ì≥rs
++;

69 
¶ì≥rs
 = 
£m
->sleepers;

75 i‡(!
	`©omic_add_√g©ive
(
¶ì≥rs
 - 1, &
£m
->
cou¡
)) {

76 
£m
->
¶ì≥rs
 = 0;

79 
£m
->
¶ì≥rs
 = 1;

80 
	`•ö_u∆ock_úq
(&
£m≠h‹e_lock
);

82 
	`scheduÀ
();

83 
tsk
->
°©e
 = 
TASK_UNINTERRUPTIBLE
;

84 
	`•ö_lock_úq
(&
£m≠h‹e_lock
);

86 
	`•ö_u∆ock_úq
(&
£m≠h‹e_lock
);

87 
	`ªmove_waô_queue
(&
£m
->
waô
, &wait);

88 
tsk
->
°©e
 = 
TASK_RUNNING
;

89 
	`wake_up
(&
£m
->
waô
);

90 
	}
}

92 
__sched
 
	$__down_öãºu±ibÀ
(
£m≠h‹e
 * 
£m
)

94 
ªtvÆ
 = 0;

95 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

96 
	`DECLARE_WAITQUEUE
(
waô
, 
tsk
);

97 
tsk
->
°©e
 = 
TASK_INTERRUPTIBLE
;

98 
	`add_waô_queue_ex˛usive
(&
£m
->
waô
, &wait);

100 
	`•ö_lock_úq
(&
£m≠h‹e_lock
);

101 
£m
->
¶ì≥rs
 ++;

103 
¶ì≥rs
 = 
£m
->sleepers;

112 i‡(
	`sig«l_≥ndög
(
cuºít
)) {

113 
ªtvÆ
 = -
EINTR
;

114 
£m
->
¶ì≥rs
 = 0;

115 
	`©omic_add
(
¶ì≥rs
, &
£m
->
cou¡
);

125 i‡(!
	`©omic_add_√g©ive
(
¶ì≥rs
 - 1, &
£m
->
cou¡
)) {

126 
£m
->
¶ì≥rs
 = 0;

129 
£m
->
¶ì≥rs
 = 1;

130 
	`•ö_u∆ock_úq
(&
£m≠h‹e_lock
);

132 
	`scheduÀ
();

133 
tsk
->
°©e
 = 
TASK_INTERRUPTIBLE
;

134 
	`•ö_lock_úq
(&
£m≠h‹e_lock
);

136 
	`•ö_u∆ock_úq
(&
£m≠h‹e_lock
);

137 
tsk
->
°©e
 = 
TASK_RUNNING
;

138 
	`ªmove_waô_queue
(&
£m
->
waô
, &wait);

139 
	`wake_up
(&
£m
->
waô
);

140  
ªtvÆ
;

141 
	}
}

151 
	$__down_åylock
(
£m≠h‹e
 * 
£m
)

153 
¶ì≥rs
;

154 
Êags
;

156 
	`•ö_lock_úqßve
(&
£m≠h‹e_lock
, 
Êags
);

157 
¶ì≥rs
 = 
£m
->sleepers + 1;

158 
£m
->
¶ì≥rs
 = 0;

164 i‡(!
	`©omic_add_√g©ive
(
¶ì≥rs
, &
£m
->
cou¡
))

165 
	`wake_up
(&
£m
->
waô
);

167 
	`•ö_u∆ock_úqª°‹e
(&
£m≠h‹e_lock
, 
Êags
);

169 
	}
}

182 
asm
(" .section .sched.text,\"ax\",%progbits \n\
.align 5 \n\
.globl __down_failed \n\
__down_failed: \n\
 sp!, {r0 -Ñ4,Ür} \n\
Ñ0, ip \n\
 __down \n\
 sp!, {r0 -Ñ4,Öc} \n\
\n\
.align 5 \n\
.globl __down_interruptible_failed \n\
__down_interruptible_failed: \n\
 sp!, {r0 -Ñ4,Ür} \n\
Ñ0, ip \n\
 __down_interruptible \n\
 ip,Ñ0 \n\
 sp!, {r0 -Ñ4,Öc} \n\
\n\
.align 5 \n\
.globl __down_trylock_failed \n\
__down_trylock_failed: \n\
 sp!, {r0 -Ñ4,Ür} \n\
Ñ0, ip \n\
 __down_trylock \n\
 ip,Ñ0 \n\
 sp!, {r0 -Ñ4,Öc} \n\
\n\
.align 5 \n\
.globl __up_wakeup \n\
__up_wakeup: \n\
 sp!, {r0 -Ñ4,Ür} \n\
Ñ0, ip \n\
 __up \n\
 sp!, {r0 -Ñ4,Öc} \n\
");

218 
EXPORT_SYMBOL
(
__down_Áûed
);

219 
EXPORT_SYMBOL
(
__down_öãºu±ibÀ_Áûed
);

220 
EXPORT_SYMBOL
(
__down_åylock_Áûed
);

221 
EXPORT_SYMBOL
(
__up_wakeup
);

	@arch/arm/kernel/setup.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/°ddef.h
>

13 
	~<löux/i›‹t.h
>

14 
	~<löux/dñay.h
>

15 
	~<löux/ut¢ame.h
>

16 
	~<löux/öôrd.h
>

17 
	~<löux/c⁄sﬁe.h
>

18 
	~<löux/boŸmem.h
>

19 
	~<löux/£q_fûe.h
>

20 
	~<löux/s¸ìn_öfo.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/roŸ_dev.h
>

23 
	~<löux/˝u.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/smp.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/ñf.h
>

29 
	~<asm/¥ocöfo.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/ˇcheÊush.h
>

33 
	~<asm/ébÊush.h
>

35 
	~<asm/mach/¨ch.h
>

36 
	~<asm/mach/úq.h
>

37 
	~<asm/mach/time.h
>

39 
	~"com∑t.h
"

41 #i‚de‡
MEM_SIZE


42 
	#MEM_SIZE
 (16*1024*1024)

	)

45 #i‡
deföed
(
CONFIG_FPE_NWFPE
Ë|| deföed(
CONFIG_FPE_FASTFPE
)

46 
	gÂe_ty≥
[8];

48 
__öô
 
	$Âe_£tup
(*
löe
)

50 
	`mem˝y
(
Âe_ty≥
, 
löe
, 8);

52 
	}
}

54 
__£tup
("Âe=", 
Âe_£tup
);

57 
∑gög_öô
(
memöfo
 *, 
machöe_desc
 *
desc
);

58 
ªboŸ_£tup
(*
°r
);

59 
roŸ_mou¡Êags
;

60 
_°ext
, 
_ãxt
, 
_ëext
, 
__d©a_°¨t
, 
_ed©a
, 
_íd
;

62 
	g¥o˚ss‹_id
;

63 
	g__machöe_¨ch_ty≥
;

64 
EXPORT_SYMBOL
(
__machöe_¨ch_ty≥
);

66 
	gsy°em_ªv
;

67 
EXPORT_SYMBOL
(
sy°em_ªv
);

69 
	gsy°em_£rül_low
;

70 
EXPORT_SYMBOL
(
sy°em_£rül_low
);

72 
	gsy°em_£rül_high
;

73 
EXPORT_SYMBOL
(
sy°em_£rül_high
);

75 
	gñf_hwˇp
;

76 
EXPORT_SYMBOL
(
ñf_hwˇp
);

79 #ifde‡
MULTI_CPU


80 
¥o˚ss‹
 
	g¥o˚ss‹
;

82 #ifde‡
MULTI_TLB


83 
˝u_éb_‚s
 
	g˝u_éb
;

85 #ifde‡
MULTI_USER


86 
˝u_u£r_‚s
 
	g˝u_u£r
;

88 #ifde‡
MULTI_CACHE


89 
˝u_ˇche_‚s
 
	g˝u_ˇche
;

91 #ifde‡
CONFIG_OUTER_CACHE


92 
ouãr_ˇche_‚s
 
	gouãr_ˇche
;

95 
	s°ack
 {

96 
u32
 
	múq
[3];

97 
u32
 
	mabt
[3];

98 
u32
 
	mund
[3];

99 } 
	g____ˇchñöe_Æig√d
;

101 
°ack
 
	g°acks
[
NR_CPUS
];

103 
	gñf_∂©f‹m
[
ELF_PLATFORM_SIZE
];

104 
EXPORT_SYMBOL
(
ñf_∂©f‹m
);

106 
phys_öôrd_°¨t
 
	g__öôd©a
 = 0;

107 
phys_öôrd_size
 
	g__öôd©a
 = 0;

109 
memöfo
 memöfÿ
	g__öôd©a
 = { 0, };

110 c⁄° *
	g˝u_«me
;

111 c⁄° *
	gmachöe_«me
;

112 
__öôd©a
 
	gcomm™d_löe
[
COMMAND_LINE_SIZE
];

114 
	gdeÁu…_comm™d_löe
[
COMMAND_LINE_SIZE
] 
	g__öôd©a
 = 
CONFIG_CMDLINE
;

115 uni⁄ { 
	mc
[4]; 
	ml
; } 
ídün_ã°
 
	g__öôd©a
 = { { 'l', '?', '?', 'b' } };

116 
	#ENDIANNESS
 (()
ídün_ã°
.
l
)

	)

118 
DEFINE_PER_CPU
(
˝uöfo_¨m
, 
˝u_d©a
);

123 
ªsour˚
 
	gmem_ªs
[] = {

125 .
«me
 = "Video RAM",

126 .
	g°¨t
 = 0,

127 .
	gíd
 = 0,

128 .
	gÊags
 = 
IORESOURCE_MEM


131 .
	g«me
 = "KernelÅext",

132 .
	g°¨t
 = 0,

133 .
	gíd
 = 0,

134 .
	gÊags
 = 
IORESOURCE_MEM


137 .
	g«me
 = "Kernel data",

138 .
	g°¨t
 = 0,

139 .
	gíd
 = 0,

140 .
	gÊags
 = 
IORESOURCE_MEM


144 
	#video_øm
 
mem_ªs
[0]

	)

145 
	#kî√l_code
 
mem_ªs
[1]

	)

146 
	#kî√l_d©a
 
mem_ªs
[2]

	)

148 
ªsour˚
 
	gio_ªs
[] = {

150 .
«me
 = "reserved",

151 .
	g°¨t
 = 0x3bc,

152 .
	gíd
 = 0x3be,

153 .
	gÊags
 = 
IORESOURCE_IO
 | 
IORESOURCE_BUSY


156 .
	g«me
 = "reserved",

157 .
	g°¨t
 = 0x378,

158 .
	gíd
 = 0x37f,

159 .
	gÊags
 = 
IORESOURCE_IO
 | 
IORESOURCE_BUSY


162 .
	g«me
 = "reserved",

163 .
	g°¨t
 = 0x278,

164 .
	gíd
 = 0x27f,

165 .
	gÊags
 = 
IORESOURCE_IO
 | 
IORESOURCE_BUSY


169 
	#Õ0
 
io_ªs
[0]

	)

170 
	#Õ1
 
io_ªs
[1]

	)

171 
	#Õ2
 
io_ªs
[2]

	)

173 c⁄° *
	gˇche_ty≥s
[16] = {

192 c⁄° *
	gˇche_˛ón
[16] = {

211 c⁄° *
	gˇche_lockdown
[16] = {

230 c⁄° *
	g¥oc_¨ch
[] = {

250 
	#CACHE_TYPE
(
x
Ë(((xË>> 25Ë& 15)

	)

251 
	#CACHE_S
(
x
Ë((xË& (1 << 24))

	)

252 
	#CACHE_DSIZE
(
x
Ë(((xË>> 12Ë& 4095Ë

	)

253 
	#CACHE_ISIZE
(
x
Ë((xË& 4095)

	)

255 
	#CACHE_SIZE
(
y
Ë(((yË>> 6Ë& 7)

	)

256 
	#CACHE_ASSOC
(
y
Ë(((yË>> 3Ë& 7)

	)

257 
	#CACHE_M
(
y
Ë((yË& (1 << 2))

	)

258 
	#CACHE_LINE
(
y
Ë((yË& 3)

	)

260 
ölöe
 
	$dump_ˇche
(c⁄° *
¥efix
, 
˝u
, 
ˇche
)

262 
mu…
 = 2 + (
	`CACHE_M
(
ˇche
) ? 1 : 0);

264 
	`¥ötk
("CPU%u: %s: %d bytes,ássociativity %d, %d byteÜines, %d sets\n",

265 
˝u
, 
¥efix
,

266 
mu…
 << (8 + 
	`CACHE_SIZE
(
ˇche
)),

267 (
mu…
 << 
	`CACHE_ASSOC
(
ˇche
)) >> 1,

268 8 << 
	`CACHE_LINE
(
ˇche
),

269 1 << (6 + 
	`CACHE_SIZE
(
ˇche
Ë- 
	`CACHE_ASSOC
(cache) -

270 
	`CACHE_LINE
(
ˇche
)));

271 
	}
}

273 
__öô
 
	$dump_˝u_öfo
(
˝u
)

275 
öfo
 = 
	`ªad_˝uid
(
CPUID_CACHETYPE
);

277 i‡(
öfo
 !
¥o˚ss‹_id
) {

278 
	`¥ötk
("CPU%u: D %†%†ˇche\n", 
˝u
, 
	`ˇche_is_vivt
() ? "VIVT" : "VIPT",

279 
ˇche_ty≥s
[
	`CACHE_TYPE
(
öfo
)]);

280 i‡(
	`CACHE_S
(
öfo
)) {

281 
	`dump_ˇche
("I cache", 
˝u
, 
	`CACHE_ISIZE
(
öfo
));

282 
	`dump_ˇche
("D cache", 
˝u
, 
	`CACHE_DSIZE
(
öfo
));

284 
	`dump_ˇche
("ˇche", 
˝u
, 
	`CACHE_ISIZE
(
öfo
));

288 i‡(
	`¨ch_is_cohîít
())

289 
	`¥ötk
("Cache coherencyÉnabled\n");

290 
	}
}

292 
	$˝u_¨chôe˘uª
()

294 
˝u_¨ch
;

296 i‡((
¥o˚ss‹_id
 & 0x0008f000) == 0) {

297 
˝u_¨ch
 = 
CPU_ARCH_UNKNOWN
;

298 } i‡((
¥o˚ss‹_id
 & 0x0008f000) == 0x00007000) {

299 
˝u_¨ch
 = (
¥o˚ss‹_id
 & (1 << 23)Ë? 
CPU_ARCH_ARMv4T
 : 
CPU_ARCH_ARMv3
;

300 } i‡((
¥o˚ss‹_id
 & 0x00080000) == 0x00000000) {

301 
˝u_¨ch
 = (
¥o˚ss‹_id
 >> 16) & 7;

302 i‡(
˝u_¨ch
)

303 
˝u_¨ch
 +
CPU_ARCH_ARMv3
;

306 
˝u_¨ch
 = ((
¥o˚ss‹_id
 >> 12Ë& 0xfË- 0xb + 
CPU_ARCH_ARMv6
;

309  
˝u_¨ch
;

310 
	}
}

316 
¥oc_öfo_li°
 *
lookup_¥o˚ss‹_ty≥
();

317 
machöe_desc
 *
lookup_machöe_ty≥
();

319 
__öô
 
	$£tup_¥o˚ss‹
()

321 
¥oc_öfo_li°
 *
li°
;

328 
li°
 = 
	`lookup_¥o˚ss‹_ty≥
(
¥o˚ss‹_id
);

329 i‡(!
li°
) {

330 
	`¥ötk
("CPU configuration botched (ID %08x), unable "

331 "tÿc⁄töue.\n", 
¥o˚ss‹_id
);

335 
˝u_«me
 = 
li°
->cpu_name;

337 #ifde‡
MULTI_CPU


338 
¥o˚ss‹
 = *
li°
->
¥oc
;

340 #ifde‡
MULTI_TLB


341 
˝u_éb
 = *
li°
->
éb
;

343 #ifde‡
MULTI_USER


344 
˝u_u£r
 = *
li°
->
u£r
;

346 #ifde‡
MULTI_CACHE


347 
˝u_ˇche
 = *
li°
->
ˇche
;

350 
	`¥ötk
("CPU: %s [%08x]Ñevision %d (ARMv%s), cr=%08lx\n",

351 
˝u_«me
, 
¥o˚ss‹_id
, ()processor_id & 15,

352 
¥oc_¨ch
[
	`˝u_¨chôe˘uª
()], 
¸_Æignmít
);

354 
	`•rötf
(
	`öô_ut¢ame
()->
machöe
, "%s%c", 
li°
->
¨ch_«me
, 
ENDIANNESS
);

355 
	`•rötf
(
ñf_∂©f‹m
, "%s%c", 
li°
->
ñf_«me
, 
ENDIANNESS
);

356 
ñf_hwˇp
 = 
li°
->elf_hwcap;

357 #i‚de‡
CONFIG_ARM_THUMB


358 
ñf_hwˇp
 &~
HWCAP_THUMB
;

361 
	`˝u_¥oc_öô
();

362 
	}
}

370 
	$˝u_öô
()

372 
˝u
 = 
	`smp_¥o˚ss‹_id
();

373 
°ack
 *
°k
 = &
°acks
[
˝u
];

375 i‡(
˝u
 >
NR_CPUS
) {

376 
	`¥ötk
(
KERN_CRIT
 "CPU%u: badÖrim¨y CPUÇumbî\n", 
˝u
);

377 
	`BUG
();

380 i‡(
sy°em_°©e
 =
SYSTEM_BOOTING
)

381 
	`dump_˝u_öfo
(
˝u
);

386 
	`__asm__
 (

395 : "r" (
°k
),

396 "I" (
PSR_F_BIT
 | 
PSR_I_BIT
 | 
IRQ_MODE
),

397 "I" (
	`off£tof
(
°ack
, 
úq
[0])),

398 "I" (
PSR_F_BIT
 | 
PSR_I_BIT
 | 
ABT_MODE
),

399 "I" (
	`off£tof
(
°ack
, 
abt
[0])),

400 "I" (
PSR_F_BIT
 | 
PSR_I_BIT
 | 
UND_MODE
),

401 "I" (
	`off£tof
(
°ack
, 
und
[0])),

402 "I" (
PSR_F_BIT
 | 
PSR_I_BIT
 | 
SVC_MODE
)

404 
	}
}

406 
machöe_desc
 * 
__öô
 
	$£tup_machöe
(
ƒ
)

408 
machöe_desc
 *
li°
;

413 
li°
 = 
	`lookup_machöe_ty≥
(
ƒ
);

414 i‡(!
li°
) {

415 
	`¥ötk
("Machine configuration botched (nr %d), unable "

416 "tÿc⁄töue.\n", 
ƒ
);

420 
	`¥ötk
("Machöe: %s\n", 
li°
->
«me
);

422  
li°
;

423 
	}
}

425 
__öô
 
	$óæy_öôrd
(**
p
)

427 
°¨t
, 
size
;

429 
°¨t
 = 
	`mem∑r£
(*
p
,Ö);

430 i‡(**
p
 == ',') {

431 
size
 = 
	`mem∑r£
((*
p
) + 1,Ö);

433 
phys_öôrd_°¨t
 = 
°¨t
;

434 
phys_öôrd_size
 = 
size
;

436 
	}
}

437 
__óæy_∑øm
("öôrd=", 
óæy_öôrd
);

439 
__öô
 
	$¨m_add_mem‹y
(
°¨t
, 
size
)

441 
memb™k
 *
b™k
;

447 
size
 -
°¨t
 & ~
PAGE_MASK
;

449 
b™k
 = &
memöfo
.b™k[memöfo.
ƒ_b™ks
++];

451 
b™k
->
°¨t
 = 
	`PAGE_ALIGN
(start);

452 
b™k
->
size
 = sizê& 
PAGE_MASK
;

453 
b™k
->
node
 = 
	`PHYS_TO_NID
(
°¨t
);

454 
	}
}

460 
__öô
 
	$óæy_mem
(**
p
)

462 
u£rmem
 
__öôd©a
 = 0;

463 
size
, 
°¨t
;

470 i‡(
u£rmem
 == 0) {

471 
u£rmem
 = 1;

472 
memöfo
.
ƒ_b™ks
 = 0;

475 
°¨t
 = 
PHYS_OFFSET
;

476 
size
 = 
	`mem∑r£
(*
p
,Ö);

477 i‡(**
p
 == '@')

478 
°¨t
 = 
	`mem∑r£
(*
p
 + 1,Ö);

480 
	`¨m_add_mem‹y
(
°¨t
, 
size
);

481 
	}
}

482 
__óæy_∑øm
("mem=", 
óæy_mem
);

487 
__öô
 
	$∑r£_cmdlöe
(**
cmdlöe_p
, *
‰om
)

489 
c
 = ' ', *
to
 = 
comm™d_löe
;

490 
Àn
 = 0;

493 i‡(
c
 == ' ') {

494 
óæy_∑øms
 
__óæy_begö
, 
__óæy_íd
;

495 
óæy_∑øms
 *
p
;

497 
p
 = &
__óæy_begö
;Ö < &
__óæy_íd
;Ö++) {

498 
Àn
 = 
	`°æí
(
p
->
¨g
);

500 i‡(
	`memcmp
(
‰om
, 
p
->
¨g
, 
Àn
) == 0) {

501 i‡(
to
 !
comm™d_löe
)

502 
to
 -= 1;

503 
‰om
 +
Àn
;

504 
p
->
	`‚
(&
‰om
);

506 *
‰om
 != ' ' && *from != '\0')

507 
‰om
++;

512 
c
 = *
‰om
++;

513 i‡(!
c
)

515 i‡(
COMMAND_LINE_SIZE
 <++
Àn
)

517 *
to
++ = 
c
;

519 *
to
 = '\0';

520 *
cmdlöe_p
 = 
comm™d_löe
;

521 
	}
}

523 
__öô


524 
	$£tup_ømdisk
(
dﬁﬂd
, 
¥om±
, 
image_°¨t
, 
rd_sz
)

526 #ifde‡
CONFIG_BLK_DEV_RAM


527 
rd_size
, 
rd_image_°¨t
, 
rd_¥om±
, 
rd_dﬁﬂd
;

529 
rd_image_°¨t
 = 
image_°¨t
;

530 
rd_¥om±
 = 
¥om±
;

531 
rd_dﬁﬂd
 = 
dﬁﬂd
;

533 i‡(
rd_sz
)

534 
rd_size
 = 
rd_sz
;

536 
	}
}

538 
__öô


539 
	$ªque°_°™d¨d_ªsour˚s
(
memöfo
 *
mi
, 
machöe_desc
 *
mdesc
)

541 
ªsour˚
 *
ªs
;

542 
i
;

544 
kî√l_code
.
°¨t
 = 
	`vút_to_phys
(&
_ãxt
);

545 
kî√l_code
.
íd
 = 
	`vút_to_phys
(&
_ëext
 - 1);

546 
kî√l_d©a
.
°¨t
 = 
	`vút_to_phys
(&
__d©a_°¨t
);

547 
kî√l_d©a
.
íd
 = 
	`vút_to_phys
(&
_íd
 - 1);

549 
i
 = 0; i < 
mi
->
ƒ_b™ks
; i++) {

550 
vút_°¨t
, 
vút_íd
;

552 i‡(
mi
->
b™k
[
i
].
size
 == 0)

555 
vút_°¨t
 = 
	`__phys_to_vút
(
mi
->
b™k
[
i
].
°¨t
);

556 
vút_íd
 = 
vút_°¨t
 + 
mi
->
b™k
[
i
].
size
 - 1;

558 
ªs
 = 
	`Æloc_boŸmem_low
((*res));

559 
ªs
->
«me
 = "System RAM";

560 
ªs
->
°¨t
 = 
	`__vút_to_phys
(
vút_°¨t
);

561 
ªs
->
íd
 = 
	`__vút_to_phys
(
vút_íd
);

562 
ªs
->
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_BUSY
;

564 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, 
ªs
);

566 i‡(
kî√l_code
.
°¨t
 >
ªs
->start &&

567 
kî√l_code
.
íd
 <
ªs
->end)

568 
	`ªque°_ªsour˚
(
ªs
, &
kî√l_code
);

569 i‡(
kî√l_d©a
.
°¨t
 >
ªs
->start &&

570 
kî√l_d©a
.
íd
 <
ªs
->end)

571 
	`ªque°_ªsour˚
(
ªs
, &
kî√l_d©a
);

574 i‡(
mdesc
->
video_°¨t
) {

575 
video_øm
.
°¨t
 = 
mdesc
->
video_°¨t
;

576 
video_øm
.
íd
 = 
mdesc
->
video_íd
;

577 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
video_øm
);

584 i‡(
mdesc
->
ª£rve_Õ0
)

585 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
Õ0
);

586 i‡(
mdesc
->
ª£rve_Õ1
)

587 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
Õ1
);

588 i‡(
mdesc
->
ª£rve_Õ2
)

589 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
Õ2
);

590 
	}
}

602 
__öô
 
	$∑r£_èg_c‹e
(c⁄° 
èg
 *tag)

604 i‡(
èg
->
hdr
.
size
 > 2) {

605 i‡((
èg
->
u
.
c‹e
.
Êags
 & 1) == 0)

606 
roŸ_mou¡Êags
 &~
MS_RDONLY
;

607 
ROOT_DEV
 = 
	`ﬁd_decode_dev
(
èg
->
u
.
c‹e
.
roŸdev
);

610 
	}
}

612 
__ègèbÀ
(
ATAG_CORE
, 
∑r£_èg_c‹e
);

614 
__öô
 
	$∑r£_èg_mem32
(c⁄° 
èg
 *tag)

616 i‡(
memöfo
.
ƒ_b™ks
 >
NR_BANKS
) {

617 
	`¥ötk
(
KERN_WARNING


619 
èg
->
u
.
mem
.
°¨t
,Åag->u.mem.
size
 / 1024);

620  -
EINVAL
;

622 
	`¨m_add_mem‹y
(
èg
->
u
.
mem
.
°¨t
,Åag->u.mem.
size
);

624 
	}
}

626 
__ègèbÀ
(
ATAG_MEM
, 
∑r£_èg_mem32
);

628 #i‡
deföed
(
CONFIG_VGA_CONSOLE
Ë|| deföed(
CONFIG_DUMMY_CONSOLE
)

629 
s¸ìn_öfo
 
	gs¸ìn_öfo
 = {

630 .
‹ig_video_löes
 = 30,

631 .
	g‹ig_video_cﬁs
 = 80,

632 .
	g‹ig_video_mode
 = 0,

633 .
	g‹ig_video_ega_bx
 = 0,

634 .
	g‹ig_video_isVGA
 = 1,

635 .
	g‹ig_video_poöts
 = 8

638 
__öô
 
	$∑r£_èg_videŸext
(c⁄° 
èg
 *tag)

640 
s¸ìn_öfo
.
‹ig_x
 = 
èg
->
u
.
videŸext
.
x
;

641 
s¸ìn_öfo
.
‹ig_y
 = 
èg
->
u
.
videŸext
.
y
;

642 
s¸ìn_öfo
.
‹ig_video_∑ge
 = 
èg
->
u
.
videŸext
.
video_∑ge
;

643 
s¸ìn_öfo
.
‹ig_video_mode
 = 
èg
->
u
.
videŸext
.
video_mode
;

644 
s¸ìn_öfo
.
‹ig_video_cﬁs
 = 
èg
->
u
.
videŸext
.
video_cﬁs
;

645 
s¸ìn_öfo
.
‹ig_video_ega_bx
 = 
èg
->
u
.
videŸext
.
video_ega_bx
;

646 
s¸ìn_öfo
.
‹ig_video_löes
 = 
èg
->
u
.
videŸext
.
video_löes
;

647 
s¸ìn_öfo
.
‹ig_video_isVGA
 = 
èg
->
u
.
videŸext
.
video_isvga
;

648 
s¸ìn_öfo
.
‹ig_video_poöts
 = 
èg
->
u
.
videŸext
.
video_poöts
;

650 
	}
}

652 
__ègèbÀ
(
ATAG_VIDEOTEXT
, 
∑r£_èg_videŸext
);

655 
__öô
 
	$∑r£_èg_ømdisk
(c⁄° 
èg
 *tag)

657 
	`£tup_ømdisk
((
èg
->
u
.
ømdisk
.
Êags
 & 1) == 0,

658 (
èg
->
u
.
ømdisk
.
Êags
 & 2) == 0,

659 
èg
->
u
.
ømdisk
.
°¨t
,Åag->u.ømdisk.
size
);

661 
	}
}

663 
__ègèbÀ
(
ATAG_RAMDISK
, 
∑r£_èg_ømdisk
);

665 
__öô
 
	$∑r£_èg_öôrd
(c⁄° 
èg
 *tag)

667 
	`¥ötk
(
KERN_WARNING
 "ATAG_INITRD is deprecated; "

669 
phys_öôrd_°¨t
 = 
	`__vút_to_phys
(
èg
->
u
.
öôrd
.
°¨t
);

670 
phys_öôrd_size
 = 
èg
->
u
.
öôrd
.
size
;

672 
	}
}

674 
__ègèbÀ
(
ATAG_INITRD
, 
∑r£_èg_öôrd
);

676 
__öô
 
	$∑r£_èg_öôrd2
(c⁄° 
èg
 *tag)

678 
phys_öôrd_°¨t
 = 
èg
->
u
.
öôrd
.
°¨t
;

679 
phys_öôrd_size
 = 
èg
->
u
.
öôrd
.
size
;

681 
	}
}

683 
__ègèbÀ
(
ATAG_INITRD2
, 
∑r£_èg_öôrd2
);

685 
__öô
 
	$∑r£_èg_£rü r
(c⁄° 
èg
 *tag)

687 
sy°em_£rül_low
 = 
èg
->
u
.
£rü r
.
low
;

688 
sy°em_£rül_high
 = 
èg
->
u
.
£rü r
.
high
;

690 
	}
}

692 
__ègèbÀ
(
ATAG_SERIAL
, 
∑r£_èg_£rü r
);

694 
__öô
 
	$∑r£_èg_ªvisi⁄
(c⁄° 
èg
 *tag)

696 
sy°em_ªv
 = 
èg
->
u
.
ªvisi⁄
.
ªv
;

698 
	}
}

700 
__ègèbÀ
(
ATAG_REVISION
, 
∑r£_èg_ªvisi⁄
);

702 
__öô
 
	$∑r£_èg_cmdlöe
(c⁄° 
èg
 *tag)

704 
	`°æ˝y
(
deÁu…_comm™d_löe
, 
èg
->
u
.
cmdlöe
.cmdlöe, 
COMMAND_LINE_SIZE
);

706 
	}
}

708 
__ègèbÀ
(
ATAG_CMDLINE
, 
∑r£_èg_cmdlöe
);

715 
__öô
 
	$∑r£_èg
(c⁄° 
èg
 *tag)

717 
ègèbÀ
 
__ègèbÀ_begö
, 
__ègèbÀ_íd
;

718 
ègèbÀ
 *
t
;

720 
t
 = &
__ègèbÀ_begö
;Å < &
__ègèbÀ_íd
;Å++)

721 i‡(
èg
->
hdr
.èg =
t
->tag) {

722 
t
->
	`∑r£
(
èg
);

726  
t
 < &
__ègèbÀ_íd
;

727 
	}
}

733 
__öô
 
	$∑r£_ègs
(c⁄° 
èg
 *
t
)

735 ; 
t
->
hdr
.
size
;Å = 
	`èg_√xt
(t))

736 i‡(!
	`∑r£_èg
(
t
))

737 
	`¥ötk
(
KERN_WARNING


739 
t
->
hdr
.
èg
);

740 
	}
}

745 
	söô_ègs
 {

746 
èg_hódî
 
	mhdr1
;

747 
èg_c‹e
 
	mc‹e
;

748 
èg_hódî
 
	mhdr2
;

749 
èg_mem32
 
	mmem
;

750 
èg_hódî
 
	mhdr3
;

751 } 
öô_ègs
 
	g__öôd©a
 = {

752 { 
èg_size
(
èg_c‹e
), 
ATAG_CORE
 },

753 { 1, 
PAGE_SIZE
, 0xff },

754 { 
èg_size
(
èg_mem32
), 
ATAG_MEM
 },

755 { 
MEM_SIZE
, 
PHYS_OFFSET
 },

756 { 0, 
ATAG_NONE
 }

759 (*
öô_machöe
)(Ë
__öôd©a
;

761 
__öô
 
	$cu°omize_machöe
()

764 i‡(
öô_machöe
)

765 
	`öô_machöe
();

767 
	}
}

768 
¨ch_öôˇŒ
(
cu°omize_machöe
);

770 
__öô
 
	$£tup_¨ch
(**
cmdlöe_p
)

772 
èg
 *
ègs
 = (èg *)&
öô_ègs
;

773 
machöe_desc
 *
mdesc
;

774 *
‰om
 = 
deÁu…_comm™d_löe
;

776 
	`£tup_¥o˚ss‹
();

777 
mdesc
 = 
	`£tup_machöe
(
machöe_¨ch_ty≥
);

778 
machöe_«me
 = 
mdesc
->
«me
;

780 i‡(
mdesc
->
so·_ªboŸ
)

781 
	`ªboŸ_£tup
("s");

783 i‡(
mdesc
->
boŸ_∑øms
)

784 
ègs
 = 
	`phys_to_vút
(
mdesc
->
boŸ_∑øms
);

790 i‡(
ègs
->
hdr
.
èg
 !
ATAG_CORE
)

791 
	`c⁄vît_to_èg_li°
(
ègs
);

792 i‡(
ègs
->
hdr
.
èg
 !
ATAG_CORE
)

793 
ègs
 = (
èg
 *)&
öô_ègs
;

795 i‡(
mdesc
->
fixup
)

796 
mdesc
->
	`fixup
(mdesc, 
ègs
, &
‰om
, &
memöfo
);

798 i‡(
ègs
->
hdr
.
èg
 =
ATAG_CORE
) {

799 i‡(
memöfo
.
ƒ_b™ks
 != 0)

800 
	`squash_mem_ègs
(
ègs
);

801 
	`∑r£_ègs
(
ègs
);

804 
öô_mm
.
°¨t_code
 = (Ë&
_ãxt
;

805 
öô_mm
.
íd_code
 = (Ë&
_ëext
;

806 
öô_mm
.
íd_d©a
 = (Ë&
_ed©a
;

807 
öô_mm
.
brk
 = (Ë&
_íd
;

809 
	`mem˝y
(
boŸ_comm™d_löe
, 
‰om
, 
COMMAND_LINE_SIZE
);

810 
boŸ_comm™d_löe
[
COMMAND_LINE_SIZE
-1] = '\0';

811 
	`∑r£_cmdlöe
(
cmdlöe_p
, 
‰om
);

812 
	`∑gög_öô
(&
memöfo
, 
mdesc
);

813 
	`ªque°_°™d¨d_ªsour˚s
(&
memöfo
, 
mdesc
);

815 #ifde‡
CONFIG_SMP


816 
	`smp_öô_˝us
();

819 
	`˝u_öô
();

824 
öô_¨ch_úq
 = 
mdesc
->
öô_úq
;

825 
sy°em_timî
 = 
mdesc
->
timî
;

826 
öô_machöe
 = 
mdesc
->init_machine;

828 #ifde‡
CONFIG_VT


829 #i‡
	`deföed
(
CONFIG_VGA_CONSOLE
)

830 
c⁄swôchp
 = &
vga_c⁄
;

831 #ñi‡
	`deföed
(
CONFIG_DUMMY_CONSOLE
)

832 
c⁄swôchp
 = &
dummy_c⁄
;

835 
	}
}

838 
__öô
 
	$t›ﬁogy_öô
()

840 
˝u
;

842 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

843 
˝uöfo_¨m
 *
˝uöfo
 = &
	`≥r_˝u
(
˝u_d©a
, 
˝u
);

844 
˝uöfo
->
˝u
.
hŸ∂uggabÀ
 = 1;

845 
	`ªgi°î_˝u
(&
˝uöfo
->
˝u
, cpu);

849 
	}
}

851 
subsys_öôˇŒ
(
t›ﬁogy_öô
);

853 c⁄° *
	ghwˇp_°r
[] = {

865 
NULL


869 
	$c_show_ˇche
(
£q_fûe
 *
m
, c⁄° *
ty≥
, 
ˇche
)

871 
mu…
 = 2 + (
	`CACHE_M
(
ˇche
) ? 1 : 0);

873 
	`£q_¥ötf
(
m
, "%s size\t\t: %d\n"

877 
ty≥
, 
mu…
 << (8 + 
	`CACHE_SIZE
(
ˇche
)),

878 
ty≥
, (
mu…
 << 
	`CACHE_ASSOC
(
ˇche
)) >> 1,

879 
ty≥
, 8 << 
	`CACHE_LINE
(
ˇche
),

880 
ty≥
, 1 << (6 + 
	`CACHE_SIZE
(
ˇche
Ë- 
	`CACHE_ASSOC
(cache) -

881 
	`CACHE_LINE
(
ˇche
)));

882 
	}
}

884 
	$c_show
(
£q_fûe
 *
m
, *
v
)

886 
i
;

888 
	`£q_¥ötf
(
m
, "Processor\t: %sÑev %d (%s)\n",

889 
˝u_«me
, ()
¥o˚ss‹_id
 & 15, 
ñf_∂©f‹m
);

891 #i‡
	`deföed
(
CONFIG_SMP
)

892 
	`f‹_óch_⁄löe_˝u
(
i
) {

898 
	`£q_¥ötf
(
m
, "¥o˚ss‹\t: %d\n", 
i
);

899 
	`£q_¥ötf
(
m
, "BogoMIPS\t: %lu.%02lu\n\n",

900 
	`≥r_˝u
(
˝u_d©a
, 
i
).
lo›s_≥r_jiffy
 / (500000UL/
HZ
),

901 (
	`≥r_˝u
(
˝u_d©a
, 
i
).
lo›s_≥r_jiffy
 / (5000UL/
HZ
)) % 100);

904 
	`£q_¥ötf
(
m
, "BogoMIPS\t: %lu.%02lu\n",

905 
lo›s_≥r_jiffy
 / (500000/
HZ
),

906 (
lo›s_≥r_jiffy
 / (5000/
HZ
)) % 100);

910 
	`£q_puts
(
m
, "Features\t: ");

912 
i
 = 0; 
hwˇp_°r
[i]; i++)

913 i‡(
ñf_hwˇp
 & (1 << 
i
))

914 
	`£q_¥ötf
(
m
, "%†", 
hwˇp_°r
[
i
]);

916 
	`£q_¥ötf
(
m
, "\nCPU im∂emíãr\t: 0x%02x\n", 
¥o˚ss‹_id
 >> 24);

917 
	`£q_¥ötf
(
m
, "CPUárchôe˘uª: %s\n", 
¥oc_¨ch
[
	`˝u_¨chôe˘uª
()]);

919 i‡((
¥o˚ss‹_id
 & 0x0008f000) == 0x00000000) {

921 
	`£q_¥ötf
(
m
, "CPUÖ¨t\t: %07x\n", 
¥o˚ss‹_id
 >> 4);

923 i‡((
¥o˚ss‹_id
 & 0x0008f000) == 0x00007000) {

925 
	`£q_¥ötf
(
m
, "CPU variant\t: 0x%02x\n",

926 (
¥o˚ss‹_id
 >> 16) & 127);

929 
	`£q_¥ötf
(
m
, "CPU variant\t: 0x%x\n",

930 (
¥o˚ss‹_id
 >> 20) & 15);

932 
	`£q_¥ötf
(
m
, "CPUÖart\t: 0x%03x\n",

933 (
¥o˚ss‹_id
 >> 4) & 0xfff);

935 
	`£q_¥ötf
(
m
, "CPUÑevisi⁄\t: %d\n", 
¥o˚ss‹_id
 & 15);

938 
ˇche_öfo
 = 
	`ªad_˝uid
(
CPUID_CACHETYPE
);

939 i‡(
ˇche_öfo
 !
¥o˚ss‹_id
) {

940 
	`£q_¥ötf
(
m
, "CacheÅype\t: %s\n"

944 
ˇche_ty≥s
[
	`CACHE_TYPE
(
ˇche_öfo
)],

945 
ˇche_˛ón
[
	`CACHE_TYPE
(
ˇche_öfo
)],

946 
ˇche_lockdown
[
	`CACHE_TYPE
(
ˇche_öfo
)],

947 
	`CACHE_S
(
ˇche_öfo
) ? "Harvard" : "Unified");

949 i‡(
	`CACHE_S
(
ˇche_öfo
)) {

950 
	`c_show_ˇche
(
m
, "I", 
	`CACHE_ISIZE
(
ˇche_öfo
));

951 
	`c_show_ˇche
(
m
, "D", 
	`CACHE_DSIZE
(
ˇche_öfo
));

953 
	`c_show_ˇche
(
m
, "Cache", 
	`CACHE_ISIZE
(
ˇche_öfo
));

958 
	`£q_puts
(
m
, "\n");

960 
	`£q_¥ötf
(
m
, "H¨dw¨e\t: %s\n", 
machöe_«me
);

961 
	`£q_¥ötf
(
m
, "Revisi⁄\t: %04x\n", 
sy°em_ªv
);

962 
	`£q_¥ötf
(
m
, "Serial\t\t: %08x%08x\n",

963 
sy°em_£rül_high
, 
sy°em_£rül_low
);

966 
	}
}

968 *
	$c_°¨t
(
£q_fûe
 *
m
, 
loff_t
 *
pos
)

970  *
pos
 < 1 ? (*)1 : 
NULL
;

971 
	}
}

973 *
	$c_√xt
(
£q_fûe
 *
m
, *
v
, 
loff_t
 *
pos
)

975 ++*
pos
;

976  
NULL
;

977 
	}
}

979 
	$c_°›
(
£q_fûe
 *
m
, *
v
)

981 
	}
}

983 
£q_›î©i⁄s
 
	g˝uöfo_›
 = {

984 .
°¨t
 = 
c_°¨t
,

985 .
	g√xt
 = 
c_√xt
,

986 .
	g°›
 = 
c_°›
,

987 .
	gshow
 = 
c_show


	@arch/arm/kernel/signal.c

10 
	~<löux/î∫o.h
>

11 
	~<löux/sig«l.h
>

12 
	~<löux/≥rs⁄Æôy.h
>

13 
	~<löux/‰ìzî.h
>

15 
	~<asm/ñf.h
>

16 
	~<asm/ˇcheÊush.h
>

17 
	~<asm/uc⁄ãxt.h
>

18 
	~<asm/uac˚ss.h
>

19 
	~<asm/uni°d.h
>

21 
	~"±ø˚.h
"

22 
	~"sig«l.h
"

24 
	#_BLOCKABLE
 (~(
	`sigmask
(
SIGKILL
Ë| sigmask(
SIGSTOP
)))

	)

29 
	#SWI_SYS_SIGRETURN
 (0xef000000|(
__NR_sigªtu∫
))

	)

30 
	#SWI_SYS_RT_SIGRETURN
 (0xef000000|(
__NR_π_sigªtu∫
))

	)

35 
	#MOV_R7_NR_SIGRETURN
 (0xe3a07000 | (
__NR_sigªtu∫
 - 
__NR_SYSCALL_BASE
))

	)

36 
	#MOV_R7_NR_RT_SIGRETURN
 (0xe3a07000 | (
__NR_π_sigªtu∫
 - 
__NR_SYSCALL_BASE
))

	)

42 
	#SWI_THUMB_SIGRETURN
 (0xdf00 << 16 | 0x2700 | (
__NR_sigªtu∫
 - 
__NR_SYSCALL_BASE
))

	)

43 
	#SWI_THUMB_RT_SIGRETURN
 (0xdf00 << 16 | 0x2700 | (
__NR_π_sigªtu∫
 - 
__NR_SYSCALL_BASE
))

	)

45 c⁄° 
	gsigªtu∫_codes
[7] = {

46 
MOV_R7_NR_SIGRETURN
, 
SWI_SYS_SIGRETURN
, 
SWI_THUMB_SIGRETURN
,

47 
MOV_R7_NR_RT_SIGRETURN
, 
SWI_SYS_RT_SIGRETURN
, 
SWI_THUMB_RT_SIGRETURN
,

50 
do_sig«l
(
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 * 
ªgs
, 
sysˇŒ
);

55 
asmlökage
 
	$sys_sigsu•íd
(
ª°¨t
, 
ﬁdmask
, 
ﬁd_sig£t_t
 
mask
, 
±_ªgs
 *
ªgs
)

57 
sig£t_t
 
ßve£t
;

59 
mask
 &
_BLOCKABLE
;

60 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

61 
ßve£t
 = 
cuºít
->
blocked
;

62 
	`sigöô£t
(&
cuºít
->
blocked
, 
mask
);

63 
	`ªˇlc_sig≥ndög
();

64 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

65 
ªgs
->
ARM_r0
 = -
EINTR
;

68 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

69 
	`scheduÀ
();

70 i‡(
	`do_sig«l
(&
ßve£t
, 
ªgs
, 0))

71  
ªgs
->
ARM_r0
;

73 
	}
}

75 
asmlökage
 

76 
	$sys_π_sigsu•íd
(
sig£t_t
 
__u£r
 *
u√w£t
, 
size_t
 
sig£tsize
, 
±_ªgs
 *
ªgs
)

78 
sig£t_t
 
ßve£t
, 
√w£t
;

81 i‡(
sig£tsize
 !(
sig£t_t
))

82  -
EINVAL
;

84 i‡(
	`c›y_‰om_u£r
(&
√w£t
, 
u√w£t
, (newset)))

85  -
EFAULT
;

86 
	`sigdñ£tmask
(&
√w£t
, ~
_BLOCKABLE
);

88 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

89 
ßve£t
 = 
cuºít
->
blocked
;

90 
cuºít
->
blocked
 = 
√w£t
;

91 
	`ªˇlc_sig≥ndög
();

92 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

93 
ªgs
->
ARM_r0
 = -
EINTR
;

96 
cuºít
->
°©e
 = 
TASK_INTERRUPTIBLE
;

97 
	`scheduÀ
();

98 i‡(
	`do_sig«l
(&
ßve£t
, 
ªgs
, 0))

99  
ªgs
->
ARM_r0
;

101 
	}
}

103 
asmlökage
 

104 
	$sys_siga˘i⁄
(
sig
, c⁄° 
ﬁd_siga˘i⁄
 
__u£r
 *
a˘
,

105 
ﬁd_siga˘i⁄
 
__u£r
 *
ﬂ˘
)

107 
k_siga˘i⁄
 
√w_ka
, 
ﬁd_ka
;

108 
ªt
;

110 i‡(
a˘
) {

111 
ﬁd_sig£t_t
 
mask
;

112 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
a˘
, (*act)) ||

113 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_h™dÀr
, &
a˘
->sa_handler) ||

114 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_ª°‹î
, &
a˘
->sa_restorer))

115  -
EFAULT
;

116 
	`__gë_u£r
(
√w_ka
.
ß
.
ß_Êags
, &
a˘
->sa_flags);

117 
	`__gë_u£r
(
mask
, &
a˘
->
ß_mask
);

118 
	`sigöô£t
(&
√w_ka
.
ß
.
ß_mask
, 
mask
);

121 
ªt
 = 
	`do_siga˘i⁄
(
sig
, 
a˘
 ? &
√w_ka
 : 
NULL
, 
ﬂ˘
 ? &
ﬁd_ka
 : NULL);

123 i‡(!
ªt
 && 
ﬂ˘
) {

124 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
ﬂ˘
, (*oact)) ||

125 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_h™dÀr
, &
ﬂ˘
->sa_handler) ||

126 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_ª°‹î
, &
ﬂ˘
->sa_restorer))

127  -
EFAULT
;

128 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_Êags
, &
ﬂ˘
->sa_flags);

129 
	`__put_u£r
(
ﬁd_ka
.
ß
.
ß_mask
.
sig
[0], &
ﬂ˘
->sa_mask);

132  
ªt
;

133 
	}
}

135 #ifde‡
CONFIG_CRUNCH


136 
	$¥e£rve_¸unch_c⁄ãxt
(
¸unch_sig‰ame
 *
‰ame
)

138 
kbuf
[(*
‰ame
) + 8];

139 
¸unch_sig‰ame
 *
k‰ame
;

142 
k‰ame
 = (
¸unch_sig‰ame
 *)(()(
kbuf
 + 8) & ~7);

143 
k‰ame
->
magic
 = 
CRUNCH_MAGIC
;

144 
k‰ame
->
size
 = 
CRUNCH_STORAGE_SIZE
;

145 
	`¸unch_èsk_c›y
(
	`cuºít_thªad_öfo
(), &
k‰ame
->
°‹age
);

146  
	`__c›y_to_u£r
(
‰ame
, 
k‰ame
, (*frame));

147 
	}
}

149 
	$ª°‹e_¸unch_c⁄ãxt
(
¸unch_sig‰ame
 *
‰ame
)

151 
kbuf
[(*
‰ame
) + 8];

152 
¸unch_sig‰ame
 *
k‰ame
;

155 
k‰ame
 = (
¸unch_sig‰ame
 *)(()(
kbuf
 + 8) & ~7);

156 i‡(
	`__c›y_‰om_u£r
(
k‰ame
, 
‰ame
, (*frame)))

158 i‡(
k‰ame
->
magic
 !
CRUNCH_MAGIC
 ||

159 
k‰ame
->
size
 !
CRUNCH_STORAGE_SIZE
)

161 
	`¸unch_èsk_ª°‹e
(
	`cuºít_thªad_öfo
(), &
k‰ame
->
°‹age
);

163 
	}
}

166 #ifde‡
CONFIG_IWMMXT


168 
	$¥e£rve_iwmmxt_c⁄ãxt
(
iwmmxt_sig‰ame
 *
‰ame
)

170 
kbuf
[(*
‰ame
) + 8];

171 
iwmmxt_sig‰ame
 *
k‰ame
;

174 
k‰ame
 = (
iwmmxt_sig‰ame
 *)(()(
kbuf
 + 8) & ~7);

175 
k‰ame
->
magic
 = 
IWMMXT_MAGIC
;

176 
k‰ame
->
size
 = 
IWMMXT_STORAGE_SIZE
;

177 
	`iwmmxt_èsk_c›y
(
	`cuºít_thªad_öfo
(), &
k‰ame
->
°‹age
);

178  
	`__c›y_to_u£r
(
‰ame
, 
k‰ame
, (*frame));

179 
	}
}

181 
	$ª°‹e_iwmmxt_c⁄ãxt
(
iwmmxt_sig‰ame
 *
‰ame
)

183 
kbuf
[(*
‰ame
) + 8];

184 
iwmmxt_sig‰ame
 *
k‰ame
;

187 
k‰ame
 = (
iwmmxt_sig‰ame
 *)(()(
kbuf
 + 8) & ~7);

188 i‡(
	`__c›y_‰om_u£r
(
k‰ame
, 
‰ame
, (*frame)))

190 i‡(
k‰ame
->
magic
 !
IWMMXT_MAGIC
 ||

191 
k‰ame
->
size
 !
IWMMXT_STORAGE_SIZE
)

193 
	`iwmmxt_èsk_ª°‹e
(
	`cuºít_thªad_öfo
(), &
k‰ame
->
°‹age
);

195 
	}
}

202 
	ssig‰ame
 {

203 
uc⁄ãxt
 
	muc
;

204 
	mªtcode
[2];

207 
	sπ_sig‰ame
 {

208 
sigöfo
 
	möfo
;

209 
sig‰ame
 
	msig
;

212 
	$ª°‹e_sig‰ame
(
±_ªgs
 *
ªgs
, 
sig‰ame
 
__u£r
 *
sf
)

214 
aux_sig‰ame
 
__u£r
 *
aux
;

215 
sig£t_t
 
£t
;

216 
îr
;

218 
îr
 = 
	`__c›y_‰om_u£r
(&
£t
, &
sf
->
uc
.
uc_sigmask
, (set));

219 i‡(
îr
 == 0) {

220 
	`sigdñ£tmask
(&
£t
, ~
_BLOCKABLE
);

221 
	`•ö_lock_úq
(&
cuºít
->
sigh™d
->
siglock
);

222 
cuºít
->
blocked
 = 
£t
;

223 
	`ªˇlc_sig≥ndög
();

224 
	`•ö_u∆ock_úq
(&
cuºít
->
sigh™d
->
siglock
);

227 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r0
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r0
, 
îr
);

228 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r1
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r1
, 
îr
);

229 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r2
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r2
, 
îr
);

230 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r3
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r3
, 
îr
);

231 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r4
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r4
, 
îr
);

232 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r5
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r5
, 
îr
);

233 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r6
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r6
, 
îr
);

234 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r7
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r7
, 
îr
);

235 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r8
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r8
, 
îr
);

236 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r9
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r9
, 
îr
);

237 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_r10
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r10
, 
îr
);

238 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_Â
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_Â
, 
îr
);

239 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_ù
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_ù
, 
îr
);

240 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_•
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_•
, 
îr
);

241 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_Ã
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_Ã
, 
îr
);

242 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_pc
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_pc
, 
îr
);

243 
	`__gë_u£r_îr‹
(
ªgs
->
ARM_˝§
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_˝§
, 
îr
);

245 
îr
 |!
	`vÆid_u£r_ªgs
(
ªgs
);

247 
aux
 = (
aux_sig‰ame
 
__u£r
 *Ë
sf
->
uc
.
uc_ªg•a˚
;

248 #ifde‡
CONFIG_CRUNCH


249 i‡(
îr
 == 0)

250 
îr
 |
	`ª°‹e_¸unch_c⁄ãxt
(&
aux
->
¸unch
);

252 #ifde‡
CONFIG_IWMMXT


253 i‡(
îr
 =0 && 
	`ã°_thªad_Êag
(
TIF_USING_IWMMXT
))

254 
îr
 |
	`ª°‹e_iwmmxt_c⁄ãxt
(&
aux
->
iwmmxt
);

256 #ifde‡
CONFIG_VFP


261  
îr
;

262 
	}
}

264 
asmlökage
 
	$sys_sigªtu∫
(
±_ªgs
 *
ªgs
)

266 
sig‰ame
 
__u£r
 *
‰ame
;

269 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

276 i‡(
ªgs
->
ARM_•
 & 7)

277 
bad‰ame
;

279 
‰ame
 = (
sig‰ame
 
__u£r
 *)
ªgs
->
ARM_•
;

281 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
,  (*frame)))

282 
bad‰ame
;

284 i‡(
	`ª°‹e_sig‰ame
(
ªgs
, 
‰ame
))

285 
bad‰ame
;

287 
	`sögÀ_°ï_å≠
(
cuºít
);

289  
ªgs
->
ARM_r0
;

291 
bad‰ame
:

292 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

294 
	}
}

296 
asmlökage
 
	$sys_π_sigªtu∫
(
±_ªgs
 *
ªgs
)

298 
π_sig‰ame
 
__u£r
 *
‰ame
;

301 
	`cuºít_thªad_öfo
()->
ª°¨t_block
.
‚
 = 
do_no_ª°¨t_sysˇŒ
;

308 i‡(
ªgs
->
ARM_•
 & 7)

309 
bad‰ame
;

311 
‰ame
 = (
π_sig‰ame
 
__u£r
 *)
ªgs
->
ARM_•
;

313 i‡(!
	`ac˚ss_ok
(
VERIFY_READ
, 
‰ame
,  (*frame)))

314 
bad‰ame
;

316 i‡(
	`ª°‹e_sig‰ame
(
ªgs
, &
‰ame
->
sig
))

317 
bad‰ame
;

319 i‡(
	`do_sigÆt°ack
(&
‰ame
->
sig
.
uc
.
uc_°ack
, 
NULL
, 
ªgs
->
ARM_•
Ë=-
EFAULT
)

320 
bad‰ame
;

322 
	`sögÀ_°ï_å≠
(
cuºít
);

324  
ªgs
->
ARM_r0
;

326 
bad‰ame
:

327 
	`f‹˚_sig
(
SIGSEGV
, 
cuºít
);

329 
	}
}

332 
	$£tup_sig‰ame
(
sig‰ame
 
__u£r
 *
sf
, 
±_ªgs
 *
ªgs
, 
sig£t_t
 *
£t
)

334 
aux_sig‰ame
 
__u£r
 *
aux
;

335 
îr
 = 0;

337 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r0
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r0
, 
îr
);

338 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r1
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r1
, 
îr
);

339 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r2
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r2
, 
îr
);

340 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r3
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r3
, 
îr
);

341 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r4
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r4
, 
îr
);

342 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r5
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r5
, 
îr
);

343 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r6
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r6
, 
îr
);

344 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r7
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r7
, 
îr
);

345 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r8
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r8
, 
îr
);

346 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r9
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r9
, 
îr
);

347 
	`__put_u£r_îr‹
(
ªgs
->
ARM_r10
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_r10
, 
îr
);

348 
	`__put_u£r_îr‹
(
ªgs
->
ARM_Â
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_Â
, 
îr
);

349 
	`__put_u£r_îr‹
(
ªgs
->
ARM_ù
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_ù
, 
îr
);

350 
	`__put_u£r_îr‹
(
ªgs
->
ARM_•
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_•
, 
îr
);

351 
	`__put_u£r_îr‹
(
ªgs
->
ARM_Ã
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_Ã
, 
îr
);

352 
	`__put_u£r_îr‹
(
ªgs
->
ARM_pc
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_pc
, 
îr
);

353 
	`__put_u£r_îr‹
(
ªgs
->
ARM_˝§
, &
sf
->
uc
.
uc_mc⁄ãxt
.
¨m_˝§
, 
îr
);

355 
	`__put_u£r_îr‹
(
cuºít
->
thªad
.
å≠_no
, &
sf
->
uc
.
uc_mc⁄ãxt
.å≠_no, 
îr
);

356 
	`__put_u£r_îr‹
(
cuºít
->
thªad
.
îr‹_code
, &
sf
->
uc
.
uc_mc⁄ãxt
.îr‹_code, 
îr
);

357 
	`__put_u£r_îr‹
(
cuºít
->
thªad
.
addªss
, &
sf
->
uc
.
uc_mc⁄ãxt
.
Áu…_addªss
, 
îr
);

358 
	`__put_u£r_îr‹
(
£t
->
sig
[0], &
sf
->
uc
.
uc_mc⁄ãxt
.
ﬁdmask
, 
îr
);

360 
îr
 |
	`__c›y_to_u£r
(&
sf
->
uc
.
uc_sigmask
, 
£t
, (*set));

362 
aux
 = (
aux_sig‰ame
 
__u£r
 *Ë
sf
->
uc
.
uc_ªg•a˚
;

363 #ifde‡
CONFIG_CRUNCH


364 i‡(
îr
 == 0)

365 
îr
 |
	`¥e£rve_¸unch_c⁄ãxt
(&
aux
->
¸unch
);

367 #ifde‡
CONFIG_IWMMXT


368 i‡(
îr
 =0 && 
	`ã°_thªad_Êag
(
TIF_USING_IWMMXT
))

369 
îr
 |
	`¥e£rve_iwmmxt_c⁄ãxt
(&
aux
->
iwmmxt
);

371 #ifde‡
CONFIG_VFP


375 
	`__put_u£r_îr‹
(0, &
aux
->
íd_magic
, 
îr
);

377  
îr
;

378 
	}
}

380 
ölöe
 
__u£r
 *

381 
	$gë_sig‰ame
(
k_siga˘i⁄
 *
ka
, 
±_ªgs
 *
ªgs
, 
‰amesize
)

383 
•
 = 
ªgs
->
ARM_•
;

384 
__u£r
 *
‰ame
;

389 i‡((
ka
->
ß
.
ß_Êags
 & 
SA_ONSTACK
Ë&& !
	`ßs_ss_Êags
(
•
))

390 
•
 = 
cuºít
->
ßs_ss_•
 + cuºít->
ßs_ss_size
;

395 
‰ame
 = (
__u£r
 *)((
•
 - 
‰amesize
) & ~7);

400 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
‰ame
, 
‰amesize
))

401 
‰ame
 = 
NULL
;

403  
‰ame
;

404 
	}
}

407 
	$£tup_ªtu∫
(
±_ªgs
 *
ªgs
, 
k_siga˘i⁄
 *
ka
,

408 
__u£r
 *
rc
, __u£∏*
‰ame
, 
usig
)

410 
h™dÀr
 = ()
ka
->
ß
.
ß_h™dÀr
;

411 
ªtcode
;

412 
thumb
 = 0;

413 
˝§
 = 
ªgs
->
ARM_˝§
 & ~
PSR_f
;

418 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_THIRTYTWO
)

419 
˝§
 = (˝§ & ~
MODE_MASK
Ë| 
USR_MODE
;

421 #ifde‡
CONFIG_ARM_THUMB


422 i‡(
ñf_hwˇp
 & 
HWCAP_THUMB
) {

427 
thumb
 = 
h™dÀr
 & 1;

429 i‡(
thumb
)

430 
˝§
 |
PSR_T_BIT
;

432 
˝§
 &~
PSR_T_BIT
;

436 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_RESTORER
) {

437 
ªtcode
 = ()
ka
->
ß
.
ß_ª°‹î
;

439 
idx
 = 
thumb
 << 1;

441 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

442 
idx
 += 3;

444 i‡(
	`__put_u£r
(
sigªtu∫_codes
[
idx
], 
rc
) ||

445 
	`__put_u£r
(
sigªtu∫_codes
[
idx
+1], 
rc
+1))

448 i‡(
˝§
 & 
MODE32_BIT
) {

453 
ªtcode
 = 
KERN_SIGRETURN_CODE
 + (
idx
 << 2Ë+ 
thumb
;

459 
	`Êush_iˇche_ønge
(()
rc
,

460 ()(
rc
 + 2));

462 
ªtcode
 = (()
rc
Ë+ 
thumb
;

466 
ªgs
->
ARM_r0
 = 
usig
;

467 
ªgs
->
ARM_•
 = ()
‰ame
;

468 
ªgs
->
ARM_Ã
 = 
ªtcode
;

469 
ªgs
->
ARM_pc
 = 
h™dÀr
;

470 
ªgs
->
ARM_˝§
 = 
˝§
;

473 
	}
}

476 
	$£tup_‰ame
(
usig
, 
k_siga˘i⁄
 *
ka
, 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

478 
sig‰ame
 
__u£r
 *
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*frame));

479 
îr
 = 0;

481 i‡(!
‰ame
)

487 
	`__put_u£r_îr‹
(0x5ac3c35a, &
‰ame
->
uc
.
uc_Êags
, 
îr
);

489 
îr
 |
	`£tup_sig‰ame
(
‰ame
, 
ªgs
, 
£t
);

490 i‡(
îr
 == 0)

491 
îr
 = 
	`£tup_ªtu∫
(
ªgs
, 
ka
, 
‰ame
->
ªtcode
, føme, 
usig
);

493  
îr
;

494 
	}
}

497 
	$£tup_π_‰ame
(
usig
, 
k_siga˘i⁄
 *
ka
, 
sigöfo_t
 *
öfo
,

498 
sig£t_t
 *
£t
, 
±_ªgs
 *
ªgs
)

500 
π_sig‰ame
 
__u£r
 *
‰ame
 = 
	`gë_sig‰ame
(
ka
, 
ªgs
, (*frame));

501 
°ack_t
 
°ack
;

502 
îr
 = 0;

504 i‡(!
‰ame
)

507 
îr
 |
	`c›y_sigöfo_to_u£r
(&
‰ame
->
öfo
, info);

509 
	`__put_u£r_îr‹
(0, &
‰ame
->
sig
.
uc
.
uc_Êags
, 
îr
);

510 
	`__put_u£r_îr‹
(
NULL
, &
‰ame
->
sig
.
uc
.
uc_lök
, 
îr
);

512 
	`mem£t
(&
°ack
, 0, (stack));

513 
°ack
.
ss_•
 = (
__u£r
 *)
cuºít
->
ßs_ss_•
;

514 
°ack
.
ss_Êags
 = 
	`ßs_ss_Êags
(
ªgs
->
ARM_•
);

515 
°ack
.
ss_size
 = 
cuºít
->
ßs_ss_size
;

516 
îr
 |
	`__c›y_to_u£r
(&
‰ame
->
sig
.
uc
.
uc_°ack
, &
°ack
, (stack));

518 
îr
 |
	`£tup_sig‰ame
(&
‰ame
->
sig
, 
ªgs
, 
£t
);

519 i‡(
îr
 == 0)

520 
îr
 = 
	`£tup_ªtu∫
(
ªgs
, 
ka
, 
‰ame
->
sig
.
ªtcode
, føme, 
usig
);

522 i‡(
îr
 == 0) {

528 
ªgs
->
ARM_r1
 = ()&
‰ame
->
öfo
;

529 
ªgs
->
ARM_r2
 = ()&
‰ame
->
sig
.
uc
;

532  
îr
;

533 
	}
}

535 
ölöe
 
	$ª°¨t_sysˇŒ
(
±_ªgs
 *
ªgs
)

537 
ªgs
->
ARM_r0
 =Ñegs->
ARM_ORIG_r0
;

538 
ªgs
->
ARM_pc
 -
	`thumb_mode
(regs) ? 2 : 4;

539 
	}
}

545 
	$h™dÀ_sig«l
(
sig
, 
k_siga˘i⁄
 *
ka
,

546 
sigöfo_t
 *
öfo
, 
sig£t_t
 *
ﬁd£t
,

547 
±_ªgs
 * 
ªgs
, 
sysˇŒ
)

549 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

550 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

551 
usig
 = 
sig
;

552 
ªt
;

557 i‡(
sysˇŒ
) {

558 
ªgs
->
ARM_r0
) {

559 -
ERESTART_RESTARTBLOCK
:

560 -
ERESTARTNOHAND
:

561 
ªgs
->
ARM_r0
 = -
EINTR
;

563 -
ERESTARTSYS
:

564 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_RESTART
)) {

565 
ªgs
->
ARM_r0
 = -
EINTR
;

569 -
ERESTARTNOINTR
:

570 
	`ª°¨t_sysˇŒ
(
ªgs
);

577 i‡(
usig
 < 32 && 
thªad
->
exec_domaö
 &&Åhªad->exec_domaö->
sig«l_övm≠
)

578 
usig
 = 
thªad
->
exec_domaö
->
sig«l_övm≠
[usig];

583 i‡(
ka
->
ß
.
ß_Êags
 & 
SA_SIGINFO
)

584 
ªt
 = 
	`£tup_π_‰ame
(
usig
, 
ka
, 
öfo
, 
ﬁd£t
, 
ªgs
);

586 
ªt
 = 
	`£tup_‰ame
(
usig
, 
ka
, 
ﬁd£t
, 
ªgs
);

591 
ªt
 |!
	`vÆid_u£r_ªgs
(
ªgs
);

593 i‡(
ªt
 != 0) {

594 
	`f‹˚_sig£gv
(
sig
, 
tsk
);

601 
	`•ö_lock_úq
(&
tsk
->
sigh™d
->
siglock
);

602 
	`sig‹£ts
(&
tsk
->
blocked
, &tsk->blocked,

603 &
ka
->
ß
.
ß_mask
);

604 i‡(!(
ka
->
ß
.
ß_Êags
 & 
SA_NODEFER
))

605 
	`sigadd£t
(&
tsk
->
blocked
, 
sig
);

606 
	`ªˇlc_sig≥ndög
();

607 
	`•ö_u∆ock_úq
(&
tsk
->
sigh™d
->
siglock
);

609 
	}
}

620 
	$do_sig«l
(
sig£t_t
 *
ﬁd£t
, 
±_ªgs
 *
ªgs
, 
sysˇŒ
)

622 
k_siga˘i⁄
 
ka
;

623 
sigöfo_t
 
öfo
;

624 
sigƒ
;

632 i‡(!
	`u£r_mode
(
ªgs
))

635 i‡(
	`åy_to_‰ìze
())

636 
no_sig«l
;

638 
	`sögÀ_°ï_˛ór
(
cuºít
);

640 
sigƒ
 = 
	`gë_sig«l_to_dñivî
(&
öfo
, &
ka
, 
ªgs
, 
NULL
);

641 i‡(
sigƒ
 > 0) {

642 
	`h™dÀ_sig«l
(
sigƒ
, &
ka
, &
öfo
, 
ﬁd£t
, 
ªgs
, 
sysˇŒ
);

643 
	`sögÀ_°ï_£t
(
cuºít
);

647 
no_sig«l
:

651 i‡(
sysˇŒ
) {

652 i‡(
ªgs
->
ARM_r0
 =-
ERESTART_RESTARTBLOCK
) {

653 i‡(
	`thumb_mode
(
ªgs
)) {

654 
ªgs
->
ARM_r7
 = 
__NR_ª°¨t_sysˇŒ
 - 
__NR_SYSCALL_BASE
;

655 
ªgs
->
ARM_pc
 -= 2;

657 #i‡
	`deföed
(
CONFIG_AEABI
Ë&& !deföed(
CONFIG_OABI_COMPAT
)

658 
ªgs
->
ARM_r7
 = 
__NR_ª°¨t_sysˇŒ
;

659 
ªgs
->
ARM_pc
 -= 4;

661 
u32
 
__u£r
 *
u•
;

662 
u32
 
swivÆ
 = 
__NR_ª°¨t_sysˇŒ
;

664 
ªgs
->
ARM_•
 -= 12;

665 
u•
 = (
u32
 
__u£r
 *)
ªgs
->
ARM_•
;

676 
swivÆ
 = swivÆ - 
__NR_SYSCALL_BASE
 + 
__NR_OABI_SYSCALL_BASE
;

678 
	`put_u£r
(
ªgs
->
ARM_pc
, &
u•
[0]);

680 
	`put_u£r
(0xef000000 | 
swivÆ
, &
u•
[1]);

682 
	`put_u£r
(0xe49df00c, &
u•
[2]);

684 
	`Êush_iˇche_ønge
(()
u•
,

685 ()(
u•
 + 3));

687 
ªgs
->
ARM_pc
 =Ñegs->
ARM_•
 + 4;

691 i‡(
ªgs
->
ARM_r0
 =-
ERESTARTNOHAND
 ||

692 
ªgs
->
ARM_r0
 =-
ERESTARTSYS
 ||

693 
ªgs
->
ARM_r0
 =-
ERESTARTNOINTR
) {

694 
	`ª°¨t_sysˇŒ
(
ªgs
);

697 
	`sögÀ_°ï_£t
(
cuºít
);

699 
	}
}

701 
asmlökage
 

702 
	$do_nŸify_ªsume
(
±_ªgs
 *
ªgs
, 
thªad_Êags
, 
sysˇŒ
)

704 i‡(
thªad_Êags
 & 
_TIF_SIGPENDING
)

705 
	`do_sig«l
(&
cuºít
->
blocked
, 
ªgs
, 
sysˇŒ
);

706 
	}
}

	@arch/arm/kernel/signal.h

10 
	#KERN_SIGRETURN_CODE
 (
CONFIG_VECTORS_BASE
 + 0x00000500)

	)

12 c⁄° 
sigªtu∫_codes
[7];

	@arch/arm/kernel/smp.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/•ölock.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<löux/ˇche.h
>

17 
	~<löux/¥ofûe.h
>

18 
	~<löux/î∫o.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/˝u.h
>

21 
	~<löux/smp.h
>

22 
	~<löux/£q_fûe.h
>

23 
	~<löux/úq.h
>

25 
	~<asm/©omic.h
>

26 
	~<asm/ˇcheÊush.h
>

27 
	~<asm/˝u.h
>

28 
	~<asm/mmu_c⁄ãxt.h
>

29 
	~<asm/pgèbÀ.h
>

30 
	~<asm/pgÆloc.h
>

31 
	~<asm/¥o˚ss‹.h
>

32 
	~<asm/ébÊush.h
>

33 
	~<asm/±ø˚.h
>

40 
˝umask_t
 
	g˝u_possibÀ_m≠
;

41 
EXPORT_SYMBOL
(
˝u_possibÀ_m≠
);

42 
˝umask_t
 
	g˝u_⁄löe_m≠
;

43 
EXPORT_SYMBOL
(
˝u_⁄löe_m≠
);

50 
£c⁄d¨y_d©a
 
	g£c⁄d¨y_d©a
;

56 
	sùi_d©a
 {

57 
•ölock_t
 
	mlock
;

58 
	mùi_cou¡
;

59 
	mbôs
;

62 
DEFINE_PER_CPU
(
ùi_d©a
, ipi_data) = {

63 .
lock
 = 
SPIN_LOCK_UNLOCKED
,

66 
	eùi_msg_ty≥
 {

67 
	mIPI_TIMER
,

68 
	mIPI_RESCHEDULE
,

69 
	mIPI_CALL_FUNC
,

70 
	mIPI_CPU_STOP
,

73 
	ssmp_ˇŒ_°ru˘
 {

74 (*
	mfunc
)(*
	möfo
);

75 *
	möfo
;

76 
	mwaô
;

77 
˝umask_t
 
	m≥ndög
;

78 
˝umask_t
 
	munföished
;

81 
smp_ˇŒ_°ru˘
 * vﬁ©ûê
	gsmp_ˇŒ_fun˘i⁄_d©a
;

82 
DEFINE_SPINLOCK
(
smp_ˇŒ_fun˘i⁄_lock
);

84 
__˝uöô
 
	$__˝u_up
(
˝u
)

86 
˝uöfo_¨m
 *
ci
 = &
	`≥r_˝u
(
˝u_d©a
, 
˝u
);

87 
èsk_°ru˘
 *
idÀ
 = 
ci
->idle;

88 
pgd_t
 *
pgd
;

89 
pmd_t
 *
pmd
;

90 
ªt
;

96 i‡(!
idÀ
) {

97 
idÀ
 = 
	`f‹k_idÀ
(
˝u
);

98 i‡(
	`IS_ERR
(
idÀ
)) {

99 
	`¥ötk
(
KERN_ERR
 "CPU%u: f‹k(ËÁûed\n", 
˝u
);

100  
	`PTR_ERR
(
idÀ
);

102 
ci
->
idÀ
 = idle;

111 
pgd
 = 
	`pgd_Æloc
(&
öô_mm
);

112 
pmd
 = 
	`pmd_off£t
(
pgd
, 
PHYS_OFFSET
);

113 *
pmd
 = 
	`__pmd
((
PHYS_OFFSET
 & 
PGDIR_MASK
) |

114 
PMD_TYPE_SECT
 | 
PMD_SECT_AP_WRITE
);

120 
£c⁄d¨y_d©a
.
°ack
 = 
	`èsk_°ack_∑ge
(
idÀ
Ë+ 
THREAD_START_SP
;

121 
£c⁄d¨y_d©a
.
pgdú
 = 
	`vút_to_phys
(
pgd
);

122 
	`wmb
();

127 
ªt
 = 
	`boŸ_£c⁄d¨y
(
˝u
, 
idÀ
);

128 i‡(
ªt
 == 0) {

129 
timeout
;

135 
timeout
 = 
jiffõs
 + 
HZ
;

136 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

137 i‡(
	`˝u_⁄löe
(
˝u
))

140 
	`udñay
(10);

141 
	`b¨rõr
();

144 i‡(!
	`˝u_⁄löe
(
˝u
))

145 
ªt
 = -
EIO
;

148 
£c⁄d¨y_d©a
.
°ack
 = 
NULL
;

149 
£c⁄d¨y_d©a
.
pgdú
 = 0;

151 *
	`pmd_off£t
(
pgd
, 
PHYS_OFFSET
Ë
	`__pmd
(0);

152 
	`pgd_‰ì
(
pgd
);

154 i‡(
ªt
) {

155 
	`¥ötk
(
KERN_CRIT
 "CPU%u:Öro˚ss‹ faûedÅÿboŸ\n", 
˝u
);

162  
ªt
;

163 
	}
}

165 #ifde‡
CONFIG_HOTPLUG_CPU


169 
__˝uexô
 
	$__˝u_dißbÀ
()

171 
˝u
 = 
	`smp_¥o˚ss‹_id
();

172 
èsk_°ru˘
 *
p
;

173 
ªt
;

175 
ªt
 = 
	`mach_˝u_dißbÀ
(
˝u
);

176 i‡(
ªt
)

177  
ªt
;

183 
	`˝u_˛ór
(
˝u
, 
˝u_⁄löe_m≠
);

188 
	`migøã_úqs
();

193 
	`loˇl_timî_°›
(
˝u
);

199 
	`Êush_ˇche_Æl
();

200 
	`loˇl_Êush_éb_Æl
();

202 
	`ªad_lock
(&
èskli°_lock
);

203 
	`f‹_óch_¥o˚ss
(
p
) {

204 i‡(
p
->
mm
)

205 
	`˝u_˛ór
(
˝u
, 
p
->
mm
->
˝u_vm_mask
);

207 
	`ªad_u∆ock
(&
èskli°_lock
);

210 
	}
}

216 
__˝uexô
 
	$__˝u_dõ
(
˝u
)

218 i‡(!
	`∂©f‹m_˝u_kûl
(
˝u
))

219 
	`¥ötk
("CPU%u: u«bÀÅÿkûl\n", 
˝u
);

220 
	}
}

230 
__˝uexô
 
	$˝u_dõ
()

232 
˝u
 = 
	`smp_¥o˚ss‹_id
();

234 
	`loˇl_úq_dißbÀ
();

235 
	`idÀ_èsk_exô
();

241 
	`∂©f‹m_˝u_dõ
(
˝u
);

248 
	`__asm__
("mov sp, %0\n"

251 : "r" (
	`èsk_°ack_∑ge
(
cuºít
Ë+ 
THREAD_SIZE
 - 8));

252 
	}
}

259 
asmlökage
 
__˝uöô
 
	$£c⁄d¨y_°¨t_kî√l
()

261 
mm_°ru˘
 *
mm
 = &
öô_mm
;

262 
˝u
 = 
	`smp_¥o˚ss‹_id
();

264 
	`¥ötk
("CPU%u: BoŸed sec⁄d¨yÖro˚ss‹\n", 
˝u
);

270 
	`©omic_öc
(&
mm
->
mm_u£rs
);

271 
	`©omic_öc
(&
mm
->
mm_cou¡
);

272 
cuºít
->
a˘ive_mm
 = 
mm
;

273 
	`˝u_£t
(
˝u
, 
mm
->
˝u_vm_mask
);

274 
	`˝u_swôch_mm
(
mm
->
pgd
, mm);

275 
	`íãr_œzy_éb
(
mm
, 
cuºít
);

276 
	`loˇl_Êush_éb_Æl
();

278 
	`˝u_öô
();

279 
	`¥ìm±_dißbÀ
();

284 
	`∂©f‹m_£c⁄d¨y_öô
(
˝u
);

289 
	`loˇl_úq_íabÀ
();

290 
	`loˇl_fiq_íabÀ
();

292 
	`ˇlibøã_dñay
();

294 
	`smp_°‹e_˝u_öfo
(
˝u
);

299 
	`˝u_£t
(
˝u
, 
˝u_⁄löe_m≠
);

304 
	`loˇl_timî_£tup
(
˝u
);

309 
	`˝u_idÀ
();

310 
	}
}

316 
__˝uöô
 
	$smp_°‹e_˝u_öfo
(
˝uid
)

318 
˝uöfo_¨m
 *
˝u_öfo
 = &
	`≥r_˝u
(
˝u_d©a
, 
˝uid
);

320 
˝u_öfo
->
lo›s_≥r_jiffy
 =Üoops_per_jiffy;

321 
	}
}

323 
__öô
 
	$smp_˝us_d⁄e
(
max_˝us
)

325 
˝u
;

326 
bogosum
 = 0;

328 
	`f‹_óch_⁄löe_˝u
(
˝u
)

329 
bogosum
 +
	`≥r_˝u
(
˝u_d©a
, 
˝u
).
lo›s_≥r_jiffy
;

331 
	`¥ötk
(
KERN_INFO
 "SMP: Total of %dÖrocessorsáctivated "

333 
	`num_⁄löe_˝us
(),

334 
bogosum
 / (500000/
HZ
),

335 (
bogosum
 / (5000/
HZ
)) % 100);

336 
	}
}

338 
__öô
 
	$smp_¥ï¨e_boŸ_˝u
()

340 
˝u
 = 
	`smp_¥o˚ss‹_id
();

342 
	`≥r_˝u
(
˝u_d©a
, 
˝u
).
idÀ
 = 
cuºít
;

343 
	}
}

345 
	$£nd_ùi_mesßge
(
˝umask_t
 
ˇŒm≠
, 
ùi_msg_ty≥
 
msg
)

347 
Êags
;

348 
˝u
;

350 
	`loˇl_úq_ßve
(
Êags
);

352 
	`f‹_óch_˝u_mask
(
˝u
, 
ˇŒm≠
) {

353 
ùi_d©a
 *
ùi
 = &
	`≥r_˝u
(ùi_d©a, 
˝u
);

355 
	`•ö_lock
(&
ùi
->
lock
);

356 
ùi
->
bôs
 |1 << 
msg
;

357 
	`•ö_u∆ock
(&
ùi
->
lock
);

363 
	`smp_¸oss_ˇŒ
(
ˇŒm≠
);

365 
	`loˇl_úq_ª°‹e
(
Êags
);

366 
	}
}

372 
smp_ˇŒ_fun˘i⁄_⁄_˝u
((*
func
)(*
öfo
), *info,

373 
ªåy
, 
waô
, 
˝umask_t
 
ˇŒm≠
)

375 
smp_ˇŒ_°ru˘
 
d©a
;

376 
timeout
;

377 
ªt
 = 0;

379 
d©a
.
func
 = func;

380 
d©a
.
öfo
 = info;

381 
d©a
.
waô
 = wait;

383 
	`˝u_˛ór
(
	`smp_¥o˚ss‹_id
(), 
ˇŒm≠
);

384 i‡(
	`˝us_em±y
(
ˇŒm≠
))

385 
out
;

387 
d©a
.
≥ndög
 = 
ˇŒm≠
;

388 i‡(
waô
)

389 
d©a
.
unföished
 = 
ˇŒm≠
;

394 
	`•ö_lock
(&
smp_ˇŒ_fun˘i⁄_lock
);

395 
smp_ˇŒ_fun˘i⁄_d©a
 = &
d©a
;

397 
	`£nd_ùi_mesßge
(
ˇŒm≠
, 
IPI_CALL_FUNC
);

399 
timeout
 = 
jiffõs
 + 
HZ
;

400 !
	`˝us_em±y
(
d©a
.
≥ndög
Ë&& 
	`time_bef‹e
(
jiffõs
, 
timeout
))

401 
	`b¨rõr
();

406 i‡(!
	`˝us_em±y
(
d©a
.
≥ndög
)) {

410 
	`¥ötk
(
KERN_CRIT


413 
	`smp_¥o˚ss‹_id
(), 
func
, 
öfo
, *
	`˝us_addr
(
ˇŒm≠
),

414 *
	`˝us_addr
(
d©a
.
≥ndög
), 
waô
 ? "" : "no ");

419 
timeout
 = 
jiffõs
 + (5 * 
HZ
);

420 !
	`˝us_em±y
(
d©a
.
≥ndög
Ë&& 
	`time_bef‹e
(
jiffõs
, 
timeout
))

421 
	`b¨rõr
();

423 i‡(
	`˝us_em±y
(
d©a
.
≥ndög
))

424 
	`¥ötk
(
KERN_CRIT
 " RESOLVED\n");

426 
	`¥ötk
(
KERN_CRIT
 " STILL STUCK\n");

432 
smp_ˇŒ_fun˘i⁄_d©a
 = 
NULL
;

433 
	`•ö_u∆ock
(&
smp_ˇŒ_fun˘i⁄_lock
);

435 i‡(!
	`˝us_em±y
(
d©a
.
≥ndög
)) {

436 
ªt
 = -
ETIMEDOUT
;

437 
out
;

440 i‡(
waô
)

441 !
	`˝us_em±y
(
d©a
.
unföished
))

442 
	`b¨rõr
();

443 
out
:

446 
	}
}

448 
smp_ˇŒ_fun˘i⁄
((*
func
)(*
öfo
), *öfo, 
ªåy
,

449 
waô
)

451  
	`smp_ˇŒ_fun˘i⁄_⁄_˝u
(
func
, 
öfo
, 
ªåy
, 
waô
,

452 
˝u_⁄löe_m≠
);

453 
	}
}

454 
EXPORT_SYMBOL_GPL
(
smp_ˇŒ_fun˘i⁄
);

456 
	$show_ùi_li°
(
£q_fûe
 *
p
)

458 
˝u
;

460 
	`£q_puts
(
p
, "IPI:");

462 
	`f‹_óch_¥e£¡_˝u
(
˝u
)

463 
	`£q_¥ötf
(
p
, " %10lu", 
	`≥r_˝u
(
ùi_d©a
, 
˝u
).
ùi_cou¡
);

465 
	`£q_putc
(
p
, '\n');

466 
	}
}

468 
	$show_loˇl_úqs
(
£q_fûe
 *
p
)

470 
˝u
;

472 
	`£q_¥ötf
(
p
, "LOC: ");

474 
	`f‹_óch_¥e£¡_˝u
(
˝u
)

475 
	`£q_¥ötf
(
p
, "%10u ", 
úq_°©
[
˝u
].
loˇl_timî_úqs
);

477 
	`£q_putc
(
p
, '\n');

478 
	}
}

480 
	$ùi_timî
()

482 
	`úq_íãr
();

483 
	`¥ofûe_tick
(
CPU_PROFILING
);

484 
	`upd©e_¥o˚ss_times
(
	`u£r_mode
(
	`gë_úq_ªgs
()));

485 
	`úq_exô
();

486 
	}
}

488 #ifde‡
CONFIG_LOCAL_TIMERS


489 
asmlökage
 
__ex˚±i⁄
 
	$do_loˇl_timî
(
±_ªgs
 *
ªgs
)

491 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

492 
˝u
 = 
	`smp_¥o˚ss‹_id
();

494 i‡(
	`loˇl_timî_ack
()) {

495 
úq_°©
[
˝u
].
loˇl_timî_úqs
++;

496 
	`ùi_timî
();

499 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

500 
	}
}

509 
	$ùi_ˇŒ_fun˘i⁄
(
˝u
)

511 
smp_ˇŒ_°ru˘
 *
d©a
 = 
smp_ˇŒ_fun˘i⁄_d©a
;

512 (*
func
)(*
öfo
Ë
d©a
->func;

513 *
öfo
 = 
d©a
->info;

514 
waô
 = 
d©a
->wait;

516 
	`˝u_˛ór
(
˝u
, 
d©a
->
≥ndög
);

518 
	`func
(
öfo
);

520 i‡(
waô
)

521 
	`˝u_˛ór
(
˝u
, 
d©a
->
unföished
);

522 
	}
}

524 
DEFINE_SPINLOCK
(
°›_lock
);

529 
	$ùi_˝u_°›
(
˝u
)

531 
	`•ö_lock
(&
°›_lock
);

532 
	`¥ötk
(
KERN_CRIT
 "CPU%u: st›pög\n", 
˝u
);

533 
	`dump_°ack
();

534 
	`•ö_u∆ock
(&
°›_lock
);

536 
	`˝u_˛ór
(
˝u
, 
˝u_⁄löe_m≠
);

538 
	`loˇl_fiq_dißbÀ
();

539 
	`loˇl_úq_dißbÀ
();

542 
	`˝u_ªœx
();

543 
	}
}

554 
asmlökage
 
__ex˚±i⁄
 
	$do_IPI
(
±_ªgs
 *
ªgs
)

556 
˝u
 = 
	`smp_¥o˚ss‹_id
();

557 
ùi_d©a
 *
ùi
 = &
	`≥r_˝u
(ùi_d©a, 
˝u
);

558 
±_ªgs
 *
ﬁd_ªgs
 = 
	`£t_úq_ªgs
(
ªgs
);

560 
ùi
->
ùi_cou¡
++;

563 
msgs
;

565 
	`•ö_lock
(&
ùi
->
lock
);

566 
msgs
 = 
ùi
->
bôs
;

567 
ùi
->
bôs
 = 0;

568 
	`•ö_u∆ock
(&
ùi
->
lock
);

570 i‡(!
msgs
)

574 
√xtmsg
;

576 
√xtmsg
 = 
msgs
 & -msgs;

577 
msgs
 &~
√xtmsg
;

578 
√xtmsg
 = 
	`ffz
(~nextmsg);

580 
√xtmsg
) {

581 
IPI_TIMER
:

582 
	`ùi_timî
();

585 
IPI_RESCHEDULE
:

592 
IPI_CALL_FUNC
:

593 
	`ùi_ˇŒ_fun˘i⁄
(
˝u
);

596 
IPI_CPU_STOP
:

597 
	`ùi_˝u_°›
(
˝u
);

601 
	`¥ötk
(
KERN_CRIT
 "CPU%u: Unknown IPI message 0x%x\n",

602 
˝u
, 
√xtmsg
);

605 } 
msgs
);

608 
	`£t_úq_ªgs
(
ﬁd_ªgs
);

609 
	}
}

611 
	$smp_£nd_ªscheduÀ
(
˝u
)

613 
	`£nd_ùi_mesßge
(
	`˝umask_of_˝u
(
˝u
), 
IPI_RESCHEDULE
);

614 
	}
}

616 
	$smp_£nd_timî
()

618 
˝umask_t
 
mask
 = 
˝u_⁄löe_m≠
;

619 
	`˝u_˛ór
(
	`smp_¥o˚ss‹_id
(), 
mask
);

620 
	`£nd_ùi_mesßge
(
mask
, 
IPI_TIMER
);

621 
	}
}

623 
	$smp_£nd_°›
()

625 
˝umask_t
 
mask
 = 
˝u_⁄löe_m≠
;

626 
	`˝u_˛ór
(
	`smp_¥o˚ss‹_id
(), 
mask
);

627 
	`£nd_ùi_mesßge
(
mask
, 
IPI_CPU_STOP
);

628 
	}
}

633 
__öô
 
	$£tup_¥ofûög_timî
(
mu…ùlõr
)

635  -
EINVAL
;

636 
	}
}

639 
⁄_óch_˝u_mask
((*
func
)(*), *
öfo
, 
ªåy
, 
waô
,

640 
˝umask_t
 
mask
)

642 
ªt
 = 0;

644 
	`¥ìm±_dißbÀ
();

646 
ªt
 = 
	`smp_ˇŒ_fun˘i⁄_⁄_˝u
(
func
, 
öfo
, 
ªåy
, 
waô
, 
mask
);

647 i‡(
	`˝u_is£t
(
	`smp_¥o˚ss‹_id
(), 
mask
))

648 
	`func
(
öfo
);

650 
	`¥ìm±_íabÀ
();

652  
ªt
;

653 
	}
}

660 
	séb_¨gs
 {

661 
vm_¨ó_°ru˘
 *
	mè_vma
;

662 
	mè_°¨t
;

663 
	mè_íd
;

666 
ölöe
 
	$ùi_Êush_éb_Æl
(*
ign‹ed
)

668 
	`loˇl_Êush_éb_Æl
();

669 
	}
}

671 
ölöe
 
	$ùi_Êush_éb_mm
(*
¨g
)

673 
mm_°ru˘
 *
mm
 = (mm_°ru˘ *)
¨g
;

675 
	`loˇl_Êush_éb_mm
(
mm
);

676 
	}
}

678 
ölöe
 
	$ùi_Êush_éb_∑ge
(*
¨g
)

680 
éb_¨gs
 *
è
 = (éb_¨g†*)
¨g
;

682 
	`loˇl_Êush_éb_∑ge
(
è
->
è_vma
,Åa->
è_°¨t
);

683 
	}
}

685 
ölöe
 
	$ùi_Êush_éb_kî√l_∑ge
(*
¨g
)

687 
éb_¨gs
 *
è
 = (éb_¨g†*)
¨g
;

689 
	`loˇl_Êush_éb_kî√l_∑ge
(
è
->
è_°¨t
);

690 
	}
}

692 
ölöe
 
	$ùi_Êush_éb_ønge
(*
¨g
)

694 
éb_¨gs
 *
è
 = (éb_¨g†*)
¨g
;

696 
	`loˇl_Êush_éb_ønge
(
è
->
è_vma
,Åa->
è_°¨t
,Åa->
è_íd
);

697 
	}
}

699 
ölöe
 
	$ùi_Êush_éb_kî√l_ønge
(*
¨g
)

701 
éb_¨gs
 *
è
 = (éb_¨g†*)
¨g
;

703 
	`loˇl_Êush_éb_kî√l_ønge
(
è
->
è_°¨t
,Åa->
è_íd
);

704 
	}
}

706 
	$Êush_éb_Æl
()

708 
	`⁄_óch_˝u
(
ùi_Êush_éb_Æl
, 
NULL
, 1, 1);

709 
	}
}

711 
	$Êush_éb_mm
(
mm_°ru˘
 *
mm
)

713 
˝umask_t
 
mask
 = 
mm
->
˝u_vm_mask
;

715 
	`⁄_óch_˝u_mask
(
ùi_Êush_éb_mm
, 
mm
, 1, 1, 
mask
);

716 
	}
}

718 
	$Êush_éb_∑ge
(
vm_¨ó_°ru˘
 *
vma
, 
uaddr
)

720 
˝umask_t
 
mask
 = 
vma
->
vm_mm
->
˝u_vm_mask
;

721 
éb_¨gs
 
è
;

723 
è
.
è_vma
 = 
vma
;

724 
è
.
è_°¨t
 = 
uaddr
;

726 
	`⁄_óch_˝u_mask
(
ùi_Êush_éb_∑ge
, &
è
, 1, 1, 
mask
);

727 
	}
}

729 
	$Êush_éb_kî√l_∑ge
(
kaddr
)

731 
éb_¨gs
 
è
;

733 
è
.
è_°¨t
 = 
kaddr
;

735 
	`⁄_óch_˝u
(
ùi_Êush_éb_kî√l_∑ge
, &
è
, 1, 1);

736 
	}
}

738 
	$Êush_éb_ønge
(
vm_¨ó_°ru˘
 *
vma
,

739 
°¨t
, 
íd
)

741 
˝umask_t
 
mask
 = 
vma
->
vm_mm
->
˝u_vm_mask
;

742 
éb_¨gs
 
è
;

744 
è
.
è_vma
 = 
vma
;

745 
è
.
è_°¨t
 = 
°¨t
;

746 
è
.
è_íd
 = 
íd
;

748 
	`⁄_óch_˝u_mask
(
ùi_Êush_éb_ønge
, &
è
, 1, 1, 
mask
);

749 
	}
}

751 
	$Êush_éb_kî√l_ønge
(
°¨t
, 
íd
)

753 
éb_¨gs
 
è
;

755 
è
.
è_°¨t
 = 
°¨t
;

756 
è
.
è_íd
 = 
íd
;

758 
	`⁄_óch_˝u
(
ùi_Êush_éb_kî√l_ønge
, &
è
, 1, 1);

759 
	}
}

	@arch/arm/kernel/stacktrace.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/sched.h
>

3 
	~<löux/°ackåa˚.h
>

5 
	~"°ackåa˚.h
"

7 
wÆk_°ack‰ame
(
Â
, 
low
, 
high
,

8 (*
‚
)(
°ack‰ame
 *, *), *
d©a
)

10 
°ack‰ame
 *
‰ame
;

16 i‡(
Â
 < (
low
 + 12Ë|| f∞+ 4 >
high
)

19 
‰ame
 = (
°ack‰ame
 *)(
Â
 - 12);

21 i‡(
	`‚
(
‰ame
, 
d©a
))

28 
low
 = 
Â
 + 4;

29 
Â
 = 
‰ame
->fp;

30 } 
Â
);

33 
	}
}

34 
EXPORT_SYMBOL
(
wÆk_°ack‰ame
);

36 #ifde‡
CONFIG_STACKTRACE


37 
	s°ack_åa˚_d©a
 {

38 
°ack_åa˚
 *
	måa˚
;

39 
	mskù
;

42 
	$ßve_åa˚
(
°ack‰ame
 *
‰ame
, *
d
)

44 
°ack_åa˚_d©a
 *
d©a
 = 
d
;

45 
°ack_åa˚
 *
åa˚
 = 
d©a
->trace;

47 i‡(
d©a
->
skù
) {

48 
d©a
->
skù
--;

52 
åa˚
->
íåõs
[åa˚->
ƒ_íåõs
++] = 
‰ame
->
Ã
;

54  
åa˚
->
ƒ_íåõs
 >åa˚->
max_íåõs
;

55 
	}
}

57 
	$ßve_°ack_åa˚
(
°ack_åa˚
 *
åa˚
)

59 
°ack_åa˚_d©a
 
d©a
;

60 
Â
, 
ba£
;

62 
d©a
.
åa˚
 =Årace;

63 
d©a
.
skù
 = 
åa˚
->skip;

64 
ba£
 = ()
	`èsk_°ack_∑ge
(
cuºít
);

65 
	`asm
("mov %0, fp" : "Ù" (
Â
));

67 
	`wÆk_°ack‰ame
(
Â
, 
ba£
, ba£ + 
THREAD_SIZE
, 
ßve_åa˚
, &
d©a
);

68 
	}
}

	@arch/arm/kernel/stacktrace.h

1 
	s°ack‰ame
 {

2 
	mÂ
;

3 
	m•
;

4 
	mÃ
;

5 
	mpc
;

8 
wÆk_°ack‰ame
(
Â
, 
low
, 
high
,

9 (*
‚
)(
°ack‰ame
 *, *), *
d©a
);

	@arch/arm/kernel/sys_arm.c

15 
	~<löux/moduÀ.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/£m.h
>

21 
	~<löux/msg.h
>

22 
	~<löux/shm.h
>

23 
	~<löux/°©.h
>

24 
	~<löux/sysˇŒs.h
>

25 
	~<löux/mm™.h
>

26 
	~<löux/fs.h
>

27 
	~<löux/fûe.h
>

28 
	~<löux/ut¢ame.h
>

30 
	~<asm/uac˚ss.h
>

31 
	~<asm/ùc.h
>

33 
do_mªm≠
(
addr
, 
ﬁd_Àn
,

34 
√w_Àn
, 
Êags
,

35 
√w_addr
);

41 
asmlökage
 
	$sys_pùe
(
__u£r
 *
fûdes
)

43 
fd
[2];

44 
îr‹
;

46 
îr‹
 = 
	`do_pùe
(
fd
);

47 i‡(!
îr‹
) {

48 i‡(
	`c›y_to_u£r
(
fûdes
, 
fd
, 2*()))

49 
îr‹
 = -
EFAULT
;

51  
îr‹
;

52 
	}
}

55 
ölöe
 
	$do_mm≠2
(

56 
addr
, 
Àn
,

57 
¥Ÿ
, 
Êags
,

58 
fd
, 
pgoff
)

60 
îr‹
 = -
EINVAL
;

61 
fûe
 * fûê
NULL
;

63 
Êags
 &~(
MAP_EXECUTABLE
 | 
MAP_DENYWRITE
);

65 i‡(
Êags
 & 
MAP_FIXED
 && 
addr
 < 
FIRST_USER_ADDRESS
)

66 
out
;

68 
îr‹
 = -
EBADF
;

69 i‡(!(
Êags
 & 
MAP_ANONYMOUS
)) {

70 
fûe
 = 
	`fgë
(
fd
);

71 i‡(!
fûe
)

72 
out
;

75 
	`down_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

76 
îr‹
 = 
	`do_mm≠_pgoff
(
fûe
, 
addr
, 
Àn
, 
¥Ÿ
, 
Êags
, 
pgoff
);

77 
	`up_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

79 i‡(
fûe
)

80 
	`Âut
(
fûe
);

81 
out
:

82  
îr‹
;

83 
	}
}

85 
	smm≠_¨g_°ru˘
 {

86 
	maddr
;

87 
	mÀn
;

88 
	m¥Ÿ
;

89 
	mÊags
;

90 
	mfd
;

91 
	moff£t
;

94 
asmlökage
 
	$ﬁd_mm≠
(
mm≠_¨g_°ru˘
 
__u£r
 *
¨g
)

96 
îr‹
 = -
EFAULT
;

97 
mm≠_¨g_°ru˘
 
a
;

99 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

100 
out
;

102 
îr‹
 = -
EINVAL
;

103 i‡(
a
.
off£t
 & ~
PAGE_MASK
)

104 
out
;

106 
îr‹
 = 
	`do_mm≠2
(
a
.
addr
,á.
Àn
,á.
¥Ÿ
,á.
Êags
,á.
fd
,á.
off£t
 >> 
PAGE_SHIFT
);

107 
out
:

108  
îr‹
;

109 
	}
}

111 
asmlökage
 

112 
	$sys_¨m_mªm≠
(
addr
, 
ﬁd_Àn
,

113 
√w_Àn
, 
Êags
,

114 
√w_addr
)

116 
ªt
 = -
EINVAL
;

118 i‡(
Êags
 & 
MREMAP_FIXED
 && 
√w_addr
 < 
FIRST_USER_ADDRESS
)

119 
out
;

121 
	`down_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

122 
ªt
 = 
	`do_mªm≠
(
addr
, 
ﬁd_Àn
, 
√w_Àn
, 
Êags
, 
√w_addr
);

123 
	`up_wrôe
(&
cuºít
->
mm
->
mm≠_£m
);

125 
out
:

126  
ªt
;

127 
	}
}

134 
	s£l_¨g_°ru˘
 {

135 
	mn
;

136 
fd_£t
 
__u£r
 *
	möp
, *
	mouç
, *
	mexp
;

137 
timevÆ
 
__u£r
 *
	mtvp
;

140 
asmlökage
 
	$ﬁd_£À˘
(
£l_¨g_°ru˘
 
__u£r
 *
¨g
)

142 
£l_¨g_°ru˘
 
a
;

144 i‡(
	`c›y_‰om_u£r
(&
a
, 
¨g
, (a)))

145  -
EFAULT
;

147  
	`sys_£À˘
(
a
.
n
,á.
öp
,á.
ouç
,á.
exp
,á.
tvp
);

148 
	}
}

150 #i‡!
deföed
(
CONFIG_AEABI
Ë|| deföed(
CONFIG_OABI_COMPAT
)

156 
asmlökage
 
	$sys_ùc
(
uöt
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

157 
__u£r
 *
±r
, 
fi·h
)

159 
vîsi⁄
, 
ªt
;

161 
vîsi⁄
 = 
ˇŒ
 >> 16;

162 
ˇŒ
 &= 0xffff;

164 
ˇŒ
) {

165 
SEMOP
:

166  
	`sys_£mtimed›
 (
fú°
, (
£mbuf
 
__u£r
 *)
±r
, 
£c⁄d
, 
NULL
);

167 
SEMTIMEDOP
:

168  
	`sys_£mtimed›
(
fú°
, (
£mbuf
 
__u£r
 *)
±r
, 
£c⁄d
,

169 (c⁄° 
time•ec
 
__u£r
 *)
fi·h
);

171 
SEMGET
:

172  
	`sys_£mgë
 (
fú°
, 
£c⁄d
, 
thúd
);

173 
SEMCTL
: {

174 
£mun
 
fouπh
;

175 i‡(!
±r
)

176  -
EINVAL
;

177 i‡(
	`gë_u£r
(
fouπh
.
__∑d
, (
__u£r
 * __u£∏*Ë
±r
))

178  -
EFAULT
;

179  
	`sys_£m˘l
 (
fú°
, 
£c⁄d
, 
thúd
, 
fouπh
);

182 
MSGSND
:

183  
	`sys_msg¢d
(
fú°
, (
msgbuf
 
__u£r
 *Ë
±r
,

184 
£c⁄d
, 
thúd
);

185 
MSGRCV
:

186 
vîsi⁄
) {

188 
ùc_kludge
 
tmp
;

189 i‡(!
±r
)

190  -
EINVAL
;

191 i‡(
	`c›y_‰om_u£r
(&
tmp
,(
ùc_kludge
 
__u£r
 *)
±r
,

192  (
tmp
)))

193  -
EFAULT
;

194  
	`sys_msgrcv
 (
fú°
, 
tmp
.
msgp
, 
£c⁄d
,

195 
tmp
.
msgtyp
, 
thúd
);

198  
	`sys_msgrcv
 (
fú°
,

199 (
msgbuf
 
__u£r
 *Ë
±r
,

200 
£c⁄d
, 
fi·h
, 
thúd
);

202 
MSGGET
:

203  
	`sys_msggë
 ((
key_t
Ë
fú°
, 
£c⁄d
);

204 
MSGCTL
:

205  
	`sys_msg˘l
(
fú°
, 
£c⁄d
, (
msqid_ds
 
__u£r
 *)
±r
);

207 
SHMAT
:

208 
vîsi⁄
) {

210 
ul⁄g
 
øddr
;

211 
ªt
 = 
	`do_shm©
(
fú°
, (
__u£r
 *)
±r
, 
£c⁄d
, &
øddr
);

212 i‡(
ªt
)

213  
ªt
;

214  
	`put_u£r
(
øddr
, (
ul⁄g
 
__u£r
 *)
thúd
);

217  -
EINVAL
;

219 
SHMDT
:

220  
	`sys_shmdt
 ((
__u£r
 *)
±r
);

221 
SHMGET
:

222  
	`sys_shmgë
 (
fú°
, 
£c⁄d
, 
thúd
);

223 
SHMCTL
:

224  
	`sys_shm˘l
 (
fú°
, 
£c⁄d
,

225 (
shmid_ds
 
__u£r
 *Ë
±r
);

227  -
ENOSYS
;

229 
	}
}

235 
asmlökage
 
	$sys_f‹k
(
±_ªgs
 *
ªgs
)

237 #ifde‡
CONFIG_MMU


238  
	`do_f‹k
(
SIGCHLD
, 
ªgs
->
ARM_•
,Ñegs, 0, 
NULL
, NULL);

241 (-
EINVAL
);

243 
	}
}

248 
asmlökage
 
	$sys_˛⁄e
(
˛⁄e_Êags
, 
√w•
,

249 
__u£r
 *
∑ª¡_tid±r
, 
és_vÆ
,

250 
__u£r
 *
chûd_tid±r
, 
±_ªgs
 *
ªgs
)

252 i‡(!
√w•
)

253 
√w•
 = 
ªgs
->
ARM_•
;

255  
	`do_f‹k
(
˛⁄e_Êags
, 
√w•
, 
ªgs
, 0, 
∑ª¡_tid±r
, 
chûd_tid±r
);

256 
	}
}

258 
asmlökage
 
	$sys_vf‹k
(
±_ªgs
 *
ªgs
)

260  
	`do_f‹k
(
CLONE_VFORK
 | 
CLONE_VM
 | 
SIGCHLD
, 
ªgs
->
ARM_•
,Ñegs, 0, 
NULL
, NULL);

261 
	}
}

266 
asmlökage
 
	$sys_execve
(
__u£r
 *
fûíamei
, __u£∏* __u£∏*
¨gv
,

267 
__u£r
 * __u£∏*
ívp
, 
±_ªgs
 *
ªgs
)

269 
îr‹
;

270 * 
fûíame
;

272 
fûíame
 = 
	`gë«me
(
fûíamei
);

273 
îr‹
 = 
	`PTR_ERR
(
fûíame
);

274 i‡(
	`IS_ERR
(
fûíame
))

275 
out
;

276 
îr‹
 = 
	`do_execve
(
fûíame
, 
¨gv
, 
ívp
, 
ªgs
);

277 
	`puäame
(
fûíame
);

278 
out
:

279  
îr‹
;

280 
	}
}

282 
	$kî√l_execve
(c⁄° *
fûíame
, *c⁄° 
¨gv
[], *c⁄° 
ívp
[])

284 
±_ªgs
 
ªgs
;

285 
ªt
;

287 
	`mem£t
(&
ªgs
, 0, (
±_ªgs
));

288 
ªt
 = 
	`do_execve
((*)
fûíame
, (
__u£r
 * __u£∏*)
¨gv
,

289 (
__u£r
 * __u£∏*)
ívp
, &
ªgs
);

290 i‡(
ªt
 < 0)

291 
out
;

296 
ªgs
.
ARM_r0
 = 
ªt
;

302 
	`asm
( "addÑ0, %0, %1\n\t"

311 : "r" (
	`cuºít_thªad_öfo
()),

312 "Ir" (
THREAD_START_SP
 - (
ªgs
)),

313 "r" (&
ªgs
),

314 "Ir" ((
ªgs
))

317 
out
:

318  
ªt
;

319 
	}
}

320 
EXPORT_SYMBOL
(
kî√l_execve
);

326 
asmlökage
 
	$sys_¨m_Ádvi£64_64
(
fd
, 
advi˚
,

327 
loff_t
 
off£t
,Üoff_à
Àn
)

329  
	`sys_Ádvi£64_64
(
fd
, 
off£t
, 
Àn
, 
advi˚
);

330 
	}
}

	@arch/arm/kernel/sys_oabi-compat.c

75 
	~<löux/sysˇŒs.h
>

76 
	~<löux/î∫o.h
>

77 
	~<löux/fs.h
>

78 
	~<löux/f˙é.h
>

79 
	~<löux/evíçﬁl.h
>

80 
	~<löux/£m.h
>

81 
	~<löux/sockë.h
>

82 
	~<löux/√t.h
>

83 
	~<asm/ùc.h
>

84 
	~<asm/uac˚ss.h
>

86 
	sﬁdabi_°©64
 {

87 
	m°_dev
;

88 
	m__∑d1
;

89 
	m__°_öo
;

90 
	m°_mode
;

91 
	m°_∆ök
;

93 
	m°_uid
;

94 
	m°_gid
;

96 
	m°_rdev
;

97 
	m__∑d2
;

99 
	m°_size
;

100 
	m°_blksize
;

101 
	m°_blocks
;

103 
	m°_©ime
;

104 
	m°_©ime_n£c
;

106 
	m°_mtime
;

107 
	m°_mtime_n£c
;

109 
	m°_˘ime
;

110 
	m°_˘ime_n£c
;

112 
	m°_öo
;

113 } 
__©åibuã__
 ((
∑cked
,
Æig√d
(4)));

115 
	$˝_ﬁdabi_°©64
(
k°©
 *
°©
,

116 
ﬁdabi_°©64
 
__u£r
 *
°©buf
)

118 
ﬁdabi_°©64
 
tmp
;

120 
tmp
.
°_dev
 = 
	`huge_ícode_dev
(
°©
->
dev
);

121 
tmp
.
__∑d1
 = 0;

122 
tmp
.
__°_öo
 = 
°©
->
öo
;

123 
tmp
.
°_mode
 = 
°©
->
mode
;

124 
tmp
.
°_∆ök
 = 
°©
->
∆ök
;

125 
tmp
.
°_uid
 = 
°©
->
uid
;

126 
tmp
.
°_gid
 = 
°©
->
gid
;

127 
tmp
.
°_rdev
 = 
	`huge_ícode_dev
(
°©
->
rdev
);

128 
tmp
.
°_size
 = 
°©
->
size
;

129 
tmp
.
°_blocks
 = 
°©
->
blocks
;

130 
tmp
.
__∑d2
 = 0;

131 
tmp
.
°_blksize
 = 
°©
->
blksize
;

132 
tmp
.
°_©ime
 = 
°©
->
©ime
.
tv_£c
;

133 
tmp
.
°_©ime_n£c
 = 
°©
->
©ime
.
tv_n£c
;

134 
tmp
.
°_mtime
 = 
°©
->
mtime
.
tv_£c
;

135 
tmp
.
°_mtime_n£c
 = 
°©
->
mtime
.
tv_n£c
;

136 
tmp
.
°_˘ime
 = 
°©
->
˘ime
.
tv_£c
;

137 
tmp
.
°_˘ime_n£c
 = 
°©
->
˘ime
.
tv_n£c
;

138 
tmp
.
°_öo
 = 
°©
->
öo
;

139  
	`c›y_to_u£r
(
°©buf
,&
tmp
,—mp)Ë? -
EFAULT
 : 0;

140 
	}
}

142 
asmlökage
 
	$sys_ﬂbi_°©64
(
__u£r
 * 
fûíame
,

143 
ﬁdabi_°©64
 
__u£r
 * 
°©buf
)

145 
k°©
 
°©
;

146 
îr‹
 = 
	`vfs_°©
(
fûíame
, &
°©
);

147 i‡(!
îr‹
)

148 
îr‹
 = 
	`˝_ﬁdabi_°©64
(&
°©
, 
°©buf
);

149  
îr‹
;

150 
	}
}

152 
asmlökage
 
	$sys_ﬂbi_l°©64
(
__u£r
 * 
fûíame
,

153 
ﬁdabi_°©64
 
__u£r
 * 
°©buf
)

155 
k°©
 
°©
;

156 
îr‹
 = 
	`vfs_l°©
(
fûíame
, &
°©
);

157 i‡(!
îr‹
)

158 
îr‹
 = 
	`˝_ﬁdabi_°©64
(&
°©
, 
°©buf
);

159  
îr‹
;

160 
	}
}

162 
asmlökage
 
	$sys_ﬂbi_f°©64
(
fd
,

163 
ﬁdabi_°©64
 
__u£r
 * 
°©buf
)

165 
k°©
 
°©
;

166 
îr‹
 = 
	`vfs_f°©
(
fd
, &
°©
);

167 i‡(!
îr‹
)

168 
îr‹
 = 
	`˝_ﬁdabi_°©64
(&
°©
, 
°©buf
);

169  
îr‹
;

170 
	}
}

172 
	sﬂbi_Êock64
 {

173 
	ml_ty≥
;

174 
	ml_whí˚
;

175 
loff_t
 
	ml_°¨t
;

176 
loff_t
 
	ml_Àn
;

177 
pid_t
 
	ml_pid
;

178 } 
__©åibuã__
 ((
∑cked
,
Æig√d
(4)));

180 
asmlökage
 
	$sys_ﬂbi_f˙é64
(
fd
, 
cmd
,

181 
¨g
)

183 
ﬂbi_Êock64
 
u£r
;

184 
Êock64
 
kî√l
;

185 
mm_£gmít_t
 
fs
 = 
USER_DS
;

186 
loˇl_¨g
 = 
¨g
;

187 
ªt
;

189 
cmd
) {

190 
F_GETLK64
:

191 
F_SETLK64
:

192 
F_SETLKW64
:

193 i‡(
	`c›y_‰om_u£r
(&
u£r
, (
ﬂbi_Êock64
 
__u£r
 *)
¨g
,

194 (
u£r
)))

195  -
EFAULT
;

196 
kî√l
.
l_ty≥
 = 
u£r
.l_type;

197 
kî√l
.
l_whí˚
 = 
u£r
.l_whence;

198 
kî√l
.
l_°¨t
 = 
u£r
.l_start;

199 
kî√l
.
l_Àn
 = 
u£r
.l_len;

200 
kî√l
.
l_pid
 = 
u£r
.l_pid;

201 
loˇl_¨g
 = ()&
kî√l
;

202 
fs
 = 
	`gë_fs
();

203 
	`£t_fs
(
KERNEL_DS
);

206 
ªt
 = 
	`sys_f˙é64
(
fd
, 
cmd
, 
loˇl_¨g
);

208 
cmd
) {

209 
F_GETLK64
:

210 i‡(!
ªt
) {

211 
u£r
.
l_ty≥
 = 
kî√l
.l_type;

212 
u£r
.
l_whí˚
 = 
kî√l
.l_whence;

213 
u£r
.
l_°¨t
 = 
kî√l
.l_start;

214 
u£r
.
l_Àn
 = 
kî√l
.l_len;

215 
u£r
.
l_pid
 = 
kî√l
.l_pid;

216 i‡(
	`c›y_to_u£r
((
ﬂbi_Êock64
 
__u£r
 *)
¨g
,

217 &
u£r
, (user)))

218 
ªt
 = -
EFAULT
;

220 
F_SETLK64
:

221 
F_SETLKW64
:

222 
	`£t_fs
(
fs
);

225  
ªt
;

226 
	}
}

228 
	sﬂbi_ïﬁl_evít
 {

229 
__u32
 
	mevíts
;

230 
__u64
 
	md©a
;

231 } 
__©åibuã__
 ((
∑cked
,
Æig√d
(4)));

233 
asmlökage
 
	$sys_ﬂbi_ïﬁl_˘l
(
ïfd
, 
›
, 
fd
,

234 
ﬂbi_ïﬁl_evít
 
__u£r
 *
evít
)

236 
ﬂbi_ïﬁl_evít
 
u£r
;

237 
ïﬁl_evít
 
kî√l
;

238 
mm_£gmít_t
 
fs
;

239 
ªt
;

241 i‡(
›
 =
EPOLL_CTL_DEL
)

242  
	`sys_ïﬁl_˘l
(
ïfd
, 
›
, 
fd
, 
NULL
);

243 i‡(
	`c›y_‰om_u£r
(&
u£r
, 
evít
, (user)))

244  -
EFAULT
;

245 
kî√l
.
evíts
 = 
u£r
.events;

246 
kî√l
.
d©a
 = 
u£r
.data;

247 
fs
 = 
	`gë_fs
();

248 
	`£t_fs
(
KERNEL_DS
);

249 
ªt
 = 
	`sys_ïﬁl_˘l
(
ïfd
, 
›
, 
fd
, &
kî√l
);

250 
	`£t_fs
(
fs
);

251  
ªt
;

252 
	}
}

254 
asmlökage
 
	$sys_ﬂbi_ïﬁl_waô
(
ïfd
,

255 
ﬂbi_ïﬁl_evít
 
__u£r
 *
evíts
,

256 
maxevíts
, 
timeout
)

258 
ïﬁl_evít
 *
kbuf
;

259 
mm_£gmít_t
 
fs
;

260 
ªt
, 
îr
, 
i
;

262 i‡(
maxevíts
 <0 || maxevít†> (
INT_MAX
/(
ïﬁl_evít
)))

263  -
EINVAL
;

264 
kbuf
 = 
	`kmÆloc
((*kbufË* 
maxevíts
, 
GFP_KERNEL
);

265 i‡(!
kbuf
)

266  -
ENOMEM
;

267 
fs
 = 
	`gë_fs
();

268 
	`£t_fs
(
KERNEL_DS
);

269 
ªt
 = 
	`sys_ïﬁl_waô
(
ïfd
, 
kbuf
, 
maxevíts
, 
timeout
);

270 
	`£t_fs
(
fs
);

271 
îr
 = 0;

272 
i
 = 0; i < 
ªt
; i++) {

273 
	`__put_u£r_îr‹
(
kbuf
[
i
].
evíts
, &evíts->evíts, 
îr
);

274 
	`__put_u£r_îr‹
(
kbuf
[
i
].
d©a
, &
evíts
->d©a, 
îr
);

275 
evíts
++;

277 
	`k‰ì
(
kbuf
);

278  
îr
 ? -
EFAULT
 : 
ªt
;

279 
	}
}

281 
	sﬂbi_£mbuf
 {

282 
	m£m_num
;

283 
	m£m_›
;

284 
	m£m_Êg
;

285 
	m__∑d
;

288 
asmlökage
 
	$sys_ﬂbi_£mtimed›
(
£mid
,

289 
ﬂbi_£mbuf
 
__u£r
 *
ts›s
,

290 
ns›s
,

291 c⁄° 
time•ec
 
__u£r
 *
timeout
)

293 
£mbuf
 *
s›s
;

294 
time•ec
 
loˇl_timeout
;

295 
îr
;

296 
i
;

298 i‡(
ns›s
 < 1)

299  -
EINVAL
;

300 
s›s
 = 
	`kmÆloc
((*s›sË* 
ns›s
, 
GFP_KERNEL
);

301 i‡(!
s›s
)

302  -
ENOMEM
;

303 
îr
 = 0;

304 
i
 = 0; i < 
ns›s
; i++) {

305 
	`__gë_u£r_îr‹
(
s›s
[
i
].
£m_num
, &
ts›s
->£m_num, 
îr
);

306 
	`__gë_u£r_îr‹
(
s›s
[
i
].
£m_›
, &
ts›s
->£m_›, 
îr
);

307 
	`__gë_u£r_îr‹
(
s›s
[
i
].
£m_Êg
, &
ts›s
->£m_Êg, 
îr
);

308 
ts›s
++;

310 i‡(
timeout
) {

312 
îr
 |
	`c›y_‰om_u£r
(&
loˇl_timeout
, 
timeout
, (*timeout));

313 
timeout
 = &
loˇl_timeout
;

315 i‡(
îr
) {

316 
îr
 = -
EFAULT
;

318 
mm_£gmít_t
 
fs
 = 
	`gë_fs
();

319 
	`£t_fs
(
KERNEL_DS
);

320 
îr
 = 
	`sys_£mtimed›
(
£mid
, 
s›s
, 
ns›s
, 
timeout
);

321 
	`£t_fs
(
fs
);

323 
	`k‰ì
(
s›s
);

324  
îr
;

325 
	}
}

327 
asmlökage
 
	$sys_ﬂbi_£m›
(
£mid
, 
ﬂbi_£mbuf
 
__u£r
 *
ts›s
,

328 
ns›s
)

330  
	`sys_ﬂbi_£mtimed›
(
£mid
, 
ts›s
, 
ns›s
, 
NULL
);

331 
	}
}

333 
asmlökage
 
sys_ùc
(
uöt
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

334 
__u£r
 *
±r
, 
fi·h
);

336 
asmlökage
 
	$sys_ﬂbi_ùc
(
uöt
 
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
,

337 
__u£r
 *
±r
, 
fi·h
)

339 
ˇŒ
 & 0xffff) {

340 
SEMOP
:

341  
	`sys_ﬂbi_£mtimed›
(
fú°
,

342 (
ﬂbi_£mbuf
 
__u£r
 *)
±r
,

343 
£c⁄d
, 
NULL
);

344 
SEMTIMEDOP
:

345  
	`sys_ﬂbi_£mtimed›
(
fú°
,

346 (
ﬂbi_£mbuf
 
__u£r
 *)
±r
,

347 
£c⁄d
,

348 (c⁄° 
time•ec
 
__u£r
 *)
fi·h
);

350  
	`sys_ùc
(
ˇŒ
, 
fú°
, 
£c⁄d
, 
thúd
, 
±r
, 
fi·h
);

352 
	}
}

354 
asmlökage
 
	$sys_ﬂbi_böd
(
fd
, 
sockaddr
 
__u£r
 *
addr
, 
addæí
)

356 
ß_Ámûy_t
 
ß_Ámûy
;

357 i‡(
addæí
 == 112 &&

358 
	`gë_u£r
(
ß_Ámûy
, &
addr
->sa_family) == 0 &&

359 
ß_Ámûy
 =
AF_UNIX
)

360 
addæí
 = 110;

361  
	`sys_böd
(
fd
, 
addr
, 
addæí
);

362 
	}
}

364 
asmlökage
 
	$sys_ﬂbi_c⁄√˘
(
fd
, 
sockaddr
 
__u£r
 *
addr
, 
addæí
)

366 
ß_Ámûy_t
 
ß_Ámûy
;

367 i‡(
addæí
 == 112 &&

368 
	`gë_u£r
(
ß_Ámûy
, &
addr
->sa_family) == 0 &&

369 
ß_Ámûy
 =
AF_UNIX
)

370 
addæí
 = 110;

371  
	`sys_c⁄√˘
(
fd
, 
addr
, 
addæí
);

372 
	}
}

374 
asmlökage
 
	$sys_ﬂbi_£ndto
(
fd
, 
__u£r
 *
buff
,

375 
size_t
 
Àn
, 
Êags
,

376 
sockaddr
 
__u£r
 *
addr
,

377 
addæí
)

379 
ß_Ámûy_t
 
ß_Ámûy
;

380 i‡(
addæí
 == 112 &&

381 
	`gë_u£r
(
ß_Ámûy
, &
addr
->sa_family) == 0 &&

382 
ß_Ámûy
 =
AF_UNIX
)

383 
addæí
 = 110;

384  
	`sys_£ndto
(
fd
, 
buff
, 
Àn
, 
Êags
, 
addr
, 
addæí
);

385 
	}
}

387 
asmlökage
 
	$sys_ﬂbi_£ndmsg
(
fd
, 
msghdr
 
__u£r
 *
msg
, 
Êags
)

389 
sockaddr
 
__u£r
 *
addr
;

390 
msg_«mñí
;

391 
ß_Ámûy_t
 
ß_Ámûy
;

392 i‡(
msg
 &&

393 
	`gë_u£r
(
msg_«mñí
, &
msg
->msg_namelen) == 0 &&

394 
msg_«mñí
 == 112 &&

395 
	`gë_u£r
(
addr
, &
msg
->
msg_«me
) == 0 &&

396 
	`gë_u£r
(
ß_Ámûy
, &
addr
->sa_family) == 0 &&

397 
ß_Ámûy
 =
AF_UNIX
)

408 
	`put_u£r
(110, &
msg
->
msg_«mñí
);

410  
	`sys_£ndmsg
(
fd
, 
msg
, 
Êags
);

411 
	}
}

413 
asmlökage
 
	$sys_ﬂbi_sockëˇŒ
(
ˇŒ
, 
__u£r
 *
¨gs
)

415 
r
 = -
EFAULT
, 
a
[6];

417 
ˇŒ
) {

418 
SYS_BIND
:

419 i‡(
	`c›y_‰om_u£r
(
a
, 
¨gs
, 3 * ()) == 0)

420 
r
 = 
	`sys_ﬂbi_böd
(
a
[0], (
sockaddr
 
__u£r
 *)a[1],á[2]);

422 
SYS_CONNECT
:

423 i‡(
	`c›y_‰om_u£r
(
a
, 
¨gs
, 3 * ()) == 0)

424 
r
 = 
	`sys_ﬂbi_c⁄√˘
(
a
[0], (
sockaddr
 
__u£r
 *)a[1],á[2]);

426 
SYS_SENDTO
:

427 i‡(
	`c›y_‰om_u£r
(
a
, 
¨gs
, 6 * ()) == 0)

428 
r
 = 
	`sys_ﬂbi_£ndto
(
a
[0], (
__u£r
 *)a[1],á[2],á[3],

429 (
sockaddr
 
__u£r
 *)
a
[4],á[5]);

431 
SYS_SENDMSG
:

432 i‡(
	`c›y_‰om_u£r
(
a
, 
¨gs
, 3 * ()) == 0)

433 
r
 = 
	`sys_ﬂbi_£ndmsg
(
a
[0], (
msghdr
 
__u£r
 *)a[1],á[2]);

436 
r
 = 
	`sys_sockëˇŒ
(
ˇŒ
, 
¨gs
);

439  
r
;

440 
	}
}

	@arch/arm/kernel/time.c

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/time.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/smp.h
>

25 
	~<löux/timex.h
>

26 
	~<löux/î∫o.h
>

27 
	~<löux/¥ofûe.h
>

28 
	~<löux/sysdev.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/úq.h
>

32 
	~<löux/mc146818πc.h
>

34 
	~<asm/Àds.h
>

35 
	~<asm/thªad_öfo.h
>

36 
	~<asm/mach/time.h
>

41 
sys_timî
 *
	gsy°em_timî
;

43 #i‡
deföed
(
CONFIG_RTC_DRV_CMOS
Ë|| deföed(
CONFIG_RTC_DRV_CMOS_MODULE
)

45 
DEFINE_SPINLOCK
(
πc_lock
);

47 #ifde‡
CONFIG_RTC_DRV_CMOS_MODULE


48 
EXPORT_SYMBOL
(
πc_lock
);

53 
	#USECS_PER_JIFFY
 (1000000/
HZ
)

	)

55 #ifde‡
CONFIG_SMP


56 
	$¥ofûe_pc
(
±_ªgs
 *
ªgs
)

58 
Â
, 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

60 i‡(
	`ö_lock_fun˘i⁄s
(
pc
)) {

61 
Â
 = 
ªgs
->
ARM_Â
;

62 
pc
 = 
	`pc_poöãr
(((*)
Â
)[-1]);

65  
pc
;

66 
	}
}

67 
EXPORT_SYMBOL
(
¥ofûe_pc
);

73 (*
£t_πc
)();

75 #i‚de‡
CONFIG_GENERIC_TIME


76 
	$dummy_gëtimeoff£t
()

79 
	}
}

87 
	$¥ötk_˛ock
()

89  ()(
jiffõs
 - 
INITIAL_JIFFIES
) *

90 (1000000000 / 
HZ
);

91 
	}
}

93 
	g√xt_πc_upd©e
;

101 
ölöe
 
	$do_£t_πc
()

103 i‡(!
	`¡p_syn˚d
(Ë|| 
£t_πc
 =
NULL
)

106 i‡(
√xt_πc_upd©e
 &&

107 
	`time_bef‹e
(()
xtime
.
tv_£c
, 
√xt_πc_upd©e
))

110 i‡(
xtime
.
tv_n£c
 < 500000000 - ((Ë
tick_n£c
 >> 1) &&

111 
xtime
.
tv_n£c
 >500000000 + ((Ë
tick_n£c
 >> 1))

114 i‡(
	`£t_πc
())

118 
√xt_πc_upd©e
 = 
xtime
.
tv_£c
 + 60;

120 
√xt_πc_upd©e
 = 
xtime
.
tv_£c
 + 660;

121 
	}
}

123 #ifde‡
CONFIG_LEDS


125 
	$dummy_Àds_evít
(
Àd_evít_t
 
evt
)

127 
	}
}

129 (*
Àds_evít
)(
Àd_evít_t
Ë
dummy_Àds_evít
;

131 
	sÀds_evt_«me
 {

132 c⁄° 
«me
[8];

133 
⁄
;

134 
off
;

137 c⁄° 
Àds_evt_«me
 
evt_«mes
[] = {

138 { "ambî", 
Àd_ambî_⁄
, 
Àd_ambî_off
 },

139 { "blue", 
Àd_blue_⁄
, 
Àd_blue_off
 },

140 { "gªí", 
Àd_gªí_⁄
, 
Àd_gªí_off
 },

141 { "ªd", 
Àd_ªd_⁄
, 
Àd_ªd_off
 },

142 
	}
};

144 
ssize_t
 
	$Àds_°‹e
(
sys_devi˚
 *
dev
, c⁄° *
buf
, 
size_t
 
size
)

146 
ªt
 = -
EINVAL
, 
Àn
 = 
	`°rc•n
(
buf
, " ");

148 i‡(
Àn
 > 0 && 
buf
[len] == '\0')

149 
Àn
--;

151 i‡(
	`°∫cmp
(
buf
, "˛aim", 
Àn
) == 0) {

152 
	`Àds_evít
(
Àd_˛aim
);

153 
ªt
 = 
size
;

154 } i‡(
	`°∫cmp
(
buf
, "ªÀa£", 
Àn
) == 0) {

155 
	`Àds_evít
(
Àd_ªÀa£
);

156 
ªt
 = 
size
;

158 
i
;

160 
i
 = 0; i < 
	`ARRAY_SIZE
(
evt_«mes
); i++) {

161 i‡(
	`°æí
(
evt_«mes
[
i
].
«me
Ë!
Àn
 ||

162 
	`°∫cmp
(
buf
, 
evt_«mes
[
i
].
«me
, 
Àn
) != 0)

164 i‡(
	`°∫cmp
(
buf
+
Àn
, " on", 3) == 0) {

165 
	`Àds_evít
(
evt_«mes
[
i
].
⁄
);

166 
ªt
 = 
size
;

167 } i‡(
	`°∫cmp
(
buf
+
Àn
, " off", 4) == 0) {

168 
	`Àds_evít
(
evt_«mes
[
i
].
off
);

169 
ªt
 = 
size
;

174  
ªt
;

175 
	}
}

177 
SYSDEV_ATTR
(
evít
, 0200, 
NULL
, 
Àds_°‹e
);

179 
	$Àds_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

181 
	`Àds_evít
(
Àd_°›
);

183 
	}
}

185 
	$Àds_ªsume
(
sys_devi˚
 *
dev
)

187 
	`Àds_evít
(
Àd_°¨t
);

189 
	}
}

191 
	$Àds_shutdown
(
sys_devi˚
 *
dev
)

193 
	`Àds_evít
(
Àd_hÆãd
);

195 
	}
}

197 
sysdev_˛ass
 
	gÀds_sys˛ass
 = {

198 
£t_k£t_«me
("leds"),

199 .
shutdown
 = 
Àds_shutdown
,

200 .
	gsu•íd
 = 
Àds_su•íd
,

201 .
	gªsume
 = 
Àds_ªsume
,

204 
sys_devi˚
 
	gÀds_devi˚
 = {

205 .
id
 = 0,

206 .
	g˛s
 = &
Àds_sys˛ass
,

209 
__öô
 
	$Àds_öô
()

211 
ªt
;

212 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
Àds_sys˛ass
);

213 i‡(
ªt
 == 0)

214 
ªt
 = 
	`sysdev_ªgi°î
(&
Àds_devi˚
);

215 i‡(
ªt
 == 0)

216 
ªt
 = 
	`sysdev_¸óã_fûe
(&
Àds_devi˚
, &
©å_evít
);

217  
ªt
;

218 
	}
}

220 
devi˚_öôˇŒ
(
Àds_öô
);

222 
EXPORT_SYMBOL
(
Àds_evít
);

225 #ifde‡
CONFIG_LEDS_TIMER


226 
ölöe
 
	$do_Àds
()

228 
cou¡
 = 
HZ
/2;

230 i‡(--
cou¡
 == 0) {

231 
cou¡
 = 
HZ
/2;

232 
	`Àds_evít
(
Àd_timî
);

234 
	}
}

236 
	#do_Àds
()

	)

239 #i‚de‡
CONFIG_GENERIC_TIME


240 
	$do_gëtimeofday
(
timevÆ
 *
tv
)

242 
Êags
;

243 
£q
;

244 
u£c
, 
£c
;

247 
£q
 = 
	`ªad_£qbegö_úqßve
(&
xtime_lock
, 
Êags
);

248 
u£c
 = 
sy°em_timî
->
	`off£t
();

249 
£c
 = 
xtime
.
tv_£c
;

250 
u£c
 +
xtime
.
tv_n£c
 / 1000;

251 } 
	`ªad_£qªåy_úqª°‹e
(&
xtime_lock
, 
£q
, 
Êags
));

254 
u£c
 >= 1000000) {

255 
u£c
 -= 1000000;

256 
£c
++;

259 
tv
->
tv_£c
 = 
£c
;

260 
tv
->
tv_u£c
 = 
u£c
;

261 
	}
}

263 
EXPORT_SYMBOL
(
do_gëtimeofday
);

265 
	$do_£âimeofday
(
time•ec
 *
tv
)

267 
time_t
 
wtm_£c
, 
£c
 = 
tv
->
tv_£c
;

268 
wtm_n£c
, 
n£c
 = 
tv
->
tv_n£c
;

270 i‡(()
tv
->
tv_n£c
 >
NSEC_PER_SEC
)

271  -
EINVAL
;

273 
	`wrôe_£qlock_úq
(&
xtime_lock
);

280 
n£c
 -
sy°em_timî
->
	`off£t
(Ë* 
NSEC_PER_USEC
;

282 
wtm_£c
 = 
wÆl_to_m⁄Ÿ⁄ic
.
tv_£c
 + (
xtime
.tv_£¯- 
£c
);

283 
wtm_n£c
 = 
wÆl_to_m⁄Ÿ⁄ic
.
tv_n£c
 + (
xtime
.tv_n£¯- 
n£c
);

285 
	`£t_n‹mÆized_time•ec
(&
xtime
, 
£c
, 
n£c
);

286 
	`£t_n‹mÆized_time•ec
(&
wÆl_to_m⁄Ÿ⁄ic
, 
wtm_£c
, 
wtm_n£c
);

288 
	`¡p_˛ór
();

289 
	`wrôe_£qu∆ock_úq
(&
xtime_lock
);

290 
	`˛ock_was_£t
();

292 
	}
}

294 
EXPORT_SYMBOL
(
do_£âimeofday
);

305 
	$ßve_time_dñè
(
time•ec
 *
dñè
, time•e¯*
πc
)

307 
	`£t_n‹mÆized_time•ec
(
dñè
,

308 
xtime
.
tv_£c
 - 
πc
->tv_sec,

309 
xtime
.
tv_n£c
 - 
πc
->tv_nsec);

310 
	}
}

311 
EXPORT_SYMBOL
(
ßve_time_dñè
);

318 
	$ª°‹e_time_dñè
(
time•ec
 *
dñè
, time•e¯*
πc
)

320 
time•ec
 
ts
;

322 
	`£t_n‹mÆized_time•ec
(&
ts
,

323 
dñè
->
tv_£c
 + 
πc
->tv_sec,

324 
dñè
->
tv_n£c
 + 
πc
->tv_nsec);

326 
	`do_£âimeofday
(&
ts
);

327 
	}
}

328 
EXPORT_SYMBOL
(
ª°‹e_time_dñè
);

330 #i‚de‡
CONFIG_GENERIC_CLOCKEVENTS


334 
	$timî_tick
()

336 
	`¥ofûe_tick
(
CPU_PROFILING
);

337 
	`do_Àds
();

338 
	`do_£t_πc
();

339 
	`do_timî
(1);

340 #i‚de‡
CONFIG_SMP


341 
	`upd©e_¥o˚ss_times
(
	`u£r_mode
(
	`gë_úq_ªgs
()));

343 
	}
}

346 #i‡
deföed
(
CONFIG_PM
Ë&& !deföed(
CONFIG_GENERIC_CLOCKEVENTS
)

347 
	$timî_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

349 
sys_timî
 *
timî
 = 
	`c⁄èöî_of
(
dev
, sys_timer, dev);

351 i‡(
timî
->
su•íd
 !
NULL
)

352 
timî
->
	`su•íd
();

355 
	}
}

357 
	$timî_ªsume
(
sys_devi˚
 *
dev
)

359 
sys_timî
 *
timî
 = 
	`c⁄èöî_of
(
dev
, sys_timer, dev);

361 i‡(
timî
->
ªsume
 !
NULL
)

362 
timî
->
	`ªsume
();

365 
	}
}

367 
	#timî_su•íd
 
NULL


	)

368 
	#timî_ªsume
 
NULL


	)

371 
sysdev_˛ass
 
	gtimî_sys˛ass
 = {

372 
£t_k£t_«me
("timer"),

373 .
su•íd
 = 
timî_su•íd
,

374 .
	gªsume
 = 
timî_ªsume
,

377 #ifde‡
CONFIG_NO_IDLE_HZ


378 
	$timî_dyn_tick_íabÀ
()

380 
dyn_tick_timî
 *
dyn_tick
 = 
sy°em_timî
->dyn_tick;

381 
Êags
;

382 
ªt
 = -
ENODEV
;

384 i‡(
dyn_tick
) {

385 
	`•ö_lock_úqßve
(&
dyn_tick
->
lock
, 
Êags
);

386 
ªt
 = 0;

387 i‡(!(
dyn_tick
->
°©e
 & 
DYN_TICK_ENABLED
)) {

388 
ªt
 = 
dyn_tick
->
	`íabÀ
();

390 i‡(
ªt
 == 0)

391 
dyn_tick
->
°©e
 |
DYN_TICK_ENABLED
;

393 
	`•ö_u∆ock_úqª°‹e
(&
dyn_tick
->
lock
, 
Êags
);

396  
ªt
;

397 
	}
}

399 
	$timî_dyn_tick_dißbÀ
()

401 
dyn_tick_timî
 *
dyn_tick
 = 
sy°em_timî
->dyn_tick;

402 
Êags
;

403 
ªt
 = -
ENODEV
;

405 i‡(
dyn_tick
) {

406 
	`•ö_lock_úqßve
(&
dyn_tick
->
lock
, 
Êags
);

407 
ªt
 = 0;

408 i‡(
dyn_tick
->
°©e
 & 
DYN_TICK_ENABLED
) {

409 
ªt
 = 
dyn_tick
->
	`dißbÀ
();

411 i‡(
ªt
 == 0)

412 
dyn_tick
->
°©e
 &~
DYN_TICK_ENABLED
;

414 
	`•ö_u∆ock_úqª°‹e
(&
dyn_tick
->
lock
, 
Êags
);

417  
ªt
;

418 
	}
}

425 
	$timî_dyn_ª¥ogøm
()

427 
dyn_tick_timî
 *
dyn_tick
 = 
sy°em_timî
->dyn_tick;

428 
√xt
, 
£q
, 
Êags
;

430 i‡(!
dyn_tick
)

433 
	`•ö_lock_úqßve
(&
dyn_tick
->
lock
, 
Êags
);

434 i‡(
dyn_tick
->
°©e
 & 
DYN_TICK_ENABLED
) {

435 
√xt
 = 
	`√xt_timî_öãºu±
();

437 
£q
 = 
	`ªad_£qbegö
(&
xtime_lock
);

438 
dyn_tick
->
	`ª¥ogøm
(
√xt
 - 
jiffõs
);

439 } 
	`ªad_£qªåy
(&
xtime_lock
, 
£q
));

441 
	`•ö_u∆ock_úqª°‹e
(&
dyn_tick
->
lock
, 
Êags
);

442 
	}
}

444 
ssize_t
 
	$timî_show_dyn_tick
(
sys_devi˚
 *
dev
, *
buf
)

446  
	`•rötf
(
buf
, "%i\n",

447 (
sy°em_timî
->
dyn_tick
->
°©e
 & 
DYN_TICK_ENABLED
) >> 1);

448 
	}
}

450 
ssize_t
 
	$timî_£t_dyn_tick
(
sys_devi˚
 *
dev
, c⁄° *
buf
,

451 
size_t
 
cou¡
)

453 
íabÀ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 2);

455 i‡(
íabÀ
)

456 
	`timî_dyn_tick_íabÀ
();

458 
	`timî_dyn_tick_dißbÀ
();

460  
cou¡
;

461 
	}
}

462 
SYSDEV_ATTR
(
dyn_tick
, 0644, 
timî_show_dyn_tick
, 
timî_£t_dyn_tick
);

467 
	gdy¡ick_°r
[4] 
	g__öôd©a
 = "";

469 
__öô
 
	$dy¡ick_£tup
(*
°r
)

471 i‡(
°r
)

472 
	`°æ˝y
(
dy¡ick_°r
, 
°r
, (dyntick_str));

474 
	}
}

476 
__£tup
("dy¡ick=", 
dy¡ick_£tup
);

479 
__öô
 
	$timî_öô_sysfs
()

481 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
timî_sys˛ass
);

482 i‡(
ªt
 == 0) {

483 
sy°em_timî
->
dev
.
˛s
 = &
timî_sys˛ass
;

484 
ªt
 = 
	`sysdev_ªgi°î
(&
sy°em_timî
->
dev
);

487 #ifde‡
CONFIG_NO_IDLE_HZ


488 i‡(
ªt
 =0 && 
sy°em_timî
->
dyn_tick
) {

489 
ªt
 = 
	`sysdev_¸óã_fûe
(&
sy°em_timî
->
dev
, &
©å_dyn_tick
);

495 i‡(
ªt
 =0 && 
dy¡ick_°r
[0] == 'e')

496 
ªt
 = 
	`timî_dyn_tick_íabÀ
();

500  
ªt
;

501 
	}
}

503 
devi˚_öôˇŒ
(
timî_öô_sysfs
);

505 
__öô
 
	$time_öô
()

507 #i‚de‡
CONFIG_GENERIC_TIME


508 i‡(
sy°em_timî
->
off£t
 =
NULL
)

509 
sy°em_timî
->
off£t
 = 
dummy_gëtimeoff£t
;

511 
sy°em_timî
->
	`öô
();

513 #ifde‡
CONFIG_NO_IDLE_HZ


514 i‡(
sy°em_timî
->
dyn_tick
)

515 
	`•ö_lock_öô
(&
sy°em_timî
->
dyn_tick
->
lock
);

517 
	}
}

	@arch/arm/kernel/traps.c

15 
	~<löux/moduÀ.h
>

16 
	~<löux/sig«l.h
>

17 
	~<löux/•ölock.h
>

18 
	~<löux/≥rs⁄Æôy.h
>

19 
	~<löux/kÆlsyms.h
>

20 
	~<löux/dñay.h
>

21 
	~<löux/öô.h
>

23 
	~<asm/©omic.h
>

24 
	~<asm/ˇcheÊush.h
>

25 
	~<asm/sy°em.h
>

26 
	~<asm/uac˚ss.h
>

27 
	~<asm/uni°d.h
>

28 
	~<asm/å≠s.h
>

29 
	~<asm/io.h
>

31 
	~"±ø˚.h
"

32 
	~"sig«l.h
"

34 c⁄° *
	gh™dÀr
[]= { "prefetchábort", "dataábort", "addressÉxception", "interrupt" };

36 #ifde‡
CONFIG_DEBUG_USER


37 
	gu£r_debug
;

39 
__öô
 
	$u£r_debug_£tup
(*
°r
)

41 
	`gë_›ti⁄
(&
°r
, &
u£r_debug
);

43 
	}
}

44 
__£tup
("u£r_debug=", 
u£r_debug_£tup
);

47 
dump_mem
(c⁄° *
°r
, 
bŸtom
, 
t›
);

49 
ölöe
 
	$ö_ex˚±i⁄_ãxt
(
±r
)

51 
__ex˚±i⁄_ãxt_°¨t
[];

52 
__ex˚±i⁄_ãxt_íd
[];

54  
±r
 >()&
__ex˚±i⁄_ãxt_°¨t
 &&

55 
±r
 < ()&
__ex˚±i⁄_ãxt_íd
;

56 
	}
}

58 
	$dump_backåa˚_íåy
(
whîe
, 
‰om
, 
‰ame
)

60 #ifde‡
CONFIG_KALLSYMS


61 
	`¥ötk
("[<%08lx>] ", 
whîe
);

62 
	`¥öt_symbﬁ
("(%sË", 
whîe
);

63 
	`¥ötk
("‰om [<%08lx>] ", 
‰om
);

64 
	`¥öt_symbﬁ
("(%s)\n", 
‰om
);

66 
	`¥ötk
("Fun˘i⁄É¡îedáà[<%08lx>] from [<%08lx>]\n", 
whîe
, 
‰om
);

69 i‡(
	`ö_ex˚±i⁄_ãxt
(
whîe
))

70 
	`dump_mem
("Ex˚±i⁄ sèck", 
‰ame
 + 4, fømê+ 4 + (
±_ªgs
));

71 
	}
}

78 
	$vîify_°ack
(
•
)

80 i‡(
•
 < 
PAGE_OFFSET
 || (• > ()
high_mem‹y
 && high_memory != 0))

81  -
EFAULT
;

84 
	}
}

89 
	$dump_mem
(c⁄° *
°r
, 
bŸtom
, 
t›
)

91 
p
 = 
bŸtom
 & ~31;

92 
mm_£gmít_t
 
fs
;

93 
i
;

100 
fs
 = 
	`gë_fs
();

101 
	`£t_fs
(
KERNEL_DS
);

103 
	`¥ötk
("%s(0x%08lxÅÿ0x%08lx)\n", 
°r
, 
bŸtom
, 
t›
);

105 
p
 = 
bŸtom
 & ~31;Ö < 
t›
;) {

106 
	`¥ötk
("%04lx: ", 
p
 & 0xffff);

108 
i
 = 0; i < 8; i++, 
p
 += 4) {

109 
vÆ
;

111 i‡(
p
 < 
bŸtom
 ||Ö >
t›
)

112 
	`¥ötk
(" ");

114 
	`__gë_u£r
(
vÆ
, (*)
p
);

115 
	`¥ötk
("%08x ", 
vÆ
);

118 
	`¥ötk
 ("\n");

121 
	`£t_fs
(
fs
);

122 
	}
}

124 
	$dump_ö°r
(
±_ªgs
 *
ªgs
)

126 
addr
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

127 c⁄° 
thumb
 = 
	`thumb_mode
(
ªgs
);

128 c⁄° 
width
 = 
thumb
 ? 4 : 8;

129 
mm_£gmít_t
 
fs
;

130 
i
;

137 
fs
 = 
	`gë_fs
();

138 
	`£t_fs
(
KERNEL_DS
);

140 
	`¥ötk
("Code: ");

141 
i
 = -4; i < 1; i++) {

142 
vÆ
, 
bad
;

144 i‡(
thumb
)

145 
bad
 = 
	`__gë_u£r
(
vÆ
, &((
u16
 *)
addr
)[
i
]);

147 
bad
 = 
	`__gë_u£r
(
vÆ
, &((
u32
 *)
addr
)[
i
]);

149 i‡(!
bad
)

150 
	`¥ötk
(
i
 =0 ? "(%0*xË" : "%0*x ", 
width
, 
vÆ
);

152 
	`¥ötk
("bad PC value.");

156 
	`¥ötk
("\n");

158 
	`£t_fs
(
fs
);

159 
	}
}

161 
	$dump_backåa˚
(
±_ªgs
 *
ªgs
, 
èsk_°ru˘
 *
tsk
)

163 
Â
;

164 
ok
 = 1;

166 
	`¥ötk
("Backtrace: ");

167 
Â
 = 
ªgs
->
ARM_Â
;

168 i‡(!
Â
) {

169 
	`¥ötk
("no frameÖointer");

170 
ok
 = 0;

171 } i‡(
	`vîify_°ack
(
Â
)) {

172 
	`¥ötk
("övÆid fømêpoöã∏0x%08x", 
Â
);

173 
ok
 = 0;

174 } i‡(
Â
 < ()
	`íd_of_°ack
(
tsk
))

175 
	`¥ötk
("frameÖointer underflow");

176 
	`¥ötk
("\n");

178 i‡(
ok
)

179 
	`c_backåa˚
(
Â
, 
	`¥o˚ss‹_mode
(
ªgs
));

180 
	}
}

182 
	$dump_°ack
()

184 
	`__backåa˚
();

185 
	}
}

187 
EXPORT_SYMBOL
(
dump_°ack
);

189 
	$show_°ack
(
èsk_°ru˘
 *
tsk
, *
•
)

191 
Â
;

193 i‡(!
tsk
)

194 
tsk
 = 
cuºít
;

196 i‡(
tsk
 !
cuºít
)

197 
Â
 = 
	`thªad_ßved_Â
(
tsk
);

199 
	`asm
("mov %0, fp" : "Ù" (
Â
) : : "cc");

201 
	`c_backåa˚
(
Â
, 0x10);

202 
	`b¨rõr
();

203 
	}
}

205 #ifde‡
CONFIG_PREEMPT


206 
	#S_PREEMPT
 " PREEMPT"

	)

208 
	#S_PREEMPT
 ""

	)

210 #ifde‡
CONFIG_SMP


211 
	#S_SMP
 " SMP"

	)

213 
	#S_SMP
 ""

	)

216 
	$__dõ
(c⁄° *
°r
, 
îr
, 
thªad_öfo
 *
thªad
, 
±_ªgs
 *
ªgs
)

218 
èsk_°ru˘
 *
tsk
 = 
thªad
->
èsk
;

219 
dõ_cou¡î
;

221 
	`¥ötk
("I¡î«»îr‹: %s: %x [#%d]" 
S_PREEMPT
 
S_SMP
 "\n",

222 
°r
, 
îr
, ++
dõ_cou¡î
);

223 
	`¥öt_moduÀs
();

224 
	`__show_ªgs
(
ªgs
);

225 
	`¥ötk
("Process %s (pid: %d, stackÜimit = 0x%p)\n",

226 
tsk
->
comm
,Åsk->
pid
, 
thªad
 + 1);

228 i‡(!
	`u£r_mode
(
ªgs
Ë|| 
	`ö_öãºu±
()) {

229 
	`dump_mem
("Sèck: ", 
ªgs
->
ARM_•
,

230 
THREAD_SIZE
 + ()
	`èsk_°ack_∑ge
(
tsk
));

231 
	`dump_backåa˚
(
ªgs
, 
tsk
);

232 
	`dump_ö°r
(
ªgs
);

234 
	}
}

236 
DEFINE_SPINLOCK
(
dõ_lock
);

241 
NORET_TYPE
 
	$dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
, 
îr
)

243 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

245 
	`o›s_íãr
();

247 
	`c⁄sﬁe_vîbo£
();

248 
	`•ö_lock_úq
(&
dõ_lock
);

249 
	`bu°_•ölocks
(1);

250 
	`__dõ
(
°r
, 
îr
, 
thªad
, 
ªgs
);

251 
	`bu°_•ölocks
(0);

252 
	`•ö_u∆ock_úq
(&
dõ_lock
);

254 i‡(
	`ö_öãºu±
())

255 
	`∑nic
("FatalÉxception in interrupt");

257 i‡(
∑nic_⁄_o›s
)

258 
	`∑nic
("FatalÉxception");

260 
	`o›s_exô
();

261 
	`do_exô
(
SIGSEGV
);

262 
	}
}

264 
	$¨m_nŸify_dõ
(c⁄° *
°r
, 
±_ªgs
 *
ªgs
,

265 
sigöfo
 *
öfo
, 
îr
, 
å≠
)

267 i‡(
	`u£r_mode
(
ªgs
)) {

268 
cuºít
->
thªad
.
îr‹_code
 = 
îr
;

269 
cuºít
->
thªad
.
å≠_no
 = 
å≠
;

271 
	`f‹˚_sig_öfo
(
öfo
->
si_signo
, info, 
cuºít
);

273 
	`dõ
(
°r
, 
ªgs
, 
îr
);

275 
	}
}

277 
LIST_HEAD
(
undef_hook
);

278 
DEFINE_SPINLOCK
(
undef_lock
);

280 
	$ªgi°î_undef_hook
(
undef_hook
 *
hook
)

282 
Êags
;

284 
	`•ö_lock_úqßve
(&
undef_lock
, 
Êags
);

285 
	`li°_add
(&
hook
->
node
, &
undef_hook
);

286 
	`•ö_u∆ock_úqª°‹e
(&
undef_lock
, 
Êags
);

287 
	}
}

289 
	$uƒegi°î_undef_hook
(
undef_hook
 *
hook
)

291 
Êags
;

293 
	`•ö_lock_úqßve
(&
undef_lock
, 
Êags
);

294 
	`li°_dñ
(&
hook
->
node
);

295 
	`•ö_u∆ock_úqª°‹e
(&
undef_lock
, 
Êags
);

296 
	}
}

298 
asmlökage
 
__ex˚±i⁄
 
	$do_undefö°r
(
±_ªgs
 *
ªgs
)

300 
c‹ª˘i⁄
 = 
	`thumb_mode
(
ªgs
) ? 2 : 4;

301 
ö°r
;

302 
undef_hook
 *
hook
;

303 
sigöfo_t
 
öfo
;

304 
__u£r
 *
pc
;

305 
Êags
;

312 
ªgs
->
ARM_pc
 -
c‹ª˘i⁄
;

314 
pc
 = (
__u£r
 *)
	`ö°ru˘i⁄_poöãr
(
ªgs
);

316 i‡(
	`¥o˚ss‹_mode
(
ªgs
Ë=
SVC_MODE
) {

317 
ö°r
 = *(
u32
 *Ë
pc
;

318 } i‡(
	`thumb_mode
(
ªgs
)) {

319 
	`gë_u£r
(
ö°r
, (
u16
 
__u£r
 *)
pc
);

321 
	`gë_u£r
(
ö°r
, (
u32
 
__u£r
 *)
pc
);

324 
	`•ö_lock_úqßve
(&
undef_lock
, 
Êags
);

325 
	`li°_f‹_óch_íåy
(
hook
, &
undef_hook
, 
node
) {

326 i‡((
ö°r
 & 
hook
->
ö°r_mask
Ë=hook->
ö°r_vÆ
 &&

327 (
ªgs
->
ARM_˝§
 & 
hook
->
˝§_mask
Ë=hook->
˝§_vÆ
) {

328 i‡(
hook
->
	`‚
(
ªgs
, 
ö°r
) == 0) {

329 
	`•ö_u∆ock_úq
(&
undef_lock
);

334 
	`•ö_u∆ock_úqª°‹e
(&
undef_lock
, 
Êags
);

336 #ifde‡
CONFIG_DEBUG_USER


337 i‡(
u£r_debug
 & 
UDBG_UNDEFINED
) {

338 
	`¥ötk
(
KERN_INFO
 "%s (%d): undefined instruction:Öc=%p\n",

339 
cuºít
->
comm
, cuºít->
pid
, 
pc
);

340 
	`dump_ö°r
(
ªgs
);

344 
öfo
.
si_signo
 = 
SIGILL
;

345 
öfo
.
si_î∫o
 = 0;

346 
öfo
.
si_code
 = 
ILL_ILLOPC
;

347 
öfo
.
si_addr
 = 
pc
;

349 
	`¨m_nŸify_dõ
("O›†- undeföed in°ru˘i⁄", 
ªgs
, &
öfo
, 0, 6);

350 
	}
}

352 
asmlökage
 
	$do_u√xp_fiq
 (
±_ªgs
 *
ªgs
)

354 #i‚de‡
CONFIG_IGNORE_FIQ


355 
	`¥ötk
("Hmm. Unexpected FIQÑeceived, butÅryingÅo continue\n");

356 
	`¥ötk
("You may haveá hardwareÖroblem...\n");

358 
	}
}

366 
asmlökage
 
	$bad_mode
(
±_ªgs
 *
ªgs
, 
ªas⁄
)

368 
	`c⁄sﬁe_vîbo£
();

370 
	`¥ötk
(
KERN_CRIT
 "Bad modêö %†h™dÀ∏dëe˘ed\n", 
h™dÀr
[
ªas⁄
]);

372 
	`dõ
("O›†- bad mode", 
ªgs
, 0);

373 
	`loˇl_úq_dißbÀ
();

374 
	`∑nic
("bad mode");

375 
	}
}

377 
	$bad_sysˇŒ
(
n
, 
±_ªgs
 *
ªgs
)

379 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

380 
sigöfo_t
 
öfo
;

382 i‡(
cuºít
->
≥rs⁄Æôy
 !
PER_LINUX
 &&

383 
cuºít
->
≥rs⁄Æôy
 !
PER_LINUX_32BIT
 &&

384 
thªad
->
exec_domaö
->
h™dÀr
) {

385 
thªad
->
exec_domaö
->
	`h™dÀr
(
n
, 
ªgs
);

386  
ªgs
->
ARM_r0
;

389 #ifde‡
CONFIG_DEBUG_USER


390 i‡(
u£r_debug
 & 
UDBG_SYSCALL
) {

391 
	`¥ötk
(
KERN_ERR
 "[%d] %s: obsolete system call %08x.\n",

392 
cuºít
->
pid
, cuºít->
comm
, 
n
);

393 
	`dump_ö°r
(
ªgs
);

397 
öfo
.
si_signo
 = 
SIGILL
;

398 
öfo
.
si_î∫o
 = 0;

399 
öfo
.
si_code
 = 
ILL_ILLTRP
;

400 
öfo
.
si_addr
 = (
__u£r
 *)
	`ö°ru˘i⁄_poöãr
(
ªgs
) -

401 (
	`thumb_mode
(
ªgs
) ? 2 : 4);

403 
	`¨m_nŸify_dõ
("O›†- bad sysˇŒ", 
ªgs
, &
öfo
, 
n
, 0);

405  
ªgs
->
ARM_r0
;

406 
	}
}

408 
ölöe
 

409 
	$do_ˇche_›
(
°¨t
, 
íd
, 
Êags
)

411 
vm_¨ó_°ru˘
 *
vma
;

413 i‡(
íd
 < 
°¨t
 || 
Êags
)

416 
vma
 = 
	`föd_vma
(
cuºít
->
a˘ive_mm
, 
°¨t
);

417 i‡(
vma
 && vma->
vm_°¨t
 < 
íd
) {

418 i‡(
°¨t
 < 
vma
->
vm_°¨t
)

419 
°¨t
 = 
vma
->
vm_°¨t
;

420 i‡(
íd
 > 
vma
->
vm_íd
)

421 
íd
 = 
vma
->
vm_íd
;

423 
	`Êush_ˇche_u£r_ønge
(
vma
, 
°¨t
, 
íd
);

425 
	}
}

431 
	#NR
(
x
Ë((
__ARM_NR_
##xË- 
__ARM_NR_BASE
)

	)

432 
asmlökage
 
	$¨m_sysˇŒ
(
no
, 
±_ªgs
 *
ªgs
)

434 
thªad_öfo
 *
thªad
 = 
	`cuºít_thªad_öfo
();

435 
sigöfo_t
 
öfo
;

437 i‡((
no
 >> 16Ë!(
__ARM_NR_BASE
>> 16))

438  
	`bad_sysˇŒ
(
no
, 
ªgs
);

440 
no
 & 0xffff) {

442 
öfo
.
si_signo
 = 
SIGSEGV
;

443 
öfo
.
si_î∫o
 = 0;

444 
öfo
.
si_code
 = 
SEGV_MAPERR
;

445 
öfo
.
si_addr
 = 
NULL
;

447 
	`¨m_nŸify_dõ
("bønchÅhrough zîo", 
ªgs
, &
öfo
, 0, 0);

450 
	`NR
(
bªakpoöt
):

451 
ªgs
->
ARM_pc
 -
	`thumb_mode
(regs) ? 2 : 4;

452 
	`±ø˚_bªak
(
cuºít
, 
ªgs
);

453  
ªgs
->
ARM_r0
;

469 
	`NR
(
ˇcheÊush
):

470 
	`do_ˇche_›
(
ªgs
->
ARM_r0
,Ñegs->
ARM_r1
,Ñegs->
ARM_r2
);

473 
	`NR
(
u§26
):

474 i‡(!(
ñf_hwˇp
 & 
HWCAP_26BIT
))

476 
ªgs
->
ARM_˝§
 &~
MODE32_BIT
;

477  
ªgs
->
ARM_r0
;

479 
	`NR
(
u§32
):

480 i‡(!(
ñf_hwˇp
 & 
HWCAP_26BIT
))

482 
ªgs
->
ARM_˝§
 |
MODE32_BIT
;

483  
ªgs
->
ARM_r0
;

485 
	`NR
(
£t_és
):

486 
thªad
->
ç_vÆue
 = 
ªgs
->
ARM_r0
;

487 #i‡
	`deföed
(
CONFIG_HAS_TLS_REG
)

488 
	`asm
 ("m¸Ö15, 0, %0, c13, c0, 3" : : "r" (
ªgs
->
ARM_r0
) );

489 #ñi‡!
	`deföed
(
CONFIG_TLS_REG_EMUL
)

496 *((*)0xffff0ff0Ë
ªgs
->
ARM_r0
;

500 #ifde‡
CONFIG_NEEDS_SYSCALL_FOR_CMPXCHG


514 
	`do_D©aAb‹t
(
addr
, 
f§
,

515 
±_ªgs
 *
ªgs
);

516 
vÆ
;

517 
addr
 = 
ªgs
->
ARM_r2
;

518 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

519 
pgd_t
 *
pgd
; 
pmd_t
 *
pmd
; 
±e_t
 *
±e
;

520 
•ölock_t
 *
±l
;

522 
ªgs
->
ARM_˝§
 &~
PSR_C_BIT
;

523 
	`down_ªad
(&
mm
->
mm≠_£m
);

524 
pgd
 = 
	`pgd_off£t
(
mm
, 
addr
);

525 i‡(!
	`pgd_¥e£¡
(*
pgd
))

526 
bad_ac˚ss
;

527 
pmd
 = 
	`pmd_off£t
(
pgd
, 
addr
);

528 i‡(!
	`pmd_¥e£¡
(*
pmd
))

529 
bad_ac˚ss
;

530 
±e
 = 
	`±e_off£t_m≠_lock
(
mm
, 
pmd
, 
addr
, &
±l
);

531 i‡(!
	`±e_¥e£¡
(*
±e
Ë|| !
	`±e_dúty
(*pte)) {

532 
	`±e_unm≠_u∆ock
(
±e
, 
±l
);

533 
bad_ac˚ss
;

535 
vÆ
 = *(*)
addr
;

536 
vÆ
 -
ªgs
->
ARM_r0
;

537 i‡(
vÆ
 == 0) {

538 *(*)
addr
 = 
ªgs
->
ARM_r1
;

539 
ªgs
->
ARM_˝§
 |
PSR_C_BIT
;

541 
	`±e_unm≠_u∆ock
(
±e
, 
±l
);

542 
	`up_ªad
(&
mm
->
mm≠_£m
);

543  
vÆ
;

545 
bad_ac˚ss
:

546 
	`up_ªad
(&
mm
->
mm≠_£m
);

548 
	`do_D©aAb‹t
(
addr
, 15 + (1 << 11), 
ªgs
);

558 i‡(
no
 <= 0x7ff)

559  -
ENOSYS
;

562 #ifde‡
CONFIG_DEBUG_USER


567 i‡(
u£r_debug
 & 
UDBG_SYSCALL
) {

568 
	`¥ötk
("[%d] %s:árm syscall %d\n",

569 
cuºít
->
pid
, cuºít->
comm
, 
no
);

570 
	`dump_ö°r
(
ªgs
);

571 i‡(
	`u£r_mode
(
ªgs
)) {

572 
	`__show_ªgs
(
ªgs
);

573 
	`c_backåa˚
(
ªgs
->
ARM_Â
, 
	`¥o˚ss‹_mode
(regs));

577 
öfo
.
si_signo
 = 
SIGILL
;

578 
öfo
.
si_î∫o
 = 0;

579 
öfo
.
si_code
 = 
ILL_ILLTRP
;

580 
öfo
.
si_addr
 = (
__u£r
 *)
	`ö°ru˘i⁄_poöãr
(
ªgs
) -

581 (
	`thumb_mode
(
ªgs
) ? 2 : 4);

583 
	`¨m_nŸify_dõ
("O›†- bad sysˇŒ(2)", 
ªgs
, &
öfo
, 
no
, 0);

585 
	}
}

587 #ifde‡
CONFIG_TLS_REG_EMUL


597 
	$gë_ç_å≠
(
±_ªgs
 *
ªgs
, 
ö°r
)

599 
ªg
 = (
ö°r
 >> 12) & 15;

600 i‡(
ªg
 == 15)

602 
ªgs
->
uªgs
[
ªg
] = 
	`cuºít_thªad_öfo
()->
ç_vÆue
;

603 
ªgs
->
ARM_pc
 += 4;

605 
	}
}

607 
undef_hook
 
	g¨m_mrc_hook
 = {

608 .
ö°r_mask
 = 0x0fff0fff,

609 .
	gö°r_vÆ
 = 0x0e1d0f70,

610 .
	g˝§_mask
 = 
PSR_T_BIT
,

611 .
	g˝§_vÆ
 = 0,

612 .
	g‚
 = 
gë_ç_å≠
,

615 
__öô
 
	$¨m_mrc_hook_öô
()

617 
	`ªgi°î_undef_hook
(&
¨m_mrc_hook
);

619 
	}
}

621 
œã_öôˇŒ
(
¨m_mrc_hook_öô
);

625 
	$__bad_xchg
(vﬁ©ûê*
±r
, 
size
)

627 
	`¥ötk
("xchg: bad data size:Öc 0x%p,Ötr 0x%p, size %d\n",

628 
	`__buûtö_ªtu∫_addªss
(0), 
±r
, 
size
);

629 
	`BUG
();

630 
	}
}

631 
EXPORT_SYMBOL
(
__bad_xchg
);

637 
asmlökage
 

638 
	$badd©Øb‹t
(
code
, 
ö°r
, 
±_ªgs
 *
ªgs
)

640 
addr
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

641 
sigöfo_t
 
öfo
;

643 #ifde‡
CONFIG_DEBUG_USER


644 i‡(
u£r_debug
 & 
UDBG_BADABORT
) {

645 
	`¥ötk
(
KERN_ERR
 "[%d] %s: bad dataábort: code %d instr 0x%08lx\n",

646 
cuºít
->
pid
, cuºít->
comm
, 
code
, 
ö°r
);

647 
	`dump_ö°r
(
ªgs
);

648 
	`show_±e
(
cuºít
->
mm
, 
addr
);

652 
öfo
.
si_signo
 = 
SIGILL
;

653 
öfo
.
si_î∫o
 = 0;

654 
öfo
.
si_code
 = 
ILL_ILLOPC
;

655 
öfo
.
si_addr
 = (
__u£r
 *)
addr
;

657 
	`¨m_nŸify_dõ
("unknow¿d©®ab‹àcode", 
ªgs
, &
öfo
, 
ö°r
, 0);

658 
	}
}

660 
__©åibuã__
((
n‹ëu∫
)Ë
	$__bug
(c⁄° *
fûe
, 
löe
)

662 
	`¥ötk
(
KERN_CRIT
"kî√»BUGáà%s:%d!\n", 
fûe
, 
löe
);

667 
	}
}

668 
EXPORT_SYMBOL
(
__bug
);

670 
	$__ªadwrôe_bug
(c⁄° *
‚
)

672 
	`¥ötk
("%†ˇŒed, buànŸ im∂emíãd\n", 
‚
);

673 
	`BUG
();

674 
	}
}

675 
EXPORT_SYMBOL
(
__ªadwrôe_bug
);

677 
	$__±e_îr‹
(c⁄° *
fûe
, 
löe
, 
vÆ
)

679 
	`¥ötk
("%s:%d: badÖã %08lx.\n", 
fûe
, 
löe
, 
vÆ
);

680 
	}
}

682 
	$__pmd_îr‹
(c⁄° *
fûe
, 
löe
, 
vÆ
)

684 
	`¥ötk
("%s:%d: badÖmd %08lx.\n", 
fûe
, 
löe
, 
vÆ
);

685 
	}
}

687 
	$__pgd_îr‹
(c⁄° *
fûe
, 
löe
, 
vÆ
)

689 
	`¥ötk
("%s:%d: badÖgd %08lx.\n", 
fûe
, 
löe
, 
vÆ
);

690 
	}
}

692 
asmlökage
 
	$__div0
()

694 
	`¥ötk
("Division by zero in kernel.\n");

695 
	`dump_°ack
();

696 
	}
}

697 
EXPORT_SYMBOL
(
__div0
);

699 
	$ab‹t
()

701 
	`BUG
();

704 
	`∑nic
("Oops failedÅo killÅhread");

705 
	}
}

706 
EXPORT_SYMBOL
(
ab‹t
);

708 
__öô
 
	$å≠_öô
()

710 
ve˘‹s
 = 
CONFIG_VECTORS_BASE
;

711 
__°ubs_°¨t
[], 
__°ubs_íd
[];

712 
__ve˘‹s_°¨t
[], 
__ve˘‹s_íd
[];

713 
__ku£r_hñ≥r_°¨t
[], 
__ku£r_hñ≥r_íd
[];

714 
ku£r_sz
 = 
__ku£r_hñ≥r_íd
 - 
__ku£r_hñ≥r_°¨t
;

721 
	`mem˝y
((*)
ve˘‹s
, 
__ve˘‹s_°¨t
, 
__ve˘‹s_íd
 - __vectors_start);

722 
	`mem˝y
((*)
ve˘‹s
 + 0x200, 
__°ubs_°¨t
, 
__°ubs_íd
 - __stubs_start);

723 
	`mem˝y
((*)
ve˘‹s
 + 0x1000 - 
ku£r_sz
, 
__ku£r_hñ≥r_°¨t
, kuser_sz);

729 
	`mem˝y
((*)
KERN_SIGRETURN_CODE
, 
sigªtu∫_codes
,

730 (
sigªtu∫_codes
));

732 
	`Êush_iˇche_ønge
(
ve˘‹s
, ve˘‹†+ 
PAGE_SIZE
);

733 
	`modify_domaö
(
DOMAIN_USER
, 
DOMAIN_CLIENT
);

734 
	}
}

	@arch/arm/kernel/xscale-cp0.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/ty≥s.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/sig«l.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/öô.h
>

17 
	~<asm/thªad_nŸify.h
>

18 
	~<asm/io.h
>

20 
ölöe
 
	$d•_ßve_°©e
(
u32
 *
°©e
)

22 
__asm__
 
	`__vﬁ©ûe__
 (

24 : "Ù" (
°©e
[0]), "=r" (state[1]));

25 
	}
}

27 
ölöe
 
	$d•_lﬂd_°©e
(
u32
 *
°©e
)

29 
__asm__
 
	`__vﬁ©ûe__
 (

31 : : "r" (
°©e
[0]), "r" (state[1]));

32 
	}
}

34 
	$d•_do
(
nŸifõr_block
 *
£lf
, 
cmd
, *
t
)

36 
thªad_öfo
 *
thªad
 = 
t
;

38 
cmd
) {

39 
THREAD_NOTIFY_FLUSH
:

40 
thªad
->
˝u_c⁄ãxt
.
exåa
[0] = 0;

41 
thªad
->
˝u_c⁄ãxt
.
exåa
[1] = 0;

44 
THREAD_NOTIFY_SWITCH
:

45 
	`d•_ßve_°©e
(
	`cuºít_thªad_öfo
()->
˝u_c⁄ãxt
.
exåa
);

46 
	`d•_lﬂd_°©e
(
thªad
->
˝u_c⁄ãxt
.
exåa
);

50  
NOTIFY_DONE
;

51 
	}
}

53 
nŸifõr_block
 
	gd•_nŸifõr_block
 = {

54 .
nŸifõr_ˇŒ
 = 
d•_do
,

58 #ifde‡
CONFIG_IWMMXT


59 
	$iwmmxt_do
(
nŸifõr_block
 *
£lf
, 
cmd
, *
t
)

61 
thªad_öfo
 *
thªad
 = 
t
;

63 
cmd
) {

64 
THREAD_NOTIFY_FLUSH
:

73 
THREAD_NOTIFY_RELEASE
:

74 
	`iwmmxt_èsk_ªÀa£
(
thªad
);

77 
THREAD_NOTIFY_SWITCH
:

78 
	`iwmmxt_èsk_swôch
(
thªad
);

82  
NOTIFY_DONE
;

83 
	}
}

85 
nŸifõr_block
 
	giwmmxt_nŸifõr_block
 = {

86 .
nŸifõr_ˇŒ
 = 
iwmmxt_do
,

91 
u32
 
__öô
 
	$xsˇÀ_˝_ac˚ss_ªad
()

93 
u32
 
vÆue
;

95 
__asm__
 
	`__vﬁ©ûe__
 (

97 : "Ù" (
vÆue
));

99  
vÆue
;

100 
	}
}

102 
__öô
 
	$xsˇÀ_˝_ac˚ss_wrôe
(
u32
 
vÆue
)

104 
u32
 
ãmp
;

106 
__asm__
 
	`__vﬁ©ûe__
 (

111 : "Ù" (
ãmp
Ë: "r" (
vÆue
));

112 
	}
}

120 
__öô
 
	$˝u_has_iwmmxt
()

122 
u32
 
lo
;

123 
u32
 
hi
;

134 
__asm__
 
	`__vﬁ©ûe__
 (

137 : "Ù" (
lo
), "Ù" (
hi
)

140  !!
hi
;

141 
	}
}

152 
__öô
 
	$xsˇÀ_˝0_öô
()

154 
u32
 
˝_ac˚ss
;

156 
˝_ac˚ss
 = 
	`xsˇÀ_˝_ac˚ss_ªad
() & ~3;

157 
	`xsˇÀ_˝_ac˚ss_wrôe
(
˝_ac˚ss
 | 1);

159 i‡(
	`˝u_has_iwmmxt
()) {

160 #i‚de‡
CONFIG_IWMMXT


161 
	`¥ötk
(
KERN_WARNING
 "CAUTION: XScale iWMMXt coprocessor "

164 
	`¥ötk
(
KERN_INFO
 "XScale iWMMXt coprocessor detected.\n");

165 
ñf_hwˇp
 |
HWCAP_IWMMXT
;

166 
	`thªad_ªgi°î_nŸifõr
(&
iwmmxt_nŸifõr_block
);

169 
	`¥ötk
(
KERN_INFO
 "XScale DSP coprocessor detected.\n");

170 
	`thªad_ªgi°î_nŸifõr
(&
d•_nŸifõr_block
);

171 
˝_ac˚ss
 |= 1;

174 
	`xsˇÀ_˝_ac˚ss_wrôe
(
˝_ac˚ss
);

177 
	}
}

179 
œã_öôˇŒ
(
xsˇÀ_˝0_öô
);

	@arch/arm/lib/bitops.h

2 #i‡
__LINUX_ARM_ARCH__
 >6 && 
deföed
(
CONFIG_CPU_32v6K
)

3 .
ma¸o
 
	gbô›
, 
ö°r


4 
mov
 
	gr2
, #1

5 
™d
 
	gr3
, 
	gr0
, #7 @ 
Gë
 
bô
 
off£t


6 
add
 
	gr1
,Ñ1, 
	gr0
, 
	gl§
 #3 @ 
Gë
 
byã
 
off£t


7 
mov
 
	gr3
, 
	gr2
, 
l¶
Ñ3

8 1: 
ldªxb
 
r2
, [
r1
]

9 \
ö°r
 
	gr2
,Ñ2, 
r3


10 
°ªxb
 
	gr0
, 
	gr2
, [
r1
]

11 
cmp
 
	gr0
, #0

12 
	gb√
 1b

13 
mov
 
	gpc
, 
	gÃ


14 .
	gídm


16 .
ma¸o
 
	gã°›
, 
	gö°r
, 
°‹e


17 
™d
 
	gr3
, 
	gr0
, #7 @ 
Gë
 
bô
 
off£t


18 
mov
 
	gr2
, #1

19 
add
 
	gr1
,Ñ1, 
	gr0
, 
	gl§
 #3 @ 
Gë
 
byã
 
off£t


20 
mov
 
	gr3
, 
	gr2
, 
l¶
Ñ3 @ 
¸óã
 
	gmask


21 1: 
ldªxb
 
r2
, [
r1
]

22 
™ds
 
	gr0
, 
	gr2
, 
	gr3
 @ 
ßve
 
ﬁd
 
vÆue
 
of
 
	gbô


23 \
ö°r
 
	gr2
,Ñ2, 
	gr3
 @ 
toggÀ
 
bô


24 
°ªxb
 
	gù
, 
	gr2
, [
r1
]

25 
cmp
 
	gù
, #0

26 
	gb√
 1b

27 
cmp
 
	gr0
, #0

28 
mov√
 
	gr0
, #1

29 2: 
mov
 
pc
, 
	gÃ


30 .
	gídm


32 .
ma¸o
 
	gbô›
, 
ö°r


33 
™d
 
	gr2
, 
	gr0
, #7

34 
mov
 
	gr3
, #1

35 
mov
 
	gr3
,Ñ3, 
l¶
 
r2


36 
ßve_™d_dißbÀ_úqs
 
ù


37 
ldrb
 
	gr2
, [
r1
, 
r0
, 
l§
 #3]

38 \
ö°r
 
	gr2
,Ñ2, 
r3


39 
°rb
 
	gr2
, [
r1
, 
r0
, 
l§
 #3]

40 
ª°‹e_úqs
 
ù


41 
mov
 
	gpc
, 
	gÃ


42 .
	gídm


52 .
ma¸o
 
	gã°›
, 
	gö°r
, 
°‹e


53 
add
 
	gr1
,Ñ1, 
	gr0
, 
	gl§
 #3

54 
™d
 
	gr3
, 
	gr0
, #7

55 
mov
 
	gr0
, #1

56 
ßve_™d_dißbÀ_úqs
 
ù


57 
ldrb
 
	gr2
, [
r1
]

58 
t°
 
	gr2
, 
	gr0
, 
l¶
 
	gr3


59 \
ö°r
 
	gr2
,Ñ2, 
	gr0
, 
l¶
 
	gr3


60 \
°‹e
 
	gr2
, [
r1
]

61 
ª°‹e_úqs
 
ù


62 
moveq
 
	gr0
, #0

63 
mov
 
	gpc
, 
	gÃ


64 .
	gídm


	@arch/arm/lib/io-shark.c

	@arch/arm/mach-aaec2000/aaed2000.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/devi˚.h
>

17 
	~<löux/maj‹.h
>

18 
	~<löux/öãºu±.h
>

20 
	~<asm/£tup.h
>

21 
	~<asm/mem‹y.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/úq.h
>

26 
	~<asm/mach/¨ch.h
>

27 
	~<asm/mach/m≠.h
>

28 
	~<asm/mach/úq.h
>

30 
	~<asm/¨ch/Øed2000.h
>

32 
	~"c‹e.h
"

34 
	$Øed2000_˛cd_dißbÀ
(
˛cd_fb
 *
fb
)

36 
AAED_EXT_GPIO
 &~
AAED_EGPIO_LCD_PWR_EN
;

37 
	}
}

39 
	$Øed2000_˛cd_íabÀ
(
˛cd_fb
 *
fb
)

41 
AAED_EXT_GPIO
 |
AAED_EGPIO_LCD_PWR_EN
;

42 
	}
}

44 
Øec2000_˛cd_öfo
 
	g˛cd_öfo
 = {

45 .
íabÀ
 = 
Øed2000_˛cd_íabÀ
,

46 .
	gdißbÀ
 = 
Øed2000_˛cd_dißbÀ
,

47 .
	g∑√l
 = {

48 .
mode
 = {

49 .
«me
 = "Sharp",

50 .
	gª‰esh
 = 60,

51 .
	gxªs
 = 640,

52 .
	gyªs
 = 480,

53 .
	gpix˛ock
 = 39721,

54 .
	gÀ·_m¨gö
 = 20,

55 .
	gright_m¨gö
 = 44,

56 .
	guµî_m¨gö
 = 21,

57 .
	glowî_m¨gö
 = 34,

58 .
	ghsync_Àn
 = 96,

59 .
	gvsync_Àn
 = 2,

60 .
	gsync
 = 0,

61 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

63 .
	gwidth
 = -1,

64 .
	gheight
 = -1,

65 .
	gtim2
 = 
TIM2_IVS
 | 
TIM2_IHS
,

66 .
	g˙é
 = 
CNTL_LCDTFT
,

67 .
	gbµ
 = 16,

71 
__öô
 
	$Øed2000_öô_úq
()

73 
	`Øec2000_öô_úq
();

74 
	}
}

76 
__öô
 
	$Øed2000_öô
()

78 
	`Øec2000_£t_˛cd_∂©_d©a
(&
˛cd_öfo
);

79 
	}
}

81 
m≠_desc
 
	gØed2000_io_desc
[] 
	g__öôd©a
 = {

83 .
vútuÆ
 = 
EXT_GPIO_VBASE
,

84 .
	gp‚
 = 
__phys_to_p‚
(
EXT_GPIO_PBASE
),

85 .
	gÀngth
 = 
EXT_GPIO_LENGTH
,

86 .
	gty≥
 = 
MT_DEVICE


90 
__öô
 
	$Øed2000_m≠_io
()

92 
	`Øec2000_m≠_io
();

93 
	`iŸabÀ_öô
(
Øed2000_io_desc
, 
	`ARRAY_SIZE
(aaed2000_io_desc));

94 
	}
}

96 
MACHINE_START
(
AAED2000
, "Agilent AAED-2000 Development Platform")

98 .
	gphys_io
 = 
PIO_BASE
,

99 .
	gio_pg_off°
 = ((
VIO_BASE
) >> 18) & 0xfffc,

100 .
	gm≠_io
 = 
Øed2000_m≠_io
,

101 .
	göô_úq
 = 
Øed2000_öô_úq
,

102 .
	gtimî
 = &
Øec2000_timî
,

103 .
	göô_machöe
 = 
Øed2000_öô
,

104 
	gMACHINE_END


	@arch/arm/mach-aaec2000/clock.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/li°.h
>

15 
	~<löux/î∫o.h
>

16 
	~<löux/îr.h
>

17 
	~<löux/°rög.h
>

18 
	~<löux/˛k.h
>

19 
	~<löux/muãx.h
>

21 
	~<asm/£m≠h‹e.h
>

23 
	~"˛ock.h
"

25 
LIST_HEAD
(
˛ocks
);

26 
DEFINE_MUTEX
(
˛ocks_muãx
);

28 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

30 
˛k
 *
p
, *˛k = 
	`ERR_PTR
(-
ENOENT
);

32 
	`muãx_lock
(&
˛ocks_muãx
);

33 
	`li°_f‹_óch_íåy
(
p
, &
˛ocks
, 
node
) {

34 i‡(
	`°rcmp
(
id
, 
p
->
«me
Ë=0 && 
	`åy_moduÀ_gë
’->
ow√r
)) {

35 
˛k
 = 
p
;

39 
	`muãx_u∆ock
(&
˛ocks_muãx
);

41  
˛k
;

42 
	}
}

43 
EXPORT_SYMBOL
(
˛k_gë
);

45 
	$˛k_put
(
˛k
 *clk)

47 
	`moduÀ_put
(
˛k
->
ow√r
);

48 
	}
}

49 
EXPORT_SYMBOL
(
˛k_put
);

51 
	$˛k_íabÀ
(
˛k
 *clk)

54 
	}
}

55 
EXPORT_SYMBOL
(
˛k_íabÀ
);

57 
	$˛k_dißbÀ
(
˛k
 *clk)

59 
	}
}

60 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

62 
	$˛k_gë_øã
(
˛k
 *clk)

64  
˛k
->
øã
;

65 
	}
}

66 
EXPORT_SYMBOL
(
˛k_gë_øã
);

68 
	$˛k_round_øã
(
˛k
 *˛k, 
øã
)

70  
øã
;

71 
	}
}

72 
EXPORT_SYMBOL
(
˛k_round_øã
);

74 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

77 
	}
}

78 
EXPORT_SYMBOL
(
˛k_£t_øã
);

80 
	$˛k_ªgi°î
(
˛k
 *clk)

82 
	`muãx_lock
(&
˛ocks_muãx
);

83 
	`li°_add
(&
˛k
->
node
, &
˛ocks
);

84 
	`muãx_u∆ock
(&
˛ocks_muãx
);

86 
	}
}

87 
EXPORT_SYMBOL
(
˛k_ªgi°î
);

89 
	$˛k_uƒegi°î
(
˛k
 *clk)

91 
	`muãx_lock
(&
˛ocks_muãx
);

92 
	`li°_dñ
(&
˛k
->
node
);

93 
	`muãx_u∆ock
(&
˛ocks_muãx
);

94 
	}
}

95 
EXPORT_SYMBOL
(
˛k_uƒegi°î
);

97 
__öô
 
	$˛k_öô
()

100 
	}
}

101 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-aaec2000/clock.h

12 
	gmoduÀ
;

14 
	s˛k
 {

15 
li°_hód
 
	mnode
;

16 
	møã
;

17 
moduÀ
 *
	mow√r
;

18 c⁄° *
	m«me
;

19 *
	md©a
;

22 
˛k_ªgi°î
(
˛k
 *clk);

23 
˛k_uƒegi°î
(
˛k
 *clk);

	@arch/arm/mach-aaec2000/core.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

16 
	~<löux/li°.h
>

17 
	~<löux/î∫o.h
>

18 
	~<löux/dma-m≠pög.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/timex.h
>

21 
	~<löux/sig«l.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/úq.h
>

25 
	~<asm/sizes.h
>

27 
	~<asm/mach/Êash.h
>

28 
	~<asm/mach/úq.h
>

29 
	~<asm/mach/time.h
>

30 
	~<asm/mach/m≠.h
>

32 
	~"c‹e.h
"

33 
	~"˛ock.h
"

48 
m≠_desc
 
	g°™d¨d_io_desc
[] 
	g__öôd©a
 = {

50 .
vútuÆ
 = 
VIO_APB_BASE
,

51 .
	gp‚
 = 
__phys_to_p‚
(
PIO_APB_BASE
),

52 .
	gÀngth
 = 
IO_APB_LENGTH
,

53 .
	gty≥
 = 
MT_DEVICE


55 .
	gvútuÆ
 = 
VIO_AHB_BASE
,

56 .
	gp‚
 = 
__phys_to_p‚
(
PIO_AHB_BASE
),

57 .
	gÀngth
 = 
IO_AHB_LENGTH
,

58 .
	gty≥
 = 
MT_DEVICE


62 
__öô
 
	$Øec2000_m≠_io
()

64 
	`iŸabÀ_öô
(
°™d¨d_io_desc
, 
	`ARRAY_SIZE
(standard_io_desc));

65 
	}
}

70 
	$Øec2000_öt_ack
(
úq
)

72 
IRQ_INTSR
 = 1 << 
úq
;

73 
	}
}

75 
	$Øec2000_öt_mask
(
úq
)

77 
IRQ_INTENC
 |(1 << 
úq
);

78 
	}
}

80 
	$Øec2000_öt_unmask
(
úq
)

82 
IRQ_INTENS
 |(1 << 
úq
);

83 
	}
}

85 
úq_chù
 
	gØec2000_úq_chù
 = {

86 .
ack
 = 
Øec2000_öt_ack
,

87 .
	gmask
 = 
Øec2000_öt_mask
,

88 .
	gunmask
 = 
Øec2000_öt_unmask
,

91 
__öô
 
	$Øec2000_öô_úq
()

93 
i
;

95 
i
 = 0; i < 
NR_IRQS
; i++) {

96 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

97 
	`£t_úq_chù
(
i
, &
Øec2000_úq_chù
);

98 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

102 
IRQ_INTENC
 = 0xffffffff;

105 
IRQ_INTSR
 = IRQ_INTSR;

106 
	}
}

112 
	$Øec2000_gëtimeoff£t
()

114 
ticks_to_m©ch
, 
ñ≠£d
, 
u£c
;

117 
ticks_to_m©ch
 = 
TIMER1_LOAD
 - 
TIMER1_VAL
;

120 
ñ≠£d
 = 
LATCH
 - 
ticks_to_m©ch
;

123 
u£c
 = ()(
ñ≠£d
 * (
tick_n£c
 / 1000))/
LATCH
;

125  
u£c
;

126 
	}
}

129 
úqªtu∫_t


130 
	$Øec2000_timî_öãºu±
(
úq
, *
dev_id
)

133 
	`wrôe_£qlock
(&
xtime_lock
);

135 
	`timî_tick
();

136 
TIMER1_CLEAR
 = 1;

138 
	`wrôe_£qu∆ock
(&
xtime_lock
);

140  
IRQ_HANDLED
;

141 
	}
}

143 
úqa˘i⁄
 
	gØec2000_timî_úq
 = {

144 .
«me
 = "AAEC-2000 Timer Tick",

145 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

146 .
	gh™dÀr
 = 
Øec2000_timî_öãºu±
,

149 
__öô
 
	$Øec2000_timî_öô
()

152 
TIMER1_CTRL
 = 0;

157 
TIMER1_LOAD
 = 
LATCH
;

158 
TIMER1_CLEAR
 = 1;

160 
	`£tup_úq
(
INT_TMR1_OFL
, &
Øec2000_timî_úq
);

162 
TIMER1_CTRL
 = 
TIMER_CTRL_ENABLE
 |

163 
TIMER_CTRL_PERIODIC
 |

164 
TIMER_CTRL_CLKSEL_508K
;

165 
	}
}

167 
sys_timî
 
	gØec2000_timî
 = {

168 .
öô
 = 
Øec2000_timî_öô
,

169 .
	goff£t
 = 
Øec2000_gëtimeoff£t
,

172 
˛cd_∑√l
 
	gmach_˛cd_∑√l
;

174 
	$Øec2000_˛cd_£tup
(
˛cd_fb
 *
fb
)

176 
dma_addr_t
 
dma
;

178 
fb
->
∑√l
 = &
mach_˛cd_∑√l
;

180 
fb
->fb.
s¸ìn_ba£
 = 
	`dma_Æloc_wrôecomböe
(&fb->
dev
->dev, 
SZ_1M
,

181 &
dma
, 
GFP_KERNEL
);

183 i‡(!
fb
->fb.
s¸ìn_ba£
) {

184 
	`¥ötk
(
KERN_ERR
 "CLCD: unableÅo map framebuffer\n");

185  -
ENOMEM
;

188 
fb
->fb.
fix
.
smem_°¨t
 = 
dma
;

189 
fb
->fb.
fix
.
smem_Àn
 = 
SZ_1M
;

192 
	}
}

194 
	$Øec2000_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

196  
	`dma_mm≠_wrôecomböe
(&
fb
->
dev
->dev, 
vma
,

197 
fb
->fb.
s¸ìn_ba£
,

198 
fb
->fb.
fix
.
smem_°¨t
,

199 
fb
->fb.
fix
.
smem_Àn
);

200 
	}
}

202 
	$Øec2000_˛cd_ªmove
(
˛cd_fb
 *
fb
)

204 
	`dma_‰ì_wrôecomböe
(&
fb
->
dev
->dev, fb->fb.
fix
.
smem_Àn
,

205 
fb
->fb.
s¸ìn_ba£
, fb->fb.
fix
.
smem_°¨t
);

206 
	}
}

208 
˛cd_bﬂrd
 
	g˛cd_∂©_d©a
 = {

209 .
«me
 = "AAEC-2000",

210 .
	gcheck
 = 
˛cdfb_check
,

211 .
	gdecode
 = 
˛cdfb_decode
,

212 .
	g£tup
 = 
Øec2000_˛cd_£tup
,

213 .
	gmm≠
 = 
Øec2000_˛cd_mm≠
,

214 .
	gªmove
 = 
Øec2000_˛cd_ªmove
,

217 
amba_devi˚
 
	g˛cd_devi˚
 = {

218 .
dev
 = {

219 .
bus_id
 = "mb:16",

220 .
	gcohîít_dma_mask
 = ~0,

221 .
	g∂©f‹m_d©a
 = &
˛cd_∂©_d©a
,

223 .
	gªs
 = {

224 .
°¨t
 = 
AAEC_CLCD_PHYS
,

225 .
	gíd
 = 
AAEC_CLCD_PHYS
 + 
SZ_4K
 - 1,

226 .
	gÊags
 = 
IORESOURCE_MEM
,

228 .
	gúq
 = { 
INT_LCD
, 
NO_IRQ
 },

229 .
	g≥rùhid
 = 0x41110,

232 
amba_devi˚
 *
	gamba_devs
[] 
	g__öôd©a
 = {

233 &
˛cd_devi˚
,

236 
˛k
 
	gØec2000_˛cd_˛k
 = {

237 .
«me
 = "CLCDCLK",

240 
__öô
 
	$Øec2000_£t_˛cd_∂©_d©a
(
Øec2000_˛cd_öfo
 *
˛cd
)

242 
˛cd_∂©_d©a
.
íabÀ
 = 
˛cd
->enable;

243 
˛cd_∂©_d©a
.
dißbÀ
 = 
˛cd
->disable;

244 
	`mem˝y
(&
mach_˛cd_∑√l
, &
˛cd
->
∑√l
, (
˛cd_∑√l
));

245 
	}
}

247 
Êash_∂©f‹m_d©a
 
	gØec2000_Êash_d©a
 = {

248 .
m≠_«me
 = "cfi_probe",

249 .
	gwidth
 = 4,

252 
ªsour˚
 
	gØec2000_Êash_ªsour˚
 = {

253 .
°¨t
 = 
AAEC_FLASH_BASE
,

254 .
	gíd
 = 
AAEC_FLASH_BASE
 + 
AAEC_FLASH_SIZE
,

255 .
	gÊags
 = 
IORESOURCE_MEM
,

258 
∂©f‹m_devi˚
 
	gØec2000_Êash_devi˚
 = {

259 .
«me
 = "armflash",

260 .
	gid
 = 0,

261 .
	gdev
 = {

262 .
∂©f‹m_d©a
 = &
Øec2000_Êash_d©a
,

264 .
	gnum_ªsour˚s
 = 1,

265 .
	gªsour˚
 = &
Øec2000_Êash_ªsour˚
,

268 
__öô
 
	$Øec2000_öô
()

270 
i
;

272 
	`˛k_ªgi°î
(&
Øec2000_˛cd_˛k
);

274 
i
 = 0; i < 
	`ARRAY_SIZE
(
amba_devs
); i++) {

275 
amba_devi˚
 *
d
 = 
amba_devs
[
i
];

276 
	`amba_devi˚_ªgi°î
(
d
, &
iomem_ªsour˚
);

279 
	`∂©f‹m_devi˚_ªgi°î
(&
Øec2000_Êash_devi˚
);

282 
	}
};

283 
¨ch_öôˇŒ
(
Øec2000_öô
);

	@arch/arm/mach-aaec2000/core.h

12 
	~<löux/amba/bus.h
>

13 
	~<löux/amba/˛cd.h
>

15 
	gsys_timî
;

17 
sys_timî
 
Øec2000_timî
;

18 
__öô
 
Øec2000_m≠_io
();

19 
__öô
 
Øec2000_öô_úq
();

21 
	sØec2000_˛cd_öfo
 {

22 
˛cd_∑√l
 
	m∑√l
;

23 (*
	mdißbÀ
)(
	m˛cd_fb
 *);

24 (*
	míabÀ
)(
	m˛cd_fb
 *);

27 
__öô
 
Øec2000_£t_˛cd_∂©_d©a
(
Øec2000_˛cd_öfo
 *);

	@arch/arm/mach-at91/at91rm9200.c

13 
	~<löux/moduÀ.h
>

15 
	~<asm/mach/¨ch.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch/©91rm9200.h
>

18 
	~<asm/¨ch/©91_pmc.h
>

19 
	~<asm/¨ch/©91_°.h
>

21 
	~"gíîic.h
"

22 
	~"˛ock.h
"

24 
m≠_desc
 
	g©91rm9200_io_desc
[] 
	g__öôd©a
 = {

26 .
vútuÆ
 = 
AT91_VA_BASE_SYS
,

27 .
	gp‚
 = 
__phys_to_p‚
(
AT91_BASE_SYS
),

28 .
	gÀngth
 = 
SZ_4K
,

29 .
	gty≥
 = 
MT_DEVICE
,

31 .
	gvútuÆ
 = 
AT91_VA_BASE_EMAC
,

32 .
	gp‚
 = 
__phys_to_p‚
(
AT91RM9200_BASE_EMAC
),

33 .
	gÀngth
 = 
SZ_16K
,

34 .
	gty≥
 = 
MT_DEVICE
,

36 .
	gvútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91RM9200_SRAM_SIZE
,

37 .
	gp‚
 = 
__phys_to_p‚
(
AT91RM9200_SRAM_BASE
),

38 .
	gÀngth
 = 
AT91RM9200_SRAM_SIZE
,

39 .
	gty≥
 = 
MT_DEVICE
,

50 
˛k
 
	gudc_˛k
 = {

51 .
«me
 = "udc_clk",

52 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_UDP
,

53 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

55 
˛k
 
	gohci_˛k
 = {

56 .
«me
 = "ohci_clk",

57 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_UHP
,

58 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

60 
˛k
 
	gëhî_˛k
 = {

61 .
«me
 = "ether_clk",

62 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_EMAC
,

63 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

65 
˛k
 
	gmmc_˛k
 = {

66 .
«me
 = "mci_clk",

67 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_MCI
,

68 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

70 
˛k
 
	gtwi_˛k
 = {

71 .
«me
 = "twi_clk",

72 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TWI
,

73 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

75 
˛k
 
	gußπ0_˛k
 = {

76 .
«me
 = "usart0_clk",

77 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_US0
,

78 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

80 
˛k
 
	gußπ1_˛k
 = {

81 .
«me
 = "usart1_clk",

82 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_US1
,

83 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

85 
˛k
 
	gußπ2_˛k
 = {

86 .
«me
 = "usart2_clk",

87 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_US2
,

88 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

90 
˛k
 
	gußπ3_˛k
 = {

91 .
«me
 = "usart3_clk",

92 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_US3
,

93 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

95 
˛k
 
	g•i_˛k
 = {

96 .
«me
 = "spi_clk",

97 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_SPI
,

98 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

100 
˛k
 
	gpioA_˛k
 = {

101 .
«me
 = "pioA_clk",

102 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_PIOA
,

103 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

105 
˛k
 
	gpioB_˛k
 = {

106 .
«me
 = "pioB_clk",

107 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_PIOB
,

108 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

110 
˛k
 
	gpioC_˛k
 = {

111 .
«me
 = "pioC_clk",

112 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_PIOC
,

113 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

115 
˛k
 
	gpioD_˛k
 = {

116 .
«me
 = "pioD_clk",

117 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_PIOD
,

118 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

120 
˛k
 
	gssc0_˛k
 = {

121 .
«me
 = "ssc0_clk",

122 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_SSC0
,

123 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

125 
˛k
 
	gssc1_˛k
 = {

126 .
«me
 = "ssc1_clk",

127 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_SSC1
,

128 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

130 
˛k
 
	gssc2_˛k
 = {

131 .
«me
 = "ssc2_clk",

132 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_SSC2
,

133 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

135 
˛k
 
	gtc0_˛k
 = {

136 .
«me
 = "tc0_clk",

137 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC0
,

138 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

140 
˛k
 
	gtc1_˛k
 = {

141 .
«me
 = "tc1_clk",

142 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC1
,

143 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

145 
˛k
 
	gtc2_˛k
 = {

146 .
«me
 = "tc2_clk",

147 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC2
,

148 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

150 
˛k
 
	gtc3_˛k
 = {

151 .
«me
 = "tc3_clk",

152 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC3
,

153 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

155 
˛k
 
	gtc4_˛k
 = {

156 .
«me
 = "tc4_clk",

157 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC4
,

158 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

160 
˛k
 
	gtc5_˛k
 = {

161 .
«me
 = "tc5_clk",

162 .
	gpmc_mask
 = 1 << 
AT91RM9200_ID_TC5
,

163 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

166 
˛k
 *
	g≥rùh_˛ocks
[] 
	g__öôd©a
 = {

167 &
pioA_˛k
,

168 &
pioB_˛k
,

169 &
pioC_˛k
,

170 &
pioD_˛k
,

171 &
ußπ0_˛k
,

172 &
ußπ1_˛k
,

173 &
ußπ2_˛k
,

174 &
ußπ3_˛k
,

175 &
mmc_˛k
,

176 &
udc_˛k
,

177 &
twi_˛k
,

178 &
•i_˛k
,

179 &
ssc0_˛k
,

180 &
ssc1_˛k
,

181 &
ssc2_˛k
,

182 &
tc0_˛k
,

183 &
tc1_˛k
,

184 &
tc2_˛k
,

185 &
tc3_˛k
,

186 &
tc4_˛k
,

187 &
tc5_˛k
,

188 &
ohci_˛k
,

189 &
ëhî_˛k
,

197 
˛k
 
	gpck0
 = {

198 .
«me
 = "pck0",

199 .
	gpmc_mask
 = 
AT91_PMC_PCK0
,

200 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

201 .
	gid
 = 0,

203 
˛k
 
	gpck1
 = {

204 .
«me
 = "pck1",

205 .
	gpmc_mask
 = 
AT91_PMC_PCK1
,

206 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

207 .
	gid
 = 1,

209 
˛k
 
	gpck2
 = {

210 .
«me
 = "pck2",

211 .
	gpmc_mask
 = 
AT91_PMC_PCK2
,

212 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

213 .
	gid
 = 2,

215 
˛k
 
	gpck3
 = {

216 .
«me
 = "pck3",

217 .
	gpmc_mask
 = 
AT91_PMC_PCK3
,

218 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

219 .
	gid
 = 3,

222 
__öô
 
	$©91rm9200_ªgi°î_˛ocks
()

224 
i
;

226 
i
 = 0; i < 
	`ARRAY_SIZE
(
≥rùh_˛ocks
); i++)

227 
	`˛k_ªgi°î
(
≥rùh_˛ocks
[
i
]);

229 
	`˛k_ªgi°î
(&
pck0
);

230 
	`˛k_ªgi°î
(&
pck1
);

231 
	`˛k_ªgi°î
(&
pck2
);

232 
	`˛k_ªgi°î
(&
pck3
);

233 
	}
}

239 
©91_gpio_b™k
 
	g©91rm9200_gpio
[] = {

241 .
id
 = 
AT91RM9200_ID_PIOA
,

242 .
	goff£t
 = 
AT91_PIOA
,

243 .
	g˛ock
 = &
pioA_˛k
,

245 .
	gid
 = 
AT91RM9200_ID_PIOB
,

246 .
	goff£t
 = 
AT91_PIOB
,

247 .
	g˛ock
 = &
pioB_˛k
,

249 .
	gid
 = 
AT91RM9200_ID_PIOC
,

250 .
	goff£t
 = 
AT91_PIOC
,

251 .
	g˛ock
 = &
pioC_˛k
,

253 .
	gid
 = 
AT91RM9200_ID_PIOD
,

254 .
	goff£t
 = 
AT91_PIOD
,

255 .
	g˛ock
 = &
pioD_˛k
,

259 
	$©91rm9200_ª£t
()

264 
	`©91_sys_wrôe
(
AT91_ST_WDMR
, 
AT91_ST_RSTEN
 | 
AT91_ST_EXTEN
 | 1);

265 
	`©91_sys_wrôe
(
AT91_ST_CR
, 
AT91_ST_WDRST
);

266 
	}
}

272 
__öô
 
	$©91rm9200_öôülize
(
maö_˛ock
, 
b™ks
)

275 
	`iŸabÀ_öô
(
©91rm9200_io_desc
, 
	`ARRAY_SIZE
(at91rm9200_io_desc));

277 
©91_¨ch_ª£t
 = 
©91rm9200_ª£t
;

278 
©91_exã∫_úq
 = (1 << 
AT91RM9200_ID_IRQ0
Ë| (1 << 
AT91RM9200_ID_IRQ1
)

279 | (1 << 
AT91RM9200_ID_IRQ2
Ë| (1 << 
AT91RM9200_ID_IRQ3
)

280 | (1 << 
AT91RM9200_ID_IRQ4
Ë| (1 << 
AT91RM9200_ID_IRQ5
)

281 | (1 << 
AT91RM9200_ID_IRQ6
);

284 
	`©91_˛ock_öô
(
maö_˛ock
);

287 
	`©91rm9200_ªgi°î_˛ocks
();

290 
	`©91_gpio_öô
(
©91rm9200_gpio
, 
b™ks
);

291 
	}
}

301 
	g©91rm9200_deÁu…_úq_¥i‹ôy
[
NR_AIC_IRQS
] 
	g__öôd©a
 = {

336 
__öô
 
	$©91rm9200_öô_öãºu±s
(
¥i‹ôy
[
NR_AIC_IRQS
])

338 i‡(!
¥i‹ôy
)

339 
¥i‹ôy
 = 
©91rm9200_deÁu…_úq_¥i‹ôy
;

342 
	`©91_aic_öô
(
¥i‹ôy
);

345 
	`©91_gpio_úq_£tup
();

346 
	}
}

	@arch/arm/mach-at91/at91rm9200_devices.c

13 
	~<asm/mach/¨ch.h
>

14 
	~<asm/mach/m≠.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<asm/¨ch/bﬂrd.h
>

19 
	~<asm/¨ch/gpio.h
>

20 
	~<asm/¨ch/©91rm9200.h
>

21 
	~<asm/¨ch/©91rm9200_mc.h
>

23 
	~"gíîic.h
"

30 #i‡
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

31 
u64
 
	gohci_dmamask
 = 0xffffffffUL;

32 
©91_usbh_d©a
 
	gusbh_d©a
;

34 
ªsour˚
 
	gusbh_ªsour˚s
[] = {

36 .
°¨t
 = 
AT91RM9200_UHP_BASE
,

37 .
	gíd
 = 
AT91RM9200_UHP_BASE
 + 
SZ_1M
 - 1,

38 .
	gÊags
 = 
IORESOURCE_MEM
,

41 .
°¨t
 = 
AT91RM9200_ID_UHP
,

42 .
	gíd
 = 
AT91RM9200_ID_UHP
,

43 .
	gÊags
 = 
IORESOURCE_IRQ
,

47 
∂©f‹m_devi˚
 
	g©91rm9200_usbh_devi˚
 = {

48 .
«me
 = "at91_ohci",

49 .
	gid
 = -1,

50 .
	gdev
 = {

51 .
dma_mask
 = &
ohci_dmamask
,

52 .
	gcohîít_dma_mask
 = 0xffffffff,

53 .
	g∂©f‹m_d©a
 = &
usbh_d©a
,

55 .
	gªsour˚
 = 
usbh_ªsour˚s
,

56 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
usbh_ªsour˚s
),

59 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
)

61 i‡(!
d©a
)

64 
usbh_d©a
 = *
d©a
;

65 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_usbh_devi˚
);

66 
	}
}

68 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
Ë{
	}
}

76 #ifde‡
CONFIG_USB_GADGET_AT91


77 
©91_udc_d©a
 
	gudc_d©a
;

79 
ªsour˚
 
	gudc_ªsour˚s
[] = {

81 .
°¨t
 = 
AT91RM9200_BASE_UDP
,

82 .
	gíd
 = 
AT91RM9200_BASE_UDP
 + 
SZ_16K
 - 1,

83 .
	gÊags
 = 
IORESOURCE_MEM
,

86 .
°¨t
 = 
AT91RM9200_ID_UDP
,

87 .
	gíd
 = 
AT91RM9200_ID_UDP
,

88 .
	gÊags
 = 
IORESOURCE_IRQ
,

92 
∂©f‹m_devi˚
 
	g©91rm9200_udc_devi˚
 = {

93 .
«me
 = "at91_udc",

94 .
	gid
 = -1,

95 .
	gdev
 = {

96 .
∂©f‹m_d©a
 = &
udc_d©a
,

98 .
	gªsour˚
 = 
udc_ªsour˚s
,

99 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
udc_ªsour˚s
),

102 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
)

104 i‡(!
d©a
)

107 i‡(
d©a
->
vbus_pö
) {

108 
	`©91_£t_gpio_öput
(
d©a
->
vbus_pö
, 0);

109 
	`©91_£t_deglôch
(
d©a
->
vbus_pö
, 1);

111 i‡(
d©a
->
puŒup_pö
)

112 
	`©91_£t_gpio_ouçut
(
d©a
->
puŒup_pö
, 0);

114 
udc_d©a
 = *
d©a
;

115 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_udc_devi˚
);

116 
	}
}

118 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
Ë{
	}
}

126 #i‡
deföed
(
CONFIG_ARM_AT91_ETHER
Ë|| deföed(
CONFIG_ARM_AT91_ETHER_MODULE
)

127 
u64
 
	gëh_dmamask
 = 0xffffffffUL;

128 
©91_ëh_d©a
 
	gëh_d©a
;

130 
ªsour˚
 
	gëh_ªsour˚s
[] = {

132 .
°¨t
 = 
AT91_VA_BASE_EMAC
,

133 .
	gíd
 = 
AT91_VA_BASE_EMAC
 + 
SZ_16K
 - 1,

134 .
	gÊags
 = 
IORESOURCE_MEM
,

137 .
°¨t
 = 
AT91RM9200_ID_EMAC
,

138 .
	gíd
 = 
AT91RM9200_ID_EMAC
,

139 .
	gÊags
 = 
IORESOURCE_IRQ
,

143 
∂©f‹m_devi˚
 
	g©91rm9200_ëh_devi˚
 = {

144 .
«me
 = "at91_ether",

145 .
	gid
 = -1,

146 .
	gdev
 = {

147 .
dma_mask
 = &
ëh_dmamask
,

148 .
	gcohîít_dma_mask
 = 0xffffffff,

149 .
	g∂©f‹m_d©a
 = &
ëh_d©a
,

151 .
	gªsour˚
 = 
ëh_ªsour˚s
,

152 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ëh_ªsour˚s
),

155 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
)

157 i‡(!
d©a
)

160 i‡(
d©a
->
phy_úq_pö
) {

161 
	`©91_£t_gpio_öput
(
d©a
->
phy_úq_pö
, 0);

162 
	`©91_£t_deglôch
(
d©a
->
phy_úq_pö
, 1);

166 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA16
, 0);

167 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA15
, 0);

168 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA14
, 0);

169 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA13
, 0);

170 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA12
, 0);

171 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA11
, 0);

172 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA10
, 0);

173 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA9
, 0);

174 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA8
, 0);

175 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA7
, 0);

177 i‡(!
d©a
->
is_rmii
) {

178 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB19
, 0);

179 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB18
, 0);

180 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB17
, 0);

181 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB16
, 0);

182 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB15
, 0);

183 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB14
, 0);

184 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB13
, 0);

185 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB12
, 0);

188 
ëh_d©a
 = *
d©a
;

189 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_ëh_devi˚
);

190 
	}
}

192 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
Ë{
	}
}

200 #i‡
deföed
(
CONFIG_AT91_CF
Ë|| deföed(
CONFIG_AT91_CF_MODULE
)

201 
©91_cf_d©a
 
	gcf_d©a
;

203 
	#CF_BASE
 
AT91_CHIPSELECT_4


	)

205 
ªsour˚
 
	gcf_ªsour˚s
[] = {

207 .
°¨t
 = 
CF_BASE
,

209 .
	gíd
 = 
CF_BASE
 + (0x30000000 - 1),

210 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_MEM_8AND16BIT
,

214 
∂©f‹m_devi˚
 
	g©91rm9200_cf_devi˚
 = {

215 .
«me
 = "at91_cf",

216 .
	gid
 = -1,

217 .
	gdev
 = {

218 .
∂©f‹m_d©a
 = &
cf_d©a
,

220 .
	gªsour˚
 = 
cf_ªsour˚s
,

221 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
cf_ªsour˚s
),

224 
__öô
 
	$©91_add_devi˚_cf
(
©91_cf_d©a
 *
d©a
)

226 
cß
;

228 i‡(!
d©a
)

231 
d©a
->
chù£À˘
 = 4;

234 
cß
 = 
	`©91_sys_ªad
(
AT91_EBI_CSA
);

235 
	`©91_sys_wrôe
(
AT91_EBI_CSA
, 
cß
 | 
AT91_EBI_CS4A_SMC_COMPACTFLASH
);

242 
	`©91_sys_wrôe
(
	`AT91_SMC_CSR
(4),

243 
AT91_SMC_ACSS_STD


244 | 
AT91_SMC_DBW_16


245 | 
AT91_SMC_BAT


246 | 
AT91_SMC_WSEN


247 | 
	`AT91_SMC_NWS_
(32)

248 | 
	`AT91_SMC_RWSETUP_
(6)

249 | 
	`AT91_SMC_RWHOLD_
(4)

253 i‡(
d©a
->
úq_pö
) {

254 
	`©91_£t_gpio_öput
(
d©a
->
úq_pö
, 1);

255 
	`©91_£t_deglôch
(
d©a
->
úq_pö
, 1);

257 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

258 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

261 i‡(
d©a
->
vcc_pö
)

262 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

263 
	`©91_£t_gpio_ouçut
(
d©a
->
r°_pö
, 0);

266 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC9
, 0);

267 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC10
, 0);

268 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC11
, 0);

269 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC12
, 0);

272 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC6
, 1);

274 
cf_d©a
 = *
d©a
;

275 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_cf_devi˚
);

276 
	}
}

278 
__öô
 
	$©91_add_devi˚_cf
(
©91_cf_d©a
 *
d©a
Ë{
	}
}

286 #i‡
deföed
(
CONFIG_MMC_AT91
Ë|| deföed(
CONFIG_MMC_AT91_MODULE
)

287 
u64
 
	gmmc_dmamask
 = 0xffffffffUL;

288 
©91_mmc_d©a
 
	gmmc_d©a
;

290 
ªsour˚
 
	gmmc_ªsour˚s
[] = {

292 .
°¨t
 = 
AT91RM9200_BASE_MCI
,

293 .
	gíd
 = 
AT91RM9200_BASE_MCI
 + 
SZ_16K
 - 1,

294 .
	gÊags
 = 
IORESOURCE_MEM
,

297 .
°¨t
 = 
AT91RM9200_ID_MCI
,

298 .
	gíd
 = 
AT91RM9200_ID_MCI
,

299 .
	gÊags
 = 
IORESOURCE_IRQ
,

303 
∂©f‹m_devi˚
 
	g©91rm9200_mmc_devi˚
 = {

304 .
«me
 = "at91_mci",

305 .
	gid
 = -1,

306 .
	gdev
 = {

307 .
dma_mask
 = &
mmc_dmamask
,

308 .
	gcohîít_dma_mask
 = 0xffffffff,

309 .
	g∂©f‹m_d©a
 = &
mmc_d©a
,

311 .
	gªsour˚
 = 
mmc_ªsour˚s
,

312 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc_ªsour˚s
),

315 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
)

317 i‡(!
d©a
)

321 i‡(
d©a
->
dë_pö
) {

322 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

323 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

325 i‡(
d©a
->
wp_pö
)

326 
	`©91_£t_gpio_öput
(
d©a
->
wp_pö
, 1);

327 i‡(
d©a
->
vcc_pö
)

328 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

331 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA27
, 0);

333 i‡(
d©a
->
¶Ÿ_b
) {

335 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA8
, 1);

338 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA9
, 1);

339 i‡(
d©a
->
wúe4
) {

340 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA10
, 1);

341 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA11
, 1);

342 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA12
, 1);

346 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA28
, 1);

349 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA29
, 1);

350 i‡(
d©a
->
wúe4
) {

351 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB3
, 1);

352 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB4
, 1);

353 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB5
, 1);

357 
mmc_d©a
 = *
d©a
;

358 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_mmc_devi˚
);

359 
	}
}

361 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
Ë{
	}
}

369 #i‡
deföed
(
CONFIG_MTD_NAND_AT91
Ë|| deföed(
CONFIG_MTD_NAND_AT91_MODULE
)

370 
©91_«nd_d©a
 
	g«nd_d©a
;

372 
	#NAND_BASE
 
AT91_CHIPSELECT_3


	)

374 
ªsour˚
 
	g«nd_ªsour˚s
[] = {

376 .
°¨t
 = 
NAND_BASE
,

377 .
	gíd
 = 
NAND_BASE
 + 
SZ_8M
 - 1,

378 .
	gÊags
 = 
IORESOURCE_MEM
,

382 
∂©f‹m_devi˚
 
	g©91rm9200_«nd_devi˚
 = {

383 .
«me
 = "at91_nand",

384 .
	gid
 = -1,

385 .
	gdev
 = {

386 .
∂©f‹m_d©a
 = &
«nd_d©a
,

388 .
	gªsour˚
 = 
«nd_ªsour˚s
,

389 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«nd_ªsour˚s
),

392 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
)

394 
cß
;

396 i‡(!
d©a
)

400 
cß
 = 
	`©91_sys_ªad
(
AT91_EBI_CSA
);

401 
	`©91_sys_wrôe
(
AT91_EBI_CSA
, 
cß
 | 
AT91_EBI_CS3A_SMC_SMARTMEDIA
);

404 
	`©91_sys_wrôe
(
	`AT91_SMC_CSR
(3), 
AT91_SMC_ACSS_STD
 | 
AT91_SMC_DBW_8
 | 
AT91_SMC_WSEN


405 | 
	`AT91_SMC_NWS_
(5)

406 | 
	`AT91_SMC_TDF_
(1)

407 | 
	`AT91_SMC_RWSETUP_
(0)

408 | 
	`AT91_SMC_RWHOLD_
(1)

412 i‡(
d©a
->
íabÀ_pö
)

413 
	`©91_£t_gpio_ouçut
(
d©a
->
íabÀ_pö
, 1);

416 i‡(
d©a
->
rdy_pö
)

417 
	`©91_£t_gpio_öput
(
d©a
->
rdy_pö
, 1);

420 i‡(
d©a
->
dë_pö
)

421 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

423 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC1
, 0);

424 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC3
, 0);

426 
«nd_d©a
 = *
d©a
;

427 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_«nd_devi˚
);

428 
	}
}

430 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
Ë{
	}
}

438 #i‡
deföed
(
CONFIG_I2C_AT91
Ë|| deföed(
CONFIG_I2C_AT91_MODULE
)

440 
ªsour˚
 
	gtwi_ªsour˚s
[] = {

442 .
°¨t
 = 
AT91RM9200_BASE_TWI
,

443 .
	gíd
 = 
AT91RM9200_BASE_TWI
 + 
SZ_16K
 - 1,

444 .
	gÊags
 = 
IORESOURCE_MEM
,

447 .
°¨t
 = 
AT91RM9200_ID_TWI
,

448 .
	gíd
 = 
AT91RM9200_ID_TWI
,

449 .
	gÊags
 = 
IORESOURCE_IRQ
,

453 
∂©f‹m_devi˚
 
	g©91rm9200_twi_devi˚
 = {

454 .
«me
 = "at91_i2c",

455 .
	gid
 = -1,

456 .
	gªsour˚
 = 
twi_ªsour˚s
,

457 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
twi_ªsour˚s
),

460 
__öô
 
	$©91_add_devi˚_i2c
()

463 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA25
, 0);

464 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA25
, 1);

466 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA26
, 0);

467 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA26
, 1);

469 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_twi_devi˚
);

470 
	}
}

472 
__öô
 
	$©91_add_devi˚_i2c
(Ë{
	}
}

480 #i‡
deföed
(
CONFIG_SPI_AT91
Ë|| deföed(
CONFIG_SPI_AT91_MODULE
Ë|| deföed(
CONFIG_AT91_SPI
Ë|| deföed(
CONFIG_AT91_SPI_MODULE
)

481 
u64
 
	g•i_dmamask
 = 0xffffffffUL;

483 
ªsour˚
 
	g•i_ªsour˚s
[] = {

485 .
°¨t
 = 
AT91RM9200_BASE_SPI
,

486 .
	gíd
 = 
AT91RM9200_BASE_SPI
 + 
SZ_16K
 - 1,

487 .
	gÊags
 = 
IORESOURCE_MEM
,

490 .
°¨t
 = 
AT91RM9200_ID_SPI
,

491 .
	gíd
 = 
AT91RM9200_ID_SPI
,

492 .
	gÊags
 = 
IORESOURCE_IRQ
,

496 
∂©f‹m_devi˚
 
	g©91rm9200_•i_devi˚
 = {

497 .
«me
 = "at91_spi",

498 .
	gid
 = 0,

499 .
	gdev
 = {

500 .
dma_mask
 = &
•i_dmamask
,

501 .
	gcohîít_dma_mask
 = 0xffffffff,

503 .
	gªsour˚
 = 
•i_ªsour˚s
,

504 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i_ªsour˚s
),

507 c⁄° 
	g•i_°™d¨d_cs
[4] = { 
AT91_PIN_PA3
, 
AT91_PIN_PA4
, 
AT91_PIN_PA5
, 
AT91_PIN_PA6
 };

509 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
)

511 
i
;

512 
cs_pö
;

514 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA0
, 0);

515 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA1
, 0);

516 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA2
, 0);

519 
i
 = 0; i < 
ƒ_devi˚s
; i++) {

520 i‡(
devi˚s
[
i
].
c⁄åﬁÀr_d©a
)

521 
cs_pö
 = (Ë
devi˚s
[
i
].
c⁄åﬁÀr_d©a
;

523 
cs_pö
 = 
•i_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

525 #ifde‡
CONFIG_SPI_AT91_MANUAL_CS


526 
	`©91_£t_gpio_ouçut
(
cs_pö
, 1);

528 
	`©91_£t_A_≥rùh
(
cs_pö
, 0);

532 
devi˚s
[
i
].
c⁄åﬁÀr_d©a
 = (*Ë
cs_pö
;

535 
	`•i_ªgi°î_bﬂrd_öfo
(
devi˚s
, 
ƒ_devi˚s
);

536 
	`©91_˛ock_assocüã
("•i_˛k", &
©91rm9200_•i_devi˚
.
dev
, "spi");

537 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_•i_devi˚
);

538 
	}
}

540 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
Ë{
	}
}

548 #i‡
deföed
(
CONFIG_RTC_DRV_AT91RM9200
Ë|| deföed(
CONFIG_RTC_DRV_AT91RM9200_MODULE
)

549 
∂©f‹m_devi˚
 
	g©91rm9200_πc_devi˚
 = {

550 .
«me
 = "at91_rtc",

551 .
	gid
 = -1,

552 .
	gnum_ªsour˚s
 = 0,

555 
__öô
 
	$©91_add_devi˚_πc
()

557 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_πc_devi˚
);

558 
	}
}

560 
__öô
 
	$©91_add_devi˚_πc
(Ë{
	}
}

568 #i‡
deföed
(
CONFIG_AT91RM9200_WATCHDOG
Ë|| deföed(
CONFIG_AT91RM9200_WATCHDOG_MODULE
)

569 
∂©f‹m_devi˚
 
	g©91rm9200_wdt_devi˚
 = {

570 .
«me
 = "at91_wdt",

571 .
	gid
 = -1,

572 .
	gnum_ªsour˚s
 = 0,

575 
__öô
 
	$©91_add_devi˚_w©chdog
()

577 
	`∂©f‹m_devi˚_ªgi°î
(&
©91rm9200_wdt_devi˚
);

578 
	}
}

580 
__öô
 
	$©91_add_devi˚_w©chdog
(Ë{
	}
}

588 #i‡
deföed
(
CONFIG_LEDS
)

589 
u8
 
	g©91_Àds_˝u
;

590 
u8
 
	g©91_Àds_timî
;

592 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
)

595 
	`©91_£t_gpio_ouçut
(
˝u_Àd
, 1);

596 
	`©91_£t_gpio_ouçut
(
timî_Àd
, 1);

598 
©91_Àds_˝u
 = 
˝u_Àd
;

599 
©91_Àds_timî
 = 
timî_Àd
;

600 
	}
}

602 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
Ë{
	}
}

610 #i‡
deföed
(
CONFIG_SERIAL_ATMEL
)

611 
ªsour˚
 
	gdbgu_ªsour˚s
[] = {

613 .
°¨t
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
,

614 .
	gíd
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
 + 
SZ_512
 - 1,

615 .
	gÊags
 = 
IORESOURCE_MEM
,

618 .
°¨t
 = 
AT91_ID_SYS
,

619 .
	gíd
 = 
AT91_ID_SYS
,

620 .
	gÊags
 = 
IORESOURCE_IRQ
,

624 
©mñ_u¨t_d©a
 
	gdbgu_d©a
 = {

625 .
u£_dma_tx
 = 0,

626 .
	gu£_dma_rx
 = 0,

627 .
	gªgs
 = (
__iomem
 *)(
AT91_VA_BASE_SYS
 + 
AT91_DBGU
),

630 
∂©f‹m_devi˚
 
	g©91rm9200_dbgu_devi˚
 = {

631 .
«me
 = "atmel_usart",

632 .
	gid
 = 0,

633 .
	gdev
 = {

634 .
∂©f‹m_d©a
 = &
dbgu_d©a
,

635 .
	gcohîít_dma_mask
 = 0xffffffff,

637 .
	gªsour˚
 = 
dbgu_ªsour˚s
,

638 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dbgu_ªsour˚s
),

641 
ölöe
 
	$c⁄figuª_dbgu_pös
()

643 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA30
, 0);

644 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA31
, 1);

645 
	}
}

647 
ªsour˚
 
	gu¨t0_ªsour˚s
[] = {

649 .
°¨t
 = 
AT91RM9200_BASE_US0
,

650 .
	gíd
 = 
AT91RM9200_BASE_US0
 + 
SZ_16K
 - 1,

651 .
	gÊags
 = 
IORESOURCE_MEM
,

654 .
°¨t
 = 
AT91RM9200_ID_US0
,

655 .
	gíd
 = 
AT91RM9200_ID_US0
,

656 .
	gÊags
 = 
IORESOURCE_IRQ
,

660 
©mñ_u¨t_d©a
 
	gu¨t0_d©a
 = {

661 .
u£_dma_tx
 = 1,

662 .
	gu£_dma_rx
 = 1,

665 
∂©f‹m_devi˚
 
	g©91rm9200_u¨t0_devi˚
 = {

666 .
«me
 = "atmel_usart",

667 .
	gid
 = 1,

668 .
	gdev
 = {

669 .
∂©f‹m_d©a
 = &
u¨t0_d©a
,

670 .
	gcohîít_dma_mask
 = 0xffffffff,

672 .
	gªsour˚
 = 
u¨t0_ªsour˚s
,

673 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t0_ªsour˚s
),

676 
ölöe
 
	$c⁄figuª_ußπ0_pös
()

678 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA17
, 1);

679 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA18
, 0);

680 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA20
, 0);

686 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PA21
, 1);

687 
	}
}

689 
ªsour˚
 
	gu¨t1_ªsour˚s
[] = {

691 .
°¨t
 = 
AT91RM9200_BASE_US1
,

692 .
	gíd
 = 
AT91RM9200_BASE_US1
 + 
SZ_16K
 - 1,

693 .
	gÊags
 = 
IORESOURCE_MEM
,

696 .
°¨t
 = 
AT91RM9200_ID_US1
,

697 .
	gíd
 = 
AT91RM9200_ID_US1
,

698 .
	gÊags
 = 
IORESOURCE_IRQ
,

702 
©mñ_u¨t_d©a
 
	gu¨t1_d©a
 = {

703 .
u£_dma_tx
 = 1,

704 .
	gu£_dma_rx
 = 1,

707 
∂©f‹m_devi˚
 
	g©91rm9200_u¨t1_devi˚
 = {

708 .
«me
 = "atmel_usart",

709 .
	gid
 = 2,

710 .
	gdev
 = {

711 .
∂©f‹m_d©a
 = &
u¨t1_d©a
,

712 .
	gcohîít_dma_mask
 = 0xffffffff,

714 .
	gªsour˚
 = 
u¨t1_ªsour˚s
,

715 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t1_ªsour˚s
),

718 
ölöe
 
	$c⁄figuª_ußπ1_pös
()

720 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB18
, 0);

721 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB19
, 0);

722 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB20
, 1);

723 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB21
, 0);

724 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB23
, 0);

725 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB24
, 0);

726 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB25
, 0);

727 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB26
, 0);

728 
	}
}

730 
ªsour˚
 
	gu¨t2_ªsour˚s
[] = {

732 .
°¨t
 = 
AT91RM9200_BASE_US2
,

733 .
	gíd
 = 
AT91RM9200_BASE_US2
 + 
SZ_16K
 - 1,

734 .
	gÊags
 = 
IORESOURCE_MEM
,

737 .
°¨t
 = 
AT91RM9200_ID_US2
,

738 .
	gíd
 = 
AT91RM9200_ID_US2
,

739 .
	gÊags
 = 
IORESOURCE_IRQ
,

743 
©mñ_u¨t_d©a
 
	gu¨t2_d©a
 = {

744 .
u£_dma_tx
 = 1,

745 .
	gu£_dma_rx
 = 1,

748 
∂©f‹m_devi˚
 
	g©91rm9200_u¨t2_devi˚
 = {

749 .
«me
 = "atmel_usart",

750 .
	gid
 = 3,

751 .
	gdev
 = {

752 .
∂©f‹m_d©a
 = &
u¨t2_d©a
,

753 .
	gcohîít_dma_mask
 = 0xffffffff,

755 .
	gªsour˚
 = 
u¨t2_ªsour˚s
,

756 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t2_ªsour˚s
),

759 
ölöe
 
	$c⁄figuª_ußπ2_pös
()

761 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA22
, 0);

762 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA23
, 1);

763 
	}
}

765 
ªsour˚
 
	gu¨t3_ªsour˚s
[] = {

767 .
°¨t
 = 
AT91RM9200_BASE_US3
,

768 .
	gíd
 = 
AT91RM9200_BASE_US3
 + 
SZ_16K
 - 1,

769 .
	gÊags
 = 
IORESOURCE_MEM
,

772 .
°¨t
 = 
AT91RM9200_ID_US3
,

773 .
	gíd
 = 
AT91RM9200_ID_US3
,

774 .
	gÊags
 = 
IORESOURCE_IRQ
,

778 
©mñ_u¨t_d©a
 
	gu¨t3_d©a
 = {

779 .
u£_dma_tx
 = 1,

780 .
	gu£_dma_rx
 = 1,

783 
∂©f‹m_devi˚
 
	g©91rm9200_u¨t3_devi˚
 = {

784 .
«me
 = "atmel_usart",

785 .
	gid
 = 4,

786 .
	gdev
 = {

787 .
∂©f‹m_d©a
 = &
u¨t3_d©a
,

788 .
	gcohîít_dma_mask
 = 0xffffffff,

790 .
	gªsour˚
 = 
u¨t3_ªsour˚s
,

791 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t3_ªsour˚s
),

794 
ölöe
 
	$c⁄figuª_ußπ3_pös
()

796 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA5
, 1);

797 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA6
, 0);

798 
	}
}

800 
∂©f‹m_devi˚
 *
	g©91_u¨ts
[
ATMEL_MAX_UART
];

801 
∂©f‹m_devi˚
 *
	g©mñ_deÁu…_c⁄sﬁe_devi˚
;

803 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
)

805 
i
;

808 
i
 = 0; i < 
c⁄fig
->
ƒ_ây
; i++) {

809 
c⁄fig
->
ây_m≠
[
i
]) {

811 
	`c⁄figuª_ußπ0_pös
();

812 
©91_u¨ts
[
i
] = &
©91rm9200_u¨t0_devi˚
;

813 
	`©91_˛ock_assocüã
("ußπ0_˛k", &
©91rm9200_u¨t0_devi˚
.
dev
, "usart");

816 
	`c⁄figuª_ußπ1_pös
();

817 
©91_u¨ts
[
i
] = &
©91rm9200_u¨t1_devi˚
;

818 
	`©91_˛ock_assocüã
("ußπ1_˛k", &
©91rm9200_u¨t1_devi˚
.
dev
, "usart");

821 
	`c⁄figuª_ußπ2_pös
();

822 
©91_u¨ts
[
i
] = &
©91rm9200_u¨t2_devi˚
;

823 
	`©91_˛ock_assocüã
("ußπ2_˛k", &
©91rm9200_u¨t2_devi˚
.
dev
, "usart");

826 
	`c⁄figuª_ußπ3_pös
();

827 
©91_u¨ts
[
i
] = &
©91rm9200_u¨t3_devi˚
;

828 
	`©91_˛ock_assocüã
("ußπ3_˛k", &
©91rm9200_u¨t3_devi˚
.
dev
, "usart");

831 
	`c⁄figuª_dbgu_pös
();

832 
©91_u¨ts
[
i
] = &
©91rm9200_dbgu_devi˚
;

833 
	`©91_˛ock_assocüã
("mck", &
©91rm9200_dbgu_devi˚
.
dev
, "usart");

838 
©91_u¨ts
[
i
]->
id
 = i;

842 i‡(
c⁄fig
->
c⁄sﬁe_ây
 < 
ATMEL_MAX_UART
)

843 
©mñ_deÁu…_c⁄sﬁe_devi˚
 = 
©91_u¨ts
[
c⁄fig
->
c⁄sﬁe_ây
];

844 i‡(!
©mñ_deÁu…_c⁄sﬁe_devi˚
)

845 
	`¥ötk
(
KERN_INFO
 "AT91: No default serial console defined.\n");

846 
	}
}

848 
__öô
 
	$©91_add_devi˚_£rül
()

850 
i
;

852 
i
 = 0; i < 
ATMEL_MAX_UART
; i++) {

853 i‡(
©91_u¨ts
[
i
])

854 
	`∂©f‹m_devi˚_ªgi°î
(
©91_u¨ts
[
i
]);

856 
	}
}

858 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
Ë{
	}
}

859 
__öô
 
	$©91_add_devi˚_£rül
(Ë{
	}
}

869 
__öô
 
	$©91_add_°™d¨d_devi˚s
()

871 
	`©91_add_devi˚_πc
();

872 
	`©91_add_devi˚_w©chdog
();

874 
	}
}

876 
¨ch_öôˇŒ
(
©91_add_°™d¨d_devi˚s
);

	@arch/arm/mach-at91/at91rm9200_time.c

22 
	~<löux/öô.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/úq.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/time.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/io.h
>

31 
	~<asm/mach/time.h
>

33 
	~<asm/¨ch/©91_°.h
>

35 
	gœ°_¸å
;

41 
ölöe
 
	$ªad_CRTR
() {

42 
x1
, 
x2
;

45 
x1
 = 
	`©91_sys_ªad
(
AT91_ST_CRTR
);

46 
x2
 = 
	`©91_sys_ªad
(
AT91_ST_CRTR
);

47 } 
x1
 !
x2
);

49  
x1
;

50 
	}
}

58 
	$©91rm9200_gëtimeoff£t
()

60 
ñ≠£d
;

62 
ñ≠£d
 = (
	`ªad_CRTR
(Ë- 
œ°_¸å
Ë& 
AT91_ST_ALMV
;

64  ()(
ñ≠£d
 * (
tick_n£c
 / 1000)Ë/ 
LATCH
;

65 
	}
}

70 
úqªtu∫_t
 
	$©91rm9200_timî_öãºu±
(
úq
, *
dev_id
)

72 i‡(
	`©91_sys_ªad
(
AT91_ST_SR
Ë& 
AT91_ST_PITS
) {

73 
	`wrôe_£qlock
(&
xtime_lock
);

75 ((
	`ªad_CRTR
(Ë- 
œ°_¸å
Ë& 
AT91_ST_ALMV
Ë>
LATCH
) {

76 
	`timî_tick
();

77 
œ°_¸å
 = (œ°_¸å + 
LATCH
Ë& 
AT91_ST_ALMV
;

80 
	`wrôe_£qu∆ock
(&
xtime_lock
);

82  
IRQ_HANDLED
;

85  
IRQ_NONE
;

86 
	}
}

88 
úqa˘i⁄
 
	g©91rm9200_timî_úq
 = {

89 .
«me
 = "at91_tick",

90 .
	gÊags
 = 
IRQF_SHARED
 | 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

91 .
	gh™dÀr
 = 
©91rm9200_timî_öãºu±


94 
	$©91rm9200_timî_ª£t
()

96 
œ°_¸å
 = 0;

99 
	`©91_sys_wrôe
(
AT91_ST_RTMR
, 1);

102 
	`©91_sys_wrôe
(
AT91_ST_PIMR
, 
LATCH
);

105 (Ë
	`©91_sys_ªad
(
AT91_ST_SR
);

108 
	`©91_sys_wrôe
(
AT91_ST_IER
, 
AT91_ST_PITS
);

109 
	}
}

114 
__öô
 
	$©91rm9200_timî_öô
()

117 
	`©91_sys_wrôe
(
AT91_ST_IDR
, 
AT91_ST_PITS
 | 
AT91_ST_WDOVF
 | 
AT91_ST_RTTINC
 | 
AT91_ST_ALMS
);

118 (Ë
	`©91_sys_ªad
(
AT91_ST_SR
);

121 
	`£tup_úq
(
AT91_ID_SYS
, &
©91rm9200_timî_úq
);

124 
tick_u£c
 = (
LATCH
 * 1000000Ë/ 
CLOCK_TICK_RATE
;

127 
	`©91rm9200_timî_ª£t
();

128 
	}
}

130 #ifde‡
CONFIG_PM


131 
	$©91rm9200_timî_su•íd
()

134 
	`©91_sys_wrôe
(
AT91_ST_IDR
, 
AT91_ST_PITS
);

135 
	}
}

137 
	#©91rm9200_timî_su•íd
 
NULL


	)

140 
sys_timî
 
	g©91rm9200_timî
 = {

141 .
öô
 = 
©91rm9200_timî_öô
,

142 .
	goff£t
 = 
©91rm9200_gëtimeoff£t
,

143 .
	gsu•íd
 = 
©91rm9200_timî_su•íd
,

144 .
	gªsume
 = 
©91rm9200_timî_ª£t
,

	@arch/arm/mach-at91/at91sam9260.c

13 
	~<löux/moduÀ.h
>

15 
	~<asm/mach/¨ch.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch/˝u.h
>

18 
	~<asm/¨ch/©91ßm9260.h
>

19 
	~<asm/¨ch/©91_pmc.h
>

20 
	~<asm/¨ch/©91_r°c.h
>

22 
	~"gíîic.h
"

23 
	~"˛ock.h
"

25 
m≠_desc
 
	g©91ßm9260_io_desc
[] 
	g__öôd©a
 = {

27 .
vútuÆ
 = 
AT91_VA_BASE_SYS
,

28 .
	gp‚
 = 
__phys_to_p‚
(
AT91_BASE_SYS
),

29 .
	gÀngth
 = 
SZ_16K
,

30 .
	gty≥
 = 
MT_DEVICE
,

34 
m≠_desc
 
	g©91ßm9260_§am_desc
[] 
	g__öôd©a
 = {

36 .
vútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91SAM9260_SRAM0_SIZE
,

37 .
	gp‚
 = 
__phys_to_p‚
(
AT91SAM9260_SRAM0_BASE
),

38 .
	gÀngth
 = 
AT91SAM9260_SRAM0_SIZE
,

39 .
	gty≥
 = 
MT_DEVICE
,

41 .
	gvútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91SAM9260_SRAM0_SIZE
 - 
AT91SAM9260_SRAM1_SIZE
,

42 .
	gp‚
 = 
__phys_to_p‚
(
AT91SAM9260_SRAM1_BASE
),

43 .
	gÀngth
 = 
AT91SAM9260_SRAM1_SIZE
,

44 .
	gty≥
 = 
MT_DEVICE
,

48 
m≠_desc
 
	g©91ßm9xe_§am_desc
[] 
	g__öôd©a
 = {

50 .
p‚
 = 
__phys_to_p‚
(
AT91SAM9XE_SRAM_BASE
),

51 .
	gty≥
 = 
MT_DEVICE
,

62 
˛k
 
	gpioA_˛k
 = {

63 .
«me
 = "pioA_clk",

64 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_PIOA
,

65 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

67 
˛k
 
	gpioB_˛k
 = {

68 .
«me
 = "pioB_clk",

69 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_PIOB
,

70 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

72 
˛k
 
	gpioC_˛k
 = {

73 .
«me
 = "pioC_clk",

74 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_PIOC
,

75 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

77 
˛k
 
	gadc_˛k
 = {

78 .
«me
 = "adc_clk",

79 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_ADC
,

80 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

82 
˛k
 
	gußπ0_˛k
 = {

83 .
«me
 = "usart0_clk",

84 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US0
,

85 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

87 
˛k
 
	gußπ1_˛k
 = {

88 .
«me
 = "usart1_clk",

89 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US1
,

90 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

92 
˛k
 
	gußπ2_˛k
 = {

93 .
«me
 = "usart2_clk",

94 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US2
,

95 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

97 
˛k
 
	gmmc_˛k
 = {

98 .
«me
 = "mci_clk",

99 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_MCI
,

100 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

102 
˛k
 
	gudc_˛k
 = {

103 .
«me
 = "udc_clk",

104 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_UDP
,

105 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

107 
˛k
 
	gtwi_˛k
 = {

108 .
«me
 = "twi_clk",

109 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TWI
,

110 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

112 
˛k
 
	g•i0_˛k
 = {

113 .
«me
 = "spi0_clk",

114 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_SPI0
,

115 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

117 
˛k
 
	g•i1_˛k
 = {

118 .
«me
 = "spi1_clk",

119 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_SPI1
,

120 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

122 
˛k
 
	gssc_˛k
 = {

123 .
«me
 = "ssc_clk",

124 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_SSC
,

125 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

127 
˛k
 
	gtc0_˛k
 = {

128 .
«me
 = "tc0_clk",

129 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC0
,

130 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

132 
˛k
 
	gtc1_˛k
 = {

133 .
«me
 = "tc1_clk",

134 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC1
,

135 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

137 
˛k
 
	gtc2_˛k
 = {

138 .
«me
 = "tc2_clk",

139 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC2
,

140 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

142 
˛k
 
	gohci_˛k
 = {

143 .
«me
 = "ohci_clk",

144 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_UHP
,

145 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

147 
˛k
 
	gmacb_˛k
 = {

148 .
«me
 = "macb_clk",

149 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_EMAC
,

150 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

152 
˛k
 
	gisi_˛k
 = {

153 .
«me
 = "isi_clk",

154 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_ISI
,

155 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

157 
˛k
 
	gußπ3_˛k
 = {

158 .
«me
 = "usart3_clk",

159 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US3
,

160 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

162 
˛k
 
	gußπ4_˛k
 = {

163 .
«me
 = "usart4_clk",

164 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US4
,

165 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

167 
˛k
 
	gußπ5_˛k
 = {

168 .
«me
 = "usart5_clk",

169 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_US5
,

170 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

172 
˛k
 
	gtc3_˛k
 = {

173 .
«me
 = "tc3_clk",

174 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC3
,

175 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

177 
˛k
 
	gtc4_˛k
 = {

178 .
«me
 = "tc4_clk",

179 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC4
,

180 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

182 
˛k
 
	gtc5_˛k
 = {

183 .
«me
 = "tc5_clk",

184 .
	gpmc_mask
 = 1 << 
AT91SAM9260_ID_TC5
,

185 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

188 
˛k
 *
	g≥rùh_˛ocks
[] 
	g__öôd©a
 = {

189 &
pioA_˛k
,

190 &
pioB_˛k
,

191 &
pioC_˛k
,

192 &
adc_˛k
,

193 &
ußπ0_˛k
,

194 &
ußπ1_˛k
,

195 &
ußπ2_˛k
,

196 &
mmc_˛k
,

197 &
udc_˛k
,

198 &
twi_˛k
,

199 &
•i0_˛k
,

200 &
•i1_˛k
,

201 &
ssc_˛k
,

202 &
tc0_˛k
,

203 &
tc1_˛k
,

204 &
tc2_˛k
,

205 &
ohci_˛k
,

206 &
macb_˛k
,

207 &
isi_˛k
,

208 &
ußπ3_˛k
,

209 &
ußπ4_˛k
,

210 &
ußπ5_˛k
,

211 &
tc3_˛k
,

212 &
tc4_˛k
,

213 &
tc5_˛k
,

221 
˛k
 
	gpck0
 = {

222 .
«me
 = "pck0",

223 .
	gpmc_mask
 = 
AT91_PMC_PCK0
,

224 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

225 .
	gid
 = 0,

227 
˛k
 
	gpck1
 = {

228 .
«me
 = "pck1",

229 .
	gpmc_mask
 = 
AT91_PMC_PCK1
,

230 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

231 .
	gid
 = 1,

234 
__öô
 
	$©91ßm9260_ªgi°î_˛ocks
()

236 
i
;

238 
i
 = 0; i < 
	`ARRAY_SIZE
(
≥rùh_˛ocks
); i++)

239 
	`˛k_ªgi°î
(
≥rùh_˛ocks
[
i
]);

241 
	`˛k_ªgi°î
(&
pck0
);

242 
	`˛k_ªgi°î
(&
pck1
);

243 
	}
}

249 
©91_gpio_b™k
 
	g©91ßm9260_gpio
[] = {

251 .
id
 = 
AT91SAM9260_ID_PIOA
,

252 .
	goff£t
 = 
AT91_PIOA
,

253 .
	g˛ock
 = &
pioA_˛k
,

255 .
	gid
 = 
AT91SAM9260_ID_PIOB
,

256 .
	goff£t
 = 
AT91_PIOB
,

257 .
	g˛ock
 = &
pioB_˛k
,

259 .
	gid
 = 
AT91SAM9260_ID_PIOC
,

260 .
	goff£t
 = 
AT91_PIOC
,

261 .
	g˛ock
 = &
pioC_˛k
,

265 
	$©91ßm9260_ª£t
()

267 
	`©91_sys_wrôe
(
AT91_RSTC_CR
, 
AT91_RSTC_KEY
 | 
AT91_RSTC_PROCRST
 | 
AT91_RSTC_PERRST
);

268 
	}
}

275 
__öô
 
	$©91ßm9xe_öôülize
()

277 
cidr
, 
§am_size
;

279 
cidr
 = 
	`©91_sys_ªad
(
AT91_DBGU_CIDR
);

281 
cidr
 & 
AT91_CIDR_SRAMSIZ
) {

282 
AT91_CIDR_SRAMSIZ_32K
:

283 
§am_size
 = 2 * 
SZ_16K
;

285 
AT91_CIDR_SRAMSIZ_16K
:

287 
§am_size
 = 
SZ_16K
;

290 
©91ßm9xe_§am_desc
->
vútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
§am_size
;

291 
©91ßm9xe_§am_desc
->
Àngth
 = 
§am_size
;

293 
	`iŸabÀ_öô
(
©91ßm9xe_§am_desc
, 
	`ARRAY_SIZE
(at91sam9xe_sram_desc));

294 
	}
}

296 
__öô
 
	$©91ßm9260_öôülize
(
maö_˛ock
)

299 
	`iŸabÀ_öô
(
©91ßm9260_io_desc
, 
	`ARRAY_SIZE
(at91sam9260_io_desc));

301 i‡(
	`˝u_is_©91ßm9xe
())

302 
	`©91ßm9xe_öôülize
();

304 
	`iŸabÀ_öô
(
©91ßm9260_§am_desc
, 
	`ARRAY_SIZE
(at91sam9260_sram_desc));

306 
©91_¨ch_ª£t
 = 
©91ßm9260_ª£t
;

307 
©91_exã∫_úq
 = (1 << 
AT91SAM9260_ID_IRQ0
Ë| (1 << 
AT91SAM9260_ID_IRQ1
)

308 | (1 << 
AT91SAM9260_ID_IRQ2
);

311 
	`©91_˛ock_öô
(
maö_˛ock
);

314 
	`©91ßm9260_ªgi°î_˛ocks
();

317 
	`©91_gpio_öô
(
©91ßm9260_gpio
, 3);

318 
	}
}

327 
	g©91ßm9260_deÁu…_úq_¥i‹ôy
[
NR_AIC_IRQS
] 
	g__öôd©a
 = {

362 
__öô
 
	$©91ßm9260_öô_öãºu±s
(
¥i‹ôy
[
NR_AIC_IRQS
])

364 i‡(!
¥i‹ôy
)

365 
¥i‹ôy
 = 
©91ßm9260_deÁu…_úq_¥i‹ôy
;

368 
	`©91_aic_öô
(
¥i‹ôy
);

371 
	`©91_gpio_úq_£tup
();

372 
	}
}

	@arch/arm/mach-at91/at91sam9260_devices.c

12 
	~<asm/mach/¨ch.h
>

13 
	~<asm/mach/m≠.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<asm/¨ch/bﬂrd.h
>

18 
	~<asm/¨ch/gpio.h
>

19 
	~<asm/¨ch/©91ßm9260.h
>

20 
	~<asm/¨ch/©91ßm926x_mc.h
>

21 
	~<asm/¨ch/©91ßm9260_m©rix.h
>

23 
	~"gíîic.h
"

30 #i‡
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

31 
u64
 
	gohci_dmamask
 = 0xffffffffUL;

32 
©91_usbh_d©a
 
	gusbh_d©a
;

34 
ªsour˚
 
	gusbh_ªsour˚s
[] = {

36 .
°¨t
 = 
AT91SAM9260_UHP_BASE
,

37 .
	gíd
 = 
AT91SAM9260_UHP_BASE
 + 
SZ_1M
 - 1,

38 .
	gÊags
 = 
IORESOURCE_MEM
,

41 .
°¨t
 = 
AT91SAM9260_ID_UHP
,

42 .
	gíd
 = 
AT91SAM9260_ID_UHP
,

43 .
	gÊags
 = 
IORESOURCE_IRQ
,

47 
∂©f‹m_devi˚
 
	g©91_usbh_devi˚
 = {

48 .
«me
 = "at91_ohci",

49 .
	gid
 = -1,

50 .
	gdev
 = {

51 .
dma_mask
 = &
ohci_dmamask
,

52 .
	gcohîít_dma_mask
 = 0xffffffff,

53 .
	g∂©f‹m_d©a
 = &
usbh_d©a
,

55 .
	gªsour˚
 = 
usbh_ªsour˚s
,

56 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
usbh_ªsour˚s
),

59 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
)

61 i‡(!
d©a
)

64 
usbh_d©a
 = *
d©a
;

65 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_usbh_devi˚
);

66 
	}
}

68 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
Ë{
	}
}

76 #ifde‡
CONFIG_USB_GADGET_AT91


77 
©91_udc_d©a
 
	gudc_d©a
;

79 
ªsour˚
 
	gudc_ªsour˚s
[] = {

81 .
°¨t
 = 
AT91SAM9260_BASE_UDP
,

82 .
	gíd
 = 
AT91SAM9260_BASE_UDP
 + 
SZ_16K
 - 1,

83 .
	gÊags
 = 
IORESOURCE_MEM
,

86 .
°¨t
 = 
AT91SAM9260_ID_UDP
,

87 .
	gíd
 = 
AT91SAM9260_ID_UDP
,

88 .
	gÊags
 = 
IORESOURCE_IRQ
,

92 
∂©f‹m_devi˚
 
	g©91_udc_devi˚
 = {

93 .
«me
 = "at91_udc",

94 .
	gid
 = -1,

95 .
	gdev
 = {

96 .
∂©f‹m_d©a
 = &
udc_d©a
,

98 .
	gªsour˚
 = 
udc_ªsour˚s
,

99 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
udc_ªsour˚s
),

102 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
)

104 i‡(!
d©a
)

107 i‡(
d©a
->
vbus_pö
) {

108 
	`©91_£t_gpio_öput
(
d©a
->
vbus_pö
, 0);

109 
	`©91_£t_deglôch
(
d©a
->
vbus_pö
, 1);

114 
udc_d©a
 = *
d©a
;

115 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_udc_devi˚
);

116 
	}
}

118 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
Ë{
	}
}

126 #i‡
deföed
(
CONFIG_MACB
Ë|| deföed(
CONFIG_MACB_MODULE
)

127 
u64
 
	gëh_dmamask
 = 0xffffffffUL;

128 
©91_ëh_d©a
 
	gëh_d©a
;

130 
ªsour˚
 
	gëh_ªsour˚s
[] = {

132 .
°¨t
 = 
AT91SAM9260_BASE_EMAC
,

133 .
	gíd
 = 
AT91SAM9260_BASE_EMAC
 + 
SZ_16K
 - 1,

134 .
	gÊags
 = 
IORESOURCE_MEM
,

137 .
°¨t
 = 
AT91SAM9260_ID_EMAC
,

138 .
	gíd
 = 
AT91SAM9260_ID_EMAC
,

139 .
	gÊags
 = 
IORESOURCE_IRQ
,

143 
∂©f‹m_devi˚
 
	g©91ßm9260_ëh_devi˚
 = {

144 .
«me
 = "macb",

145 .
	gid
 = -1,

146 .
	gdev
 = {

147 .
dma_mask
 = &
ëh_dmamask
,

148 .
	gcohîít_dma_mask
 = 0xffffffff,

149 .
	g∂©f‹m_d©a
 = &
ëh_d©a
,

151 .
	gªsour˚
 = 
ëh_ªsour˚s
,

152 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ëh_ªsour˚s
),

155 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
)

157 i‡(!
d©a
)

160 i‡(
d©a
->
phy_úq_pö
) {

161 
	`©91_£t_gpio_öput
(
d©a
->
phy_úq_pö
, 0);

162 
	`©91_£t_deglôch
(
d©a
->
phy_úq_pö
, 1);

166 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA19
, 0);

167 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA17
, 0);

168 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA14
, 0);

169 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA15
, 0);

170 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA18
, 0);

171 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA16
, 0);

172 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA12
, 0);

173 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA13
, 0);

174 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA21
, 0);

175 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA20
, 0);

177 i‡(!
d©a
->
is_rmii
) {

178 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA28
, 0);

179 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA29
, 0);

180 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA25
, 0);

181 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA26
, 0);

182 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA27
, 0);

183 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA23
, 0);

184 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA24
, 0);

185 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA22
, 0);

188 
ëh_d©a
 = *
d©a
;

189 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_ëh_devi˚
);

190 
	}
}

192 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
Ë{
	}
}

200 #i‡
deföed
(
CONFIG_MMC_AT91
Ë|| deföed(
CONFIG_MMC_AT91_MODULE
)

201 
u64
 
	gmmc_dmamask
 = 0xffffffffUL;

202 
©91_mmc_d©a
 
	gmmc_d©a
;

204 
ªsour˚
 
	gmmc_ªsour˚s
[] = {

206 .
°¨t
 = 
AT91SAM9260_BASE_MCI
,

207 .
	gíd
 = 
AT91SAM9260_BASE_MCI
 + 
SZ_16K
 - 1,

208 .
	gÊags
 = 
IORESOURCE_MEM
,

211 .
°¨t
 = 
AT91SAM9260_ID_MCI
,

212 .
	gíd
 = 
AT91SAM9260_ID_MCI
,

213 .
	gÊags
 = 
IORESOURCE_IRQ
,

217 
∂©f‹m_devi˚
 
	g©91ßm9260_mmc_devi˚
 = {

218 .
«me
 = "at91_mci",

219 .
	gid
 = -1,

220 .
	gdev
 = {

221 .
dma_mask
 = &
mmc_dmamask
,

222 .
	gcohîít_dma_mask
 = 0xffffffff,

223 .
	g∂©f‹m_d©a
 = &
mmc_d©a
,

225 .
	gªsour˚
 = 
mmc_ªsour˚s
,

226 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc_ªsour˚s
),

229 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
)

231 i‡(!
d©a
)

235 i‡(
d©a
->
dë_pö
) {

236 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

237 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

239 i‡(
d©a
->
wp_pö
)

240 
	`©91_£t_gpio_öput
(
d©a
->
wp_pö
, 1);

241 i‡(
d©a
->
vcc_pö
)

242 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

245 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA8
, 0);

247 i‡(
d©a
->
¶Ÿ_b
) {

249 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA1
, 1);

252 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA0
, 1);

253 i‡(
d©a
->
wúe4
) {

254 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA5
, 1);

255 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA4
, 1);

256 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA3
, 1);

260 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA7
, 1);

263 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA6
, 1);

264 i‡(
d©a
->
wúe4
) {

265 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA9
, 1);

266 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA10
, 1);

267 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA11
, 1);

271 
mmc_d©a
 = *
d©a
;

272 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_mmc_devi˚
);

273 
	}
}

275 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
Ë{
	}
}

283 #i‡
deföed
(
CONFIG_MTD_NAND_AT91
Ë|| deföed(
CONFIG_MTD_NAND_AT91_MODULE
)

284 
©91_«nd_d©a
 
	g«nd_d©a
;

286 
	#NAND_BASE
 
AT91_CHIPSELECT_3


	)

288 
ªsour˚
 
	g«nd_ªsour˚s
[] = {

290 .
°¨t
 = 
NAND_BASE
,

291 .
	gíd
 = 
NAND_BASE
 + 
SZ_8M
 - 1,

292 .
	gÊags
 = 
IORESOURCE_MEM
,

296 
∂©f‹m_devi˚
 
	g©91ßm9260_«nd_devi˚
 = {

297 .
«me
 = "at91_nand",

298 .
	gid
 = -1,

299 .
	gdev
 = {

300 .
∂©f‹m_d©a
 = &
«nd_d©a
,

302 .
	gªsour˚
 = 
«nd_ªsour˚s
,

303 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«nd_ªsour˚s
),

306 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
)

308 
cß
, 
mode
;

310 i‡(!
d©a
)

313 
cß
 = 
	`©91_sys_ªad
(
AT91_MATRIX_EBICSA
);

314 
	`©91_sys_wrôe
(
AT91_MATRIX_EBICSA
, 
cß
 | 
AT91_MATRIX_CS3A_SMC
);

317 
	`©91_sys_wrôe
(
	`AT91_SMC_SETUP
(3), 
	`AT91_SMC_NWESETUP_
(0Ë| 
	`AT91_SMC_NCS_WRSETUP_
(0)

318 | 
	`AT91_SMC_NRDSETUP_
(0Ë| 
	`AT91_SMC_NCS_RDSETUP_
(0));

320 
	`©91_sys_wrôe
(
	`AT91_SMC_PULSE
(3), 
	`AT91_SMC_NWEPULSE_
(3Ë| 
	`AT91_SMC_NCS_WRPULSE_
(3)

321 | 
	`AT91_SMC_NRDPULSE_
(3Ë| 
	`AT91_SMC_NCS_RDPULSE_
(3));

323 
	`©91_sys_wrôe
(
	`AT91_SMC_CYCLE
(3), 
	`AT91_SMC_NWECYCLE_
(5Ë| 
	`AT91_SMC_NRDCYCLE_
(5));

325 i‡(
d©a
->
bus_width_16
)

326 
mode
 = 
AT91_SMC_DBW_16
;

328 
mode
 = 
AT91_SMC_DBW_8
;

329 
	`©91_sys_wrôe
(
	`AT91_SMC_MODE
(3), 
mode
 | 
AT91_SMC_READMODE
 | 
AT91_SMC_WRITEMODE
 | 
AT91_SMC_EXNWMODE_DISABLE
 | 
	`AT91_SMC_TDF_
(2));

332 i‡(
d©a
->
íabÀ_pö
)

333 
	`©91_£t_gpio_ouçut
(
d©a
->
íabÀ_pö
, 1);

336 i‡(
d©a
->
rdy_pö
)

337 
	`©91_£t_gpio_öput
(
d©a
->
rdy_pö
, 1);

340 i‡(
d©a
->
dë_pö
)

341 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

343 
«nd_d©a
 = *
d©a
;

344 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_«nd_devi˚
);

345 
	}
}

347 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
Ë{
	}
}

355 #i‡
deföed
(
CONFIG_I2C_AT91
Ë|| deföed(
CONFIG_I2C_AT91_MODULE
)

357 
ªsour˚
 
	gtwi_ªsour˚s
[] = {

359 .
°¨t
 = 
AT91SAM9260_BASE_TWI
,

360 .
	gíd
 = 
AT91SAM9260_BASE_TWI
 + 
SZ_16K
 - 1,

361 .
	gÊags
 = 
IORESOURCE_MEM
,

364 .
°¨t
 = 
AT91SAM9260_ID_TWI
,

365 .
	gíd
 = 
AT91SAM9260_ID_TWI
,

366 .
	gÊags
 = 
IORESOURCE_IRQ
,

370 
∂©f‹m_devi˚
 
	g©91ßm9260_twi_devi˚
 = {

371 .
«me
 = "at91_i2c",

372 .
	gid
 = -1,

373 .
	gªsour˚
 = 
twi_ªsour˚s
,

374 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
twi_ªsour˚s
),

377 
__öô
 
	$©91_add_devi˚_i2c
()

380 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA23
, 0);

381 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA23
, 1);

383 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA24
, 0);

384 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA24
, 1);

386 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_twi_devi˚
);

387 
	}
}

389 
__öô
 
	$©91_add_devi˚_i2c
(Ë{
	}
}

397 #i‡
deföed
(
CONFIG_SPI_ATMEL
Ë|| deföed(
CONFIG_SPI_ATMEL_MODULE
)

398 
u64
 
	g•i_dmamask
 = 0xffffffffUL;

400 
ªsour˚
 
	g•i0_ªsour˚s
[] = {

402 .
°¨t
 = 
AT91SAM9260_BASE_SPI0
,

403 .
	gíd
 = 
AT91SAM9260_BASE_SPI0
 + 
SZ_16K
 - 1,

404 .
	gÊags
 = 
IORESOURCE_MEM
,

407 .
°¨t
 = 
AT91SAM9260_ID_SPI0
,

408 .
	gíd
 = 
AT91SAM9260_ID_SPI0
,

409 .
	gÊags
 = 
IORESOURCE_IRQ
,

413 
∂©f‹m_devi˚
 
	g©91ßm9260_•i0_devi˚
 = {

414 .
«me
 = "atmel_spi",

415 .
	gid
 = 0,

416 .
	gdev
 = {

417 .
dma_mask
 = &
•i_dmamask
,

418 .
	gcohîít_dma_mask
 = 0xffffffff,

420 .
	gªsour˚
 = 
•i0_ªsour˚s
,

421 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i0_ªsour˚s
),

424 c⁄° 
	g•i0_°™d¨d_cs
[4] = { 
AT91_PIN_PA3
, 
AT91_PIN_PC11
, 
AT91_PIN_PC16
, 
AT91_PIN_PC17
 };

426 
ªsour˚
 
	g•i1_ªsour˚s
[] = {

428 .
°¨t
 = 
AT91SAM9260_BASE_SPI1
,

429 .
	gíd
 = 
AT91SAM9260_BASE_SPI1
 + 
SZ_16K
 - 1,

430 .
	gÊags
 = 
IORESOURCE_MEM
,

433 .
°¨t
 = 
AT91SAM9260_ID_SPI1
,

434 .
	gíd
 = 
AT91SAM9260_ID_SPI1
,

435 .
	gÊags
 = 
IORESOURCE_IRQ
,

439 
∂©f‹m_devi˚
 
	g©91ßm9260_•i1_devi˚
 = {

440 .
«me
 = "atmel_spi",

441 .
	gid
 = 1,

442 .
	gdev
 = {

443 .
dma_mask
 = &
•i_dmamask
,

444 .
	gcohîít_dma_mask
 = 0xffffffff,

446 .
	gªsour˚
 = 
•i1_ªsour˚s
,

447 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i1_ªsour˚s
),

450 c⁄° 
	g•i1_°™d¨d_cs
[4] = { 
AT91_PIN_PB3
, 
AT91_PIN_PC5
, 
AT91_PIN_PC4
, 
AT91_PIN_PC3
 };

452 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
)

454 
i
;

455 
cs_pö
;

456 
íabÀ_•i0
 = 0;

457 
íabÀ_•i1
 = 0;

460 
i
 = 0; i < 
ƒ_devi˚s
; i++) {

461 i‡(
devi˚s
[
i
].
c⁄åﬁÀr_d©a
)

462 
cs_pö
 = (Ë
devi˚s
[
i
].
c⁄åﬁÀr_d©a
;

463 i‡(
devi˚s
[
i
].
bus_num
 == 0)

464 
cs_pö
 = 
•i0_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

466 
cs_pö
 = 
•i1_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

468 i‡(
devi˚s
[
i
].
bus_num
 == 0)

469 
íabÀ_•i0
 = 1;

471 
íabÀ_•i1
 = 1;

474 
	`©91_£t_gpio_ouçut
(
cs_pö
, 1);

477 
devi˚s
[
i
].
c⁄åﬁÀr_d©a
 = (*Ë
cs_pö
;

480 
	`•i_ªgi°î_bﬂrd_öfo
(
devi˚s
, 
ƒ_devi˚s
);

483 i‡(
íabÀ_•i0
) {

484 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA0
, 0);

485 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA1
, 0);

486 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA2
, 0);

488 
	`©91_˛ock_assocüã
("•i0_˛k", &
©91ßm9260_•i0_devi˚
.
dev
, "spi_clk");

489 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_•i0_devi˚
);

491 i‡(
íabÀ_•i1
) {

492 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB0
, 0);

493 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB1
, 0);

494 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB2
, 0);

496 
	`©91_˛ock_assocüã
("•i1_˛k", &
©91ßm9260_•i1_devi˚
.
dev
, "spi_clk");

497 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9260_•i1_devi˚
);

499 
	}
}

501 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
Ë{
	}
}

509 #i‡
deföed
(
CONFIG_LEDS
)

510 
u8
 
	g©91_Àds_˝u
;

511 
u8
 
	g©91_Àds_timî
;

513 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
)

516 
	`©91_£t_gpio_ouçut
(
˝u_Àd
, 1);

517 
	`©91_£t_gpio_ouçut
(
timî_Àd
, 1);

519 
©91_Àds_˝u
 = 
˝u_Àd
;

520 
©91_Àds_timî
 = 
timî_Àd
;

521 
	}
}

523 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
Ë{
	}
}

530 #i‡
deföed
(
CONFIG_SERIAL_ATMEL
)

531 
ªsour˚
 
	gdbgu_ªsour˚s
[] = {

533 .
°¨t
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
,

534 .
	gíd
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
 + 
SZ_512
 - 1,

535 .
	gÊags
 = 
IORESOURCE_MEM
,

538 .
°¨t
 = 
AT91_ID_SYS
,

539 .
	gíd
 = 
AT91_ID_SYS
,

540 .
	gÊags
 = 
IORESOURCE_IRQ
,

544 
©mñ_u¨t_d©a
 
	gdbgu_d©a
 = {

545 .
u£_dma_tx
 = 0,

546 .
	gu£_dma_rx
 = 0,

547 .
	gªgs
 = (
__iomem
 *)(
AT91_VA_BASE_SYS
 + 
AT91_DBGU
),

550 
∂©f‹m_devi˚
 
	g©91ßm9260_dbgu_devi˚
 = {

551 .
«me
 = "atmel_usart",

552 .
	gid
 = 0,

553 .
	gdev
 = {

554 .
∂©f‹m_d©a
 = &
dbgu_d©a
,

555 .
	gcohîít_dma_mask
 = 0xffffffff,

557 .
	gªsour˚
 = 
dbgu_ªsour˚s
,

558 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dbgu_ªsour˚s
),

561 
ölöe
 
	$c⁄figuª_dbgu_pös
()

563 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB14
, 0);

564 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB15
, 1);

565 
	}
}

567 
ªsour˚
 
	gu¨t0_ªsour˚s
[] = {

569 .
°¨t
 = 
AT91SAM9260_BASE_US0
,

570 .
	gíd
 = 
AT91SAM9260_BASE_US0
 + 
SZ_16K
 - 1,

571 .
	gÊags
 = 
IORESOURCE_MEM
,

574 .
°¨t
 = 
AT91SAM9260_ID_US0
,

575 .
	gíd
 = 
AT91SAM9260_ID_US0
,

576 .
	gÊags
 = 
IORESOURCE_IRQ
,

580 
©mñ_u¨t_d©a
 
	gu¨t0_d©a
 = {

581 .
u£_dma_tx
 = 1,

582 .
	gu£_dma_rx
 = 1,

585 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t0_devi˚
 = {

586 .
«me
 = "atmel_usart",

587 .
	gid
 = 1,

588 .
	gdev
 = {

589 .
∂©f‹m_d©a
 = &
u¨t0_d©a
,

590 .
	gcohîít_dma_mask
 = 0xffffffff,

592 .
	gªsour˚
 = 
u¨t0_ªsour˚s
,

593 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t0_ªsour˚s
),

596 
ölöe
 
	$c⁄figuª_ußπ0_pös
()

598 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB4
, 1);

599 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB5
, 0);

600 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB26
, 0);

601 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB27
, 0);

602 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB24
, 0);

603 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB22
, 0);

604 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB23
, 0);

605 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB25
, 0);

606 
	}
}

608 
ªsour˚
 
	gu¨t1_ªsour˚s
[] = {

610 .
°¨t
 = 
AT91SAM9260_BASE_US1
,

611 .
	gíd
 = 
AT91SAM9260_BASE_US1
 + 
SZ_16K
 - 1,

612 .
	gÊags
 = 
IORESOURCE_MEM
,

615 .
°¨t
 = 
AT91SAM9260_ID_US1
,

616 .
	gíd
 = 
AT91SAM9260_ID_US1
,

617 .
	gÊags
 = 
IORESOURCE_IRQ
,

621 
©mñ_u¨t_d©a
 
	gu¨t1_d©a
 = {

622 .
u£_dma_tx
 = 1,

623 .
	gu£_dma_rx
 = 1,

626 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t1_devi˚
 = {

627 .
«me
 = "atmel_usart",

628 .
	gid
 = 2,

629 .
	gdev
 = {

630 .
∂©f‹m_d©a
 = &
u¨t1_d©a
,

631 .
	gcohîít_dma_mask
 = 0xffffffff,

633 .
	gªsour˚
 = 
u¨t1_ªsour˚s
,

634 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t1_ªsour˚s
),

637 
ölöe
 
	$c⁄figuª_ußπ1_pös
()

639 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB6
, 1);

640 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB7
, 0);

641 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB28
, 0);

642 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB29
, 0);

643 
	}
}

645 
ªsour˚
 
	gu¨t2_ªsour˚s
[] = {

647 .
°¨t
 = 
AT91SAM9260_BASE_US2
,

648 .
	gíd
 = 
AT91SAM9260_BASE_US2
 + 
SZ_16K
 - 1,

649 .
	gÊags
 = 
IORESOURCE_MEM
,

652 .
°¨t
 = 
AT91SAM9260_ID_US2
,

653 .
	gíd
 = 
AT91SAM9260_ID_US2
,

654 .
	gÊags
 = 
IORESOURCE_IRQ
,

658 
©mñ_u¨t_d©a
 
	gu¨t2_d©a
 = {

659 .
u£_dma_tx
 = 1,

660 .
	gu£_dma_rx
 = 1,

663 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t2_devi˚
 = {

664 .
«me
 = "atmel_usart",

665 .
	gid
 = 3,

666 .
	gdev
 = {

667 .
∂©f‹m_d©a
 = &
u¨t2_d©a
,

668 .
	gcohîít_dma_mask
 = 0xffffffff,

670 .
	gªsour˚
 = 
u¨t2_ªsour˚s
,

671 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t2_ªsour˚s
),

674 
ölöe
 
	$c⁄figuª_ußπ2_pös
()

676 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB8
, 1);

677 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB9
, 0);

678 
	}
}

680 
ªsour˚
 
	gu¨t3_ªsour˚s
[] = {

682 .
°¨t
 = 
AT91SAM9260_BASE_US3
,

683 .
	gíd
 = 
AT91SAM9260_BASE_US3
 + 
SZ_16K
 - 1,

684 .
	gÊags
 = 
IORESOURCE_MEM
,

687 .
°¨t
 = 
AT91SAM9260_ID_US3
,

688 .
	gíd
 = 
AT91SAM9260_ID_US3
,

689 .
	gÊags
 = 
IORESOURCE_IRQ
,

693 
©mñ_u¨t_d©a
 
	gu¨t3_d©a
 = {

694 .
u£_dma_tx
 = 1,

695 .
	gu£_dma_rx
 = 1,

698 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t3_devi˚
 = {

699 .
«me
 = "atmel_usart",

700 .
	gid
 = 4,

701 .
	gdev
 = {

702 .
∂©f‹m_d©a
 = &
u¨t3_d©a
,

703 .
	gcohîít_dma_mask
 = 0xffffffff,

705 .
	gªsour˚
 = 
u¨t3_ªsour˚s
,

706 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t3_ªsour˚s
),

709 
ölöe
 
	$c⁄figuª_ußπ3_pös
()

711 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB10
, 1);

712 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB11
, 0);

713 
	}
}

715 
ªsour˚
 
	gu¨t4_ªsour˚s
[] = {

717 .
°¨t
 = 
AT91SAM9260_BASE_US4
,

718 .
	gíd
 = 
AT91SAM9260_BASE_US4
 + 
SZ_16K
 - 1,

719 .
	gÊags
 = 
IORESOURCE_MEM
,

722 .
°¨t
 = 
AT91SAM9260_ID_US4
,

723 .
	gíd
 = 
AT91SAM9260_ID_US4
,

724 .
	gÊags
 = 
IORESOURCE_IRQ
,

728 
©mñ_u¨t_d©a
 
	gu¨t4_d©a
 = {

729 .
u£_dma_tx
 = 1,

730 .
	gu£_dma_rx
 = 1,

733 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t4_devi˚
 = {

734 .
«me
 = "atmel_usart",

735 .
	gid
 = 5,

736 .
	gdev
 = {

737 .
∂©f‹m_d©a
 = &
u¨t4_d©a
,

738 .
	gcohîít_dma_mask
 = 0xffffffff,

740 .
	gªsour˚
 = 
u¨t4_ªsour˚s
,

741 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t4_ªsour˚s
),

744 
ölöe
 
	$c⁄figuª_ußπ4_pös
()

746 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA31
, 1);

747 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA30
, 0);

748 
	}
}

750 
ªsour˚
 
	gu¨t5_ªsour˚s
[] = {

752 .
°¨t
 = 
AT91SAM9260_BASE_US5
,

753 .
	gíd
 = 
AT91SAM9260_BASE_US5
 + 
SZ_16K
 - 1,

754 .
	gÊags
 = 
IORESOURCE_MEM
,

757 .
°¨t
 = 
AT91SAM9260_ID_US5
,

758 .
	gíd
 = 
AT91SAM9260_ID_US5
,

759 .
	gÊags
 = 
IORESOURCE_IRQ
,

763 
©mñ_u¨t_d©a
 
	gu¨t5_d©a
 = {

764 .
u£_dma_tx
 = 1,

765 .
	gu£_dma_rx
 = 1,

768 
∂©f‹m_devi˚
 
	g©91ßm9260_u¨t5_devi˚
 = {

769 .
«me
 = "atmel_usart",

770 .
	gid
 = 6,

771 .
	gdev
 = {

772 .
∂©f‹m_d©a
 = &
u¨t5_d©a
,

773 .
	gcohîít_dma_mask
 = 0xffffffff,

775 .
	gªsour˚
 = 
u¨t5_ªsour˚s
,

776 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t5_ªsour˚s
),

779 
ölöe
 
	$c⁄figuª_ußπ5_pös
()

781 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB12
, 1);

782 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB13
, 0);

783 
	}
}

785 
∂©f‹m_devi˚
 *
	g©91_u¨ts
[
ATMEL_MAX_UART
];

786 
∂©f‹m_devi˚
 *
	g©mñ_deÁu…_c⁄sﬁe_devi˚
;

788 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
)

790 
i
;

793 
i
 = 0; i < 
c⁄fig
->
ƒ_ây
; i++) {

794 
c⁄fig
->
ây_m≠
[
i
]) {

796 
	`c⁄figuª_ußπ0_pös
();

797 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t0_devi˚
;

798 
	`©91_˛ock_assocüã
("ußπ0_˛k", &
©91ßm9260_u¨t0_devi˚
.
dev
, "usart");

801 
	`c⁄figuª_ußπ1_pös
();

802 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t1_devi˚
;

803 
	`©91_˛ock_assocüã
("ußπ1_˛k", &
©91ßm9260_u¨t1_devi˚
.
dev
, "usart");

806 
	`c⁄figuª_ußπ2_pös
();

807 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t2_devi˚
;

808 
	`©91_˛ock_assocüã
("ußπ2_˛k", &
©91ßm9260_u¨t2_devi˚
.
dev
, "usart");

811 
	`c⁄figuª_ußπ3_pös
();

812 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t3_devi˚
;

813 
	`©91_˛ock_assocüã
("ußπ3_˛k", &
©91ßm9260_u¨t3_devi˚
.
dev
, "usart");

816 
	`c⁄figuª_ußπ4_pös
();

817 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t4_devi˚
;

818 
	`©91_˛ock_assocüã
("ußπ4_˛k", &
©91ßm9260_u¨t4_devi˚
.
dev
, "usart");

821 
	`c⁄figuª_ußπ5_pös
();

822 
©91_u¨ts
[
i
] = &
©91ßm9260_u¨t5_devi˚
;

823 
	`©91_˛ock_assocüã
("ußπ5_˛k", &
©91ßm9260_u¨t5_devi˚
.
dev
, "usart");

826 
	`c⁄figuª_dbgu_pös
();

827 
©91_u¨ts
[
i
] = &
©91ßm9260_dbgu_devi˚
;

828 
	`©91_˛ock_assocüã
("mck", &
©91ßm9260_dbgu_devi˚
.
dev
, "usart");

833 
©91_u¨ts
[
i
]->
id
 = i;

837 i‡(
c⁄fig
->
c⁄sﬁe_ây
 < 
ATMEL_MAX_UART
)

838 
©mñ_deÁu…_c⁄sﬁe_devi˚
 = 
©91_u¨ts
[
c⁄fig
->
c⁄sﬁe_ây
];

839 i‡(!
©mñ_deÁu…_c⁄sﬁe_devi˚
)

840 
	`¥ötk
(
KERN_INFO
 "AT91: No default serial console defined.\n");

841 
	}
}

843 
__öô
 
	$©91_add_devi˚_£rül
()

845 
i
;

847 
i
 = 0; i < 
ATMEL_MAX_UART
; i++) {

848 i‡(
©91_u¨ts
[
i
])

849 
	`∂©f‹m_devi˚_ªgi°î
(
©91_u¨ts
[
i
]);

851 
	}
}

853 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
Ë{
	}
}

854 
__öô
 
	$©91_add_devi˚_£rül
(Ë{
	}
}

863 
__öô
 
	$©91_add_°™d¨d_devi˚s
()

866 
	}
}

868 
¨ch_öôˇŒ
(
©91_add_°™d¨d_devi˚s
);

	@arch/arm/mach-at91/at91sam9261.c

13 
	~<löux/moduÀ.h
>

15 
	~<asm/mach/¨ch.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch/©91ßm9261.h
>

18 
	~<asm/¨ch/©91_pmc.h
>

19 
	~<asm/¨ch/©91_r°c.h
>

21 
	~"gíîic.h
"

22 
	~"˛ock.h
"

24 
m≠_desc
 
	g©91ßm9261_io_desc
[] 
	g__öôd©a
 = {

26 .
vútuÆ
 = 
AT91_VA_BASE_SYS
,

27 .
	gp‚
 = 
__phys_to_p‚
(
AT91_BASE_SYS
),

28 .
	gÀngth
 = 
SZ_16K
,

29 .
	gty≥
 = 
MT_DEVICE
,

31 .
	gvútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91SAM9261_SRAM_SIZE
,

32 .
	gp‚
 = 
__phys_to_p‚
(
AT91SAM9261_SRAM_BASE
),

33 .
	gÀngth
 = 
AT91SAM9261_SRAM_SIZE
,

34 .
	gty≥
 = 
MT_DEVICE
,

45 
˛k
 
	gpioA_˛k
 = {

46 .
«me
 = "pioA_clk",

47 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_PIOA
,

48 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

50 
˛k
 
	gpioB_˛k
 = {

51 .
«me
 = "pioB_clk",

52 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_PIOB
,

53 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

55 
˛k
 
	gpioC_˛k
 = {

56 .
«me
 = "pioC_clk",

57 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_PIOC
,

58 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

60 
˛k
 
	gußπ0_˛k
 = {

61 .
«me
 = "usart0_clk",

62 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_US0
,

63 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

65 
˛k
 
	gußπ1_˛k
 = {

66 .
«me
 = "usart1_clk",

67 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_US1
,

68 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

70 
˛k
 
	gußπ2_˛k
 = {

71 .
«me
 = "usart2_clk",

72 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_US2
,

73 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

75 
˛k
 
	gmmc_˛k
 = {

76 .
«me
 = "mci_clk",

77 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_MCI
,

78 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

80 
˛k
 
	gudc_˛k
 = {

81 .
«me
 = "udc_clk",

82 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_UDP
,

83 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

85 
˛k
 
	gtwi_˛k
 = {

86 .
«me
 = "twi_clk",

87 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_TWI
,

88 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

90 
˛k
 
	g•i0_˛k
 = {

91 .
«me
 = "spi0_clk",

92 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_SPI0
,

93 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

95 
˛k
 
	g•i1_˛k
 = {

96 .
«me
 = "spi1_clk",

97 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_SPI1
,

98 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

100 
˛k
 
	gssc0_˛k
 = {

101 .
«me
 = "ssc0_clk",

102 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_SSC0
,

103 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

105 
˛k
 
	gssc1_˛k
 = {

106 .
«me
 = "ssc1_clk",

107 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_SSC1
,

108 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

110 
˛k
 
	gssc2_˛k
 = {

111 .
«me
 = "ssc2_clk",

112 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_SSC2
,

113 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

115 
˛k
 
	gtc0_˛k
 = {

116 .
«me
 = "tc0_clk",

117 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_TC0
,

118 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

120 
˛k
 
	gtc1_˛k
 = {

121 .
«me
 = "tc1_clk",

122 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_TC1
,

123 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

125 
˛k
 
	gtc2_˛k
 = {

126 .
«me
 = "tc2_clk",

127 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_TC2
,

128 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

130 
˛k
 
	gohci_˛k
 = {

131 .
«me
 = "ohci_clk",

132 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_UHP
,

133 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

135 
˛k
 
	glcdc_˛k
 = {

136 .
«me
 = "lcdc_clk",

137 .
	gpmc_mask
 = 1 << 
AT91SAM9261_ID_LCDC
,

138 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

141 
˛k
 *
	g≥rùh_˛ocks
[] 
	g__öôd©a
 = {

142 &
pioA_˛k
,

143 &
pioB_˛k
,

144 &
pioC_˛k
,

145 &
ußπ0_˛k
,

146 &
ußπ1_˛k
,

147 &
ußπ2_˛k
,

148 &
mmc_˛k
,

149 &
udc_˛k
,

150 &
twi_˛k
,

151 &
•i0_˛k
,

152 &
•i1_˛k
,

153 &
ssc0_˛k
,

154 &
ssc1_˛k
,

155 &
ssc2_˛k
,

156 &
tc0_˛k
,

157 &
tc1_˛k
,

158 &
tc2_˛k
,

159 &
ohci_˛k
,

160 &
lcdc_˛k
,

168 
˛k
 
	gpck0
 = {

169 .
«me
 = "pck0",

170 .
	gpmc_mask
 = 
AT91_PMC_PCK0
,

171 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

172 .
	gid
 = 0,

174 
˛k
 
	gpck1
 = {

175 .
«me
 = "pck1",

176 .
	gpmc_mask
 = 
AT91_PMC_PCK1
,

177 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

178 .
	gid
 = 1,

180 
˛k
 
	gpck2
 = {

181 .
«me
 = "pck2",

182 .
	gpmc_mask
 = 
AT91_PMC_PCK2
,

183 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

184 .
	gid
 = 2,

186 
˛k
 
	gpck3
 = {

187 .
«me
 = "pck3",

188 .
	gpmc_mask
 = 
AT91_PMC_PCK3
,

189 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

190 .
	gid
 = 3,

194 
˛k
 
	ghck0
 = {

195 .
«me
 = "hck0",

196 .
	gpmc_mask
 = 
AT91_PMC_HCK0
,

197 .
	gty≥
 = 
CLK_TYPE_SYSTEM
,

198 .
	gid
 = 0,

200 
˛k
 
	ghck1
 = {

201 .
«me
 = "hck1",

202 .
	gpmc_mask
 = 
AT91_PMC_HCK1
,

203 .
	gty≥
 = 
CLK_TYPE_SYSTEM
,

204 .
	gid
 = 1,

207 
__öô
 
	$©91ßm9261_ªgi°î_˛ocks
()

209 
i
;

211 
i
 = 0; i < 
	`ARRAY_SIZE
(
≥rùh_˛ocks
); i++)

212 
	`˛k_ªgi°î
(
≥rùh_˛ocks
[
i
]);

214 
	`˛k_ªgi°î
(&
pck0
);

215 
	`˛k_ªgi°î
(&
pck1
);

216 
	`˛k_ªgi°î
(&
pck2
);

217 
	`˛k_ªgi°î
(&
pck3
);

219 
	`˛k_ªgi°î
(&
hck0
);

220 
	`˛k_ªgi°î
(&
hck1
);

221 
	}
}

227 
©91_gpio_b™k
 
	g©91ßm9261_gpio
[] = {

229 .
id
 = 
AT91SAM9261_ID_PIOA
,

230 .
	goff£t
 = 
AT91_PIOA
,

231 .
	g˛ock
 = &
pioA_˛k
,

233 .
	gid
 = 
AT91SAM9261_ID_PIOB
,

234 .
	goff£t
 = 
AT91_PIOB
,

235 .
	g˛ock
 = &
pioB_˛k
,

237 .
	gid
 = 
AT91SAM9261_ID_PIOC
,

238 .
	goff£t
 = 
AT91_PIOC
,

239 .
	g˛ock
 = &
pioC_˛k
,

243 
	$©91ßm9261_ª£t
()

245 
	`©91_sys_wrôe
(
AT91_RSTC_CR
, 
AT91_RSTC_KEY
 | 
AT91_RSTC_PROCRST
 | 
AT91_RSTC_PERRST
);

246 
	}
}

253 
__öô
 
	$©91ßm9261_öôülize
(
maö_˛ock
)

256 
	`iŸabÀ_öô
(
©91ßm9261_io_desc
, 
	`ARRAY_SIZE
(at91sam9261_io_desc));

258 
©91_¨ch_ª£t
 = 
©91ßm9261_ª£t
;

259 
©91_exã∫_úq
 = (1 << 
AT91SAM9261_ID_IRQ0
Ë| (1 << 
AT91SAM9261_ID_IRQ1
)

260 | (1 << 
AT91SAM9261_ID_IRQ2
);

263 
	`©91_˛ock_öô
(
maö_˛ock
);

266 
	`©91ßm9261_ªgi°î_˛ocks
();

269 
	`©91_gpio_öô
(
©91ßm9261_gpio
, 3);

270 
	}
}

279 
	g©91ßm9261_deÁu…_úq_¥i‹ôy
[
NR_AIC_IRQS
] 
	g__öôd©a
 = {

314 
__öô
 
	$©91ßm9261_öô_öãºu±s
(
¥i‹ôy
[
NR_AIC_IRQS
])

316 i‡(!
¥i‹ôy
)

317 
¥i‹ôy
 = 
©91ßm9261_deÁu…_úq_¥i‹ôy
;

320 
	`©91_aic_öô
(
¥i‹ôy
);

323 
	`©91_gpio_úq_£tup
();

324 
	}
}

	@arch/arm/mach-at91/at91sam9261_devices.c

13 
	~<asm/mach/¨ch.h
>

14 
	~<asm/mach/m≠.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<asm/¨ch/bﬂrd.h
>

19 
	~<asm/¨ch/gpio.h
>

20 
	~<asm/¨ch/©91ßm9261.h
>

21 
	~<asm/¨ch/©91ßm9261_m©rix.h
>

22 
	~<asm/¨ch/©91ßm926x_mc.h
>

24 
	~"gíîic.h
"

31 #i‡
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

32 
u64
 
	gohci_dmamask
 = 0xffffffffUL;

33 
©91_usbh_d©a
 
	gusbh_d©a
;

35 
ªsour˚
 
	gusbh_ªsour˚s
[] = {

37 .
°¨t
 = 
AT91SAM9261_UHP_BASE
,

38 .
	gíd
 = 
AT91SAM9261_UHP_BASE
 + 
SZ_1M
 - 1,

39 .
	gÊags
 = 
IORESOURCE_MEM
,

42 .
°¨t
 = 
AT91SAM9261_ID_UHP
,

43 .
	gíd
 = 
AT91SAM9261_ID_UHP
,

44 .
	gÊags
 = 
IORESOURCE_IRQ
,

48 
∂©f‹m_devi˚
 
	g©91ßm9261_usbh_devi˚
 = {

49 .
«me
 = "at91_ohci",

50 .
	gid
 = -1,

51 .
	gdev
 = {

52 .
dma_mask
 = &
ohci_dmamask
,

53 .
	gcohîít_dma_mask
 = 0xffffffff,

54 .
	g∂©f‹m_d©a
 = &
usbh_d©a
,

56 .
	gªsour˚
 = 
usbh_ªsour˚s
,

57 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
usbh_ªsour˚s
),

60 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
)

62 i‡(!
d©a
)

65 
usbh_d©a
 = *
d©a
;

66 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_usbh_devi˚
);

67 
	}
}

69 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
Ë{
	}
}

77 #ifde‡
CONFIG_USB_GADGET_AT91


78 
©91_udc_d©a
 
	gudc_d©a
;

80 
ªsour˚
 
	gudc_ªsour˚s
[] = {

82 .
°¨t
 = 
AT91SAM9261_BASE_UDP
,

83 .
	gíd
 = 
AT91SAM9261_BASE_UDP
 + 
SZ_16K
 - 1,

84 .
	gÊags
 = 
IORESOURCE_MEM
,

87 .
°¨t
 = 
AT91SAM9261_ID_UDP
,

88 .
	gíd
 = 
AT91SAM9261_ID_UDP
,

89 .
	gÊags
 = 
IORESOURCE_IRQ
,

93 
∂©f‹m_devi˚
 
	g©91ßm9261_udc_devi˚
 = {

94 .
«me
 = "at91_udc",

95 .
	gid
 = -1,

96 .
	gdev
 = {

97 .
∂©f‹m_d©a
 = &
udc_d©a
,

99 .
	gªsour˚
 = 
udc_ªsour˚s
,

100 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
udc_ªsour˚s
),

103 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
)

105 
x
;

107 i‡(!
d©a
)

110 i‡(
d©a
->
vbus_pö
) {

111 
	`©91_£t_gpio_öput
(
d©a
->
vbus_pö
, 0);

112 
	`©91_£t_deglôch
(
d©a
->
vbus_pö
, 1);

116 
x
 = 
	`©91_sys_ªad
(
AT91_MATRIX_USBPUCR
);

117 
	`©91_sys_wrôe
(
AT91_MATRIX_USBPUCR
, 
x
 | 
AT91_MATRIX_USBPUCR_PUON
);

119 
udc_d©a
 = *
d©a
;

120 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_udc_devi˚
);

121 
	}
}

123 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
Ë{
	}
}

130 #i‡
deföed
(
CONFIG_MMC_AT91
Ë|| deföed(
CONFIG_MMC_AT91_MODULE
)

131 
u64
 
	gmmc_dmamask
 = 0xffffffffUL;

132 
©91_mmc_d©a
 
	gmmc_d©a
;

134 
ªsour˚
 
	gmmc_ªsour˚s
[] = {

136 .
°¨t
 = 
AT91SAM9261_BASE_MCI
,

137 .
	gíd
 = 
AT91SAM9261_BASE_MCI
 + 
SZ_16K
 - 1,

138 .
	gÊags
 = 
IORESOURCE_MEM
,

141 .
°¨t
 = 
AT91SAM9261_ID_MCI
,

142 .
	gíd
 = 
AT91SAM9261_ID_MCI
,

143 .
	gÊags
 = 
IORESOURCE_IRQ
,

147 
∂©f‹m_devi˚
 
	g©91ßm9261_mmc_devi˚
 = {

148 .
«me
 = "at91_mci",

149 .
	gid
 = -1,

150 .
	gdev
 = {

151 .
dma_mask
 = &
mmc_dmamask
,

152 .
	gcohîít_dma_mask
 = 0xffffffff,

153 .
	g∂©f‹m_d©a
 = &
mmc_d©a
,

155 .
	gªsour˚
 = 
mmc_ªsour˚s
,

156 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc_ªsour˚s
),

159 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
)

161 i‡(!
d©a
)

165 i‡(
d©a
->
dë_pö
) {

166 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

167 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

169 i‡(
d©a
->
wp_pö
)

170 
	`©91_£t_gpio_öput
(
d©a
->
wp_pö
, 1);

171 i‡(
d©a
->
vcc_pö
)

172 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

175 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA2
, 0);

178 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA1
, 1);

181 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA0
, 1);

182 i‡(
d©a
->
wúe4
) {

183 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA4
, 1);

184 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA5
, 1);

185 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA6
, 1);

188 
mmc_d©a
 = *
d©a
;

189 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_mmc_devi˚
);

190 
	}
}

192 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
Ë{
	}
}

200 #i‡
deföed
(
CONFIG_MTD_NAND_AT91
Ë|| deföed(
CONFIG_MTD_NAND_AT91_MODULE
)

201 
©91_«nd_d©a
 
	g«nd_d©a
;

203 
	#NAND_BASE
 
AT91_CHIPSELECT_3


	)

205 
ªsour˚
 
	g«nd_ªsour˚s
[] = {

207 .
°¨t
 = 
NAND_BASE
,

208 .
	gíd
 = 
NAND_BASE
 + 
SZ_256M
 - 1,

209 .
	gÊags
 = 
IORESOURCE_MEM
,

213 
∂©f‹m_devi˚
 
	g©91_«nd_devi˚
 = {

214 .
«me
 = "at91_nand",

215 .
	gid
 = -1,

216 .
	gdev
 = {

217 .
∂©f‹m_d©a
 = &
«nd_d©a
,

219 .
	gªsour˚
 = 
«nd_ªsour˚s
,

220 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«nd_ªsour˚s
),

223 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
)

225 
cß
, 
mode
;

227 i‡(!
d©a
)

230 
cß
 = 
	`©91_sys_ªad
(
AT91_MATRIX_EBICSA
);

231 
	`©91_sys_wrôe
(
AT91_MATRIX_EBICSA
, 
cß
 | 
AT91_MATRIX_CS3A_SMC
);

234 
	`©91_sys_wrôe
(
	`AT91_SMC_SETUP
(3), 
	`AT91_SMC_NWESETUP_
(0Ë| 
	`AT91_SMC_NCS_WRSETUP_
(0)

235 | 
	`AT91_SMC_NRDSETUP_
(0Ë| 
	`AT91_SMC_NCS_RDSETUP_
(0));

237 
	`©91_sys_wrôe
(
	`AT91_SMC_PULSE
(3), 
	`AT91_SMC_NWEPULSE_
(2Ë| 
	`AT91_SMC_NCS_WRPULSE_
(5)

238 | 
	`AT91_SMC_NRDPULSE_
(2Ë| 
	`AT91_SMC_NCS_RDPULSE_
(5));

240 
	`©91_sys_wrôe
(
	`AT91_SMC_CYCLE
(3), 
	`AT91_SMC_NWECYCLE_
(7Ë| 
	`AT91_SMC_NRDCYCLE_
(7));

242 i‡(
d©a
->
bus_width_16
)

243 
mode
 = 
AT91_SMC_DBW_16
;

245 
mode
 = 
AT91_SMC_DBW_8
;

246 
	`©91_sys_wrôe
(
	`AT91_SMC_MODE
(3), 
mode
 | 
AT91_SMC_READMODE
 | 
AT91_SMC_WRITEMODE
 | 
AT91_SMC_EXNWMODE_DISABLE
 | 
	`AT91_SMC_TDF_
(1));

249 i‡(
d©a
->
íabÀ_pö
)

250 
	`©91_£t_gpio_ouçut
(
d©a
->
íabÀ_pö
, 1);

253 i‡(
d©a
->
rdy_pö
)

254 
	`©91_£t_gpio_öput
(
d©a
->
rdy_pö
, 1);

257 i‡(
d©a
->
dë_pö
)

258 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

260 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC0
, 0);

261 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC1
, 0);

263 
«nd_d©a
 = *
d©a
;

264 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_«nd_devi˚
);

265 
	}
}

268 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
Ë{
	}
}

276 #i‡
deföed
(
CONFIG_I2C_AT91
Ë|| deföed(
CONFIG_I2C_AT91_MODULE
)

278 
ªsour˚
 
	gtwi_ªsour˚s
[] = {

280 .
°¨t
 = 
AT91SAM9261_BASE_TWI
,

281 .
	gíd
 = 
AT91SAM9261_BASE_TWI
 + 
SZ_16K
 - 1,

282 .
	gÊags
 = 
IORESOURCE_MEM
,

285 .
°¨t
 = 
AT91SAM9261_ID_TWI
,

286 .
	gíd
 = 
AT91SAM9261_ID_TWI
,

287 .
	gÊags
 = 
IORESOURCE_IRQ
,

291 
∂©f‹m_devi˚
 
	g©91ßm9261_twi_devi˚
 = {

292 .
«me
 = "at91_i2c",

293 .
	gid
 = -1,

294 .
	gªsour˚
 = 
twi_ªsour˚s
,

295 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
twi_ªsour˚s
),

298 
__öô
 
	$©91_add_devi˚_i2c
()

301 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA7
, 0);

302 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA7
, 1);

304 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA8
, 0);

305 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA8
, 1);

307 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_twi_devi˚
);

308 
	}
}

310 
__öô
 
	$©91_add_devi˚_i2c
(Ë{
	}
}

318 #i‡
deföed
(
CONFIG_SPI_ATMEL
Ë|| deföed(
CONFIG_SPI_ATMEL_MODULE
)

319 
u64
 
	g•i_dmamask
 = 0xffffffffUL;

321 
ªsour˚
 
	g•i0_ªsour˚s
[] = {

323 .
°¨t
 = 
AT91SAM9261_BASE_SPI0
,

324 .
	gíd
 = 
AT91SAM9261_BASE_SPI0
 + 
SZ_16K
 - 1,

325 .
	gÊags
 = 
IORESOURCE_MEM
,

328 .
°¨t
 = 
AT91SAM9261_ID_SPI0
,

329 .
	gíd
 = 
AT91SAM9261_ID_SPI0
,

330 .
	gÊags
 = 
IORESOURCE_IRQ
,

334 
∂©f‹m_devi˚
 
	g©91ßm9261_•i0_devi˚
 = {

335 .
«me
 = "atmel_spi",

336 .
	gid
 = 0,

337 .
	gdev
 = {

338 .
dma_mask
 = &
•i_dmamask
,

339 .
	gcohîít_dma_mask
 = 0xffffffff,

341 .
	gªsour˚
 = 
•i0_ªsour˚s
,

342 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i0_ªsour˚s
),

345 c⁄° 
	g•i0_°™d¨d_cs
[4] = { 
AT91_PIN_PA3
, 
AT91_PIN_PA4
, 
AT91_PIN_PA5
, 
AT91_PIN_PA6
 };

347 
ªsour˚
 
	g•i1_ªsour˚s
[] = {

349 .
°¨t
 = 
AT91SAM9261_BASE_SPI1
,

350 .
	gíd
 = 
AT91SAM9261_BASE_SPI1
 + 
SZ_16K
 - 1,

351 .
	gÊags
 = 
IORESOURCE_MEM
,

354 .
°¨t
 = 
AT91SAM9261_ID_SPI1
,

355 .
	gíd
 = 
AT91SAM9261_ID_SPI1
,

356 .
	gÊags
 = 
IORESOURCE_IRQ
,

360 
∂©f‹m_devi˚
 
	g©91ßm9261_•i1_devi˚
 = {

361 .
«me
 = "atmel_spi",

362 .
	gid
 = 1,

363 .
	gdev
 = {

364 .
dma_mask
 = &
•i_dmamask
,

365 .
	gcohîít_dma_mask
 = 0xffffffff,

367 .
	gªsour˚
 = 
•i1_ªsour˚s
,

368 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i1_ªsour˚s
),

371 c⁄° 
	g•i1_°™d¨d_cs
[4] = { 
AT91_PIN_PB28
, 
AT91_PIN_PA24
, 
AT91_PIN_PA25
, 
AT91_PIN_PA26
 };

373 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
)

375 
i
;

376 
cs_pö
;

377 
íabÀ_•i0
 = 0;

378 
íabÀ_•i1
 = 0;

381 
i
 = 0; i < 
ƒ_devi˚s
; i++) {

382 i‡(
devi˚s
[
i
].
c⁄åﬁÀr_d©a
)

383 
cs_pö
 = (Ë
devi˚s
[
i
].
c⁄åﬁÀr_d©a
;

384 i‡(
devi˚s
[
i
].
bus_num
 == 0)

385 
cs_pö
 = 
•i0_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

387 
cs_pö
 = 
•i1_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

389 i‡(
devi˚s
[
i
].
bus_num
 == 0)

390 
íabÀ_•i0
 = 1;

392 
íabÀ_•i1
 = 1;

395 
	`©91_£t_gpio_ouçut
(
cs_pö
, 1);

398 
devi˚s
[
i
].
c⁄åﬁÀr_d©a
 = (*Ë
cs_pö
;

401 
	`•i_ªgi°î_bﬂrd_öfo
(
devi˚s
, 
ƒ_devi˚s
);

404 i‡(
íabÀ_•i0
) {

405 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA0
, 0);

406 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA1
, 0);

407 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA2
, 0);

409 
	`©91_˛ock_assocüã
("•i0_˛k", &
©91ßm9261_•i0_devi˚
.
dev
, "spi_clk");

410 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_•i0_devi˚
);

412 i‡(
íabÀ_•i1
) {

413 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB30
, 0);

414 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB31
, 0);

415 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB29
, 0);

417 
	`©91_˛ock_assocüã
("•i1_˛k", &
©91ßm9261_•i1_devi˚
.
dev
, "spi_clk");

418 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_•i1_devi˚
);

420 
	}
}

422 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
Ë{
	}
}

430 #i‡
deföed
(
CONFIG_FB_ATMEL
Ë|| deföed(
CONFIG_FB_ATMEL_MODULE
)

431 
u64
 
	glcdc_dmamask
 = 0xffffffffUL;

432 
©mñ_lcdfb_öfo
 
	glcdc_d©a
;

434 
ªsour˚
 
	glcdc_ªsour˚s
[] = {

436 .
°¨t
 = 
AT91SAM9261_LCDC_BASE
,

437 .
	gíd
 = 
AT91SAM9261_LCDC_BASE
 + 
SZ_4K
 - 1,

438 .
	gÊags
 = 
IORESOURCE_MEM
,

441 .
°¨t
 = 
AT91SAM9261_ID_LCDC
,

442 .
	gíd
 = 
AT91SAM9261_ID_LCDC
,

443 .
	gÊags
 = 
IORESOURCE_IRQ
,

445 #i‡
deföed
(
CONFIG_FB_INTSRAM
)

447 .
°¨t
 = 
AT91SAM9261_SRAM_BASE
,

448 .
	gíd
 = 
AT91SAM9261_SRAM_BASE
 + 
AT91SAM9261_SRAM_SIZE
 - 1,

449 .
	gÊags
 = 
IORESOURCE_MEM
,

454 
∂©f‹m_devi˚
 
	g©91_lcdc_devi˚
 = {

455 .
«me
 = "atmel_lcdfb",

456 .
	gid
 = 0,

457 .
	gdev
 = {

458 .
dma_mask
 = &
lcdc_dmamask
,

459 .
	gcohîít_dma_mask
 = 0xffffffff,

460 .
	g∂©f‹m_d©a
 = &
lcdc_d©a
,

462 .
	gªsour˚
 = 
lcdc_ªsour˚s
,

463 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
lcdc_ªsour˚s
),

466 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
)

468 i‡(!
d©a
) {

472 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB1
, 0);

473 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB2
, 0);

474 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB3
, 0);

475 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB4
, 0);

476 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB7
, 0);

477 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB8
, 0);

478 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB9
, 0);

479 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB10
, 0);

480 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB11
, 0);

481 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB12
, 0);

482 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB15
, 0);

483 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB16
, 0);

484 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB17
, 0);

485 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB18
, 0);

486 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB19
, 0);

487 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB20
, 0);

488 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB23
, 0);

489 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB24
, 0);

490 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB25
, 0);

491 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB26
, 0);

492 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB27
, 0);

493 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB28
, 0);

495 
lcdc_d©a
 = *
d©a
;

496 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_lcdc_devi˚
);

497 
	}
}

499 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
Ë{
	}
}

507 #i‡
deföed
(
CONFIG_LEDS
)

508 
u8
 
	g©91_Àds_˝u
;

509 
u8
 
	g©91_Àds_timî
;

511 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
)

514 
	`©91_£t_gpio_ouçut
(
˝u_Àd
, 1);

515 
	`©91_£t_gpio_ouçut
(
timî_Àd
, 1);

517 
©91_Àds_˝u
 = 
˝u_Àd
;

518 
©91_Àds_timî
 = 
timî_Àd
;

519 
	}
}

521 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
Ë{
	}
}

529 #i‡
deföed
(
CONFIG_SERIAL_ATMEL
)

530 
ªsour˚
 
	gdbgu_ªsour˚s
[] = {

532 .
°¨t
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
,

533 .
	gíd
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
 + 
SZ_512
 - 1,

534 .
	gÊags
 = 
IORESOURCE_MEM
,

537 .
°¨t
 = 
AT91_ID_SYS
,

538 .
	gíd
 = 
AT91_ID_SYS
,

539 .
	gÊags
 = 
IORESOURCE_IRQ
,

543 
©mñ_u¨t_d©a
 
	gdbgu_d©a
 = {

544 .
u£_dma_tx
 = 0,

545 .
	gu£_dma_rx
 = 0,

546 .
	gªgs
 = (
__iomem
 *)(
AT91_VA_BASE_SYS
 + 
AT91_DBGU
),

549 
∂©f‹m_devi˚
 
	g©91ßm9261_dbgu_devi˚
 = {

550 .
«me
 = "atmel_usart",

551 .
	gid
 = 0,

552 .
	gdev
 = {

553 .
∂©f‹m_d©a
 = &
dbgu_d©a
,

554 .
	gcohîít_dma_mask
 = 0xffffffff,

556 .
	gªsour˚
 = 
dbgu_ªsour˚s
,

557 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dbgu_ªsour˚s
),

560 
ölöe
 
	$c⁄figuª_dbgu_pös
()

562 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA9
, 0);

563 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA10
, 1);

564 
	}
}

566 
ªsour˚
 
	gu¨t0_ªsour˚s
[] = {

568 .
°¨t
 = 
AT91SAM9261_BASE_US0
,

569 .
	gíd
 = 
AT91SAM9261_BASE_US0
 + 
SZ_16K
 - 1,

570 .
	gÊags
 = 
IORESOURCE_MEM
,

573 .
°¨t
 = 
AT91SAM9261_ID_US0
,

574 .
	gíd
 = 
AT91SAM9261_ID_US0
,

575 .
	gÊags
 = 
IORESOURCE_IRQ
,

579 
©mñ_u¨t_d©a
 
	gu¨t0_d©a
 = {

580 .
u£_dma_tx
 = 1,

581 .
	gu£_dma_rx
 = 1,

584 
∂©f‹m_devi˚
 
	g©91ßm9261_u¨t0_devi˚
 = {

585 .
«me
 = "atmel_usart",

586 .
	gid
 = 1,

587 .
	gdev
 = {

588 .
∂©f‹m_d©a
 = &
u¨t0_d©a
,

589 .
	gcohîít_dma_mask
 = 0xffffffff,

591 .
	gªsour˚
 = 
u¨t0_ªsour˚s
,

592 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t0_ªsour˚s
),

595 
ölöe
 
	$c⁄figuª_ußπ0_pös
()

597 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC8
, 1);

598 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC9
, 0);

599 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC10
, 0);

600 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC11
, 0);

601 
	}
}

603 
ªsour˚
 
	gu¨t1_ªsour˚s
[] = {

605 .
°¨t
 = 
AT91SAM9261_BASE_US1
,

606 .
	gíd
 = 
AT91SAM9261_BASE_US1
 + 
SZ_16K
 - 1,

607 .
	gÊags
 = 
IORESOURCE_MEM
,

610 .
°¨t
 = 
AT91SAM9261_ID_US1
,

611 .
	gíd
 = 
AT91SAM9261_ID_US1
,

612 .
	gÊags
 = 
IORESOURCE_IRQ
,

616 
©mñ_u¨t_d©a
 
	gu¨t1_d©a
 = {

617 .
u£_dma_tx
 = 1,

618 .
	gu£_dma_rx
 = 1,

621 
∂©f‹m_devi˚
 
	g©91ßm9261_u¨t1_devi˚
 = {

622 .
«me
 = "atmel_usart",

623 .
	gid
 = 2,

624 .
	gdev
 = {

625 .
∂©f‹m_d©a
 = &
u¨t1_d©a
,

626 .
	gcohîít_dma_mask
 = 0xffffffff,

628 .
	gªsour˚
 = 
u¨t1_ªsour˚s
,

629 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t1_ªsour˚s
),

632 
ölöe
 
	$c⁄figuª_ußπ1_pös
()

634 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC12
, 1);

635 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC13
, 0);

636 
	}
}

638 
ªsour˚
 
	gu¨t2_ªsour˚s
[] = {

640 .
°¨t
 = 
AT91SAM9261_BASE_US2
,

641 .
	gíd
 = 
AT91SAM9261_BASE_US2
 + 
SZ_16K
 - 1,

642 .
	gÊags
 = 
IORESOURCE_MEM
,

645 .
°¨t
 = 
AT91SAM9261_ID_US2
,

646 .
	gíd
 = 
AT91SAM9261_ID_US2
,

647 .
	gÊags
 = 
IORESOURCE_IRQ
,

651 
©mñ_u¨t_d©a
 
	gu¨t2_d©a
 = {

652 .
u£_dma_tx
 = 1,

653 .
	gu£_dma_rx
 = 1,

656 
∂©f‹m_devi˚
 
	g©91ßm9261_u¨t2_devi˚
 = {

657 .
«me
 = "atmel_usart",

658 .
	gid
 = 3,

659 .
	gdev
 = {

660 .
∂©f‹m_d©a
 = &
u¨t2_d©a
,

661 .
	gcohîít_dma_mask
 = 0xffffffff,

663 .
	gªsour˚
 = 
u¨t2_ªsour˚s
,

664 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t2_ªsour˚s
),

667 
ölöe
 
	$c⁄figuª_ußπ2_pös
()

669 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC15
, 0);

670 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC14
, 1);

671 
	}
}

673 
∂©f‹m_devi˚
 *
	g©91_u¨ts
[
ATMEL_MAX_UART
];

674 
∂©f‹m_devi˚
 *
	g©mñ_deÁu…_c⁄sﬁe_devi˚
;

676 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
)

678 
i
;

681 
i
 = 0; i < 
c⁄fig
->
ƒ_ây
; i++) {

682 
c⁄fig
->
ây_m≠
[
i
]) {

684 
	`c⁄figuª_ußπ0_pös
();

685 
©91_u¨ts
[
i
] = &
©91ßm9261_u¨t0_devi˚
;

686 
	`©91_˛ock_assocüã
("ußπ0_˛k", &
©91ßm9261_u¨t0_devi˚
.
dev
, "usart");

689 
	`c⁄figuª_ußπ1_pös
();

690 
©91_u¨ts
[
i
] = &
©91ßm9261_u¨t1_devi˚
;

691 
	`©91_˛ock_assocüã
("ußπ1_˛k", &
©91ßm9261_u¨t1_devi˚
.
dev
, "usart");

694 
	`c⁄figuª_ußπ2_pös
();

695 
©91_u¨ts
[
i
] = &
©91ßm9261_u¨t2_devi˚
;

696 
	`©91_˛ock_assocüã
("ußπ2_˛k", &
©91ßm9261_u¨t2_devi˚
.
dev
, "usart");

699 
	`c⁄figuª_dbgu_pös
();

700 
©91_u¨ts
[
i
] = &
©91ßm9261_dbgu_devi˚
;

701 
	`©91_˛ock_assocüã
("mck", &
©91ßm9261_dbgu_devi˚
.
dev
, "usart");

706 
©91_u¨ts
[
i
]->
id
 = i;

710 i‡(
c⁄fig
->
c⁄sﬁe_ây
 < 
ATMEL_MAX_UART
)

711 
©mñ_deÁu…_c⁄sﬁe_devi˚
 = 
©91_u¨ts
[
c⁄fig
->
c⁄sﬁe_ây
];

712 i‡(!
©mñ_deÁu…_c⁄sﬁe_devi˚
)

713 
	`¥ötk
(
KERN_INFO
 "AT91: No default serial console defined.\n");

714 
	}
}

716 
__öô
 
	$©91_add_devi˚_£rül
()

718 
i
;

720 
i
 = 0; i < 
ATMEL_MAX_UART
; i++) {

721 i‡(
©91_u¨ts
[
i
])

722 
	`∂©f‹m_devi˚_ªgi°î
(
©91_u¨ts
[
i
]);

724 
	}
}

726 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
Ë{
	}
}

727 
__öô
 
	$©91_add_devi˚_£rül
(Ë{
	}
}

737 
__öô
 
	$©91_add_°™d¨d_devi˚s
()

740 
	}
}

742 
¨ch_öôˇŒ
(
©91_add_°™d¨d_devi˚s
);

	@arch/arm/mach-at91/at91sam9263.c

13 
	~<löux/moduÀ.h
>

15 
	~<asm/mach/¨ch.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch/©91ßm9263.h
>

18 
	~<asm/¨ch/©91_pmc.h
>

19 
	~<asm/¨ch/©91_r°c.h
>

21 
	~"gíîic.h
"

22 
	~"˛ock.h
"

24 
m≠_desc
 
	g©91ßm9263_io_desc
[] 
	g__öôd©a
 = {

26 .
vútuÆ
 = 
AT91_VA_BASE_SYS
,

27 .
	gp‚
 = 
__phys_to_p‚
(
AT91_BASE_SYS
),

28 .
	gÀngth
 = 
SZ_16K
,

29 .
	gty≥
 = 
MT_DEVICE
,

31 .
	gvútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91SAM9263_SRAM0_SIZE
,

32 .
	gp‚
 = 
__phys_to_p‚
(
AT91SAM9263_SRAM0_BASE
),

33 .
	gÀngth
 = 
AT91SAM9263_SRAM0_SIZE
,

34 .
	gty≥
 = 
MT_DEVICE
,

36 .
	gvútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
AT91SAM9263_SRAM0_SIZE
 - 
AT91SAM9263_SRAM1_SIZE
,

37 .
	gp‚
 = 
__phys_to_p‚
(
AT91SAM9263_SRAM1_BASE
),

38 .
	gÀngth
 = 
AT91SAM9263_SRAM1_SIZE
,

39 .
	gty≥
 = 
MT_DEVICE
,

50 
˛k
 
	gpioA_˛k
 = {

51 .
«me
 = "pioA_clk",

52 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_PIOA
,

53 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

55 
˛k
 
	gpioB_˛k
 = {

56 .
«me
 = "pioB_clk",

57 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_PIOB
,

58 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

60 
˛k
 
	gpioCDE_˛k
 = {

61 .
«me
 = "pioCDE_clk",

62 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_PIOCDE
,

63 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

65 
˛k
 
	gußπ0_˛k
 = {

66 .
«me
 = "usart0_clk",

67 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_US0
,

68 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

70 
˛k
 
	gußπ1_˛k
 = {

71 .
«me
 = "usart1_clk",

72 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_US1
,

73 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

75 
˛k
 
	gußπ2_˛k
 = {

76 .
«me
 = "usart2_clk",

77 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_US2
,

78 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

80 
˛k
 
	gmmc0_˛k
 = {

81 .
«me
 = "mci0_clk",

82 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_MCI0
,

83 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

85 
˛k
 
	gmmc1_˛k
 = {

86 .
«me
 = "mci1_clk",

87 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_MCI1
,

88 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

90 
˛k
 
	gˇn_˛k
 = {

91 .
«me
 = "can_clk",

92 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_CAN
,

93 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

95 
˛k
 
	gtwi_˛k
 = {

96 .
«me
 = "twi_clk",

97 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_TWI
,

98 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

100 
˛k
 
	g•i0_˛k
 = {

101 .
«me
 = "spi0_clk",

102 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_SPI0
,

103 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

105 
˛k
 
	g•i1_˛k
 = {

106 .
«me
 = "spi1_clk",

107 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_SPI1
,

108 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

110 
˛k
 
	gssc0_˛k
 = {

111 .
«me
 = "ssc0_clk",

112 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_SSC0
,

113 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

115 
˛k
 
	gssc1_˛k
 = {

116 .
«me
 = "ssc1_clk",

117 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_SSC1
,

118 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

120 
˛k
 
	gac97_˛k
 = {

121 .
«me
 = "ac97_clk",

122 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_AC97C
,

123 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

125 
˛k
 
	gtcb_˛k
 = {

126 .
«me
 = "tcb_clk",

127 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_TCB
,

128 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

130 
˛k
 
	gpwmc_˛k
 = {

131 .
«me
 = "pwmc_clk",

132 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_PWMC
,

133 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

135 
˛k
 
	gmacb_˛k
 = {

136 .
«me
 = "macb_clk",

137 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_EMAC
,

138 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

140 
˛k
 
	gdma_˛k
 = {

141 .
«me
 = "dma_clk",

142 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_DMA
,

143 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

145 
˛k
 
	gtwodge_˛k
 = {

146 .
«me
 = "2dge_clk",

147 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_2DGE
,

148 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

150 
˛k
 
	gudc_˛k
 = {

151 .
«me
 = "udc_clk",

152 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_UDP
,

153 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

155 
˛k
 
	gisi_˛k
 = {

156 .
«me
 = "isi_clk",

157 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_ISI
,

158 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

160 
˛k
 
	glcdc_˛k
 = {

161 .
«me
 = "lcdc_clk",

162 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_LCDC
,

163 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

165 
˛k
 
	gohci_˛k
 = {

166 .
«me
 = "ohci_clk",

167 .
	gpmc_mask
 = 1 << 
AT91SAM9263_ID_UHP
,

168 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

171 
˛k
 *
	g≥rùh_˛ocks
[] 
	g__öôd©a
 = {

172 &
pioA_˛k
,

173 &
pioB_˛k
,

174 &
pioCDE_˛k
,

175 &
ußπ0_˛k
,

176 &
ußπ1_˛k
,

177 &
ußπ2_˛k
,

178 &
mmc0_˛k
,

179 &
mmc1_˛k
,

180 &
ˇn_˛k
,

181 &
twi_˛k
,

182 &
•i0_˛k
,

183 &
•i1_˛k
,

184 &
ssc0_˛k
,

185 &
ssc1_˛k
,

186 &
ac97_˛k
,

187 &
tcb_˛k
,

188 &
pwmc_˛k
,

189 &
macb_˛k
,

190 &
twodge_˛k
,

191 &
udc_˛k
,

192 &
isi_˛k
,

193 &
lcdc_˛k
,

194 &
dma_˛k
,

195 &
ohci_˛k
,

203 
˛k
 
	gpck0
 = {

204 .
«me
 = "pck0",

205 .
	gpmc_mask
 = 
AT91_PMC_PCK0
,

206 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

207 .
	gid
 = 0,

209 
˛k
 
	gpck1
 = {

210 .
«me
 = "pck1",

211 .
	gpmc_mask
 = 
AT91_PMC_PCK1
,

212 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

213 .
	gid
 = 1,

215 
˛k
 
	gpck2
 = {

216 .
«me
 = "pck2",

217 .
	gpmc_mask
 = 
AT91_PMC_PCK2
,

218 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

219 .
	gid
 = 2,

221 
˛k
 
	gpck3
 = {

222 .
«me
 = "pck3",

223 .
	gpmc_mask
 = 
AT91_PMC_PCK3
,

224 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

225 .
	gid
 = 3,

228 
__öô
 
	$©91ßm9263_ªgi°î_˛ocks
()

230 
i
;

232 
i
 = 0; i < 
	`ARRAY_SIZE
(
≥rùh_˛ocks
); i++)

233 
	`˛k_ªgi°î
(
≥rùh_˛ocks
[
i
]);

235 
	`˛k_ªgi°î
(&
pck0
);

236 
	`˛k_ªgi°î
(&
pck1
);

237 
	`˛k_ªgi°î
(&
pck2
);

238 
	`˛k_ªgi°î
(&
pck3
);

239 
	}
}

245 
©91_gpio_b™k
 
	g©91ßm9263_gpio
[] = {

247 .
id
 = 
AT91SAM9263_ID_PIOA
,

248 .
	goff£t
 = 
AT91_PIOA
,

249 .
	g˛ock
 = &
pioA_˛k
,

251 .
	gid
 = 
AT91SAM9263_ID_PIOB
,

252 .
	goff£t
 = 
AT91_PIOB
,

253 .
	g˛ock
 = &
pioB_˛k
,

255 .
	gid
 = 
AT91SAM9263_ID_PIOCDE
,

256 .
	goff£t
 = 
AT91_PIOC
,

257 .
	g˛ock
 = &
pioCDE_˛k
,

259 .
	gid
 = 
AT91SAM9263_ID_PIOCDE
,

260 .
	goff£t
 = 
AT91_PIOD
,

261 .
	g˛ock
 = &
pioCDE_˛k
,

263 .
	gid
 = 
AT91SAM9263_ID_PIOCDE
,

264 .
	goff£t
 = 
AT91_PIOE
,

265 .
	g˛ock
 = &
pioCDE_˛k
,

269 
	$©91ßm9263_ª£t
()

271 
	`©91_sys_wrôe
(
AT91_RSTC_CR
, 
AT91_RSTC_KEY
 | 
AT91_RSTC_PROCRST
 | 
AT91_RSTC_PERRST
);

272 
	}
}

279 
__öô
 
	$©91ßm9263_öôülize
(
maö_˛ock
)

282 
	`iŸabÀ_öô
(
©91ßm9263_io_desc
, 
	`ARRAY_SIZE
(at91sam9263_io_desc));

284 
©91_¨ch_ª£t
 = 
©91ßm9263_ª£t
;

285 
©91_exã∫_úq
 = (1 << 
AT91SAM9263_ID_IRQ0
Ë| (1 << 
AT91SAM9263_ID_IRQ1
);

288 
	`©91_˛ock_öô
(
maö_˛ock
);

291 
	`©91ßm9263_ªgi°î_˛ocks
();

294 
	`©91_gpio_öô
(
©91ßm9263_gpio
, 5);

295 
	}
}

304 
	g©91ßm9263_deÁu…_úq_¥i‹ôy
[
NR_AIC_IRQS
] 
	g__öôd©a
 = {

339 
__öô
 
	$©91ßm9263_öô_öãºu±s
(
¥i‹ôy
[
NR_AIC_IRQS
])

341 i‡(!
¥i‹ôy
)

342 
¥i‹ôy
 = 
©91ßm9263_deÁu…_úq_¥i‹ôy
;

345 
	`©91_aic_öô
(
¥i‹ôy
);

348 
	`©91_gpio_úq_£tup
();

349 
	}
}

	@arch/arm/mach-at91/at91sam9263_devices.c

12 
	~<asm/mach/¨ch.h
>

13 
	~<asm/mach/m≠.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<asm/¨ch/bﬂrd.h
>

18 
	~<asm/¨ch/gpio.h
>

19 
	~<asm/¨ch/©91ßm9263.h
>

20 
	~<asm/¨ch/©91ßm926x_mc.h
>

21 
	~<asm/¨ch/©91ßm9263_m©rix.h
>

23 
	~"gíîic.h
"

30 #i‡
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

31 
u64
 
	gohci_dmamask
 = 0xffffffffUL;

32 
©91_usbh_d©a
 
	gusbh_d©a
;

34 
ªsour˚
 
	gusbh_ªsour˚s
[] = {

36 .
°¨t
 = 
AT91SAM9263_UHP_BASE
,

37 .
	gíd
 = 
AT91SAM9263_UHP_BASE
 + 
SZ_1M
 - 1,

38 .
	gÊags
 = 
IORESOURCE_MEM
,

41 .
°¨t
 = 
AT91SAM9263_ID_UHP
,

42 .
	gíd
 = 
AT91SAM9263_ID_UHP
,

43 .
	gÊags
 = 
IORESOURCE_IRQ
,

47 
∂©f‹m_devi˚
 
	g©91_usbh_devi˚
 = {

48 .
«me
 = "at91_ohci",

49 .
	gid
 = -1,

50 .
	gdev
 = {

51 .
dma_mask
 = &
ohci_dmamask
,

52 .
	gcohîít_dma_mask
 = 0xffffffff,

53 .
	g∂©f‹m_d©a
 = &
usbh_d©a
,

55 .
	gªsour˚
 = 
usbh_ªsour˚s
,

56 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
usbh_ªsour˚s
),

59 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
)

61 
i
;

63 i‡(!
d©a
)

67 
i
 = 0; i < 
d©a
->
p‹ts
; i++) {

68 i‡(
d©a
->
vbus_pö
[
i
])

69 
	`©91_£t_gpio_ouçut
(
d©a
->
vbus_pö
[
i
], 0);

72 
usbh_d©a
 = *
d©a
;

73 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_usbh_devi˚
);

74 
	}
}

76 
__öô
 
	$©91_add_devi˚_usbh
(
©91_usbh_d©a
 *
d©a
Ë{
	}
}

84 #ifde‡
CONFIG_USB_GADGET_AT91


85 
©91_udc_d©a
 
	gudc_d©a
;

87 
ªsour˚
 
	gudc_ªsour˚s
[] = {

89 .
°¨t
 = 
AT91SAM9263_BASE_UDP
,

90 .
	gíd
 = 
AT91SAM9263_BASE_UDP
 + 
SZ_16K
 - 1,

91 .
	gÊags
 = 
IORESOURCE_MEM
,

94 .
°¨t
 = 
AT91SAM9263_ID_UDP
,

95 .
	gíd
 = 
AT91SAM9263_ID_UDP
,

96 .
	gÊags
 = 
IORESOURCE_IRQ
,

100 
∂©f‹m_devi˚
 
	g©91_udc_devi˚
 = {

101 .
«me
 = "at91_udc",

102 .
	gid
 = -1,

103 .
	gdev
 = {

104 .
∂©f‹m_d©a
 = &
udc_d©a
,

106 .
	gªsour˚
 = 
udc_ªsour˚s
,

107 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
udc_ªsour˚s
),

110 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
)

112 i‡(!
d©a
)

115 i‡(
d©a
->
vbus_pö
) {

116 
	`©91_£t_gpio_öput
(
d©a
->
vbus_pö
, 0);

117 
	`©91_£t_deglôch
(
d©a
->
vbus_pö
, 1);

122 
udc_d©a
 = *
d©a
;

123 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_udc_devi˚
);

124 
	}
}

126 
__öô
 
	$©91_add_devi˚_udc
(
©91_udc_d©a
 *
d©a
Ë{
	}
}

134 #i‡
deföed
(
CONFIG_MACB
Ë|| deföed(
CONFIG_MACB_MODULE
)

135 
u64
 
	gëh_dmamask
 = 0xffffffffUL;

136 
©91_ëh_d©a
 
	gëh_d©a
;

138 
ªsour˚
 
	gëh_ªsour˚s
[] = {

140 .
°¨t
 = 
AT91SAM9263_BASE_EMAC
,

141 .
	gíd
 = 
AT91SAM9263_BASE_EMAC
 + 
SZ_16K
 - 1,

142 .
	gÊags
 = 
IORESOURCE_MEM
,

145 .
°¨t
 = 
AT91SAM9263_ID_EMAC
,

146 .
	gíd
 = 
AT91SAM9263_ID_EMAC
,

147 .
	gÊags
 = 
IORESOURCE_IRQ
,

151 
∂©f‹m_devi˚
 
	g©91ßm9263_ëh_devi˚
 = {

152 .
«me
 = "macb",

153 .
	gid
 = -1,

154 .
	gdev
 = {

155 .
dma_mask
 = &
ëh_dmamask
,

156 .
	gcohîít_dma_mask
 = 0xffffffff,

157 .
	g∂©f‹m_d©a
 = &
ëh_d©a
,

159 .
	gªsour˚
 = 
ëh_ªsour˚s
,

160 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ëh_ªsour˚s
),

163 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
)

165 i‡(!
d©a
)

168 i‡(
d©a
->
phy_úq_pö
) {

169 
	`©91_£t_gpio_öput
(
d©a
->
phy_úq_pö
, 0);

170 
	`©91_£t_deglôch
(
d©a
->
phy_úq_pö
, 1);

174 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE21
, 0);

175 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC25
, 0);

176 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE25
, 0);

177 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE26
, 0);

178 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE27
, 0);

179 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE28
, 0);

180 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE23
, 0);

181 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE24
, 0);

182 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE30
, 0);

183 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE29
, 0);

185 i‡(!
d©a
->
is_rmii
) {

186 
	`©91_£t_A_≥rùh
(
AT91_PIN_PE22
, 0);

187 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC26
, 0);

188 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC22
, 0);

189 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC23
, 0);

190 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC27
, 0);

191 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC20
, 0);

192 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC21
, 0);

193 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC24
, 0);

196 
ëh_d©a
 = *
d©a
;

197 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_ëh_devi˚
);

198 
	}
}

200 
__öô
 
	$©91_add_devi˚_ëh
(
©91_ëh_d©a
 *
d©a
Ë{
	}
}

208 #i‡
deföed
(
CONFIG_MMC_AT91
Ë|| deföed(
CONFIG_MMC_AT91_MODULE
)

209 
u64
 
	gmmc_dmamask
 = 0xffffffffUL;

210 
©91_mmc_d©a
 
	gmmc0_d©a
, 
	gmmc1_d©a
;

212 
ªsour˚
 
	gmmc0_ªsour˚s
[] = {

214 .
°¨t
 = 
AT91SAM9263_BASE_MCI0
,

215 .
	gíd
 = 
AT91SAM9263_BASE_MCI0
 + 
SZ_16K
 - 1,

216 .
	gÊags
 = 
IORESOURCE_MEM
,

219 .
°¨t
 = 
AT91SAM9263_ID_MCI0
,

220 .
	gíd
 = 
AT91SAM9263_ID_MCI0
,

221 .
	gÊags
 = 
IORESOURCE_IRQ
,

225 
∂©f‹m_devi˚
 
	g©91ßm9263_mmc0_devi˚
 = {

226 .
«me
 = "at91_mci",

227 .
	gid
 = 0,

228 .
	gdev
 = {

229 .
dma_mask
 = &
mmc_dmamask
,

230 .
	gcohîít_dma_mask
 = 0xffffffff,

231 .
	g∂©f‹m_d©a
 = &
mmc0_d©a
,

233 .
	gªsour˚
 = 
mmc0_ªsour˚s
,

234 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc0_ªsour˚s
),

237 
ªsour˚
 
	gmmc1_ªsour˚s
[] = {

239 .
°¨t
 = 
AT91SAM9263_BASE_MCI1
,

240 .
	gíd
 = 
AT91SAM9263_BASE_MCI1
 + 
SZ_16K
 - 1,

241 .
	gÊags
 = 
IORESOURCE_MEM
,

244 .
°¨t
 = 
AT91SAM9263_ID_MCI1
,

245 .
	gíd
 = 
AT91SAM9263_ID_MCI1
,

246 .
	gÊags
 = 
IORESOURCE_IRQ
,

250 
∂©f‹m_devi˚
 
	g©91ßm9263_mmc1_devi˚
 = {

251 .
«me
 = "at91_mci",

252 .
	gid
 = 1,

253 .
	gdev
 = {

254 .
dma_mask
 = &
mmc_dmamask
,

255 .
	gcohîít_dma_mask
 = 0xffffffff,

256 .
	g∂©f‹m_d©a
 = &
mmc1_d©a
,

258 .
	gªsour˚
 = 
mmc1_ªsour˚s
,

259 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc1_ªsour˚s
),

262 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
)

264 i‡(!
d©a
)

268 i‡(
d©a
->
dë_pö
) {

269 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

270 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

272 i‡(
d©a
->
wp_pö
)

273 
	`©91_£t_gpio_öput
(
d©a
->
wp_pö
, 1);

274 i‡(
d©a
->
vcc_pö
)

275 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

277 i‡(
mmc_id
 == 0) {

279 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA12
, 0);

281 i‡(
d©a
->
¶Ÿ_b
) {

283 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA16
, 1);

286 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA17
, 1);

287 i‡(
d©a
->
wúe4
) {

288 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA18
, 1);

289 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA19
, 1);

290 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA20
, 1);

294 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA1
, 1);

297 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA0
, 1);

298 i‡(
d©a
->
wúe4
) {

299 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA3
, 1);

300 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA4
, 1);

301 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA5
, 1);

305 
mmc0_d©a
 = *
d©a
;

306 
	`©91_˛ock_assocüã
("mci0_˛k", &
©91ßm9263_mmc1_devi˚
.
dev
, "mci_clk");

307 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_mmc0_devi˚
);

310 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA6
, 0);

312 i‡(
d©a
->
¶Ÿ_b
) {

314 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA21
, 1);

317 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA22
, 1);

318 i‡(
d©a
->
wúe4
) {

319 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA23
, 1);

320 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA24
, 1);

321 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA25
, 1);

325 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA7
, 1);

328 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA8
, 1);

329 i‡(
d©a
->
wúe4
) {

330 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA9
, 1);

331 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA10
, 1);

332 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA11
, 1);

336 
mmc1_d©a
 = *
d©a
;

337 
	`©91_˛ock_assocüã
("mci1_˛k", &
©91ßm9263_mmc1_devi˚
.
dev
, "mci_clk");

338 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_mmc1_devi˚
);

340 
	}
}

342 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
Ë{
	}
}

350 #i‡
deföed
(
CONFIG_MTD_NAND_AT91
Ë|| deföed(
CONFIG_MTD_NAND_AT91_MODULE
)

351 
©91_«nd_d©a
 
	g«nd_d©a
;

353 
	#NAND_BASE
 
AT91_CHIPSELECT_3


	)

355 
ªsour˚
 
	g«nd_ªsour˚s
[] = {

357 .
°¨t
 = 
NAND_BASE
,

358 .
	gíd
 = 
NAND_BASE
 + 
SZ_256M
 - 1,

359 .
	gÊags
 = 
IORESOURCE_MEM
,

363 
∂©f‹m_devi˚
 
	g©91ßm9263_«nd_devi˚
 = {

364 .
«me
 = "at91_nand",

365 .
	gid
 = -1,

366 .
	gdev
 = {

367 .
∂©f‹m_d©a
 = &
«nd_d©a
,

369 .
	gªsour˚
 = 
«nd_ªsour˚s
,

370 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«nd_ªsour˚s
),

373 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
)

375 
cß
, 
mode
;

377 i‡(!
d©a
)

380 
cß
 = 
	`©91_sys_ªad
(
AT91_MATRIX_EBI0CSA
);

381 
	`©91_sys_wrôe
(
AT91_MATRIX_EBI0CSA
, 
cß
 | 
AT91_MATRIX_EBI0_CS3A_SMC
);

384 
	`©91_sys_wrôe
(
	`AT91_SMC_SETUP
(3), 
	`AT91_SMC_NWESETUP_
(0Ë| 
	`AT91_SMC_NCS_WRSETUP_
(0)

385 | 
	`AT91_SMC_NRDSETUP_
(0Ë| 
	`AT91_SMC_NCS_RDSETUP_
(0));

387 
	`©91_sys_wrôe
(
	`AT91_SMC_PULSE
(3), 
	`AT91_SMC_NWEPULSE_
(3Ë| 
	`AT91_SMC_NCS_WRPULSE_
(3)

388 | 
	`AT91_SMC_NRDPULSE_
(3Ë| 
	`AT91_SMC_NCS_RDPULSE_
(3));

390 
	`©91_sys_wrôe
(
	`AT91_SMC_CYCLE
(3), 
	`AT91_SMC_NWECYCLE_
(5Ë| 
	`AT91_SMC_NRDCYCLE_
(5));

392 i‡(
d©a
->
bus_width_16
)

393 
mode
 = 
AT91_SMC_DBW_16
;

395 
mode
 = 
AT91_SMC_DBW_8
;

396 
	`©91_sys_wrôe
(
	`AT91_SMC_MODE
(3), 
mode
 | 
AT91_SMC_READMODE
 | 
AT91_SMC_WRITEMODE
 | 
AT91_SMC_EXNWMODE_DISABLE
 | 
	`AT91_SMC_TDF_
(2));

399 i‡(
d©a
->
íabÀ_pö
)

400 
	`©91_£t_gpio_ouçut
(
d©a
->
íabÀ_pö
, 1);

403 i‡(
d©a
->
rdy_pö
)

404 
	`©91_£t_gpio_öput
(
d©a
->
rdy_pö
, 1);

407 i‡(
d©a
->
dë_pö
)

408 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

410 
«nd_d©a
 = *
d©a
;

411 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_«nd_devi˚
);

412 
	}
}

414 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
Ë{
	}
}

422 #i‡
deföed
(
CONFIG_I2C_AT91
Ë|| deföed(
CONFIG_I2C_AT91_MODULE
)

424 
ªsour˚
 
	gtwi_ªsour˚s
[] = {

426 .
°¨t
 = 
AT91SAM9263_BASE_TWI
,

427 .
	gíd
 = 
AT91SAM9263_BASE_TWI
 + 
SZ_16K
 - 1,

428 .
	gÊags
 = 
IORESOURCE_MEM
,

431 .
°¨t
 = 
AT91SAM9263_ID_TWI
,

432 .
	gíd
 = 
AT91SAM9263_ID_TWI
,

433 .
	gÊags
 = 
IORESOURCE_IRQ
,

437 
∂©f‹m_devi˚
 
	g©91ßm9263_twi_devi˚
 = {

438 .
«me
 = "at91_i2c",

439 .
	gid
 = -1,

440 .
	gªsour˚
 = 
twi_ªsour˚s
,

441 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
twi_ªsour˚s
),

444 
__öô
 
	$©91_add_devi˚_i2c
()

447 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB4
, 0);

448 
	`©91_£t_mu…i_drive
(
AT91_PIN_PB4
, 1);

450 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB5
, 0);

451 
	`©91_£t_mu…i_drive
(
AT91_PIN_PB5
, 1);

453 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_twi_devi˚
);

454 
	}
}

456 
__öô
 
	$©91_add_devi˚_i2c
(Ë{
	}
}

464 #i‡
deföed
(
CONFIG_SPI_ATMEL
Ë|| deföed(
CONFIG_SPI_ATMEL_MODULE
)

465 
u64
 
	g•i_dmamask
 = 0xffffffffUL;

467 
ªsour˚
 
	g•i0_ªsour˚s
[] = {

469 .
°¨t
 = 
AT91SAM9263_BASE_SPI0
,

470 .
	gíd
 = 
AT91SAM9263_BASE_SPI0
 + 
SZ_16K
 - 1,

471 .
	gÊags
 = 
IORESOURCE_MEM
,

474 .
°¨t
 = 
AT91SAM9263_ID_SPI0
,

475 .
	gíd
 = 
AT91SAM9263_ID_SPI0
,

476 .
	gÊags
 = 
IORESOURCE_IRQ
,

480 
∂©f‹m_devi˚
 
	g©91ßm9263_•i0_devi˚
 = {

481 .
«me
 = "atmel_spi",

482 .
	gid
 = 0,

483 .
	gdev
 = {

484 .
dma_mask
 = &
•i_dmamask
,

485 .
	gcohîít_dma_mask
 = 0xffffffff,

487 .
	gªsour˚
 = 
•i0_ªsour˚s
,

488 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i0_ªsour˚s
),

491 c⁄° 
	g•i0_°™d¨d_cs
[4] = { 
AT91_PIN_PA5
, 
AT91_PIN_PA3
, 
AT91_PIN_PA4
, 
AT91_PIN_PB11
 };

493 
ªsour˚
 
	g•i1_ªsour˚s
[] = {

495 .
°¨t
 = 
AT91SAM9263_BASE_SPI1
,

496 .
	gíd
 = 
AT91SAM9263_BASE_SPI1
 + 
SZ_16K
 - 1,

497 .
	gÊags
 = 
IORESOURCE_MEM
,

500 .
°¨t
 = 
AT91SAM9263_ID_SPI1
,

501 .
	gíd
 = 
AT91SAM9263_ID_SPI1
,

502 .
	gÊags
 = 
IORESOURCE_IRQ
,

506 
∂©f‹m_devi˚
 
	g©91ßm9263_•i1_devi˚
 = {

507 .
«me
 = "atmel_spi",

508 .
	gid
 = 1,

509 .
	gdev
 = {

510 .
dma_mask
 = &
•i_dmamask
,

511 .
	gcohîít_dma_mask
 = 0xffffffff,

513 .
	gªsour˚
 = 
•i1_ªsour˚s
,

514 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i1_ªsour˚s
),

517 c⁄° 
	g•i1_°™d¨d_cs
[4] = { 
AT91_PIN_PB15
, 
AT91_PIN_PB16
, 
AT91_PIN_PB17
, 
AT91_PIN_PB18
 };

519 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
)

521 
i
;

522 
cs_pö
;

523 
íabÀ_•i0
 = 0;

524 
íabÀ_•i1
 = 0;

527 
i
 = 0; i < 
ƒ_devi˚s
; i++) {

528 i‡(
devi˚s
[
i
].
c⁄åﬁÀr_d©a
)

529 
cs_pö
 = (Ë
devi˚s
[
i
].
c⁄åﬁÀr_d©a
;

530 i‡(
devi˚s
[
i
].
bus_num
 == 0)

531 
cs_pö
 = 
•i0_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

533 
cs_pö
 = 
•i1_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

535 i‡(
devi˚s
[
i
].
bus_num
 == 0)

536 
íabÀ_•i0
 = 1;

538 
íabÀ_•i1
 = 1;

541 
	`©91_£t_gpio_ouçut
(
cs_pö
, 1);

544 
devi˚s
[
i
].
c⁄åﬁÀr_d©a
 = (*Ë
cs_pö
;

547 
	`•i_ªgi°î_bﬂrd_öfo
(
devi˚s
, 
ƒ_devi˚s
);

550 i‡(
íabÀ_•i0
) {

551 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA0
, 0);

552 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA1
, 0);

553 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA2
, 0);

555 
	`©91_˛ock_assocüã
("•i0_˛k", &
©91ßm9263_•i0_devi˚
.
dev
, "spi_clk");

556 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_•i0_devi˚
);

558 i‡(
íabÀ_•i1
) {

559 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB12
, 0);

560 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB13
, 0);

561 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB14
, 0);

563 
	`©91_˛ock_assocüã
("•i1_˛k", &
©91ßm9263_•i1_devi˚
.
dev
, "spi_clk");

564 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_•i1_devi˚
);

566 
	}
}

568 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
Ë{
	}
}

576 #i‡
deföed
(
CONFIG_SND_AT91_AC97
Ë|| deföed(
CONFIG_SND_AT91_AC97_MODULE
)

577 
u64
 
	gac97_dmamask
 = 0xffffffffUL;

578 
©mñ_ac97_d©a
 
	gac97_d©a
;

580 
ªsour˚
 
	gac97_ªsour˚s
[] = {

582 .
°¨t
 = 
AT91SAM9263_BASE_AC97C
,

583 .
	gíd
 = 
AT91SAM9263_BASE_AC97C
 + 
SZ_16K
 - 1,

584 .
	gÊags
 = 
IORESOURCE_MEM
,

587 .
°¨t
 = 
AT91SAM9263_ID_AC97C
,

588 .
	gíd
 = 
AT91SAM9263_ID_AC97C
,

589 .
	gÊags
 = 
IORESOURCE_IRQ
,

593 
∂©f‹m_devi˚
 
	g©91ßm9263_ac97_devi˚
 = {

594 .
«me
 = "ac97c",

595 .
	gid
 = 1,

596 .
	gdev
 = {

597 .
dma_mask
 = &
ac97_dmamask
,

598 .
	gcohîít_dma_mask
 = 0xffffffff,

599 .
	g∂©f‹m_d©a
 = &
ac97_d©a
,

601 .
	gªsour˚
 = 
ac97_ªsour˚s
,

602 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ac97_ªsour˚s
),

605 
__öô
 
	$©91_add_devi˚_ac97
(
©mñ_ac97_d©a
 *
d©a
)

607 i‡(!
d©a
)

610 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB0
, 0);

611 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB1
, 0);

612 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB2
, 0);

613 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB3
, 0);

616 i‡(
d©a
->
ª£t_pö
)

617 
	`©91_£t_gpio_ouçut
(
d©a
->
ª£t_pö
, 0);

619 
ac97_d©a
 = *
ek_d©a
;

620 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9263_ac97_devi˚
);

621 
	}
}

623 
__öô
 
	$©91_add_devi˚_ac97
(
©mñ_ac97_d©a
 *
d©a
Ë{
	}
}

631 #i‡
deföed
(
CONFIG_FB_ATMEL
Ë|| deföed(
CONFIG_FB_ATMEL_MODULE
)

632 
u64
 
	glcdc_dmamask
 = 0xffffffffUL;

633 
©mñ_lcdfb_öfo
 
	glcdc_d©a
;

635 
ªsour˚
 
	glcdc_ªsour˚s
[] = {

637 .
°¨t
 = 
AT91SAM9263_LCDC_BASE
,

638 .
	gíd
 = 
AT91SAM9263_LCDC_BASE
 + 
SZ_4K
 - 1,

639 .
	gÊags
 = 
IORESOURCE_MEM
,

642 .
°¨t
 = 
AT91SAM9263_ID_LCDC
,

643 .
	gíd
 = 
AT91SAM9263_ID_LCDC
,

644 .
	gÊags
 = 
IORESOURCE_IRQ
,

648 
∂©f‹m_devi˚
 
	g©91_lcdc_devi˚
 = {

649 .
«me
 = "atmel_lcdfb",

650 .
	gid
 = 0,

651 .
	gdev
 = {

652 .
dma_mask
 = &
lcdc_dmamask
,

653 .
	gcohîít_dma_mask
 = 0xffffffff,

654 .
	g∂©f‹m_d©a
 = &
lcdc_d©a
,

656 .
	gªsour˚
 = 
lcdc_ªsour˚s
,

657 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
lcdc_ªsour˚s
),

660 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
)

662 i‡(!
d©a
)

665 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC1
, 0);

666 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC2
, 0);

667 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC3
, 0);

668 
	`©91_£t_B_≥rùh
(
AT91_PIN_PB9
, 0);

669 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC6
, 0);

670 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC7
, 0);

671 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC8
, 0);

672 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC9
, 0);

673 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC10
, 0);

674 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC11
, 0);

675 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC14
, 0);

676 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC15
, 0);

677 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC16
, 0);

678 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC12
, 0);

679 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC18
, 0);

680 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC19
, 0);

681 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC22
, 0);

682 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC23
, 0);

683 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC24
, 0);

684 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC17
, 0);

685 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC26
, 0);

686 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC27
, 0);

688 
lcdc_d©a
 = *
d©a
;

689 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_lcdc_devi˚
);

690 
	}
}

692 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
Ë{
	}
}

700 #i‡
deföed
(
CONFIG_LEDS
)

701 
u8
 
	g©91_Àds_˝u
;

702 
u8
 
	g©91_Àds_timî
;

704 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
)

707 
	`©91_£t_gpio_ouçut
(
˝u_Àd
, 1);

708 
	`©91_£t_gpio_ouçut
(
timî_Àd
, 1);

710 
©91_Àds_˝u
 = 
˝u_Àd
;

711 
©91_Àds_timî
 = 
timî_Àd
;

712 
	}
}

714 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
Ë{
	}
}

722 #i‡
deföed
(
CONFIG_SERIAL_ATMEL
)

724 
ªsour˚
 
	gdbgu_ªsour˚s
[] = {

726 .
°¨t
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
,

727 .
	gíd
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
 + 
SZ_512
 - 1,

728 .
	gÊags
 = 
IORESOURCE_MEM
,

731 .
°¨t
 = 
AT91_ID_SYS
,

732 .
	gíd
 = 
AT91_ID_SYS
,

733 .
	gÊags
 = 
IORESOURCE_IRQ
,

737 
©mñ_u¨t_d©a
 
	gdbgu_d©a
 = {

738 .
u£_dma_tx
 = 0,

739 .
	gu£_dma_rx
 = 0,

740 .
	gªgs
 = (
__iomem
 *)(
AT91_VA_BASE_SYS
 + 
AT91_DBGU
),

743 
∂©f‹m_devi˚
 
	g©91ßm9263_dbgu_devi˚
 = {

744 .
«me
 = "atmel_usart",

745 .
	gid
 = 0,

746 .
	gdev
 = {

747 .
∂©f‹m_d©a
 = &
dbgu_d©a
,

748 .
	gcohîít_dma_mask
 = 0xffffffff,

750 .
	gªsour˚
 = 
dbgu_ªsour˚s
,

751 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dbgu_ªsour˚s
),

754 
ölöe
 
	$c⁄figuª_dbgu_pös
()

756 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC30
, 0);

757 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC31
, 1);

758 
	}
}

760 
ªsour˚
 
	gu¨t0_ªsour˚s
[] = {

762 .
°¨t
 = 
AT91SAM9263_BASE_US0
,

763 .
	gíd
 = 
AT91SAM9263_BASE_US0
 + 
SZ_16K
 - 1,

764 .
	gÊags
 = 
IORESOURCE_MEM
,

767 .
°¨t
 = 
AT91SAM9263_ID_US0
,

768 .
	gíd
 = 
AT91SAM9263_ID_US0
,

769 .
	gÊags
 = 
IORESOURCE_IRQ
,

773 
©mñ_u¨t_d©a
 
	gu¨t0_d©a
 = {

774 .
u£_dma_tx
 = 1,

775 .
	gu£_dma_rx
 = 1,

778 
∂©f‹m_devi˚
 
	g©91ßm9263_u¨t0_devi˚
 = {

779 .
«me
 = "atmel_usart",

780 .
	gid
 = 1,

781 .
	gdev
 = {

782 .
∂©f‹m_d©a
 = &
u¨t0_d©a
,

783 .
	gcohîít_dma_mask
 = 0xffffffff,

785 .
	gªsour˚
 = 
u¨t0_ªsour˚s
,

786 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t0_ªsour˚s
),

789 
ölöe
 
	$c⁄figuª_ußπ0_pös
()

791 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA26
, 1);

792 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA27
, 0);

793 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA28
, 0);

794 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA29
, 0);

795 
	}
}

797 
ªsour˚
 
	gu¨t1_ªsour˚s
[] = {

799 .
°¨t
 = 
AT91SAM9263_BASE_US1
,

800 .
	gíd
 = 
AT91SAM9263_BASE_US1
 + 
SZ_16K
 - 1,

801 .
	gÊags
 = 
IORESOURCE_MEM
,

804 .
°¨t
 = 
AT91SAM9263_ID_US1
,

805 .
	gíd
 = 
AT91SAM9263_ID_US1
,

806 .
	gÊags
 = 
IORESOURCE_IRQ
,

810 
©mñ_u¨t_d©a
 
	gu¨t1_d©a
 = {

811 .
u£_dma_tx
 = 1,

812 .
	gu£_dma_rx
 = 1,

815 
∂©f‹m_devi˚
 
	g©91ßm9263_u¨t1_devi˚
 = {

816 .
«me
 = "atmel_usart",

817 .
	gid
 = 2,

818 .
	gdev
 = {

819 .
∂©f‹m_d©a
 = &
u¨t1_d©a
,

820 .
	gcohîít_dma_mask
 = 0xffffffff,

822 .
	gªsour˚
 = 
u¨t1_ªsour˚s
,

823 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t1_ªsour˚s
),

826 
ölöe
 
	$c⁄figuª_ußπ1_pös
()

828 
	`©91_£t_A_≥rùh
(
AT91_PIN_PD0
, 1);

829 
	`©91_£t_A_≥rùh
(
AT91_PIN_PD1
, 0);

830 
	`©91_£t_B_≥rùh
(
AT91_PIN_PD7
, 0);

831 
	`©91_£t_B_≥rùh
(
AT91_PIN_PD8
, 0);

832 
	}
}

834 
ªsour˚
 
	gu¨t2_ªsour˚s
[] = {

836 .
°¨t
 = 
AT91SAM9263_BASE_US2
,

837 .
	gíd
 = 
AT91SAM9263_BASE_US2
 + 
SZ_16K
 - 1,

838 .
	gÊags
 = 
IORESOURCE_MEM
,

841 .
°¨t
 = 
AT91SAM9263_ID_US2
,

842 .
	gíd
 = 
AT91SAM9263_ID_US2
,

843 .
	gÊags
 = 
IORESOURCE_IRQ
,

847 
©mñ_u¨t_d©a
 
	gu¨t2_d©a
 = {

848 .
u£_dma_tx
 = 1,

849 .
	gu£_dma_rx
 = 1,

852 
∂©f‹m_devi˚
 
	g©91ßm9263_u¨t2_devi˚
 = {

853 .
«me
 = "atmel_usart",

854 .
	gid
 = 3,

855 .
	gdev
 = {

856 .
∂©f‹m_d©a
 = &
u¨t2_d©a
,

857 .
	gcohîít_dma_mask
 = 0xffffffff,

859 .
	gªsour˚
 = 
u¨t2_ªsour˚s
,

860 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t2_ªsour˚s
),

863 
ölöe
 
	$c⁄figuª_ußπ2_pös
()

865 
	`©91_£t_A_≥rùh
(
AT91_PIN_PD2
, 1);

866 
	`©91_£t_A_≥rùh
(
AT91_PIN_PD3
, 0);

867 
	`©91_£t_B_≥rùh
(
AT91_PIN_PD5
, 0);

868 
	`©91_£t_B_≥rùh
(
AT91_PIN_PD6
, 0);

869 
	}
}

871 
∂©f‹m_devi˚
 *
	g©91_u¨ts
[
ATMEL_MAX_UART
];

872 
∂©f‹m_devi˚
 *
	g©mñ_deÁu…_c⁄sﬁe_devi˚
;

874 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
)

876 
i
;

879 
i
 = 0; i < 
c⁄fig
->
ƒ_ây
; i++) {

880 
c⁄fig
->
ây_m≠
[
i
]) {

882 
	`c⁄figuª_ußπ0_pös
();

883 
©91_u¨ts
[
i
] = &
©91ßm9263_u¨t0_devi˚
;

884 
	`©91_˛ock_assocüã
("ußπ0_˛k", &
©91ßm9263_u¨t0_devi˚
.
dev
, "usart");

887 
	`c⁄figuª_ußπ1_pös
();

888 
©91_u¨ts
[
i
] = &
©91ßm9263_u¨t1_devi˚
;

889 
	`©91_˛ock_assocüã
("ußπ1_˛k", &
©91ßm9263_u¨t1_devi˚
.
dev
, "usart");

892 
	`c⁄figuª_ußπ2_pös
();

893 
©91_u¨ts
[
i
] = &
©91ßm9263_u¨t2_devi˚
;

894 
	`©91_˛ock_assocüã
("ußπ2_˛k", &
©91ßm9263_u¨t2_devi˚
.
dev
, "usart");

897 
	`c⁄figuª_dbgu_pös
();

898 
©91_u¨ts
[
i
] = &
©91ßm9263_dbgu_devi˚
;

899 
	`©91_˛ock_assocüã
("mck", &
©91ßm9263_dbgu_devi˚
.
dev
, "usart");

904 
©91_u¨ts
[
i
]->
id
 = i;

908 i‡(
c⁄fig
->
c⁄sﬁe_ây
 < 
ATMEL_MAX_UART
)

909 
©mñ_deÁu…_c⁄sﬁe_devi˚
 = 
©91_u¨ts
[
c⁄fig
->
c⁄sﬁe_ây
];

910 i‡(!
©mñ_deÁu…_c⁄sﬁe_devi˚
)

911 
	`¥ötk
(
KERN_INFO
 "AT91: No default serial console defined.\n");

912 
	}
}

914 
__öô
 
	$©91_add_devi˚_£rül
()

916 
i
;

918 
i
 = 0; i < 
ATMEL_MAX_UART
; i++) {

919 i‡(
©91_u¨ts
[
i
])

920 
	`∂©f‹m_devi˚_ªgi°î
(
©91_u¨ts
[
i
]);

922 
	}
}

924 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
Ë{
	}
}

925 
__öô
 
	$©91_add_devi˚_£rül
(Ë{
	}
}

934 
__öô
 
	$©91_add_°™d¨d_devi˚s
()

937 
	}
}

939 
¨ch_öôˇŒ
(
©91_add_°™d¨d_devi˚s
);

	@arch/arm/mach-at91/at91sam926x_time.c

12 
	~<löux/öô.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/úq.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/time.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/io.h
>

21 
	~<asm/mach/time.h
>

23 
	~<asm/¨ch/©91_pô.h
>

26 
	#PIT_CPIV
(
x
Ë((xË& 
AT91_PIT_CPIV
)

	)

27 
	#PIT_PICNT
(
x
Ë(((xË& 
AT91_PIT_PICNT
Ë>> 20)

	)

34 
	$©91ßm926x_gëtimeoff£t
()

36 
ñ≠£d
;

37 
t
 = 
	`©91_sys_ªad
(
AT91_PIT_PIIR
);

39 
ñ≠£d
 = (
	`PIT_PICNT
(
t
Ë* 
LATCH
Ë+ 
	`PIT_CPIV
(t);

41  ()(
ñ≠£d
 * 
	`jiffõs_to_u£cs
(1)Ë/ 
LATCH
;

42 
	}
}

47 
úqªtu∫_t
 
	$©91ßm926x_timî_öãºu±
(
úq
, *
dev_id
)

49 vﬁ©ûê
ƒ_ticks
;

51 i‡(
	`©91_sys_ªad
(
AT91_PIT_SR
Ë& 
AT91_PIT_PITS
) {

52 
	`wrôe_£qlock
(&
xtime_lock
);

55 
ƒ_ticks
 = 
	`PIT_PICNT
(
	`©91_sys_ªad
(
AT91_PIT_PIVR
));

57 
	`timî_tick
();

58 
ƒ_ticks
--;

59 } 
ƒ_ticks
);

61 
	`wrôe_£qu∆ock
(&
xtime_lock
);

62  
IRQ_HANDLED
;

64  
IRQ_NONE
;

65 
	}
}

67 
úqa˘i⁄
 
	g©91ßm926x_timî_úq
 = {

68 .
«me
 = "at91_tick",

69 .
	gÊags
 = 
IRQF_SHARED
 | 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

70 .
	gh™dÀr
 = 
©91ßm926x_timî_öãºu±


73 
	$©91ßm926x_timî_ª£t
()

76 
	`©91_sys_wrôe
(
AT91_PIT_MR
, 0);

79 (Ë
	`©91_sys_ªad
(
AT91_PIT_PIVR
);

82 
	`©91_sys_wrôe
(
AT91_PIT_MR
, (
LATCH
 & 
AT91_PIT_PIV
Ë| 
AT91_PIT_PITIEN
 | 
AT91_PIT_PITEN
);

83 
	}
}

88 
__öô
 
	$©91ßm926x_timî_öô
()

91 
	`©91ßm926x_timî_ª£t
();

94 
	`£tup_úq
(
AT91_ID_SYS
, &
©91ßm926x_timî_úq
);

95 
	}
}

97 #ifde‡
CONFIG_PM


98 
	$©91ßm926x_timî_su•íd
()

101 
	`©91_sys_wrôe
(
AT91_PIT_MR
, 0);

102 
	}
}

104 
	#©91ßm926x_timî_su•íd
 
NULL


	)

107 
sys_timî
 
	g©91ßm926x_timî
 = {

108 .
öô
 = 
©91ßm926x_timî_öô
,

109 .
	goff£t
 = 
©91ßm926x_gëtimeoff£t
,

110 .
	gsu•íd
 = 
©91ßm926x_timî_su•íd
,

111 .
	gªsume
 = 
©91ßm926x_timî_ª£t
,

	@arch/arm/mach-at91/at91sam9rl.c

12 
	~<löux/moduÀ.h
>

14 
	~<asm/mach/¨ch.h
>

15 
	~<asm/mach/m≠.h
>

16 
	~<asm/¨ch/˝u.h
>

17 
	~<asm/¨ch/©91ßm9æ.h
>

18 
	~<asm/¨ch/©91_pmc.h
>

19 
	~<asm/¨ch/©91_r°c.h
>

21 
	~"gíîic.h
"

22 
	~"˛ock.h
"

24 
m≠_desc
 
	g©91ßm9æ_io_desc
[] 
	g__öôd©a
 = {

26 .
vútuÆ
 = 
AT91_VA_BASE_SYS
,

27 .
	gp‚
 = 
__phys_to_p‚
(
AT91_BASE_SYS
),

28 .
	gÀngth
 = 
SZ_16K
,

29 .
	gty≥
 = 
MT_DEVICE
,

33 
m≠_desc
 
	g©91ßm9æ_§am_desc
[] 
	g__öôd©a
 = {

35 .
p‚
 = 
__phys_to_p‚
(
AT91SAM9RL_SRAM_BASE
),

36 .
	gty≥
 = 
MT_DEVICE
,

47 
˛k
 
	gpioA_˛k
 = {

48 .
«me
 = "pioA_clk",

49 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_PIOA
,

50 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

52 
˛k
 
	gpioB_˛k
 = {

53 .
«me
 = "pioB_clk",

54 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_PIOB
,

55 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

57 
˛k
 
	gpioC_˛k
 = {

58 .
«me
 = "pioC_clk",

59 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_PIOC
,

60 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

62 
˛k
 
	gpioD_˛k
 = {

63 .
«me
 = "pioD_clk",

64 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_PIOD
,

65 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

67 
˛k
 
	gußπ0_˛k
 = {

68 .
«me
 = "usart0_clk",

69 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_US0
,

70 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

72 
˛k
 
	gußπ1_˛k
 = {

73 .
«me
 = "usart1_clk",

74 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_US1
,

75 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

77 
˛k
 
	gußπ2_˛k
 = {

78 .
«me
 = "usart2_clk",

79 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_US2
,

80 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

82 
˛k
 
	gußπ3_˛k
 = {

83 .
«me
 = "usart3_clk",

84 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_US3
,

85 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

87 
˛k
 
	gmmc_˛k
 = {

88 .
«me
 = "mci_clk",

89 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_MCI
,

90 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

92 
˛k
 
	gtwi0_˛k
 = {

93 .
«me
 = "twi0_clk",

94 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TWI0
,

95 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

97 
˛k
 
	gtwi1_˛k
 = {

98 .
«me
 = "twi1_clk",

99 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TWI1
,

100 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

102 
˛k
 
	g•i_˛k
 = {

103 .
«me
 = "spi_clk",

104 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_SPI
,

105 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

107 
˛k
 
	gssc0_˛k
 = {

108 .
«me
 = "ssc0_clk",

109 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_SSC0
,

110 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

112 
˛k
 
	gssc1_˛k
 = {

113 .
«me
 = "ssc1_clk",

114 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_SSC1
,

115 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

117 
˛k
 
	gtc0_˛k
 = {

118 .
«me
 = "tc0_clk",

119 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TC0
,

120 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

122 
˛k
 
	gtc1_˛k
 = {

123 .
«me
 = "tc1_clk",

124 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TC1
,

125 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

127 
˛k
 
	gtc2_˛k
 = {

128 .
«me
 = "tc2_clk",

129 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TC2
,

130 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

132 
˛k
 
	gpwmc_˛k
 = {

133 .
«me
 = "pwmc_clk",

134 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_PWMC
,

135 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

137 
˛k
 
	gtsc_˛k
 = {

138 .
«me
 = "tsc_clk",

139 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_TSC
,

140 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

142 
˛k
 
	gdma_˛k
 = {

143 .
«me
 = "dma_clk",

144 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_DMA
,

145 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

147 
˛k
 
	gudphs_˛k
 = {

148 .
«me
 = "udphs_clk",

149 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_UDPHS
,

150 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

152 
˛k
 
	glcdc_˛k
 = {

153 .
«me
 = "lcdc_clk",

154 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_LCDC
,

155 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

157 
˛k
 
	gac97_˛k
 = {

158 .
«me
 = "ac97_clk",

159 .
	gpmc_mask
 = 1 << 
AT91SAM9RL_ID_AC97C
,

160 .
	gty≥
 = 
CLK_TYPE_PERIPHERAL
,

163 
˛k
 *
	g≥rùh_˛ocks
[] 
	g__öôd©a
 = {

164 &
pioA_˛k
,

165 &
pioB_˛k
,

166 &
pioC_˛k
,

167 &
pioD_˛k
,

168 &
ußπ0_˛k
,

169 &
ußπ1_˛k
,

170 &
ußπ2_˛k
,

171 &
ußπ3_˛k
,

172 &
mmc_˛k
,

173 &
twi0_˛k
,

174 &
twi1_˛k
,

175 &
•i_˛k
,

176 &
ssc0_˛k
,

177 &
ssc1_˛k
,

178 &
tc0_˛k
,

179 &
tc1_˛k
,

180 &
tc2_˛k
,

181 &
pwmc_˛k
,

182 &
tsc_˛k
,

183 &
dma_˛k
,

184 &
udphs_˛k
,

185 &
lcdc_˛k
,

186 &
ac97_˛k
,

194 
˛k
 
	gpck0
 = {

195 .
«me
 = "pck0",

196 .
	gpmc_mask
 = 
AT91_PMC_PCK0
,

197 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

198 .
	gid
 = 0,

200 
˛k
 
	gpck1
 = {

201 .
«me
 = "pck1",

202 .
	gpmc_mask
 = 
AT91_PMC_PCK1
,

203 .
	gty≥
 = 
CLK_TYPE_PROGRAMMABLE
,

204 .
	gid
 = 1,

207 
__öô
 
	$©91ßm9æ_ªgi°î_˛ocks
()

209 
i
;

211 
i
 = 0; i < 
	`ARRAY_SIZE
(
≥rùh_˛ocks
); i++)

212 
	`˛k_ªgi°î
(
≥rùh_˛ocks
[
i
]);

214 
	`˛k_ªgi°î
(&
pck0
);

215 
	`˛k_ªgi°î
(&
pck1
);

216 
	}
}

222 
©91_gpio_b™k
 
	g©91ßm9æ_gpio
[] = {

224 .
id
 = 
AT91SAM9RL_ID_PIOA
,

225 .
	goff£t
 = 
AT91_PIOA
,

226 .
	g˛ock
 = &
pioA_˛k
,

228 .
	gid
 = 
AT91SAM9RL_ID_PIOB
,

229 .
	goff£t
 = 
AT91_PIOB
,

230 .
	g˛ock
 = &
pioB_˛k
,

232 .
	gid
 = 
AT91SAM9RL_ID_PIOC
,

233 .
	goff£t
 = 
AT91_PIOC
,

234 .
	g˛ock
 = &
pioC_˛k
,

236 .
	gid
 = 
AT91SAM9RL_ID_PIOD
,

237 .
	goff£t
 = 
AT91_PIOD
,

238 .
	g˛ock
 = &
pioD_˛k
,

242 
	$©91ßm9æ_ª£t
()

244 
	`©91_sys_wrôe
(
AT91_RSTC_CR
, 
AT91_RSTC_KEY
 | 
AT91_RSTC_PROCRST
 | 
AT91_RSTC_PERRST
);

245 
	}
}

252 
__öô
 
	$©91ßm9æ_öôülize
(
maö_˛ock
)

254 
cidr
, 
§am_size
;

257 
	`iŸabÀ_öô
(
©91ßm9æ_io_desc
, 
	`ARRAY_SIZE
(at91sam9rl_io_desc));

259 
cidr
 = 
	`©91_sys_ªad
(
AT91_DBGU_CIDR
);

261 
cidr
 & 
AT91_CIDR_SRAMSIZ
) {

262 
AT91_CIDR_SRAMSIZ_32K
:

263 
§am_size
 = 2 * 
SZ_16K
;

265 
AT91_CIDR_SRAMSIZ_16K
:

267 
§am_size
 = 
SZ_16K
;

270 
©91ßm9æ_§am_desc
->
vútuÆ
 = 
AT91_IO_VIRT_BASE
 - 
§am_size
;

271 
©91ßm9æ_§am_desc
->
Àngth
 = 
§am_size
;

274 
	`iŸabÀ_öô
(
©91ßm9æ_§am_desc
, 
	`ARRAY_SIZE
(at91sam9rl_sram_desc));

276 
©91_¨ch_ª£t
 = 
©91ßm9æ_ª£t
;

277 
©91_exã∫_úq
 = (1 << 
AT91SAM9RL_ID_IRQ0
);

280 
	`©91_˛ock_öô
(
maö_˛ock
);

283 
	`©91ßm9æ_ªgi°î_˛ocks
();

286 
	`©91_gpio_öô
(
©91ßm9æ_gpio
, 4);

287 
	}
}

296 
	g©91ßm9æ_deÁu…_úq_¥i‹ôy
[
NR_AIC_IRQS
] 
	g__öôd©a
 = {

331 
__öô
 
	$©91ßm9æ_öô_öãºu±s
(
¥i‹ôy
[
NR_AIC_IRQS
])

333 i‡(!
¥i‹ôy
)

334 
¥i‹ôy
 = 
©91ßm9æ_deÁu…_úq_¥i‹ôy
;

337 
	`©91_aic_öô
(
¥i‹ôy
);

340 
	`©91_gpio_úq_£tup
();

341 
	}
}

	@arch/arm/mach-at91/at91sam9rl_devices.c

9 
	~<asm/mach/¨ch.h
>

10 
	~<asm/mach/m≠.h
>

12 
	~<löux/∂©f‹m_devi˚.h
>

13 
	~<löux/fb.h
>

15 
	~<video/©mñ_lcdc.h
>

17 
	~<asm/¨ch/bﬂrd.h
>

18 
	~<asm/¨ch/gpio.h
>

19 
	~<asm/¨ch/©91ßm9æ.h
>

20 
	~<asm/¨ch/©91ßm9æ_m©rix.h
>

21 
	~<asm/¨ch/©91ßm926x_mc.h
>

23 
	~"gíîic.h
"

30 #i‡
deföed
(
CONFIG_MMC_AT91
Ë|| deföed(
CONFIG_MMC_AT91_MODULE
)

31 
u64
 
	gmmc_dmamask
 = 0xffffffffUL;

32 
©91_mmc_d©a
 
	gmmc_d©a
;

34 
ªsour˚
 
	gmmc_ªsour˚s
[] = {

36 .
°¨t
 = 
AT91SAM9RL_BASE_MCI
,

37 .
	gíd
 = 
AT91SAM9RL_BASE_MCI
 + 
SZ_16K
 - 1,

38 .
	gÊags
 = 
IORESOURCE_MEM
,

41 .
°¨t
 = 
AT91SAM9RL_ID_MCI
,

42 .
	gíd
 = 
AT91SAM9RL_ID_MCI
,

43 .
	gÊags
 = 
IORESOURCE_IRQ
,

47 
∂©f‹m_devi˚
 
	g©91ßm9æ_mmc_devi˚
 = {

48 .
«me
 = "at91_mci",

49 .
	gid
 = -1,

50 .
	gdev
 = {

51 .
dma_mask
 = &
mmc_dmamask
,

52 .
	gcohîít_dma_mask
 = 0xffffffff,

53 .
	g∂©f‹m_d©a
 = &
mmc_d©a
,

55 .
	gªsour˚
 = 
mmc_ªsour˚s
,

56 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mmc_ªsour˚s
),

59 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
)

61 i‡(!
d©a
)

65 i‡(
d©a
->
dë_pö
) {

66 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

67 
	`©91_£t_deglôch
(
d©a
->
dë_pö
, 1);

69 i‡(
d©a
->
wp_pö
)

70 
	`©91_£t_gpio_öput
(
d©a
->
wp_pö
, 1);

71 i‡(
d©a
->
vcc_pö
)

72 
	`©91_£t_gpio_ouçut
(
d©a
->
vcc_pö
, 0);

75 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA2
, 0);

78 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA1
, 1);

81 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA0
, 1);

82 i‡(
d©a
->
wúe4
) {

83 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA3
, 1);

84 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA4
, 1);

85 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA5
, 1);

88 
mmc_d©a
 = *
d©a
;

89 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9æ_mmc_devi˚
);

90 
	}
}

92 
__öô
 
	$©91_add_devi˚_mmc
(
mmc_id
, 
©91_mmc_d©a
 *
d©a
Ë{
	}
}

100 #i‡
deföed
(
CONFIG_MTD_NAND_AT91
Ë|| deföed(
CONFIG_MTD_NAND_AT91_MODULE
)

101 
©91_«nd_d©a
 
	g«nd_d©a
;

103 
	#NAND_BASE
 
AT91_CHIPSELECT_3


	)

105 
ªsour˚
 
	g«nd_ªsour˚s
[] = {

107 .
°¨t
 = 
NAND_BASE
,

108 .
	gíd
 = 
NAND_BASE
 + 
SZ_256M
 - 1,

109 .
	gÊags
 = 
IORESOURCE_MEM
,

113 
∂©f‹m_devi˚
 
	g©91_«nd_devi˚
 = {

114 .
«me
 = "at91_nand",

115 .
	gid
 = -1,

116 .
	gdev
 = {

117 .
∂©f‹m_d©a
 = &
«nd_d©a
,

119 .
	gªsour˚
 = 
«nd_ªsour˚s
,

120 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«nd_ªsour˚s
),

123 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
)

125 
cß
;

127 i‡(!
d©a
)

130 
cß
 = 
	`©91_sys_ªad
(
AT91_MATRIX_EBICSA
);

131 
	`©91_sys_wrôe
(
AT91_MATRIX_EBICSA
, 
cß
 | 
AT91_MATRIX_CS3A_SMC_SMARTMEDIA
);

134 
	`©91_sys_wrôe
(
	`AT91_SMC_SETUP
(3), 
	`AT91_SMC_NWESETUP_
(0Ë| 
	`AT91_SMC_NCS_WRSETUP_
(0)

135 | 
	`AT91_SMC_NRDSETUP_
(0Ë| 
	`AT91_SMC_NCS_RDSETUP_
(0));

137 
	`©91_sys_wrôe
(
	`AT91_SMC_PULSE
(3), 
	`AT91_SMC_NWEPULSE_
(2Ë| 
	`AT91_SMC_NCS_WRPULSE_
(5)

138 | 
	`AT91_SMC_NRDPULSE_
(2Ë| 
	`AT91_SMC_NCS_RDPULSE_
(5));

140 
	`©91_sys_wrôe
(
	`AT91_SMC_CYCLE
(3), 
	`AT91_SMC_NWECYCLE_
(7Ë| 
	`AT91_SMC_NRDCYCLE_
(7));

142 
	`©91_sys_wrôe
(
	`AT91_SMC_MODE
(3), 
AT91_SMC_DBW_8
 | 
AT91_SMC_READMODE
 | 
AT91_SMC_WRITEMODE
 | 
AT91_SMC_EXNWMODE_DISABLE
 | 
	`AT91_SMC_TDF_
(1));

145 i‡(
d©a
->
íabÀ_pö
)

146 
	`©91_£t_gpio_ouçut
(
d©a
->
íabÀ_pö
, 1);

149 i‡(
d©a
->
rdy_pö
)

150 
	`©91_£t_gpio_öput
(
d©a
->
rdy_pö
, 1);

153 i‡(
d©a
->
dë_pö
)

154 
	`©91_£t_gpio_öput
(
d©a
->
dë_pö
, 1);

156 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB4
, 0);

157 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB5
, 0);

159 
«nd_d©a
 = *
d©a
;

160 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_«nd_devi˚
);

161 
	}
}

164 
__öô
 
	$©91_add_devi˚_«nd
(
©91_«nd_d©a
 *
d©a
Ë{
	}
}

172 #i‡
deföed
(
CONFIG_I2C_AT91
Ë|| deföed(
CONFIG_I2C_AT91_MODULE
)

174 
ªsour˚
 
	gtwi_ªsour˚s
[] = {

176 .
°¨t
 = 
AT91SAM9RL_BASE_TWI0
,

177 .
	gíd
 = 
AT91SAM9RL_BASE_TWI0
 + 
SZ_16K
 - 1,

178 .
	gÊags
 = 
IORESOURCE_MEM
,

181 .
°¨t
 = 
AT91SAM9RL_ID_TWI0
,

182 .
	gíd
 = 
AT91SAM9RL_ID_TWI0
,

183 .
	gÊags
 = 
IORESOURCE_IRQ
,

187 
∂©f‹m_devi˚
 
	g©91ßm9æ_twi_devi˚
 = {

188 .
«me
 = "at91_i2c",

189 .
	gid
 = -1,

190 .
	gªsour˚
 = 
twi_ªsour˚s
,

191 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
twi_ªsour˚s
),

194 
__öô
 
	$©91_add_devi˚_i2c
()

197 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA23
, 0);

198 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA23
, 1);

200 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA24
, 0);

201 
	`©91_£t_mu…i_drive
(
AT91_PIN_PA24
, 1);

203 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9æ_twi_devi˚
);

204 
	}
}

206 
__öô
 
	$©91_add_devi˚_i2c
(Ë{
	}
}

214 #i‡
deföed
(
CONFIG_SPI_ATMEL
Ë|| deföed(
CONFIG_SPI_ATMEL_MODULE
)

215 
u64
 
	g•i_dmamask
 = 0xffffffffUL;

217 
ªsour˚
 
	g•i_ªsour˚s
[] = {

219 .
°¨t
 = 
AT91SAM9RL_BASE_SPI
,

220 .
	gíd
 = 
AT91SAM9RL_BASE_SPI
 + 
SZ_16K
 - 1,

221 .
	gÊags
 = 
IORESOURCE_MEM
,

224 .
°¨t
 = 
AT91SAM9RL_ID_SPI
,

225 .
	gíd
 = 
AT91SAM9RL_ID_SPI
,

226 .
	gÊags
 = 
IORESOURCE_IRQ
,

230 
∂©f‹m_devi˚
 
	g©91ßm9æ_•i_devi˚
 = {

231 .
«me
 = "atmel_spi",

232 .
	gid
 = 0,

233 .
	gdev
 = {

234 .
dma_mask
 = &
•i_dmamask
,

235 .
	gcohîít_dma_mask
 = 0xffffffff,

237 .
	gªsour˚
 = 
•i_ªsour˚s
,

238 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•i_ªsour˚s
),

241 c⁄° 
	g•i_°™d¨d_cs
[4] = { 
AT91_PIN_PA28
, 
AT91_PIN_PB7
, 
AT91_PIN_PD8
, 
AT91_PIN_PD9
 };

244 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
)

246 
i
;

247 
cs_pö
;

249 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA25
, 0);

250 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA26
, 0);

251 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA27
, 0);

254 
i
 = 0; i < 
ƒ_devi˚s
; i++) {

255 i‡(
devi˚s
[
i
].
c⁄åﬁÀr_d©a
)

256 
cs_pö
 = (Ë
devi˚s
[
i
].
c⁄åﬁÀr_d©a
;

258 
cs_pö
 = 
•i_°™d¨d_cs
[
devi˚s
[
i
].
chù_£À˘
];

261 
	`©91_£t_gpio_ouçut
(
cs_pö
, 1);

264 
devi˚s
[
i
].
c⁄åﬁÀr_d©a
 = (*Ë
cs_pö
;

267 
	`•i_ªgi°î_bﬂrd_öfo
(
devi˚s
, 
ƒ_devi˚s
);

268 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9æ_•i_devi˚
);

269 
	}
}

271 
__öô
 
	$©91_add_devi˚_•i
(
•i_bﬂrd_öfo
 *
devi˚s
, 
ƒ_devi˚s
Ë{
	}
}

279 #i‡
deföed
(
CONFIG_FB_ATMEL
Ë|| deföed(
CONFIG_FB_ATMEL_MODULE
)

280 
u64
 
	glcdc_dmamask
 = 0xffffffffUL;

281 
©mñ_lcdfb_öfo
 
	glcdc_d©a
;

283 
ªsour˚
 
	glcdc_ªsour˚s
[] = {

285 .
°¨t
 = 
AT91SAM9RL_LCDC_BASE
,

286 .
	gíd
 = 
AT91SAM9RL_LCDC_BASE
 + 
SZ_4K
 - 1,

287 .
	gÊags
 = 
IORESOURCE_MEM
,

290 .
°¨t
 = 
AT91SAM9RL_ID_LCDC
,

291 .
	gíd
 = 
AT91SAM9RL_ID_LCDC
,

292 .
	gÊags
 = 
IORESOURCE_IRQ
,

294 #i‡
deföed
(
CONFIG_FB_INTSRAM
)

296 .
°¨t
 = 
AT91SAM9RL_SRAM_BASE
,

297 .
	gíd
 = 
AT91SAM9RL_SRAM_BASE
 + 
AT91SAM9RL_SRAM_SIZE
 - 1,

298 .
	gÊags
 = 
IORESOURCE_MEM
,

303 
∂©f‹m_devi˚
 
	g©91_lcdc_devi˚
 = {

304 .
«me
 = "atmel_lcdfb",

305 .
	gid
 = 0,

306 .
	gdev
 = {

307 .
dma_mask
 = &
lcdc_dmamask
,

308 .
	gcohîít_dma_mask
 = 0xffffffff,

309 .
	g∂©f‹m_d©a
 = &
lcdc_d©a
,

311 .
	gªsour˚
 = 
lcdc_ªsour˚s
,

312 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
lcdc_ªsour˚s
),

315 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
)

317 i‡(!
d©a
) {

321 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC1
, 0);

322 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC5
, 0);

323 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC6
, 0);

324 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC7
, 0);

325 
	`©91_£t_A_≥rùh
(
AT91_PIN_PC3
, 0);

326 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC9
, 0);

327 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC10
, 0);

328 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC11
, 0);

329 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC12
, 0);

330 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC13
, 0);

331 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC15
, 0);

332 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC16
, 0);

333 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC17
, 0);

334 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC18
, 0);

335 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC19
, 0);

336 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC20
, 0);

337 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC21
, 0);

338 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC22
, 0);

339 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC23
, 0);

340 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC24
, 0);

341 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC25
, 0);

343 
lcdc_d©a
 = *
d©a
;

344 
	`∂©f‹m_devi˚_ªgi°î
(&
©91_lcdc_devi˚
);

345 
	}
}

347 
__öô
 
	$©91_add_devi˚_lcdc
(
©mñ_lcdfb_öfo
 *
d©a
Ë{
	}
}

355 #i‡
deföed
(
CONFIG_LEDS
)

356 
u8
 
	g©91_Àds_˝u
;

357 
u8
 
	g©91_Àds_timî
;

359 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
)

362 
	`©91_£t_gpio_ouçut
(
˝u_Àd
, 1);

363 
	`©91_£t_gpio_ouçut
(
timî_Àd
, 1);

365 
©91_Àds_˝u
 = 
˝u_Àd
;

366 
©91_Àds_timî
 = 
timî_Àd
;

367 
	}
}

369 
__öô
 
	$©91_öô_Àds
(
u8
 
˝u_Àd
, u8 
timî_Àd
Ë{
	}
}

377 #i‡
deföed
(
CONFIG_SERIAL_ATMEL
)

378 
ªsour˚
 
	gdbgu_ªsour˚s
[] = {

380 .
°¨t
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
,

381 .
	gíd
 = 
AT91_VA_BASE_SYS
 + 
AT91_DBGU
 + 
SZ_512
 - 1,

382 .
	gÊags
 = 
IORESOURCE_MEM
,

385 .
°¨t
 = 
AT91_ID_SYS
,

386 .
	gíd
 = 
AT91_ID_SYS
,

387 .
	gÊags
 = 
IORESOURCE_IRQ
,

391 
©mñ_u¨t_d©a
 
	gdbgu_d©a
 = {

392 .
u£_dma_tx
 = 0,

393 .
	gu£_dma_rx
 = 0,

394 .
	gªgs
 = (
__iomem
 *)(
AT91_VA_BASE_SYS
 + 
AT91_DBGU
),

397 
∂©f‹m_devi˚
 
	g©91ßm9æ_dbgu_devi˚
 = {

398 .
«me
 = "atmel_usart",

399 .
	gid
 = 0,

400 .
	gdev
 = {

401 .
∂©f‹m_d©a
 = &
dbgu_d©a
,

402 .
	gcohîít_dma_mask
 = 0xffffffff,

404 .
	gªsour˚
 = 
dbgu_ªsour˚s
,

405 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dbgu_ªsour˚s
),

408 
ölöe
 
	$c⁄figuª_dbgu_pös
()

410 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA21
, 0);

411 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA22
, 1);

412 
	}
}

414 
ªsour˚
 
	gu¨t0_ªsour˚s
[] = {

416 .
°¨t
 = 
AT91SAM9RL_BASE_US0
,

417 .
	gíd
 = 
AT91SAM9RL_BASE_US0
 + 
SZ_16K
 - 1,

418 .
	gÊags
 = 
IORESOURCE_MEM
,

421 .
°¨t
 = 
AT91SAM9RL_ID_US0
,

422 .
	gíd
 = 
AT91SAM9RL_ID_US0
,

423 .
	gÊags
 = 
IORESOURCE_IRQ
,

427 
©mñ_u¨t_d©a
 
	gu¨t0_d©a
 = {

428 .
u£_dma_tx
 = 1,

429 .
	gu£_dma_rx
 = 1,

432 
∂©f‹m_devi˚
 
	g©91ßm9æ_u¨t0_devi˚
 = {

433 .
«me
 = "atmel_usart",

434 .
	gid
 = 1,

435 .
	gdev
 = {

436 .
∂©f‹m_d©a
 = &
u¨t0_d©a
,

437 .
	gcohîít_dma_mask
 = 0xffffffff,

439 .
	gªsour˚
 = 
u¨t0_ªsour˚s
,

440 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t0_ªsour˚s
),

443 
ölöe
 
	$c⁄figuª_ußπ0_pös
()

445 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA6
, 1);

446 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA7
, 0);

447 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA9
, 0);

448 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA10
, 0);

449 
	}
}

451 
ªsour˚
 
	gu¨t1_ªsour˚s
[] = {

453 .
°¨t
 = 
AT91SAM9RL_BASE_US1
,

454 .
	gíd
 = 
AT91SAM9RL_BASE_US1
 + 
SZ_16K
 - 1,

455 .
	gÊags
 = 
IORESOURCE_MEM
,

458 .
°¨t
 = 
AT91SAM9RL_ID_US1
,

459 .
	gíd
 = 
AT91SAM9RL_ID_US1
,

460 .
	gÊags
 = 
IORESOURCE_IRQ
,

464 
©mñ_u¨t_d©a
 
	gu¨t1_d©a
 = {

465 .
u£_dma_tx
 = 1,

466 .
	gu£_dma_rx
 = 1,

469 
∂©f‹m_devi˚
 
	g©91ßm9æ_u¨t1_devi˚
 = {

470 .
«me
 = "atmel_usart",

471 .
	gid
 = 2,

472 .
	gdev
 = {

473 .
∂©f‹m_d©a
 = &
u¨t1_d©a
,

474 .
	gcohîít_dma_mask
 = 0xffffffff,

476 .
	gªsour˚
 = 
u¨t1_ªsour˚s
,

477 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t1_ªsour˚s
),

480 
ölöe
 
	$c⁄figuª_ußπ1_pös
()

482 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA11
, 1);

483 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA12
, 0);

484 
	}
}

486 
ªsour˚
 
	gu¨t2_ªsour˚s
[] = {

488 .
°¨t
 = 
AT91SAM9RL_BASE_US2
,

489 .
	gíd
 = 
AT91SAM9RL_BASE_US2
 + 
SZ_16K
 - 1,

490 .
	gÊags
 = 
IORESOURCE_MEM
,

493 .
°¨t
 = 
AT91SAM9RL_ID_US2
,

494 .
	gíd
 = 
AT91SAM9RL_ID_US2
,

495 .
	gÊags
 = 
IORESOURCE_IRQ
,

499 
©mñ_u¨t_d©a
 
	gu¨t2_d©a
 = {

500 .
u£_dma_tx
 = 1,

501 .
	gu£_dma_rx
 = 1,

504 
∂©f‹m_devi˚
 
	g©91ßm9æ_u¨t2_devi˚
 = {

505 .
«me
 = "atmel_usart",

506 .
	gid
 = 3,

507 .
	gdev
 = {

508 .
∂©f‹m_d©a
 = &
u¨t2_d©a
,

509 .
	gcohîít_dma_mask
 = 0xffffffff,

511 .
	gªsour˚
 = 
u¨t2_ªsour˚s
,

512 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t2_ªsour˚s
),

515 
ölöe
 
	$c⁄figuª_ußπ2_pös
()

517 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA13
, 1);

518 
	`©91_£t_A_≥rùh
(
AT91_PIN_PA14
, 0);

519 
	}
}

521 
ªsour˚
 
	gu¨t3_ªsour˚s
[] = {

523 .
°¨t
 = 
AT91SAM9RL_BASE_US3
,

524 .
	gíd
 = 
AT91SAM9RL_BASE_US3
 + 
SZ_16K
 - 1,

525 .
	gÊags
 = 
IORESOURCE_MEM
,

528 .
°¨t
 = 
AT91SAM9RL_ID_US3
,

529 .
	gíd
 = 
AT91SAM9RL_ID_US3
,

530 .
	gÊags
 = 
IORESOURCE_IRQ
,

534 
©mñ_u¨t_d©a
 
	gu¨t3_d©a
 = {

535 .
u£_dma_tx
 = 1,

536 .
	gu£_dma_rx
 = 1,

539 
∂©f‹m_devi˚
 
	g©91ßm9æ_u¨t3_devi˚
 = {

540 .
«me
 = "atmel_usart",

541 .
	gid
 = 4,

542 .
	gdev
 = {

543 .
∂©f‹m_d©a
 = &
u¨t3_d©a
,

544 .
	gcohîít_dma_mask
 = 0xffffffff,

546 .
	gªsour˚
 = 
u¨t3_ªsour˚s
,

547 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
u¨t3_ªsour˚s
),

550 
ölöe
 
	$c⁄figuª_ußπ3_pös
()

552 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB0
, 1);

553 
	`©91_£t_A_≥rùh
(
AT91_PIN_PB1
, 0);

554 
	}
}

556 
∂©f‹m_devi˚
 *
	g©91_u¨ts
[
ATMEL_MAX_UART
];

557 
∂©f‹m_devi˚
 *
	g©mñ_deÁu…_c⁄sﬁe_devi˚
;

559 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
)

561 
i
;

564 
i
 = 0; i < 
c⁄fig
->
ƒ_ây
; i++) {

565 
c⁄fig
->
ây_m≠
[
i
]) {

567 
	`c⁄figuª_ußπ0_pös
();

568 
©91_u¨ts
[
i
] = &
©91ßm9æ_u¨t0_devi˚
;

569 
	`©91_˛ock_assocüã
("ußπ0_˛k", &
©91ßm9æ_u¨t0_devi˚
.
dev
, "usart");

572 
	`c⁄figuª_ußπ1_pös
();

573 
©91_u¨ts
[
i
] = &
©91ßm9æ_u¨t1_devi˚
;

574 
	`©91_˛ock_assocüã
("ußπ1_˛k", &
©91ßm9æ_u¨t1_devi˚
.
dev
, "usart");

577 
	`c⁄figuª_ußπ2_pös
();

578 
©91_u¨ts
[
i
] = &
©91ßm9æ_u¨t2_devi˚
;

579 
	`©91_˛ock_assocüã
("ußπ2_˛k", &
©91ßm9æ_u¨t2_devi˚
.
dev
, "usart");

582 
	`c⁄figuª_ußπ3_pös
();

583 
©91_u¨ts
[
i
] = &
©91ßm9æ_u¨t3_devi˚
;

584 
	`©91_˛ock_assocüã
("ußπ3_˛k", &
©91ßm9æ_u¨t3_devi˚
.
dev
, "usart");

587 
	`c⁄figuª_dbgu_pös
();

588 
©91_u¨ts
[
i
] = &
©91ßm9æ_dbgu_devi˚
;

589 
	`©91_˛ock_assocüã
("mck", &
©91ßm9æ_dbgu_devi˚
.
dev
, "usart");

594 
©91_u¨ts
[
i
]->
id
 = i;

598 i‡(
c⁄fig
->
c⁄sﬁe_ây
 < 
ATMEL_MAX_UART
)

599 
©mñ_deÁu…_c⁄sﬁe_devi˚
 = 
©91_u¨ts
[
c⁄fig
->
c⁄sﬁe_ây
];

600 i‡(!
©mñ_deÁu…_c⁄sﬁe_devi˚
)

601 
	`¥ötk
(
KERN_INFO
 "AT91: No default serial console defined.\n");

602 
	}
}

604 
__öô
 
	$©91_add_devi˚_£rül
()

606 
i
;

608 
i
 = 0; i < 
ATMEL_MAX_UART
; i++) {

609 i‡(
©91_u¨ts
[
i
])

610 
	`∂©f‹m_devi˚_ªgi°î
(
©91_u¨ts
[
i
]);

612 
	}
}

614 
__öô
 
	$©91_öô_£rül
(
©91_u¨t_c⁄fig
 *
c⁄fig
Ë{
	}
}

615 
__öô
 
	$©91_add_devi˚_£rül
(Ë{
	}
}

625 
__öô
 
	$©91_add_°™d¨d_devi˚s
()

628 
	}
}

630 
¨ch_öôˇŒ
(
©91_add_°™d¨d_devi˚s
);

	@arch/arm/mach-at91/board-1arm.c

21 
	~<löux/ty≥s.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/úq.h
>

32 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mach/m≠.h
>

34 
	~<asm/mach/úq.h
>

36 
	~<asm/¨ch/bﬂrd.h
>

37 
	~<asm/¨ch/gpio.h
>

39 
	~"gíîic.h
"

47 
©91_u¨t_c⁄fig
 
__öôd©a
 
	g⁄órm_u¨t_c⁄fig
 = {

48 .
c⁄sﬁe_ây
 = 0,

49 .
	gƒ_ây
 = 3,

50 .
	gây_m≠
 = { 4, 0, 1, -1, -1 },

53 
__öô
 
	$⁄órm_m≠_io
()

56 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_PQFP
);

59 
	`©91_öô_£rül
(&
⁄órm_u¨t_c⁄fig
);

60 
	}
}

62 
__öô
 
	$⁄órm_öô_úq
()

64 
	`©91rm9200_öô_öãºu±s
(
NULL
);

65 
	}
}

67 
©91_ëh_d©a
 
__öôd©a
 
	g⁄órm_ëh_d©a
 = {

68 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

69 .
	gis_rmii
 = 1,

72 
©91_usbh_d©a
 
__öôd©a
 
	g⁄órm_usbh_d©a
 = {

73 .
p‹ts
 = 1,

76 
©91_udc_d©a
 
__öôd©a
 
	g⁄órm_udc_d©a
 = {

77 .
vbus_pö
 = 
AT91_PIN_PC2
,

78 .
	gpuŒup_pö
 = 
AT91_PIN_PC3
,

81 
__öô
 
	$⁄órm_bﬂrd_öô
()

84 
	`©91_add_devi˚_£rül
();

86 
	`©91_add_devi˚_ëh
(&
⁄órm_ëh_d©a
);

88 
	`©91_add_devi˚_usbh
(&
⁄órm_usbh_d©a
);

90 
	`©91_add_devi˚_udc
(&
⁄órm_udc_d©a
);

91 
	}
}

93 
MACHINE_START
(
ONEARM
, "Ajeco 1ARM single board computer")

95 .
	gphys_io
 = 
AT91_BASE_SYS
,

96 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

97 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

98 .
	gtimî
 = &
©91rm9200_timî
,

99 .
	gm≠_io
 = 
⁄órm_m≠_io
,

100 .
	göô_úq
 = 
⁄órm_öô_úq
,

101 .
	göô_machöe
 = 
⁄órm_bﬂrd_öô
,

102 
	gMACHINE_END


	@arch/arm/mach-at91/board-carmeva.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/úq.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/bﬂrd.h
>

38 
	~<asm/¨ch/gpio.h
>

40 
	~"gíîic.h
"

48 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gˇrmeva_u¨t_c⁄fig
 = {

49 .
c⁄sﬁe_ây
 = 0,

50 .
	gƒ_ây
 = 2,

51 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

54 
__öô
 
	$ˇrmeva_m≠_io
()

57 
	`©91rm9200_öôülize
(20000000, 
AT91RM9200_BGA
);

60 
	`©91_öô_£rül
(&
ˇrmeva_u¨t_c⁄fig
);

61 
	}
}

63 
__öô
 
	$ˇrmeva_öô_úq
()

65 
	`©91rm9200_öô_öãºu±s
(
NULL
);

66 
	}
}

68 
©91_ëh_d©a
 
__öôd©a
 
	gˇrmeva_ëh_d©a
 = {

69 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

70 .
	gis_rmii
 = 1,

73 
©91_usbh_d©a
 
__öôd©a
 
	gˇrmeva_usbh_d©a
 = {

74 .
p‹ts
 = 2,

77 
©91_udc_d©a
 
__öôd©a
 
	gˇrmeva_udc_d©a
 = {

78 .
vbus_pö
 = 
AT91_PIN_PD12
,

79 .
	gpuŒup_pö
 = 
AT91_PIN_PD9
,

90 
©91_mmc_d©a
 
__öôd©a
 
	gˇrmeva_mmc_d©a
 = {

91 .
¶Ÿ_b
 = 0,

92 .
	gwúe4
 = 1,

93 .
	gdë_pö
 = 
AT91_PIN_PB10
,

94 .
	gwp_pö
 = 
AT91_PIN_PC14
,

97 
•i_bﬂrd_öfo
 
	gˇrmeva_•i_devi˚s
[] = {

99 .
modÆüs
 = "mtd_dataflash",

100 .
	gchù_£À˘
 = 0,

101 .
	gmax_•ìd_hz
 = 10 * 1000 * 1000,

104 .
	gmodÆüs
 = "spi-cs1",

105 .
	gchù_£À˘
 = 1,

106 .
	gmax_•ìd_hz
 = 250 * 1000,

109 .
	gmodÆüs
 = "spi-cs2",

110 .
	gchù_£À˘
 = 2,

111 .
	gmax_•ìd_hz
 = 1 * 1000 * 1000,

114 .
	gmodÆüs
 = "spi-cs3",

115 .
	gchù_£À˘
 = 3,

116 .
	gmax_•ìd_hz
 = 10 * 1000 * 1000,

120 
__öô
 
	$ˇrmeva_bﬂrd_öô
()

123 
	`©91_add_devi˚_£rül
();

125 
	`©91_add_devi˚_ëh
(&
ˇrmeva_ëh_d©a
);

127 
	`©91_add_devi˚_usbh
(&
ˇrmeva_usbh_d©a
);

129 
	`©91_add_devi˚_udc
(&
ˇrmeva_udc_d©a
);

131 
	`©91_add_devi˚_i2c
();

133 
	`©91_add_devi˚_•i
(
ˇrmeva_•i_devi˚s
, 
	`ARRAY_SIZE
(carmeva_spi_devices));

137 
	`©91_add_devi˚_mmc
(0, &
ˇrmeva_mmc_d©a
);

138 
	}
}

140 
MACHINE_START
(
CARMEVA
, "Carmeva")

142 .
	gphys_io
 = 
AT91_BASE_SYS
,

143 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

144 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

145 .
	gtimî
 = &
©91rm9200_timî
,

146 .
	gm≠_io
 = 
ˇrmeva_m≠_io
,

147 .
	göô_úq
 = 
ˇrmeva_öô_úq
,

148 .
	göô_machöe
 = 
ˇrmeva_bﬂrd_öô
,

149 
	gMACHINE_END


	@arch/arm/mach-at91/board-csb337.c

21 
	~<löux/ty≥s.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/∂©f‹m_devi˚.h
>

26 
	~<löux/•i/•i.h
>

27 
	~<löux/mtd/physm≠.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/úq.h
>

34 
	~<asm/mach/¨ch.h
>

35 
	~<asm/mach/m≠.h
>

36 
	~<asm/mach/úq.h
>

38 
	~<asm/¨ch/bﬂrd.h
>

39 
	~<asm/¨ch/gpio.h
>

41 
	~"gíîic.h
"

49 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gcsb337_u¨t_c⁄fig
 = {

50 .
c⁄sﬁe_ây
 = 0,

51 .
	gƒ_ây
 = 2,

52 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

55 
__öô
 
	$csb337_m≠_io
()

58 
	`©91rm9200_öôülize
(3686400, 
AT91RM9200_BGA
);

61 
	`©91_öô_Àds
(
AT91_PIN_PB0
, 
AT91_PIN_PB1
);

64 
	`©91_öô_£rül
(&
csb337_u¨t_c⁄fig
);

65 
	}
}

67 
__öô
 
	$csb337_öô_úq
()

69 
	`©91rm9200_öô_öãºu±s
(
NULL
);

70 
	}
}

72 
©91_ëh_d©a
 
__öôd©a
 
	gcsb337_ëh_d©a
 = {

73 .
phy_úq_pö
 = 
AT91_PIN_PC2
,

74 .
	gis_rmii
 = 0,

77 
©91_usbh_d©a
 
__öôd©a
 
	gcsb337_usbh_d©a
 = {

78 .
p‹ts
 = 2,

81 
©91_udc_d©a
 
__öôd©a
 
	gcsb337_udc_d©a
 = {

83 .
puŒup_pö
 = 
AT91_PIN_PA24
,

86 
©91_cf_d©a
 
__öôd©a
 
	gcsb337_cf_d©a
 = {

93 .
dë_pö
 = 
AT91_PIN_PC3
,

96 .
	gúq_pö
 = 
AT91_PIN_PA19
,

97 .
	gvcc_pö
 = 
AT91_PIN_PD0
,

98 .
	gr°_pö
 = 
AT91_PIN_PD2
,

101 
©91_mmc_d©a
 
__öôd©a
 
	gcsb337_mmc_d©a
 = {

102 .
dë_pö
 = 
AT91_PIN_PD5
,

103 .
	g¶Ÿ_b
 = 0,

104 .
	gwúe4
 = 1,

105 .
	gwp_pö
 = 
AT91_PIN_PD6
,

108 
•i_bﬂrd_öfo
 
	gcsb337_•i_devi˚s
[] = {

110 .
modÆüs
 = "sak82c900",

111 .
	gchù_£À˘
 = 0,

112 .
	gmax_•ìd_hz
 = 6 * 1000 * 1000,

116 
	#CSB_FLASH_BASE
 
AT91_CHIPSELECT_0


	)

117 
	#CSB_FLASH_SIZE
 0x800000

	)

119 
mtd_∑πôi⁄
 
	gcsb_Êash_∑πôi⁄s
[] = {

121 .
«me
 = "uMON flash",

122 .
	goff£t
 = 0,

123 .
	gsize
 = 
MTDPART_SIZ_FULL
,

124 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

128 
physm≠_Êash_d©a
 
	gcsb_Êash_d©a
 = {

129 .
width
 = 2,

130 .
	g∑πs
 = 
csb_Êash_∑πôi⁄s
,

131 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
csb_Êash_∑πôi⁄s
),

134 
ªsour˚
 
	gcsb_Êash_ªsour˚s
[] = {

136 .
°¨t
 = 
CSB_FLASH_BASE
,

137 .
	gíd
 = 
CSB_FLASH_BASE
 + 
CSB_FLASH_SIZE
 - 1,

138 .
	gÊags
 = 
IORESOURCE_MEM
,

142 
∂©f‹m_devi˚
 
	gcsb_Êash
 = {

143 .
«me
 = "physmap-flash",

144 .
	gid
 = 0,

145 .
	gdev
 = {

146 .
∂©f‹m_d©a
 = &
csb_Êash_d©a
,

148 .
	gªsour˚
 = 
csb_Êash_ªsour˚s
,

149 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
csb_Êash_ªsour˚s
),

152 
__öô
 
	$csb337_bﬂrd_öô
()

155 
	`©91_add_devi˚_£rül
();

157 
	`©91_add_devi˚_ëh
(&
csb337_ëh_d©a
);

159 
	`©91_add_devi˚_usbh
(&
csb337_usbh_d©a
);

161 
	`©91_add_devi˚_udc
(&
csb337_udc_d©a
);

163 
	`©91_add_devi˚_i2c
();

165 
	`©91_£t_gpio_öput
(
AT91_PIN_PB22
, 1);

166 
	`©91_add_devi˚_cf
(&
csb337_cf_d©a
);

168 
	`©91_add_devi˚_•i
(
csb337_•i_devi˚s
, 
	`ARRAY_SIZE
(csb337_spi_devices));

170 
	`©91_add_devi˚_mmc
(0, &
csb337_mmc_d©a
);

172 
	`∂©f‹m_devi˚_ªgi°î
(&
csb_Êash
);

173 
	}
}

175 
MACHINE_START
(
CSB337
, "Cogent CSB337")

177 .
	gphys_io
 = 
AT91_BASE_SYS
,

178 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

179 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

180 .
	gtimî
 = &
©91rm9200_timî
,

181 .
	gm≠_io
 = 
csb337_m≠_io
,

182 .
	göô_úq
 = 
csb337_öô_úq
,

183 .
	göô_machöe
 = 
csb337_bﬂrd_öô
,

184 
	gMACHINE_END


	@arch/arm/mach-at91/board-csb637.c

21 
	~<löux/ty≥s.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/∂©f‹m_devi˚.h
>

26 
	~<löux/mtd/physm≠.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/úq.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/bﬂrd.h
>

38 
	~<asm/¨ch/gpio.h
>

40 
	~"gíîic.h
"

48 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gcsb637_u¨t_c⁄fig
 = {

49 .
c⁄sﬁe_ây
 = 0,

50 .
	gƒ_ây
 = 2,

51 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

54 
__öô
 
	$csb637_m≠_io
()

57 
	`©91rm9200_öôülize
(3686400, 
AT91RM9200_BGA
);

60 
	`©91_öô_Àds
(
AT91_PIN_PB2
, AT91_PIN_PB2);

63 
	`©91_öô_£rül
(&
csb637_u¨t_c⁄fig
);

64 
	}
}

66 
__öô
 
	$csb637_öô_úq
()

68 
	`©91rm9200_öô_öãºu±s
(
NULL
);

69 
	}
}

71 
©91_ëh_d©a
 
__öôd©a
 
	gcsb637_ëh_d©a
 = {

72 .
phy_úq_pö
 = 
AT91_PIN_PC0
,

73 .
	gis_rmii
 = 0,

76 
©91_usbh_d©a
 
__öôd©a
 
	gcsb637_usbh_d©a
 = {

77 .
p‹ts
 = 2,

80 
©91_udc_d©a
 
__öôd©a
 
	gcsb637_udc_d©a
 = {

81 .
vbus_pö
 = 
AT91_PIN_PB28
,

82 .
	gpuŒup_pö
 = 
AT91_PIN_PB1
,

85 
	#CSB_FLASH_BASE
 
AT91_CHIPSELECT_0


	)

86 
	#CSB_FLASH_SIZE
 0x1000000

	)

88 
mtd_∑πôi⁄
 
	gcsb_Êash_∑πôi⁄s
[] = {

90 .
«me
 = "uMON flash",

91 .
	goff£t
 = 0,

92 .
	gsize
 = 
MTDPART_SIZ_FULL
,

93 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

97 
physm≠_Êash_d©a
 
	gcsb_Êash_d©a
 = {

98 .
width
 = 2,

99 .
	g∑πs
 = 
csb_Êash_∑πôi⁄s
,

100 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
csb_Êash_∑πôi⁄s
),

103 
ªsour˚
 
	gcsb_Êash_ªsour˚s
[] = {

105 .
°¨t
 = 
CSB_FLASH_BASE
,

106 .
	gíd
 = 
CSB_FLASH_BASE
 + 
CSB_FLASH_SIZE
 - 1,

107 .
	gÊags
 = 
IORESOURCE_MEM
,

111 
∂©f‹m_devi˚
 
	gcsb_Êash
 = {

112 .
«me
 = "physmap-flash",

113 .
	gid
 = 0,

114 .
	gdev
 = {

115 .
∂©f‹m_d©a
 = &
csb_Êash_d©a
,

117 .
	gªsour˚
 = 
csb_Êash_ªsour˚s
,

118 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
csb_Êash_ªsour˚s
),

121 
__öô
 
	$csb637_bﬂrd_öô
()

124 
	`©91_add_devi˚_£rül
();

126 
	`©91_add_devi˚_ëh
(&
csb637_ëh_d©a
);

128 
	`©91_add_devi˚_usbh
(&
csb637_usbh_d©a
);

130 
	`©91_add_devi˚_udc
(&
csb637_udc_d©a
);

132 
	`©91_add_devi˚_i2c
();

134 
	`©91_add_devi˚_•i
(
NULL
, 0);

136 
	`∂©f‹m_devi˚_ªgi°î
(&
csb_Êash
);

137 
	}
}

139 
MACHINE_START
(
CSB637
, "Cogent CSB637")

141 .
	gphys_io
 = 
AT91_BASE_SYS
,

142 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

143 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

144 .
	gtimî
 = &
©91rm9200_timî
,

145 .
	gm≠_io
 = 
csb637_m≠_io
,

146 .
	göô_úq
 = 
csb637_öô_úq
,

147 .
	göô_machöe
 = 
csb637_bﬂrd_öô
,

148 
	gMACHINE_END


	@arch/arm/mach-at91/board-dk.c

24 
	~<löux/ty≥s.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/moduÀ.h
>

28 
	~<löux/∂©f‹m_devi˚.h
>

29 
	~<löux/•i/•i.h
>

30 
	~<löux/mtd/physm≠.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/£tup.h
>

34 
	~<asm/mach-ty≥s.h
>

35 
	~<asm/úq.h
>

37 
	~<asm/mach/¨ch.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/úq.h
>

41 
	~<asm/¨ch/bﬂrd.h
>

42 
	~<asm/¨ch/gpio.h
>

43 
	~<asm/¨ch/©91rm9200_mc.h
>

45 
	~"gíîic.h
"

53 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gdk_u¨t_c⁄fig
 = {

54 .
c⁄sﬁe_ây
 = 0,

55 .
	gƒ_ây
 = 2,

56 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

59 
__öô
 
	$dk_m≠_io
()

62 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_BGA
);

65 
	`©91_öô_Àds
(
AT91_PIN_PB2
, AT91_PIN_PB2);

68 
	`©91_öô_£rül
(&
dk_u¨t_c⁄fig
);

69 
	}
}

71 
__öô
 
	$dk_öô_úq
()

73 
	`©91rm9200_öô_öãºu±s
(
NULL
);

74 
	}
}

76 
©91_ëh_d©a
 
__öôd©a
 
	gdk_ëh_d©a
 = {

77 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

78 .
	gis_rmii
 = 1,

81 
©91_usbh_d©a
 
__öôd©a
 
	gdk_usbh_d©a
 = {

82 .
p‹ts
 = 2,

85 
©91_udc_d©a
 
__öôd©a
 
	gdk_udc_d©a
 = {

86 .
vbus_pö
 = 
AT91_PIN_PD4
,

87 .
	gpuŒup_pö
 = 
AT91_PIN_PD5
,

90 
©91_cf_d©a
 
__öôd©a
 
	gdk_cf_d©a
 = {

91 .
dë_pö
 = 
AT91_PIN_PB0
,

92 .
	gr°_pö
 = 
AT91_PIN_PC5
,

97 
©91_mmc_d©a
 
__öôd©a
 
	gdk_mmc_d©a
 = {

98 .
¶Ÿ_b
 = 0,

99 .
	gwúe4
 = 1,

102 
•i_bﬂrd_öfo
 
	gdk_•i_devi˚s
[] = {

104 .
modÆüs
 = "mtd_dataflash",

105 .
	gchù_£À˘
 = 0,

106 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

109 .
	gmodÆüs
 = "ur6hcps2",

110 .
	gchù_£À˘
 = 1,

111 .
	gmax_•ìd_hz
 = 250 * 1000,

114 .
	gmodÆüs
 = "tlv1504",

115 .
	gchù_£À˘
 = 2,

116 .
	gmax_•ìd_hz
 = 20 * 1000 * 1000,

118 #ifde‡
CONFIG_MTD_AT91_DATAFLASH_CARD


120 .
	gmodÆüs
 = "mtd_dataflash",

121 .
	gchù_£À˘
 = 3,

122 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

127 
mtd_∑πôi⁄
 
__öôd©a
 
	gdk_«nd_∑πôi⁄
[] = {

129 .
«me
 = "NAND Partition 1",

130 .
	goff£t
 = 0,

131 .
	gsize
 = 
MTDPART_SIZ_FULL
,

135 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

137 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
dk_«nd_∑πôi⁄
);

138  
dk_«nd_∑πôi⁄
;

139 
	}
}

141 
©91_«nd_d©a
 
__öôd©a
 
	gdk_«nd_d©a
 = {

142 .
Æe
 = 22,

143 .
	g˛e
 = 21,

144 .
	gdë_pö
 = 
AT91_PIN_PB1
,

145 .
	grdy_pö
 = 
AT91_PIN_PC2
,

147 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

150 
	#DK_FLASH_BASE
 
AT91_CHIPSELECT_0


	)

151 
	#DK_FLASH_SIZE
 0x200000

	)

153 
physm≠_Êash_d©a
 
	gdk_Êash_d©a
 = {

154 .
width
 = 2,

157 
ªsour˚
 
	gdk_Êash_ªsour˚
 = {

158 .
°¨t
 = 
DK_FLASH_BASE
,

159 .
	gíd
 = 
DK_FLASH_BASE
 + 
DK_FLASH_SIZE
 - 1,

160 .
	gÊags
 = 
IORESOURCE_MEM
,

163 
∂©f‹m_devi˚
 
	gdk_Êash
 = {

164 .
«me
 = "physmap-flash",

165 .
	gid
 = 0,

166 .
	gdev
 = {

167 .
∂©f‹m_d©a
 = &
dk_Êash_d©a
,

169 .
	gªsour˚
 = &
dk_Êash_ªsour˚
,

170 .
	gnum_ªsour˚s
 = 1,

174 
__öô
 
	$dk_bﬂrd_öô
()

177 
	`©91_add_devi˚_£rül
();

179 
	`©91_add_devi˚_ëh
(&
dk_ëh_d©a
);

181 
	`©91_add_devi˚_usbh
(&
dk_usbh_d©a
);

183 
	`©91_add_devi˚_udc
(&
dk_udc_d©a
);

184 
	`©91_£t_mu…i_drive
(
dk_udc_d©a
.
puŒup_pö
, 1);

186 
	`©91_add_devi˚_cf
(&
dk_cf_d©a
);

188 
	`©91_add_devi˚_i2c
();

190 
	`©91_add_devi˚_•i
(
dk_•i_devi˚s
, 
	`ARRAY_SIZE
(dk_spi_devices));

191 #ifde‡
CONFIG_MTD_AT91_DATAFLASH_CARD


193 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB7
, 0);

196 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB7
, 1);

197 
	`©91_add_devi˚_mmc
(0, &
dk_mmc_d©a
);

200 
	`©91_add_devi˚_«nd
(&
dk_«nd_d©a
);

202 
	`∂©f‹m_devi˚_ªgi°î
(&
dk_Êash
);

205 
	}
}

207 
MACHINE_START
(
AT91RM9200DK
, "Atmel AT91RM9200-DK")

209 .
	gphys_io
 = 
AT91_BASE_SYS
,

210 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

211 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

212 .
	gtimî
 = &
©91rm9200_timî
,

213 .
	gm≠_io
 = 
dk_m≠_io
,

214 .
	göô_úq
 = 
dk_öô_úq
,

215 .
	göô_machöe
 = 
dk_bﬂrd_öô
,

216 
	gMACHINE_END


	@arch/arm/mach-at91/board-eb9200.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/devi˚.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/úq.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/bﬂrd.h
>

38 
	~<asm/¨ch/gpio.h
>

40 
	~"gíîic.h
"

48 
©91_u¨t_c⁄fig
 
__öôd©a
 
	geb9200_u¨t_c⁄fig
 = {

49 .
c⁄sﬁe_ây
 = 0,

50 .
	gƒ_ây
 = 2,

51 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

54 
__öô
 
	$eb9200_m≠_io
()

57 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_BGA
);

60 
	`©91_öô_£rül
(&
eb9200_u¨t_c⁄fig
);

61 
	}
}

63 
__öô
 
	$eb9200_öô_úq
()

65 
	`©91rm9200_öô_öãºu±s
(
NULL
);

66 
	}
}

68 
©91_ëh_d©a
 
__öôd©a
 
	geb9200_ëh_d©a
 = {

69 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

70 .
	gis_rmii
 = 1,

73 
©91_usbh_d©a
 
__öôd©a
 
	geb9200_usbh_d©a
 = {

74 .
p‹ts
 = 2,

77 
©91_udc_d©a
 
__öôd©a
 
	geb9200_udc_d©a
 = {

78 .
vbus_pö
 = 
AT91_PIN_PD4
,

79 .
	gpuŒup_pö
 = 
AT91_PIN_PD5
,

82 
©91_cf_d©a
 
__öôd©a
 
	geb9200_cf_d©a
 = {

83 .
dë_pö
 = 
AT91_PIN_PB0
,

84 .
	gr°_pö
 = 
AT91_PIN_PC5
,

89 
©91_mmc_d©a
 
__öôd©a
 
	geb9200_mmc_d©a
 = {

90 .
¶Ÿ_b
 = 0,

91 .
	gwúe4
 = 1,

94 
__öô
 
	$eb9200_bﬂrd_öô
()

97 
	`©91_add_devi˚_£rül
();

99 
	`©91_add_devi˚_ëh
(&
eb9200_ëh_d©a
);

101 
	`©91_add_devi˚_usbh
(&
eb9200_usbh_d©a
);

103 
	`©91_add_devi˚_udc
(&
eb9200_udc_d©a
);

105 
	`©91_add_devi˚_i2c
();

107 
	`©91_add_devi˚_cf
(&
eb9200_cf_d©a
);

109 
	`©91_add_devi˚_•i
(
NULL
, 0);

112 
	`©91_add_devi˚_mmc
(0, &
eb9200_mmc_d©a
);

113 
	}
}

115 
MACHINE_START
(
ATEB9200
, "Embest ATEB9200")

116 .
	gphys_io
 = 
AT91_BASE_SYS
,

117 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

118 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

119 .
	gtimî
 = &
©91rm9200_timî
,

120 .
	gm≠_io
 = 
eb9200_m≠_io
,

121 .
	göô_úq
 = 
eb9200_öô_úq
,

122 .
	göô_machöe
 = 
eb9200_bﬂrd_öô
,

123 
	gMACHINE_END


	@arch/arm/mach-at91/board-ek.c

24 
	~<löux/ty≥s.h
>

25 
	~<löux/öô.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/moduÀ.h
>

28 
	~<löux/∂©f‹m_devi˚.h
>

29 
	~<löux/•i/•i.h
>

30 
	~<löux/mtd/physm≠.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/£tup.h
>

34 
	~<asm/mach-ty≥s.h
>

35 
	~<asm/úq.h
>

37 
	~<asm/mach/¨ch.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/úq.h
>

41 
	~<asm/¨ch/bﬂrd.h
>

42 
	~<asm/¨ch/gpio.h
>

43 
	~<asm/¨ch/©91rm9200_mc.h
>

45 
	~"gíîic.h
"

53 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gek_u¨t_c⁄fig
 = {

54 .
c⁄sﬁe_ây
 = 0,

55 .
	gƒ_ây
 = 2,

56 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

59 
__öô
 
	$ek_m≠_io
()

62 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_BGA
);

65 
	`©91_öô_Àds
(
AT91_PIN_PB1
, 
AT91_PIN_PB2
);

68 
	`©91_öô_£rül
(&
ek_u¨t_c⁄fig
);

69 
	}
}

71 
__öô
 
	$ek_öô_úq
()

73 
	`©91rm9200_öô_öãºu±s
(
NULL
);

74 
	}
}

76 
©91_ëh_d©a
 
__öôd©a
 
	gek_ëh_d©a
 = {

77 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

78 .
	gis_rmii
 = 1,

81 
©91_usbh_d©a
 
__öôd©a
 
	gek_usbh_d©a
 = {

82 .
p‹ts
 = 2,

85 
©91_udc_d©a
 
__öôd©a
 
	gek_udc_d©a
 = {

86 .
vbus_pö
 = 
AT91_PIN_PD4
,

87 .
	gpuŒup_pö
 = 
AT91_PIN_PD5
,

90 
©91_mmc_d©a
 
__öôd©a
 
	gek_mmc_d©a
 = {

91 .
dë_pö
 = 
AT91_PIN_PB27
,

92 .
	g¶Ÿ_b
 = 0,

93 .
	gwúe4
 = 1,

94 .
	gwp_pö
 = 
AT91_PIN_PA17
,

97 
•i_bﬂrd_öfo
 
	gek_•i_devi˚s
[] = {

99 .
modÆüs
 = "mtd_dataflash",

100 .
	gchù_£À˘
 = 0,

101 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

103 #ifde‡
CONFIG_MTD_AT91_DATAFLASH_CARD


105 .
	gmodÆüs
 = "mtd_dataflash",

106 .
	gchù_£À˘
 = 3,

107 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

112 
	#EK_FLASH_BASE
 
AT91_CHIPSELECT_0


	)

113 
	#EK_FLASH_SIZE
 0x200000

	)

115 
physm≠_Êash_d©a
 
	gek_Êash_d©a
 = {

116 .
width
 = 2,

119 
ªsour˚
 
	gek_Êash_ªsour˚
 = {

120 .
°¨t
 = 
EK_FLASH_BASE
,

121 .
	gíd
 = 
EK_FLASH_BASE
 + 
EK_FLASH_SIZE
 - 1,

122 .
	gÊags
 = 
IORESOURCE_MEM
,

125 
∂©f‹m_devi˚
 
	gek_Êash
 = {

126 .
«me
 = "physmap-flash",

127 .
	gid
 = 0,

128 .
	gdev
 = {

129 .
∂©f‹m_d©a
 = &
ek_Êash_d©a
,

131 .
	gªsour˚
 = &
ek_Êash_ªsour˚
,

132 .
	gnum_ªsour˚s
 = 1,

136 
__öô
 
	$ek_bﬂrd_öô
()

139 
	`©91_add_devi˚_£rül
();

141 
	`©91_add_devi˚_ëh
(&
ek_ëh_d©a
);

143 
	`©91_add_devi˚_usbh
(&
ek_usbh_d©a
);

145 
	`©91_add_devi˚_udc
(&
ek_udc_d©a
);

146 
	`©91_£t_mu…i_drive
(
ek_udc_d©a
.
puŒup_pö
, 1);

148 
	`©91_add_devi˚_i2c
();

150 
	`©91_add_devi˚_•i
(
ek_•i_devi˚s
, 
	`ARRAY_SIZE
(ek_spi_devices));

151 #ifde‡
CONFIG_MTD_AT91_DATAFLASH_CARD


153 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB22
, 0);

156 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB22
, 1);

157 
	`©91_add_devi˚_mmc
(0, &
ek_mmc_d©a
);

160 
	`∂©f‹m_devi˚_ªgi°î
(&
ek_Êash
);

163 
	}
}

165 
MACHINE_START
(
AT91RM9200EK
, "Atmel AT91RM9200-EK")

167 .
	gphys_io
 = 
AT91_BASE_SYS
,

168 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

169 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

170 .
	gtimî
 = &
©91rm9200_timî
,

171 .
	gm≠_io
 = 
ek_m≠_io
,

172 .
	göô_úq
 = 
ek_öô_úq
,

173 .
	göô_machöe
 = 
ek_bﬂrd_öô
,

174 
	gMACHINE_END


	@arch/arm/mach-at91/board-kafa.c

21 
	~<löux/ty≥s.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/úq.h
>

32 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mach/m≠.h
>

34 
	~<asm/mach/úq.h
>

36 
	~<asm/¨ch/bﬂrd.h
>

37 
	~<asm/¨ch/gpio.h
>

39 
	~"gíîic.h
"

47 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gkaÁ_u¨t_c⁄fig
 = {

48 .
c⁄sﬁe_ây
 = 0,

49 .
	gƒ_ây
 = 2,

50 .
	gây_m≠
 = { 4, 0, -1, -1, -1 }

53 
__öô
 
	$kaÁ_m≠_io
()

56 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_PQFP
);

59 
	`©91_öô_Àds
(
AT91_PIN_PB4
, AT91_PIN_PB4);

62 
	`©91_öô_£rül
(&
kaÁ_u¨t_c⁄fig
);

63 
	}
}

65 
__öô
 
	$kaÁ_öô_úq
()

67 
	`©91rm9200_öô_öãºu±s
(
NULL
);

68 
	}
}

70 
©91_ëh_d©a
 
__öôd©a
 
	gkaÁ_ëh_d©a
 = {

71 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

72 .
	gis_rmii
 = 0,

75 
©91_usbh_d©a
 
__öôd©a
 
	gkaÁ_usbh_d©a
 = {

76 .
p‹ts
 = 1,

79 
©91_udc_d©a
 
__öôd©a
 
	gkaÁ_udc_d©a
 = {

80 .
vbus_pö
 = 
AT91_PIN_PB6
,

81 .
	gpuŒup_pö
 = 
AT91_PIN_PB7
,

84 
__öô
 
	$kaÁ_bﬂrd_öô
()

87 
	`©91_add_devi˚_£rül
();

89 
	`©91_add_devi˚_ëh
(&
kaÁ_ëh_d©a
);

91 
	`©91_add_devi˚_usbh
(&
kaÁ_usbh_d©a
);

93 
	`©91_add_devi˚_udc
(&
kaÁ_udc_d©a
);

95 
	`©91_add_devi˚_i2c
();

97 
	`©91_add_devi˚_•i
(
NULL
, 0);

98 
	}
}

100 
MACHINE_START
(
KAFA
, "Sperry-Sun KAFA")

102 .
	gphys_io
 = 
AT91_BASE_SYS
,

103 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

104 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

105 .
	gtimî
 = &
©91rm9200_timî
,

106 .
	gm≠_io
 = 
kaÁ_m≠_io
,

107 .
	göô_úq
 = 
kaÁ_öô_úq
,

108 .
	göô_machöe
 = 
kaÁ_bﬂrd_öô
,

109 
	gMACHINE_END


	@arch/arm/mach-at91/board-kb9202.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/úq.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/bﬂrd.h
>

38 
	~<asm/¨ch/gpio.h
>

40 
	~"gíîic.h
"

48 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gkb9202_u¨t_c⁄fig
 = {

49 .
c⁄sﬁe_ây
 = 0,

50 .
	gƒ_ây
 = 3,

51 .
	gây_m≠
 = { 4, 0, 1, -1, -1 }

54 
__öô
 
	$kb9202_m≠_io
()

57 
	`©91rm9200_öôülize
(10000000, 
AT91RM9200_PQFP
);

60 
	`©91_öô_Àds
(
AT91_PIN_PC19
, 
AT91_PIN_PC18
);

63 
	`©91_öô_£rül
(&
kb9202_u¨t_c⁄fig
);

64 
	}
}

66 
__öô
 
	$kb9202_öô_úq
()

68 
	`©91rm9200_öô_öãºu±s
(
NULL
);

69 
	}
}

71 
©91_ëh_d©a
 
__öôd©a
 
	gkb9202_ëh_d©a
 = {

72 .
phy_úq_pö
 = 
AT91_PIN_PB29
,

73 .
	gis_rmii
 = 0,

76 
©91_usbh_d©a
 
__öôd©a
 
	gkb9202_usbh_d©a
 = {

77 .
p‹ts
 = 1,

80 
©91_udc_d©a
 
__öôd©a
 
	gkb9202_udc_d©a
 = {

81 .
vbus_pö
 = 
AT91_PIN_PB24
,

82 .
	gpuŒup_pö
 = 
AT91_PIN_PB22
,

85 
©91_mmc_d©a
 
__öôd©a
 
	gkb9202_mmc_d©a
 = {

86 .
dë_pö
 = 
AT91_PIN_PB2
,

87 .
	g¶Ÿ_b
 = 0,

88 .
	gwúe4
 = 1,

91 
mtd_∑πôi⁄
 
__öôd©a
 
	gkb9202_«nd_∑πôi⁄
[] = {

93 .
«me
 = "nand_fs",

94 .
	goff£t
 = 0,

95 .
	gsize
 = 
MTDPART_SIZ_FULL
,

99 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

101 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
kb9202_«nd_∑πôi⁄
);

102  
kb9202_«nd_∑πôi⁄
;

103 
	}
}

105 
©91_«nd_d©a
 
__öôd©a
 
	gkb9202_«nd_d©a
 = {

106 .
Æe
 = 22,

107 .
	g˛e
 = 21,

109 .
	grdy_pö
 = 
AT91_PIN_PC29
,

110 .
	gíabÀ_pö
 = 
AT91_PIN_PC28
,

111 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

114 
__öô
 
	$kb9202_bﬂrd_öô
()

117 
	`©91_add_devi˚_£rül
();

119 
	`©91_add_devi˚_ëh
(&
kb9202_ëh_d©a
);

121 
	`©91_add_devi˚_usbh
(&
kb9202_usbh_d©a
);

123 
	`©91_add_devi˚_udc
(&
kb9202_udc_d©a
);

125 
	`©91_add_devi˚_mmc
(0, &
kb9202_mmc_d©a
);

127 
	`©91_add_devi˚_i2c
();

129 
	`©91_add_devi˚_•i
(
NULL
, 0);

131 
	`©91_add_devi˚_«nd
(&
kb9202_«nd_d©a
);

132 
	}
}

134 
MACHINE_START
(
KB9200
, "KB920x")

136 .
	gphys_io
 = 
AT91_BASE_SYS
,

137 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

138 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

139 .
	gtimî
 = &
©91rm9200_timî
,

140 .
	gm≠_io
 = 
kb9202_m≠_io
,

141 .
	göô_úq
 = 
kb9202_öô_úq
,

142 .
	göô_machöe
 = 
kb9202_bﬂrd_öô
,

143 
	gMACHINE_END


	@arch/arm/mach-at91/board-picotux200.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<löux/•i/•i.h
>

28 
	~<löux/mtd/physm≠.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/úq.h
>

35 
	~<asm/mach/¨ch.h
>

36 
	~<asm/mach/m≠.h
>

37 
	~<asm/mach/úq.h
>

39 
	~<asm/¨ch/bﬂrd.h
>

40 
	~<asm/¨ch/gpio.h
>

41 
	~<asm/¨ch/©91rm9200_mc.h
>

43 
	~"gíîic.h
"

51 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gpicŸux200_u¨t_c⁄fig
 = {

52 .
c⁄sﬁe_ây
 = 0,

53 .
	gƒ_ây
 = 2,

54 .
	gây_m≠
 = { 4, 1, -1, -1, -1 }

57 
__öô
 
	$picŸux200_m≠_io
()

60 
	`©91rm9200_öôülize
(18432000, 
AT91RM9200_BGA
);

63 
	`©91_öô_£rül
(&
picŸux200_u¨t_c⁄fig
);

64 
	}
}

66 
__öô
 
	$picŸux200_öô_úq
()

68 
	`©91rm9200_öô_öãºu±s
(
NULL
);

69 
	}
}

71 
©91_ëh_d©a
 
__öôd©a
 
	gpicŸux200_ëh_d©a
 = {

72 .
phy_úq_pö
 = 
AT91_PIN_PC4
,

73 .
	gis_rmii
 = 1,

76 
©91_usbh_d©a
 
__öôd©a
 
	gpicŸux200_usbh_d©a
 = {

77 .
p‹ts
 = 1,

85 
©91_mmc_d©a
 
__öôd©a
 
	gpicŸux200_mmc_d©a
 = {

86 .
dë_pö
 = 
AT91_PIN_PB27
,

87 .
	g¶Ÿ_b
 = 0,

88 .
	gwúe4
 = 1,

89 .
	gwp_pö
 = 
AT91_PIN_PA17
,

107 
	#PICOTUX200_FLASH_BASE
 
AT91_CHIPSELECT_0


	)

108 
	#PICOTUX200_FLASH_SIZE
 0x400000

	)

110 
physm≠_Êash_d©a
 
	gpicŸux200_Êash_d©a
 = {

111 .
width
 = 2,

114 
ªsour˚
 
	gpicŸux200_Êash_ªsour˚
 = {

115 .
°¨t
 = 
PICOTUX200_FLASH_BASE
,

116 .
	gíd
 = 
PICOTUX200_FLASH_BASE
 + 
PICOTUX200_FLASH_SIZE
 - 1,

117 .
	gÊags
 = 
IORESOURCE_MEM
,

120 
∂©f‹m_devi˚
 
	gpicŸux200_Êash
 = {

121 .
«me
 = "physmap-flash",

122 .
	gid
 = 0,

123 .
	gdev
 = {

124 .
∂©f‹m_d©a
 = &
picŸux200_Êash_d©a
,

126 .
	gªsour˚
 = &
picŸux200_Êash_ªsour˚
,

127 .
	gnum_ªsour˚s
 = 1,

130 
__öô
 
	$picŸux200_bﬂrd_öô
()

133 
	`©91_add_devi˚_£rül
();

135 
	`©91_add_devi˚_ëh
(&
picŸux200_ëh_d©a
);

137 
	`©91_add_devi˚_usbh
(&
picŸux200_usbh_d©a
);

142 
	`©91_add_devi˚_i2c
();

145 #ifde‡
CONFIG_MTD_AT91_DATAFLASH_CARD


147 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB22
, 0);

150 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PB22
, 1);

151 
	`©91_add_devi˚_mmc
(0, &
picŸux200_mmc_d©a
);

154 
	`∂©f‹m_devi˚_ªgi°î
(&
picŸux200_Êash
);

155 
	}
}

157 
MACHINE_START
(
PICOTUX2XX
, "picotux 200")

159 .
	gphys_io
 = 
AT91_BASE_SYS
,

160 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

161 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

162 .
	gtimî
 = &
©91rm9200_timî
,

163 .
	gm≠_io
 = 
picŸux200_m≠_io
,

164 .
	göô_úq
 = 
picŸux200_öô_úq
,

165 .
	göô_machöe
 = 
picŸux200_bﬂrd_öô
,

166 
	gMACHINE_END


	@arch/arm/mach-at91/board-sam9260ek.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<löux/•i/•i.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/úq.h
>

34 
	~<asm/mach/¨ch.h
>

35 
	~<asm/mach/m≠.h
>

36 
	~<asm/mach/úq.h
>

38 
	~<asm/¨ch/bﬂrd.h
>

39 
	~<asm/¨ch/gpio.h
>

40 
	~<asm/¨ch/©91ßm926x_mc.h
>

42 
	~"gíîic.h
"

50 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gek_u¨t_c⁄fig
 = {

51 .
c⁄sﬁe_ây
 = 0,

52 .
	gƒ_ây
 = 3,

53 .
	gây_m≠
 = { 6, 0, 1, -1, -1, -1, -1 }

56 
__öô
 
	$ek_m≠_io
()

59 
	`©91ßm9260_öôülize
(18432000);

62 
	`©91_öô_£rül
(&
ek_u¨t_c⁄fig
);

63 
	}
}

65 
__öô
 
	$ek_öô_úq
()

67 
	`©91ßm9260_öô_öãºu±s
(
NULL
);

68 
	}
}

74 
©91_usbh_d©a
 
__öôd©a
 
	gek_usbh_d©a
 = {

75 .
p‹ts
 = 2,

81 
©91_udc_d©a
 
__öôd©a
 
	gek_udc_d©a
 = {

82 .
vbus_pö
 = 
AT91_PIN_PC5
,

83 .
	gpuŒup_pö
 = 0,

90 
•i_bﬂrd_öfo
 
	gek_•i_devi˚s
[] = {

91 #i‡!
deföed
(
CONFIG_MMC_AT91
)

93 .
modÆüs
 = "mtd_dataflash",

94 .
	gchù_£À˘
 = 1,

95 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

96 .
	gbus_num
 = 0,

98 #i‡
deföed
(
CONFIG_MTD_AT91_DATAFLASH_CARD
)

100 .
	gmodÆüs
 = "mtd_dataflash",

101 .
	gchù_£À˘
 = 0,

102 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

103 .
	gbus_num
 = 0,

107 #i‡
deföed
(
CONFIG_SND_AT73C213
Ë|| deföed(
CONFIG_SND_AT73C213_MODULE
)

109 .
	gmodÆüs
 = "at73c213",

110 .
	gchù_£À˘
 = 0,

111 .
	gmax_•ìd_hz
 = 10 * 1000 * 1000,

112 .
	gbus_num
 = 1,

121 
©91_ëh_d©a
 
__öôd©a
 
	gek_macb_d©a
 = {

122 .
phy_úq_pö
 = 
AT91_PIN_PA7
,

123 .
	gis_rmii
 = 1,

130 
mtd_∑πôi⁄
 
__öôd©a
 
	gek_«nd_∑πôi⁄
[] = {

132 .
«me
 = "Partition 1",

133 .
	goff£t
 = 0,

134 .
	gsize
 = 256 * 1024,

137 .
	g«me
 = "Partition 2",

138 .
	goff£t
 = 256 * 1024,

139 .
	gsize
 = 
MTDPART_SIZ_FULL
,

143 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

145 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
ek_«nd_∑πôi⁄
);

146  
ek_«nd_∑πôi⁄
;

147 
	}
}

149 
©91_«nd_d©a
 
__öôd©a
 
	gek_«nd_d©a
 = {

150 .
Æe
 = 21,

151 .
	g˛e
 = 22,

153 .
	grdy_pö
 = 
AT91_PIN_PC13
,

154 .
	gíabÀ_pö
 = 
AT91_PIN_PC14
,

155 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

156 #i‡
deföed
(
CONFIG_MTD_NAND_AT91_BUSWIDTH_16
)

157 .
	gbus_width_16
 = 1,

159 .
	gbus_width_16
 = 0,

167 
©91_mmc_d©a
 
__öôd©a
 
	gek_mmc_d©a
 = {

168 .
¶Ÿ_b
 = 1,

169 .
	gwúe4
 = 1,

175 
__öô
 
	$ek_bﬂrd_öô
()

178 
	`©91_add_devi˚_£rül
();

180 
	`©91_add_devi˚_usbh
(&
ek_usbh_d©a
);

182 
	`©91_add_devi˚_udc
(&
ek_udc_d©a
);

184 
	`©91_add_devi˚_•i
(
ek_•i_devi˚s
, 
	`ARRAY_SIZE
(ek_spi_devices));

186 
	`©91_add_devi˚_«nd
(&
ek_«nd_d©a
);

188 
	`©91_add_devi˚_ëh
(&
ek_macb_d©a
);

190 
	`©91_add_devi˚_mmc
(0, &
ek_mmc_d©a
);

192 
	`©91_add_devi˚_i2c
();

193 
	}
}

195 
MACHINE_START
(
AT91SAM9260EK
, "Atmel AT91SAM9260-EK")

197 .
	gphys_io
 = 
AT91_BASE_SYS
,

198 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

199 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

200 .
	gtimî
 = &
©91ßm926x_timî
,

201 .
	gm≠_io
 = 
ek_m≠_io
,

202 .
	göô_úq
 = 
ek_öô_úq
,

203 .
	göô_machöe
 = 
ek_bﬂrd_öô
,

204 
	gMACHINE_END


	@arch/arm/mach-at91/board-sam9261ek.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<löux/•i/•i.h
>

28 
	~<löux/•i/ads7846.h
>

29 
	~<löux/dm9000.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/£tup.h
>

33 
	~<asm/mach-ty≥s.h
>

34 
	~<asm/úq.h
>

36 
	~<asm/mach/¨ch.h
>

37 
	~<asm/mach/m≠.h
>

38 
	~<asm/mach/úq.h
>

40 
	~<asm/¨ch/bﬂrd.h
>

41 
	~<asm/¨ch/gpio.h
>

42 
	~<asm/¨ch/©91ßm926x_mc.h
>

44 
	~"gíîic.h
"

52 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gek_u¨t_c⁄fig
 = {

53 .
c⁄sﬁe_ây
 = 0,

54 .
	gƒ_ây
 = 1,

55 .
	gây_m≠
 = { 3, -1, -1, -1 }

58 
__öô
 
	$ek_m≠_io
()

61 
	`©91ßm9261_öôülize
(18432000);

64 
	`©91_öô_Àds
(
AT91_PIN_PA13
, 
AT91_PIN_PA14
);

67 
	`©91_öô_£rül
(&
ek_u¨t_c⁄fig
);

68 
	}
}

70 
__öô
 
	$ek_öô_úq
()

72 
	`©91ßm9261_öô_öãºu±s
(
NULL
);

73 
	}
}

79 #i‡
deföed
(
CONFIG_DM9000
)

80 
ªsour˚
 
	g©91ßm9261_dm9000_ªsour˚
[] = {

82 .
°¨t
 = 
AT91_CHIPSELECT_2
,

83 .
	gíd
 = 
AT91_CHIPSELECT_2
 + 3,

84 .
	gÊags
 = 
IORESOURCE_MEM


87 .
°¨t
 = 
AT91_CHIPSELECT_2
 + 0x44,

88 .
	gíd
 = 
AT91_CHIPSELECT_2
 + 0xFF,

89 .
	gÊags
 = 
IORESOURCE_MEM


92 .
°¨t
 = 
AT91_PIN_PC11
,

93 .
	gíd
 = 
AT91_PIN_PC11
,

94 .
	gÊags
 = 
IORESOURCE_IRQ


98 
dm9000_∂©_d©a
 
	gdm9000_∂©d©a
 = {

99 .
Êags
 = 
DM9000_PLATF_16BITONLY
,

102 
∂©f‹m_devi˚
 
	g©91ßm9261_dm9000_devi˚
 = {

103 .
«me
 = "dm9000",

104 .
	gid
 = 0,

105 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
©91ßm9261_dm9000_ªsour˚
),

106 .
	gªsour˚
 = 
©91ßm9261_dm9000_ªsour˚
,

107 .
	gdev
 = {

108 .
∂©f‹m_d©a
 = &
dm9000_∂©d©a
,

112 
__öô
 
	$ek_add_devi˚_dm9000
()

119 
	`©91_sys_wrôe
(
	`AT91_SMC_SETUP
(2), 
	`AT91_SMC_NWESETUP_
(2Ë| 
	`AT91_SMC_NCS_WRSETUP_
(0Ë| 
	`AT91_SMC_NRDSETUP_
(2Ë| 
	`AT91_SMC_NCS_RDSETUP_
(0));

120 
	`©91_sys_wrôe
(
	`AT91_SMC_PULSE
(2), 
	`AT91_SMC_NWEPULSE_
(4Ë| 
	`AT91_SMC_NCS_WRPULSE_
(8Ë| 
	`AT91_SMC_NRDPULSE_
(4Ë| 
	`AT91_SMC_NCS_RDPULSE_
(8));

121 
	`©91_sys_wrôe
(
	`AT91_SMC_CYCLE
(2), 
	`AT91_SMC_NWECYCLE_
(16Ë| 
	`AT91_SMC_NRDCYCLE_
(16));

122 
	`©91_sys_wrôe
(
	`AT91_SMC_MODE
(2), 
AT91_SMC_READMODE
 | 
AT91_SMC_WRITEMODE
 | 
AT91_SMC_EXNWMODE_DISABLE
 | 
AT91_SMC_BAT_WRITE
 | 
AT91_SMC_DBW_16
 | 
	`AT91_SMC_TDF_
(1));

125 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PC10
, 0);

128 
	`©91_£t_gpio_öput
(
AT91_PIN_PC11
, 0);

130 
	`∂©f‹m_devi˚_ªgi°î
(&
©91ßm9261_dm9000_devi˚
);

131 
	}
}

133 
__öô
 
	$ek_add_devi˚_dm9000
(Ë{
	}
}

140 
©91_usbh_d©a
 
__öôd©a
 
	gek_usbh_d©a
 = {

141 .
p‹ts
 = 2,

148 
©91_udc_d©a
 
__öôd©a
 
	gek_udc_d©a
 = {

149 .
vbus_pö
 = 
AT91_PIN_PB29
,

150 .
	gpuŒup_pö
 = 0,

157 
©91_mmc_d©a
 
__öôd©a
 
	gek_mmc_d©a
 = {

158 .
wúe4
 = 1,

168 
mtd_∑πôi⁄
 
__öôd©a
 
	gek_«nd_∑πôi⁄
[] = {

170 .
«me
 = "Partition 1",

171 .
	goff£t
 = 0,

172 .
	gsize
 = 256 * 1024,

175 .
	g«me
 = "Partition 2",

176 .
	goff£t
 = 256 * 1024 ,

177 .
	gsize
 = 
MTDPART_SIZ_FULL
,

181 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

183 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
ek_«nd_∑πôi⁄
);

184  
ek_«nd_∑πôi⁄
;

185 
	}
}

187 
©91_«nd_d©a
 
__öôd©a
 
	gek_«nd_d©a
 = {

188 .
Æe
 = 22,

189 .
	g˛e
 = 21,

191 .
	grdy_pö
 = 
AT91_PIN_PC15
,

192 .
	gíabÀ_pö
 = 
AT91_PIN_PC14
,

193 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

194 #i‡
deföed
(
CONFIG_MTD_NAND_AT91_BUSWIDTH_16
)

195 .
	gbus_width_16
 = 1,

197 .
	gbus_width_16
 = 0,

204 #i‡
deföed
(
CONFIG_TOUCHSCREEN_ADS7846
Ë|| deföed(
CONFIG_TOUCHSCREEN_ADS7846_MODULE
)

206 
	$ads7843_≥ndown_°©e
()

208  !
	`©91_gë_gpio_vÆue
(
AT91_PIN_PC2
);

209 
	}
}

211 
ads7846_∂©f‹m_d©a
 
	gads_öfo
 = {

212 .
modñ
 = 7843,

213 .
	gx_mö
 = 150,

214 .
	gx_max
 = 3830,

215 .
	gy_mö
 = 190,

216 .
	gy_max
 = 3830,

217 .
	gvªf_dñay_u£cs
 = 100,

218 .
	gx_∂©e_ohms
 = 450,

219 .
	gy_∂©e_ohms
 = 250,

220 .
	g¥essuª_max
 = 15000,

221 .
	gdeboun˚_max
 = 1,

222 .
	gdeboun˚_ªp
 = 0,

223 .
	gdeboun˚_tﬁ
 = (~0),

224 .
	ggë_≥ndown_°©e
 = 
ads7843_≥ndown_°©e
,

227 
__öô
 
	$ek_add_devi˚_ts
()

229 
	`©91_£t_B_≥rùh
(
AT91_PIN_PC2
, 1);

230 
	`©91_£t_gpio_öput
(
AT91_PIN_PA11
, 1);

231 
	}
}

233 
__öô
 
	$ek_add_devi˚_ts
(Ë{
	}
}

239 
•i_bﬂrd_öfo
 
	gek_•i_devi˚s
[] = {

241 .
modÆüs
 = "mtd_dataflash",

242 .
	gchù_£À˘
 = 0,

243 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

244 .
	gbus_num
 = 0,

246 #i‡
deföed
(
CONFIG_TOUCHSCREEN_ADS7846
Ë|| deföed(
CONFIG_TOUCHSCREEN_ADS7846_MODULE
)

248 .
	gmodÆüs
 = "ads7846",

249 .
	gchù_£À˘
 = 2,

250 .
	gmax_•ìd_hz
 = 125000 * 26,

251 .
	gbus_num
 = 0,

252 .
	g∂©f‹m_d©a
 = &
ads_öfo
,

253 .
	gúq
 = 
AT91SAM9261_ID_IRQ0
,

256 #i‡
deföed
(
CONFIG_MTD_AT91_DATAFLASH_CARD
)

258 .
	gmodÆüs
 = "mtd_dataflash",

259 .
	gchù_£À˘
 = 3,

260 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

261 .
	gbus_num
 = 0,

263 #ñi‡
deföed
(
CONFIG_SND_AT73C213
Ë|| deföed(
CONFIG_SND_AT73C213_MODULE
)

265 .
	gmodÆüs
 = "at73c213",

266 .
	gchù_£À˘
 = 3,

267 .
	gmax_•ìd_hz
 = 10 * 1000 * 1000,

268 .
	gbus_num
 = 0,

274 
__öô
 
	$ek_bﬂrd_öô
()

277 
	`©91_add_devi˚_£rül
();

279 
	`©91_add_devi˚_usbh
(&
ek_usbh_d©a
);

281 
	`©91_add_devi˚_udc
(&
ek_udc_d©a
);

283 
	`©91_add_devi˚_i2c
();

285 
	`©91_add_devi˚_«nd
(&
ek_«nd_d©a
);

287 
	`ek_add_devi˚_dm9000
();

290 #i‡
	`deföed
(
CONFIG_SPI_ATMEL
Ë|| deföed(
CONFIG_SPI_ATMEL_MODULE
)

292 
	`©91_add_devi˚_•i
(
ek_•i_devi˚s
, 
	`ARRAY_SIZE
(ek_spi_devices));

294 
	`ek_add_devi˚_ts
();

297 
	`©91_add_devi˚_mmc
(0, &
ek_mmc_d©a
);

299 
	}
}

301 
MACHINE_START
(
AT91SAM9261EK
, "Atmel AT91SAM9261-EK")

303 .
	gphys_io
 = 
AT91_BASE_SYS
,

304 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

305 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

306 .
	gtimî
 = &
©91ßm926x_timî
,

307 .
	gm≠_io
 = 
ek_m≠_io
,

308 .
	göô_úq
 = 
ek_öô_úq
,

309 .
	göô_machöe
 = 
ek_bﬂrd_öô
,

310 
	gMACHINE_END


	@arch/arm/mach-at91/board-sam9263ek.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/mm.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<löux/•i/•i.h
>

28 
	~<löux/•i/ads7846.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/úq.h
>

35 
	~<asm/mach/¨ch.h
>

36 
	~<asm/mach/m≠.h
>

37 
	~<asm/mach/úq.h
>

39 
	~<asm/¨ch/bﬂrd.h
>

40 
	~<asm/¨ch/gpio.h
>

41 
	~<asm/¨ch/©91ßm926x_mc.h
>

43 
	~"gíîic.h
"

51 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gek_u¨t_c⁄fig
 = {

52 .
c⁄sﬁe_ây
 = 0,

53 .
	gƒ_ây
 = 2,

54 .
	gây_m≠
 = { 3, 0, -1, -1, }

57 
__öô
 
	$ek_m≠_io
()

60 
	`©91ßm9263_öôülize
(16367660);

63 
	`©91_öô_£rül
(&
ek_u¨t_c⁄fig
);

64 
	}
}

66 
__öô
 
	$ek_öô_úq
()

68 
	`©91ßm9263_öô_öãºu±s
(
NULL
);

69 
	}
}

75 
©91_usbh_d©a
 
__öôd©a
 
	gek_usbh_d©a
 = {

76 .
p‹ts
 = 2,

77 .
	gvbus_pö
 = { 
AT91_PIN_PA24
, 
AT91_PIN_PA21
 },

83 
©91_udc_d©a
 
__öôd©a
 
	gek_udc_d©a
 = {

84 .
vbus_pö
 = 
AT91_PIN_PA25
,

85 .
	gpuŒup_pö
 = 0,

92 #i‡
deföed
(
CONFIG_TOUCHSCREEN_ADS7846
Ë|| deföed(
CONFIG_TOUCHSCREEN_ADS7846_MODULE
)

93 
	$ads7843_≥ndown_°©e
()

95  !
	`©91_gë_gpio_vÆue
(
AT91_PIN_PA15
);

96 
	}
}

98 
ads7846_∂©f‹m_d©a
 
	gads_öfo
 = {

99 .
modñ
 = 7843,

100 .
	gx_mö
 = 150,

101 .
	gx_max
 = 3830,

102 .
	gy_mö
 = 190,

103 .
	gy_max
 = 3830,

104 .
	gvªf_dñay_u£cs
 = 100,

105 .
	gx_∂©e_ohms
 = 450,

106 .
	gy_∂©e_ohms
 = 250,

107 .
	g¥essuª_max
 = 15000,

108 .
	gdeboun˚_max
 = 1,

109 .
	gdeboun˚_ªp
 = 0,

110 .
	gdeboun˚_tﬁ
 = (~0),

111 .
	ggë_≥ndown_°©e
 = 
ads7843_≥ndown_°©e
,

114 
__öô
 
	$ek_add_devi˚_ts
()

116 
	`©91_£t_B_≥rùh
(
AT91_PIN_PA15
, 1);

117 
	`©91_£t_gpio_öput
(
AT91_PIN_PA31
, 1);

118 
	}
}

120 
__öô
 
	$ek_add_devi˚_ts
(Ë{
	}
}

126 
•i_bﬂrd_öfo
 
	gek_•i_devi˚s
[] = {

127 #i‡
deföed
(
CONFIG_MTD_AT91_DATAFLASH_CARD
)

129 .
modÆüs
 = "mtd_dataflash",

130 .
	gchù_£À˘
 = 0,

131 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

132 .
	gbus_num
 = 0,

135 #i‡
deföed
(
CONFIG_TOUCHSCREEN_ADS7846
Ë|| deföed(
CONFIG_TOUCHSCREEN_ADS7846_MODULE
)

137 .
	gmodÆüs
 = "ads7846",

138 .
	gchù_£À˘
 = 3,

139 .
	gmax_•ìd_hz
 = 125000 * 26,

140 .
	gbus_num
 = 0,

141 .
	g∂©f‹m_d©a
 = &
ads_öfo
,

142 .
	gúq
 = 
AT91SAM9263_ID_IRQ1
,

151 
©91_mmc_d©a
 
__öôd©a
 
	gek_mmc_d©a
 = {

152 .
wúe4
 = 1,

153 .
	gdë_pö
 = 
AT91_PIN_PE18
,

154 .
	gwp_pö
 = 
AT91_PIN_PE19
,

162 
©91_ëh_d©a
 
__öôd©a
 
	gek_macb_d©a
 = {

163 .
is_rmii
 = 1,

170 
mtd_∑πôi⁄
 
__öôd©a
 
	gek_«nd_∑πôi⁄
[] = {

172 .
«me
 = "Partition 1",

173 .
	goff£t
 = 0,

174 .
	gsize
 = 64 * 1024 * 1024,

177 .
	g«me
 = "Partition 2",

178 .
	goff£t
 = 64 * 1024 * 1024,

179 .
	gsize
 = 
MTDPART_SIZ_FULL
,

183 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

185 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
ek_«nd_∑πôi⁄
);

186  
ek_«nd_∑πôi⁄
;

187 
	}
}

189 
©91_«nd_d©a
 
__öôd©a
 
	gek_«nd_d©a
 = {

190 .
Æe
 = 21,

191 .
	g˛e
 = 22,

193 .
	grdy_pö
 = 
AT91_PIN_PA22
,

194 .
	gíabÀ_pö
 = 
AT91_PIN_PD15
,

195 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

196 #i‡
deföed
(
CONFIG_MTD_NAND_AT91_BUSWIDTH_16
)

197 .
	gbus_width_16
 = 1,

199 .
	gbus_width_16
 = 0,

207 
©mñ_ac97_d©a
 
	gek_ac97_d©a
 = {

208 .
ª£t_pö
 = 
AT91_PIN_PA13
,

212 
__öô
 
	$ek_bﬂrd_öô
()

215 
	`©91_add_devi˚_£rül
();

217 
	`©91_add_devi˚_usbh
(&
ek_usbh_d©a
);

219 
	`©91_add_devi˚_udc
(&
ek_udc_d©a
);

221 
	`©91_£t_gpio_ouçut
(
AT91_PIN_PE20
, 1);

222 
	`©91_add_devi˚_•i
(
ek_•i_devi˚s
, 
	`ARRAY_SIZE
(ek_spi_devices));

224 
	`ek_add_devi˚_ts
();

226 
	`©91_add_devi˚_mmc
(1, &
ek_mmc_d©a
);

228 
	`©91_add_devi˚_ëh
(&
ek_macb_d©a
);

230 
	`©91_add_devi˚_«nd
(&
ek_«nd_d©a
);

232 
	`©91_add_devi˚_i2c
();

234 
	`©91_add_devi˚_ac97
(&
ek_ac97_d©a
);

235 
	}
}

237 
MACHINE_START
(
AT91SAM9263EK
, "Atmel AT91SAM9263-EK")

239 .
	gphys_io
 = 
AT91_BASE_SYS
,

240 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

241 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

242 .
	gtimî
 = &
©91ßm926x_timî
,

243 .
	gm≠_io
 = 
ek_m≠_io
,

244 .
	göô_úq
 = 
ek_öô_úq
,

245 .
	göô_machöe
 = 
ek_bﬂrd_öô
,

246 
	gMACHINE_END


	@arch/arm/mach-at91/board-sam9rlek.c

10 
	~<löux/ty≥s.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/∂©f‹m_devi˚.h
>

15 
	~<löux/•i/•i.h
>

16 
	~<löux/fb.h
>

17 
	~<löux/˛k.h
>

19 
	~<video/©mñ_lcdc.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/£tup.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/úq.h
>

26 
	~<asm/mach/¨ch.h
>

27 
	~<asm/mach/m≠.h
>

28 
	~<asm/mach/úq.h
>

30 
	~<asm/¨ch/bﬂrd.h
>

31 
	~<asm/¨ch/gpio.h
>

32 
	~<asm/¨ch/©91ßm926x_mc.h
>

34 
	~"gíîic.h
"

42 
©91_u¨t_c⁄fig
 
__öôd©a
 
	gek_u¨t_c⁄fig
 = {

43 .
c⁄sﬁe_ây
 = 0,

44 .
	gƒ_ây
 = 2,

45 .
	gây_m≠
 = { 4, 0, -1, -1, -1 }

48 
__öô
 
	$ek_m≠_io
()

51 
	`©91ßm9æ_öôülize
(12000000);

54 
	`©91_öô_£rül
(&
ek_u¨t_c⁄fig
);

55 
	}
}

57 
__öô
 
	$ek_öô_úq
()

59 
	`©91ßm9æ_öô_öãºu±s
(
NULL
);

60 
	}
}

66 
©91_mmc_d©a
 
__öôd©a
 
	gek_mmc_d©a
 = {

67 .
wúe4
 = 1,

68 .
	gdë_pö
 = 
AT91_PIN_PA15
,

77 
mtd_∑πôi⁄
 
__öôd©a
 
	gek_«nd_∑πôi⁄
[] = {

79 .
«me
 = "Partition 1",

80 .
	goff£t
 = 0,

81 .
	gsize
 = 256 * 1024,

84 .
	g«me
 = "Partition 2",

85 .
	goff£t
 = 256 * 1024 ,

86 .
	gsize
 = 
MTDPART_SIZ_FULL
,

90 
mtd_∑πôi⁄
 * 
__öô
 
	$«nd_∑πôi⁄s
(
size
, *
num_∑πôi⁄s
)

92 *
num_∑πôi⁄s
 = 
	`ARRAY_SIZE
(
ek_«nd_∑πôi⁄
);

93  
ek_«nd_∑πôi⁄
;

94 
	}
}

96 
©91_«nd_d©a
 
__öôd©a
 
	gek_«nd_d©a
 = {

97 .
Æe
 = 21,

98 .
	g˛e
 = 22,

100 .
	grdy_pö
 = 
AT91_PIN_PD17
,

101 .
	gíabÀ_pö
 = 
AT91_PIN_PB6
,

102 .
	g∑πôi⁄_öfo
 = 
«nd_∑πôi⁄s
,

103 .
	gbus_width_16
 = 0,

110 
•i_bﬂrd_öfo
 
	gek_•i_devi˚s
[] = {

112 .
modÆüs
 = "mtd_dataflash",

113 .
	gchù_£À˘
 = 0,

114 .
	gmax_•ìd_hz
 = 15 * 1000 * 1000,

115 .
	gbus_num
 = 0,

123 #i‡
deföed
(
CONFIG_FB_ATMEL
Ë|| deföed(
CONFIG_FB_ATMEL_MODULE
)

124 
fb_videomode
 
	g©91_t·_vga_modes
[] = {

126 .
«me
 = "TX09D50VM1CCA @ 60",

127 .
	gª‰esh
 = 60,

128 .
	gxªs
 = 240, .
	gyªs
 = 320,

129 .
	gpix˛ock
 = 
KHZ2PICOS
(4965),

131 .
	gÀ·_m¨gö
 = 1, .
	gright_m¨gö
 = 33,

132 .
	guµî_m¨gö
 = 1, .
	glowî_m¨gö
 = 0,

133 .
	ghsync_Àn
 = 5, .
	gvsync_Àn
 = 1,

135 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

136 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

140 
fb_m⁄•ecs
 
	g©91fb_deÁu…_m⁄•ecs
 = {

141 .
m™uÁ˘uªr
 = "HIT",

142 .
	gm⁄ô‹
 = "TX09D50VM1CCA",

144 .
	gmodedb
 = 
©91_t·_vga_modes
,

145 .
	gmodedb_Àn
 = 
ARRAY_SIZE
(
©91_t·_vga_modes
),

146 .
	ghfmö
 = 15000,

147 .
	ghfmax
 = 64000,

148 .
	gvfmö
 = 50,

149 .
	gvfmax
 = 150,

152 
	#AT91SAM9RL_DEFAULT_LCDCON2
 (
ATMEL_LCDC_MEMOR_LITTLE
 \

153 | 
ATMEL_LCDC_DISTYPE_TFT
 \

154 | 
ATMEL_LCDC_CLKMOD_ALWAYSACTIVE
)

	)

156 
	$©91_lcdc_powî_c⁄åﬁ
(
⁄
)

158 i‡(
⁄
)

159 
	`©91_£t_gpio_vÆue
(
AT91_PIN_PA30
, 0);

161 
	`©91_£t_gpio_vÆue
(
AT91_PIN_PA30
, 1);

162 
	}
}

165 
©mñ_lcdfb_öfo
 
__öôd©a
 
	gek_lcdc_d©a
 = {

166 .
deÁu…_bµ
 = 16,

167 .
	gdeÁu…_dmac⁄
 = 
ATMEL_LCDC_DMAEN
,

168 .
	gdeÁu…_lcdc⁄2
 = 
AT91SAM9RL_DEFAULT_LCDCON2
,

169 .
	gdeÁu…_m⁄•ecs
 = &
©91fb_deÁu…_m⁄•ecs
,

170 .
	g©mñ_lcdfb_powî_c⁄åﬁ
 = 
©91_lcdc_powî_c⁄åﬁ
,

171 .
	ggu¨d_time
 = 1,

175 
©mñ_lcdfb_öfo
 
__öôd©a
 
	gek_lcdc_d©a
;

179 
__öô
 
	$ek_bﬂrd_öô
()

182 
	`©91_add_devi˚_£rül
();

184 
	`©91_add_devi˚_i2c
();

186 
	`©91_add_devi˚_«nd
(&
ek_«nd_d©a
);

188 
	`©91_add_devi˚_•i
(
ek_•i_devi˚s
, 
	`ARRAY_SIZE
(ek_spi_devices));

190 
	`©91_add_devi˚_mmc
(0, &
ek_mmc_d©a
);

192 
	`©91_add_devi˚_lcdc
(&
ek_lcdc_d©a
);

193 
	}
}

195 
MACHINE_START
(
AT91SAM9RLEK
, "Atmel AT91SAM9RL-EK")

197 .
	gphys_io
 = 
AT91_BASE_SYS
,

198 .
	gio_pg_off°
 = (
AT91_VA_BASE_SYS
 >> 18) & 0xfffc,

199 .
	gboŸ_∑øms
 = 
AT91_SDRAM_BASE
 + 0x100,

200 .
	gtimî
 = &
©91ßm926x_timî
,

201 .
	gm≠_io
 = 
ek_m≠_io
,

202 .
	göô_úq
 = 
ek_öô_úq
,

203 .
	göô_machöe
 = 
ek_bﬂrd_öô
,

204 
	gMACHINE_END


	@arch/arm/mach-at91/clock.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/fs.h
>

17 
	~<löux/debugfs.h
>

18 
	~<löux/£q_fûe.h
>

19 
	~<löux/li°.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/îr.h
>

22 
	~<löux/•ölock.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/˛k.h
>

26 
	~<asm/£m≠h‹e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/¨ch/©91_pmc.h
>

32 
	~<asm/¨ch/˝u.h
>

34 
	~"˛ock.h
"

43 
	#˛k_is_¥im¨y
(
x
Ë((x)->
ty≥
 & 
CLK_TYPE_PRIMARY
)

	)

44 
	#˛k_is_¥ogømmabÀ
(
x
Ë((x)->
ty≥
 & 
CLK_TYPE_PROGRAMMABLE
)

	)

45 
	#˛k_is_≥rùhîÆ
(
x
Ë((x)->
ty≥
 & 
CLK_TYPE_PERIPHERAL
)

	)

46 
	#˛k_is_sys
(
x
Ë((x)->
ty≥
 & 
CLK_TYPE_SYSTEM
)

	)

49 
LIST_HEAD
(
˛ocks
);

50 
DEFINE_SPINLOCK
(
˛k_lock
);

52 
u32
 
	g©91_∂lb_usb_öô
;

60 
˛k
 
	g˛k32k
 = {

61 .
«me
 = "clk32k",

62 .
	gøã_hz
 = 
AT91_SLOW_CLOCK
,

63 .
	gu£rs
 = 1,

64 .
	gid
 = 0,

65 .
	gty≥
 = 
CLK_TYPE_PRIMARY
,

67 
˛k
 
	gmaö_˛k
 = {

68 .
«me
 = "main",

69 .
	gpmc_mask
 = 
AT91_PMC_MOSCS
,

70 .
	gid
 = 1,

71 .
	gty≥
 = 
CLK_TYPE_PRIMARY
,

73 
˛k
 
	g∂œ
 = {

74 .
«me
 = "plla",

75 .
	g∑ª¡
 = &
maö_˛k
,

76 .
	gpmc_mask
 = 
AT91_PMC_LOCKA
,

77 .
	gid
 = 2,

78 .
	gty≥
 = 
CLK_TYPE_PRIMARY
 | 
CLK_TYPE_PLL
,

81 
	$∂lb_mode
(
˛k
 *˛k, 
is_⁄
)

83 
u32
 
vÆue
;

85 i‡(
is_⁄
) {

86 
is_⁄
 = 
AT91_PMC_LOCKB
;

87 
vÆue
 = 
©91_∂lb_usb_öô
;

89 
vÆue
 = 0;

92 
	`©91_sys_wrôe
(
AT91_CKGR_PLLBR
, 
vÆue
);

95 
	`˝u_ªœx
();

96 } (
	`©91_sys_ªad
(
AT91_PMC_SR
Ë& 
AT91_PMC_LOCKB
Ë!
is_⁄
);

97 
	}
}

99 
˛k
 
	g∂lb
 = {

100 .
«me
 = "pllb",

101 .
	g∑ª¡
 = &
maö_˛k
,

102 .
	gpmc_mask
 = 
AT91_PMC_LOCKB
,

103 .
	gmode
 = 
∂lb_mode
,

104 .
	gid
 = 3,

105 .
	gty≥
 = 
CLK_TYPE_PRIMARY
 | 
CLK_TYPE_PLL
,

108 
	$pmc_sys_mode
(
˛k
 *˛k, 
is_⁄
)

110 i‡(
is_⁄
)

111 
	`©91_sys_wrôe
(
AT91_PMC_SCER
, 
˛k
->
pmc_mask
);

113 
	`©91_sys_wrôe
(
AT91_PMC_SCDR
, 
˛k
->
pmc_mask
);

114 
	}
}

117 
˛k
 
	gudpck
 = {

118 .
«me
 = "udpck",

119 .
	g∑ª¡
 = &
∂lb
,

120 .
	gmode
 = 
pmc_sys_mode
,

122 
˛k
 
	guhpck
 = {

123 .
«me
 = "uhpck",

124 .
	g∑ª¡
 = &
∂lb
,

125 .
	gmode
 = 
pmc_sys_mode
,

134 
˛k
 
	gmck
 = {

135 .
«me
 = "mck",

136 .
	gpmc_mask
 = 
AT91_PMC_MCKRDY
,

139 
	$pmc_≥rùh_mode
(
˛k
 *˛k, 
is_⁄
)

141 i‡(
is_⁄
)

142 
	`©91_sys_wrôe
(
AT91_PMC_PCER
, 
˛k
->
pmc_mask
);

144 
	`©91_sys_wrôe
(
AT91_PMC_PCDR
, 
˛k
->
pmc_mask
);

145 
	}
}

147 
˛k
 
__öô
 *
	$©91_css_to_˛k
(
css
)

149 
css
) {

150 
AT91_PMC_CSS_SLOW
:

151  &
˛k32k
;

152 
AT91_PMC_CSS_MAIN
:

153  &
maö_˛k
;

154 
AT91_PMC_CSS_PLLA
:

155  &
∂œ
;

156 
AT91_PMC_CSS_PLLB
:

157  &
∂lb
;

160  
NULL
;

161 
	}
}

168 
__öô
 
	$©91_˛ock_assocüã
(c⁄° *
id
, 
devi˚
 *
dev
, c⁄° *
func
)

170 
˛k
 *˛k = 
	`˛k_gë
(
NULL
, 
id
);

172 i‡(!
dev
 || !
˛k
 || !
	`IS_ERR
(
	`˛k_gë
(dev, 
func
)))

175 
˛k
->
fun˘i⁄
 = 
func
;

176 
˛k
->
dev
 = dev;

177 
	}
}

180 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

182 
˛k
 *clk;

184 
	`li°_f‹_óch_íåy
(
˛k
, &
˛ocks
, 
node
) {

185 i‡(
	`°rcmp
(
id
, 
˛k
->
«me
) == 0)

186  
˛k
;

187 i‡(
˛k
->
fun˘i⁄
 && (
dev
 =˛k->devË&& 
	`°rcmp
(
id
, clk->function) == 0)

188  
˛k
;

191  
	`ERR_PTR
(-
ENOENT
);

192 
	}
}

193 
EXPORT_SYMBOL
(
˛k_gë
);

195 
	$˛k_put
(
˛k
 *clk)

197 
	}
}

198 
EXPORT_SYMBOL
(
˛k_put
);

200 
	$__˛k_íabÀ
(
˛k
 *clk)

202 i‡(
˛k
->
∑ª¡
)

203 
	`__˛k_íabÀ
(
˛k
->
∑ª¡
);

204 i‡(
˛k
->
u£rs
++ =0 && clk->
mode
)

205 
˛k
->
	`mode
(clk, 1);

206 
	}
}

208 
	$˛k_íabÀ
(
˛k
 *clk)

210 
Êags
;

212 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

213 
	`__˛k_íabÀ
(
˛k
);

214 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

216 
	}
}

217 
EXPORT_SYMBOL
(
˛k_íabÀ
);

219 
	$__˛k_dißbÀ
(
˛k
 *clk)

221 
	`BUG_ON
(
˛k
->
u£rs
 == 0);

222 i‡(--
˛k
->
u£rs
 =0 && clk->
mode
)

223 
˛k
->
	`mode
(clk, 0);

224 i‡(
˛k
->
∑ª¡
)

225 
	`__˛k_dißbÀ
(
˛k
->
∑ª¡
);

226 
	}
}

228 
	$˛k_dißbÀ
(
˛k
 *clk)

230 
Êags
;

232 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

233 
	`__˛k_dißbÀ
(
˛k
);

234 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

235 
	}
}

236 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

238 
	$˛k_gë_øã
(
˛k
 *clk)

240 
Êags
;

241 
øã
;

243 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

245 
øã
 = 
˛k
->
øã_hz
;

246 i‡(
øã
 || !
˛k
->
∑ª¡
)

248 
˛k
 = clk->
∑ª¡
;

250 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

251  
øã
;

252 
	}
}

253 
EXPORT_SYMBOL
(
˛k_gë_øã
);

257 #ifde‡
CONFIG_AT91_PROGRAMMABLE_CLOCKS


266 
	$˛k_round_øã
(
˛k
 *˛k, 
øã
)

268 
Êags
;

269 
¥esˇÀ
;

270 
a˘uÆ
;

272 i‡(!
	`˛k_is_¥ogømmabÀ
(
˛k
))

273  -
EINVAL
;

274 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

276 
a˘uÆ
 = 
˛k
->
∑ª¡
->
øã_hz
;

277 
¥esˇÀ
 = 0;Örescale < 7;Örescale++) {

278 i‡(
a˘uÆ
 &&á˘uÆ <
øã
)

280 
a˘uÆ
 >>= 1;

283 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

284  (
¥esˇÀ
 < 7Ë? 
a˘uÆ
 : -
ENOENT
;

285 
	}
}

286 
EXPORT_SYMBOL
(
˛k_round_øã
);

288 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

290 
Êags
;

291 
¥esˇÀ
;

292 
a˘uÆ
;

294 i‡(!
	`˛k_is_¥ogømmabÀ
(
˛k
))

295  -
EINVAL
;

296 i‡(
˛k
->
u£rs
)

297  -
EBUSY
;

298 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

300 
a˘uÆ
 = 
˛k
->
∑ª¡
->
øã_hz
;

301 
¥esˇÀ
 = 0;Örescale < 7;Örescale++) {

302 i‡(
a˘uÆ
 &&á˘uÆ <
øã
) {

303 
u32
 
pckr
;

305 
pckr
 = 
	`©91_sys_ªad
(
	`AT91_PMC_PCKR
(
˛k
->
id
));

306 
pckr
 &
AT91_PMC_CSS_PLLB
;

307 
pckr
 |
¥esˇÀ
 << 2;

308 
	`©91_sys_wrôe
(
	`AT91_PMC_PCKR
(
˛k
->
id
), 
pckr
);

309 
˛k
->
øã_hz
 = 
a˘uÆ
;

312 
a˘uÆ
 >>= 1;

315 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

316  (
¥esˇÀ
 < 7Ë? 
a˘uÆ
 : -
ENOENT
;

317 
	}
}

318 
EXPORT_SYMBOL
(
˛k_£t_øã
);

320 
˛k
 *
	$˛k_gë_∑ª¡
(
˛k
 *clk)

322  
˛k
->
∑ª¡
;

323 
	}
}

324 
EXPORT_SYMBOL
(
˛k_gë_∑ª¡
);

326 
	$˛k_£t_∑ª¡
(
˛k
 *˛k, ˛k *
∑ª¡
)

328 
Êags
;

330 i‡(
˛k
->
u£rs
)

331  -
EBUSY
;

332 i‡(!
	`˛k_is_¥im¨y
(
∑ª¡
Ë|| !
	`˛k_is_¥ogømmabÀ
(
˛k
))

333  -
EINVAL
;

334 
	`•ö_lock_úqßve
(&
˛k_lock
, 
Êags
);

336 
˛k
->
øã_hz
 = 
∑ª¡
->rate_hz;

337 
˛k
->
∑ª¡
 =Öarent;

338 
	`©91_sys_wrôe
(
	`AT91_PMC_PCKR
(
˛k
->
id
), 
∑ª¡
->id);

340 
	`•ö_u∆ock_úqª°‹e
(&
˛k_lock
, 
Êags
);

342 
	}
}

343 
EXPORT_SYMBOL
(
˛k_£t_∑ª¡
);

346 
	$öô_¥ogømmabÀ_˛ock
(
˛k
 *clk)

348 
˛k
 *
∑ª¡
;

349 
u32
 
pckr
;

351 
pckr
 = 
	`©91_sys_ªad
(
	`AT91_PMC_PCKR
(
˛k
->
id
));

352 
∑ª¡
 = 
	`©91_css_to_˛k
(
pckr
 & 
AT91_PMC_CSS
);

353 
˛k
->
∑ª¡
 =Öarent;

354 
˛k
->
øã_hz
 = 
∑ª¡
->øã_hz / (1 << ((
pckr
 >> 2) & 3));

355 
	}
}

361 #ifde‡
CONFIG_DEBUG_FS


363 
	$©91_˛k_show
(
£q_fûe
 *
s
, *
unu£d
)

365 
u32
 
sc§
, 
pc§
, 
§
;

366 
˛k
 *clk;

368 
	`£q_¥ötf
(
s
, "SCSR = %8x\n", 
sc§
 = 
	`©91_sys_ªad
(
AT91_PMC_SCSR
));

369 
	`£q_¥ötf
(
s
, "PCSR = %8x\n", 
pc§
 = 
	`©91_sys_ªad
(
AT91_PMC_PCSR
));

370 
	`£q_¥ötf
(
s
, "MOR = %8x\n", 
	`©91_sys_ªad
(
AT91_CKGR_MOR
));

371 
	`£q_¥ötf
(
s
, "MCFR = %8x\n", 
	`©91_sys_ªad
(
AT91_CKGR_MCFR
));

372 
	`£q_¥ötf
(
s
, "PLLA = %8x\n", 
	`©91_sys_ªad
(
AT91_CKGR_PLLAR
));

373 
	`£q_¥ötf
(
s
, "PLLB = %8x\n", 
	`©91_sys_ªad
(
AT91_CKGR_PLLBR
));

374 
	`£q_¥ötf
(
s
, "MCKR = %8x\n", 
	`©91_sys_ªad
(
AT91_PMC_MCKR
));

375 
	`£q_¥ötf
(
s
, "SR = %8x\n", 
§
 = 
	`©91_sys_ªad
(
AT91_PMC_SR
));

377 
	`£q_¥ötf
(
s
, "\n");

379 
	`li°_f‹_óch_íåy
(
˛k
, &
˛ocks
, 
node
) {

380 *
°©e
;

382 i‡(
˛k
->
mode
 =
pmc_sys_mode
)

383 
°©e
 = (
sc§
 & 
˛k
->
pmc_mask
) ? "on" : "off";

384 i‡(
˛k
->
mode
 =
pmc_≥rùh_mode
)

385 
°©e
 = (
pc§
 & 
˛k
->
pmc_mask
) ? "on" : "off";

386 i‡(
˛k
->
pmc_mask
)

387 
°©e
 = (
§
 & 
˛k
->
pmc_mask
) ? "on" : "off";

388 i‡(
˛k
 =&
˛k32k
 || clk =&
maö_˛k
)

389 
°©e
 = "on";

391 
°©e
 = "";

393 
	`£q_¥ötf
(
s
, "%-10s users=%2d %-3s %9ld Hz %s\n",

394 
˛k
->
«me
, clk->
u£rs
, 
°©e
, 
	`˛k_gë_øã
(clk),

395 
˛k
->
∑ª¡
 ? clk->∑ª¡->
«me
 : "");

398 
	}
}

400 
	$©91_˛k_›í
(
öode
 *öode, 
fûe
 *file)

402  
	`sögÀ_›í
(
fûe
, 
©91_˛k_show
, 
NULL
);

403 
	}
}

405 c⁄° 
fûe_›î©i⁄s
 
	g©91_˛k_›î©i⁄s
 = {

406 .
›í
 = 
©91_˛k_›í
,

407 .
	gªad
 = 
£q_ªad
,

408 .
	gŒ£ek
 = 
£q_l£ek
,

409 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

412 
__öô
 
	$©91_˛k_debugfs_öô
()

415 (Ë
	`debugfs_¸óã_fûe
("©91_˛k", 
S_IFREG
 | 
S_IRUGO
, 
NULL
, NULL, &
©91_˛k_›î©i⁄s
);

418 
	}
}

419 
po°c‹e_öôˇŒ
(
©91_˛k_debugfs_öô
);

426 
__öô
 
	$˛k_ªgi°î
(
˛k
 *clk)

428 i‡(
	`˛k_is_≥rùhîÆ
(
˛k
)) {

429 
˛k
->
∑ª¡
 = &
mck
;

430 
˛k
->
mode
 = 
pmc_≥rùh_mode
;

431 
	`li°_add_èû
(&
˛k
->
node
, &
˛ocks
);

433 i‡(
	`˛k_is_sys
(
˛k
)) {

434 
˛k
->
∑ª¡
 = &
mck
;

435 
˛k
->
mode
 = 
pmc_sys_mode
;

437 
	`li°_add_èû
(&
˛k
->
node
, &
˛ocks
);

439 #ifde‡
CONFIG_AT91_PROGRAMMABLE_CLOCKS


440 i‡(
	`˛k_is_¥ogømmabÀ
(
˛k
)) {

441 
˛k
->
mode
 = 
pmc_sys_mode
;

442 
	`öô_¥ogømmabÀ_˛ock
(
˛k
);

443 
	`li°_add_èû
(&
˛k
->
node
, &
˛ocks
);

448 
	}
}

453 
u32
 
__öô
 
	$©91_∂l_øã
(
˛k
 *
∂l
, 
u32
 
‰eq
, u32 
ªg
)

455 
mul
, 
div
;

457 
div
 = 
ªg
 & 0xff;

458 
mul
 = (
ªg
 >> 16) & 0x7ff;

459 i‡(
div
 && 
mul
) {

460 
‰eq
 /
div
;

461 
‰eq
 *
mul
 + 1;

463 
‰eq
 = 0;

465  
‰eq
;

466 
	}
}

468 
u32
 
__öô
 
	$©91_usb_øã
(
˛k
 *
∂l
, 
u32
 
‰eq
, u32 
ªg
)

470 i‡(
∂l
 =&
∂lb
 && (
ªg
 & 
AT91_PMC_USB96M
))

471  
‰eq
 / 2;

473  
‰eq
;

474 
	}
}

476 
__öô
 
	$©91_∂l_ˇlc
(
maö_‰eq
, 
out_‰eq
)

478 
i
, 
div
 = 0, 
mul
 = 0, 
diff
 = 1 << 30;

479 
ªt
 = (
out_‰eq
 > 155000000) ? 0xbe00 : 0x3e00;

482 i‡(
out_‰eq
 > 240000000)

483 
Áû
;

485 
i
 = 1; i < 256; i++) {

486 
diff1
;

487 
öput
, 
mul1
;

493 
öput
 = 
maö_‰eq
 / 
i
;

494 i‡(
öput
 < 100000)

496 i‡(
öput
 > 32000000)

499 
mul1
 = 
out_‰eq
 / 
öput
;

500 i‡(
mul1
 > 2048)

502 i‡(
mul1
 < 2)

503 
Áû
;

505 
diff1
 = 
out_‰eq
 - 
öput
 * 
mul1
;

506 i‡(
diff1
 < 0)

507 
diff1
 = -diff1;

508 i‡(
diff
 > 
diff1
) {

509 
diff
 = 
diff1
;

510 
div
 = 
i
;

511 
mul
 = 
mul1
;

512 i‡(
diff
 == 0)

516 i‡(
i
 =256 && 
diff
 > (
out_‰eq
 >> 5))

517 
Áû
;

518  
ªt
 | ((
mul
 - 1Ë<< 16Ë| 
div
;

519 
Áû
:

521 
	}
}

523 
˛k
 *c⁄° 
	g°™d¨d_pmc_˛ocks
[] 
	g__öôd©a
 = {

525 &
˛k32k
,

526 &
maö_˛k
,

527 &
∂œ
,

528 &
∂lb
,

531 &
udpck
,

532 &
uhpck
,

535 &
mck


538 
__öô
 
	$©91_˛ock_öô
(
maö_˛ock
)

540 
tmp
, 
‰eq
, 
mckr
;

541 
i
;

549 i‡(!
maö_˛ock
) {

551 
tmp
 = 
	`©91_sys_ªad
(
AT91_CKGR_MCFR
);

552 } !(
tmp
 & 
AT91_PMC_MAINRDY
));

553 
maö_˛ock
 = (
tmp
 & 
AT91_PMC_MAINF
Ë* (
AT91_SLOW_CLOCK
 / 16);

555 
maö_˛k
.
øã_hz
 = 
maö_˛ock
;

558 
∂œ
.
øã_hz
 = 
	`©91_∂l_øã
(&∂œ, 
maö_˛ock
, 
	`©91_sys_ªad
(
AT91_CKGR_PLLAR
));

559 i‡(
∂œ
.
øã_hz
 > 209000000)

560 
	`¥_öfo
("Clocks: PLLA ovî˛ocked, %ld MHz\n", 
∂œ
.
øã_hz
 / 1000000);

568 
©91_∂lb_usb_öô
 = 
	`©91_∂l_ˇlc
(
maö_˛ock
, 48000000 * 2Ë| 
AT91_PMC_USB96M
;

569 
∂lb
.
øã_hz
 = 
	`©91_∂l_øã
(&∂lb, 
maö_˛ock
, 
©91_∂lb_usb_öô
);

570 i‡(
	`˝u_is_©91rm9200
()) {

571 
uhpck
.
pmc_mask
 = 
AT91RM9200_PMC_UHP
;

572 
udpck
.
pmc_mask
 = 
AT91RM9200_PMC_UDP
;

573 
	`©91_sys_wrôe
(
AT91_PMC_SCER
, 
AT91RM9200_PMC_MCKUDP
);

574 } i‡(
	`˝u_is_©91ßm9260
(Ë|| 
	`˝u_is_©91ßm9261
(Ë|| 
	`˝u_is_©91ßm9263
()) {

575 
uhpck
.
pmc_mask
 = 
AT91SAM926x_PMC_UHP
;

576 
udpck
.
pmc_mask
 = 
AT91SAM926x_PMC_UDP
;

578 
	`©91_sys_wrôe
(
AT91_CKGR_PLLBR
, 0);

580 
udpck
.
øã_hz
 = 
	`©91_usb_øã
(&
∂lb
,ÖŒb.øã_hz, 
©91_∂lb_usb_öô
);

581 
uhpck
.
øã_hz
 = 
	`©91_usb_øã
(&
∂lb
,ÖŒb.øã_hz, 
©91_∂lb_usb_öô
);

587 
mckr
 = 
	`©91_sys_ªad
(
AT91_PMC_MCKR
);

588 
mck
.
∑ª¡
 = 
	`©91_css_to_˛k
(
mckr
 & 
AT91_PMC_CSS
);

589 
‰eq
 = 
mck
.
∑ª¡
->
øã_hz
;

590 
‰eq
 /(1 << ((
mckr
 >> 2) & 3));

591 
mck
.
øã_hz
 = 
‰eq
 / (1 + ((
mckr
 >> 8) & 3));

594 
i
 = 0; i < 
	`ARRAY_SIZE
(
°™d¨d_pmc_˛ocks
); i++)

595 
	`li°_add_èû
(&
°™d¨d_pmc_˛ocks
[
i
]->
node
, &
˛ocks
);

598 
	`˛k_íabÀ
(&
mck
);

600 
	`¥ötk
("Clocks: CPU %u MHz, master %u MHz, main %u.%03u MHz\n",

601 
‰eq
 / 1000000, (Ë
mck
.
øã_hz
 / 1000000,

602 (Ë
maö_˛ock
 / 1000000,

603 ((Ë
maö_˛ock
 % 1000000) / 1000);

606 
	}
}

611 
__öô
 
	$©91_˛ock_ª£t
()

613 
pcdr
 = 0;

614 
scdr
 = 0;

615 
˛k
 *clk;

617 
	`li°_f‹_óch_íåy
(
˛k
, &
˛ocks
, 
node
) {

618 i‡(
˛k
->
u£rs
 > 0)

621 i‡(
˛k
->
mode
 =
pmc_≥rùh_mode
)

622 
pcdr
 |
˛k
->
pmc_mask
;

624 i‡(
˛k
->
mode
 =
pmc_sys_mode
)

625 
scdr
 |
˛k
->
pmc_mask
;

627 
	`¥_debug
("Clocks: dißbÀ unu£d %s\n", 
˛k
->
«me
);

630 
	`©91_sys_wrôe
(
AT91_PMC_PCDR
, 
pcdr
);

631 
	`©91_sys_wrôe
(
AT91_PMC_SCDR
, 
scdr
);

634 
	}
}

635 
œã_öôˇŒ
(
©91_˛ock_ª£t
);

	@arch/arm/mach-at91/clock.h

9 
	#CLK_TYPE_PRIMARY
 0x1

	)

10 
	#CLK_TYPE_PLL
 0x2

	)

11 
	#CLK_TYPE_PROGRAMMABLE
 0x4

	)

12 
	#CLK_TYPE_PERIPHERAL
 0x8

	)

13 
	#CLK_TYPE_SYSTEM
 0x10

	)

16 
	s˛k
 {

17 
li°_hód
 
	mnode
;

18 c⁄° *
	m«me
;

19 c⁄° *
	mfun˘i⁄
;

20 
devi˚
 *
	mdev
;

21 
	møã_hz
;

22 
˛k
 *
	m∑ª¡
;

23 
u32
 
	mpmc_mask
;

24 (*
	mmode
)(
	m˛k
 *, );

25 
	mid
:2;

26 
	mty≥
;

27 
u16
 
	mu£rs
;

31 
__öô
 
˛k_ªgi°î
(
˛k
 *clk);

	@arch/arm/mach-at91/generic.h

12 
__öô
 
©91rm9200_öôülize
(
maö_˛ock
, 
b™ks
);

13 
__öô
 
©91ßm9260_öôülize
(
maö_˛ock
);

14 
__öô
 
©91ßm9261_öôülize
(
maö_˛ock
);

15 
__öô
 
©91ßm9263_öôülize
(
maö_˛ock
);

16 
__öô
 
©91ßm9æ_öôülize
(
maö_˛ock
);

19 
__öô
 
©91rm9200_öô_öãºu±s
(
¥i‹ôy
[]);

20 
__öô
 
©91ßm9260_öô_öãºu±s
(
¥i‹ôy
[]);

21 
__öô
 
©91ßm9261_öô_öãºu±s
(
¥i‹ôy
[]);

22 
__öô
 
©91ßm9263_öô_öãºu±s
(
¥i‹ôy
[]);

23 
__öô
 
©91ßm9æ_öô_öãºu±s
(
¥i‹ôy
[]);

24 
__öô
 
©91_aic_öô
(
¥i‹ôy
[]);

27 
	gsys_timî
;

28 
sys_timî
 
©91rm9200_timî
;

29 
sys_timî
 
©91ßm926x_timî
;

32 
__öô
 
©91_˛ock_öô
(
maö_˛ock
);

33 
	gdevi˚
;

34 
__öô
 
©91_˛ock_assocüã
(c⁄° *
id
, 
devi˚
 *
dev
, c⁄° *
func
);

37 
©91_úq_su•íd
();

38 
©91_úq_ªsume
();

41 
	#AT91RM9200_PQFP
 3

	)

42 
	#AT91RM9200_BGA
 4

	)

44 
	s©91_gpio_b™k
 {

45 
	mid
;

46 
	moff£t
;

47 
˛k
 *
	m˛ock
;

49 
__öô
 
©91_gpio_öô
(
©91_gpio_b™k
 *, 
ƒ_b™ks
);

50 
__öô
 
©91_gpio_úq_£tup
();

52 (*
©91_¨ch_ª£t
)();

53 
©91_exã∫_úq
;

	@arch/arm/mach-at91/gpio.c

12 
	~<löux/˛k.h
>

13 
	~<löux/î∫o.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/úq.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/li°.h
>

18 
	~<löux/moduÀ.h
>

20 
	~<asm/io.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/¨ch/©91_pio.h
>

23 
	~<asm/¨ch/gpio.h
>

25 
	~"gíîic.h
"

28 
©91_gpio_b™k
 *
	ggpio
;

29 
	ggpio_b™ks
;

32 
ölöe
 
__iomem
 *
	$pö_to_c⁄åﬁÀr
(
pö
)

34 
__iomem
 *
sys_ba£
 = (__iomem *Ë
AT91_VA_BASE_SYS
;

36 
pö
 -
PIN_BASE
;

37 
pö
 /= 32;

38 i‡(
	`likñy
(
pö
 < 
gpio_b™ks
))

39  
sys_ba£
 + 
gpio
[
pö
].
off£t
;

41  
NULL
;

42 
	}
}

44 
ölöe
 
	$pö_to_mask
(
pö
)

46 
pö
 -
PIN_BASE
;

47  1 << (
pö
 % 32);

48 
	}
}

70 
__öô_‹_moduÀ
 
	$©91_£t_GPIO_≥rùh
(
pö
, 
u£_puŒup
)

72 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

73 
mask
 = 
	`pö_to_mask
(
pö
);

75 i‡(!
pio
)

76  -
EINVAL
;

77 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

78 
	`__øw_wrôñ
(
mask
, 
pio
 + (
u£_puŒup
 ? 
PIO_PUER
 : 
PIO_PUDR
));

79 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PER
);

81 
	}
}

82 
EXPORT_SYMBOL
(
©91_£t_GPIO_≥rùh
);

88 
__öô_‹_moduÀ
 
	$©91_£t_A_≥rùh
(
pö
, 
u£_puŒup
)

90 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

91 
mask
 = 
	`pö_to_mask
(
pö
);

93 i‡(!
pio
)

94  -
EINVAL
;

96 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

97 
	`__øw_wrôñ
(
mask
, 
pio
 + (
u£_puŒup
 ? 
PIO_PUER
 : 
PIO_PUDR
));

98 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_ASR
);

99 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PDR
);

101 
	}
}

102 
EXPORT_SYMBOL
(
©91_£t_A_≥rùh
);

108 
__öô_‹_moduÀ
 
	$©91_£t_B_≥rùh
(
pö
, 
u£_puŒup
)

110 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

111 
mask
 = 
	`pö_to_mask
(
pö
);

113 i‡(!
pio
)

114  -
EINVAL
;

116 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

117 
	`__øw_wrôñ
(
mask
, 
pio
 + (
u£_puŒup
 ? 
PIO_PUER
 : 
PIO_PUDR
));

118 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_BSR
);

119 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PDR
);

121 
	}
}

122 
EXPORT_SYMBOL
(
©91_£t_B_≥rùh
);

129 
__öô_‹_moduÀ
 
	$©91_£t_gpio_öput
(
pö
, 
u£_puŒup
)

131 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

132 
mask
 = 
	`pö_to_mask
(
pö
);

134 i‡(!
pio
)

135  -
EINVAL
;

137 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

138 
	`__øw_wrôñ
(
mask
, 
pio
 + (
u£_puŒup
 ? 
PIO_PUER
 : 
PIO_PUDR
));

139 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_ODR
);

140 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PER
);

142 
	}
}

143 
EXPORT_SYMBOL
(
©91_£t_gpio_öput
);

150 
__öô_‹_moduÀ
 
	$©91_£t_gpio_ouçut
(
pö
, 
vÆue
)

152 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

153 
mask
 = 
	`pö_to_mask
(
pö
);

155 i‡(!
pio
)

156  -
EINVAL
;

158 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

159 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PUDR
);

160 
	`__øw_wrôñ
(
mask
, 
pio
 + (
vÆue
 ? 
PIO_SODR
 : 
PIO_CODR
));

161 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_OER
);

162 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_PER
);

164 
	}
}

165 
EXPORT_SYMBOL
(
©91_£t_gpio_ouçut
);

171 
__öô_‹_moduÀ
 
	$©91_£t_deglôch
(
pö
, 
is_⁄
)

173 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

174 
mask
 = 
	`pö_to_mask
(
pö
);

176 i‡(!
pio
)

177  -
EINVAL
;

178 
	`__øw_wrôñ
(
mask
, 
pio
 + (
is_⁄
 ? 
PIO_IFER
 : 
PIO_IFDR
));

180 
	}
}

181 
EXPORT_SYMBOL
(
©91_£t_deglôch
);

187 
__öô_‹_moduÀ
 
	$©91_£t_mu…i_drive
(
pö
, 
is_⁄
)

189 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

190 
mask
 = 
	`pö_to_mask
(
pö
);

192 i‡(!
pio
)

193  -
EINVAL
;

195 
	`__øw_wrôñ
(
mask
, 
pio
 + (
is_⁄
 ? 
PIO_MDER
 : 
PIO_MDDR
));

197 
	}
}

198 
EXPORT_SYMBOL
(
©91_£t_mu…i_drive
);

206 
	$gpio_dúe˘i⁄_öput
(
pö
)

208 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

209 
mask
 = 
	`pö_to_mask
(
pö
);

211 i‡(!
pio
 || !(
	`__øw_ªadl
’iÿ+ 
PIO_PSR
Ë& 
mask
))

212  -
EINVAL
;

213 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_ODR
);

215 
	}
}

216 
EXPORT_SYMBOL
(
gpio_dúe˘i⁄_öput
);

218 
	$gpio_dúe˘i⁄_ouçut
(
pö
, 
vÆue
)

220 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

221 
mask
 = 
	`pö_to_mask
(
pö
);

223 i‡(!
pio
 || !(
	`__øw_ªadl
’iÿ+ 
PIO_PSR
Ë& 
mask
))

224  -
EINVAL
;

225 
	`__øw_wrôñ
(
mask
, 
pio
 + (
vÆue
 ? 
PIO_SODR
 : 
PIO_CODR
));

226 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_OER
);

228 
	}
}

229 
EXPORT_SYMBOL
(
gpio_dúe˘i⁄_ouçut
);

236 
	$©91_£t_gpio_vÆue
(
pö
, 
vÆue
)

238 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

239 
mask
 = 
	`pö_to_mask
(
pö
);

241 i‡(!
pio
)

242  -
EINVAL
;

243 
	`__øw_wrôñ
(
mask
, 
pio
 + (
vÆue
 ? 
PIO_SODR
 : 
PIO_CODR
));

245 
	}
}

246 
EXPORT_SYMBOL
(
©91_£t_gpio_vÆue
);

252 
	$©91_gë_gpio_vÆue
(
pö
)

254 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

255 
mask
 = 
	`pö_to_mask
(
pö
);

256 
u32
 
pd§
;

258 i‡(!
pio
)

259  -
EINVAL
;

260 
pd§
 = 
	`__øw_ªadl
(
pio
 + 
PIO_PDSR
);

261  (
pd§
 & 
mask
) != 0;

262 
	}
}

263 
EXPORT_SYMBOL
(
©91_gë_gpio_vÆue
);

267 #ifde‡
CONFIG_PM


269 
u32
 
	gwakeups
[
MAX_GPIO_BANKS
];

270 
u32
 
	gbackups
[
MAX_GPIO_BANKS
];

272 
	$gpio_úq_£t_wake
(
pö
, 
°©e
)

274 
mask
 = 
	`pö_to_mask
(
pö
);

275 
b™k
 = (
pö
 - 
PIN_BASE
) / 32;

277 i‡(
	`u∆ikñy
(
b™k
 >
MAX_GPIO_BANKS
))

278  -
EINVAL
;

280 i‡(
°©e
)

281 
wakeups
[
b™k
] |
mask
;

283 
wakeups
[
b™k
] &~
mask
;

285 
	`£t_úq_wake
(
gpio
[
b™k
].
id
, 
°©e
);

288 
	}
}

290 
	$©91_gpio_su•íd
()

292 
i
;

294 
i
 = 0; i < 
gpio_b™ks
; i++) {

295 
u32
 
pio
 = 
gpio
[
i
].
off£t
;

297 
backups
[
i
] = 
	`©91_sys_ªad
(
pio
 + 
PIO_IMR
);

298 
	`©91_sys_wrôe
(
pio
 + 
PIO_IDR
, 
backups
[
i
]);

299 
	`©91_sys_wrôe
(
pio
 + 
PIO_IER
, 
wakeups
[
i
]);

301 i‡(!
wakeups
[
i
])

302 
	`˛k_dißbÀ
(
gpio
[
i
].
˛ock
);

304 #ifde‡
CONFIG_PM_DEBUG


305 
	`¥ötk
(
KERN_DEBUG
 "GPIO-%¯may wakêf‹ %08x\n", 'A'+
i
, 
wakeups
[i]);

309 
	}
}

311 
	$©91_gpio_ªsume
()

313 
i
;

315 
i
 = 0; i < 
gpio_b™ks
; i++) {

316 
u32
 
pio
 = 
gpio
[
i
].
off£t
;

318 i‡(!
wakeups
[
i
])

319 
	`˛k_íabÀ
(
gpio
[
i
].
˛ock
);

321 
	`©91_sys_wrôe
(
pio
 + 
PIO_IDR
, 
wakeups
[
i
]);

322 
	`©91_sys_wrôe
(
pio
 + 
PIO_IER
, 
backups
[
i
]);

324 
	}
}

327 
	#gpio_úq_£t_wake
 
NULL


	)

342 
	$gpio_úq_mask
(
pö
)

344 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

345 
mask
 = 
	`pö_to_mask
(
pö
);

347 i‡(
pio
)

348 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IDR
);

349 
	}
}

351 
	$gpio_úq_unmask
(
pö
)

353 
__iomem
 *
pio
 = 
	`pö_to_c⁄åﬁÀr
(
pö
);

354 
mask
 = 
	`pö_to_mask
(
pö
);

356 i‡(
pio
)

357 
	`__øw_wrôñ
(
mask
, 
pio
 + 
PIO_IER
);

358 
	}
}

360 
	$gpio_úq_ty≥
(
pö
, 
ty≥
)

362  (
ty≥
 =
IRQT_BOTHEDGE
Ë? 0 : -
EINVAL
;

363 
	}
}

365 
úq_chù
 
	ggpio_úqchù
 = {

366 .
«me
 = "GPIO",

367 .
	gmask
 = 
gpio_úq_mask
,

368 .
	gunmask
 = 
gpio_úq_unmask
,

369 .
	g£t_ty≥
 = 
gpio_úq_ty≥
,

370 .
	g£t_wake
 = 
gpio_úq_£t_wake
,

373 
	$gpio_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

375 
pö
;

376 
úq_desc
 *
gpio
;

377 
__iomem
 *
pio
;

378 
u32
 
i§
;

380 
pio
 = 
	`gë_úq_chù_d©a
(
úq
);

383 
desc
->
chù
->
	`ack
(
úq
);

386 
i§
 = 
	`__øw_ªadl
(
pio
 + 
PIO_ISR
Ë& __øw_ªadl’iÿ+ 
PIO_IMR
);

387 i‡(!
i§
)

390 
pö
 = (Ë
	`gë_úq_d©a
(
úq
);

391 
gpio
 = &
úq_desc
[
pö
];

393 
i§
) {

394 i‡(
i§
 & 1) {

395 i‡(
	`u∆ikñy
(
gpio
->
dïth
)) {

401 
	`gpio_úq_mask
(
pö
);

404 
	`desc_h™dÀ_úq
(
pö
, 
gpio
);

406 
pö
++;

407 
gpio
++;

408 
i§
 >>= 1;

411 
desc
->
chù
->
	`unmask
(
úq
);

413 
	}
}

420 
__öô
 
	$©91_gpio_úq_£tup
()

422 
pioc
, 
pö
;

424 
pioc
 = 0, 
pö
 = 
PIN_BASE
;

425 
pioc
 < 
gpio_b™ks
;

426 
pioc
++) {

427 
__iomem
 *
c⁄åﬁÀr
;

428 
id
 = 
gpio
[
pioc
].id;

429 
i
;

431 
	`˛k_íabÀ
(
gpio
[
pioc
].
˛ock
);

433 
c⁄åﬁÀr
 = (
__iomem
 *Ë
AT91_VA_BASE_SYS
 + 
gpio
[
pioc
].
off£t
;

434 
	`__øw_wrôñ
(~0, 
c⁄åﬁÀr
 + 
PIO_IDR
);

436 
	`£t_úq_d©a
(
id
, (*Ë
pö
);

437 
	`£t_úq_chù_d©a
(
id
, 
c⁄åﬁÀr
);

439 
i
 = 0; i < 32; i++, 
pö
++) {

444 
	`£t_úq_chù
(
pö
, &
gpio_úqchù
);

445 
	`£t_úq_h™dÀr
(
pö
, 
h™dÀ_sim∂e_úq
);

446 
	`£t_úq_Êags
(
pö
, 
IRQF_VALID
);

449 
	`£t_úq_chaöed_h™dÀr
(
id
, 
gpio_úq_h™dÀr
);

451 
	`¥_öfo
("AT91: %d gpiÿúq†ö %d b™ks\n", 
pö
 - 
PIN_BASE
, 
gpio_b™ks
);

452 
	}
}

457 
__öô
 
	$©91_gpio_öô
(
©91_gpio_b™k
 *
d©a
, 
ƒ_b™ks
)

459 
	`BUG_ON
(
ƒ_b™ks
 > 
MAX_GPIO_BANKS
);

461 
gpio
 = 
d©a
;

462 
gpio_b™ks
 = 
ƒ_b™ks
;

463 
	}
}

	@arch/arm/mach-at91/irq.c

23 
	~<löux/öô.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/ty≥s.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/£tup.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/úq.h
>

35 
	~<asm/mach/m≠.h
>

38 
	$©91_aic_mask_úq
(
úq
)

41 
	`©91_sys_wrôe
(
AT91_AIC_IDCR
, 1 << 
úq
);

42 
	}
}

44 
	$©91_aic_unmask_úq
(
úq
)

47 
	`©91_sys_wrôe
(
AT91_AIC_IECR
, 1 << 
úq
);

48 
	}
}

50 
	g©91_exã∫_úq
;

52 
	#is_exã∫_úq
(
úq
Ë((1 << (úq)Ë& 
©91_exã∫_úq
)

	)

54 
	$©91_aic_£t_ty≥
(
úq
, 
ty≥
)

56 
smr
, 
§˘y≥
;

58 
ty≥
) {

59 
IRQT_HIGH
:

60 
§˘y≥
 = 
AT91_AIC_SRCTYPE_HIGH
;

62 
IRQT_RISING
:

63 
§˘y≥
 = 
AT91_AIC_SRCTYPE_RISING
;

65 
IRQT_LOW
:

66 i‡((
úq
 =
AT91_ID_FIQ
Ë|| 
	`is_exã∫_úq
(irq))

67 
§˘y≥
 = 
AT91_AIC_SRCTYPE_LOW
;

69  -
EINVAL
;

71 
IRQT_FALLING
:

72 i‡((
úq
 =
AT91_ID_FIQ
Ë|| 
	`is_exã∫_úq
(irq))

73 
§˘y≥
 = 
AT91_AIC_SRCTYPE_FALLING
;

75  -
EINVAL
;

78  -
EINVAL
;

81 
smr
 = 
	`©91_sys_ªad
(
	`AT91_AIC_SMR
(
úq
)Ë& ~
AT91_AIC_SRCTYPE
;

82 
	`©91_sys_wrôe
(
	`AT91_AIC_SMR
(
úq
), 
smr
 | 
§˘y≥
);

84 
	}
}

86 #ifde‡
CONFIG_PM


88 
u32
 
	gwakeups
;

89 
u32
 
	gbackups
;

91 
	$©91_aic_£t_wake
(
úq
, 
vÆue
)

93 i‡(
	`u∆ikñy
(
úq
 >= 32))

94  -
EINVAL
;

96 i‡(
vÆue
)

97 
wakeups
 |(1 << 
úq
);

99 
wakeups
 &~(1 << 
úq
);

102 
	}
}

104 
	$©91_úq_su•íd
()

106 
backups
 = 
	`©91_sys_ªad
(
AT91_AIC_IMR
);

107 
	`©91_sys_wrôe
(
AT91_AIC_IDCR
, 
backups
);

108 
	`©91_sys_wrôe
(
AT91_AIC_IECR
, 
wakeups
);

109 
	}
}

111 
	$©91_úq_ªsume
()

113 
	`©91_sys_wrôe
(
AT91_AIC_IDCR
, 
wakeups
);

114 
	`©91_sys_wrôe
(
AT91_AIC_IECR
, 
backups
);

115 
	}
}

118 
	#©91_aic_£t_wake
 
NULL


	)

121 
úq_chù
 
	g©91_aic_chù
 = {

122 .
«me
 = "AIC",

123 .
	gack
 = 
©91_aic_mask_úq
,

124 .
	gmask
 = 
©91_aic_mask_úq
,

125 .
	gunmask
 = 
©91_aic_unmask_úq
,

126 .
	g£t_ty≥
 = 
©91_aic_£t_ty≥
,

127 .
	g£t_wake
 = 
©91_aic_£t_wake
,

133 
__öô
 
	$©91_aic_öô
(
¥i‹ôy
[
NR_AIC_IRQS
])

135 
i
;

141 
i
 = 0; i < 
NR_AIC_IRQS
; i++) {

143 
	`©91_sys_wrôe
(
	`AT91_AIC_SVR
(
i
), i);

145 
	`©91_sys_wrôe
(
	`AT91_AIC_SMR
(
i
), 
AT91_AIC_SRCTYPE_LOW
 | 
¥i‹ôy
[i]);

147 
	`£t_úq_chù
(
i
, &
©91_aic_chù
);

148 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

149 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

152 i‡(
i
 < 8)

153 
	`©91_sys_wrôe
(
AT91_AIC_EOICR
, 0);

160 
	`©91_sys_wrôe
(
AT91_AIC_SPU
, 
NR_AIC_IRQS
);

163 
	`©91_sys_wrôe
(
AT91_AIC_DCR
, 0);

166 
	`©91_sys_wrôe
(
AT91_AIC_IDCR
, 0xFFFFFFFF);

167 
	`©91_sys_wrôe
(
AT91_AIC_ICCR
, 0xFFFFFFFF);

168 
	}
}

	@arch/arm/mach-at91/leds.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/öô.h
>

16 
	~<asm/mach-ty≥s.h
>

17 
	~<asm/Àds.h
>

18 
	~<asm/¨ch/bﬂrd.h
>

19 
	~<asm/¨ch/gpio.h
>

22 
ölöe
 
	$©91_Àd_⁄
(
Àd
)

24 
	`©91_£t_gpio_vÆue
(
Àd
, 0);

25 
	}
}

27 
ölöe
 
	$©91_Àd_off
(
Àd
)

29 
	`©91_£t_gpio_vÆue
(
Àd
, 1);

30 
	}
}

32 
ölöe
 
	$©91_Àd_toggÀ
(
Àd
)

34 
is_off
 = 
	`©91_gë_gpio_vÆue
(
Àd
);

35 i‡(
is_off
)

36 
	`©91_Àd_⁄
(
Àd
);

38 
	`©91_Àd_off
(
Àd
);

39 
	}
}

45 
	$©91_Àds_evít
(
Àd_evít_t
 
evt
)

47 
Êags
;

49 
	`loˇl_úq_ßve
(
Êags
);

51 
evt
) {

52 
Àd_°¨t
:

53 
	`©91_Àd_⁄
(
©91_Àds_˝u
);

56 
Àd_°›
:

57 
	`©91_Àd_off
(
©91_Àds_˝u
);

60 #ifde‡
CONFIG_LEDS_TIMER


61 
Àd_timî
:

62 
	`©91_Àd_toggÀ
(
©91_Àds_timî
);

66 #ifde‡
CONFIG_LEDS_CPU


67 
Àd_idÀ_°¨t
:

68 
	`©91_Àd_off
(
©91_Àds_˝u
);

71 
Àd_idÀ_íd
:

72 
	`©91_Àd_⁄
(
©91_Àds_˝u
);

80 
	`loˇl_úq_ª°‹e
(
Êags
);

81 
	}
}

84 
__öô
 
	$Àds_öô
()

86 i‡(!
©91_Àds_timî
 || !
©91_Àds_˝u
)

87  -
ENODEV
;

89 
Àds_evít
 = 
©91_Àds_evít
;

91 
	`Àds_evít
(
Àd_°¨t
);

93 
	}
}

95 
__öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-at91/pm.c

13 
	~<löux/pm.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/¥oc_fs.h
>

16 
	~<löux/pm.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/sysfs.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<asm/io.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/©omic.h
>

25 
	~<asm/mach/time.h
>

26 
	~<asm/mach/úq.h
>

27 
	~<asm/mach-ty≥s.h
>

29 
	~<asm/¨ch/©91_pmc.h
>

30 
	~<asm/¨ch/©91rm9200_mc.h
>

31 
	~<asm/¨ch/gpio.h
>

32 
	~<asm/¨ch/˝u.h
>

34 
	~"gíîic.h
"

37 
	$©91_pm_vÆid_°©e
(
su•íd_°©e_t
 
°©e
)

39 
°©e
) {

40 
PM_SUSPEND_ON
:

41 
PM_SUSPEND_STANDBY
:

42 
PM_SUSPEND_MEM
:

48 
	}
}

51 
su•íd_°©e_t
 
	gèrgë_°©e
;

56 
	$©91_pm_£t_èrgë
(
su•íd_°©e_t
 
°©e
)

58 
èrgë_°©e
 = 
°©e
;

60 
	}
}

66 
	$©91_pm_vîify_˛ocks
()

68 
sc§
;

69 
i
;

71 
sc§
 = 
	`©91_sys_ªad
(
AT91_PMC_SCSR
);

74 i‡(
	`˝u_is_©91rm9200
()) {

75 i‡((
sc§
 & (
AT91RM9200_PMC_UHP
 | 
AT91RM9200_PMC_UDP
)) != 0) {

76 
	`¥_debug
("AT91: PM - Suspend-to-RAM with USB stilláctive\n");

79 } i‡(
	`˝u_is_©91ßm9260
(Ë|| 
	`˝u_is_©91ßm9261
(Ë|| 
	`˝u_is_©91ßm9263
()) {

80 i‡((
sc§
 & (
AT91SAM926x_PMC_UHP
 | 
AT91SAM926x_PMC_UDP
)) != 0) {

81 
	`¥_debug
("AT91: PM - Suspend-to-RAM with USB stilláctive\n");

86 #ifde‡
CONFIG_AT91_PROGRAMMABLE_CLOCKS


88 
i
 = 0; i < 4; i++) {

89 
u32
 
css
;

91 i‡((
sc§
 & (
AT91_PMC_PCK0
 << 
i
)) == 0)

94 
css
 = 
	`©91_sys_ªad
(
	`AT91_PMC_PCKR
(
i
)Ë& 
AT91_PMC_CSS
;

95 i‡(
css
 !
AT91_PMC_CSS_SLOW
) {

96 
	`¥_debug
("AT91: PM - Su•íd-to-RAM wôh PCK%d sr¯%d\n", 
i
, 
css
);

103 
	}
}

115 
	$©91_su•íd_íãrög_¶ow_˛ock
()

117  (
èrgë_°©e
 =
PM_SUSPEND_MEM
);

118 
	}
}

119 
EXPORT_SYMBOL
(
©91_su•íd_íãrög_¶ow_˛ock
);

122 (*
¶ow_˛ock
)();

125 
	$©91_pm_íãr
(
su•íd_°©e_t
 
°©e
)

127 
	`©91_gpio_su•íd
();

128 
	`©91_úq_su•íd
();

130 
	`¥_debug
("AT91: PM - wake mask %08x,Öm state %d\n",

132 (
	`©91_sys_ªad
(
AT91_PMC_PCSR
)

133 | (1 << 
AT91_ID_FIQ
)

134 | (1 << 
AT91_ID_SYS
)

135 | (
©91_exã∫_úq
))

136 & 
	`©91_sys_ªad
(
AT91_AIC_IMR
),

137 
°©e
);

139 
°©e
) {

145 
PM_SUSPEND_MEM
:

149 i‡(!
	`©91_pm_vîify_˛ocks
())

150 
îr‹
;

156 i‡(
¶ow_˛ock
) {

157 
	`¶ow_˛ock
();

161 
	`¥_öfo
("AT91: PM -Ço slow clock mode yet ...\n");

171 
PM_SUSPEND_STANDBY
:

177 
	`asm
("b 1f; .align 5; 1:");

178 
	`asm
("mcrÖ15, 0,Ñ0, c7, c10, 4");

179 
	`©91_sys_wrôe
(
AT91_SDRAMC_SRR
, 1);

182 
PM_SUSPEND_ON
:

183 
	`asm
("mcrÖ15, 0,Ñ0, c7, c0, 4");

187 
	`¥_debug
("AT91: PM - bogu†su•íd sèã %d\n", 
°©e
);

188 
îr‹
;

191 
	`¥_debug
("AT91: PM - wakeup %08x\n",

192 
	`©91_sys_ªad
(
AT91_AIC_IPR
Ë&át91_sys_ªad(
AT91_AIC_IMR
));

194 
îr‹
:

195 
èrgë_°©e
 = 
PM_SUSPEND_ON
;

196 
	`©91_úq_ªsume
();

197 
	`©91_gpio_ªsume
();

199 
	}
}

202 
pm_›s
 
	g©91_pm_›s
 ={

203 .
vÆid
 = 
©91_pm_vÆid_°©e
,

204 .
	g£t_èrgë
 = 
©91_pm_£t_èrgë
,

205 .
	gíãr
 = 
©91_pm_íãr
,

208 
__öô
 
	$©91_pm_öô
()

210 
	`¥ötk
("AT91: Power Management\n");

212 #ifde‡
CONFIG_AT91_PM_SLOW_CLOCK


216 
¶ow_˛ock
 = (*Ë(
AT91_VA_BASE_SRAM
 + (3 * 
SZ_4K
));

217 
	`mem˝y
(
¶ow_˛ock
, 
©91rm9200_¶ow_˛ock
, 
©91rm9200_¶ow_˛ock_sz
);

221 
	`©91_sys_wrôe
(
AT91_SDRAMC_LPR
, 0);

223 
	`pm_£t_›s
(&
©91_pm_›s
);

226 
	}
}

227 
¨ch_öôˇŒ
(
©91_pm_öô
);

	@arch/arm/mach-clps711x/autcpu12.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/mm.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/sizes.h
>

28 
	~<asm/io.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/mach/¨ch.h
>

32 
	~<asm/pgèbÀ.h
>

33 
	~<asm/∑ge.h
>

35 
	~<asm/mach/m≠.h
>

36 
	~<asm/¨ch/aut˝u12.h
>

38 
	~"comm⁄.h
"

48 
m≠_desc
 
	gaut˝u12_io_desc
[] 
	g__öôd©a
 = {

52 .
vútuÆ
 = 
AUTCPU12_VIRT_CS8900A
,

53 .
	gp‚
 = 
__phys_to_p‚
(
AUTCPU12_PHYS_CS8900A
),

54 .
	gÀngth
 = 
SZ_1M
,

55 .
	gty≥
 = 
MT_DEVICE


59 
__öô
 
	$aut˝u12_m≠_io
()

61 
	`˛ps711x_m≠_io
();

62 
	`iŸabÀ_öô
(
aut˝u12_io_desc
, 
	`ARRAY_SIZE
(autcpu12_io_desc));

63 
	}
}

65 
MACHINE_START
(
AUTCPU12
, "autronixáutcpu12")

67 .
	gphys_io
 = 0x80000000,

68 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

69 .
	gboŸ_∑øms
 = 0xc0020000,

70 .
	gm≠_io
 = 
aut˝u12_m≠_io
,

71 .
	göô_úq
 = 
˛ps711x_öô_úq
,

72 .
	gtimî
 = &
˛ps711x_timî
,

73 
	gMACHINE_END


	@arch/arm/mach-clps711x/cdb89712.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/mm.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/pgèbÀ.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mach/m≠.h
>

35 
	~"comm⁄.h
"

41 
m≠_desc
 
	gcdb89712_io_desc
[] 
	g__öôd©a
 = {

43 .
vútuÆ
 = 
ETHER_BASE
,

44 .
	gp‚
 =
__phys_to_p‚
(
ETHER_START
),

45 .
	gÀngth
 = 
ETHER_SIZE
,

46 .
	gty≥
 = 
MT_DEVICE


50 
__öô
 
	$cdb89712_m≠_io
()

52 
	`˛ps711x_m≠_io
();

53 
	`iŸabÀ_öô
(
cdb89712_io_desc
, 
	`ARRAY_SIZE
(cdb89712_io_desc));

54 
	}
}

56 
MACHINE_START
(
CDB89712
, "Cirrus-CDB89712")

58 .
	gphys_io
 = 0x80000000,

59 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

60 .
	gboŸ_∑øms
 = 0xc0000100,

61 .
	gm≠_io
 = 
cdb89712_m≠_io
,

62 .
	göô_úq
 = 
˛ps711x_öô_úq
,

63 .
	gtimî
 = &
˛ps711x_timî
,

64 
	gMACHINE_END


	@arch/arm/mach-clps711x/ceiva.c

20 
	~<löux/öô.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/°rög.h
>

24 
	~<asm/£tup.h
>

25 
	~<asm/mach-ty≥s.h
>

26 
	~<asm/mach/¨ch.h
>

28 
	~<löux/kî√l.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/∑ge.h
>

32 
	~<asm/pgèbÀ.h
>

33 
	~<asm/sizes.h
>

35 
	~<asm/mach/m≠.h
>

37 
	~"comm⁄.h
"

39 
m≠_desc
 
	g˚iva_io_desc
[] 
	g__öôd©a
 = {

42 .
vútuÆ
 = 
CEIVA_VIRT_SED1355
,

43 .
	gp‚
 = 
__phys_to_p‚
(
CEIVA_PHYS_SED1355
),

44 .
	gÀngth
 = 
SZ_2M
,

45 .
	gty≥
 = 
MT_DEVICE


50 
__öô
 
	$˚iva_m≠_io
()

52 
	`˛ps711x_m≠_io
();

53 
	`iŸabÀ_öô
(
˚iva_io_desc
, 
	`ARRAY_SIZE
(ceiva_io_desc));

54 
	}
}

57 
MACHINE_START
(
CEIVA
, "CEIVA/Polaroid Photo MAX Digital Picture Frame")

59 .
	gphys_io
 = 0x80000000,

60 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

61 .
	gboŸ_∑øms
 = 0xc0000100,

62 .
	gm≠_io
 = 
˚iva_m≠_io
,

63 .
	göô_úq
 = 
˛ps711x_öô_úq
,

64 .
	gtimî
 = &
˛ps711x_timî
,

65 
	gMACHINE_END


	@arch/arm/mach-clps711x/clep7312.c

18 
	~<löux/öô.h
>

19 
	~<löux/ty≥s.h
>

20 
	~<löux/°rög.h
>

22 
	~<asm/£tup.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
	~"comm⁄.h
"

28 
__öô


29 
	$fixup_˛ï7312
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

30 **
cmdlöe
, 
memöfo
 *
mi
)

32 
mi
->
ƒ_b™ks
=1;

33 
mi
->
b™k
[0].
°¨t
 = 0xc0000000;

34 
mi
->
b™k
[0].
size
 = 0x01000000;

35 
mi
->
b™k
[0].
node
 = 0;

36 
	}
}

39 
MACHINE_START
(
CLEP7212
, "Cirrus Logic 7212/7312")

41 .
	gphys_io
 = 0x80000000,

42 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

43 .
	gboŸ_∑øms
 = 0xc0000100,

44 .
	gfixup
 = 
fixup_˛ï7312
,

45 .
	gm≠_io
 = 
˛ps711x_m≠_io
,

46 .
	göô_úq
 = 
˛ps711x_öô_úq
,

47 .
	gtimî
 = &
˛ps711x_timî
,

48 
	gMACHINE_END


	@arch/arm/mach-clps711x/common.h

7 
	gsys_timî
;

9 
˛ps711x_m≠_io
();

10 
˛ps711x_öô_úq
();

11 
sys_timî
 
˛ps711x_timî
;

	@arch/arm/mach-clps711x/edb7211-arch.c

20 
	~<löux/öô.h
>

21 
	~<löux/ty≥s.h
>

22 
	~<löux/°rög.h
>

24 
	~<asm/£tup.h
>

25 
	~<asm/mach-ty≥s.h
>

26 
	~<asm/mach/¨ch.h
>

28 
	~"comm⁄.h
"

30 
edb7211_m≠_io
();

32 
__öô


33 
	$fixup_edb7211
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

34 **
cmdlöe
, 
memöfo
 *
mi
)

44 
mi
->
b™k
[0].
°¨t
 = 0xc0000000;

45 
mi
->
b™k
[0].
size
 = 8*1024*1024;

46 
mi
->
b™k
[0].
node
 = 0;

47 
mi
->
b™k
[1].
°¨t
 = 0xc1000000;

48 
mi
->
b™k
[1].
size
 = 8*1024*1024;

49 
mi
->
b™k
[1].
node
 = 1;

50 
mi
->
ƒ_b™ks
 = 2;

51 
	}
}

53 
MACHINE_START
(
EDB7211
, "CL-EDB7211 (EP7211Éval board)")

55 .
	gphys_io
 = 0x80000000,

56 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

57 .
	gboŸ_∑øms
 = 0xc0020100,

58 .
	gfixup
 = 
fixup_edb7211
,

59 .
	gm≠_io
 = 
edb7211_m≠_io
,

60 .
	göô_úq
 = 
˛ps711x_öô_úq
,

61 .
	gtimî
 = &
˛ps711x_timî
,

62 
	gMACHINE_END


	@arch/arm/mach-clps711x/edb7211-mm.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/öô.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/∑ge.h
>

27 
	~<asm/pgèbÀ.h
>

28 
	~<asm/sizes.h
>

30 
	~<asm/mach/m≠.h
>

32 
˛ps711x_m≠_io
();

53 
m≠_desc
 
	gedb7211_io_desc
[] 
	g__öôd©a
 = {

55 .
vútuÆ
 = 
EP7211_VIRT_EXTKBD
,

56 .
	gp‚
 = 
__phys_to_p‚
(
EP7211_PHYS_EXTKBD
),

57 .
	gÀngth
 = 
SZ_1M
,

58 .
	gty≥
 = 
MT_DEVICE
,

60 .
	gvútuÆ
 = 
EP7211_VIRT_CS8900A
,

61 .
	gp‚
 = 
__phys_to_p‚
(
EP7211_PHYS_CS8900A
),

62 .
	gÀngth
 = 
SZ_1M
,

63 .
	gty≥
 = 
MT_DEVICE
,

65 .
	gvútuÆ
 = 
EP7211_VIRT_FLASH1
,

66 .
	gp‚
 = 
__phys_to_p‚
(
EP7211_PHYS_FLASH1
),

67 .
	gÀngth
 = 
SZ_8M
,

68 .
	gty≥
 = 
MT_DEVICE
,

70 .
	gvútuÆ
 = 
EP7211_VIRT_FLASH2
,

71 .
	gp‚
 = 
__phys_to_p‚
(
EP7211_PHYS_FLASH2
),

72 .
	gÀngth
 = 
SZ_8M
,

73 .
	gty≥
 = 
MT_DEVICE
,

77 
__öô
 
	$edb7211_m≠_io
()

79 
	`˛ps711x_m≠_io
();

80 
	`iŸabÀ_öô
(
edb7211_io_desc
, 
	`ARRAY_SIZE
(edb7211_io_desc));

81 
	}
}

	@arch/arm/mach-clps711x/fortunet.c

22 
	~<löux/ty≥s.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/öôrd.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mem‹y.h
>

35 
	~"comm⁄.h
"

37 
memöfo
 
	gmemm≠
 = {

38 .
ƒ_b™ks
 = 1,

39 .
	gb™k
 = {

41 .
°¨t
 = 0xC0000000,

42 .
	gsize
 = 0x01000000,

43 .
	gnode
 = 0

48 
	sèg_IMAGE_PARAMS


50 
	mømdisk_ok
;

51 
	mømdisk_addªss
;

52 
	mømdisk_size
;

53 
	møm_size
;

54 
	mexåa_∑øm_ty≥
;

55 
	mexåa_∑øm_±r
;

56 
	mcomm™d_löe
;

57 } 
	tIMAGE_PARAMS
;

59 
	#IMAGE_PARAMS_PHYS
 0xC01F0000

	)

61 
__öô


62 
	$f‹tu√t_fixup
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

63 **
cmdlöe
, 
memöfo
 *
mi
)

65 
IMAGE_PARAMS
 *
ù
 = 
	`phys_to_vút
(
IMAGE_PARAMS_PHYS
);

66 *
cmdlöe
 = 
	`phys_to_vút
(
ù
->
comm™d_löe
);

67 #ifde‡
CONFIG_BLK_DEV_INITRD


68 if(
ù
->
ømdisk_ok
)

70 
öôrd_°¨t
 = 
	`__phys_to_vút
(
ù
->
ømdisk_addªss
);

71 
öôrd_íd
 = 
öôrd_°¨t
 + 
ù
->
ømdisk_size
;

74 
memm≠
.
b™k
[0].
size
 = 
ù
->
øm_size
;

75 *
mi
 = 
memm≠
;

76 
	}
}

78 
MACHINE_START
(
FORTUNET
, "ARM-FortuNet")

80 .
	gphys_io
 = 0x80000000,

81 .
	gio_pg_off°
 = ((0xf0000000) >> 18) & 0xfffc,

82 .
	gboŸ_∑øms
 = 0x00000000,

83 .
	gfixup
 = 
f‹tu√t_fixup
,

84 .
	gm≠_io
 = 
˛ps711x_m≠_io
,

85 .
	göô_úq
 = 
˛ps711x_öô_úq
,

86 .
	gtimî
 = &
˛ps711x_timî
,

87 
	gMACHINE_END


	@arch/arm/mach-clps711x/irq.c

20 
	~<löux/öô.h
>

21 
	~<löux/li°.h
>

23 
	~<asm/mach/úq.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/io.h
>

26 
	~<asm/úq.h
>

28 
	~<asm/h¨dw¨e/˛ps7111.h
>

30 
	$öt1_mask
(
úq
)

32 
u32
 
ötmr1
;

34 
ötmr1
 = 
	`˛ps_ªadl
(
INTMR1
);

35 
ötmr1
 &~(1 << 
úq
);

36 
	`˛ps_wrôñ
(
ötmr1
, 
INTMR1
);

37 
	}
}

39 
	$öt1_ack
(
úq
)

41 
u32
 
ötmr1
;

43 
ötmr1
 = 
	`˛ps_ªadl
(
INTMR1
);

44 
ötmr1
 &~(1 << 
úq
);

45 
	`˛ps_wrôñ
(
ötmr1
, 
INTMR1
);

47 
úq
) {

48 
IRQ_CSINT
: 
	`˛ps_wrôñ
(0, 
COEOI
); ;

49 
IRQ_TC1OI
: 
	`˛ps_wrôñ
(0, 
TC1EOI
); ;

50 
IRQ_TC2OI
: 
	`˛ps_wrôñ
(0, 
TC2EOI
); ;

51 
IRQ_RTCMI
: 
	`˛ps_wrôñ
(0, 
RTCEOI
); ;

52 
IRQ_TINT
: 
	`˛ps_wrôñ
(0, 
TEOI
); ;

53 
IRQ_UMSINT
: 
	`˛ps_wrôñ
(0, 
UMSEOI
); ;

55 
	}
}

57 
	$öt1_unmask
(
úq
)

59 
u32
 
ötmr1
;

61 
ötmr1
 = 
	`˛ps_ªadl
(
INTMR1
);

62 
ötmr1
 |1 << 
úq
;

63 
	`˛ps_wrôñ
(
ötmr1
, 
INTMR1
);

64 
	}
}

66 
úq_chù
 
	göt1_chù
 = {

67 .
ack
 = 
öt1_ack
,

68 .
	gmask
 = 
öt1_mask
,

69 .
	gunmask
 = 
öt1_unmask
,

72 
	$öt2_mask
(
úq
)

74 
u32
 
ötmr2
;

76 
ötmr2
 = 
	`˛ps_ªadl
(
INTMR2
);

77 
ötmr2
 &~(1 << (
úq
 - 16));

78 
	`˛ps_wrôñ
(
ötmr2
, 
INTMR2
);

79 
	}
}

81 
	$öt2_ack
(
úq
)

83 
u32
 
ötmr2
;

85 
ötmr2
 = 
	`˛ps_ªadl
(
INTMR2
);

86 
ötmr2
 &~(1 << (
úq
 - 16));

87 
	`˛ps_wrôñ
(
ötmr2
, 
INTMR2
);

89 
úq
) {

90 
IRQ_KBDINT
: 
	`˛ps_wrôñ
(0, 
KBDEOI
); ;

92 
	}
}

94 
	$öt2_unmask
(
úq
)

96 
u32
 
ötmr2
;

98 
ötmr2
 = 
	`˛ps_ªadl
(
INTMR2
);

99 
ötmr2
 |1 << (
úq
 - 16);

100 
	`˛ps_wrôñ
(
ötmr2
, 
INTMR2
);

101 
	}
}

103 
úq_chù
 
	göt2_chù
 = {

104 .
ack
 = 
öt2_ack
,

105 .
	gmask
 = 
öt2_mask
,

106 .
	gunmask
 = 
öt2_unmask
,

109 
__öô
 
	$˛ps711x_öô_úq
()

111 
i
;

113 
i
 = 0; i < 
NR_IRQS
; i++) {

114 i‡(
INT1_IRQS
 & (1 << 
i
)) {

115 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

116 
	`£t_úq_chù
(
i
, &
öt1_chù
);

117 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

119 i‡(
INT2_IRQS
 & (1 << 
i
)) {

120 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

121 
	`£t_úq_chù
(
i
, &
öt2_chù
);

122 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

129 
	`˛ps_wrôñ
(0, 
INTMR1
);

130 
	`˛ps_wrôñ
(0, 
INTMR2
);

135 
	`˛ps_wrôñ
(0, 
COEOI
);

136 
	`˛ps_wrôñ
(0, 
TC1EOI
);

137 
	`˛ps_wrôñ
(0, 
TC2EOI
);

138 
	`˛ps_wrôñ
(0, 
RTCEOI
);

139 
	`˛ps_wrôñ
(0, 
TEOI
);

140 
	`˛ps_wrôñ
(0, 
UMSEOI
);

141 
	`˛ps_wrôñ
(0, 
SYNCIO
);

142 
	`˛ps_wrôñ
(0, 
KBDEOI
);

143 
	}
}

	@arch/arm/mach-clps711x/mm.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/boŸmem.h
>

27 
	~<asm/sizes.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/pgèbÀ.h
>

30 
	~<asm/∑ge.h
>

31 
	~<asm/mach/m≠.h
>

32 
	~<asm/h¨dw¨e/˛ps7111.h
>

37 
m≠_desc
 
	g˛ps711x_io_desc
[] 
	g__öôd©a
 = {

39 .
vútuÆ
 = 
CLPS7111_VIRT_BASE
,

40 .
	gp‚
 = 
__phys_to_p‚
(
CLPS7111_PHYS_BASE
),

41 .
	gÀngth
 = 
SZ_1M
,

42 .
	gty≥
 = 
MT_DEVICE


46 
__öô
 
	$˛ps711x_m≠_io
()

48 
	`iŸabÀ_öô
(
˛ps711x_io_desc
, 
	`ARRAY_SIZE
(clps711x_io_desc));

49 
	}
}

	@arch/arm/mach-clps711x/p720t-leds.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/öô.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/Àds.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/h¨dw¨e/˛ps7111.h
>

32 
	~<asm/h¨dw¨e/ï7212.h
>

34 
	$p720t_Àds_evít
(
Àd_evít_t
 
Àdevt
)

36 
Êags
;

37 
u32
 
pddr
;

39 
	`loˇl_úq_ßve
(
Êags
);

40 
Àdevt
) {

41 
Àd_idÀ_°¨t
:

44 
Àd_idÀ_íd
:

47 
Àd_timî
:

48 
pddr
 = 
	`˛ps_ªadb
(
PDDR
);

49 
	`˛ps_wrôeb
(
pddr
 ^ 1, 
PDDR
);

56 
	`loˇl_úq_ª°‹e
(
Êags
);

57 
	}
}

59 
__öô
 
	$Àds_öô
()

61 i‡(
	`machöe_is_p720t
())

62 
Àds_evít
 = 
p720t_Àds_evít
;

65 
	}
}

67 
¨ch_öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-clps711x/p720t.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/mm.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/pgèbÀ.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/sizes.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/¨ch/sy•ld.h
>

37 
	~"comm⁄.h
"

44 
m≠_desc
 
	gp720t_io_desc
[] 
	g__öôd©a
 = {

46 .
vútuÆ
 = 
SYSPLD_VIRT_BASE
,

47 .
	gp‚
 = 
__phys_to_p‚
(
SYSPLD_PHYS_BASE
),

48 .
	gÀngth
 = 
SZ_1M
,

49 .
	gty≥
 = 
MT_DEVICE


51 .
	gvútuÆ
 = 0xfe400000,

52 .
	gp‚
 = 
__phys_to_p‚
(0x10400000),

53 .
	gÀngth
 = 
SZ_1M
,

54 .
	gty≥
 = 
MT_DEVICE


58 
__öô


59 
	$fixup_p720t
(
machöe_desc
 *
desc
, 
èg
 *tag,

60 **
cmdlöe
, 
memöfo
 *
mi
)

65 i‡(
èg
->
hdr
.èg !
ATAG_CORE
) {

66 
èg
->
hdr
.èg = 
ATAG_CORE
;

67 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_c‹e
);

68 
èg
->
u
.
c‹e
.
Êags
 = 0;

69 
èg
->
u
.
c‹e
.
∑gesize
 = 
PAGE_SIZE
;

70 
èg
->
u
.
c‹e
.
roŸdev
 = 0x0100;

72 
èg
 = 
	`èg_√xt
(tag);

73 
èg
->
hdr
.èg = 
ATAG_MEM
;

74 
èg
->
hdr
.
size
 = 
	`èg_size
(
èg_mem32
);

75 
èg
->
u
.
mem
.
size
 = 4096;

76 
èg
->
u
.
mem
.
°¨t
 = 
PHYS_OFFSET
;

78 
èg
 = 
	`èg_√xt
(tag);

79 
èg
->
hdr
.èg = 
ATAG_NONE
;

80 
èg
->
hdr
.
size
 = 0;

82 
	}
}

84 
__öô
 
	$p720t_m≠_io
()

86 
	`˛ps711x_m≠_io
();

87 
	`iŸabÀ_öô
(
p720t_io_desc
, 
	`ARRAY_SIZE
(p720t_io_desc));

88 
	}
}

90 
MACHINE_START
(
P720T
, "ARM-Prospector720T")

92 .
	gphys_io
 = 0x80000000,

93 .
	gio_pg_off°
 = ((0xff000000) >> 18) & 0xfffc,

94 .
	gboŸ_∑øms
 = 0xc0000100,

95 .
	gfixup
 = 
fixup_p720t
,

96 .
	gm≠_io
 = 
p720t_m≠_io
,

97 .
	göô_úq
 = 
˛ps711x_öô_úq
,

98 .
	gtimî
 = &
˛ps711x_timî
,

99 
MACHINE_END


101 
	$p720t_hw_öô
()

107 
PLD_LCDEN
 = 0;

108 
PLD_PWR
 &~(
PLD_S4_ON
|
PLD_S3_ON
|
PLD_S2_ON
|
PLD_S1_ON
);

110 
PLD_KBD
 = 0;

111 
PLD_IO
 = 0;

112 
PLD_IRDA
 = 0;

113 
PLD_CODEC
 = 0;

114 
PLD_TCH
 = 0;

115 
PLD_SPI
 = 0;

116 #i‚de‡
CONFIG_DEBUG_LL


117 
PLD_COM2
 = 0;

118 
PLD_COM1
 = 0;

122 
	}
}

124 
__öôˇŒ
(
p720t_hw_öô
);

	@arch/arm/mach-clps711x/time.c

19 
	~<löux/timex.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/úq.h
>

23 
	~<löux/sched.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/Àds.h
>

28 
	~<asm/io.h
>

29 
	~<asm/h¨dw¨e/˛ps7111.h
>

31 
	~<asm/mach/time.h
>

40 
	$˛ps711x_gëtimeoff£t
()

42 
hwticks
;

43 
hwticks
 = 
LATCH
 - (
	`˛ps_ªadl
(
TC2D
) & 0xffff);

44  (
hwticks
 * (
tick_n£c
 / 1000)Ë/ 
LATCH
;

45 
	}
}

50 
úqªtu∫_t


51 
	$p720t_timî_öãºu±
(
úq
, *
dev_id
)

53 
	`wrôe_£qlock
(&
xtime_lock
);

54 
	`timî_tick
();

55 
	`wrôe_£qu∆ock
(&
xtime_lock
);

56  
IRQ_HANDLED
;

57 
	}
}

59 
úqa˘i⁄
 
	g˛ps711x_timî_úq
 = {

60 .
«me
 = "CLPS711x Timer Tick",

61 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

62 .
	gh™dÀr
 = 
p720t_timî_öãºu±
,

65 
__öô
 
	$˛ps711x_timî_öô
()

67 
time•ec
 
tv
;

68 
sysc⁄
;

70 
sysc⁄
 = 
	`˛ps_ªadl
(
SYSCON1
);

71 
sysc⁄
 |
SYSCON1_TC2S
 | 
SYSCON1_TC2M
;

72 
	`˛ps_wrôñ
(
sysc⁄
, 
SYSCON1
);

74 
	`˛ps_wrôñ
(
LATCH
-1, 
TC2D
);

76 
	`£tup_úq
(
IRQ_TC2OI
, &
˛ps711x_timî_úq
);

78 
tv
.
tv_n£c
 = 0;

79 
tv
.
tv_£c
 = 
	`˛ps_ªadl
(
RTCDR
);

80 
	`do_£âimeofday
(&
tv
);

81 
	}
}

83 
sys_timî
 
	g˛ps711x_timî
 = {

84 .
öô
 = 
˛ps711x_timî_öô
,

85 .
	goff£t
 = 
˛ps711x_gëtimeoff£t
,

	@arch/arm/mach-clps7500/core.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/öãºu±.h
>

12 
	~<löux/úq.h
>

13 
	~<löux/li°.h
>

14 
	~<löux/sched.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/devi˚.h
>

17 
	~<löux/£rül_8250.h
>

19 
	~<asm/mach/¨ch.h
>

20 
	~<asm/mach/m≠.h
>

21 
	~<asm/mach/úq.h
>

22 
	~<asm/mach/time.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/h¨dw¨e/iomd.h
>

26 
	~<asm/io.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach-ty≥s.h
>

30 
	gvøm_size
;

32 
	$˛7500_ack_úq_a
(
úq
)

34 
vÆ
, 
mask
;

36 
mask
 = 1 << 
úq
;

37 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

38 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKA
);

39 
	`iomd_wrôeb
(
mask
, 
IOMD_IRQCLRA
);

40 
	}
}

42 
	$˛7500_mask_úq_a
(
úq
)

44 
vÆ
, 
mask
;

46 
mask
 = 1 << 
úq
;

47 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

48 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKA
);

49 
	}
}

51 
	$˛7500_unmask_úq_a
(
úq
)

53 
vÆ
, 
mask
;

55 
mask
 = 1 << 
úq
;

56 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

57 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKA
);

58 
	}
}

60 
úq_chù
 
	g˛ps7500_a_chù
 = {

61 .
ack
 = 
˛7500_ack_úq_a
,

62 .
	gmask
 = 
˛7500_mask_úq_a
,

63 .
	gunmask
 = 
˛7500_unmask_úq_a
,

66 
	$˛7500_mask_úq_b
(
úq
)

68 
vÆ
, 
mask
;

70 
mask
 = 1 << (
úq
 & 7);

71 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKB
);

72 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKB
);

73 
	}
}

75 
	$˛7500_unmask_úq_b
(
úq
)

77 
vÆ
, 
mask
;

79 
mask
 = 1 << (
úq
 & 7);

80 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKB
);

81 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKB
);

82 
	}
}

84 
úq_chù
 
	g˛ps7500_b_chù
 = {

85 .
ack
 = 
˛7500_mask_úq_b
,

86 .
	gmask
 = 
˛7500_mask_úq_b
,

87 .
	gunmask
 = 
˛7500_unmask_úq_b
,

90 
	$˛7500_mask_úq_c
(
úq
)

92 
vÆ
, 
mask
;

94 
mask
 = 1 << (
úq
 & 7);

95 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKC
);

96 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKC
);

97 
	}
}

99 
	$˛7500_unmask_úq_c
(
úq
)

101 
vÆ
, 
mask
;

103 
mask
 = 1 << (
úq
 & 7);

104 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKC
);

105 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKC
);

106 
	}
}

108 
úq_chù
 
	g˛ps7500_c_chù
 = {

109 .
ack
 = 
˛7500_mask_úq_c
,

110 .
	gmask
 = 
˛7500_mask_úq_c
,

111 .
	gunmask
 = 
˛7500_unmask_úq_c
,

114 
	$˛7500_mask_úq_d
(
úq
)

116 
vÆ
, 
mask
;

118 
mask
 = 1 << (
úq
 & 7);

119 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKD
);

120 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKD
);

121 
	}
}

123 
	$˛7500_unmask_úq_d
(
úq
)

125 
vÆ
, 
mask
;

127 
mask
 = 1 << (
úq
 & 7);

128 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKD
);

129 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKD
);

130 
	}
}

132 
úq_chù
 
	g˛ps7500_d_chù
 = {

133 .
ack
 = 
˛7500_mask_úq_d
,

134 .
	gmask
 = 
˛7500_mask_úq_d
,

135 .
	gunmask
 = 
˛7500_unmask_úq_d
,

138 
	$˛7500_mask_úq_dma
(
úq
)

140 
vÆ
, 
mask
;

142 
mask
 = 1 << (
úq
 & 7);

143 
vÆ
 = 
	`iomd_ªadb
(
IOMD_DMAMASK
);

144 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_DMAMASK
);

145 
	}
}

147 
	$˛7500_unmask_úq_dma
(
úq
)

149 
vÆ
, 
mask
;

151 
mask
 = 1 << (
úq
 & 7);

152 
vÆ
 = 
	`iomd_ªadb
(
IOMD_DMAMASK
);

153 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_DMAMASK
);

154 
	}
}

156 
úq_chù
 
	g˛ps7500_dma_chù
 = {

157 .
ack
 = 
˛7500_mask_úq_dma
,

158 .
	gmask
 = 
˛7500_mask_úq_dma
,

159 .
	gunmask
 = 
˛7500_unmask_úq_dma
,

162 
	$˛7500_mask_úq_fiq
(
úq
)

164 
vÆ
, 
mask
;

166 
mask
 = 1 << (
úq
 & 7);

167 
vÆ
 = 
	`iomd_ªadb
(
IOMD_FIQMASK
);

168 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_FIQMASK
);

169 
	}
}

171 
	$˛7500_unmask_úq_fiq
(
úq
)

173 
vÆ
, 
mask
;

175 
mask
 = 1 << (
úq
 & 7);

176 
vÆ
 = 
	`iomd_ªadb
(
IOMD_FIQMASK
);

177 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_FIQMASK
);

178 
	}
}

180 
úq_chù
 
	g˛ps7500_fiq_chù
 = {

181 .
ack
 = 
˛7500_mask_úq_fiq
,

182 .
	gmask
 = 
˛7500_mask_úq_fiq
,

183 .
	gunmask
 = 
˛7500_unmask_úq_fiq
,

186 
	$˛7500_no_a˘i⁄
(
úq
)

188 
	}
}

190 
úq_chù
 
	g˛ps7500_no_chù
 = {

191 .
ack
 = 
˛7500_no_a˘i⁄
,

192 .
	gmask
 = 
˛7500_no_a˘i⁄
,

193 .
	gunmask
 = 
˛7500_no_a˘i⁄
,

196 
úqa˘i⁄
 
	gúq_iß
 = { 
no_a˘i⁄
, 0, 
CPU_MASK_NONE
, "iß", 
NULL
, NULL };

198 
__öô
 
	$˛ps7500_öô_úq
()

200 
úq
, 
Êags
;

202 
	`iomd_wrôeb
(0, 
IOMD_IRQMASKA
);

203 
	`iomd_wrôeb
(0, 
IOMD_IRQMASKB
);

204 
	`iomd_wrôeb
(0, 
IOMD_FIQMASK
);

205 
	`iomd_wrôeb
(0, 
IOMD_DMAMASK
);

207 
úq
 = 0; irq < 
NR_IRQS
; irq++) {

208 
Êags
 = 
IRQF_VALID
;

210 i‡(
úq
 <= 6 || (irq >= 9 && irq <= 15) ||

211 (
úq
 >= 48 && irq <= 55))

212 
Êags
 |
IRQF_PROBE
;

214 
úq
) {

216 
	`£t_úq_chù
(
úq
, &
˛ps7500_a_chù
);

217 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

218 
	`£t_úq_Êags
(
úq
, 
Êags
);

222 
	`£t_úq_chù
(
úq
, &
˛ps7500_b_chù
);

223 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

224 
	`£t_úq_Êags
(
úq
, 
Êags
);

228 
	`£t_úq_chù
(
úq
, &
˛ps7500_dma_chù
);

229 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

230 
	`£t_úq_Êags
(
úq
, 
Êags
);

234 
	`£t_úq_chù
(
úq
, &
˛ps7500_c_chù
);

235 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

236 
	`£t_úq_Êags
(
úq
, 
Êags
);

240 
	`£t_úq_chù
(
úq
, &
˛ps7500_d_chù
);

241 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

242 
	`£t_úq_Êags
(
úq
, 
Êags
);

246 
	`£t_úq_chù
(
úq
, &
˛ps7500_no_chù
);

247 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

248 
	`£t_úq_Êags
(
úq
, 
Êags
);

252 
	`£t_úq_chù
(
úq
, &
˛ps7500_fiq_chù
);

253 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

254 
	`£t_úq_Êags
(
úq
, 
Êags
);

259 
	`£tup_úq
(
IRQ_ISA
, &
úq_iß
);

260 
	}
}

262 
m≠_desc
 
	g˛7500_io_desc
[] 
	g__öôd©a
 = {

264 .
vútuÆ
 = ()
IO_BASE
,

265 .
	gp‚
 = 
__phys_to_p‚
(
IO_START
),

266 .
	gÀngth
 = 
IO_SIZE
,

267 .
	gty≥
 = 
MT_DEVICE


269 .
	gvútuÆ
 = 
ISA_BASE
,

270 .
	gp‚
 = 
__phys_to_p‚
(
ISA_START
),

271 .
	gÀngth
 = 
ISA_SIZE
,

272 .
	gty≥
 = 
MT_DEVICE


274 .
	gvútuÆ
 = 
FLASH_BASE
,

275 .
	gp‚
 = 
__phys_to_p‚
(
FLASH_START
),

276 .
	gÀngth
 = 
FLASH_SIZE
,

277 .
	gty≥
 = 
MT_DEVICE


279 .
	gvútuÆ
 = 
LED_BASE
,

280 .
	gp‚
 = 
__phys_to_p‚
(
LED_START
),

281 .
	gÀngth
 = 
LED_SIZE
,

282 .
	gty≥
 = 
MT_DEVICE


286 
__öô
 
	$˛ps7500_m≠_io
()

288 
	`iŸabÀ_öô
(
˛7500_io_desc
, 
	`ARRAY_SIZE
(cl7500_io_desc));

289 
	}
}

291 
io˘ime_öô
();

292 
ioc_timî_gëtimeoff£t
();

294 
úqªtu∫_t


295 
	$˛ps7500_timî_öãºu±
(
úq
, *
dev_id
)

297 
	`wrôe_£qlock
(&
xtime_lock
);

299 
	`timî_tick
();

304 
cou¡
, 
°©e
 = 0xff00;

305 i‡(
cou¡
-- == 0) {

306 
°©e
 ^= 0x100;

307 
cou¡
 = 25;

308 *((vﬁ©ûê*)
LED_ADDRESS
Ë
°©e
;

312 
	`wrôe_£qu∆ock
(&
xtime_lock
);

314  
IRQ_HANDLED
;

315 
	}
}

317 
úqa˘i⁄
 
	g˛ps7500_timî_úq
 = {

318 .
«me
 = "CLPS7500 Timer Tick",

319 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

320 .
	gh™dÀr
 = 
˛ps7500_timî_öãºu±
,

326 
__öô
 
	$˛ps7500_timî_öô
()

328 
	`io˘ime_öô
();

329 
	`£tup_úq
(
IRQ_TIMER
, &
˛ps7500_timî_úq
);

330 
	}
}

332 
sys_timî
 
	g˛ps7500_timî
 = {

333 .
öô
 = 
˛ps7500_timî_öô
,

334 .
	goff£t
 = 
ioc_timî_gëtimeoff£t
,

337 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

339 .
m≠ba£
 = 0x03010fe0,

340 .
	gúq
 = 10,

341 .
	gu¨t˛k
 = 1843200,

342 .
	gªgshi·
 = 2,

343 .
	giŸy≥
 = 
UPIO_MEM
,

344 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
 | 
UPF_SKIP_TEST
,

347 .
	gm≠ba£
 = 0x03010be0,

348 .
	gúq
 = 0,

349 .
	gu¨t˛k
 = 1843200,

350 .
	gªgshi·
 = 2,

351 .
	giŸy≥
 = 
UPIO_MEM
,

352 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
 | 
UPF_SKIP_TEST
,

355 .
	gioba£
 = 
ISASLOT_IO
 + 0x2e8,

356 .
	gúq
 = 41,

357 .
	gu¨t˛k
 = 1843200,

358 .
	gªgshi·
 = 0,

359 .
	giŸy≥
 = 
UPIO_PORT
,

360 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

363 .
	gioba£
 = 
ISASLOT_IO
 + 0x3e8,

364 .
	gúq
 = 40,

365 .
	gu¨t˛k
 = 1843200,

366 .
	gªgshi·
 = 0,

367 .
	giŸy≥
 = 
UPIO_PORT
,

368 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

373 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

374 .
«me
 = "serial8250",

375 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

376 .
	gdev
 = {

377 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

381 
__öô
 
	$˛ps7500_öô
()

383 
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

384 
	}
}

386 
MACHINE_START
(
CLPS7500
, "CL-PS7500")

388 .
	gphys_io
 = 0x03000000,

389 .
	gio_pg_off°
 = ((0xe0000000) >> 18) & 0xfffc,

390 .
	gm≠_io
 = 
˛ps7500_m≠_io
,

391 .
	göô_úq
 = 
˛ps7500_öô_úq
,

392 .
	göô_machöe
 = 
˛ps7500_öô
,

393 .
	gtimî
 = &
˛ps7500_timî
,

394 
	gMACHINE_END


	@arch/arm/mach-davinci/board-evm.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/dma-m≠pög.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

16 
	~<löux/mtd/mtd.h
>

17 
	~<löux/mtd/∑πôi⁄s.h
>

18 
	~<löux/mtd/physm≠.h
>

20 
	~<asm/£tup.h
>

21 
	~<asm/io.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/m≠.h
>

27 
	~<asm/mach/Êash.h
>

29 
	~<asm/¨ch/comm⁄.h
>

32 
__öô
 
davöci_psc_öô
();

33 
__öô
 
davöci_úq_öô
();

34 
__öô
 
davöci_m≠_comm⁄_io
();

37 
	#NOR_FLASH_PHYS
 0x02000000

	)

39 
mtd_∑πôi⁄
 
	gdavöci_evm_∑πôi⁄s
[] = {

42 .
«me
 = "bootloader",

43 .
	goff£t
 = 0,

44 .
	gsize
 = 4 * 
SZ_64K
,

45 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

49 .
	g«me
 = "params",

50 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

51 .
	gsize
 = 
SZ_64K
,

52 .
	gmask_Êags
 = 0,

56 .
	g«me
 = "kernel",

57 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

58 .
	gsize
 = 
SZ_2M
,

59 .
	gmask_Êags
 = 0

63 .
	g«me
 = "filesystem",

64 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

65 .
	gsize
 = 
MTDPART_SIZ_FULL
,

66 .
	gmask_Êags
 = 0

70 
physm≠_Êash_d©a
 
	gdavöci_evm_Êash_d©a
 = {

71 .
width
 = 2,

72 .
	g∑πs
 = 
davöci_evm_∑πôi⁄s
,

73 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
davöci_evm_∑πôi⁄s
),

78 
ªsour˚
 
	gdavöci_evm_Êash_ªsour˚
 = {

79 .
°¨t
 = 
NOR_FLASH_PHYS
,

80 .
	gíd
 = 
NOR_FLASH_PHYS
 + 
SZ_16M
 - 1,

81 .
	gÊags
 = 
IORESOURCE_MEM
,

84 
∂©f‹m_devi˚
 
	gdavöci_evm_Êash_devi˚
 = {

85 .
«me
 = "physmap-flash",

86 .
	gid
 = 0,

87 .
	gdev
 = {

88 .
∂©f‹m_d©a
 = &
davöci_evm_Êash_d©a
,

90 .
	gnum_ªsour˚s
 = 1,

91 .
	gªsour˚
 = &
davöci_evm_Êash_ªsour˚
,

94 
∂©f‹m_devi˚
 *
	gdavöci_evm_devi˚s
[] 
	g__öôd©a
 = {

95 &
davöci_evm_Êash_devi˚
,

98 
__öô


99 
	$davöci_evm_m≠_io
()

101 
	`davöci_m≠_comm⁄_io
();

102 
	}
}

104 
__öô
 
	$davöci_evm_öô
()

106 
	`davöci_psc_öô
();

108 #i‡
	`deföed
(
CONFIG_BLK_DEV_DAVINCI
Ë|| deföed(
CONFIG_BLK_DEV_DAVINCI_MODULE
)

109 
	`¥ötk
(
KERN_WARNING
 "WARNING: both IDEánd NOR flasháreÉnabled, "

113 
	`∂©f‹m_add_devi˚s
(
davöci_evm_devi˚s
,

114 
	`ARRAY_SIZE
(
davöci_evm_devi˚s
));

115 
	}
}

117 
__öô
 
	$davöci_evm_úq_öô
()

119 
	`davöci_úq_öô
();

120 
	}
}

122 
MACHINE_START
(
DAVINCI_EVM
, "DaVinci EVM")

124 .
	gphys_io
 = 
IO_PHYS
,

125 .
	gio_pg_off°
 = (
io_p2v
(
IO_PHYS
) >> 18) & 0xfffc,

126 .
	gboŸ_∑øms
 = (
DAVINCI_DDR_BASE
 + 0x100),

127 .
	gm≠_io
 = 
davöci_evm_m≠_io
,

128 .
	göô_úq
 = 
davöci_evm_úq_öô
,

129 .
	gtimî
 = &
davöci_timî
,

130 .
	göô_machöe
 = 
davöci_evm_öô
,

131 
	gMACHINE_END


	@arch/arm/mach-davinci/id.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

17 
	~<asm/io.h
>

19 
	#JTAG_ID_BASE
 0x01c40028

	)

21 
	sdavöci_id
 {

22 
u8
 
	mv¨ü¡
;

23 
u16
 
	m∑π_no
;

24 
u32
 
	mm™uÁ˘uªr
;

25 
u32
 
	mty≥
;

29 
davöci_id
 
	gdavöci_ids
[] 
	g__öôd©a
 = {

32 .
∑π_no
 = 0xb700,

33 .
	gv¨ü¡
 = 0x0,

34 .
	gm™uÁ˘uªr
 = 0x017,

35 .
	gty≥
 = 0x64460000,

42 
u16
 
__öô
 
	$davöci_gë_∑π_no
()

44 
u32
 
dev_id
, 
∑π_no
;

46 
dev_id
 = 
	`davöci_ªadl
(
JTAG_ID_BASE
);

48 
∑π_no
 = ((
dev_id
 >> 12) & 0xffff);

50  
∑π_no
;

51 
	}
}

56 
u8
 
__öô
 
	$davöci_gë_v¨ü¡
()

58 
u32
 
v¨ü¡
;

60 
v¨ü¡
 = 
	`davöci_ªadl
(
JTAG_ID_BASE
);

62 
v¨ü¡
 = (variant >> 28) & 0xf;

64  
v¨ü¡
;

65 
	}
}

67 
__öô
 
	$davöci_check_ªvisi⁄
()

69 
i
;

70 
u16
 
∑π_no
;

71 
u8
 
v¨ü¡
;

73 
∑π_no
 = 
	`davöci_gë_∑π_no
();

74 
v¨ü¡
 = 
	`davöci_gë_v¨ü¡
();

77 
i
 = 0; i < 
	`ARRAY_SIZE
(
davöci_ids
); i++) {

78 i‡(
∑π_no
 =(
davöci_ids
[
i
].part_no)) {

79 
sy°em_ªv
 = 
davöci_ids
[
i
].
ty≥
;

85 
i
 = 0; i < 
	`ARRAY_SIZE
(
davöci_ids
); i++) {

86 i‡(
∑π_no
 =
davöci_ids
[
i
].part_no &&

87 
v¨ü¡
 =
davöci_ids
[
i
].variant) {

88 
sy°em_ªv
 = 
davöci_ids
[
i
].
ty≥
;

93 
	`¥ötk
("DaVöcòDM%04x v¨ü¡ 0x%x\n", 
sy°em_ªv
 >> 16, 
v¨ü¡
);

94 
	}
}

	@arch/arm/mach-davinci/io.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/öô.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/io.h
>

17 
	~<asm/mem‹y.h
>

19 
	~<asm/mach/m≠.h
>

21 
davöci_check_ªvisi⁄
();

27 
m≠_desc
 
	gdavöci_io_desc
[] 
	g__öôd©a
 = {

29 .
vútuÆ
 = 
IO_VIRT
,

30 .
	gp‚
 = 
__phys_to_p‚
(
IO_PHYS
),

31 .
	gÀngth
 = 
IO_SIZE
,

32 .
	gty≥
 = 
MT_DEVICE


36 
__öô
 
	$davöci_m≠_comm⁄_io
()

38 
	`iŸabÀ_öô
(
davöci_io_desc
, 
	`ARRAY_SIZE
(davinci_io_desc));

44 
	`loˇl_Êush_éb_Æl
();

45 
	`Êush_ˇche_Æl
();

50 
	`davöci_check_ªvisi⁄
();

51 
	}
}

	@arch/arm/mach-davinci/irq.c

21 
	~<löux/kî√l.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/úq.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/mach/úq.h
>

30 
	#IRQ_BIT
(
úq
Ë((úqË& 0x1f)

	)

32 
	#FIQ_REG0_OFFSET
 0x0000

	)

33 
	#FIQ_REG1_OFFSET
 0x0004

	)

34 
	#IRQ_REG0_OFFSET
 0x0008

	)

35 
	#IRQ_REG1_OFFSET
 0x000C

	)

36 
	#IRQ_ENT_REG0_OFFSET
 0x0018

	)

37 
	#IRQ_ENT_REG1_OFFSET
 0x001C

	)

38 
	#IRQ_INCTL_REG_OFFSET
 0x0020

	)

39 
	#IRQ_EABASE_REG_OFFSET
 0x0024

	)

40 
	#IRQ_INTPRI0_REG_OFFSET
 0x0030

	)

41 
	#IRQ_INTPRI7_REG_OFFSET
 0x004C

	)

43 
ölöe
 
	$davöci_úq_ªadl
(
off£t
)

45  
	`davöci_ªadl
(
DAVINCI_ARM_INTC_BASE
 + 
off£t
);

46 
	}
}

48 
ölöe
 
	$davöci_úq_wrôñ
(
vÆue
, 
off£t
)

50 
	`davöci_wrôñ
(
vÆue
, 
DAVINCI_ARM_INTC_BASE
 + 
off£t
);

51 
	}
}

54 
	$davöci_mask_úq
(
úq
)

56 
mask
;

57 
u32
 
l
;

59 
mask
 = 1 << 
	`IRQ_BIT
(
úq
);

61 i‡(
úq
 > 31) {

62 
l
 = 
	`davöci_úq_ªadl
(
IRQ_ENT_REG1_OFFSET
);

63 
l
 &~
mask
;

64 
	`davöci_úq_wrôñ
(
l
, 
IRQ_ENT_REG1_OFFSET
);

66 
l
 = 
	`davöci_úq_ªadl
(
IRQ_ENT_REG0_OFFSET
);

67 
l
 &~
mask
;

68 
	`davöci_úq_wrôñ
(
l
, 
IRQ_ENT_REG0_OFFSET
);

70 
	}
}

73 
	$davöci_unmask_úq
(
úq
)

75 
mask
;

76 
u32
 
l
;

78 
mask
 = 1 << 
	`IRQ_BIT
(
úq
);

80 i‡(
úq
 > 31) {

81 
l
 = 
	`davöci_úq_ªadl
(
IRQ_ENT_REG1_OFFSET
);

82 
l
 |
mask
;

83 
	`davöci_úq_wrôñ
(
l
, 
IRQ_ENT_REG1_OFFSET
);

85 
l
 = 
	`davöci_úq_ªadl
(
IRQ_ENT_REG0_OFFSET
);

86 
l
 |
mask
;

87 
	`davöci_úq_wrôñ
(
l
, 
IRQ_ENT_REG0_OFFSET
);

89 
	}
}

92 
	$davöci_ack_úq
(
úq
)

94 
mask
;

96 
mask
 = 1 << 
	`IRQ_BIT
(
úq
);

98 i‡(
úq
 > 31)

99 
	`davöci_úq_wrôñ
(
mask
, 
IRQ_REG1_OFFSET
);

101 
	`davöci_úq_wrôñ
(
mask
, 
IRQ_REG0_OFFSET
);

102 
	}
}

104 
úq_chù
 
	gdavöci_úq_chù_0
 = {

105 .
«me
 = "AINTC",

106 .
	gack
 = 
davöci_ack_úq
,

107 .
	gmask
 = 
davöci_mask_úq
,

108 .
	gunmask
 = 
davöci_unmask_úq
,

113 c⁄° 
u8
 
	gdeÁu…_¥i‹ôõs
[
DAVINCI_N_AINTC_IRQ
] 
	g__öôd©a
 = {

114 [
IRQ_VDINT0
] = 2,

115 [
IRQ_VDINT1
] = 6,

116 [
IRQ_VDINT2
] = 6,

117 [
IRQ_HISTINT
] = 6,

118 [
IRQ_H3AINT
] = 6,

119 [
IRQ_PRVUINT
] = 6,

120 [
IRQ_RSZINT
] = 6,

122 [
IRQ_VENCINT
] = 6,

123 [
IRQ_ASQINT
] = 6,

124 [
IRQ_IMXINT
] = 6,

125 [
IRQ_VLCDINT
] = 6,

126 [
IRQ_USBINT
] = 4,

127 [
IRQ_EMACINT
] = 4,

130 [
IRQ_CCINT0
] = 5,

131 [
IRQ_CCERRINT
] = 5,

132 [
IRQ_TCERRINT0
] = 5,

133 [
IRQ_TCERRINT
] = 5,

134 [
IRQ_PSCIN
] = 7,

136 [
IRQ_IDE
] = 4,

138 [
IRQ_MBXINT
] = 7,

139 [
IRQ_MBRINT
] = 7,

140 [
IRQ_MMCINT
] = 7,

141 [
IRQ_SDIOINT
] = 7,

143 [
IRQ_DDRINT
] = 7,

144 [
IRQ_AEMIFINT
] = 7,

145 [
IRQ_VLQINT
] = 4,

146 [
IRQ_TINT0_TINT12
] = 2,

147 [
IRQ_TINT0_TINT34
] = 2,

148 [
IRQ_TINT1_TINT12
] = 7,

149 [
IRQ_TINT1_TINT34
] = 7,

150 [
IRQ_PWMINT0
] = 7,

151 [
IRQ_PWMINT1
] = 7,

152 [
IRQ_PWMINT2
] = 7,

153 [
IRQ_I2C
] = 3,

154 [
IRQ_UARTINT0
] = 3,

155 [
IRQ_UARTINT1
] = 3,

156 [
IRQ_UARTINT2
] = 3,

157 [
IRQ_SPINT0
] = 3,

158 [
IRQ_SPINT1
] = 3,

160 [
IRQ_DSP2ARM0
] = 4,

161 [
IRQ_DSP2ARM1
] = 4,

162 [
IRQ_GPIO0
] = 7,

163 [
IRQ_GPIO1
] = 7,

164 [
IRQ_GPIO2
] = 7,

165 [
IRQ_GPIO3
] = 7,

166 [
IRQ_GPIO4
] = 7,

167 [
IRQ_GPIO5
] = 7,

168 [
IRQ_GPIO6
] = 7,

169 [
IRQ_GPIO7
] = 7,

170 [
IRQ_GPIOBNK0
] = 7,

171 [
IRQ_GPIOBNK1
] = 7,

172 [
IRQ_GPIOBNK2
] = 7,

173 [
IRQ_GPIOBNK3
] = 7,

174 [
IRQ_GPIOBNK4
] = 7,

175 [
IRQ_COMMTX
] = 7,

176 [
IRQ_COMMRX
] = 7,

177 [
IRQ_EMUINT
] = 7,

181 
__öô
 
	$davöci_úq_öô
()

183 
i
;

184 c⁄° 
u8
 *
¥i‹ôy
 = 
deÁu…_¥i‹ôõs
;

187 
	`davöci_úq_wrôñ
(~0x0, 
FIQ_REG0_OFFSET
);

188 
	`davöci_úq_wrôñ
(~0x0, 
FIQ_REG1_OFFSET
);

189 
	`davöci_úq_wrôñ
(~0x0, 
IRQ_REG0_OFFSET
);

190 
	`davöci_úq_wrôñ
(~0x0, 
IRQ_REG1_OFFSET
);

193 
	`davöci_úq_wrôñ
(0x0, 
IRQ_ENT_REG0_OFFSET
);

194 
	`davöci_úq_wrôñ
(0x0, 
IRQ_ENT_REG1_OFFSET
);

197 
	`davöci_úq_wrôñ
(0x0, 
IRQ_INCTL_REG_OFFSET
);

200 
	`davöci_úq_wrôñ
(0, 
IRQ_EABASE_REG_OFFSET
);

203 
	`davöci_úq_wrôñ
(~0x0, 
FIQ_REG0_OFFSET
);

204 
	`davöci_úq_wrôñ
(~0x0, 
FIQ_REG1_OFFSET
);

205 
	`davöci_úq_wrôñ
(~0x0, 
IRQ_REG0_OFFSET
);

206 
	`davöci_úq_wrôñ
(~0x0, 
IRQ_REG1_OFFSET
);

208 
i
 = 
IRQ_INTPRI0_REG_OFFSET
; i <
IRQ_INTPRI7_REG_OFFSET
; i += 4) {

209 
j
;

210 
u32
 
¥i
;

212 
j
 = 0, 
¥i
 = 0; j < 32; j +4, 
¥i‹ôy
++)

213 
¥i
 |(*
¥i‹ôy
 & 0x07Ë<< 
j
;

214 
	`davöci_úq_wrôñ
(
¥i
, 
i
);

218 
i
 = 0; i < 
DAVINCI_N_AINTC_IRQ
; i++) {

219 
	`£t_úq_chù
(
i
, &
davöci_úq_chù_0
);

220 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

221 i‡(
i
 !
IRQ_TINT1_TINT34
)

222 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_edge_úq
);

224 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

226 
	}
}

	@arch/arm/mach-davinci/psc.c

21 
	~<löux/kî√l.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/öô.h
>

25 
	~<asm/io.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/¨ch/psc.h
>

29 
	#PTCMD
 
	`__REG
(0x01C41120)

	)

30 
	#PDSTAT
 
	`__REG
(0x01C41200)

	)

31 
	#PDCTL1
 
	`__REG
(0x01C41304)

	)

32 
	#EPCPR
 
	`__REG
(0x01C41070)

	)

33 
	#PTSTAT
 
	`__REG
(0x01C41128)

	)

35 
	#MDSTAT
 
	`IO_ADDRESS
(0x01C41800)

	)

36 
	#MDCTL
 
	`IO_ADDRESS
(0x01C41A00)

	)

38 
	#PINMUX0
 
	`__REG
(0x01c40000)

	)

39 
	#PINMUX1
 
	`__REG
(0x01c40004)

	)

40 
	#VDD3P3V_PWDN
 
	`__REG
(0x01C40048)

	)

42 
	$davöci_psc_mux
(
id
)

44 
id
) {

45 
DAVINCI_LPSC_ATA
:

46 
PINMUX0
 |= (1 << 17) | (1 << 16);

48 
DAVINCI_LPSC_MMC_SD
:

53 
VDD3P3V_PWDN
 = 0x0;

54 
PINMUX1
 &= (~(1 << 9));

56 
DAVINCI_LPSC_I2C
:

57 
PINMUX1
 |= (1 << 7);

59 
DAVINCI_LPSC_McBSP
:

60 
PINMUX1
 |= (1 << 10);

65 
	}
}

68 
	$davöci_psc_c⁄fig
(
domaö
, 
id
, 
íabÀ
)

70 vﬁ©ûê*
md°©
 = (*)(()
MDSTAT
 + 4 * 
id
);

71 vﬁ©ûê*
md˘l
 = (*)(()
MDCTL
 + 4 * 
id
);

73 i‡(
id
 < 0)

76 i‡(
íabÀ
)

77 *
md˘l
 |= 0x00000003;

79 *
md˘l
 &= 0xFFFFFFF2;

81 i‡((
PDSTAT
 & 0x00000001) == 0) {

82 
PDCTL1
 |= 0x1;

83 
PTCMD
 = (1 << 
domaö
);

84 (((
EPCPR
 >> 
domaö
) & 1) == 0));

86 
PDCTL1
 |= 0x100;

87 !(((
PTSTAT
 >> 
domaö
) & 1) == 0));

89 
PTCMD
 = (1 << 
domaö
);

90 !(((
PTSTAT
 >> 
domaö
) & 1) == 0));

93 i‡(
íabÀ
)

94 !((*
md°©
 & 0x0000001F) == 0x3));

96 !((*
md°©
 & 0x0000001F) == 0x2));

98 i‡(
íabÀ
)

99 
	`davöci_psc_mux
(
id
);

100 
	}
}

102 
__öô
 
	$davöci_psc_öô
()

104 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_VPSSMSTR
, 1);

105 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_VPSSSLV
, 1);

106 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_TPCC
, 1);

107 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_TPTC0
, 1);

108 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_TPTC1
, 1);

109 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_GPIO
, 1);

112 
	`davöci_psc_c⁄fig
(
DAVINCI_GPSC_ARMDOMAIN
, 
DAVINCI_LPSC_TIMER2
, 1);

113 
	}
}

	@arch/arm/mach-davinci/serial.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/£rül_8250.h
>

25 
	~<löux/£rül_ªg.h
>

26 
	~<löux/∂©f‹m_devi˚.h
>

27 
	~<löux/dñay.h
>

28 
	~<löux/˛k.h
>

30 
	~<asm/io.h
>

31 
	~<asm/úq.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/¨ch/£rül.h
>

34 
	~<asm/¨ch/úqs.h
>

36 
	#UART_DAVINCI_PWREMU
 0x0c

	)

38 
ölöe
 
	$davöci_£rül_ö
(
∂©_£rül8250_p‹t
 *
up
,

39 
off£t
)

41 
off£t
 <<
up
->
ªgshi·
;

42  ()
	`__øw_ªadb
(
up
->
memba£
 + 
off£t
);

43 
	}
}

45 
ölöe
 
	$davöci_£rül_ouç
(
∂©_£rül8250_p‹t
 *
p
,

46 
off£t
, 
vÆue
)

48 
off£t
 <<
p
->
ªgshi·
;

49 
	`__øw_wrôeb
(
vÆue
, 
p
->
memba£
 + 
off£t
);

50 
	}
}

52 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

54 .
memba£
 = (*)
IO_ADDRESS
(
DAVINCI_UART0_BASE
),

55 .
	gm≠ba£
 = ()
DAVINCI_UART0_BASE
,

56 .
	gúq
 = 
IRQ_UARTINT0
,

57 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

58 .
	giŸy≥
 = 
UPIO_MEM
,

59 .
	gªgshi·
 = 2,

60 .
	gu¨t˛k
 = 27000000,

63 .
	gÊags
 = 0

67 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

68 .
«me
 = "serial8250",

69 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

70 .
	gdev
 = {

71 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

75 
__öô
 
	$davöci_£rül_ª£t
(
∂©_£rül8250_p‹t
 *
p
)

78 
pwªmu
 = 0;

80 
	`davöci_£rül_ouç
(
p
, 
UART_IER
, 0);

82 
	`davöci_£rül_ouç
(
p
, 
UART_DAVINCI_PWREMU
, 
pwªmu
);

83 
	`mdñay
(10);

85 
pwªmu
 |= (0x3 << 13);

86 
pwªmu
 |= 0x1;

87 
	`davöci_£rül_ouç
(
p
, 
UART_DAVINCI_PWREMU
, 
pwªmu
);

88 
	}
}

90 
__öô
 
	$davöci_öô
()

92 
	`davöci_£rül_ª£t
(&
£rül_∂©f‹m_d©a
[0]);

93  
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

94 
	}
}

96 
¨ch_öôˇŒ
(
davöci_öô
);

	@arch/arm/mach-davinci/time.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/ty≥s.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/˛ocksour˚.h
>

16 
	~<löux/˛ockchùs.h
>

17 
	~<löux/•ölock.h
>

19 
	~<asm/io.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mach/úq.h
>

24 
	~<asm/mach/time.h
>

25 
	~<asm/î∫o.h
>

26 
	~<asm/¨ch/io.h
>

28 
˛ock_evít_devi˚
 
	g˛ockevít_davöci
;

30 
	#DAVINCI_TIMER0_BASE
 (
IO_PHYS
 + 0x21400)

	)

31 
	#DAVINCI_TIMER1_BASE
 (
IO_PHYS
 + 0x21800)

	)

32 
	#DAVINCI_WDOG_BASE
 (
IO_PHYS
 + 0x21C00)

	)

35 
	mT0_BOT
 = 0, 
	mT0_TOP
, 
	mT1_BOT
, 
	mT1_TOP
, 
	mNUM_TIMERS
,

38 
	#IS_TIMER1
(
id
Ë(id & 0x2)

	)

39 
	#IS_TIMER0
(
id
Ë(!
	`IS_TIMER1
(id))

	)

40 
	#IS_TIMER_TOP
(
id
Ë((id & 0x1))

	)

41 
	#IS_TIMER_BOT
(
id
Ë(!
	`IS_TIMER_TOP
(id))

	)

43 
	gtimî_úqs
[
NUM_TIMERS
] = {

44 
IRQ_TINT0_TINT12
,

45 
IRQ_TINT0_TINT34
,

46 
IRQ_TINT1_TINT12
,

47 
IRQ_TINT1_TINT34
,

59 
	#TID_CLOCKEVENT
 
T0_BOT


	)

60 
	#TID_CLOCKSOURCE
 
T0_TOP


	)

63 
	#PID12
 0x0

	)

64 
	#TIM12
 0x10

	)

65 
	#TIM34
 0x14

	)

66 
	#PRD12
 0x18

	)

67 
	#PRD34
 0x1c

	)

68 
	#TCR
 0x20

	)

69 
	#TGCR
 0x24

	)

70 
	#WDTCR
 0x28

	)

73 
	#TCR_ENAMODE_DISABLE
 0x0

	)

74 
	#TCR_ENAMODE_ONESHOT
 0x1

	)

75 
	#TCR_ENAMODE_PERIODIC
 0x2

	)

76 
	#TCR_ENAMODE_MASK
 0x3

	)

78 
	#TGCR_TIMMODE_SHIFT
 2

	)

79 
	#TGCR_TIMMODE_64BIT_GP
 0x0

	)

80 
	#TGCR_TIMMODE_32BIT_UNCHAINED
 0x1

	)

81 
	#TGCR_TIMMODE_64BIT_WDOG
 0x2

	)

82 
	#TGCR_TIMMODE_32BIT_CHAINED
 0x3

	)

84 
	#TGCR_TIM12RS_SHIFT
 0

	)

85 
	#TGCR_TIM34RS_SHIFT
 1

	)

86 
	#TGCR_RESET
 0x0

	)

87 
	#TGCR_UNRESET
 0x1

	)

88 
	#TGCR_RESET_MASK
 0x3

	)

90 
	#WDTCR_WDEN_SHIFT
 14

	)

91 
	#WDTCR_WDEN_DISABLE
 0x0

	)

92 
	#WDTCR_WDEN_ENABLE
 0x1

	)

93 
	#WDTCR_WDKEY_SHIFT
 16

	)

94 
	#WDTCR_WDKEY_SEQ0
 0xa5c6

	)

95 
	#WDTCR_WDKEY_SEQ1
 0xda7e

	)

97 
	stimî_s
 {

98 *
	m«me
;

99 
	mid
;

100 
	m≥riod
;

101 
	m›ts
;

102 
	mªg_ba£
;

103 
	mtim_ªg
;

104 
	m¥d_ªg
;

105 
	míamode_shi·
;

106 
úqa˘i⁄
 
	múqa˘i⁄
;

108 
timî_s
 
	gtimîs
[];

111 
	#TIMER_OPTS_DISABLED
 0x00

	)

112 
	#TIMER_OPTS_ONESHOT
 0x01

	)

113 
	#TIMER_OPTS_PERIODIC
 0x02

	)

115 
	$timî32_c⁄fig
(
timî_s
 *
t
)

117 
u32
 
t¸
 = 
	`davöci_ªadl
(
t
->
ªg_ba£
 + 
TCR
);

120 
t¸
 &~(
TCR_ENAMODE_MASK
 << 
t
->
íamode_shi·
);

121 
	`davöci_wrôñ
(
t¸
, 
t
->
ªg_ba£
 + 
TCR
);

124 
	`davöci_wrôñ
(0, 
t
->
tim_ªg
);

125 
	`davöci_wrôñ
(
t
->
≥riod
,Å->
¥d_ªg
);

128 i‡(
t
->
›ts
 & 
TIMER_OPTS_ONESHOT
) {

129 
t¸
 |
TCR_ENAMODE_ONESHOT
 << 
t
->
íamode_shi·
;

130 } i‡(
t
->
›ts
 & 
TIMER_OPTS_PERIODIC
) {

131 
t¸
 |
TCR_ENAMODE_PERIODIC
 << 
t
->
íamode_shi·
;

134 
	`davöci_wrôñ
(
t¸
, 
t
->
ªg_ba£
 + 
TCR
);

136 
	}
}

138 
ölöe
 
u32
 
	$timî32_ªad
(
timî_s
 *
t
)

140  
	`davöci_ªadl
(
t
->
tim_ªg
);

141 
	}
}

143 
úqªtu∫_t
 
	$timî_öãºu±
(
úq
, *
dev_id
)

145 
˛ock_evít_devi˚
 *
evt
 = &
˛ockevít_davöci
;

147 
evt
->
	`evít_h™dÀr
(evt);

148  
IRQ_HANDLED
;

149 
	}
}

152 
úqªtu∫_t
 
	$‰ìrun_öãºu±
(
úq
, *
dev_id
)

154  
IRQ_HANDLED
;

155 
	}
}

157 
timî_s
 
	gtimîs
[] = {

158 [
TID_CLOCKEVENT
] = {

159 .
«me
 = "clockevent",

160 .
	g›ts
 = 
TIMER_OPTS_DISABLED
,

161 .
	gúqa˘i⁄
 = {

162 .
Êags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
,

163 .
	gh™dÀr
 = 
timî_öãºu±
,

166 [
TID_CLOCKSOURCE
] = {

167 .
«me
 = "free-run counter",

168 .
	g≥riod
 = ~0,

169 .
	g›ts
 = 
TIMER_OPTS_PERIODIC
,

170 .
	gúqa˘i⁄
 = {

171 .
Êags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
,

172 .
	gh™dÀr
 = 
‰ìrun_öãºu±
,

177 
__öô
 
	$timî_öô
()

179 
u32
 
ba£s
[] = {
DAVINCI_TIMER0_BASE
, 
DAVINCI_TIMER1_BASE
};

180 
i
;

183 
i
=0; i<2; i++) {

184 
u32
 
tg¸
, 
ba£
 = 
ba£s
[
i
];

187 
	`davöci_wrôñ
(0, 
ba£
 + 
TCR
);

190 
tg¸
 = 0;

191 
	`davöci_wrôñ
(
tg¸
, 
ba£
 + 
TGCR
);

194 
tg¸
 = 
TGCR_TIMMODE_32BIT_UNCHAINED
 << 
TGCR_TIMMODE_SHIFT
;

195 
	`davöci_wrôñ
(
tg¸
, 
ba£
 + 
TGCR
);

198 
tg¸
 |(
TGCR_UNRESET
 << 
TGCR_TIM12RS_SHIFT
) |

199 (
TGCR_UNRESET
 << 
TGCR_TIM34RS_SHIFT
);

200 
	`davöci_wrôñ
(
tg¸
, 
ba£
 + 
TGCR
);

203 
	`davöci_wrôñ
(0, 
ba£
 + 
TIM12
);

204 
	`davöci_wrôñ
(0, 
ba£
 + 
TIM34
);

208 
i
=0; i< 
	`ARRAY_SIZE
(
timîs
); i++) {

209 
timî_s
 *
t
 = &
timîs
[
i
];

211 i‡(
t
->
«me
) {

212 
t
->
id
 = 
i
;

213 
t
->
ªg_ba£
 = (
	`IS_TIMER1
—->
id
) ?

214 
DAVINCI_TIMER1_BASE
 : 
DAVINCI_TIMER0_BASE
);

216 i‡(
	`IS_TIMER_BOT
(
t
->
id
)) {

217 
t
->
íamode_shi·
 = 6;

218 
t
->
tim_ªg
 =Å->
ªg_ba£
 + 
TIM12
;

219 
t
->
¥d_ªg
 =Å->
ªg_ba£
 + 
PRD12
;

221 
t
->
íamode_shi·
 = 22;

222 
t
->
tim_ªg
 =Å->
ªg_ba£
 + 
TIM34
;

223 
t
->
¥d_ªg
 =Å->
ªg_ba£
 + 
PRD34
;

227 
t
->
úqa˘i⁄
.
«me
 =Å->name;

228 
t
->
úqa˘i⁄
.
dev_id
 = (*)t;

229 i‡(
t
->
úqa˘i⁄
.
h™dÀr
 !
NULL
) {

230 
	`£tup_úq
(
timî_úqs
[
t
->
id
], &t->
úqa˘i⁄
);

233 
	`timî32_c⁄fig
(&
timîs
[
i
]);

236 
	}
}

241 
cy˛e_t
 
	$ªad_cy˛es
()

243 
timî_s
 *
t
 = &
timîs
[
TID_CLOCKSOURCE
];

245  (
cy˛es_t
)
	`timî32_ªad
(
t
);

246 
	}
}

248 
˛ocksour˚
 
	g˛ocksour˚_davöci
 = {

249 .
«me
 = "timer0_1",

250 .
	gøtög
 = 300,

251 .
	gªad
 = 
ªad_cy˛es
,

252 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

253 .
	gshi·
 = 24,

254 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

260 
	$davöci_£t_√xt_evít
(
cy˛es
,

261 
˛ock_evít_devi˚
 *
evt
)

263 
timî_s
 *
t
 = &
timîs
[
TID_CLOCKEVENT
];

265 
t
->
≥riod
 = 
cy˛es
;

266 
	`timî32_c⁄fig
(
t
);

268 
	}
}

270 
	$davöci_£t_mode
(
˛ock_evít_mode
 
mode
,

271 
˛ock_evít_devi˚
 *
evt
)

273 
timî_s
 *
t
 = &
timîs
[
TID_CLOCKEVENT
];

275 
mode
) {

276 
CLOCK_EVT_MODE_PERIODIC
:

277 
t
->
≥riod
 = 
CLOCK_TICK_RATE
 / (
HZ
);

278 
t
->
›ts
 = 
TIMER_OPTS_PERIODIC
;

279 
	`timî32_c⁄fig
(
t
);

281 
CLOCK_EVT_MODE_ONESHOT
:

282 
t
->
›ts
 = 
TIMER_OPTS_ONESHOT
;

284 
CLOCK_EVT_MODE_UNUSED
:

285 
CLOCK_EVT_MODE_SHUTDOWN
:

286 
t
->
›ts
 = 
TIMER_OPTS_DISABLED
;

289 
	}
}

291 
˛ock_evít_devi˚
 
	g˛ockevít_davöci
 = {

292 .
«me
 = "timer0_0",

293 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

294 .
	gshi·
 = 32,

295 .
	g£t_√xt_evít
 = 
davöci_£t_√xt_evít
,

296 .
	g£t_mode
 = 
davöci_£t_mode
,

300 
__öô
 
	$davöci_timî_öô
()

302 
îr
[] 
__öôd©a
 = 
KERN_ERR


306 
	`timî_öô
();

309 
˛ocksour˚_davöci
.
mu…
 =

310 
	`˛ocksour˚_khz2mu…
(
CLOCK_TICK_RATE
/1000,

311 
˛ocksour˚_davöci
.
shi·
);

312 i‡(
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_davöci
))

313 
	`¥ötk
(
îr
, 
˛ocksour˚_davöci
.
«me
);

316 
˛ockevít_davöci
.
mu…
 = 
	`div_sc
(
CLOCK_TICK_RATE
, 
NSEC_PER_SEC
,

317 
˛ockevít_davöci
.
shi·
);

318 
˛ockevít_davöci
.
max_dñè_ns
 =

319 
	`˛ockevít_dñè2ns
(0xffffff„, &
˛ockevít_davöci
);

320 
˛ockevít_davöci
.
mö_dñè_ns
 =

321 
	`˛ockevít_dñè2ns
(1, &
˛ockevít_davöci
);

323 
˛ockevít_davöci
.
˝umask
 = 
	`˝umask_of_˝u
(0);

324 
	`˛ockevíts_ªgi°î_devi˚
(&
˛ockevít_davöci
);

325 
	}
}

327 
sys_timî
 
	gdavöci_timî
 = {

328 .
öô
 = 
davöci_timî_öô
,

333 
	$davöci_w©chdog_ª£t
() {

334 
u32
 
tg¸
, 
wdt¸
, 
ba£
 = 
DAVINCI_WDOG_BASE
;

337 
	`davöci_wrôñ
(0, 
ba£
 + 
TCR
);

340 
tg¸
 = 0;

341 
	`davöci_wrôñ
(
tg¸
, 
ba£
 + 
TCR
);

342 
tg¸
 = 
TGCR_TIMMODE_64BIT_WDOG
 << 
TGCR_TIMMODE_SHIFT
;

343 
tg¸
 |(
TGCR_UNRESET
 << 
TGCR_TIM12RS_SHIFT
) |

344 (
TGCR_UNRESET
 << 
TGCR_TIM34RS_SHIFT
);

345 
	`davöci_wrôñ
(
tg¸
, 
ba£
 + 
TCR
);

348 
	`davöci_wrôñ
(0, 
ba£
 + 
TIM12
);

349 
	`davöci_wrôñ
(0, 
ba£
 + 
TIM34
);

350 
	`davöci_wrôñ
(0, 
ba£
 + 
PRD12
);

351 
	`davöci_wrôñ
(0, 
ba£
 + 
PRD34
);

354 
wdt¸
 = 
	`davöci_ªadl
(
ba£
 + 
WDTCR
);

355 
wdt¸
 |
WDTCR_WDEN_ENABLE
 << 
WDTCR_WDEN_SHIFT
;

356 
	`davöci_wrôñ
(
wdt¸
, 
ba£
 + 
WDTCR
);

359 
wdt¸
 = (
WDTCR_WDKEY_SEQ0
 << 
WDTCR_WDKEY_SHIFT
) |

360 (
WDTCR_WDEN_ENABLE
 << 
WDTCR_WDEN_SHIFT
);

361 
	`davöci_wrôñ
(
wdt¸
, 
ba£
 + 
WDTCR
);

364 
wdt¸
 = (
WDTCR_WDKEY_SEQ1
 << 
WDTCR_WDKEY_SHIFT
) |

365 (
WDTCR_WDEN_ENABLE
 << 
WDTCR_WDEN_SHIFT
);

366 
	`davöci_wrôñ
(
wdt¸
, 
ba£
 + 
WDTCR
);

370 
wdt¸
 = 0x00004000;

371 
	`davöci_wrôñ
(
wdt¸
, 
ba£
 + 
WDTCR
);

372 
	}
}

	@arch/arm/mach-ebsa110/core.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/£rül_8250.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/h¨dw¨e.h
>

19 
	~<asm/úq.h
>

20 
	~<asm/io.h
>

21 
	~<asm/£tup.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/∑ge.h
>

25 
	~<asm/sy°em.h
>

27 
	~<asm/mach/¨ch.h
>

28 
	~<asm/mach/úq.h
>

29 
	~<asm/mach/m≠.h
>

31 
	~<asm/mach/time.h
>

33 
	#IRQ_MASK
 0x„000000

	)

34 
	#IRQ_MSET
 0x„000000

	)

35 
	#IRQ_STAT
 0xff000000

	)

36 
	#IRQ_MCLR
 0xff000000

	)

38 
	$ebß110_mask_úq
(
úq
)

40 
	`__øw_wrôeb
(1 << 
úq
, 
IRQ_MCLR
);

41 
	}
}

43 
	$ebß110_unmask_úq
(
úq
)

45 
	`__øw_wrôeb
(1 << 
úq
, 
IRQ_MSET
);

46 
	}
}

48 
úq_chù
 
	gebß110_úq_chù
 = {

49 .
ack
 = 
ebß110_mask_úq
,

50 .
	gmask
 = 
ebß110_mask_úq
,

51 .
	gunmask
 = 
ebß110_unmask_úq
,

54 
__öô
 
	$ebß110_öô_úq
()

56 
Êags
;

57 
úq
;

59 
	`loˇl_úq_ßve
(
Êags
);

60 
	`__øw_wrôeb
(0xff, 
IRQ_MCLR
);

61 
	`__øw_wrôeb
(0x55, 
IRQ_MSET
);

62 
	`__øw_wrôeb
(0x00, 
IRQ_MSET
);

63 i‡(
	`__øw_ªadb
(
IRQ_MASK
) != 0x55)

65 
	`__øw_wrôeb
(0xff, 
IRQ_MCLR
);

66 
	`loˇl_úq_ª°‹e
(
Êags
);

68 
úq
 = 0; irq < 
NR_IRQS
; irq++) {

69 
	`£t_úq_chù
(
úq
, &
ebß110_úq_chù
);

70 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

71 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

73 
	}
}

75 
m≠_desc
 
	gebß110_io_desc
[] 
	g__öôd©a
 = {

80 .
vútuÆ
 = 
IRQ_STAT
,

81 .
	gp‚
 = 
__phys_to_p‚
(
TRICK4_PHYS
),

82 .
	gÀngth
 = 
PGDIR_SIZE
,

83 .
	gty≥
 = 
MT_DEVICE


85 .
	gvútuÆ
 = 
IRQ_MASK
,

86 .
	gp‚
 = 
__phys_to_p‚
(
TRICK3_PHYS
),

87 .
	gÀngth
 = 
PGDIR_SIZE
,

88 .
	gty≥
 = 
MT_DEVICE


90 .
	gvútuÆ
 = 
SOFT_BASE
,

91 .
	gp‚
 = 
__phys_to_p‚
(
TRICK1_PHYS
),

92 .
	gÀngth
 = 
PGDIR_SIZE
,

93 .
	gty≥
 = 
MT_DEVICE


95 .
	gvútuÆ
 = 
PIT_BASE
,

96 .
	gp‚
 = 
__phys_to_p‚
(
TRICK0_PHYS
),

97 .
	gÀngth
 = 
PGDIR_SIZE
,

98 .
	gty≥
 = 
MT_DEVICE


105 .
	gvútuÆ
 = 
ISAIO_BASE
,

106 .
	gp‚
 = 
__phys_to_p‚
(
ISAIO_PHYS
),

107 .
	gÀngth
 = 
ISAIO_SIZE
,

108 .
	gty≥
 = 
MT_DEVICE


110 .
	gvútuÆ
 = 
ISAMEM_BASE
,

111 .
	gp‚
 = 
__phys_to_p‚
(
ISAMEM_PHYS
),

112 .
	gÀngth
 = 
ISAMEM_SIZE
,

113 .
	gty≥
 = 
MT_DEVICE


117 
__öô
 
	$ebß110_m≠_io
()

119 
	`iŸabÀ_öô
(
ebß110_io_desc
, 
	`ARRAY_SIZE
(ebsa110_io_desc));

120 
	}
}

123 
	#PIT_CTRL
 (
PIT_BASE
 + 0x0d)

	)

124 
	#PIT_T2
 (
PIT_BASE
 + 0x09)

	)

125 
	#PIT_T1
 (
PIT_BASE
 + 0x05)

	)

126 
	#PIT_T0
 (
PIT_BASE
 + 0x01)

	)

133 
	#MCLK
 47894000

	)

138 
	#CLKBY7
 (
MCLK
 / 7)

	)

143 
	#COUNT
 ((
CLKBY7
 + (
HZ
 / 2)Ë/ HZ)

	)

150 
	$ebß110_gëtimeoff£t
()

152 
off£t
, 
cou¡
;

154 
	`__øw_wrôeb
(0x40, 
PIT_CTRL
);

155 
cou¡
 = 
	`__øw_ªadb
(
PIT_T1
);

156 
cou¡
 |
	`__øw_ªadb
(
PIT_T1
) << 8;

161 i‡(
cou¡
 > 
COUNT
)

162 
cou¡
 |= 0xffff0000;

164 
off£t
 = 
COUNT
;

165 
off£t
 -
cou¡
;

171 
off£t
 = off£à* (1000000 / 
HZ
Ë/ 
COUNT
;

173  
off£t
;

174 
	}
}

176 
úqªtu∫_t


177 
	$ebß110_timî_öãºu±
(
úq
, *
dev_id
)

179 
u32
 
cou¡
;

181 
	`wrôe_£qlock
(&
xtime_lock
);

184 
	`__øw_wrôeb
(0x40, 
PIT_CTRL
);

185 
cou¡
 = 
	`__øw_ªadb
(
PIT_T1
);

186 
cou¡
 |
	`__øw_ªadb
(
PIT_T1
) << 8;

188 
cou¡
 +
COUNT
;

190 
	`__øw_wrôeb
(
cou¡
 & 0xff, 
PIT_T1
);

191 
	`__øw_wrôeb
(
cou¡
 >> 8, 
PIT_T1
);

193 
	`timî_tick
();

195 
	`wrôe_£qu∆ock
(&
xtime_lock
);

197  
IRQ_HANDLED
;

198 
	}
}

200 
úqa˘i⁄
 
	gebß110_timî_úq
 = {

201 .
«me
 = "EBSA110 Timer Tick",

202 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

203 .
	gh™dÀr
 = 
ebß110_timî_öãºu±
,

209 
__öô
 
	$ebß110_timî_öô
()

214 
	`__øw_wrôeb
(0x70, 
PIT_CTRL
);

215 
	`__øw_wrôeb
(
COUNT
 & 0xff, 
PIT_T1
);

216 
	`__øw_wrôeb
(
COUNT
 >> 8, 
PIT_T1
);

218 
	`£tup_úq
(
IRQ_EBSA110_TIMER0
, &
ebß110_timî_úq
);

219 
	}
}

221 
sys_timî
 
	gebß110_timî
 = {

222 .
öô
 = 
ebß110_timî_öô
,

223 .
	goff£t
 = 
ebß110_gëtimeoff£t
,

226 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

228 .
ioba£
 = 0x3f8,

229 .
	gúq
 = 1,

230 .
	gu¨t˛k
 = 1843200,

231 .
	gªgshi·
 = 0,

232 .
	giŸy≥
 = 
UPIO_PORT
,

233 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

236 .
	gioba£
 = 0x2f8,

237 .
	gúq
 = 2,

238 .
	gu¨t˛k
 = 1843200,

239 .
	gªgshi·
 = 0,

240 .
	giŸy≥
 = 
UPIO_PORT
,

241 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

246 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

247 .
«me
 = "serial8250",

248 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

249 .
	gdev
 = {

250 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

254 
ªsour˚
 
	gam79c961_ªsour˚s
[] = {

256 .
°¨t
 = 0x220,

257 .
	gíd
 = 0x238,

258 .
	gÊags
 = 
IORESOURCE_IO
,

260 .
	g°¨t
 = 
IRQ_EBSA110_ETHERNET
,

261 .
	gíd
 = 
IRQ_EBSA110_ETHERNET
,

262 .
	gÊags
 = 
IORESOURCE_IRQ
,

266 
∂©f‹m_devi˚
 
	gam79c961_devi˚
 = {

267 .
«me
 = "am79c961",

268 .
	gid
 = -1,

269 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
am79c961_ªsour˚s
),

270 .
	gªsour˚
 = 
am79c961_ªsour˚s
,

273 
∂©f‹m_devi˚
 *
	gebß110_devi˚s
[] = {

274 &
£rül_devi˚
,

275 &
am79c961_devi˚
,

278 
__öô
 
	$ebß110_öô
()

280  
	`∂©f‹m_add_devi˚s
(
ebß110_devi˚s
, 
	`ARRAY_SIZE
(ebsa110_devices));

281 
	}
}

283 
¨ch_öôˇŒ
(
ebß110_öô
);

285 
MACHINE_START
(
EBSA110
, "EBSA110")

287 .
	gphys_io
 = 0xe0000000,

288 .
	gio_pg_off°
 = ((0xe0000000) >> 18) & 0xfffc,

289 .
	gboŸ_∑øms
 = 0x00000400,

290 .
	gª£rve_Õ0
 = 1,

291 .
	gª£rve_Õ2
 = 1,

292 .
	gso·_ªboŸ
 = 1,

293 .
	gm≠_io
 = 
ebß110_m≠_io
,

294 .
	göô_úq
 = 
ebß110_öô_úq
,

295 .
	gtimî
 = &
ebß110_timî
,

296 
	gMACHINE_END


	@arch/arm/mach-ebsa110/io.c

23 
	~<löux/moduÀ.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/ty≥s.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/io.h
>

29 
	~<asm/∑ge.h
>

31 
__iomem
 *
	$__ißmem_c⁄vît_addr
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

33 
u32
 
ªt
, 
a
 = (u32 
__f‹˚
Ë
addr
;

51 
ªt
 = (
a
 & 0xf803fe) << 1;

52 
ªt
 |(
a
 & 0x03fc00) << 2;

54 
ªt
 += 0xe8000000;

56 i‡((
a
 & 0x20000) == (a & 0x40000) >> 1)

57  (
__iomem
 *)
ªt
;

59 
	`BUG
();

60  
NULL
;

61 
	}
}

66 
u8
 
	$__ªadb
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

68 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

69 
u32
 
ªt
;

71 i‡(()
addr
 & 1)

72 
ªt
 = 
	`__øw_ªadl
(
a
);

74 
ªt
 = 
	`__øw_ªadb
(
a
);

75  
ªt
;

76 
	}
}

78 
u16
 
	$__ªadw
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

80 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

82 i‡(()
addr
 & 1)

83 
	`BUG
();

85  
	`__øw_ªadw
(
a
);

86 
	}
}

88 
u32
 
	$__ªadl
(c⁄° vﬁ©ûê
__iomem
 *
addr
)

90 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

91 
u32
 
ªt
;

93 i‡(()
addr
 & 3)

94 
	`BUG
();

96 
ªt
 = 
	`__øw_ªadw
(
a
);

97 
ªt
 |
	`__øw_ªadw
(
a
 + 4) << 16;

98  
ªt
;

99 
	}
}

101 
EXPORT_SYMBOL
(
__ªadb
);

102 
EXPORT_SYMBOL
(
__ªadw
);

103 
EXPORT_SYMBOL
(
__ªadl
);

105 
	$ªadsw
(c⁄° 
__iomem
 *
addr
, *
d©a
, 
Àn
)

107 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

109 
	`BUG_ON
(()
addr
 & 1);

111 
	`__øw_ªadsw
(
a
, 
d©a
, 
Àn
);

112 
	}
}

113 
EXPORT_SYMBOL
(
ªadsw
);

115 
	$ªad¶
(c⁄° 
__iomem
 *
addr
, *
d©a
, 
Àn
)

117 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

119 
	`BUG_ON
(()
addr
 & 3);

121 
	`__øw_ªad¶
(
a
, 
d©a
, 
Àn
);

122 
	}
}

123 
EXPORT_SYMBOL
(
ªad¶
);

125 
	$__wrôeb
(
u8
 
vÆ
, 
__iomem
 *
addr
)

127 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

129 i‡(()
addr
 & 1)

130 
	`__øw_wrôñ
(
vÆ
, 
a
);

132 
	`__øw_wrôeb
(
vÆ
, 
a
);

133 
	}
}

135 
	$__wrôew
(
u16
 
vÆ
, 
__iomem
 *
addr
)

137 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

139 i‡(()
addr
 & 1)

140 
	`BUG
();

142 
	`__øw_wrôew
(
vÆ
, 
a
);

143 
	}
}

145 
	$__wrôñ
(
u32
 
vÆ
, 
__iomem
 *
addr
)

147 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

149 i‡(()
addr
 & 3)

150 
	`BUG
();

152 
	`__øw_wrôew
(
vÆ
, 
a
);

153 
	`__øw_wrôew
(
vÆ
 >> 16, 
a
 + 4);

154 
	}
}

156 
EXPORT_SYMBOL
(
__wrôeb
);

157 
EXPORT_SYMBOL
(
__wrôew
);

158 
EXPORT_SYMBOL
(
__wrôñ
);

160 
	$wrôesw
(
__iomem
 *
addr
, c⁄° *
d©a
, 
Àn
)

162 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

164 
	`BUG_ON
(()
addr
 & 1);

166 
	`__øw_wrôesw
(
a
, 
d©a
, 
Àn
);

167 
	}
}

168 
EXPORT_SYMBOL
(
wrôesw
);

170 
	$wrôe¶
(
__iomem
 *
addr
, c⁄° *
d©a
, 
Àn
)

172 
__iomem
 *
a
 = 
	`__ißmem_c⁄vît_addr
(
addr
);

174 
	`BUG_ON
(()
addr
 & 3);

176 
	`__øw_wrôe¶
(
a
, 
d©a
, 
Àn
);

177 
	}
}

178 
EXPORT_SYMBOL
(
wrôe¶
);

180 
	#SUPERIO_PORT
(
p
) \

181 (((
p
) >> 3) == (0x3f8 >> 3) || \

182 ((
p
) >> 3) == (0x2f8 >> 3) || \

183 ((
p
Ë>> 3Ë=(0x378 >> 3))

	)

189 
u8
 
	$__öb8
(
p‹t
)

191 
u32
 
ªt
;

196 i‡(
	`SUPERIO_PORT
(
p‹t
))

197 
ªt
 = 
	`__øw_ªadb
((
__iomem
 *)
ISAIO_BASE
 + (
p‹t
 << 2));

199 
__iomem
 *
a
 = (__iomem *)
ISAIO_BASE
 + ((
p‹t
 & ~1) << 1);

204 i‡(
p‹t
 & 1)

205 
ªt
 = 
	`__øw_ªadl
(
a
);

207 
ªt
 = 
	`__øw_ªadb
(
a
);

209  
ªt
;

210 
	}
}

216 
u8
 
	$__öb16
(
p‹t
)

218 
off£t
;

223 i‡(
	`SUPERIO_PORT
(
p‹t
))

224 
off£t
 = 
p‹t
 << 2;

226 
off£t
 = (
p‹t
 & ~1) << 1 | (port & 1);

228  
	`__øw_ªadb
((
__iomem
 *)
ISAIO_BASE
 + 
off£t
);

229 
	}
}

231 
u16
 
	$__öw
(
p‹t
)

233 
off£t
;

238 i‡(
	`SUPERIO_PORT
(
p‹t
))

239 
off£t
 = 
p‹t
 << 2;

241 
off£t
 = 
p‹t
 << 1;

242 
	`BUG_ON
(
p‹t
 & 1);

244  
	`__øw_ªadw
((
__iomem
 *)
ISAIO_BASE
 + 
off£t
);

245 
	}
}

250 
u32
 
	$__öl
(
p‹t
)

252 
__iomem
 *
a
;

254 i‡(
	`SUPERIO_PORT
(
p‹t
) ||Öort & 3)

255 
	`BUG
();

257 
a
 = (
__iomem
 *)
ISAIO_BASE
 + ((
p‹t
 & ~1) << 1);

259  
	`__øw_ªadw
(
a
) | __raw_readw(a + 4) << 16;

260 
	}
}

262 
EXPORT_SYMBOL
(
__öb8
);

263 
EXPORT_SYMBOL
(
__öb16
);

264 
EXPORT_SYMBOL
(
__öw
);

265 
EXPORT_SYMBOL
(
__öl
);

267 
	$__outb8
(
u8
 
vÆ
, 
p‹t
)

272 i‡(
	`SUPERIO_PORT
(
p‹t
))

273 
	`__øw_wrôeb
(
vÆ
, (
__iomem
 *)
ISAIO_BASE
 + (
p‹t
 << 2));

275 
__iomem
 *
a
 = (__iomem *)
ISAIO_BASE
 + ((
p‹t
 & ~1) << 1);

280 i‡(
p‹t
 & 1)

281 
	`__øw_wrôñ
(
vÆ
, 
a
);

283 
	`__øw_wrôeb
(
vÆ
, 
a
);

285 
	}
}

287 
	$__outb16
(
u8
 
vÆ
, 
p‹t
)

289 
off£t
;

294 i‡(
	`SUPERIO_PORT
(
p‹t
))

295 
off£t
 = 
p‹t
 << 2;

297 
off£t
 = (
p‹t
 & ~1) << 1 | (port & 1);

299 
	`__øw_wrôeb
(
vÆ
, (
__iomem
 *)
ISAIO_BASE
 + 
off£t
);

300 
	}
}

302 
	$__outw
(
u16
 
vÆ
, 
p‹t
)

304 
off£t
;

309 i‡(
	`SUPERIO_PORT
(
p‹t
))

310 
off£t
 = 
p‹t
 << 2;

312 
off£t
 = 
p‹t
 << 1;

313 
	`BUG_ON
(
p‹t
 & 1);

315 
	`__øw_wrôew
(
vÆ
, (
__iomem
 *)
ISAIO_BASE
 + 
off£t
);

316 
	}
}

318 
	$__oué
(
u32
 
vÆ
, 
p‹t
)

320 
	`BUG
();

321 
	}
}

323 
EXPORT_SYMBOL
(
__outb8
);

324 
EXPORT_SYMBOL
(
__outb16
);

325 
EXPORT_SYMBOL
(
__outw
);

326 
EXPORT_SYMBOL
(
__oué
);

328 
	$outsb
(
p‹t
, c⁄° *
‰om
, 
Àn
)

330 
u32
 
off
;

332 i‡(
	`SUPERIO_PORT
(
p‹t
))

333 
off
 = 
p‹t
 << 2;

335 
off
 = (
p‹t
 & ~1) << 1;

336 i‡(
p‹t
 & 1)

337 
	`BUG
();

340 
	`__øw_wrôesb
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
);

341 
	}
}

343 
	$ösb
(
p‹t
, *
‰om
, 
Àn
)

345 
u32
 
off
;

347 i‡(
	`SUPERIO_PORT
(
p‹t
))

348 
off
 = 
p‹t
 << 2;

350 
off
 = (
p‹t
 & ~1) << 1;

351 i‡(
p‹t
 & 1)

352 
	`BUG
();

355 
	`__øw_ªadsb
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
);

356 
	}
}

358 
EXPORT_SYMBOL
(
outsb
);

359 
EXPORT_SYMBOL
(
ösb
);

361 
	$outsw
(
p‹t
, c⁄° *
‰om
, 
Àn
)

363 
u32
 
off
;

365 i‡(
	`SUPERIO_PORT
(
p‹t
))

366 
off
 = 
p‹t
 << 2;

368 
off
 = (
p‹t
 & ~1) << 1;

369 i‡(
p‹t
 & 1)

370 
	`BUG
();

373 
	`__øw_wrôesw
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
);

374 
	}
}

376 
	$ösw
(
p‹t
, *
‰om
, 
Àn
)

378 
u32
 
off
;

380 i‡(
	`SUPERIO_PORT
(
p‹t
))

381 
off
 = 
p‹t
 << 2;

383 
off
 = (
p‹t
 & ~1) << 1;

384 i‡(
p‹t
 & 1)

385 
	`BUG
();

388 
	`__øw_ªadsw
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
);

389 
	}
}

391 
EXPORT_SYMBOL
(
outsw
);

392 
EXPORT_SYMBOL
(
ösw
);

398 
	$out¶
(
p‹t
, c⁄° *
‰om
, 
Àn
)

400 
u32
 
off
 = 
p‹t
 << 1;

402 i‡(
	`SUPERIO_PORT
(
p‹t
) ||Öort & 3)

403 
	`BUG
();

405 
	`__øw_wrôesw
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
 << 1);

406 
	}
}

408 
	$ö¶
(
p‹t
, *
‰om
, 
Àn
)

410 
u32
 
off
 = 
p‹t
 << 1;

412 i‡(
	`SUPERIO_PORT
(
p‹t
) ||Öort & 3)

413 
	`BUG
();

415 
	`__øw_ªadsw
((
__iomem
 *)
ISAIO_BASE
 + 
off
, 
‰om
, 
Àn
 << 1);

416 
	}
}

418 
EXPORT_SYMBOL
(
out¶
);

419 
EXPORT_SYMBOL
(
ö¶
);

	@arch/arm/mach-ebsa110/leds.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/•ölock.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/h¨dw¨e.h
>

19 
	~<asm/Àds.h
>

20 
	~<asm/sy°em.h
>

21 
	~<asm/mach-ty≥s.h
>

23 
•ölock_t
 
	gÀds_lock
;

25 
	$ebß110_Àds_evít
(
Àd_evít_t
 
Àdevt
)

27 
Êags
;

29 
	`•ö_lock_úqßve
(&
Àds_lock
, 
Êags
);

31 
Àdevt
) {

32 
Àd_timî
:

33 *(vﬁ©ûê*)
SOFT_BASE
 ^= 128;

40 
	`•ö_u∆ock_úqª°‹e
(&
Àds_lock
, 
Êags
);

41 
	}
}

43 
__öô
 
	$Àds_öô
()

45 i‡(
	`machöe_is_ebß110
())

46 
Àds_evít
 = 
ebß110_Àds_evít
;

49 
	}
}

51 
__öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-ep93xx/adssphere.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	gads•hîe_Êash_d©a
 = {

27 .
width
 = 4,

30 
ªsour˚
 
	gads•hîe_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x61ffffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gads•hîe_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
ads•hîe_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
ads•hîe_Êash_ªsour˚
,

46 
ï93xx_ëh_d©a
 
	gads•hîe_ëh_d©a
 = {

47 .
phy_id
 = 1,

50 
ªsour˚
 
	gads•hîe_ëh_ªsour˚
[] = {

52 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

53 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

56 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

57 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

58 .
	gÊags
 = 
IORESOURCE_IRQ
,

62 
∂©f‹m_devi˚
 
	gads•hîe_ëh_devi˚
 = {

63 .
«me
 = "ep93xx-eth",

64 .
	gid
 = -1,

65 .
	gdev
 = {

66 .
∂©f‹m_d©a
 = &
ads•hîe_ëh_d©a
,

68 .
	gnum_ªsour˚s
 = 2,

69 .
	gªsour˚
 = 
ads•hîe_ëh_ªsour˚
,

72 
__öô
 
	$ads•hîe_öô_machöe
()

74 
	`ï93xx_öô_devi˚s
();

75 
	`∂©f‹m_devi˚_ªgi°î
(&
ads•hîe_Êash
);

77 
	`mem˝y
(
ads•hîe_ëh_d©a
.
dev_addr
,

78 (*)(
EP93XX_ETHERNET_BASE
 + 0x50), 6);

79 
	`∂©f‹m_devi˚_ªgi°î
(&
ads•hîe_ëh_devi˚
);

80 
	}
}

82 
MACHINE_START
(
ADSSPHERE
, "ADS Sphere board")

84 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

85 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

86 .
	gboŸ_∑øms
 = 0x00000100,

87 .
	gm≠_io
 = 
ï93xx_m≠_io
,

88 .
	göô_úq
 = 
ï93xx_öô_úq
,

89 .
	gtimî
 = &
ï93xx_timî
,

90 .
	göô_machöe
 = 
ads•hîe_öô_machöe
,

91 
	gMACHINE_END


	@arch/arm/mach-ep93xx/clock.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/˛k.h
>

15 
	~<löux/îr.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/°rög.h
>

18 
	~<asm/div64.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/io.h
>

22 
	s˛k
 {

23 *
	m«me
;

24 
	møã
;

25 
	mu£rs
;

26 
u32
 
	míabÀ_ªg
;

27 
u32
 
	míabÀ_mask
;

30 
˛k
 
	g˛k_u¨t
 = {

31 .
«me
 = "UARTCLK",

32 .
	gøã
 = 14745600,

34 
˛k
 
	g˛k_∂l1
 = {

35 .
«me
 = "pll1",

37 
˛k
 
	g˛k_f
 = {

38 .
«me
 = "fclk",

40 
˛k
 
	g˛k_h
 = {

41 .
«me
 = "hclk",

43 
˛k
 
	g˛k_p
 = {

44 .
«me
 = "pclk",

46 
˛k
 
	g˛k_∂l2
 = {

47 .
«me
 = "pll2",

49 
˛k
 
	g˛k_usb_ho°
 = {

50 .
«me
 = "usb_host",

51 .
	gíabÀ_ªg
 = 
EP93XX_SYSCON_CLOCK_CONTROL
,

52 .
	gíabÀ_mask
 = 
EP93XX_SYSCON_CLOCK_USH_EN
,

56 
˛k
 *
	g˛ocks
[] = {

57 &
˛k_u¨t
,

58 &
˛k_∂l1
,

59 &
˛k_f
,

60 &
˛k_h
,

61 &
˛k_p
,

62 &
˛k_∂l2
,

63 &
˛k_usb_ho°
,

66 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

68 
i
;

70 
i
 = 0; i < 
	`ARRAY_SIZE
(
˛ocks
); i++) {

71 i‡(!
	`°rcmp
(
˛ocks
[
i
]->
«me
, 
id
))

72  
˛ocks
[
i
];

75  
	`ERR_PTR
(-
ENOENT
);

76 
	}
}

78 
	$˛k_íabÀ
(
˛k
 *clk)

80 i‡(!
˛k
->
u£rs
++ && clk->
íabÀ_ªg
) {

81 
u32
 
vÆue
;

83 
vÆue
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

84 
	`__øw_wrôñ
(
vÆue
 | 
˛k
->
íabÀ_mask
, clk->
íabÀ_ªg
);

88 
	}
}

90 
	$˛k_dißbÀ
(
˛k
 *clk)

92 i‡(!--
˛k
->
u£rs
 && clk->
íabÀ_ªg
) {

93 
u32
 
vÆue
;

95 
vÆue
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

96 
	`__øw_wrôñ
(
vÆue
 & ~
˛k
->
íabÀ_mask
, clk->
íabÀ_ªg
);

98 
	}
}

100 
	$˛k_gë_øã
(
˛k
 *clk)

102  
˛k
->
øã
;

103 
	}
}

105 
	$˛k_put
(
˛k
 *clk)

107 
	}
}

111 
	gf˛k_divis‹s
[] = { 1, 2, 4, 8, 16, 1, 1, 1 };

112 
	gh˛k_divis‹s
[] = { 1, 2, 4, 5, 6, 8, 16, 32 };

113 
	gp˛k_divis‹s
[] = { 1, 2, 4, 8 };

118 
	$ˇlc_∂l_øã
(
u32
 
c⁄fig_w‹d
)

120 
øã
;

121 
i
;

123 
øã
 = 14745600;

124 
øã
 *((
c⁄fig_w‹d
 >> 11) & 0x1f) + 1;

125 
øã
 *((
c⁄fig_w‹d
 >> 5) & 0x3f) + 1;

126 
	`do_div
(
øã
, (
c⁄fig_w‹d
 & 0x1f) + 1);

127 
i
 = 0; i < ((
c⁄fig_w‹d
 >> 16) & 3); i++)

128 
øã
 >>= 1;

130  ()
øã
;

131 
	}
}

133 
__öô
 
	$ï93xx_˛ock_öô
()

135 
u32
 
vÆue
;

137 
vÆue
 = 
	`__øw_ªadl
(
EP93XX_SYSCON_CLOCK_SET1
);

138 i‡(!(
vÆue
 & 0x00800000)) {

139 
˛k_∂l1
.
øã
 = 14745600;

141 
˛k_∂l1
.
øã
 = 
	`ˇlc_∂l_øã
(
vÆue
);

143 
˛k_f
.
øã
 = 
˛k_∂l1
.øã / 
f˛k_divis‹s
[(
vÆue
 >> 25) & 0x7];

144 
˛k_h
.
øã
 = 
˛k_∂l1
.øã / 
h˛k_divis‹s
[(
vÆue
 >> 20) & 0x7];

145 
˛k_p
.
øã
 = 
˛k_h
.øã / 
p˛k_divis‹s
[(
vÆue
 >> 18) & 0x3];

147 
vÆue
 = 
	`__øw_ªadl
(
EP93XX_SYSCON_CLOCK_SET2
);

148 i‡(!(
vÆue
 & 0x00080000)) {

149 
˛k_∂l2
.
øã
 = 14745600;

150 } i‡(
vÆue
 & 0x00040000) {

151 
˛k_∂l2
.
øã
 = 
	`ˇlc_∂l_øã
(
vÆue
);

153 
˛k_∂l2
.
øã
 = 0;

155 
˛k_usb_ho°
.
øã
 = 
˛k_∂l2
.øã / (((
vÆue
 >> 28) & 0xf) + 1);

157 
	`¥ötk
(
KERN_INFO
 "ep93xx: PLL1Ñunningát %ld MHz, PLL2át %ld MHz\n",

158 
˛k_∂l1
.
øã
 / 1000000, 
˛k_∂l2
.rate / 1000000);

159 
	`¥ötk
(
KERN_INFO
 "ep93xx: FCLK %ld MHz, HCLK %ld MHz, PCLK %ld MHz\n",

160 
˛k_f
.
øã
 / 1000000, 
˛k_h
.rate / 1000000,

161 
˛k_p
.
øã
 / 1000000);

164 
	}
}

165 
¨ch_öôˇŒ
(
ï93xx_˛ock_öô
);

	@arch/arm/mach-ep93xx/core.c

16 
	~<löux/kî√l.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/•ölock.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/£rül.h
>

22 
	~<löux/ây.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/£rül.h
>

25 
	~<löux/£rül_8250.h
>

26 
	~<löux/£rül_c‹e.h
>

27 
	~<löux/devi˚.h
>

28 
	~<löux/mm.h
>

29 
	~<löux/time.h
>

30 
	~<löux/timex.h
>

31 
	~<löux/dñay.h
>

32 
	~<löux/ãrmios.h
>

33 
	~<löux/amba/bus.h
>

34 
	~<löux/amba/£rül.h
>

36 
	~<asm/ty≥s.h
>

37 
	~<asm/£tup.h
>

38 
	~<asm/mem‹y.h
>

39 
	~<asm/h¨dw¨e.h
>

40 
	~<asm/úq.h
>

41 
	~<asm/sy°em.h
>

42 
	~<asm/ébÊush.h
>

43 
	~<asm/pgèbÀ.h
>

44 
	~<asm/io.h
>

46 
	~<asm/mach/m≠.h
>

47 
	~<asm/mach/time.h
>

48 
	~<asm/mach/úq.h
>

49 
	~<asm/¨ch/gpio.h
>

51 
	~<asm/h¨dw¨e/vic.h
>

57 
m≠_desc
 
	gï93xx_io_desc
[] 
	g__öôd©a
 = {

59 .
vútuÆ
 = 
EP93XX_AHB_VIRT_BASE
,

60 .
	gp‚
 = 
__phys_to_p‚
(
EP93XX_AHB_PHYS_BASE
),

61 .
	gÀngth
 = 
EP93XX_AHB_SIZE
,

62 .
	gty≥
 = 
MT_DEVICE
,

64 .
	gvútuÆ
 = 
EP93XX_APB_VIRT_BASE
,

65 .
	gp‚
 = 
__phys_to_p‚
(
EP93XX_APB_PHYS_BASE
),

66 .
	gÀngth
 = 
EP93XX_APB_SIZE
,

67 .
	gty≥
 = 
MT_DEVICE
,

71 
__öô
 
	$ï93xx_m≠_io
()

73 
	`iŸabÀ_öô
(
ï93xx_io_desc
, 
	`ARRAY_SIZE
(ep93xx_io_desc));

74 
	}
}

96 
	gœ°_jiffy_time
;

98 
	#TIMER4_TICKS_PER_JIFFY
 ((
CLOCK_TICK_RATE
 + (
HZ
/2)Ë/ HZ)

	)

100 
	$ï93xx_timî_öãºu±
(
úq
, *
dev_id
)

102 
	`wrôe_£qlock
(&
xtime_lock
);

104 
	`__øw_wrôñ
(1, 
EP93XX_TIMER1_CLEAR
);

106 (
	`__øw_ªadl
(
EP93XX_TIMER4_VALUE_LOW
Ë- 
œ°_jiffy_time
)

107 >
TIMER4_TICKS_PER_JIFFY
) {

108 
œ°_jiffy_time
 +
TIMER4_TICKS_PER_JIFFY
;

109 
	`timî_tick
();

112 
	`wrôe_£qu∆ock
(&
xtime_lock
);

114  
IRQ_HANDLED
;

115 
	}
}

117 
úqa˘i⁄
 
	gï93xx_timî_úq
 = {

118 .
«me
 = "ep93xxÅimer",

119 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

120 .
	gh™dÀr
 = 
ï93xx_timî_öãºu±
,

123 
__öô
 
	$ï93xx_timî_öô
()

126 
	`__øw_wrôñ
(0x48, 
EP93XX_TIMER1_CONTROL
);

127 
	`__øw_wrôñ
((508469 / 
HZ
Ë- 1, 
EP93XX_TIMER1_LOAD
);

128 
	`__øw_wrôñ
(0xc8, 
EP93XX_TIMER1_CONTROL
);

131 
	`__øw_wrôñ
(0x100, 
EP93XX_TIMER4_VALUE_HIGH
);

133 
	`£tup_úq
(
IRQ_EP93XX_TIMER1
, &
ï93xx_timî_úq
);

134 
	}
}

136 
	$ï93xx_gëtimeoff£t
()

138 
off£t
;

140 
off£t
 = 
	`__øw_ªadl
(
EP93XX_TIMER4_VALUE_LOW
Ë- 
œ°_jiffy_time
;

143  
off£t
 + (53 * offset / 3072);

144 
	}
}

146 
sys_timî
 
	gï93xx_timî
 = {

147 .
öô
 = 
ï93xx_timî_öô
,

148 .
	goff£t
 = 
ï93xx_gëtimeoff£t
,

155 
	ggpio_öt_unmasked
[3];

156 
	ggpio_öt_íabÀd
[3];

157 
	ggpio_öt_ty≥1
[3];

158 
	ggpio_öt_ty≥2
[3];

160 
	$upd©e_gpio_öt_∑øms
(
abf
)

162 i‡(
abf
 == 0) {

163 
	`__øw_wrôeb
(0, 
EP93XX_GPIO_A_INT_ENABLE
);

164 
	`__øw_wrôeb
(
gpio_öt_ty≥2
[0], 
EP93XX_GPIO_A_INT_TYPE2
);

165 
	`__øw_wrôeb
(
gpio_öt_ty≥1
[0], 
EP93XX_GPIO_A_INT_TYPE1
);

166 
	`__øw_wrôeb
(
gpio_öt_unmasked
[0] & 
gpio_öt_íabÀd
[0], 
EP93XX_GPIO_A_INT_ENABLE
);

167 } i‡(
abf
 == 1) {

168 
	`__øw_wrôeb
(0, 
EP93XX_GPIO_B_INT_ENABLE
);

169 
	`__øw_wrôeb
(
gpio_öt_ty≥2
[1], 
EP93XX_GPIO_B_INT_TYPE2
);

170 
	`__øw_wrôeb
(
gpio_öt_ty≥1
[1], 
EP93XX_GPIO_B_INT_TYPE1
);

171 
	`__øw_wrôeb
(
gpio_öt_unmasked
[1] & 
gpio_öt_íabÀd
[1], 
EP93XX_GPIO_B_INT_ENABLE
);

172 } i‡(
abf
 == 2) {

173 
	`__øw_wrôeb
(0, 
EP93XX_GPIO_F_INT_ENABLE
);

174 
	`__øw_wrôeb
(
gpio_öt_ty≥2
[2], 
EP93XX_GPIO_F_INT_TYPE2
);

175 
	`__øw_wrôeb
(
gpio_öt_ty≥1
[2], 
EP93XX_GPIO_F_INT_TYPE1
);

176 
	`__øw_wrôeb
(
gpio_öt_unmasked
[2] & 
gpio_öt_íabÀd
[2], 
EP93XX_GPIO_F_INT_ENABLE
);

178 
	`BUG
();

180 
	}
}

183 
	gd©a_ªgi°î_off£t
[8] = {

187 
	gd©a_dúe˘i⁄_ªgi°î_off£t
[8] = {

191 
	$gpio_löe_c⁄fig
(
löe
, 
dúe˘i⁄
)

193 
d©a_dúe˘i⁄_ªgi°î
;

194 
Êags
;

195 
v
;

197 
d©a_dúe˘i⁄_ªgi°î
 =

198 
	`EP93XX_GPIO_REG
(
d©a_dúe˘i⁄_ªgi°î_off£t
[
löe
 >> 3]);

200 
	`loˇl_úq_ßve
(
Êags
);

201 i‡(
dúe˘i⁄
 =
GPIO_OUT
) {

202 i‡(
löe
 >= 0 &&Üine < 16) {

204 
gpio_öt_unmasked
[
löe
 >> 3] &= ~(1 << (line & 7));

205 
	`upd©e_gpio_öt_∑øms
(
löe
 >> 3);

206 } i‡(
löe
 >= 40 &&Üine < 48) {

208 
gpio_öt_unmasked
[2] &~(1 << (
löe
 & 7));

209 
	`upd©e_gpio_öt_∑øms
(2);

212 
v
 = 
	`__øw_ªadb
(
d©a_dúe˘i⁄_ªgi°î
);

213 
v
 |1 << (
löe
 & 7);

214 
	`__øw_wrôeb
(
v
, 
d©a_dúe˘i⁄_ªgi°î
);

215 } i‡(
dúe˘i⁄
 =
GPIO_IN
) {

216 
v
 = 
	`__øw_ªadb
(
d©a_dúe˘i⁄_ªgi°î
);

217 
v
 &~(1 << (
löe
 & 7));

218 
	`__øw_wrôeb
(
v
, 
d©a_dúe˘i⁄_ªgi°î
);

220 
	`loˇl_úq_ª°‹e
(
Êags
);

221 
	}
}

222 
EXPORT_SYMBOL
(
gpio_löe_c⁄fig
);

224 
	$gpio_löe_gë
(
löe
)

226 
d©a_ªgi°î
;

228 
d©a_ªgi°î
 = 
	`EP93XX_GPIO_REG
(
d©a_ªgi°î_off£t
[
löe
 >> 3]);

230  !!(
	`__øw_ªadb
(
d©a_ªgi°î
Ë& (1 << (
löe
 & 7)));

231 
	}
}

232 
EXPORT_SYMBOL
(
gpio_löe_gë
);

234 
	$gpio_löe_£t
(
löe
, 
vÆue
)

236 
d©a_ªgi°î
;

237 
Êags
;

238 
v
;

240 
d©a_ªgi°î
 = 
	`EP93XX_GPIO_REG
(
d©a_ªgi°î_off£t
[
löe
 >> 3]);

242 
	`loˇl_úq_ßve
(
Êags
);

243 i‡(
vÆue
 =
EP93XX_GPIO_HIGH
) {

244 
v
 = 
	`__øw_ªadb
(
d©a_ªgi°î
);

245 
v
 |1 << (
löe
 & 7);

246 
	`__øw_wrôeb
(
v
, 
d©a_ªgi°î
);

247 } i‡(
vÆue
 =
EP93XX_GPIO_LOW
) {

248 
v
 = 
	`__øw_ªadb
(
d©a_ªgi°î
);

249 
v
 &~(1 << (
löe
 & 7));

250 
	`__øw_wrôeb
(
v
, 
d©a_ªgi°î
);

252 
	`loˇl_úq_ª°‹e
(
Êags
);

253 
	}
}

254 
EXPORT_SYMBOL
(
gpio_löe_£t
);

260 
	$ï93xx_gpio_ab_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

262 
°©us
;

263 
i
;

265 
°©us
 = 
	`__øw_ªadb
(
EP93XX_GPIO_A_INT_STATUS
);

266 
i
 = 0; i < 8; i++) {

267 i‡(
°©us
 & (1 << 
i
)) {

268 
desc
 = 
úq_desc
 + 
	`IRQ_EP93XX_GPIO
(0Ë+ 
i
;

269 
	`desc_h™dÀ_úq
(
	`IRQ_EP93XX_GPIO
(0Ë+ 
i
, 
desc
);

273 
°©us
 = 
	`__øw_ªadb
(
EP93XX_GPIO_B_INT_STATUS
);

274 
i
 = 0; i < 8; i++) {

275 i‡(
°©us
 & (1 << 
i
)) {

276 
desc
 = 
úq_desc
 + 
	`IRQ_EP93XX_GPIO
(8Ë+ 
i
;

277 
	`desc_h™dÀ_úq
(
	`IRQ_EP93XX_GPIO
(8Ë+ 
i
, 
desc
);

280 
	}
}

282 
	$ï93xx_gpio_f_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

284 
gpio_úq
 = 
	`IRQ_EP93XX_GPIO
(16Ë+ (((
úq
 + 1) & 7) ^ 4);

286 
	`desc_h™dÀ_úq
(
gpio_úq
, 
úq_desc
 + gpio_irq);

287 
	}
}

289 
	$ï93xx_gpio_úq_mask_ack
(
úq
)

291 
löe
 = 
úq
 - 
	`IRQ_EP93XX_GPIO
(0);

292 
p‹t
 = 
löe
 >> 3;

294 
gpio_öt_unmasked
[
p‹t
] &~(1 << (
löe
 & 7));

295 
	`upd©e_gpio_öt_∑øms
(
p‹t
);

297 i‡(
p‹t
 == 0) {

298 
	`__øw_wrôñ
(1 << (
löe
 & 7), 
EP93XX_GPIO_A_INT_ACK
);

299 } i‡(
p‹t
 == 1) {

300 
	`__øw_wrôñ
(1 << (
löe
 & 7), 
EP93XX_GPIO_B_INT_ACK
);

301 } i‡(
p‹t
 == 2) {

302 
	`__øw_wrôñ
(1 << (
löe
 & 7), 
EP93XX_GPIO_F_INT_ACK
);

304 
	}
}

306 
	$ï93xx_gpio_úq_mask
(
úq
)

308 
löe
 = 
úq
 - 
	`IRQ_EP93XX_GPIO
(0);

309 
p‹t
 = 
löe
 >> 3;

311 
gpio_öt_unmasked
[
p‹t
] &~(1 << (
löe
 & 7));

312 
	`upd©e_gpio_öt_∑øms
(
p‹t
);

313 
	}
}

315 
	$ï93xx_gpio_úq_unmask
(
úq
)

317 
löe
 = 
úq
 - 
	`IRQ_EP93XX_GPIO
(0);

318 
p‹t
 = 
löe
 >> 3;

320 
gpio_öt_unmasked
[
p‹t
] |1 << (
löe
 & 7);

321 
	`upd©e_gpio_öt_∑øms
(
p‹t
);

322 
	}
}

330 
	$ï93xx_gpio_úq_ty≥
(
úq
, 
ty≥
)

332 
p‹t
;

333 
löe
;

335 
löe
 = 
úq
 - 
	`IRQ_EP93XX_GPIO
(0);

336 i‡(
löe
 >= 0 &&Üine < 16) {

337 
	`gpio_löe_c⁄fig
(
löe
, 
GPIO_IN
);

339 
	`gpio_löe_c⁄fig
(
	`EP93XX_GPIO_LINE_F
(
löe
), 
GPIO_IN
);

342 
p‹t
 = 
löe
 >> 3;

343 
löe
 &= 7;

345 i‡(
ty≥
 & 
IRQT_RISING
) {

346 
gpio_öt_íabÀd
[
p‹t
] |1 << 
löe
;

347 
gpio_öt_ty≥1
[
p‹t
] |1 << 
löe
;

348 
gpio_öt_ty≥2
[
p‹t
] |1 << 
löe
;

349 } i‡(
ty≥
 & 
IRQT_FALLING
) {

350 
gpio_öt_íabÀd
[
p‹t
] |1 << 
löe
;

351 
gpio_öt_ty≥1
[
p‹t
] |1 << 
löe
;

352 
gpio_öt_ty≥2
[
p‹t
] &~(1 << 
löe
);

353 } i‡(
ty≥
 & 
IRQT_HIGH
) {

354 
gpio_öt_íabÀd
[
p‹t
] |1 << 
löe
;

355 
gpio_öt_ty≥1
[
p‹t
] &~(1 << 
löe
);

356 
gpio_öt_ty≥2
[
p‹t
] |1 << 
löe
;

357 } i‡(
ty≥
 & 
IRQT_LOW
) {

358 
gpio_öt_íabÀd
[
p‹t
] |1 << 
löe
;

359 
gpio_öt_ty≥1
[
p‹t
] &~(1 << 
löe
);

360 
gpio_öt_ty≥2
[
p‹t
] &~(1 << 
löe
);

362 
gpio_öt_íabÀd
[
p‹t
] &~(1 << 
löe
);

364 
	`upd©e_gpio_öt_∑øms
(
p‹t
);

367 
	}
}

369 
úq_chù
 
	gï93xx_gpio_úq_chù
 = {

370 .
«me
 = "GPIO",

371 .
	gack
 = 
ï93xx_gpio_úq_mask_ack
,

372 .
	gmask
 = 
ï93xx_gpio_úq_mask
,

373 .
	gunmask
 = 
ï93xx_gpio_úq_unmask
,

374 .
	g£t_ty≥
 = 
ï93xx_gpio_úq_ty≥
,

378 
__öô
 
	$ï93xx_öô_úq
()

380 
úq
;

382 
	`vic_öô
((*)
EP93XX_VIC1_BASE
, 0, 
EP93XX_VIC1_VALID_IRQ_MASK
);

383 
	`vic_öô
((*)
EP93XX_VIC2_BASE
, 32, 
EP93XX_VIC2_VALID_IRQ_MASK
);

385 
úq
 = 
	`IRQ_EP93XX_GPIO
(0); irq <= IRQ_EP93XX_GPIO(23); irq++) {

386 
	`£t_úq_chù
(
úq
, &
ï93xx_gpio_úq_chù
);

387 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

388 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

391 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO_AB
, 
ï93xx_gpio_ab_úq_h™dÀr
);

392 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO0MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

393 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO1MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

394 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO2MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

395 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO3MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

396 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO4MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

397 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO5MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

398 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO6MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

399 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EP93XX_GPIO7MUX
, 
ï93xx_gpio_f_úq_h™dÀr
);

400 
	}
}

406 
	#EP93XX_UART_MCR_OFFSET
 (0x0100)

	)

408 
	$ï93xx_u¨t_£t_m˘æ
(
amba_devi˚
 *
dev
,

409 
__iomem
 *
ba£
, 
m˘æ
)

411 
m¸
;

413 
m¸
 = 0;

414 i‡(!(
m˘æ
 & 
TIOCM_RTS
))

415 
m¸
 |= 2;

416 i‡(!(
m˘æ
 & 
TIOCM_DTR
))

417 
m¸
 |= 1;

419 
	`__øw_wrôñ
(
m¸
, 
ba£
 + 
EP93XX_UART_MCR_OFFSET
);

420 
	}
}

422 
amba_∂010_d©a
 
	gï93xx_u¨t_d©a
 = {

423 .
£t_m˘æ
 = 
ï93xx_u¨t_£t_m˘æ
,

426 
amba_devi˚
 
	gu¨t1_devi˚
 = {

427 .
dev
 = {

428 .
bus_id
 = "apb:uart1",

429 .
	g∂©f‹m_d©a
 = &
ï93xx_u¨t_d©a
,

431 .
	gªs
 = {

432 .
°¨t
 = 
EP93XX_UART1_PHYS_BASE
,

433 .
	gíd
 = 
EP93XX_UART1_PHYS_BASE
 + 0x0fff,

434 .
	gÊags
 = 
IORESOURCE_MEM
,

436 .
	gúq
 = { 
IRQ_EP93XX_UART1
, 
NO_IRQ
 },

437 .
	g≥rùhid
 = 0x00041010,

440 
amba_devi˚
 
	gu¨t2_devi˚
 = {

441 .
dev
 = {

442 .
bus_id
 = "apb:uart2",

443 .
	g∂©f‹m_d©a
 = &
ï93xx_u¨t_d©a
,

445 .
	gªs
 = {

446 .
°¨t
 = 
EP93XX_UART2_PHYS_BASE
,

447 .
	gíd
 = 
EP93XX_UART2_PHYS_BASE
 + 0x0fff,

448 .
	gÊags
 = 
IORESOURCE_MEM
,

450 .
	gúq
 = { 
IRQ_EP93XX_UART2
, 
NO_IRQ
 },

451 .
	g≥rùhid
 = 0x00041010,

454 
amba_devi˚
 
	gu¨t3_devi˚
 = {

455 .
dev
 = {

456 .
bus_id
 = "apb:uart3",

457 .
	g∂©f‹m_d©a
 = &
ï93xx_u¨t_d©a
,

459 .
	gªs
 = {

460 .
°¨t
 = 
EP93XX_UART3_PHYS_BASE
,

461 .
	gíd
 = 
EP93XX_UART3_PHYS_BASE
 + 0x0fff,

462 .
	gÊags
 = 
IORESOURCE_MEM
,

464 .
	gúq
 = { 
IRQ_EP93XX_UART3
, 
NO_IRQ
 },

465 .
	g≥rùhid
 = 0x00041010,

469 
∂©f‹m_devi˚
 
	gï93xx_πc_devi˚
 = {

470 .
«me
 = "ep93xx-rtc",

471 .
	gid
 = -1,

472 .
	gnum_ªsour˚s
 = 0,

476 
ªsour˚
 
	gï93xx_ohci_ªsour˚s
[] = {

478 .
°¨t
 = 
EP93XX_USB_PHYS_BASE
,

479 .
	gíd
 = 
EP93XX_USB_PHYS_BASE
 + 0x0fff,

480 .
	gÊags
 = 
IORESOURCE_MEM
,

483 .
°¨t
 = 
IRQ_EP93XX_USB
,

484 .
	gíd
 = 
IRQ_EP93XX_USB
,

485 .
	gÊags
 = 
IORESOURCE_IRQ
,

489 
∂©f‹m_devi˚
 
	gï93xx_ohci_devi˚
 = {

490 .
«me
 = "ep93xx-ohci",

491 .
	gid
 = -1,

492 .
	gdev
 = {

493 .
dma_mask
 = (*)0xffffffff,

494 .
	gcohîít_dma_mask
 = 0xffffffff,

496 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ï93xx_ohci_ªsour˚s
),

497 .
	gªsour˚
 = 
ï93xx_ohci_ªsour˚s
,

501 
__öô
 
	$ï93xx_öô_devi˚s
()

503 
v
;

508 
v
 = 
	`__øw_ªadl
(
EP93XX_SYSCON_DEVICE_CONFIG
);

509 
v
 &~
EP93XX_SYSCON_DEVICE_CONFIG_CRUNCH_ENABLE
;

510 
	`__øw_wrôñ
(0xØ, 
EP93XX_SYSCON_SWLOCK
);

511 
	`__øw_wrôñ
(
v
, 
EP93XX_SYSCON_DEVICE_CONFIG
);

513 
	`amba_devi˚_ªgi°î
(&
u¨t1_devi˚
, &
iomem_ªsour˚
);

514 
	`amba_devi˚_ªgi°î
(&
u¨t2_devi˚
, &
iomem_ªsour˚
);

515 
	`amba_devi˚_ªgi°î
(&
u¨t3_devi˚
, &
iomem_ªsour˚
);

517 
	`∂©f‹m_devi˚_ªgi°î
(&
ï93xx_πc_devi˚
);

518 
	`∂©f‹m_devi˚_ªgi°î
(&
ï93xx_ohci_devi˚
);

519 
	}
}

	@arch/arm/mach-ep93xx/edb9302.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	gedb9302_Êash_d©a
 = {

27 .
width
 = 2,

30 
ªsour˚
 
	gedb9302_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x60ffffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gedb9302_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
edb9302_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
edb9302_Êash_ªsour˚
,

46 
__öô
 
	$edb9302_öô_machöe
()

48 
	`ï93xx_öô_devi˚s
();

49 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9302_Êash
);

50 
	}
}

52 
MACHINE_START
(
EDB9302
, "Cirrus Logic EDB9302 Evaluation Board")

54 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

55 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

56 .
	gboŸ_∑øms
 = 0x00000100,

57 .
	gm≠_io
 = 
ï93xx_m≠_io
,

58 .
	göô_úq
 = 
ï93xx_öô_úq
,

59 .
	gtimî
 = &
ï93xx_timî
,

60 .
	göô_machöe
 = 
edb9302_öô_machöe
,

61 
	gMACHINE_END


	@arch/arm/mach-ep93xx/edb9302a.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	gedb9302a_Êash_d©a
 = {

27 .
width
 = 2,

30 
ªsour˚
 
	gedb9302a_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x60ffffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gedb9302a_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
edb9302a_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
edb9302a_Êash_ªsour˚
,

46 
ï93xx_ëh_d©a
 
	gedb9302a_ëh_d©a
 = {

47 .
phy_id
 = 1,

50 
ªsour˚
 
	gedb9302a_ëh_ªsour˚
[] = {

52 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

53 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

56 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

57 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

58 .
	gÊags
 = 
IORESOURCE_IRQ
,

62 
∂©f‹m_devi˚
 
	gedb9302a_ëh_devi˚
 = {

63 .
«me
 = "ep93xx-eth",

64 .
	gid
 = -1,

65 .
	gdev
 = {

66 .
∂©f‹m_d©a
 = &
edb9302a_ëh_d©a
,

68 .
	gnum_ªsour˚s
 = 2,

69 .
	gªsour˚
 = 
edb9302a_ëh_ªsour˚
,

72 
__öô
 
	$edb9302a_öô_machöe
()

74 
	`ï93xx_öô_devi˚s
();

75 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9302a_Êash
);

77 
	`mem˝y
(
edb9302a_ëh_d©a
.
dev_addr
,

78 (*)(
EP93XX_ETHERNET_BASE
 + 0x50), 6);

79 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9302a_ëh_devi˚
);

80 
	}
}

82 
MACHINE_START
(
EDB9302A
, "Cirrus Logic EDB9302A Evaluation Board")

84 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

85 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

86 .
	gboŸ_∑øms
 = 0xc0000100,

87 .
	gm≠_io
 = 
ï93xx_m≠_io
,

88 .
	göô_úq
 = 
ï93xx_öô_úq
,

89 .
	gtimî
 = &
ï93xx_timî
,

90 .
	göô_machöe
 = 
edb9302a_öô_machöe
,

91 
	gMACHINE_END


	@arch/arm/mach-ep93xx/edb9312.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/öãºu±.h
>

19 
	~<löux/i›‹t.h
>

20 
	~<löux/mtd/physm≠.h
>

21 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<asm/io.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

27 
physm≠_Êash_d©a
 
	gedb9312_Êash_d©a
 = {

28 .
width
 = 4,

31 
ªsour˚
 
	gedb9312_Êash_ªsour˚
 = {

32 .
°¨t
 = 0x60000000,

33 .
	gíd
 = 0x61ffffff,

34 .
	gÊags
 = 
IORESOURCE_MEM
,

37 
∂©f‹m_devi˚
 
	gedb9312_Êash
 = {

38 .
«me
 = "physmap-flash",

39 .
	gid
 = 0,

40 .
	gdev
 = {

41 .
∂©f‹m_d©a
 = &
edb9312_Êash_d©a
,

43 .
	gnum_ªsour˚s
 = 1,

44 .
	gªsour˚
 = &
edb9312_Êash_ªsour˚
,

47 
__öô
 
	$edb9312_öô_machöe
()

49 
	`ï93xx_öô_devi˚s
();

50 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9312_Êash
);

51 
	}
}

53 
MACHINE_START
(
EDB9312
, "Cirrus Logic EDB9312 Evaluation Board")

55 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

56 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

57 .
	gboŸ_∑øms
 = 0x00000100,

58 .
	gm≠_io
 = 
ï93xx_m≠_io
,

59 .
	göô_úq
 = 
ï93xx_öô_úq
,

60 .
	gtimî
 = &
ï93xx_timî
,

61 .
	göô_machöe
 = 
edb9312_öô_machöe
,

62 
	gMACHINE_END


	@arch/arm/mach-ep93xx/edb9315.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	gedb9315_Êash_d©a
 = {

27 .
width
 = 4,

30 
ªsour˚
 
	gedb9315_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x61ffffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gedb9315_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
edb9315_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
edb9315_Êash_ªsour˚
,

46 
__öô
 
	$edb9315_öô_machöe
()

48 
	`ï93xx_öô_devi˚s
();

49 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9315_Êash
);

50 
	}
}

52 
MACHINE_START
(
EDB9315
, "Cirrus Logic EDB9315 Evaluation Board")

54 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

55 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

56 .
	gboŸ_∑øms
 = 0x00000100,

57 .
	gm≠_io
 = 
ï93xx_m≠_io
,

58 .
	göô_úq
 = 
ï93xx_öô_úq
,

59 .
	gtimî
 = &
ï93xx_timî
,

60 .
	göô_machöe
 = 
edb9315_öô_machöe
,

61 
	gMACHINE_END


	@arch/arm/mach-ep93xx/edb9315a.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	gedb9315a_Êash_d©a
 = {

27 .
width
 = 2,

30 
ªsour˚
 
	gedb9315a_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x60ffffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gedb9315a_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
edb9315a_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
edb9315a_Êash_ªsour˚
,

46 
ï93xx_ëh_d©a
 
	gedb9315a_ëh_d©a
 = {

47 .
phy_id
 = 1,

50 
ªsour˚
 
	gedb9315a_ëh_ªsour˚
[] = {

52 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

53 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

56 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

57 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

58 .
	gÊags
 = 
IORESOURCE_IRQ
,

62 
∂©f‹m_devi˚
 
	gedb9315a_ëh_devi˚
 = {

63 .
«me
 = "ep93xx-eth",

64 .
	gid
 = -1,

65 .
	gdev
 = {

66 .
∂©f‹m_d©a
 = &
edb9315a_ëh_d©a
,

68 .
	gnum_ªsour˚s
 = 2,

69 .
	gªsour˚
 = 
edb9315a_ëh_ªsour˚
,

72 
__öô
 
	$edb9315a_öô_machöe
()

74 
	`ï93xx_öô_devi˚s
();

75 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9315a_Êash
);

77 
	`mem˝y
(
edb9315a_ëh_d©a
.
dev_addr
,

78 (*)(
EP93XX_ETHERNET_BASE
 + 0x50), 6);

79 
	`∂©f‹m_devi˚_ªgi°î
(&
edb9315a_ëh_devi˚
);

80 
	}
}

82 
MACHINE_START
(
EDB9315A
, "Cirrus Logic EDB9315A Evaluation Board")

84 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

85 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

86 .
	gboŸ_∑øms
 = 0xc0000100,

87 .
	gm≠_io
 = 
ï93xx_m≠_io
,

88 .
	göô_úq
 = 
ï93xx_öô_úq
,

89 .
	gtimî
 = &
ï93xx_timî
,

90 .
	göô_machöe
 = 
edb9315a_öô_machöe
,

91 
	gMACHINE_END


	@arch/arm/mach-ep93xx/gesbc9312.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<asm/io.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

26 
physm≠_Êash_d©a
 
	ggesbc9312_Êash_d©a
 = {

27 .
width
 = 4,

30 
ªsour˚
 
	ggesbc9312_Êash_ªsour˚
 = {

31 .
°¨t
 = 0x60000000,

32 .
	gíd
 = 0x607fffff,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	ggesbc9312_Êash
 = {

37 .
«me
 = "physmap-flash",

38 .
	gid
 = 0,

39 .
	gdev
 = {

40 .
∂©f‹m_d©a
 = &
gesbc9312_Êash_d©a
,

42 .
	gnum_ªsour˚s
 = 1,

43 .
	gªsour˚
 = &
gesbc9312_Êash_ªsour˚
,

46 
ï93xx_ëh_d©a
 
	ggesbc9312_ëh_d©a
 = {

47 .
phy_id
 = 1,

50 
ªsour˚
 
	ggesbc9312_ëh_ªsour˚
[] = {

52 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

53 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

56 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

57 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

58 .
	gÊags
 = 
IORESOURCE_IRQ
,

62 
∂©f‹m_devi˚
 
	ggesbc9312_ëh_devi˚
 = {

63 .
«me
 = "ep93xx-eth",

64 .
	gid
 = -1,

65 .
	gdev
 = {

66 .
∂©f‹m_d©a
 = &
gesbc9312_ëh_d©a
,

68 .
	gnum_ªsour˚s
 = 2,

69 .
	gªsour˚
 = 
gesbc9312_ëh_ªsour˚
,

72 
__öô
 
	$gesbc9312_öô_machöe
()

74 
	`ï93xx_öô_devi˚s
();

75 
	`∂©f‹m_devi˚_ªgi°î
(&
gesbc9312_Êash
);

76 
	`∂©f‹m_devi˚_ªgi°î
(&
gesbc9312_ëh_devi˚
);

77 
	}
}

79 
MACHINE_START
(
GESBC9312
, "Glomation GESBC-9312-sx")

81 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

82 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

83 .
	gboŸ_∑øms
 = 0x00000100,

84 .
	gm≠_io
 = 
ï93xx_m≠_io
,

85 .
	göô_úq
 = 
ï93xx_öô_úq
,

86 .
	gtimî
 = &
ï93xx_timî
,

87 .
	göô_machöe
 = 
gesbc9312_öô_machöe
,

88 
	gMACHINE_END


	@arch/arm/mach-ep93xx/micro9.c

12 
	~<löux/öô.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/i›‹t.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/sched.h
>

20 
	~<löux/mtd/physm≠.h
>

22 
	~<asm/io.h
>

23 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach-ty≥s.h
>

28 
ï93xx_ëh_d©a
 
	gmi¸o9_ëh_d©a
 = {

29 .
phy_id
 = 0x1f,

32 
ªsour˚
 
	gmi¸o9_ëh_ªsour˚
[] = {

34 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

35 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

36 .
	gÊags
 = 
IORESOURCE_MEM
,

38 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

39 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

40 .
	gÊags
 = 
IORESOURCE_IRQ
,

44 
∂©f‹m_devi˚
 
	gmi¸o9_ëh_devi˚
 = {

45 .
«me
 = "ep93xx-eth",

46 .
	gid
 = -1,

47 .
	gdev
 = {

48 .
∂©f‹m_d©a
 = &
mi¸o9_ëh_d©a
,

50 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mi¸o9_ëh_ªsour˚
),

51 .
	gªsour˚
 = 
mi¸o9_ëh_ªsour˚
,

54 
__öô
 
	$mi¸o9_ëh_öô
()

56 
	`mem˝y
(
mi¸o9_ëh_d©a
.
dev_addr
,

57 (*)(
EP93XX_ETHERNET_BASE
 + 0x50), 6);

58 
	`∂©f‹m_devi˚_ªgi°î
(&
mi¸o9_ëh_devi˚
);

59 
	}
}

61 
__öô
 
	$mi¸o9_öô
()

63 
	`mi¸o9_ëh_öô
();

64 
	}
}

69 #ifde‡
CONFIG_MACH_MICRO9H


70 
physm≠_Êash_d©a
 
	gmi¸o9h_Êash_d©a
 = {

71 .
width
 = 4,

74 
ªsour˚
 
	gmi¸o9h_Êash_ªsour˚
 = {

75 .
°¨t
 = 0x10000000,

76 .
	gíd
 = 0x13ffffff,

77 .
	gÊags
 = 
IORESOURCE_MEM
,

80 
∂©f‹m_devi˚
 
	gmi¸o9h_Êash
 = {

81 .
«me
 = "physmap-flash",

82 .
	gid
 = 0,

83 .
	gdev
 = {

84 .
∂©f‹m_d©a
 = &
mi¸o9h_Êash_d©a
,

86 .
	gnum_ªsour˚s
 = 1,

87 .
	gªsour˚
 = &
mi¸o9h_Êash_ªsour˚
,

90 
__öô
 
	$mi¸o9h_öô
()

92 
	`∂©f‹m_devi˚_ªgi°î
(&
mi¸o9h_Êash
);

93 
	}
}

95 
__öô
 
	$mi¸o9h_öô_machöe
()

97 
	`ï93xx_öô_devi˚s
();

98 
	`mi¸o9_öô
();

99 
	`mi¸o9h_öô
();

100 
	}
}

102 
MACHINE_START
(
MICRO9
, "Contec Hypercontrol Micro9-H")

104 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

105 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

106 .
	gboŸ_∑øms
 = 0x00000100,

107 .
	gm≠_io
 = 
ï93xx_m≠_io
,

108 .
	göô_úq
 = 
ï93xx_öô_úq
,

109 .
	gtimî
 = &
ï93xx_timî
,

110 .
	göô_machöe
 = 
mi¸o9h_öô_machöe
,

111 
	gMACHINE_END


117 #ifde‡
CONFIG_MACH_MICRO9M


118 
__öô
 
	$mi¸o9m_öô_machöe
()

120 
	`ï93xx_öô_devi˚s
();

121 
	`mi¸o9_öô
();

122 
	}
}

124 
MACHINE_START
(
MICRO9M
, "Contec Hypercontrol Micro9-M")

126 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

127 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

128 .
	gboŸ_∑øms
 = 0x00000100,

129 .
	gm≠_io
 = 
ï93xx_m≠_io
,

130 .
	göô_úq
 = 
ï93xx_öô_úq
,

131 .
	gtimî
 = &
ï93xx_timî
,

132 .
	göô_machöe
 = 
mi¸o9m_öô_machöe
,

133 
	gMACHINE_END


139 #ifde‡
CONFIG_MACH_MICRO9L


140 
__öô
 
	$mi¸o9l_öô_machöe
()

142 
	`ï93xx_öô_devi˚s
();

143 
	`mi¸o9_öô
();

144 
	}
}

146 
MACHINE_START
(
MICRO9L
, "Contec Hypercontrol Micro9-L")

148 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

149 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

150 .
	gboŸ_∑øms
 = 0x00000100,

151 .
	gm≠_io
 = 
ï93xx_m≠_io
,

152 .
	göô_úq
 = 
ï93xx_öô_úq
,

153 .
	gtimî
 = &
ï93xx_timî
,

154 .
	göô_machöe
 = 
mi¸o9l_öô_machöe
,

155 
	gMACHINE_END


	@arch/arm/mach-ep93xx/ts72xx.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/i›‹t.h
>

19 
	~<löux/mtd/physm≠.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<löux/m48t86.h
>

22 
	~<asm/io.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/m≠.h
>

28 
m≠_desc
 
	gts72xx_io_desc
[] 
	g__öôd©a
 = {

30 .
vútuÆ
 = 
TS72XX_MODEL_VIRT_BASE
,

31 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_MODEL_PHYS_BASE
),

32 .
	gÀngth
 = 
TS72XX_MODEL_SIZE
,

33 .
	gty≥
 = 
MT_DEVICE
,

35 .
	gvútuÆ
 = 
TS72XX_OPTIONS_VIRT_BASE
,

36 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_OPTIONS_PHYS_BASE
),

37 .
	gÀngth
 = 
TS72XX_OPTIONS_SIZE
,

38 .
	gty≥
 = 
MT_DEVICE
,

40 .
	gvútuÆ
 = 
TS72XX_OPTIONS2_VIRT_BASE
,

41 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_OPTIONS2_PHYS_BASE
),

42 .
	gÀngth
 = 
TS72XX_OPTIONS2_SIZE
,

43 .
	gty≥
 = 
MT_DEVICE
,

45 .
	gvútuÆ
 = 
TS72XX_RTC_INDEX_VIRT_BASE
,

46 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_RTC_INDEX_PHYS_BASE
),

47 .
	gÀngth
 = 
TS72XX_RTC_INDEX_SIZE
,

48 .
	gty≥
 = 
MT_DEVICE
,

50 .
	gvútuÆ
 = 
TS72XX_RTC_DATA_VIRT_BASE
,

51 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_RTC_DATA_PHYS_BASE
),

52 .
	gÀngth
 = 
TS72XX_RTC_DATA_SIZE
,

53 .
	gty≥
 = 
MT_DEVICE
,

57 
m≠_desc
 
	gts72xx_«nd_io_desc
[] 
	g__öôd©a
 = {

59 .
vútuÆ
 = 
TS72XX_NAND_DATA_VIRT_BASE
,

60 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND1_DATA_PHYS_BASE
),

61 .
	gÀngth
 = 
TS72XX_NAND_DATA_SIZE
,

62 .
	gty≥
 = 
MT_DEVICE
,

64 .
	gvútuÆ
 = 
TS72XX_NAND_CONTROL_VIRT_BASE
,

65 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND1_CONTROL_PHYS_BASE
),

66 .
	gÀngth
 = 
TS72XX_NAND_CONTROL_SIZE
,

67 .
	gty≥
 = 
MT_DEVICE
,

69 .
	gvútuÆ
 = 
TS72XX_NAND_BUSY_VIRT_BASE
,

70 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND1_BUSY_PHYS_BASE
),

71 .
	gÀngth
 = 
TS72XX_NAND_BUSY_SIZE
,

72 .
	gty≥
 = 
MT_DEVICE
,

76 
m≠_desc
 
	gts72xx_Æã∫©e_«nd_io_desc
[] 
	g__öôd©a
 = {

78 .
vútuÆ
 = 
TS72XX_NAND_DATA_VIRT_BASE
,

79 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND2_DATA_PHYS_BASE
),

80 .
	gÀngth
 = 
TS72XX_NAND_DATA_SIZE
,

81 .
	gty≥
 = 
MT_DEVICE
,

83 .
	gvútuÆ
 = 
TS72XX_NAND_CONTROL_VIRT_BASE
,

84 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND2_CONTROL_PHYS_BASE
),

85 .
	gÀngth
 = 
TS72XX_NAND_CONTROL_SIZE
,

86 .
	gty≥
 = 
MT_DEVICE
,

88 .
	gvútuÆ
 = 
TS72XX_NAND_BUSY_VIRT_BASE
,

89 .
	gp‚
 = 
__phys_to_p‚
(
TS72XX_NAND2_BUSY_PHYS_BASE
),

90 .
	gÀngth
 = 
TS72XX_NAND_BUSY_SIZE
,

91 .
	gty≥
 = 
MT_DEVICE
,

95 
__öô
 
	$ts72xx_m≠_io
()

97 
	`ï93xx_m≠_io
();

98 
	`iŸabÀ_öô
(
ts72xx_io_desc
, 
	`ARRAY_SIZE
(ts72xx_io_desc));

103 i‡(!
	`bﬂrd_is_ts7200
()) {

104 i‡(
	`is_ts9420_ö°ÆÀd
()) {

105 
	`iŸabÀ_öô
(
ts72xx_Æã∫©e_«nd_io_desc
,

106 
	`ARRAY_SIZE
(
ts72xx_Æã∫©e_«nd_io_desc
));

108 
	`iŸabÀ_öô
(
ts72xx_«nd_io_desc
,

109 
	`ARRAY_SIZE
(
ts72xx_«nd_io_desc
));

112 
	}
}

114 
physm≠_Êash_d©a
 
	gts72xx_Êash_d©a
 = {

115 .
width
 = 1,

118 
ªsour˚
 
	gts72xx_Êash_ªsour˚
 = {

119 .
°¨t
 = 
TS72XX_NOR_PHYS_BASE
,

120 .
	gíd
 = 
TS72XX_NOR_PHYS_BASE
 + 0x00ffffff,

121 .
	gÊags
 = 
IORESOURCE_MEM
,

124 
∂©f‹m_devi˚
 
	gts72xx_Êash
 = {

125 .
«me
 = "physmap-flash",

126 .
	gid
 = 0,

127 .
	gdev
 = {

128 .
∂©f‹m_d©a
 = &
ts72xx_Êash_d©a
,

130 .
	gnum_ªsour˚s
 = 1,

131 .
	gªsour˚
 = &
ts72xx_Êash_ªsour˚
,

134 
	$ts72xx_πc_ªadbyã
(
addr
)

136 
	`__øw_wrôeb
(
addr
, 
TS72XX_RTC_INDEX_VIRT_BASE
);

137  
	`__øw_ªadb
(
TS72XX_RTC_DATA_VIRT_BASE
);

138 
	}
}

140 
	$ts72xx_πc_wrôebyã
(
vÆue
, 
addr
)

142 
	`__øw_wrôeb
(
addr
, 
TS72XX_RTC_INDEX_VIRT_BASE
);

143 
	`__øw_wrôeb
(
vÆue
, 
TS72XX_RTC_DATA_VIRT_BASE
);

144 
	}
}

146 
m48t86_›s
 
	gts72xx_πc_›s
 = {

147 .
ªadbyã
 = 
ts72xx_πc_ªadbyã
,

148 .
	gwrôebyã
 = 
ts72xx_πc_wrôebyã
,

151 
∂©f‹m_devi˚
 
	gts72xx_πc_devi˚
 = {

152 .
«me
 = "rtc-m48t86",

153 .
	gid
 = -1,

154 .
	gdev
 = {

155 .
∂©f‹m_d©a
 = &
ts72xx_πc_›s
,

157 .
	gnum_ªsour˚s
 = 0,

160 
ï93xx_ëh_d©a
 
	gts72xx_ëh_d©a
 = {

161 .
phy_id
 = 1,

164 
ªsour˚
 
	gts72xx_ëh_ªsour˚
[] = {

166 .
°¨t
 = 
EP93XX_ETHERNET_PHYS_BASE
,

167 .
	gíd
 = 
EP93XX_ETHERNET_PHYS_BASE
 + 0xffff,

168 .
	gÊags
 = 
IORESOURCE_MEM
,

170 .
	g°¨t
 = 
IRQ_EP93XX_ETHERNET
,

171 .
	gíd
 = 
IRQ_EP93XX_ETHERNET
,

172 .
	gÊags
 = 
IORESOURCE_IRQ
,

176 
∂©f‹m_devi˚
 
	gts72xx_ëh_devi˚
 = {

177 .
«me
 = "ep93xx-eth",

178 .
	gid
 = -1,

179 .
	gdev
 = {

180 .
∂©f‹m_d©a
 = &
ts72xx_ëh_d©a
,

182 .
	gnum_ªsour˚s
 = 2,

183 .
	gªsour˚
 = 
ts72xx_ëh_ªsour˚
,

186 
__öô
 
	$ts72xx_öô_machöe
()

188 
	`ï93xx_öô_devi˚s
();

189 i‡(
	`bﬂrd_is_ts7200
())

190 
	`∂©f‹m_devi˚_ªgi°î
(&
ts72xx_Êash
);

191 
	`∂©f‹m_devi˚_ªgi°î
(&
ts72xx_πc_devi˚
);

193 
	`mem˝y
(
ts72xx_ëh_d©a
.
dev_addr
,

194 (*)(
EP93XX_ETHERNET_BASE
 + 0x50), 6);

195 
	`∂©f‹m_devi˚_ªgi°î
(&
ts72xx_ëh_devi˚
);

196 
	}
}

198 
MACHINE_START
(
TS72XX
, "Technologic Systems TS-72xx SBC")

200 .
	gphys_io
 = 
EP93XX_APB_PHYS_BASE
,

201 .
	gio_pg_off°
 = ((
EP93XX_APB_VIRT_BASE
) >> 18) & 0xfffc,

202 .
	gboŸ_∑øms
 = 0x00000100,

203 .
	gm≠_io
 = 
ts72xx_m≠_io
,

204 .
	göô_úq
 = 
ï93xx_öô_úq
,

205 .
	gtimî
 = &
ï93xx_timî
,

206 .
	göô_machöe
 = 
ts72xx_öô_machöe
,

207 
	gMACHINE_END


	@arch/arm/mach-footbridge/cats-hw.c

8 
	~<löux/i›‹t.h
>

9 
	~<löux/kî√l.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/s¸ìn_öfo.h
>

13 
	~<asm/h¨dw¨e/dec21285.h
>

14 
	~<asm/io.h
>

15 
	~<asm/mach-ty≥s.h
>

16 
	~<asm/£tup.h
>

18 
	~<asm/mach/¨ch.h
>

20 
	~"comm⁄.h
"

22 
	#CFG_PORT
 0x370

	)

23 
	#INDEX_PORT
 (
CFG_PORT
)

	)

24 
	#DATA_PORT
 (
CFG_PORT
 + 1)

	)

26 
__öô
 
	$ˇts_hw_öô
()

28 i‡(
	`machöe_is_ˇts
()) {

30 
	`outb
(0x51, 
CFG_PORT
);

31 
	`outb
(0x23, 
CFG_PORT
);

34 
	`outb
(0x07, 
INDEX_PORT
);

35 
	`outb
(0x03, 
DATA_PORT
);

39 
	`outb
(0x74, 
INDEX_PORT
);

40 
	`outb
(0x03, 
DATA_PORT
);

42 
	`outb
(0xf0, 
INDEX_PORT
);

43 
	`outb
(0x0f, 
DATA_PORT
);

45 
	`outb
(0xf1, 
INDEX_PORT
);

46 
	`outb
(0x07, 
DATA_PORT
);

49 
	`outb
(0x07, 
INDEX_PORT
);

50 
	`outb
(0x04, 
DATA_PORT
);

53 
	`outb
(0xf0, 
INDEX_PORT
);

54 
	`outb
(0x02, 
DATA_PORT
);

57 
	`outb
(0x07, 
INDEX_PORT
);

58 
	`outb
(0x05, 
DATA_PORT
);

61 
	`outb
(0xf0, 
INDEX_PORT
);

62 
	`outb
(0x02, 
DATA_PORT
);

65 
	`outb
(0xbb, 
CFG_PORT
);

69 
	}
}

71 
__öôˇŒ
(
ˇts_hw_öô
);

77 
__öô


78 
	$fixup_ˇts
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

79 **
cmdlöe
, 
memöfo
 *
mi
)

81 
ORIG_VIDEO_LINES
 = 25;

82 
ORIG_VIDEO_POINTS
 = 16;

83 
ORIG_Y
 = 24;

84 
	}
}

86 
MACHINE_START
(
CATS
, "Chalice-CATS")

88 .
	gphys_io
 = 
DC21285_ARMCSR_BASE
,

89 .
	gio_pg_off°
 = ((0xfe000000) >> 18) & 0xfffc,

90 .
	gboŸ_∑øms
 = 0x00000100,

91 .
	gso·_ªboŸ
 = 1,

92 .
	gfixup
 = 
fixup_ˇts
,

93 .
	gm≠_io
 = 
foŸbridge_m≠_io
,

94 .
	göô_úq
 = 
foŸbridge_öô_úq
,

95 .
	gtimî
 = &
iß_timî
,

96 
	gMACHINE_END


	@arch/arm/mach-footbridge/cats-pci.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/pci.h
>

10 
	~<löux/öô.h
>

12 
	~<asm/úq.h
>

13 
	~<asm/mach/pci.h
>

14 
	~<asm/mach-ty≥s.h
>

17 
	gúqm≠_ˇts
[] 
	g__öôd©a
 = { 
IRQ_PCI
, 
IRQ_IN0
, 
IRQ_IN1
, 
IRQ_IN3
 };

19 
__öô
 
	$ˇts_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

21 i‡(
dev
->
úq
 >= 128)

22  
dev
->
úq
 & 0x1f;

24 i‡(
dev
->
úq
 >= 1 && dev->irq <= 4)

25  
úqm≠_ˇts
[
dev
->
úq
 - 1];

27 i‡(
dev
->
úq
 != 0)

28 
	`¥ötk
("PCI: device %02x:%02x has unknown irqÜine %x\n",

29 
dev
->
bus
->
numbî
, dev->
dev‚
, dev->
úq
);

32 
	}
}

38 
hw_pci
 
ˇts_pci
 
	g__öôd©a
 = {

39 .
swizzÀ
 = 
NULL
,

40 .
	gm≠_úq
 = 
ˇts_m≠_úq
,

41 .
	gƒ_c⁄åﬁÀrs
 = 1,

42 .
	g£tup
 = 
dc21285_£tup
,

43 .
	gsˇn
 = 
dc21285_sˇn_bus
,

44 .
	g¥eöô
 = 
dc21285_¥eöô
,

45 .
	gpo°öô
 = 
dc21285_po°öô
,

48 
__öô
 
	$ˇts_pci_öô
()

50 i‡(
	`machöe_is_ˇts
())

51 
	`pci_comm⁄_öô
(&
ˇts_pci
);

53 
	}
}

55 
subsys_öôˇŒ
(
ˇts_pci_öô
);

	@arch/arm/mach-footbridge/co285.c

6 
	~<löux/öô.h
>

8 
	~<asm/h¨dw¨e/dec21285.h
>

9 
	~<asm/mach-ty≥s.h
>

11 
	~<asm/mach/¨ch.h
>

13 
	~"comm⁄.h
"

15 
__öô


16 
	$fixup_c€bß285
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

17 **
cmdlöe
, 
memöfo
 *
mi
)

19 
boŸ_mem‹y_íd
;

20 
boŸ_comm™d_löe
[];

22 
mi
->
ƒ_b™ks
 = 1;

23 
mi
->
b™k
[0].
°¨t
 = 
PHYS_OFFSET
;

24 
mi
->
b™k
[0].
size
 = 
boŸ_mem‹y_íd
;

25 
mi
->
b™k
[0].
node
 = 0;

27 *
cmdlöe
 = 
boŸ_comm™d_löe
;

28 
	}
}

30 
MACHINE_START
(
CO285
, "co-EBSA285")

32 .
	gphys_io
 = 
DC21285_ARMCSR_BASE
,

33 .
	gio_pg_off°
 = ((0x7cf00000) >> 18) & 0xfffc,

34 .
	gfixup
 = 
fixup_c€bß285
,

35 .
	gm≠_io
 = 
foŸbridge_m≠_io
,

36 .
	göô_úq
 = 
foŸbridge_öô_úq
,

37 .
	gtimî
 = &
foŸbridge_timî
,

38 
	gMACHINE_END


	@arch/arm/mach-footbridge/common.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/ty≥s.h
>

12 
	~<löux/mm.h
>

13 
	~<löux/i›‹t.h
>

14 
	~<löux/li°.h
>

15 
	~<löux/öô.h
>

17 
	~<asm/pgèbÀ.h
>

18 
	~<asm/∑ge.h
>

19 
	~<asm/úq.h
>

20 
	~<asm/io.h
>

21 
	~<asm/mach-ty≥s.h
>

22 
	~<asm/£tup.h
>

23 
	~<asm/h¨dw¨e/dec21285.h
>

25 
	~<asm/mach/úq.h
>

26 
	~<asm/mach/m≠.h
>

28 
	~"comm⁄.h
"

30 
__öô
 
iß_öô_úq
(
úq
);

32 
	gmem_f˛k_21285
 = 50000000;

34 
EXPORT_SYMBOL
(
mem_f˛k_21285
);

36 
__öô
 
	$∑r£_èg_mem˛k
(c⁄° 
èg
 *tag)

38 
mem_f˛k_21285
 = 
èg
->
u
.
mem˛k
.
fmem˛k
;

40 
	}
}

42 
__ègèbÀ
(
ATAG_MEMCLK
, 
∑r£_èg_mem˛k
);

48 c⁄° 
	gfb_úq_mask
[] = {

49 
IRQ_MASK_UART_RX
,

50 
IRQ_MASK_UART_TX
,

51 
IRQ_MASK_TIMER1
,

52 
IRQ_MASK_TIMER2
,

53 
IRQ_MASK_TIMER3
,

54 
IRQ_MASK_IN0
,

55 
IRQ_MASK_IN1
,

56 
IRQ_MASK_IN2
,

57 
IRQ_MASK_IN3
,

58 
IRQ_MASK_DOORBELLHOST
,

59 
IRQ_MASK_DMA1
,

60 
IRQ_MASK_DMA2
,

61 
IRQ_MASK_PCI
,

62 
IRQ_MASK_SDRAMPARITY
,

63 
IRQ_MASK_I2OINPOST
,

64 
IRQ_MASK_PCI_ABORT
,

65 
IRQ_MASK_PCI_SERR
,

66 
IRQ_MASK_DISCARD_TIMER
,

67 
IRQ_MASK_PCI_DPERR
,

68 
IRQ_MASK_PCI_PERR
,

71 
	$fb_mask_úq
(
úq
)

73 *
CSR_IRQ_DISABLE
 = 
fb_úq_mask
[
	`_DC21285_INR
(
úq
)];

74 
	}
}

76 
	$fb_unmask_úq
(
úq
)

78 *
CSR_IRQ_ENABLE
 = 
fb_úq_mask
[
	`_DC21285_INR
(
úq
)];

79 
	}
}

81 
úq_chù
 
	gfb_chù
 = {

82 .
ack
 = 
fb_mask_úq
,

83 .
	gmask
 = 
fb_mask_úq
,

84 .
	gunmask
 = 
fb_unmask_úq
,

87 
__öô
 
	$__fb_öô_úq
()

89 
úq
;

94 *
CSR_IRQ_DISABLE
 = -1;

95 *
CSR_FIQ_DISABLE
 = -1;

97 
úq
 = 
	`_DC21285_IRQ
(0); irq < _DC21285_IRQ(20); irq++) {

98 
	`£t_úq_chù
(
úq
, &
fb_chù
);

99 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

100 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

102 
	}
}

104 
__öô
 
	$foŸbridge_öô_úq
()

106 
	`__fb_öô_úq
();

108 i‡(!
	`foŸbridge_c‚_mode
())

111 i‡(
	`machöe_is_ebß285
())

117 
	`iß_öô_úq
(
IRQ_PCI
);

119 i‡(
	`machöe_is_ˇts
())

120 
	`iß_öô_úq
(
IRQ_IN2
);

122 i‡(
	`machöe_is_√twödî
())

123 
	`iß_öô_úq
(
IRQ_IN3
);

124 
	}
}

131 
m≠_desc
 
	gfb_comm⁄_io_desc
[] 
	g__öôd©a
 = {

133 .
vútuÆ
 = 
ARMCSR_BASE
,

134 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_ARMCSR_BASE
),

135 .
	gÀngth
 = 
ARMCSR_SIZE
,

136 .
	gty≥
 = 
MT_DEVICE
,

138 .
	gvútuÆ
 = 
XBUS_BASE
,

139 .
	gp‚
 = 
__phys_to_p‚
(0x40000000),

140 .
	gÀngth
 = 
XBUS_SIZE
,

141 .
	gty≥
 = 
MT_DEVICE
,

149 
m≠_desc
 
	gebß285_ho°_io_desc
[] 
	g__öôd©a
 = {

150 #i‡
deföed
(
CONFIG_ARCH_FOOTBRIDGE
Ë&& deföed(
CONFIG_FOOTBRIDGE_HOST
)

152 .
vútuÆ
 = 
PCIMEM_BASE
,

153 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_MEM
),

154 .
	gÀngth
 = 
PCIMEM_SIZE
,

155 .
	gty≥
 = 
MT_DEVICE
,

157 .
	gvútuÆ
 = 
PCICFG0_BASE
,

158 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_TYPE_0_CONFIG
),

159 .
	gÀngth
 = 
PCICFG0_SIZE
,

160 .
	gty≥
 = 
MT_DEVICE
,

162 .
	gvútuÆ
 = 
PCICFG1_BASE
,

163 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_TYPE_1_CONFIG
),

164 .
	gÀngth
 = 
PCICFG1_SIZE
,

165 .
	gty≥
 = 
MT_DEVICE
,

167 .
	gvútuÆ
 = 
PCIIACK_BASE
,

168 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_IACK
),

169 .
	gÀngth
 = 
PCIIACK_SIZE
,

170 .
	gty≥
 = 
MT_DEVICE
,

172 .
	gvútuÆ
 = 
PCIO_BASE
,

173 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_IO
),

174 .
	gÀngth
 = 
PCIO_SIZE
,

175 .
	gty≥
 = 
MT_DEVICE
,

183 
m≠_desc
 
	gco285_io_desc
[] 
	g__öôd©a
 = {

184 #ifde‡
CONFIG_ARCH_CO285


186 .
vútuÆ
 = 
PCIO_BASE
,

187 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_IO
),

188 .
	gÀngth
 = 
PCIO_SIZE
,

189 .
	gty≥
 = 
MT_DEVICE
,

191 .
	gvútuÆ
 = 
PCIMEM_BASE
,

192 .
	gp‚
 = 
__phys_to_p‚
(
DC21285_PCI_MEM
),

193 .
	gÀngth
 = 
PCIMEM_SIZE
,

194 .
	gty≥
 = 
MT_DEVICE
,

199 
__öô
 
	$foŸbridge_m≠_io
()

205 
	`iŸabÀ_öô
(
fb_comm⁄_io_desc
, 
	`ARRAY_SIZE
(fb_common_io_desc));

211 i‡(
	`machöe_is_co285
())

212 
	`iŸabÀ_öô
(
co285_io_desc
, 
	`ARRAY_SIZE
(co285_io_desc));

213 i‡(
	`foŸbridge_c‚_mode
())

214 
	`iŸabÀ_öô
(
ebß285_ho°_io_desc
, 
	`ARRAY_SIZE
(ebsa285_host_io_desc));

215 
	}
}

217 #ifde‡
CONFIG_FOOTBRIDGE_ADDIN


224 
	$__vút_to_bus
(
ªs
)

226 
	`WARN_ON
(
ªs
 < 
PAGE_OFFSET
 ||Ñe†>()
high_mem‹y
);

228  (
ªs
 - 
PAGE_OFFSET
Ë+ (*
CSR_PCISDRAMBASE
 & 0xfffffff0);

229 
	}
}

230 
EXPORT_SYMBOL
(
__vút_to_bus
);

232 
	$__bus_to_vút
(
ªs
)

234 
ªs
 -(*
CSR_PCISDRAMBASE
 & 0xfffffff0);

235 
ªs
 +
PAGE_OFFSET
;

237 
	`WARN_ON
(
ªs
 < 
PAGE_OFFSET
 ||Ñe†>()
high_mem‹y
);

239  
ªs
;

240 
	}
}

241 
EXPORT_SYMBOL
(
__bus_to_vút
);

	@arch/arm/mach-footbridge/common.h

2 
sys_timî
 
foŸbridge_timî
;

3 
sys_timî
 
iß_timî
;

5 
iß_πc_öô
();

7 
foŸbridge_m≠_io
();

8 
foŸbridge_öô_úq
();

	@arch/arm/mach-footbridge/dc21285-timer.c

7 
	~<löux/öô.h
>

8 
	~<löux/öãºu±.h
>

9 
	~<löux/úq.h
>

11 
	~<asm/úq.h
>

13 
	~<asm/h¨dw¨e/dec21285.h
>

14 
	~<asm/mach/time.h
>

16 
	~"comm⁄.h
"

21 
	gtimî1_œtch
;

23 
	$timî1_gëtimeoff£t
 ()

25 
vÆue
 = 
timî1_œtch
 - *
CSR_TIMER1_VALUE
;

27  ((
tick_n£c
 / 1000Ë* 
vÆue
Ë/ 
timî1_œtch
;

28 
	}
}

30 
úqªtu∫_t


31 
	$timî1_öãºu±
(
úq
, *
dev_id
)

33 
	`wrôe_£qlock
(&
xtime_lock
);

35 *
CSR_TIMER1_CLR
 = 0;

37 
	`timî_tick
();

39 
	`wrôe_£qu∆ock
(&
xtime_lock
);

41  
IRQ_HANDLED
;

42 
	}
}

44 
úqa˘i⁄
 
	gfoŸbridge_timî_úq
 = {

45 .
«me
 = "Timer1ÅimerÅick",

46 .
	gh™dÀr
 = 
timî1_öãºu±
,

47 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

53 
__öô
 
	$foŸbridge_timî_öô
()

55 
timî1_œtch
 = (
mem_f˛k_21285
 + 8 * 
HZ
) / (16 * HZ);

57 *
CSR_TIMER1_CLR
 = 0;

58 *
CSR_TIMER1_LOAD
 = 
timî1_œtch
;

59 *
CSR_TIMER1_CNTL
 = 
TIMER_CNTL_ENABLE
 | 
TIMER_CNTL_AUTORELOAD
 | 
TIMER_CNTL_DIV16
;

61 
	`£tup_úq
(
IRQ_TIMER1
, &
foŸbridge_timî_úq
);

63 
	`iß_πc_öô
();

64 
	}
}

66 
sys_timî
 
	gfoŸbridge_timî
 = {

67 .
öô
 = 
foŸbridge_timî_öô
,

68 .
	goff£t
 = 
timî1_gëtimeoff£t
,

	@arch/arm/mach-footbridge/dc21285.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/pci.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/i›‹t.h
>

18 
	~<löux/úq.h
>

20 
	~<asm/io.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/sy°em.h
>

23 
	~<asm/mach/pci.h
>

24 
	~<asm/h¨dw¨e/dec21285.h
>

26 
	#MAX_SLOTS
 21

	)

28 
	#PCICMD_ABORT
 ((
PCI_STATUS_REC_MASTER_ABORT
| \

29 
PCI_STATUS_REC_TARGET_ABORT
)<<16)

	)

31 
	#PCICMD_ERROR_BITS
 ((
PCI_STATUS_DETECTED_PARITY
 | \

32 
PCI_STATUS_REC_MASTER_ABORT
 | \

33 
PCI_STATUS_REC_TARGET_ABORT
 | \

34 
PCI_STATUS_PARITY
Ë<< 16)

	)

36 
£tup_¨m_úq
(, 
úqa˘i⁄
 *);

37 
pcibios_ªp‹t_°©us
(
u_öt
 
°©us_mask
, 
w¨n
);

40 
	$dc21285_ba£_addªss
(
pci_bus
 *
bus
, 
dev‚
)

42 
addr
 = 0;

44 i‡(
bus
->
numbî
 == 0) {

45 i‡(
	`PCI_SLOT
(
dev‚
) == 0)

49 
addr
 = 
ARMCSR_BASE
;

51 
dev‚
 -= 1 << 3;

53 i‡(
dev‚
 < 
	`PCI_DEVFN
(
MAX_SLOTS
, 0))

54 
addr
 = 
PCICFG0_BASE
 | 0xc00000 | (
dev‚
 << 8);

57 
addr
 = 
PCICFG1_BASE
 | (
bus
->
numbî
 << 16Ë| (
dev‚
 << 8);

59  
addr
;

60 
	}
}

63 
	$dc21285_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

64 
size
, 
u32
 *
vÆue
)

66 
addr
 = 
	`dc21285_ba£_addªss
(
bus
, 
dev‚
);

67 
u32
 
v
 = 0xffffffff;

69 i‡(
addr
)

70 
size
) {

72 
	`asm
("ldrb %0, [%1, %2]"

73 : "Ù" (
v
Ë: "r" (
addr
), "r" (
whîe
) : "cc");

76 
	`asm
("ldrh %0, [%1, %2]"

77 : "Ù" (
v
Ë: "r" (
addr
), "r" (
whîe
) : "cc");

80 
	`asm
("ldr %0, [%1, %2]"

81 : "Ù" (
v
Ë: "r" (
addr
), "r" (
whîe
) : "cc");

85 *
vÆue
 = 
v
;

87 
v
 = *
CSR_PCICMD
;

88 i‡(
v
 & 
PCICMD_ABORT
) {

89 *
CSR_PCICMD
 = 
v
 & (0xffff|
PCICMD_ABORT
);

93  
PCIBIOS_SUCCESSFUL
;

94 
	}
}

97 
	$dc21285_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

98 
size
, 
u32
 
vÆue
)

100 
addr
 = 
	`dc21285_ba£_addªss
(
bus
, 
dev‚
);

101 
u32
 
v
;

103 i‡(
addr
)

104 
size
) {

106 
	`asm
("strb %0, [%1, %2]"

107 : : "r" (
vÆue
), "r" (
addr
), "r" (
whîe
)

111 
	`asm
("strh %0, [%1, %2]"

112 : : "r" (
vÆue
), "r" (
addr
), "r" (
whîe
)

116 
	`asm
("str %0, [%1, %2]"

117 : : "r" (
vÆue
), "r" (
addr
), "r" (
whîe
)

122 
v
 = *
CSR_PCICMD
;

123 i‡(
v
 & 
PCICMD_ABORT
) {

124 *
CSR_PCICMD
 = 
v
 & (0xffff|
PCICMD_ABORT
);

128  
PCIBIOS_SUCCESSFUL
;

129 
	}
}

131 
pci_›s
 
	gdc21285_›s
 = {

132 .
ªad
 = 
dc21285_ªad_c⁄fig
,

133 .
	gwrôe
 = 
dc21285_wrôe_c⁄fig
,

136 
timî_li°
 
	g£º_timî
;

137 
timî_li°
 
	g≥º_timî
;

139 
	$dc21285_íabÀ_îr‹
(
__d©a
)

141 
__d©a
) {

142 
IRQ_PCI_SERR
:

143 
	`dñ_timî
(&
£º_timî
);

146 
IRQ_PCI_PERR
:

147 
	`dñ_timî
(&
≥º_timî
);

151 
	`íabÀ_úq
(
__d©a
);

152 
	}
}

157 
úqªtu∫_t
 
	$dc21285_ab‹t_úq
(
úq
, *
dev_id
)

159 
cmd
;

160 
°©us
;

162 
cmd
 = *
CSR_PCICMD
;

163 
°©us
 = 
cmd
 >> 16;

164 
cmd
 = cmd & 0xffff;

166 i‡(
°©us
 & 
PCI_STATUS_REC_MASTER_ABORT
) {

167 
	`¥ötk
(
KERN_DEBUG
 "PCI: masterábort,Öc=0x%08lx\n",

168 
	`ö°ru˘i⁄_poöãr
(
	`gë_úq_ªgs
()));

169 
cmd
 |
PCI_STATUS_REC_MASTER_ABORT
 << 16;

172 i‡(
°©us
 & 
PCI_STATUS_REC_TARGET_ABORT
) {

173 
	`¥ötk
(
KERN_DEBUG
 "PCI:Åargetábort: ");

174 
	`pcibios_ªp‹t_°©us
(
PCI_STATUS_REC_MASTER_ABORT
 |

175 
PCI_STATUS_SIG_TARGET_ABORT
 |

176 
PCI_STATUS_REC_TARGET_ABORT
, 1);

177 
	`¥ötk
("\n");

179 
cmd
 |
PCI_STATUS_REC_TARGET_ABORT
 << 16;

182 *
CSR_PCICMD
 = 
cmd
;

184  
IRQ_HANDLED
;

185 
	}
}

187 
úqªtu∫_t
 
	$dc21285_£º_úq
(
úq
, *
dev_id
)

189 
timî_li°
 *
timî
 = 
dev_id
;

190 
˙é
;

192 
	`¥ötk
(
KERN_DEBUG
 "PCI: systemÉrrorÑeceived: ");

193 
	`pcibios_ªp‹t_°©us
(
PCI_STATUS_SIG_SYSTEM_ERROR
, 1);

194 
	`¥ötk
("\n");

196 
˙é
 = *
CSR_SA110_CNTL
 & 0xffffdf07;

197 *
CSR_SA110_CNTL
 = 
˙é
 | 
SA110_CNTL_RXSERR
;

202 
	`dißbÀ_úq
(
úq
);

203 
timî
->
expúes
 = 
jiffõs
 + 
HZ
;

204 
	`add_timî
(
timî
);

206  
IRQ_HANDLED
;

207 
	}
}

209 
úqªtu∫_t
 
	$dc21285_disˇrd_úq
(
úq
, *
dev_id
)

211 
	`¥ötk
(
KERN_DEBUG
 "PCI: discardÅimerÉxpired\n");

212 *
CSR_SA110_CNTL
 &= 0xffffde07;

214  
IRQ_HANDLED
;

215 
	}
}

217 
úqªtu∫_t
 
	$dc21285_d∑rôy_úq
(
úq
, *
dev_id
)

219 
cmd
;

221 
	`¥ötk
(
KERN_DEBUG
 "PCI: dataÖarityÉrror detected: ");

222 
	`pcibios_ªp‹t_°©us
(
PCI_STATUS_PARITY
 | 
PCI_STATUS_DETECTED_PARITY
, 1);

223 
	`¥ötk
("\n");

225 
cmd
 = *
CSR_PCICMD
 & 0xffff;

226 *
CSR_PCICMD
 = 
cmd
 | 1 << 24;

228  
IRQ_HANDLED
;

229 
	}
}

231 
úqªtu∫_t
 
	$dc21285_∑rôy_úq
(
úq
, *
dev_id
)

233 
timî_li°
 *
timî
 = 
dev_id
;

234 
cmd
;

236 
	`¥ötk
(
KERN_DEBUG
 "PCI:ÖarityÉrror detected: ");

237 
	`pcibios_ªp‹t_°©us
(
PCI_STATUS_PARITY
 | 
PCI_STATUS_DETECTED_PARITY
, 1);

238 
	`¥ötk
("\n");

240 
cmd
 = *
CSR_PCICMD
 & 0xffff;

241 *
CSR_PCICMD
 = 
cmd
 | 1 << 31;

246 
	`dißbÀ_úq
(
úq
);

247 
timî
->
expúes
 = 
jiffõs
 + 
HZ
;

248 
	`add_timî
(
timî
);

250  
IRQ_HANDLED
;

251 
	}
}

253 
__öô
 
	$dc21285_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

255 
ªsour˚
 *
ªs
;

257 i‡(
ƒ
 || !
	`foŸbridge_c‚_mode
())

260 
ªs
 = 
	`kzÆloc
((
ªsour˚
Ë* 2, 
GFP_KERNEL
);

261 i‡(!
ªs
) {

262 
	`¥ötk
("out of memory forÑoot busÑesources");

266 
ªs
[0].
Êags
 = 
IORESOURCE_MEM
;

267 
ªs
[0].
«me
 = "FootbridgeÇon-prefetch";

268 
ªs
[1].
Êags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_PREFETCH
;

269 
ªs
[1].
«me
 = "FootbridgeÖrefetch";

271 
	`Æloˇã_ªsour˚
(&
iomem_ªsour˚
, &
ªs
[1], 0x20000000,

272 0xa0000000, 0xffffffff, 0x20000000, 
NULL
, NULL);

273 
	`Æloˇã_ªsour˚
(&
iomem_ªsour˚
, &
ªs
[0], 0x40000000,

274 0x80000000, 0xffffffff, 0x40000000, 
NULL
, NULL);

276 
sys
->
ªsour˚
[0] = &
i›‹t_ªsour˚
;

277 
sys
->
ªsour˚
[1] = &
ªs
[0];

278 
sys
->
ªsour˚
[2] = &
ªs
[1];

279 
sys
->
mem_off£t
 = 
DC21285_PCI_MEM
;

282 
	}
}

284 
pci_bus
 * 
__öô
 
	$dc21285_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sys
)

286  
	`pci_sˇn_bus
(0, &
dc21285_›s
, 
sys
);

287 
	}
}

289 
__öô
 
	$dc21285_¥eöô
()

291 
mem_size
, 
mem_mask
;

292 
c‚_mode
;

294 
mem_size
 = ()
high_mem‹y
 - 
PAGE_OFFSET
;

295 
mem_mask
 = 0x00100000; mem_mask < 0x10000000; mem_mask <<= 1)

296 i‡(
mem_mask
 >
mem_size
)

303 *
CSR_SDRAMBASEMASK
 = (
mem_mask
 - 1) & 0x0ffc0000;

304 *
CSR_SDRAMBASEOFFSET
 = 0;

305 *
CSR_ROMBASEMASK
 = 0x80000000;

306 *
CSR_CSRBASEMASK
 = 0;

307 *
CSR_CSRBASEOFFSET
 = 0;

308 *
CSR_PCIADDR_EXTN
 = 0;

310 
c‚_mode
 = 
	`__foŸbridge_c‚_mode
();

312 
	`¥ötk
(
KERN_INFO
 "PCI: DC21285 footbridge,Ñevision %02lX, in "

313 "%†mode\n", *
CSR_CLASSREV
 & 0xff, 
c‚_mode
 ?

316 i‡(
	`foŸbridge_c‚_mode
()) {

321 *
CSR_SA110_CNTL
 = (*CSR_SA110_CNTL & 0xffffde07) |

322 
SA110_CNTL_RXSERR
;

323 *
CSR_PCICMD
 = (*CSR_PCICMD & 0xffffË| 
PCICMD_ERROR_BITS
;

326 
	`öô_timî
(&
£º_timî
);

327 
	`öô_timî
(&
≥º_timî
);

329 
£º_timî
.
d©a
 = 
IRQ_PCI_SERR
;

330 
£º_timî
.
fun˘i⁄
 = 
dc21285_íabÀ_îr‹
;

331 
≥º_timî
.
d©a
 = 
IRQ_PCI_PERR
;

332 
≥º_timî
.
fun˘i⁄
 = 
dc21285_íabÀ_îr‹
;

337 
	`ªque°_úq
(
IRQ_PCI_SERR
, 
dc21285_£º_úq
, 
IRQF_DISABLED
,

338 "PCI sy°emÉº‹", &
£º_timî
);

339 
	`ªque°_úq
(
IRQ_PCI_PERR
, 
dc21285_∑rôy_úq
, 
IRQF_DISABLED
,

340 "PCIÖ¨ôyÉº‹", &
≥º_timî
);

341 
	`ªque°_úq
(
IRQ_PCI_ABORT
, 
dc21285_ab‹t_úq
, 
IRQF_DISABLED
,

342 "PCIáb‹t", 
NULL
);

343 
	`ªque°_úq
(
IRQ_DISCARD_TIMER
, 
dc21285_disˇrd_úq
, 
IRQF_DISABLED
,

344 "DisˇrdÅimî", 
NULL
);

345 
	`ªque°_úq
(
IRQ_PCI_DPERR
, 
dc21285_d∑rôy_úq
, 
IRQF_DISABLED
,

346 "PCI d©®∑rôy", 
NULL
);

348 i‡(
c‚_mode
) {

349 
ªsour˚
 
c§io
;

351 
c§io
.
Êags
 = 
IORESOURCE_IO
;

352 
c§io
.
«me
 = "Footbridge";

354 
	`Æloˇã_ªsour˚
(&
i›‹t_ªsour˚
, &
c§io
, 128,

355 0xff00, 0xffff, 128, 
NULL
, NULL);

363 *
CSR_PCICSRBASE
 = 0xf4000000;

364 *
CSR_PCICSRIOBASE
 = 
c§io
.
°¨t
;

365 *
CSR_PCISDRAMBASE
 = 
	`__vút_to_bus
(
PAGE_OFFSET
);

366 *
CSR_PCIROMBASE
 = 0;

367 *
CSR_PCICMD
 = 
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_MASTER
 |

368 
PCI_COMMAND_INVALIDATE
 | 
PCICMD_ERROR_BITS
;

369 } i‡(
	`foŸbridge_c‚_mode
() != 0) {

376 
	`∑nic
("PCI:Åhis kernel is compiled for central "

379 
	}
}

381 
__öô
 
	$dc21285_po°öô
()

383 
	`ªgi°î_iß_p‹ts
(
DC21285_PCI_MEM
, 
DC21285_PCI_IO
, 0);

384 
	}
}

	@arch/arm/mach-footbridge/dma.c

13 
	~<löux/öô.h
>

15 
	~<asm/dma.h
>

16 
	~<asm/io.h
>

17 
	~<asm/sˇâîli°.h
>

19 
	~<asm/mach/dma.h
>

20 
	~<asm/h¨dw¨e/dec21285.h
>

23 
	$fb_dma_ªque°
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

25  -
EINVAL
;

26 
	}
}

28 
	$fb_dma_íabÀ
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

30 
	}
}

32 
	$fb_dma_dißbÀ
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

34 
	}
}

36 
dma_›s
 
	gfb_dma_›s
 = {

37 .
ty≥
 = "fb",

38 .
	gªque°
 = 
fb_dma_ªque°
,

39 .
	gíabÀ
 = 
fb_dma_íabÀ
,

40 .
	gdißbÀ
 = 
fb_dma_dißbÀ
,

44 
__öô
 
	$¨ch_dma_öô
(
dma_t
 *
dma
)

47 
dma
[
	`_DC21285_DMA
(0)].
d_›s
 = &
fb_dma_›s
;

48 
dma
[
	`_DC21285_DMA
(1)].
d_›s
 = &
fb_dma_›s
;

50 #ifde‡
CONFIG_ISA_DMA


51 i‡(
	`foŸbridge_c‚_mode
())

52 
	`iß_öô_dma
(
dma
 + 
	`_ISA_DMA
(0));

54 
	}
}

	@arch/arm/mach-footbridge/ebsa285-leds.c

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/•ölock.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/Àds.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/sy°em.h
>

29 
	#LED_STATE_ENABLED
 1

	)

30 
	#LED_STATE_CLAIMED
 2

	)

31 
	gÀd_°©e
;

32 
	ghw_Àd_°©e
;

34 
DEFINE_SPINLOCK
(
Àds_lock
);

36 
	$ebß285_Àds_evít
(
Àd_evít_t
 
evt
)

38 
Êags
;

40 
	`•ö_lock_úqßve
(&
Àds_lock
, 
Êags
);

42 
evt
) {

43 
Àd_°¨t
:

44 
hw_Àd_°©e
 = 
XBUS_LED_RED
 | 
XBUS_LED_GREEN
;

45 #i‚de‡
CONFIG_LEDS_CPU


46 
hw_Àd_°©e
 |
XBUS_LED_AMBER
;

48 
Àd_°©e
 |
LED_STATE_ENABLED
;

51 
Àd_°›
:

52 
Àd_°©e
 &~
LED_STATE_ENABLED
;

55 
Àd_˛aim
:

56 
Àd_°©e
 |
LED_STATE_CLAIMED
;

57 
hw_Àd_°©e
 = 
XBUS_LED_RED
 | 
XBUS_LED_GREEN
 | 
XBUS_LED_AMBER
;

60 
Àd_ªÀa£
:

61 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

62 
hw_Àd_°©e
 = 
XBUS_LED_RED
 | 
XBUS_LED_GREEN
 | 
XBUS_LED_AMBER
;

65 #ifde‡
CONFIG_LEDS_TIMER


66 
Àd_timî
:

67 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

68 
hw_Àd_°©e
 ^
XBUS_LED_GREEN
;

72 #ifde‡
CONFIG_LEDS_CPU


73 
Àd_idÀ_°¨t
:

74 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

75 
hw_Àd_°©e
 |
XBUS_LED_AMBER
;

78 
Àd_idÀ_íd
:

79 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

80 
hw_Àd_°©e
 &~
XBUS_LED_AMBER
;

84 
Àd_hÆãd
:

85 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

86 
hw_Àd_°©e
 &~
XBUS_LED_RED
;

89 
Àd_gªí_⁄
:

90 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

91 
hw_Àd_°©e
 &~
XBUS_LED_GREEN
;

94 
Àd_gªí_off
:

95 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

96 
hw_Àd_°©e
 |
XBUS_LED_GREEN
;

99 
Àd_ambî_⁄
:

100 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

101 
hw_Àd_°©e
 &~
XBUS_LED_AMBER
;

104 
Àd_ambî_off
:

105 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

106 
hw_Àd_°©e
 |
XBUS_LED_AMBER
;

109 
Àd_ªd_⁄
:

110 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

111 
hw_Àd_°©e
 &~
XBUS_LED_RED
;

114 
Àd_ªd_off
:

115 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

116 
hw_Àd_°©e
 |
XBUS_LED_RED
;

123 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

124 *
XBUS_LEDS
 = 
hw_Àd_°©e
;

126 
	`•ö_u∆ock_úqª°‹e
(&
Àds_lock
, 
Êags
);

127 
	}
}

129 
__öô
 
	$Àds_öô
()

131 i‡(
	`machöe_is_ebß285
(Ë|| 
	`machöe_is_co285
())

132 
Àds_evít
 = 
ebß285_Àds_evít
;

134 
	`Àds_evít
(
Àd_°¨t
);

137 
	}
}

139 
__öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-footbridge/ebsa285-pci.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/pci.h
>

10 
	~<löux/öô.h
>

12 
	~<asm/úq.h
>

13 
	~<asm/mach/pci.h
>

14 
	~<asm/mach-ty≥s.h
>

16 
	gúqm≠_ebß285
[] 
	g__öôd©a
 = { 
IRQ_IN3
, 
IRQ_IN1
, 
IRQ_IN0
, 
IRQ_PCI
 };

18 
__öô
 
	$ebß285_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

20 i‡(
dev
->
víd‹
 =
PCI_VENDOR_ID_CONTAQ
 &&

21 
dev
->
devi˚
 =
PCI_DEVICE_ID_CONTAQ_82C693
)

22 
	`PCI_FUNC
(
dev
->
dev‚
)) {

28  
úqm≠_ebß285
[(
¶Ÿ
 + 
pö
) & 3];

29 
	}
}

31 
hw_pci
 
ebß285_pci
 
	g__öôd©a
 = {

32 .
swizzÀ
 = 
pci_°d_swizzÀ
,

33 .
	gm≠_úq
 = 
ebß285_m≠_úq
,

34 .
	gƒ_c⁄åﬁÀrs
 = 1,

35 .
	g£tup
 = 
dc21285_£tup
,

36 .
	gsˇn
 = 
dc21285_sˇn_bus
,

37 .
	g¥eöô
 = 
dc21285_¥eöô
,

38 .
	gpo°öô
 = 
dc21285_po°öô
,

41 
__öô
 
	$ebß285_öô_pci
()

43 i‡(
	`machöe_is_ebß285
())

44 
	`pci_comm⁄_öô
(&
ebß285_pci
);

46 
	}
}

48 
subsys_öôˇŒ
(
ebß285_öô_pci
);

	@arch/arm/mach-footbridge/ebsa285.c

6 
	~<löux/öô.h
>

8 
	~<asm/h¨dw¨e/dec21285.h
>

9 
	~<asm/mach-ty≥s.h
>

11 
	~<asm/mach/¨ch.h
>

13 
	~"comm⁄.h
"

15 
MACHINE_START
(
EBSA285
, "EBSA285")

17 .
	gphys_io
 = 
DC21285_ARMCSR_BASE
,

18 .
	gio_pg_off°
 = ((0xfe000000) >> 18) & 0xfffc,

19 .
	gboŸ_∑øms
 = 0x00000100,

20 .
	gvideo_°¨t
 = 0x000a0000,

21 .
	gvideo_íd
 = 0x000bffff,

22 .
	gm≠_io
 = 
foŸbridge_m≠_io
,

23 .
	göô_úq
 = 
foŸbridge_öô_úq
,

24 .
	gtimî
 = &
foŸbridge_timî
,

25 
	gMACHINE_END


	@arch/arm/mach-footbridge/isa-irq.c

17 
	~<löux/i›‹t.h
>

18 
	~<löux/öãºu±.h
>

19 
	~<löux/li°.h
>

20 
	~<löux/öô.h
>

22 
	~<asm/mach/úq.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/h¨dw¨e/dec21285.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/io.h
>

28 
	~<asm/mach-ty≥s.h
>

30 
	$iß_mask_pic_lo_úq
(
úq
)

32 
mask
 = 1 << (
úq
 & 7);

34 
	`outb
(
	`öb
(
PIC_MASK_LO
Ë| 
mask
, PIC_MASK_LO);

35 
	}
}

37 
	$iß_ack_pic_lo_úq
(
úq
)

39 
mask
 = 1 << (
úq
 & 7);

41 
	`outb
(
	`öb
(
PIC_MASK_LO
Ë| 
mask
, PIC_MASK_LO);

42 
	`outb
(0x20, 
PIC_LO
);

43 
	}
}

45 
	$iß_unmask_pic_lo_úq
(
úq
)

47 
mask
 = 1 << (
úq
 & 7);

49 
	`outb
(
	`öb
(
PIC_MASK_LO
Ë& ~
mask
, PIC_MASK_LO);

50 
	}
}

52 
úq_chù
 
	giß_lo_chù
 = {

53 .
ack
 = 
iß_ack_pic_lo_úq
,

54 .
	gmask
 = 
iß_mask_pic_lo_úq
,

55 .
	gunmask
 = 
iß_unmask_pic_lo_úq
,

58 
	$iß_mask_pic_hi_úq
(
úq
)

60 
mask
 = 1 << (
úq
 & 7);

62 
	`outb
(
	`öb
(
PIC_MASK_HI
Ë| 
mask
, PIC_MASK_HI);

63 
	}
}

65 
	$iß_ack_pic_hi_úq
(
úq
)

67 
mask
 = 1 << (
úq
 & 7);

69 
	`outb
(
	`öb
(
PIC_MASK_HI
Ë| 
mask
, PIC_MASK_HI);

70 
	`outb
(0x62, 
PIC_LO
);

71 
	`outb
(0x20, 
PIC_HI
);

72 
	}
}

74 
	$iß_unmask_pic_hi_úq
(
úq
)

76 
mask
 = 1 << (
úq
 & 7);

78 
	`outb
(
	`öb
(
PIC_MASK_HI
Ë& ~
mask
, PIC_MASK_HI);

79 
	}
}

81 
úq_chù
 
	giß_hi_chù
 = {

82 .
ack
 = 
iß_ack_pic_hi_úq
,

83 .
	gmask
 = 
iß_mask_pic_hi_úq
,

84 .
	gunmask
 = 
iß_unmask_pic_hi_úq
,

88 
	$iß_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

90 
iß_úq
 = *(*)
PCIIACK_BASE
;

92 i‡(
iß_úq
 < 
	`_ISA_IRQ
(0) || isa_irq >= _ISA_IRQ(16)) {

93 
	`do_bad_IRQ
(
iß_úq
, 
desc
);

97 
desc
 = 
úq_desc
 + 
iß_úq
;

98 
	`desc_h™dÀ_úq
(
iß_úq
, 
desc
);

99 
	}
}

101 
úqa˘i⁄
 
	gúq_ˇsˇde
 = {

102 .
h™dÀr
 = 
no_a˘i⁄
,

103 .
	g«me
 = "cascade",

106 
ªsour˚
 
	gpic1_ªsour˚
 = {

107 .
«me
 = "pic1",

108 .
	g°¨t
 = 0x20,

109 .
	gíd
 = 0x3f,

112 
ªsour˚
 
	gpic2_ªsour˚
 = {

113 .
«me
 = "pic2",

114 .
	g°¨t
 = 0xa0,

115 .
	gíd
 = 0xbf,

118 
__öô
 
	$iß_öô_úq
(
ho°_úq
)

120 
úq
;

127 
	`outb
(0x11, 
PIC_LO
);

128 
	`outb
(
	`_ISA_IRQ
(0), 
PIC_MASK_LO
);

129 
	`outb
(0x04, 
PIC_MASK_LO
);

130 
	`outb
(0x01, 
PIC_MASK_LO
);

131 
	`outb
(0xf5, 
PIC_MASK_LO
);

133 
	`outb
(0x11, 
PIC_HI
);

134 
	`outb
(
	`_ISA_IRQ
(8), 
PIC_MASK_HI
);

135 
	`outb
(0x02, 
PIC_MASK_HI
);

136 
	`outb
(0x01, 
PIC_MASK_HI
);

137 
	`outb
(0xÁ, 
PIC_MASK_HI
);

139 
	`outb
(0x0b, 
PIC_LO
);

140 
	`outb
(0x0b, 
PIC_HI
);

142 i‡(
	`öb
(
PIC_MASK_LO
Ë=0xf5 && inb(
PIC_MASK_HI
) == 0xfa) {

143 
	`outb
(0xff, 
PIC_MASK_LO
);

144 
	`outb
(0xff, 
PIC_MASK_HI
);

146 
	`¥ötk
(
KERN_INFO
 "IRQ: ISA PICÇot found\n");

147 
ho°_úq
 = ()-1;

150 i‡(
ho°_úq
 != ()-1) {

151 
úq
 = 
	`_ISA_IRQ
(0); irq < _ISA_IRQ(8); irq++) {

152 
	`£t_úq_chù
(
úq
, &
iß_lo_chù
);

153 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

154 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

157 
úq
 = 
	`_ISA_IRQ
(8); irq < _ISA_IRQ(16); irq++) {

158 
	`£t_úq_chù
(
úq
, &
iß_hi_chù
);

159 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

160 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

163 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
pic1_ªsour˚
);

164 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
pic2_ªsour˚
);

165 
	`£tup_úq
(
IRQ_ISA_CASCADE
, &
úq_ˇsˇde
);

167 
	`£t_úq_chaöed_h™dÀr
(
ho°_úq
, 
iß_úq_h™dÀr
);

175 i‡(
	`machöe_is_√twödî
())

176 
	`£t_úq_Êags
(
	`_ISA_IRQ
(11), 
IRQF_VALID
 |

177 
IRQF_PROBE
 | 
IRQF_NOAUTOEN
);

179 
	}
}

	@arch/arm/mach-footbridge/isa-timer.c

7 
	~<löux/öô.h
>

8 
	~<löux/öãºu±.h
>

9 
	~<löux/úq.h
>

11 
	~<asm/io.h
>

12 
	~<asm/úq.h
>

14 
	~<asm/mach/time.h
>

16 
	~"comm⁄.h
"

21 
	#mSEC_10_‰om_14
 ((14318180 + 100Ë/ 200)

	)

23 
	$iß_gëtimeoff£t
()

25 
cou¡
;

27 
cou¡_p
 = (
mSEC_10_‰om_14
/6);

28 
jiffõs_p
 = 0;

33 
jiffõs_t
;

36 
	`outb_p
(0x00, 0x43);

38 
cou¡
 = 
	`öb_p
(0x40);

44 
jiffõs_t
 = 
jiffõs
;

46 
cou¡
 |
	`öb_p
(0x40) << 8;

51 i‡((
jiffõs_t
 =
jiffõs_p
Ë&& (
cou¡
 > 
cou¡_p
))

52 
cou¡
 -(
mSEC_10_‰om_14
/6);

54 
jiffõs_p
 = 
jiffõs_t
;

56 
cou¡_p
 = 
cou¡
;

58 
cou¡
 = (((
mSEC_10_‰om_14
/6)-1Ë- cou¡Ë* (
tick_n£c
 / 1000);

59 
cou¡
 = (cou¡ + (
mSEC_10_‰om_14
/6)/2) / (mSEC_10_from_14/6);

61  
cou¡
;

62 
	}
}

64 
úqªtu∫_t


65 
	$iß_timî_öãºu±
(
úq
, *
dev_id
)

67 
	`wrôe_£qlock
(&
xtime_lock
);

68 
	`timî_tick
();

69 
	`wrôe_£qu∆ock
(&
xtime_lock
);

70  
IRQ_HANDLED
;

71 
	}
}

73 
úqa˘i⁄
 
	giß_timî_úq
 = {

74 .
«me
 = "ISAÅimerÅick",

75 .
	gh™dÀr
 = 
iß_timî_öãºu±
,

76 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

79 
__öô
 
	$iß_timî_öô
()

81 
	`iß_πc_öô
();

85 
	`outb
(0x34, 0x43);

86 
	`outb
((
mSEC_10_‰om_14
/6) & 0xFF, 0x40);

87 
	`outb
((
mSEC_10_‰om_14
/6) >> 8, 0x40);

89 
	`£tup_úq
(
IRQ_ISA_TIMER
, &
iß_timî_úq
);

90 
	}
}

92 
sys_timî
 
	giß_timî
 = {

93 .
öô
 = 
iß_timî_öô
,

94 .
	goff£t
 = 
iß_gëtimeoff£t
,

	@arch/arm/mach-footbridge/isa.c

10 
	~<löux/öô.h
>

11 
	~<löux/£rül_8250.h
>

13 
	~<asm/úq.h
>

15 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

17 .
ioba£
 = 0x3f8,

18 .
	gúq
 = 
IRQ_ISA_UART
,

19 .
	gu¨t˛k
 = 1843200,

20 .
	gªgshi·
 = 0,

21 .
	giŸy≥
 = 
UPIO_PORT
,

22 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

25 .
	gioba£
 = 0x2f8,

26 .
	gúq
 = 
IRQ_ISA_UART2
,

27 .
	gu¨t˛k
 = 1843200,

28 .
	gªgshi·
 = 0,

29 .
	giŸy≥
 = 
UPIO_PORT
,

30 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

35 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

36 .
«me
 = "serial8250",

37 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

38 .
	gdev
 = {

39 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

43 
__öô
 
	$foŸbridge_iß_öô
()

45  
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

46 
	}
}

48 
¨ch_öôˇŒ
(
foŸbridge_iß_öô
);

	@arch/arm/mach-footbridge/netwinder-hw.c

8 
	~<löux/moduÀ.h
>

9 
	~<löux/i›‹t.h
>

10 
	~<löux/kî√l.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/öô.h
>

14 
	~<asm/h¨dw¨e/dec21285.h
>

15 
	~<asm/io.h
>

16 
	~<asm/Àds.h
>

17 
	~<asm/mach-ty≥s.h
>

18 
	~<asm/£tup.h
>

20 
	~<asm/mach/¨ch.h
>

22 
	~"comm⁄.h
"

24 
	#IRDA_IO_BASE
 0x180

	)

25 
	#GP1_IO_BASE
 0x338

	)

26 
	#GP2_IO_BASE
 0x33a

	)

29 #ifde‡
CONFIG_LEDS


30 
	#DEFAULT_LEDS
 0

	)

32 
	#DEFAULT_LEDS
 
GPIO_GREEN_LED


	)

38 
ölöe
 
	$wb977_›í
()

40 
	`outb
(0x87, 0x370);

41 
	`outb
(0x87, 0x370);

42 
	}
}

44 
ölöe
 
	$wb977_˛o£
()

46 
	`outb
(0xaa, 0x370);

47 
	}
}

49 
ölöe
 
	$wb977_wb
(
ªg
, 
vÆ
)

51 
	`outb
(
ªg
, 0x370);

52 
	`outb
(
vÆ
, 0x371);

53 
	}
}

55 
ölöe
 
	$wb977_ww
(
ªg
, 
vÆ
)

57 
	`outb
(
ªg
, 0x370);

58 
	`outb
(
vÆ
 >> 8, 0x371);

59 
	`outb
(
ªg
 + 1, 0x370);

60 
	`outb
(
vÆ
 & 255, 0x371);

61 
	}
}

63 
	#wb977_devi˚_£À˘
(
dev
Ë
	`wb977_wb
(0x07, dev)

	)

64 
	#wb977_devi˚_dißbÀ
(Ë
	`wb977_wb
(0x30, 0x00)

	)

65 
	#wb977_devi˚_íabÀ
(Ë
	`wb977_wb
(0x30, 0x01)

	)

70 
DEFINE_SPINLOCK
(
gpio_lock
);

72 
	gcuºít_gpio_›
;

73 
	gcuºít_gpio_io
;

74 
	gcuºít_˝ld
;

76 
	$gpio_modify_›
(
mask
, 
£t
)

78 
√w_gpio
, 
ch™ged
;

80 
√w_gpio
 = (
cuºít_gpio_›
 & ~
mask
Ë| 
£t
;

81 
ch™ged
 = 
√w_gpio
 ^ 
cuºít_gpio_›
;

82 
cuºít_gpio_›
 = 
√w_gpio
;

84 i‡(
ch™ged
 & 0xff)

85 
	`outb
(
√w_gpio
, 
GP1_IO_BASE
);

86 i‡(
ch™ged
 & 0xff00)

87 
	`outb
(
√w_gpio
 >> 8, 
GP2_IO_BASE
);

88 
	}
}

90 
ölöe
 
	$__gpio_modify_io
(
mask
, 
ö
)

92 
√w_gpio
, 
ch™ged
;

93 
p‹t
;

95 
√w_gpio
 = (
cuºít_gpio_io
 & ~
mask
Ë| 
ö
;

96 
ch™ged
 = 
√w_gpio
 ^ 
cuºít_gpio_io
;

97 
cuºít_gpio_io
 = 
√w_gpio
;

99 
ch™ged
 >>= 1;

100 
√w_gpio
 >>= 1;

102 
	`wb977_devi˚_£À˘
(7);

104 
p‹t
 = 0xe1; 
ch™ged
 &&Öort < 0xe8; changed >>= 1) {

105 
	`wb977_wb
(
p‹t
, 
√w_gpio
 & 1);

107 
p‹t
 += 1;

108 
√w_gpio
 >>= 1;

111 
	`wb977_devi˚_£À˘
(8);

113 
p‹t
 = 0xe8; 
ch™ged
 &&Öort < 0xec; changed >>= 1) {

114 
	`wb977_wb
(
p‹t
, 
√w_gpio
 & 1);

116 
p‹t
 += 1;

117 
√w_gpio
 >>= 1;

119 
	}
}

121 
	$gpio_modify_io
(
mask
, 
ö
)

124 
	`wb977_›í
();

126 
	`__gpio_modify_io
(
mask
, 
ö
);

129 
	`wb977_˛o£
();

130 
	}
}

132 
	$gpio_ªad
()

134  
	`öb
(
GP1_IO_BASE
Ë| inb(
GP2_IO_BASE
) << 8;

135 
	}
}

140 
ölöe
 
	$wb977_öô_globÆ
()

145 
	`wb977_wb
(0x26, 0x40);

150 
	`wb977_wb
(0x22, 0xfe);

155 
	`wb977_wb
(0x2a, 0xc1);

160 
	`wb977_wb
(0x2b, 0x6b);

165 
	`wb977_wb
(0x2c, 0x55);

166 
	}
}

171 
ölöe
 
	$wb977_öô_¥öãr
()

173 
	`wb977_devi˚_£À˘
(1);

178 
	`wb977_wb
(0xf0, 0x01);

179 
	}
}

184 
ölöe
 
	$wb977_öô_keybﬂrd
()

186 
	`wb977_devi˚_£À˘
(5);

191 
	`wb977_ww
(0x60, 0x0060);

192 
	`wb977_ww
(0x62, 0x0064);

197 
	`wb977_wb
(0x70, 1);

198 
	`wb977_wb
(0x71, 0x02);

203 
	`wb977_wb
(0x72, 5);

204 
	`wb977_wb
(0x73, 0x02);

209 
	`wb977_wb
(0xf0, 0x40);

214 
	`wb977_devi˚_íabÀ
();

215 
	}
}

220 
ölöe
 
	$wb977_öô_úda
()

222 
	`wb977_devi˚_£À˘
(6);

227 
	`wb977_ww
(0x60, 
IRDA_IO_BASE
);

232 
	`wb977_wb
(0x70, 6);

233 
	`wb977_wb
(0x71, 0x02);

238 
	`wb977_wb
(0x74, 0x00);

243 
	`wb977_wb
(0x75, 0x04);

248 
	`wb977_wb
(0xf0, 0x03);

253 
	`wb977_devi˚_íabÀ
();

254 
	}
}

259 
ölöe
 
	$wb977_öô_gpio
()

261 
Êags
;

266 
cuºít_gpio_io
 = -1;

267 
	`__gpio_modify_io
(-1, 
GPIO_DONE
 | 
GPIO_WDTIMER
);

269 
	`wb977_devi˚_£À˘
(7);

274 
	`wb977_ww
(0x60, 
GP1_IO_BASE
);

275 
	`wb977_ww
(0x62, 0);

276 
	`wb977_ww
(0x64, 0);

281 
	`wb977_wb
(0x70, 10);

282 
	`wb977_wb
(0x71, 0x02);

287 
	`wb977_wb
(0xe0, 0x19);

292 
	`wb977_devi˚_íabÀ
();

294 
	`wb977_devi˚_£À˘
(8);

299 
	`wb977_ww
(0x60, 
GP2_IO_BASE
);

305 
	`wb977_wb
(0xf2, 0x00);

310 
	`wb977_wb
(0xf3, 0x00);

315 
	`wb977_wb
(0xf4, 0x00);

320 
	`wb977_devi˚_íabÀ
();

325 
	`•ö_lock_úqßve
(&
gpio_lock
, 
Êags
);

326 
	`gpio_modify_›
(-1, 
GPIO_RED_LED
 | 
GPIO_FAN
);

327 
	`•ö_u∆ock_úqª°‹e
(&
gpio_lock
, 
Êags
);

328 
	}
}

333 
__öô
 
	$wb977_öô
()

335 
	`ªque°_ªgi⁄
(0x370, 2, "W83977AF configuration");

340 
	`wb977_›í
();

345 
	`wb977_öô_globÆ
();

351 
	`wb977_öô_¥öãr
();

352 
	`wb977_öô_keybﬂrd
();

353 
	`wb977_öô_úda
();

354 
	`wb977_öô_gpio
();

359 
	`wb977_˛o£
();

360 
	}
}

362 
	$˝ld_modify
(
mask
, 
£t
)

364 
msk
;

366 
cuºít_˝ld
 = (cuºít_˝ld & ~
mask
Ë| 
£t
;

368 
	`gpio_modify_io
(
GPIO_DATA
 | 
GPIO_IOCLK
 | 
GPIO_IOLOAD
, 0);

369 
	`gpio_modify_›
(
GPIO_IOLOAD
, 0);

371 
msk
 = 8; msk; msk >>= 1) {

372 
bô
 = 
cuºít_˝ld
 & 
msk
;

374 
	`gpio_modify_›
(
GPIO_DATA
 | 
GPIO_IOCLK
, 
bô
 ? GPIO_DATA : 0);

375 
	`gpio_modify_›
(
GPIO_IOCLK
, GPIO_IOCLK);

378 
	`gpio_modify_›
(
GPIO_IOCLK
|
GPIO_DATA
, 0);

379 
	`gpio_modify_›
(
GPIO_IOLOAD
|
GPIO_DSCLK
, GPIO_IOLOAD|GPIO_DSCLK);

380 
	`gpio_modify_›
(
GPIO_IOLOAD
, 0);

381 
	}
}

383 
__öô
 
	$˝ld_öô
()

385 
Êags
;

387 
	`•ö_lock_úqßve
(&
gpio_lock
, 
Êags
);

388 
	`˝ld_modify
(-1, 
CPLD_UNMUTE
 | 
CPLD_7111_DISABLE
);

389 
	`•ö_u∆ock_úqª°‹e
(&
gpio_lock
, 
Êags
);

390 
	}
}

392 
	grwa_u∆ock
[] 
	g__öôd©a
 =

397 #i‚de‡
DEBUG


398 
	#d¥ötk
(
x
...)

	)

400 
	#d¥ötk
(
x
...Ë
	`¥ötk
(x)

	)

403 
	#WRITE_RWA
(
r
,
v
Ëdÿ{ 
	`outb
(‘), 0x279); 
	`udñay
(10); outb((v), 0xa79); } 0)

	)

405 
ölöe
 
	$rwa010_u∆ock
()

407 
i
;

409 
	`WRITE_RWA
(2, 2);

410 
	`mdñay
(10);

412 
i
 = 0; i < (
rwa_u∆ock
); i++) {

413 
	`outb
(
rwa_u∆ock
[
i
], 0x279);

414 
	`udñay
(10);

416 
	}
}

418 
ölöe
 
	$rwa010_ªad_idít
()

420 
si
[9];

421 
i
, 
j
;

423 
	`WRITE_RWA
(3, 0);

424 
	`WRITE_RWA
(0, 128);

426 
	`outb
(1, 0x279);

428 
	`mdñay
(1);

430 
	`d¥ötk
("Identifier: ");

431 
i
 = 0; i < 9; i++) {

432 
si
[
i
] = 0;

433 
j
 = 0; j < 8; j++) {

434 
bô
;

435 
	`udñay
(250);

436 
	`öb
(0x203);

437 
	`udñay
(250);

438 
bô
 = 
	`öb
(0x203);

439 
	`d¥ötk
("%02X ", 
bô
);

440 
bô
 = (bit == 0xaa) ? 1 : 0;

441 
si
[
i
] |
bô
 << 
j
;

443 
	`d¥ötk
("(%02XË", 
si
[
i
]);

445 
	`d¥ötk
("\n");

446 
	}
}

448 
ölöe
 
	$rwa010_globÆ_öô
()

450 
	`WRITE_RWA
(6, 2);

452 
	`d¥ötk
("C¨dÇÿ%d\n", 
	`öb
(0x203));

455 
	`WRITE_RWA
(7, 3);

456 
	`WRITE_RWA
(0x30, 0);

459 
	`WRITE_RWA
(7, 4);

460 
	`WRITE_RWA
(0x30, 0);

463 
	`WRITE_RWA
(7, 2);

464 
	`WRITE_RWA
(0x30, 0);

465 
	}
}

467 
ölöe
 
	$rwa010_game_p‹t_öô
()

469 
i
;

471 
	`WRITE_RWA
(7, 5);

473 
	`d¥ötk
("Slider base: ");

474 
	`WRITE_RWA
(0x61, 1);

475 
i
 = 
	`öb
(0x203);

477 
	`WRITE_RWA
(0x60, 2);

478 
	`d¥ötk
("%02X%02X (201)\n", 
	`öb
(0x203), 
i
);

480 
	`WRITE_RWA
(0x30, 1);

481 
	}
}

483 
ölöe
 
	$rwa010_wavóπi°_öô
(
ba£
, 
úq
, 
dma
)

485 
i
;

487 
	`WRITE_RWA
(7, 0);

489 
	`d¥ötk
("WaveArtist base: ");

490 
	`WRITE_RWA
(0x61, 
ba£
 & 255);

491 
i
 = 
	`öb
(0x203);

493 
	`WRITE_RWA
(0x60, 
ba£
 >> 8);

494 
	`d¥ötk
("%02X%02X (%X),", 
	`öb
(0x203), 
i
, 
ba£
);

496 
	`WRITE_RWA
(0x70, 
úq
);

497 
	`d¥ötk
(" irq: %d (%d),", 
	`öb
(0x203), 
úq
);

499 
	`WRITE_RWA
(0x74, 
dma
);

500 
	`d¥ötk
(" dma: %d (%d)\n", 
	`öb
(0x203), 
dma
);

502 
	`WRITE_RWA
(0x30, 1);

503 
	}
}

505 
ölöe
 
	$rwa010_soundbœ°î_öô
(
sb_ba£
, 
Æ_ba£
, 
úq
, 
dma
)

507 
i
;

509 
	`WRITE_RWA
(7, 1);

511 
	`d¥ötk
("SoundBlaster base: ");

512 
	`WRITE_RWA
(0x61, 
sb_ba£
 & 255);

513 
i
 = 
	`öb
(0x203);

515 
	`WRITE_RWA
(0x60, 
sb_ba£
 >> 8);

516 
	`d¥ötk
("%02X%02X (%X),", 
	`öb
(0x203), 
i
, 
sb_ba£
);

518 
	`d¥ötk
(" irq: ");

519 
	`WRITE_RWA
(0x70, 
úq
);

520 
	`d¥ötk
("%d (%d),", 
	`öb
(0x203), 
úq
);

522 
	`d¥ötk
(" 8-bit DMA: ");

523 
	`WRITE_RWA
(0x74, 
dma
);

524 
	`d¥ötk
("%d (%d)\n", 
	`öb
(0x203), 
dma
);

526 
	`d¥ötk
("AdLib base: ");

527 
	`WRITE_RWA
(0x63, 
Æ_ba£
 & 255);

528 
i
 = 
	`öb
(0x203);

530 
	`WRITE_RWA
(0x62, 
Æ_ba£
 >> 8);

531 
	`d¥ötk
("%02X%02X (%X)\n", 
	`öb
(0x203), 
i
, 
Æ_ba£
);

533 
	`WRITE_RWA
(0x30, 1);

534 
	}
}

536 
	$rwa010_soundbœ°î_ª£t
()

538 
i
;

540 
	`outb
(1, 0x226);

541 
	`udñay
(3);

542 
	`outb
(0, 0x226);

544 
i
 = 0; i < 5; i++) {

545 i‡(
	`öb
(0x22e) & 0x80)

547 
	`mdñay
(1);

549 i‡(
i
 == 5)

550 
	`¥ötk
("SoundBlaster: DSPÑeset failed\n");

552 
	`d¥ötk
("SoundBœ°î DSPÑe£t: %02X (AA)\n", 
	`öb
(0x22a));

554 
i
 = 0; i < 5; i++) {

555 i‡((
	`öb
(0x22c) & 0x80) == 0)

557 
	`mdñay
(1);

560 i‡(
i
 == 5)

561 
	`¥ötk
("SoundBlaster: DSPÇotÑeady\n");

563 
	`outb
(0xe1, 0x22c);

565 
	`d¥ötk
("SoundBlaster DSP id: ");

566 
i
 = 
	`öb
(0x22a);

567 
	`udñay
(1);

568 
i
 |
	`öb
(0x22a) << 8;

569 
	`d¥ötk
("%04X\n", 
i
);

571 
i
 = 0; i < 5; i++) {

572 i‡((
	`öb
(0x22c) & 0x80) == 0)

574 
	`mdñay
(1);

577 i‡(
i
 == 5)

578 
	`¥ötk
("SoundBlaster: couldÇotÅurn speaker off\n");

580 
	`outb
(0xd3, 0x22c);

584 
	`outb
(5, 0x38a);

585 
	`outb
(1, 0x38b);

586 
	}
}

588 
__öô
 
	$rwa010_öô
()

590 
	`rwa010_u∆ock
();

591 
	`rwa010_ªad_idít
();

592 
	`rwa010_globÆ_öô
();

593 
	`rwa010_game_p‹t_öô
();

594 
	`rwa010_wavóπi°_öô
(0x250, 3, 7);

595 
	`rwa010_soundbœ°î_öô
(0x220, 0x388, 3, 1);

596 
	`rwa010_soundbœ°î_ª£t
();

597 
	}
}

599 
EXPORT_SYMBOL
(
gpio_lock
);

600 
EXPORT_SYMBOL
(
gpio_modify_›
);

601 
EXPORT_SYMBOL
(
gpio_modify_io
);

602 
EXPORT_SYMBOL
(
˝ld_modify
);

603 
EXPORT_SYMBOL
(
gpio_ªad
);

610 
__öô
 
	$nw_hw_öô
()

612 i‡(
	`machöe_is_√twödî
()) {

613 
Êags
;

615 
	`wb977_öô
();

616 
	`˝ld_öô
();

617 
	`rwa010_öô
();

619 
	`•ö_lock_úqßve
(&
gpio_lock
, 
Êags
);

620 
	`gpio_modify_›
(
GPIO_RED_LED
|
GPIO_GREEN_LED
, 
DEFAULT_LEDS
);

621 
	`•ö_u∆ock_úqª°‹e
(&
gpio_lock
, 
Êags
);

624 
	}
}

626 
__öôˇŒ
(
nw_hw_öô
);

633 
__öô


634 
	$fixup_√twödî
(
machöe_desc
 *
desc
, 
èg
 *
ègs
,

635 **
cmdlöe
, 
memöfo
 *
mi
)

637 #ifde‡
CONFIG_ISAPNP


638 
iß≤p_dißbÀ
;

645 
iß≤p_dißbÀ
 = 1;

647 
	}
}

649 
MACHINE_START
(
NETWINDER
, "Rebel-NetWinder")

651 .
	gphys_io
 = 
DC21285_ARMCSR_BASE
,

652 .
	gio_pg_off°
 = ((0xfe000000) >> 18) & 0xfffc,

653 .
	gboŸ_∑øms
 = 0x00000100,

654 .
	gvideo_°¨t
 = 0x000a0000,

655 .
	gvideo_íd
 = 0x000bffff,

656 .
	gª£rve_Õ0
 = 1,

657 .
	gª£rve_Õ2
 = 1,

658 .
	gfixup
 = 
fixup_√twödî
,

659 .
	gm≠_io
 = 
foŸbridge_m≠_io
,

660 .
	göô_úq
 = 
foŸbridge_öô_úq
,

661 .
	gtimî
 = &
iß_timî
,

662 
	gMACHINE_END


	@arch/arm/mach-footbridge/netwinder-leds.c

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/•ölock.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/Àds.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/sy°em.h
>

29 
	#LED_STATE_ENABLED
 1

	)

30 
	#LED_STATE_CLAIMED
 2

	)

31 
	gÀd_°©e
;

32 
	ghw_Àd_°©e
;

34 
DEFINE_SPINLOCK
(
Àds_lock
);

35 
•ölock_t
 
gpio_lock
;

37 
	$√twödî_Àds_evít
(
Àd_evít_t
 
evt
)

39 
Êags
;

41 
	`•ö_lock_úqßve
(&
Àds_lock
, 
Êags
);

43 
evt
) {

44 
Àd_°¨t
:

45 
Àd_°©e
 |
LED_STATE_ENABLED
;

46 
hw_Àd_°©e
 = 
GPIO_GREEN_LED
;

49 
Àd_°›
:

50 
Àd_°©e
 &~
LED_STATE_ENABLED
;

53 
Àd_˛aim
:

54 
Àd_°©e
 |
LED_STATE_CLAIMED
;

55 
hw_Àd_°©e
 = 0;

58 
Àd_ªÀa£
:

59 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

60 
hw_Àd_°©e
 = 0;

63 #ifde‡
CONFIG_LEDS_TIMER


64 
Àd_timî
:

65 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

66 
hw_Àd_°©e
 ^
GPIO_GREEN_LED
;

70 #ifde‡
CONFIG_LEDS_CPU


71 
Àd_idÀ_°¨t
:

72 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

73 
hw_Àd_°©e
 &~
GPIO_RED_LED
;

76 
Àd_idÀ_íd
:

77 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

78 
hw_Àd_°©e
 |
GPIO_RED_LED
;

82 
Àd_hÆãd
:

83 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

84 
hw_Àd_°©e
 |
GPIO_RED_LED
;

87 
Àd_gªí_⁄
:

88 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

89 
hw_Àd_°©e
 |
GPIO_GREEN_LED
;

92 
Àd_gªí_off
:

93 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

94 
hw_Àd_°©e
 &~
GPIO_GREEN_LED
;

97 
Àd_ambî_⁄
:

98 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

99 
hw_Àd_°©e
 |
GPIO_GREEN_LED
 | 
GPIO_RED_LED
;

102 
Àd_ambî_off
:

103 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

104 
hw_Àd_°©e
 &~(
GPIO_GREEN_LED
 | 
GPIO_RED_LED
);

107 
Àd_ªd_⁄
:

108 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

109 
hw_Àd_°©e
 |
GPIO_RED_LED
;

112 
Àd_ªd_off
:

113 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

114 
hw_Àd_°©e
 &~
GPIO_RED_LED
;

121 
	`•ö_u∆ock_úqª°‹e
(&
Àds_lock
, 
Êags
);

123 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
) {

124 
	`•ö_lock_úqßve
(&
gpio_lock
, 
Êags
);

125 
	`gpio_modify_›
(
GPIO_RED_LED
 | 
GPIO_GREEN_LED
, 
hw_Àd_°©e
);

126 
	`•ö_u∆ock_úqª°‹e
(&
gpio_lock
, 
Êags
);

128 
	}
}

130 
__öô
 
	$Àds_öô
()

132 i‡(
	`machöe_is_√twödî
())

133 
Àds_evít
 = 
√twödî_Àds_evít
;

135 
	`Àds_evít
(
Àd_°¨t
);

138 
	}
}

140 
__öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-footbridge/netwinder-pci.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/pci.h
>

10 
	~<löux/öô.h
>

12 
	~<asm/úq.h
>

13 
	~<asm/mach/pci.h
>

14 
	~<asm/mach-ty≥s.h
>

20 
__öô
 
	$√twödî_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

22 
¶Ÿ
) {

27  
IRQ_NETWINDER_VGA
;

30  
IRQ_NETWINDER_ETHER100
;

33  
IRQ_ISA_HARDDISK1
;

36  
IRQ_NETWINDER_ETHER10
;

39 
	`¥ötk
(
KERN_ERR
 "PCI: unknown device in slot %s\n",

40 
	`pci_«me
(
dev
));

43 
	}
}

45 
hw_pci
 
√twödî_pci
 
	g__öôd©a
 = {

46 .
swizzÀ
 = 
pci_°d_swizzÀ
,

47 .
	gm≠_úq
 = 
√twödî_m≠_úq
,

48 .
	gƒ_c⁄åﬁÀrs
 = 1,

49 .
	g£tup
 = 
dc21285_£tup
,

50 .
	gsˇn
 = 
dc21285_sˇn_bus
,

51 .
	g¥eöô
 = 
dc21285_¥eöô
,

52 .
	gpo°öô
 = 
dc21285_po°öô
,

55 
__öô
 
	$√twödî_pci_öô
()

57 i‡(
	`machöe_is_√twödî
())

58 
	`pci_comm⁄_öô
(&
√twödî_pci
);

60 
	}
}

62 
subsys_öôˇŒ
(
√twödî_pci_öô
);

	@arch/arm/mach-footbridge/personal-pci.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/pci.h
>

10 
	~<löux/öô.h
>

12 
	~<asm/úq.h
>

13 
	~<asm/mach/pci.h
>

14 
	~<asm/mach-ty≥s.h
>

16 
	gúqm≠_≥rs⁄Æ_£rvî
[] 
	g__öôd©a
 = {

17 
IRQ_IN0
, 
IRQ_IN1
, 
IRQ_IN2
, 
IRQ_IN3
, 0, 0, 0,

18 
IRQ_DOORBELLHOST
, 
IRQ_DMA1
, 
IRQ_DMA2
, 
IRQ_PCI


21 
__öô
 
	$≥rs⁄Æ_£rvî_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

23 
löe
;

25 
	`pci_ªad_c⁄fig_byã
(
dev
, 
PCI_INTERRUPT_LINE
, &
löe
);

27 i‡(
löe
 > 0x40 &&Üine <= 0x5f) {

32  
úqm≠_≥rs⁄Æ_£rvî
[(
löe
 & 0x1f) - 8];

33 } i‡(
löe
 == 0) {

37  
úqm≠_≥rs⁄Æ_£rvî
[(
löe
 - 1) & 3];

38 
	}
}

40 
hw_pci
 
≥rs⁄Æ_£rvî_pci
 
	g__öôd©a
 = {

41 .
m≠_úq
 = 
≥rs⁄Æ_£rvî_m≠_úq
,

42 .
	gƒ_c⁄åﬁÀrs
 = 1,

43 .
	g£tup
 = 
dc21285_£tup
,

44 .
	gsˇn
 = 
dc21285_sˇn_bus
,

45 .
	g¥eöô
 = 
dc21285_¥eöô
,

46 .
	gpo°öô
 = 
dc21285_po°öô
,

49 
__öô
 
	$≥rs⁄Æ_pci_öô
()

51 i‡(
	`machöe_is_≥rs⁄Æ_£rvî
())

52 
	`pci_comm⁄_öô
(&
≥rs⁄Æ_£rvî_pci
);

54 
	}
}

56 
subsys_öôˇŒ
(
≥rs⁄Æ_pci_öô
);

	@arch/arm/mach-footbridge/personal.c

6 
	~<löux/öô.h
>

8 
	~<asm/h¨dw¨e/dec21285.h
>

9 
	~<asm/mach-ty≥s.h
>

11 
	~<asm/mach/¨ch.h
>

13 
	~"comm⁄.h
"

15 
MACHINE_START
(
PERSONAL_SERVER
, "Compaq-PersonalServer")

17 .
	gphys_io
 = 
DC21285_ARMCSR_BASE
,

18 .
	gio_pg_off°
 = ((0xfe000000) >> 18) & 0xfffc,

19 .
	gboŸ_∑øms
 = 0x00000100,

20 .
	gm≠_io
 = 
foŸbridge_m≠_io
,

21 .
	göô_úq
 = 
foŸbridge_öô_úq
,

22 .
	gtimî
 = &
foŸbridge_timî
,

23 
	gMACHINE_END


	@arch/arm/mach-footbridge/time.c

17 
	#RTC_PORT
(
x
Ë(
πc_ba£
+(x))

	)

18 
	#RTC_ALWAYS_BCD
 0

	)

20 
	~<löux/timex.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/sched.h
>

23 
	~<löux/mc146818πc.h
>

24 
	~<löux/bcd.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

29 
	~<asm/mach/time.h
>

30 
	~"comm⁄.h
"

32 
	gπc_ba£
;

34 
__öô
 
	$gë_iß_cmos_time
()

36 
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
;

39 i‡((
	`CMOS_READ
(
RTC_VALID
Ë& 
RTC_VRT
) == 0)

40  
	`mktime
(1970, 1, 1, 0, 0, 0);

43 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

44 
mö
 = 
	`CMOS_READ
(
RTC_MINUTES
);

45 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

46 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

47 
m⁄
 = 
	`CMOS_READ
(
RTC_MONTH
);

48 
yór
 = 
	`CMOS_READ
(
RTC_YEAR
);

49 } 
£c
 !
	`CMOS_READ
(
RTC_SECONDS
));

51 i‡(!(
	`CMOS_READ
(
RTC_CONTROL
Ë& 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

52 
	`BCD_TO_BIN
(
£c
);

53 
	`BCD_TO_BIN
(
mö
);

54 
	`BCD_TO_BIN
(
hour
);

55 
	`BCD_TO_BIN
(
day
);

56 
	`BCD_TO_BIN
(
m⁄
);

57 
	`BCD_TO_BIN
(
yór
);

59 i‡((
yór
 += 1900) < 1970)

60 
yór
 += 100;

61  
	`mktime
(
yór
, 
m⁄
, 
day
, 
hour
, 
mö
, 
£c
);

62 
	}
}

64 
	$£t_iß_cmos_time
()

66 
ªtvÆ
 = 0;

67 
ªÆ_£c⁄ds
, 
ªÆ_möuãs
, 
cmos_möuãs
;

68 
ßve_c⁄åﬁ
, 
ßve_‰eq_£À˘
;

69 
nowtime
 = 
xtime
.
tv_£c
;

71 
ßve_c⁄åﬁ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

72 
	`CMOS_WRITE
((
ßve_c⁄åﬁ
|
RTC_SET
), 
RTC_CONTROL
);

74 
ßve_‰eq_£À˘
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

75 
	`CMOS_WRITE
((
ßve_‰eq_£À˘
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

77 
cmos_möuãs
 = 
	`CMOS_READ
(
RTC_MINUTES
);

78 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
)

79 
	`BCD_TO_BIN
(
cmos_möuãs
);

87 
ªÆ_£c⁄ds
 = 
nowtime
 % 60;

88 
ªÆ_möuãs
 = 
nowtime
 / 60;

89 i‡(((
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) + 15)/30) & 1)

90 
ªÆ_möuãs
 += 30;

91 
ªÆ_möuãs
 %= 60;

93 i‡(
	`abs
(
ªÆ_möuãs
 - 
cmos_möuãs
) < 30) {

94 i‡(!(
ßve_c⁄åﬁ
 & 
RTC_DM_BINARY
Ë|| 
RTC_ALWAYS_BCD
) {

95 
	`BIN_TO_BCD
(
ªÆ_£c⁄ds
);

96 
	`BIN_TO_BCD
(
ªÆ_möuãs
);

98 
	`CMOS_WRITE
(
ªÆ_£c⁄ds
,
RTC_SECONDS
);

99 
	`CMOS_WRITE
(
ªÆ_möuãs
,
RTC_MINUTES
);

101 
ªtvÆ
 = -1;

110 
	`CMOS_WRITE
(
ßve_c⁄åﬁ
, 
RTC_CONTROL
);

111 
	`CMOS_WRITE
(
ßve_‰eq_£À˘
, 
RTC_FREQ_SELECT
);

113  
ªtvÆ
;

114 
	}
}

116 
__öô
 
	$iß_πc_öô
()

118 i‡(
	`machöe_is_co285
() ||

119 
	`machöe_is_≥rs⁄Æ_£rvî
())

123 
πc_ba£
 = 0;

125 
πc_ba£
 = 0x70;

127 i‡(
πc_ba£
) {

128 
ªg_d
, 
ªg_b
;

133 
ªg_d
 = 
	`CMOS_READ
(
RTC_REG_D
);

138 
	`CMOS_WRITE
(
RTC_REF_CLCK_32KHZ
, 
RTC_REG_A
);

144 
ªg_b
 = 
	`CMOS_READ
(
RTC_REG_B
) & 0x7f;

145 
ªg_b
 |= 2;

146 
	`CMOS_WRITE
(
ªg_b
, 
RTC_REG_B
);

148 i‡((
	`CMOS_READ
(
RTC_REG_A
Ë& 0x7fË=
RTC_REF_CLCK_32KHZ
 &&

149 
	`CMOS_READ
(
RTC_REG_B
Ë=
ªg_b
) {

150 
time•ec
 
tv
;

155 i‡((
ªg_d
 & 0x80) == 0)

156 
	`¥ötk
(
KERN_WARNING
 "RTC: *** warning: CMOS battery bad\n");

158 
tv
.
tv_n£c
 = 0;

159 
tv
.
tv_£c
 = 
	`gë_iß_cmos_time
();

160 
	`do_£âimeofday
(&
tv
);

161 
£t_πc
 = 
£t_iß_cmos_time
;

163 
πc_ba£
 = 0;

165 
	}
}

	@arch/arm/mach-h720x/common.c

16 
	~<löux/sched.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/mm™.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/öãºu±.h
>

22 
	~<asm/∑ge.h
>

23 
	~<asm/pgèbÀ.h
>

24 
	~<asm/dma.h
>

25 
	~<asm/io.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/úq.h
>

29 
	~<asm/mach/m≠.h
>

30 
	~<asm/¨ch/úqs.h
>

32 
	~<asm/mach/dma.h
>

35 
	#IRQDBG
(
¨gs
...Ë
	`¥ötk
◊rgs)

	)

37 
	#IRQDBG
(
¨gs
...Ëdÿ{} 0)

	)

40 
__öô
 
	$¨ch_dma_öô
(
dma_t
 *
dma
)

42 
	}
}

48 
	$h720x_gëtimeoff£t
()

50  (
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_COUNT
Ë* 
tick_u£c
Ë/ 
LATCH
;

51 
	}
}

56 
	$mask_globÆ_úq
 (
úq
 )

58 
	`CPU_REG
 (
IRQC_VIRT
, 
IRQC_IER
Ë&~(1 << 
úq
);

59 
	}
}

64 
	$unmask_globÆ_úq
 (
úq
 )

66 
	`CPU_REG
 (
IRQC_VIRT
, 
IRQC_IER
Ë|(1 << 
úq
);

67 
	}
}

74 
ölöe
 
	$ack_gpio_úq
(
u32
 
úq
)

76 
u32
 
ªg_ba£
 = 
	`GPIO_VIRT
(
	`IRQ_TO_REGNO
(
úq
));

77 
u32
 
bô
 = 
	`IRQ_TO_BIT
(
úq
);

78 i‡–(
	`CPU_REG
 (
ªg_ba£
, 
GPIO_EDGE
Ë& 
bô
))

79 
	`CPU_REG
 (
ªg_ba£
, 
GPIO_CLR
Ë
bô
;

80 
	}
}

85 
ölöe
 
	$mask_gpio_úq
(
u32
 
úq
)

87 
u32
 
ªg_ba£
 = 
	`GPIO_VIRT
(
	`IRQ_TO_REGNO
(
úq
));

88 
u32
 
bô
 = 
	`IRQ_TO_BIT
(
úq
);

89 
	`CPU_REG
 (
ªg_ba£
, 
GPIO_MASK
Ë&~
bô
;

90 
	}
}

95 
ölöe
 
	$unmask_gpio_úq
(
u32
 
úq
)

97 
u32
 
ªg_ba£
 = 
	`GPIO_VIRT
(
	`IRQ_TO_REGNO
(
úq
));

98 
u32
 
bô
 = 
	`IRQ_TO_BIT
(
úq
);

99 
	`CPU_REG
 (
ªg_ba£
, 
GPIO_MASK
Ë|
bô
;

100 
	}
}

103 
	$h720x_gpio_h™dÀr
(
mask
, 
úq
,

104 
úq_desc
 *
desc
)

106 
	`IRQDBG
("%†úq: %d\n",
__FUNCTION__
,
úq
);

107 
desc
 = 
úq_desc
 + 
úq
;

108 
mask
) {

109 i‡(
mask
 & 1) {

110 
	`IRQDBG
("h™dlög irq %d\n", 
úq
);

111 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

113 
úq
++;

114 
desc
++;

115 
mask
 >>= 1;

117 
	}
}

120 
	$h720x_gpiﬂ_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

122 
mask
, 
úq
;

124 
mask
 = 
	`CPU_REG
(
GPIO_A_VIRT
,
GPIO_STAT
);

125 
úq
 = 
	`IRQ_CHAINED_GPIOA
(0);

126 
	`IRQDBG
("%†mask: 0x%08x irq: %d\n",
__FUNCTION__
,
mask
,
úq
);

127 
	`h720x_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

128 
	}
}

131 
	$h720x_gpiob_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

133 
mask
, 
úq
;

134 
mask
 = 
	`CPU_REG
(
GPIO_B_VIRT
,
GPIO_STAT
);

135 
úq
 = 
	`IRQ_CHAINED_GPIOB
(0);

136 
	`IRQDBG
("%†mask: 0x%08x irq: %d\n",
__FUNCTION__
,
mask
,
úq
);

137 
	`h720x_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

138 
	}
}

141 
	$h720x_gpioc_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

143 
mask
, 
úq
;

145 
mask
 = 
	`CPU_REG
(
GPIO_C_VIRT
,
GPIO_STAT
);

146 
úq
 = 
	`IRQ_CHAINED_GPIOC
(0);

147 
	`IRQDBG
("%†mask: 0x%08x irq: %d\n",
__FUNCTION__
,
mask
,
úq
);

148 
	`h720x_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

149 
	}
}

152 
	$h720x_gpiod_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

154 
mask
, 
úq
;

156 
mask
 = 
	`CPU_REG
(
GPIO_D_VIRT
,
GPIO_STAT
);

157 
úq
 = 
	`IRQ_CHAINED_GPIOD
(0);

158 
	`IRQDBG
("%†mask: 0x%08x irq: %d\n",
__FUNCTION__
,
mask
,
úq
);

159 
	`h720x_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

160 
	}
}

162 #ifde‡
CONFIG_CPU_H7202


164 
	$h720x_gpi€_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

166 
mask
, 
úq
;

168 
mask
 = 
	`CPU_REG
(
GPIO_E_VIRT
,
GPIO_STAT
);

169 
úq
 = 
	`IRQ_CHAINED_GPIOE
(0);

170 
	`IRQDBG
("%†mask: 0x%08x irq: %d\n",
__FUNCTION__
,
mask
,
úq
);

171 
	`h720x_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

172 
	}
}

175 
úq_chù
 
	gh720x_globÆ_chù
 = {

176 .
ack
 = 
mask_globÆ_úq
,

177 .
	gmask
 = 
mask_globÆ_úq
,

178 .
	gunmask
 = 
unmask_globÆ_úq
,

181 
úq_chù
 
	gh720x_gpio_chù
 = {

182 .
ack
 = 
ack_gpio_úq
,

183 .
	gmask
 = 
mask_gpio_úq
,

184 .
	gunmask
 = 
unmask_gpio_úq
,

190 
__öô
 
	$h720x_öô_úq
 ()

192 
úq
;

195 
	`CPU_REG
 (
IRQC_VIRT
, 
IRQC_IER
) = 0x0;

198 
	`CPU_REG
 (
GPIO_A_VIRT
, 
GPIO_MASK
) = 0x0;

199 
	`CPU_REG
 (
GPIO_B_VIRT
, 
GPIO_MASK
) = 0x0;

200 
	`CPU_REG
 (
GPIO_C_VIRT
, 
GPIO_MASK
) = 0x0;

201 
	`CPU_REG
 (
GPIO_D_VIRT
, 
GPIO_MASK
) = 0x0;

204 
úq
 = 0; irq < 
NR_GLBL_IRQS
; irq++) {

205 
	`£t_úq_chù
(
úq
, &
h720x_globÆ_chù
);

206 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

207 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

211 
úq
 = 
	`IRQ_CHAINED_GPIOA
(0Ë; irq <
	`IRQ_CHAINED_GPIOD
(31); irq++) {

212 
	`£t_úq_chù
(
úq
, &
h720x_gpio_chù
);

213 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

214 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 );

216 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIOA
, 
h720x_gpiﬂ_demux_h™dÀr
);

217 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIOB
, 
h720x_gpiob_demux_h™dÀr
);

218 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIOC
, 
h720x_gpioc_demux_h™dÀr
);

219 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIOD
, 
h720x_gpiod_demux_h™dÀr
);

221 #ifde‡
CONFIG_CPU_H7202


222 
úq
 = 
	`IRQ_CHAINED_GPIOE
(0) ; irq <= IRQ_CHAINED_GPIOE(31); irq++) {

223 
	`£t_úq_chù
(
úq
, &
h720x_gpio_chù
);

224 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

225 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 );

227 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIOE
, 
h720x_gpi€_demux_h™dÀr
);

231 
	`CPU_REG
 (
IRQC_VIRT
, 
IRQC_IER
Ë
IRQ_ENA_MUX
;

232 
	}
}

234 
m≠_desc
 
	gh720x_io_desc
[] 
	g__öôd©a
 = {

236 .
vútuÆ
 = 
IO_VIRT
,

237 .
	gp‚
 = 
__phys_to_p‚
(
IO_PHYS
),

238 .
	gÀngth
 = 
IO_SIZE
,

239 .
	gty≥
 = 
MT_DEVICE


244 
__öô
 
	$h720x_m≠_io
()

246 
	`iŸabÀ_öô
(
h720x_io_desc
,
	`ARRAY_SIZE
(h720x_io_desc));

247 
	}
}

	@arch/arm/mach-h720x/common.h

16 
h720x_gëtimeoff£t
();

17 
__öô
 
h720x_öô_úq
 ();

18 
__öô
 
h720x_m≠_io
();

20 #ifde‡
CONFIG_ARCH_H7202


21 
sys_timî
 
h7202_timî
;

22 
__öô
 
öô_hw_h7202
();

23 
__öô
 
h7202_öô_úq
 ();

24 
__öô
 
h7202_öô_time
();

27 #ifde‡
CONFIG_ARCH_H7201


28 
sys_timî
 
h7201_timî
;

	@arch/arm/mach-h720x/cpu-h7201.c

16 
	~<löux/öô.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<asm/ty≥s.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/¨ch/úqs.h
>

23 
	~<asm/mach/úq.h
>

24 
	~<asm/mach/time.h
>

25 
	~"comm⁄.h
"

29 
úqªtu∫_t


30 
	$h7201_timî_öãºu±
(
úq
, *
dev_id
)

32 
	`wrôe_£qlock
(&
xtime_lock
);

34 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPSTAT
);

35 
	`timî_tick
();

37 
	`wrôe_£qu∆ock
(&
xtime_lock
);

39  
IRQ_HANDLED
;

40 
	}
}

42 
úqa˘i⁄
 
	gh7201_timî_úq
 = {

43 .
«me
 = "h7201 Timer Tick",

44 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

45 .
	gh™dÀr
 = 
h7201_timî_öãºu±
,

51 
__öô
 
	$h7201_öô_time
()

53 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_PERIOD
Ë
LATCH
;

54 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_CTRL
Ë
TM_RESET
;

55 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_CTRL
Ë
TM_REPEAT
 | 
TM_START
;

56 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPCTRL
Ë
ENABLE_TM0_INTR
 | 
TIMER_ENABLE_BIT
;

58 
	`£tup_úq
(
IRQ_TIMER0
, &
h7201_timî_úq
);

59 
	}
}

61 
sys_timî
 
	gh7201_timî
 = {

62 .
öô
 = 
h7201_öô_time
,

63 .
	goff£t
 = 
h720x_gëtimeoff£t
,

	@arch/arm/mach-h720x/cpu-h7202.c

16 
	~<löux/öô.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<asm/ty≥s.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/¨ch/úqs.h
>

23 
	~<asm/mach/úq.h
>

24 
	~<asm/mach/time.h
>

25 
	~<löux/devi˚.h
>

26 
	~<löux/£rül_8250.h
>

27 
	~"comm⁄.h
"

29 
ªsour˚
 
	gh7202ps2_ªsour˚s
[] = {

31 .
°¨t
 = 0x8002c000,

32 .
	gíd
 = 0x8002c040,

33 .
	gÊags
 = 
IORESOURCE_MEM
,

36 .
°¨t
 = 
IRQ_PS2
,

37 .
	gíd
 = 
IRQ_PS2
,

38 .
	gÊags
 = 
IORESOURCE_IRQ
,

42 
∂©f‹m_devi˚
 
	gh7202ps2_devi˚
 = {

43 .
«me
 = "h7202ps2",

44 .
	gid
 = -1,

45 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h7202ps2_ªsour˚s
),

46 .
	gªsour˚
 = 
h7202ps2_ªsour˚s
,

49 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

51 .
memba£
 = (*)
SERIAL0_VIRT
,

52 .
	gm≠ba£
 = 
SERIAL0_BASE
,

53 .
	gúq
 = 
IRQ_UART0
,

54 .
	gu¨t˛k
 = 2*1843200,

55 .
	gªgshi·
 = 2,

56 .
	giŸy≥
 = 
UPIO_MEM
,

57 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

60 .
	gmemba£
 = (*)
SERIAL1_VIRT
,

61 .
	gm≠ba£
 = 
SERIAL1_BASE
,

62 .
	gúq
 = 
IRQ_UART1
,

63 .
	gu¨t˛k
 = 2*1843200,

64 .
	gªgshi·
 = 2,

65 .
	giŸy≥
 = 
UPIO_MEM
,

66 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

68 #ifde‡
CONFIG_H7202_SERIAL23


70 .
	gmemba£
 = (*)
SERIAL2_VIRT
,

71 .
	gm≠ba£
 = 
SERIAL2_BASE
,

72 .
	gúq
 = 
IRQ_UART2
,

73 .
	gu¨t˛k
 = 2*1843200,

74 .
	gªgshi·
 = 2,

75 .
	giŸy≥
 = 
UPIO_MEM
,

76 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

79 .
	gmemba£
 = (*)
SERIAL3_VIRT
,

80 .
	gm≠ba£
 = 
SERIAL3_BASE
,

81 .
	gúq
 = 
IRQ_UART3
,

82 .
	gu¨t˛k
 = 2*1843200,

83 .
	gªgshi·
 = 2,

84 .
	giŸy≥
 = 
UPIO_MEM
,

85 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

91 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

92 .
«me
 = "serial8250",

93 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

94 .
	gdev
 = {

95 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

99 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

100 &
h7202ps2_devi˚
,

101 &
£rül_devi˚
,

109 
	$h7202_timîx_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

111 
mask
, 
úq
;

113 
mask
 = 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPSTAT
);

115 i‡–
mask
 & 
TSTAT_T0INT
 ) {

116 
	`wrôe_£qlock
(&
xtime_lock
);

117 
	`timî_tick
();

118 
	`wrôe_£qu∆ock
(&
xtime_lock
);

119 if–
mask
 =
TSTAT_T0INT
 )

123 
mask
 >>= 1;

124 
úq
 = 
IRQ_TIMER1
;

125 
desc
 = 
úq_desc
 + 
úq
;

126 
mask
) {

127 i‡(
mask
 & 1)

128 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

129 
úq
++;

130 
desc
++;

131 
mask
 >>= 1;

133 
	}
}

138 
úqªtu∫_t


139 
	$h7202_timî_öãºu±
(
úq
, *
dev_id
)

141 
	`h7202_timîx_demux_h™dÀr
(0, 
NULL
);

142  
IRQ_HANDLED
;

143 
	}
}

148 
ölöe
 
	$mask_timîx_úq
 (
u32
 
úq
)

150 
bô
;

151 
bô
 = 2 << ((
úq
 =
IRQ_TIMER64B
Ë? 4 : (úq - 
IRQ_TIMER1
));

152 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPCTRL
Ë&~
bô
;

153 
	}
}

158 
ölöe
 
	$unmask_timîx_úq
 (
u32
 
úq
)

160 
bô
;

161 
bô
 = 2 << ((
úq
 =
IRQ_TIMER64B
Ë? 4 : (úq - 
IRQ_TIMER1
));

162 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPCTRL
Ë|
bô
;

163 
	}
}

165 
úq_chù
 
	gh7202_timîx_chù
 = {

166 .
ack
 = 
mask_timîx_úq
,

167 .
	gmask
 = 
mask_timîx_úq
,

168 .
	gunmask
 = 
unmask_timîx_úq
,

171 
úqa˘i⁄
 
	gh7202_timî_úq
 = {

172 .
«me
 = "h7202 Timer Tick",

173 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

174 .
	gh™dÀr
 = 
h7202_timî_öãºu±
,

180 
__öô
 
	$h7202_öô_time
()

182 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_PERIOD
Ë
LATCH
;

183 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_CTRL
Ë
TM_RESET
;

184 
	`CPU_REG
 (
TIMER_VIRT
, 
TM0_CTRL
Ë
TM_REPEAT
 | 
TM_START
;

185 
	`CPU_REG
 (
TIMER_VIRT
, 
TIMER_TOPCTRL
Ë
ENABLE_TM0_INTR
 | 
TIMER_ENABLE_BIT
;

187 
	`£tup_úq
(
IRQ_TIMER0
, &
h7202_timî_úq
);

188 
	}
}

190 
sys_timî
 
	gh7202_timî
 = {

191 .
öô
 = 
h7202_öô_time
,

192 .
	goff£t
 = 
h720x_gëtimeoff£t
,

195 
__öô
 
	$h7202_öô_úq
 ()

197 
úq
;

199 
	`CPU_REG
 (
GPIO_E_VIRT
, 
GPIO_MASK
) = 0x0;

201 
úq
 = 
IRQ_TIMER1
;

202 
úq
 < 
	`IRQ_CHAINED_TIMERX
(
NR_TIMERX_IRQS
); irq++) {

203 
	`mask_timîx_úq
(
úq
);

204 
	`£t_úq_chù
(
úq
, &
h7202_timîx_chù
);

205 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

206 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 );

208 
	`£t_úq_chaöed_h™dÀr
(
IRQ_TIMERX
, 
h7202_timîx_demux_h™dÀr
);

210 
	`h720x_öô_úq
();

211 
	}
}

213 
__öô
 
	$öô_hw_h7202
()

216 
	`CPU_REG
 (
PMU_BASE
, 
PMU_PLL_CTRL
Ë|
PLL_2_EN
 | 
PLL_1_EN
 | 
PLL_3_MUTE
;

218 
	`CPU_REG
 (
SERIAL0_VIRT
, 
SERIAL_ENABLE
Ë
SERIAL_ENABLE_EN
;

219 
	`CPU_REG
 (
SERIAL1_VIRT
, 
SERIAL_ENABLE
Ë
SERIAL_ENABLE_EN
;

220 #ifde‡
CONFIG_H7202_SERIAL23


221 
	`CPU_REG
 (
SERIAL2_VIRT
, 
SERIAL_ENABLE
Ë
SERIAL_ENABLE_EN
;

222 
	`CPU_REG
 (
SERIAL3_VIRT
, 
SERIAL_ENABLE
Ë
SERIAL_ENABLE_EN
;

223 
	`CPU_IO
 (
GPIO_AMULSEL
Ë
AMULSEL_USIN2
 | 
AMULSEL_USOUT2
 |

224 
AMULSEL_USIN3
 | 
AMULSEL_USOUT3
;

226 (Ë
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

227 
	}
}

	@arch/arm/mach-h720x/h7201-eval.c

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/ty≥s.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/devi˚.h
>

22 
	~<asm/£tup.h
>

23 
	~<asm/ty≥s.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/∑ge.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/mach/¨ch.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~"comm⁄.h
"

31 
MACHINE_START
(
H7201
, "Hynix GMS30C7201")

33 .
	gphys_io
 = 0x80000000,

34 .
	gio_pg_off°
 = ((0xf0000000) >> 18) & 0xfffc,

35 .
	gboŸ_∑øms
 = 0xc0001000,

36 .
	gm≠_io
 = 
h720x_m≠_io
,

37 .
	göô_úq
 = 
h720x_öô_úq
,

38 .
	gtimî
 = &
h7201_timî
,

39 
	gMACHINE_END


	@arch/arm/mach-h720x/h7202-eval.c

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/ty≥s.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<asm/£tup.h
>

23 
	~<asm/ty≥s.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/∑ge.h
>

26 
	~<asm/pgèbÀ.h
>

27 
	~<asm/mach/¨ch.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~"comm⁄.h
"

31 
ªsour˚
 
	gcúrus_ªsour˚s
[] = {

33 .
°¨t
 = 
ETH0_PHYS
 + 0x300,

34 .
	gíd
 = 
ETH0_PHYS
 + 0x300 + 0x10,

35 .
	gÊags
 = 
IORESOURCE_MEM
,

38 .
°¨t
 = 
IRQ_CHAINED_GPIOB
(8),

39 .
	gíd
 = 
IRQ_CHAINED_GPIOB
(8),

40 .
	gÊags
 = 
IORESOURCE_IRQ
,

44 
∂©f‹m_devi˚
 
	gcúrus_devi˚
 = {

45 .
«me
 = "cirrus-cs89x0",

46 .
	gid
 = -1,

47 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
cúrus_ªsour˚s
),

48 .
	gªsour˚
 = 
cúrus_ªsour˚s
,

51 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

52 &
cúrus_devi˚
,

62 
__öô
 
	$öô_evÆ_h7202
()

64 
	`öô_hw_h7202
();

65 (Ë
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

68 
	`CPU_REG
 (
GPIO_B_VIRT
, 
GPIO_POL
) &= ~(1 << 8);

69 
	`CPU_REG
 (
GPIO_B_VIRT
, 
GPIO_EN
) |= (1 << 8);

70 
	}
}

72 
MACHINE_START
(
H7202
, "Hynix HMS30C7202")

74 .
	gphys_io
 = 0x80000000,

75 .
	gio_pg_off°
 = ((0xf0000000) >> 18) & 0xfffc,

76 .
	gboŸ_∑øms
 = 0x40000100,

77 .
	gm≠_io
 = 
h720x_m≠_io
,

78 .
	göô_úq
 = 
h7202_öô_úq
,

79 .
	gtimî
 = &
h7202_timî
,

80 .
	göô_machöe
 = 
öô_evÆ_h7202
,

81 
	gMACHINE_END


	@arch/arm/mach-imx/cpufreq.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/ty≥s.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/˝u‰eq.h
>

35 
	~<asm/sy°em.h
>

37 
	~<asm/h¨dw¨e.h
>

39 
	~"gíîic.h
"

41 #i‚de‡
__vÆ2mÊd


42 
	#__vÆ2mÊd
(
mask
,
vÆ
Ë(((mask)&~((mask)<<1))*(vÆ)&(mask))

	)

44 #i‚de‡
__mÊd2vÆ


45 
	#__mÊd2vÆ
(
mask
,
vÆ
Ë(((vÆ)&(mask))/((mask)&~((mask)<<1)))

	)

48 
	#CR_920T_CLOCK_MODE
 0xC0000000

	)

49 
	#CR_920T_FASTBUS_MODE
 0x00000000

	)

50 
	#CR_920T_ASYNC_MODE
 0xC0000000

	)

52 
u32
 
	gmp˘l0_©_boŸ
;

53 
u32
 
	gb˛k_div_©_boŸ
;

55 
	$imx_£t_async_mode
()

57 
	`adju°_¸
(
CR_920T_CLOCK_MODE
, 
CR_920T_ASYNC_MODE
);

58 
	}
}

60 
	$imx_£t_Á°bus_mode
()

62 
	`adju°_¸
(
CR_920T_CLOCK_MODE
, 
CR_920T_FASTBUS_MODE
);

63 
	}
}

65 
	$imx_£t_mp˘l0
(
u32
 
mp˘l0
)

67 
Êags
;

69 i‡(
mp˘l0
 == 0) {

70 
	`loˇl_úq_ßve
(
Êags
);

71 
CSCR
 &~
CSCR_MPEN
;

72 
	`loˇl_úq_ª°‹e
(
Êags
);

76 
	`loˇl_úq_ßve
(
Êags
);

77 
MPCTL0
 = 
mp˘l0
;

78 
CSCR
 |
CSCR_MPEN
;

79 
	`loˇl_úq_ª°‹e
(
Êags
);

80 
	}
}

91 
	$imx_compuã_mp˘l
(
u32
 *
√w_mp˘l
, u32 
cur_mp˘l
, u32 
f_ªf
, 
‰eq
, 
ªœti⁄
)

93 
u32
 
mfi
;

94 
u32
 
m‚
;

95 
u32
 
mfd
;

96 
u32
 
pd
;

97 
Œ
;

98 
l
;

99 
quŸ
;

104 i‡(
cur_mp˘l
) {

105 
mfd
 = ((
cur_mp˘l
 >> 16) & 0x3ff) + 1;

106 
pd
 = ((
cur_mp˘l
 >> 26) & 0xf) + 1;

108 
pd
=2; 
mfd
=313;

114 
quŸ
 = (
f_ªf
 + (1 << 9)) >> 10;

115 
l
 = (
‰eq
 * 
pd
 + 
quŸ
) / (2 * quot);

116 
mfi
 = 
l
 >> 10;

117 
m‚
 = ((
l
 & ((1 << 10Ë- 1)Ë* 
mfd
 + (1 << 9)) >> 10;

119 
mfd
 -= 1;

120 
pd
 -= 1;

122 *
√w_mp˘l
 = ((
mfi
 & 0xfË<< 10Ë| (
m‚
 & 0x3ffË| ((
mfd
 & 0x3ff) << 16)

123 | ((
pd
 & 0xf) << 26);

125 
Œ
 = 2 * ()
f_ªf
 * ( (
mfi
<<16Ë+ (
m‚
<<16Ë/ (
mfd
+1) );

126 
quŸ
 = (
pd
+1) * (1<<16);

127 
Œ
 +
quŸ
 / 2;

128 
	`do_div
(
Œ
, 
quŸ
);

129 
‰eq
 = 
Œ
;

131 
	`¥_debug
(
KERN_DEBUG
 "imx:Çew PLLÖarametersÖd=%d mfd=%d mfi=%d mfn=%d, freq=%ld\n",

132 
pd
, 
mfd
, 
mfi
, 
m‚
, 
‰eq
);

134  
‰eq
;

135 
	}
}

138 
	$imx_vîify_•ìd
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

140 i‡(
pﬁicy
->
˝u
 != 0)

141  -
EINVAL
;

143 
	`˝u‰eq_vîify_wôhö_limôs
(
pﬁicy
,Öﬁicy->
˝uöfo
.
mö_‰eq
,Öﬁicy->˝uöfo.
max_‰eq
);

146 
	}
}

148 
	$imx_gë_•ìd
(
˝u
)

150 
‰eq
;

151 
¸
;

152 
cs¸
;

153 
b˛k_div
;

155 i‡(
˝u
)

158 
cs¸
 = 
CSCR
;

159 
b˛k_div
 = 
	`__mÊd2vÆ
(
CSCR_BCLK_DIV
, 
cs¸
) + 1;

160 
¸
 = 
	`gë_¸
();

162 if((
¸
 & 
CR_920T_CLOCK_MODE
Ë=
CR_920T_FASTBUS_MODE
) {

163 
‰eq
 = 
	`imx_gë_sy°em_˛k
();

164 
‰eq
 = (‰eq + 
b˛k_div
/2) / bclk_div;

166 
‰eq
 = 
	`imx_gë_mcu_˛k
();

167 i‡(
cs¸
 & 
CSCR_MPU_PRESC
)

168 
‰eq
 /= 2;

171 
‰eq
 = (freq + 500) / 1000;

173  
‰eq
;

174 
	}
}

176 
	$imx_£t_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

177 
èrgë_‰eq
,

178 
ªœti⁄
)

180 
˝u‰eq_‰eqs
 
‰eqs
;

181 
u32
 
mp˘l0
 = 0;

182 
u32
 
cs¸
;

183 
Êags
;

184 
‰eq
;

185 
sys˛k
;

186 
b˛k_div
 = 
b˛k_div_©_boŸ
;

193 if(
èrgë_‰eq
 < 
pﬁicy
->
˝uöfo
.
mö_‰eq
)

194 
èrgë_‰eq
 = 
pﬁicy
->
˝uöfo
.
mö_‰eq
;

196 if(
èrgë_‰eq
 < 
pﬁicy
->
mö
)

197 
èrgë_‰eq
 = 
pﬁicy
->
mö
;

199 
‰eq
 = 
èrgë_‰eq
 * 1000;

201 
	`¥_debug
(
KERN_DEBUG
 "imx:Ñequested frequency %ld Hz, mpctl0át boot 0x%08x\n",

202 
‰eq
, 
mp˘l0_©_boŸ
);

204 
sys˛k
 = 
	`imx_gë_sy°em_˛k
();

206 i‡(
‰eq
 > 
sys˛k
 / 
b˛k_div_©_boŸ
 + 1000000) {

207 
‰eq
 = 
	`imx_compuã_mp˘l
(&
mp˘l0
, 
mp˘l0_©_boŸ
, 
CLK32
 * 512, fªq, 
ªœti⁄
);

208 i‡(
‰eq
 < 0) {

209 
	`¥ötk
(
KERN_WARNING
 "imx:Å¨gë fªquícy %ld Hz c™nŸ bê£t\n", 
‰eq
);

210  -
EINVAL
;

213 if(
‰eq
 + 1000 < 
sys˛k
) {

214 i‡(
ªœti⁄
 =
CPUFREQ_RELATION_L
)

215 
b˛k_div
 = (
sys˛k
 - 1000Ë/ 
‰eq
;

217 
b˛k_div
 = (
sys˛k
 + 
‰eq
 + 1000) / freq;

219 if(
b˛k_div
 > 16)

220 
b˛k_div
 = 16;

221 if(
b˛k_div
 < 
b˛k_div_©_boŸ
)

222 
b˛k_div
 = 
b˛k_div_©_boŸ
;

224 
‰eq
 = (
sys˛k
 + 
b˛k_div
 / 2) / bclk_div;

227 
‰eqs
.
ﬁd
 = 
	`imx_gë_•ìd
(0);

228 
‰eqs
.
√w
 = (
‰eq
 + 500) / 1000;

229 
‰eqs
.
˝u
 = 0;

230 
‰eqs
.
Êags
 = 0;

232 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

234 
	`loˇl_úq_ßve
(
Êags
);

236 
	`imx_£t_Á°bus_mode
();

238 
	`imx_£t_mp˘l0
(
mp˘l0
);

240 
cs¸
 = 
CSCR
;

241 
cs¸
 &~
CSCR_BCLK_DIV
;

242 
cs¸
 |
	`__vÆ2mÊd
(
CSCR_BCLK_DIV
, 
b˛k_div
 - 1);

243 
CSCR
 = 
cs¸
;

245 if(
mp˘l0
) {

246 
CSCR
 |
CSCR_MPLL_RESTART
;

249  
CSCR
 & 
CSCR_MPLL_RESTART
 );

251 
	`imx_£t_async_mode
();

254 
	`loˇl_úq_ª°‹e
(
Êags
);

256 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

258 
	`¥_debug
(
KERN_INFO
 "imx: set frequency %ld Hz,Ñunning from %s\n",

259 
‰eq
, 
mp˘l0
? "MPLL": "SPLL");

262 
	}
}

264 
__öô
 
	$imx_˝u‰eq_drivî_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

266 
	`¥ötk
(
KERN_INFO
 "i.MX cpu freq change driver v1.0\n");

268 i‡(
pﬁicy
->
˝u
 != 0)

269  -
EINVAL
;

271 
pﬁicy
->
cur
 =Öﬁicy->
mö
 =Öﬁicy->
max
 = 
	`imx_gë_•ìd
(0);

272 
pﬁicy
->
govîn‹
 = 
CPUFREQ_DEFAULT_GOVERNOR
;

273 
pﬁicy
->
˝uöfo
.
mö_‰eq
 = 8000;

274 
pﬁicy
->
˝uöfo
.
max_‰eq
 = 200000;

276 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 4 * 1000000000LL / 
CLK32
;

278 
	}
}

280 
˝u‰eq_drivî
 
	gimx_drivî
 = {

281 .
Êags
 = 
CPUFREQ_STICKY
,

282 .
	gvîify
 = 
imx_vîify_•ìd
,

283 .
	gèrgë
 = 
imx_£t_èrgë
,

284 .
	ggë
 = 
imx_gë_•ìd
,

285 .
	göô
 = 
imx_˝u‰eq_drivî_öô
,

286 .
	g«me
 = "imx",

289 
__öô
 
	$imx_˝u‰eq_öô
()

291 
b˛k_div_©_boŸ
 = 
	`__mÊd2vÆ
(
CSCR_BCLK_DIV
, 
CSCR
) + 1;

292 
mp˘l0_©_boŸ
 = 0;

294 if((
CSCR
 & 
CSCR_MPEN
) &&

295 ((
	`gë_¸
(Ë& 
CR_920T_CLOCK_MODE
Ë!
CR_920T_FASTBUS_MODE
))

296 
mp˘l0_©_boŸ
 = 
MPCTL0
;

298  
	`˝u‰eq_ªgi°î_drivî
(&
imx_drivî
);

299 
	}
}

301 
¨ch_öôˇŒ
(
imx_˝u‰eq_öô
);

	@arch/arm/mach-imx/dma.c

23 #unde‡
DEBUG


25 
	~<löux/moduÀ.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/kî√l.h
>

28 
	~<löux/öãºu±.h
>

29 
	~<löux/î∫o.h
>

31 
	~<asm/sy°em.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/h¨dw¨e.h
>

34 
	~<asm/dma.h
>

35 
	~<asm/¨ch/imx-dma.h
>

37 
imx_dma_ch™√l
 
	gimx_dma_ch™√ls
[
IMX_DMA_CHANNELS
];

49 
ölöe
 
	$imx_dma_sg_√xt
(
imx_dmach_t
 
dma_ch
, 
œ°cou¡
)

51 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

52 
√xtcou¡
;

53 
√xèddr
;

55 i‡(!
imxdma
->
«me
) {

56 
	`¥ötk
(
KERN_CRIT
 "%s: called forÇotállocated channel %d\n",

57 
__FUNCTION__
, 
dma_ch
);

61 
imxdma
->
ªsbyãs
 -
œ°cou¡
;

63 i‡(!
imxdma
->
sg
) {

64 
	`¥_debug
("imxdma%d:Çÿsg d©a\n", 
dma_ch
);

68 
imxdma
->
sgbc
 +
œ°cou¡
;

69 i‡((
imxdma
->
sgbc
 >imxdma->
sg
->
Àngth
Ë|| !imxdma->
ªsbyãs
) {

70 i‡((
imxdma
->
sgcou¡
 <1Ë|| !imxdma->
ªsbyãs
) {

71 
	`¥_debug
("imxdma%d: sgÅransferÜimitÑeached\n",

72 
dma_ch
);

73 
imxdma
->
sgcou¡
=0;

74 
imxdma
->
sg
 = 
NULL
;

77 
imxdma
->
sgcou¡
--;

78 
imxdma
->
sg
++;

79 
imxdma
->
sgbc
 = 0;

82 
√xtcou¡
 = 
imxdma
->
sg
->
Àngth
 - imxdma->
sgbc
;

83 
√xèddr
 = 
imxdma
->
sg
->
dma_addªss
 + imxdma->
sgbc
;

85 if(
imxdma
->
ªsbyãs
 < 
√xtcou¡
)

86 
√xtcou¡
 = 
imxdma
->
ªsbyãs
;

88 i‡((
imxdma
->
dma_mode
 & 
DMA_MODE_MASK
Ë=
DMA_MODE_READ
)

89 
	`DAR
(
dma_ch
Ë
√xèddr
;

91 
	`SAR
(
dma_ch
Ë
√xèddr
;

93 
	`CNTR
(
dma_ch
Ë
√xtcou¡
;

94 
	`¥_debug
("imxdma%d:Çext sg chunk dst 0x%08x, src 0x%08x, size 0x%08x\n",

95 
dma_ch
, 
	`DAR
(dma_ch), 
	`SAR
(dma_ch), 
	`CNTR
(dma_ch));

97  
√xtcou¡
;

98 
	}
}

110 
	$imx_dma_£tup_sg_ba£
(
imx_dmach_t
 
dma_ch
,

111 
sˇâîli°
 *
sg
, 
sgcou¡
)

113 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

115 
imxdma
->
sg
 = sg;

116 
imxdma
->
sgcou¡
 = sgcount;

117 
imxdma
->
sgbc
 = 0;

118  
	`imx_dma_sg_√xt
(
dma_ch
, 0);

119 
	}
}

139 
	$imx_dma_£tup_sögÀ
(
imx_dmach_t
 
dma_ch
, 
dma_addr_t
 
dma_addªss
,

140 
dma_Àngth
, 
dev_addr
,

141 
dmamode_t
 
dmamode
)

143 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

145 
imxdma
->
sg
 = 
NULL
;

146 
imxdma
->
sgcou¡
 = 0;

147 
imxdma
->
dma_mode
 = 
dmamode
;

148 
imxdma
->
ªsbyãs
 = 
dma_Àngth
;

150 i‡(!
dma_addªss
) {

151 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_singleÇulláddress\n",

152 
dma_ch
);

153  -
EINVAL
;

156 i‡(!
dma_Àngth
) {

157 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_single zeroÜength\n",

158 
dma_ch
);

159  -
EINVAL
;

162 i‡((
dmamode
 & 
DMA_MODE_MASK
Ë=
DMA_MODE_READ
) {

163 
	`¥_debug
("imxdma%d: mx_dma_setup_single2dev dma_addressg=0x%08x dma_length=%d dev_addr=0x%08x forÑead\n",

164 
dma_ch
, ()
dma_addªss
, 
dma_Àngth
,

165 
dev_addr
);

166 
	`SAR
(
dma_ch
Ë
dev_addr
;

167 
	`DAR
(
dma_ch
Ë()
dma_addªss
;

168 } i‡((
dmamode
 & 
DMA_MODE_MASK
Ë=
DMA_MODE_WRITE
) {

169 
	`¥_debug
("imxdma%d: mx_dma_setup_single2dev dma_addressg=0x%08x dma_length=%d dev_addr=0x%08x for write\n",

170 
dma_ch
, ()
dma_addªss
, 
dma_Àngth
,

171 
dev_addr
);

172 
	`SAR
(
dma_ch
Ë()
dma_addªss
;

173 
	`DAR
(
dma_ch
Ë
dev_addr
;

175 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_single bad dmamode\n",

176 
dma_ch
);

177  -
EINVAL
;

180 
	`CNTR
(
dma_ch
Ë
dma_Àngth
;

183 
	}
}

224 
	$imx_dma_£tup_sg
(
imx_dmach_t
 
dma_ch
,

225 
sˇâîli°
 *
sg
, 
sgcou¡
, 
dma_Àngth
,

226 
dev_addr
, 
dmamode_t
 
dmamode
)

228 
ªs
;

229 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

231 
imxdma
->
sg
 = 
NULL
;

232 
imxdma
->
sgcou¡
 = 0;

233 
imxdma
->
dma_mode
 = 
dmamode
;

234 
imxdma
->
ªsbyãs
 = 
dma_Àngth
;

236 i‡(!
sg
 || !
sgcou¡
) {

237 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_sgÉpty sgÜist\n",

238 
dma_ch
);

239  -
EINVAL
;

242 i‡(!
sg
->
Àngth
) {

243 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_sg zeroÜength\n",

244 
dma_ch
);

245  -
EINVAL
;

248 i‡((
dmamode
 & 
DMA_MODE_MASK
Ë=
DMA_MODE_READ
) {

249 
	`¥_debug
("imxdma%d: mx_dma_setup_sg2dev sg=%p sgcount=%dÅotalÜength=%d dev_addr=0x%08x forÑead\n",

250 
dma_ch
, 
sg
, 
sgcou¡
, 
dma_Àngth
, 
dev_addr
);

251 
	`SAR
(
dma_ch
Ë
dev_addr
;

252 } i‡((
dmamode
 & 
DMA_MODE_MASK
Ë=
DMA_MODE_WRITE
) {

253 
	`¥_debug
("imxdma%d: mx_dma_setup_sg2dev sg=%p sgcount=%dÅotalÜength=%d dev_addr=0x%08x for write\n",

254 
dma_ch
, 
sg
, 
sgcou¡
, 
dma_Àngth
, 
dev_addr
);

255 
	`DAR
(
dma_ch
Ë
dev_addr
;

257 
	`¥ötk
(
KERN_ERR
 "imxdma%d: imx_dma_setup_sg bad dmamode\n",

258 
dma_ch
);

259  -
EINVAL
;

262 
ªs
 = 
	`imx_dma_£tup_sg_ba£
(
dma_ch
, 
sg
, 
sgcou¡
);

263 i‡(
ªs
 <= 0) {

264 
	`¥ötk
(
KERN_ERR
 "imxdma%d:Çÿsg chunkÑódy\n", 
dma_ch
);

265  -
EINVAL
;

269 
	}
}

281 
imx_dma_£tup_h™dÀrs
(
imx_dmach_t
 
dma_ch
,

282 (*
úq_h™dÀr
) (, *),

283 (*
îr_h™dÀr
) (, *, ),

284 *
d©a
)

286 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

287 
Êags
;

289 i‡(!
imxdma
->
«me
) {

290 
	`¥ötk
(
KERN_CRIT
 "%s: called forÇotállocated channel %d\n",

291 
__FUNCTION__
, 
dma_ch
);

292  -
ENODEV
;

295 
	`loˇl_úq_ßve
(
Êags
);

296 
DISR
 = (1 << 
dma_ch
);

297 
imxdma
->
úq_h™dÀr
 = irq_handler;

298 
imxdma
->
îr_h™dÀr
 =Érr_handler;

299 
imxdma
->
d©a
 = data;

300 
	`loˇl_úq_ª°‹e
(
Êags
);

302 
	}
}

315 
	$imx_dma_íabÀ
(
imx_dmach_t
 
dma_ch
)

317 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

318 
Êags
;

320 
	`¥_debug
("imxdma%d: imx_dma_íabÀ\n", 
dma_ch
);

322 i‡(!
imxdma
->
«me
) {

323 
	`¥ötk
(
KERN_CRIT
 "%s: called forÇotállocated channel %d\n",

324 
__FUNCTION__
, 
dma_ch
);

328 
	`loˇl_úq_ßve
(
Êags
);

329 
DISR
 = (1 << 
dma_ch
);

330 
DIMR
 &~(1 << 
dma_ch
);

331 
	`CCR
(
dma_ch
Ë|
CCR_CEN
;

332 
	`loˇl_úq_ª°‹e
(
Êags
);

333 
	}
}

339 
	$imx_dma_dißbÀ
(
imx_dmach_t
 
dma_ch
)

341 
Êags
;

343 
	`¥_debug
("imxdma%d: imx_dma_dißbÀ\n", 
dma_ch
);

345 
	`loˇl_úq_ßve
(
Êags
);

346 
DIMR
 |(1 << 
dma_ch
);

347 
	`CCR
(
dma_ch
Ë&~
CCR_CEN
;

348 
DISR
 = (1 << 
dma_ch
);

349 
	`loˇl_úq_ª°‹e
(
Êags
);

350 
	}
}

357 
	$imx_dma_ªque°
(
imx_dmach_t
 
dma_ch
, c⁄° *
«me
)

359 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

360 
Êags
;

363 i‡(!
«me
)

364  -
EINVAL
;

366 i‡(
dma_ch
 >
IMX_DMA_CHANNELS
) {

367 
	`¥ötk
(
KERN_CRIT
 "%s: called forÇon-existed channel %d\n",

368 
__FUNCTION__
, 
dma_ch
);

369  -
EINVAL
;

372 
	`loˇl_úq_ßve
(
Êags
);

373 i‡(
imxdma
->
«me
) {

374 
	`loˇl_úq_ª°‹e
(
Êags
);

375  -
ENODEV
;

378 
imxdma
->
«me
 =Çame;

379 
imxdma
->
úq_h™dÀr
 = 
NULL
;

380 
imxdma
->
îr_h™dÀr
 = 
NULL
;

381 
imxdma
->
d©a
 = 
NULL
;

382 
imxdma
->
sg
 = 
NULL
;

383 
	`loˇl_úq_ª°‹e
(
Êags
);

385 
	}
}

391 
	$imx_dma_‰ì
(
imx_dmach_t
 
dma_ch
)

393 
Êags
;

394 
imx_dma_ch™√l
 *
imxdma
 = &
imx_dma_ch™√ls
[
dma_ch
];

396 i‡(!
imxdma
->
«me
) {

397 
	`¥ötk
(
KERN_CRIT


399 
__FUNCTION__
, 
dma_ch
);

403 
	`loˇl_úq_ßve
(
Êags
);

405 
DIMR
 |(1 << 
dma_ch
);

406 
	`CCR
(
dma_ch
Ë&~
CCR_CEN
;

407 
imxdma
->
«me
 = 
NULL
;

408 
	`loˇl_úq_ª°‹e
(
Êags
);

409 
	}
}

426 
	$imx_dma_ªque°_by_¥io
(
imx_dmach_t
 * 
pdma_ch
, c⁄° *
«me
,

427 
imx_dma_¥io
 
¥io
)

429 
i
;

430 
be°
;

432 
¥io
) {

433 (
DMA_PRIO_HIGH
):

434 
be°
 = 8;

436 (
DMA_PRIO_MEDIUM
):

437 
be°
 = 4;

439 (
DMA_PRIO_LOW
):

441 
be°
 = 0;

445 
i
 = 
be°
; i < 
IMX_DMA_CHANNELS
; i++) {

446 i‡(!
	`imx_dma_ªque°
(
i
, 
«me
)) {

447 *
pdma_ch
 = 
i
;

452 
i
 = 
be°
 - 1; i >= 0; i--) {

453 i‡(!
	`imx_dma_ªque°
(
i
, 
«me
)) {

454 *
pdma_ch
 = 
i
;

459 
	`¥ötk
(
KERN_ERR
 "%s:Çÿ‰ì DMA ch™√»found\n", 
__FUNCTION__
);

461  -
ENODEV
;

462 
	}
}

464 
úqªtu∫_t
 
	$dma_îr_h™dÀr
(
úq
, *
dev_id
)

466 
i
, 
di§
 = 
DISR
;

467 
imx_dma_ch™√l
 *
ch™√l
;

468 
îr_mask
 = 
DBTOSR
 | 
DRTOSR
 | 
DSESR
 | 
DBOSR
;

469 
îrcode
;

471 
DISR
 = 
di§
 & 
îr_mask
;

472 
i
 = 0; i < 
IMX_DMA_CHANNELS
; i++) {

473 if(!(
îr_mask
 & (1 << 
i
)))

475 
ch™√l
 = &
imx_dma_ch™√ls
[
i
];

476 
îrcode
 = 0;

478 i‡(
DBTOSR
 & (1 << 
i
)) {

479 
DBTOSR
 = (1 << 
i
);

480 
îrcode
 |
IMX_DMA_ERR_BURST
;

482 i‡(
DRTOSR
 & (1 << 
i
)) {

483 
DRTOSR
 = (1 << 
i
);

484 
îrcode
 |
IMX_DMA_ERR_REQUEST
;

486 i‡(
DSESR
 & (1 << 
i
)) {

487 
DSESR
 = (1 << 
i
);

488 
îrcode
 |
IMX_DMA_ERR_TRANSFER
;

490 i‡(
DBOSR
 & (1 << 
i
)) {

491 
DBOSR
 = (1 << 
i
);

492 
îrcode
 |
IMX_DMA_ERR_BUFFER
;

502 i‡(
ch™√l
->
«me
 && ch™√l->
îr_h™dÀr
) {

503 
ch™√l
->
	`îr_h™dÀr
(
i
, ch™√l->
d©a
, 
îrcode
);

507 
imx_dma_ch™√ls
[
i
].
sg
 = 
NULL
;

509 
	`¥ötk
(
KERN_WARNING


511 
i
, 
ch™√l
->
«me
,

512 
îrcode
&
IMX_DMA_ERR_BURST
? " burst":"",

513 
îrcode
&
IMX_DMA_ERR_REQUEST
? "Ñequest":"",

514 
îrcode
&
IMX_DMA_ERR_TRANSFER
? "Åransfer":"",

515 
îrcode
&
IMX_DMA_ERR_BUFFER
? " buffer":"");

517  
IRQ_HANDLED
;

518 
	}
}

520 
úqªtu∫_t
 
	$dma_úq_h™dÀr
(
úq
, *
dev_id
)

522 
i
, 
di§
 = 
DISR
;

524 
	`¥_debug
("imxdma: dma_irq_handler called, disr=0x%08x\n",

525 
di§
);

527 
DISR
 = 
di§
;

528 
i
 = 0; i < 
IMX_DMA_CHANNELS
; i++) {

529 i‡(
di§
 & (1 << 
i
)) {

530 
imx_dma_ch™√l
 *
ch™√l
 = &
imx_dma_ch™√ls
[
i
];

531 i‡(
ch™√l
->
«me
) {

532 i‡(
	`imx_dma_sg_√xt
(
i
, 
	`CNTR
(i))) {

533 
	`CCR
(
i
Ë&~
CCR_CEN
;

534 
	`mb
();

535 
	`CCR
(
i
Ë|
CCR_CEN
;

537 i‡(
ch™√l
->
úq_h™dÀr
)

538 
ch™√l
->
	`úq_h™dÀr
(
i
,

539 
ch™√l
->
d©a
);

546 
	`¥ötk
(
KERN_WARNING


547 "•uriou†IRQ f‹ DMA ch™√»%d\n", 
i
);

551  
IRQ_HANDLED
;

552 
	}
}

554 
__öô
 
	$imx_dma_öô
()

556 
ªt
;

557 
i
;

560 
DCR
 = 
DCR_DRST
;

562 
ªt
 = 
	`ªque°_úq
(
DMA_INT
, 
dma_úq_h™dÀr
, 0, "DMA", 
NULL
);

563 i‡(
ªt
) {

564 
	`¥ötk
(
KERN_CRIT
 "Wow! Can'tÑegister IRQ for DMA\n");

565  
ªt
;

568 
ªt
 = 
	`ªque°_úq
(
DMA_ERR
, 
dma_îr_h™dÀr
, 0, "DMA", 
NULL
);

569 i‡(
ªt
) {

570 
	`¥ötk
(
KERN_CRIT
 "Wow! Can'tÑegister ERRIRQ for DMA\n");

571 
	`‰ì_úq
(
DMA_INT
, 
NULL
);

575 
DCR
 = 
DCR_DEN
;

578 
DISR
 = (1 << 
IMX_DMA_CHANNELS
) - 1;

581 
DIMR
 = (1 << 
IMX_DMA_CHANNELS
) - 1;

583 
i
 = 0; i < 
IMX_DMA_CHANNELS
; i++) {

584 
imx_dma_ch™√ls
[
i
].
sg
 = 
NULL
;

585 
imx_dma_ch™√ls
[
i
].
dma_num
 = i;

588  
ªt
;

589 
	}
}

591 
¨ch_öôˇŒ
(
imx_dma_öô
);

593 
EXPORT_SYMBOL
(
imx_dma_£tup_sögÀ
);

594 
EXPORT_SYMBOL
(
imx_dma_£tup_sg
);

595 
EXPORT_SYMBOL
(
imx_dma_£tup_h™dÀrs
);

596 
EXPORT_SYMBOL
(
imx_dma_íabÀ
);

597 
EXPORT_SYMBOL
(
imx_dma_dißbÀ
);

598 
EXPORT_SYMBOL
(
imx_dma_ªque°
);

599 
EXPORT_SYMBOL
(
imx_dma_‰ì
);

600 
EXPORT_SYMBOL
(
imx_dma_ªque°_by_¥io
);

601 
EXPORT_SYMBOL
(
imx_dma_ch™√ls
);

	@arch/arm/mach-imx/generic.c

25 
	~<löux/∂©f‹m_devi˚.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/kî√l.h
>

28 
	~<löux/moduÀ.h
>

29 
	~<löux/°rög.h
>

31 
	~<asm/¨ch/imxfb.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/¨ch/imx-ªgs.h
>

35 
	~<asm/mach/m≠.h
>

36 
	~<asm/¨ch/mmc.h
>

38 
	$imx_gpio_mode
(
gpio_mode
)

40 
pö
 = 
gpio_mode
 & 
GPIO_PIN_MASK
;

41 
p‹t
 = (
gpio_mode
 & 
GPIO_PORT_MASK
Ë>> 
GPIO_PORT_SHIFT
;

42 
o¸
 = (
gpio_mode
 & 
GPIO_OCR_MASK
Ë>> 
GPIO_OCR_SHIFT
;

43 
tmp
;

46 if(
gpio_mode
 & 
GPIO_PUEN
)

47 
	`PUEN
(
p‹t
Ë|(1<<
pö
);

49 
	`PUEN
(
p‹t
Ë&~(1<<
pö
);

52 if(
gpio_mode
 & 
GPIO_OUT
)

53 
	`DDIR
(
p‹t
Ë|1<<
pö
;

55 
	`DDIR
(
p‹t
Ë&~(1<<
pö
);

58 if(
gpio_mode
 & 
GPIO_AF
)

59 
	`GPR
(
p‹t
Ë|(1<<
pö
);

61 
	`GPR
(
p‹t
Ë&~(1<<
pö
);

64 if(
gpio_mode
 & 
GPIO_GIUS
)

65 
	`GIUS
(
p‹t
Ë|(1<<
pö
);

67 
	`GIUS
(
p‹t
Ë&~(1<<
pö
);

73 if(
pö
<16) {

74 
tmp
 = 
	`OCR1
(
p‹t
);

75 
tmp
 &~–3<<(
pö
*2));

76 
tmp
 |(
o¸
 << (
pö
*2));

77 
	`OCR1
(
p‹t
Ë
tmp
;

79 
	`ICONFA1
(
p‹t
Ë&~–3<<(
pö
*2));

80 
	`ICONFA1
(
p‹t
Ë|((
gpio_mode
 >> 
GPIO_AOUT_SHIFT
Ë& 3Ë<< (
pö
 * 2);

81 
	`ICONFB1
(
p‹t
Ë&~–3<<(
pö
*2));

82 
	`ICONFB1
(
p‹t
Ë|((
gpio_mode
 >> 
GPIO_BOUT_SHIFT
Ë& 3Ë<< (
pö
 * 2);

84 
tmp
 = 
	`OCR2
(
p‹t
);

85 
tmp
 &~–3<<((
pö
-16)*2));

86 
tmp
 |(
o¸
 << ((
pö
-16)*2));

87 
	`OCR2
(
p‹t
Ë
tmp
;

89 
	`ICONFA2
(
p‹t
Ë&~–3<<((
pö
-16)*2));

90 
	`ICONFA2
(
p‹t
Ë|((
gpio_mode
 >> 
GPIO_AOUT_SHIFT
Ë& 3Ë<< ((
pö
-16) * 2);

91 
	`ICONFB2
(
p‹t
Ë&~–3<<((
pö
-16)*2));

92 
	`ICONFB2
(
p‹t
Ë|((
gpio_mode
 >> 
GPIO_BOUT_SHIFT
Ë& 3Ë<< ((
pö
-16) * 2);

94 
	}
}

96 
EXPORT_SYMBOL
(
imx_gpio_mode
);

105 
	$imx_decode_∂l
(
∂l
, 
u32
 
f_ªf
)

107 
Œ
;

108 
quŸ
;

110 
u32
 
mfi
 = (
∂l
 >> 10) & 0xf;

111 
u32
 
m‚
 = 
∂l
 & 0x3ff;

112 
u32
 
mfd
 = (
∂l
 >> 16) & 0x3ff;

113 
u32
 
pd
 = (
∂l
 >> 26) & 0xf;

115 
mfi
 = mfi <= 5 ? 5 : mfi;

117 
Œ
 = 2 * ()
f_ªf
 * ( (
mfi
<<16Ë+ (
m‚
<<16Ë/ (
mfd
+1) );

118 
quŸ
 = (
pd
+1) * (1<<16);

119 
Œ
 +
quŸ
 / 2;

120 
	`do_div
(
Œ
, 
quŸ
);

121  (Ë
Œ
;

122 
	}
}

124 
	$imx_gë_sy°em_˛k
()

126 
u32
 
f_ªf
 = (
CSCR
 & 
CSCR_SYSTEM_SEL
Ë? 16000000 : (
CLK32
 * 512);

128  
	`imx_decode_∂l
(
SPCTL0
, 
f_ªf
);

129 
	}
}

130 
EXPORT_SYMBOL
(
imx_gë_sy°em_˛k
);

132 
	$imx_gë_mcu_˛k
()

134  
	`imx_decode_∂l
(
MPCTL0
, 
CLK32
 * 512);

135 
	}
}

136 
EXPORT_SYMBOL
(
imx_gë_mcu_˛k
);

141 
	$imx_gë_≥r˛k1
()

143  
	`imx_gë_sy°em_˛k
(Ë/ (((
PCDR
) & 0xf)+1);

144 
	}
}

145 
EXPORT_SYMBOL
(
imx_gë_≥r˛k1
);

150 
	$imx_gë_≥r˛k2
()

152  
	`imx_gë_sy°em_˛k
(Ë/ (((
PCDR
>>4) & 0xf)+1);

153 
	}
}

154 
EXPORT_SYMBOL
(
imx_gë_≥r˛k2
);

159 
	$imx_gë_≥r˛k3
()

161  
	`imx_gë_sy°em_˛k
(Ë/ (((
PCDR
>>16) & 0x7f)+1);

162 
	}
}

163 
EXPORT_SYMBOL
(
imx_gë_≥r˛k3
);

168 
	$imx_gë_h˛k
()

170  
	`imx_gë_sy°em_˛k
(Ë/ (((
CSCR
>>10) & 0xf)+1);

171 
	}
}

172 
EXPORT_SYMBOL
(
imx_gë_h˛k
);

174 
ªsour˚
 
	gimx_mmc_ªsour˚s
[] = {

176 .
°¨t
 = 0x00214000,

177 .
	gíd
 = 0x002140FF,

178 .
	gÊags
 = 
IORESOURCE_MEM
,

181 .
°¨t
 = (
SDHC_INT
),

182 .
	gíd
 = (
SDHC_INT
),

183 .
	gÊags
 = 
IORESOURCE_IRQ
,

187 
u64
 
	gimxmmmc_dmamask
 = 0xffffffffUL;

189 
∂©f‹m_devi˚
 
	gimx_mmc_devi˚
 = {

190 .
«me
 = "imx-mmc",

191 .
	gid
 = 0,

192 .
	gdev
 = {

193 .
dma_mask
 = &
imxmmmc_dmamask
,

194 .
	gcohîít_dma_mask
 = 0xffffffff,

196 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
imx_mmc_ªsour˚s
),

197 .
	gªsour˚
 = 
imx_mmc_ªsour˚s
,

200 
__öô
 
	$imx_£t_mmc_öfo
(
imxmmc_∂©f‹m_d©a
 *
öfo
)

202 
imx_mmc_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

203 
	}
}

205 
imxfb_mach_öfo
 
	gimx_fb_öfo
;

207 
__öô
 
	$£t_imx_fb_öfo
(
imxfb_mach_öfo
 *
h¨d_imx_fb_öfo
)

209 
	`mem˝y
(&
imx_fb_öfo
,
h¨d_imx_fb_öfo
,(
imxfb_mach_öfo
));

210 
	}
}

211 
EXPORT_SYMBOL
(
£t_imx_fb_öfo
);

213 
ªsour˚
 
	gimxfb_ªsour˚s
[] = {

215 .
°¨t
 = 0x00205000,

216 .
	gíd
 = 0x002050FF,

217 .
	gÊags
 = 
IORESOURCE_MEM
,

220 .
°¨t
 = 
LCDC_INT
,

221 .
	gíd
 = 
LCDC_INT
,

222 .
	gÊags
 = 
IORESOURCE_IRQ
,

226 
u64
 
	gfb_dma_mask
 = ~(u64)0;

228 
∂©f‹m_devi˚
 
	gimxfb_devi˚
 = {

229 .
«me
 = "imx-fb",

230 .
	gid
 = 0,

231 .
	gdev
 = {

232 .
∂©f‹m_d©a
 = &
imx_fb_öfo
,

233 .
	gdma_mask
 = &
fb_dma_mask
,

234 .
	gcohîít_dma_mask
 = 0xffffffff,

236 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
imxfb_ªsour˚s
),

237 .
	gªsour˚
 = 
imxfb_ªsour˚s
,

240 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

241 &
imx_mmc_devi˚
,

242 &
imxfb_devi˚
,

245 
m≠_desc
 
	gimx_io_desc
[] 
	g__öôd©a
 = {

247 .
vútuÆ
 = 
IMX_IO_BASE
,

248 .
	gp‚
 = 
__phys_to_p‚
(
IMX_IO_PHYS
),

249 .
	gÀngth
 = 
IMX_IO_SIZE
,

250 .
	gty≥
 = 
MT_DEVICE


254 
__öô


255 
	$imx_m≠_io
()

257 
	`iŸabÀ_öô
(
imx_io_desc
, 
	`ARRAY_SIZE
(imx_io_desc));

258 
	}
}

260 
__öô
 
	$imx_öô
()

262  
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

263 
	}
}

265 
subsys_öôˇŒ
(
imx_öô
);

	@arch/arm/mach-imx/generic.h

12 
__öô
 
imx_m≠_io
();

13 
__öô
 
imx_öô_úq
();

15 
	gsys_timî
;

16 
sys_timî
 
imx_timî
;

	@arch/arm/mach-imx/irq.c

26 
	~<löux/öô.h
>

27 
	~<löux/li°.h
>

28 
	~<löux/timî.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/úq.h
>

32 
	~<asm/io.h
>

34 
	~<asm/mach/úq.h
>

46 
	#INTENNUM_OFF
 0x8

	)

47 
	#INTDISNUM_OFF
 0xC

	)

49 
	#VA_AITC_BASE
 
	`IO_ADDRESS
(
IMX_AITC_BASE
)

	)

50 
	#IMX_AITC_INTDISNUM
 (
VA_AITC_BASE
 + 
INTDISNUM_OFF
)

	)

51 
	#IMX_AITC_INTENNUM
 (
VA_AITC_BASE
 + 
INTENNUM_OFF
)

	)

54 
	#DEBUG_IRQ
(
fmt
...Ë
	`¥ötk
(fmt)

	)

56 
	#DEBUG_IRQ
(
fmt
...Ëdÿ{ } 0)

	)

60 
	$imx_mask_úq
(
úq
)

62 
	`__øw_wrôñ
(
úq
, 
IMX_AITC_INTDISNUM
);

63 
	}
}

66 
	$imx_unmask_úq
(
úq
)

68 
	`__øw_wrôñ
(
úq
, 
IMX_AITC_INTENNUM
);

69 
	}
}

72 
	$imx_gpio_úq_ty≥
(
_úq
, 
ty≥
)

74 
úq_ty≥
 = 0, 
úq
, 
ªg
, 
bô
;

76 
úq
 = 
_úq
 - 
	`IRQ_GPIOA
(0);

77 
ªg
 = 
úq
 >> 5;

78 
bô
 = 1 << (
úq
 % 32);

80 i‡(
ty≥
 =
IRQT_PROBE
) {

92 
	`GIUS
(
ªg
Ë|
bô
;

93 
	`DDIR
(
ªg
Ë&~(
bô
);

95 
	`DEBUG_IRQ
("£âögÅy≥ o‡úq %dÅÿ", 
_úq
);

97 i‡(
ty≥
 & 
__IRQT_RISEDGE
) {

98 
	`DEBUG_IRQ
("risingÉdges\n");

99 
úq_ty≥
 = 0x0;

101 i‡(
ty≥
 & 
__IRQT_FALEDGE
) {

102 
	`DEBUG_IRQ
("fallingÉdges\n");

103 
úq_ty≥
 = 0x1;

105 i‡(
ty≥
 & 
__IRQT_LOWLVL
) {

106 
	`DEBUG_IRQ
("lowÜevel\n");

107 
úq_ty≥
 = 0x3;

109 i‡(
ty≥
 & 
__IRQT_HIGHLVL
) {

110 
	`DEBUG_IRQ
("highÜevel\n");

111 
úq_ty≥
 = 0x2;

114 i‡(
úq
 % 32 < 16) {

115 
	`ICR1
(
ªg
Ë(ICR1‘egË& ~(0x3 << ((
úq
 % 16) * 2))) |

116 (
úq_ty≥
 << ((
úq
 % 16) * 2));

118 
	`ICR2
(
ªg
Ë(ICR2‘egË& ~(0x3 << ((
úq
 % 16) * 2))) |

119 (
úq_ty≥
 << ((
úq
 % 16) * 2));

124 
	}
}

127 
	$imx_gpio_ack_úq
(
úq
)

129 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
úq
);

130 
	`ISR
(
	`IRQ_TO_REG
(
úq
)Ë1 << ((úq - 
	`IRQ_GPIOA
(0)) % 32);

131 
	}
}

134 
	$imx_gpio_mask_úq
(
úq
)

136 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
úq
);

137 
	`IMR
(
	`IRQ_TO_REG
(
úq
)Ë&~–1 << ((úq - 
	`IRQ_GPIOA
(0)) % 32));

138 
	}
}

141 
	$imx_gpio_unmask_úq
(
úq
)

143 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
úq
);

144 
	`IMR
(
	`IRQ_TO_REG
(
úq
)Ë|1 << ((úq - 
	`IRQ_GPIOA
(0)) % 32);

145 
	}
}

148 
	$imx_gpio_h™dÀr
(
mask
, 
úq
,

149 
úq_desc
 *
desc
)

151 
desc
 = 
úq_desc
 + 
úq
;

152 
mask
) {

153 i‡(
mask
 & 1) {

154 
	`DEBUG_IRQ
("h™dlög irq %d\n", 
úq
);

155 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

157 
úq
++;

158 
desc
++;

159 
mask
 >>= 1;

161 
	}
}

164 
	$imx_gpiﬂ_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

166 
mask
, 
úq
;

168 
mask
 = 
	`ISR
(0);

169 
úq
 = 
	`IRQ_GPIOA
(0);

170 
	`imx_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

171 
	}
}

174 
	$imx_gpiob_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

176 
mask
, 
úq
;

178 
mask
 = 
	`ISR
(1);

179 
úq
 = 
	`IRQ_GPIOB
(0);

180 
	`imx_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

181 
	}
}

184 
	$imx_gpioc_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

186 
mask
, 
úq
;

188 
mask
 = 
	`ISR
(2);

189 
úq
 = 
	`IRQ_GPIOC
(0);

190 
	`imx_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

191 
	}
}

194 
	$imx_gpiod_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

196 
mask
, 
úq
;

198 
mask
 = 
	`ISR
(3);

199 
úq
 = 
	`IRQ_GPIOD
(0);

200 
	`imx_gpio_h™dÀr
(
mask
, 
úq
, 
desc
);

201 
	}
}

203 
úq_chù
 
	gimx_öã∫Æ_chù
 = {

204 .
«me
 = "MPU",

205 .
	gack
 = 
imx_mask_úq
,

206 .
	gmask
 = 
imx_mask_úq
,

207 .
	gunmask
 = 
imx_unmask_úq
,

210 
úq_chù
 
	gimx_gpio_chù
 = {

211 .
«me
 = "GPIO",

212 .
	gack
 = 
imx_gpio_ack_úq
,

213 .
	gmask
 = 
imx_gpio_mask_úq
,

214 .
	gunmask
 = 
imx_gpio_unmask_úq
,

215 .
	g£t_ty≥
 = 
imx_gpio_úq_ty≥
,

218 
__öô


219 
	$imx_öô_úq
()

221 
úq
;

223 
	`DEBUG_IRQ
("Initializing imx interrupts\n");

226 
	`IMR
(0) = 0;

227 
	`IMR
(1) = 0;

228 
	`IMR
(2) = 0;

229 
	`IMR
(3) = 0;

231 
úq
 = 0; irq < 
IMX_IRQS
; irq++) {

232 
	`£t_úq_chù
(
úq
, &
imx_öã∫Æ_chù
);

233 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

234 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

237 
úq
 = 
	`IRQ_GPIOA
(0); irq < 
	`IRQ_GPIOD
(32); irq++) {

238 
	`£t_úq_chù
(
úq
, &
imx_gpio_chù
);

239 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

240 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

243 
	`£t_úq_chaöed_h™dÀr
(
GPIO_INT_PORTA
, 
imx_gpiﬂ_demux_h™dÀr
);

244 
	`£t_úq_chaöed_h™dÀr
(
GPIO_INT_PORTB
, 
imx_gpiob_demux_h™dÀr
);

245 
	`£t_úq_chaöed_h™dÀr
(
GPIO_INT_PORTC
, 
imx_gpioc_demux_h™dÀr
);

246 
	`£t_úq_chaöed_h™dÀr
(
GPIO_INT_PORTD
, 
imx_gpiod_demux_h™dÀr
);

250 
	}
}

	@arch/arm/mach-imx/leds-mx1ads.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/sy°em.h
>

18 
	~<asm/io.h
>

19 
	~<asm/Àds.h
>

20 
	~"Àds.h
"

28 
	$mx1ads_Àds_evít
(
Àd_evít_t
 
Àdevt
)

30 
Êags
;

32 
	`loˇl_úq_ßve
(
Êags
);

34 
Àdevt
) {

35 #ifde‡
CONFIG_LEDS_CPU


36 
Àd_idÀ_°¨t
:

37 
	`DR
(0) &= ~(1<<2);

40 
Àd_idÀ_íd
:

41 
	`DR
(0) |= 1<<2;

45 #ifde‡
CONFIG_LEDS_TIMER


46 
Àd_timî
:

47 
	`DR
(0) ^= 1<<2;

52 
	`loˇl_úq_ª°‹e
(
Êags
);

53 
	}
}

	@arch/arm/mach-imx/leds.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

16 
	~<asm/Àds.h
>

17 
	~<asm/mach-ty≥s.h
>

19 
	~"Àds.h
"

21 
__öô


22 
	$Àds_öô
()

24 i‡(
	`machöe_is_mx1ads
()) {

25 
Àds_evít
 = 
mx1ads_Àds_evít
;

29 
	}
}

31 
__öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-imx/leds.h

9 
mx1ads_Àds_evít
(
Àd_evít_t
 
evt
);

	@arch/arm/mach-imx/mx1ads.c

15 
	~<löux/devi˚.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/úq.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/∑ge.h
>

24 
	~<asm/mach/m≠.h
>

25 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/mach/¨ch.h
>

28 
	~<asm/¨ch/mmc.h
>

29 
	~<asm/¨ch/imx-u¨t.h
>

30 
	~<löux/öãºu±.h
>

31 
	~"gíîic.h
"

33 
ªsour˚
 
	gcs89x0_ªsour˚s
[] = {

35 .
°¨t
 = 
IMX_CS4_PHYS
 + 0x300,

36 .
	gíd
 = 
IMX_CS4_PHYS
 + 0x300 + 16,

37 .
	gÊags
 = 
IORESOURCE_MEM
,

40 .
°¨t
 = 
IRQ_GPIOC
(17),

41 .
	gíd
 = 
IRQ_GPIOC
(17),

42 .
	gÊags
 = 
IORESOURCE_IRQ
,

46 
∂©f‹m_devi˚
 
	gcs89x0_devi˚
 = {

47 .
«me
 = "cirrus-cs89x0",

48 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
cs89x0_ªsour˚s
),

49 .
	gªsour˚
 = 
cs89x0_ªsour˚s
,

52 
imxu¨t_∂©f‹m_d©a
 
	gu¨t_pd©a
 = {

53 .
Êags
 = 
IMXUART_HAVE_RTSCTS
,

56 
ªsour˚
 
	gimx_u¨t1_ªsour˚s
[] = {

58 .
°¨t
 = 0x00206000,

59 .
	gíd
 = 0x002060FF,

60 .
	gÊags
 = 
IORESOURCE_MEM
,

63 .
°¨t
 = (
UART1_MINT_RX
),

64 .
	gíd
 = (
UART1_MINT_RX
),

65 .
	gÊags
 = 
IORESOURCE_IRQ
,

68 .
°¨t
 = (
UART1_MINT_TX
),

69 .
	gíd
 = (
UART1_MINT_TX
),

70 .
	gÊags
 = 
IORESOURCE_IRQ
,

74 
∂©f‹m_devi˚
 
	gimx_u¨t1_devi˚
 = {

75 .
«me
 = "imx-uart",

76 .
	gid
 = 0,

77 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
imx_u¨t1_ªsour˚s
),

78 .
	gªsour˚
 = 
imx_u¨t1_ªsour˚s
,

79 .
	gdev
 = {

80 .
∂©f‹m_d©a
 = &
u¨t_pd©a
,

84 
ªsour˚
 
	gimx_u¨t2_ªsour˚s
[] = {

86 .
°¨t
 = 0x00207000,

87 .
	gíd
 = 0x002070FF,

88 .
	gÊags
 = 
IORESOURCE_MEM
,

91 .
°¨t
 = (
UART2_MINT_RX
),

92 .
	gíd
 = (
UART2_MINT_RX
),

93 .
	gÊags
 = 
IORESOURCE_IRQ
,

96 .
°¨t
 = (
UART2_MINT_TX
),

97 .
	gíd
 = (
UART2_MINT_TX
),

98 .
	gÊags
 = 
IORESOURCE_IRQ
,

102 
∂©f‹m_devi˚
 
	gimx_u¨t2_devi˚
 = {

103 .
«me
 = "imx-uart",

104 .
	gid
 = 1,

105 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
imx_u¨t2_ªsour˚s
),

106 .
	gªsour˚
 = 
imx_u¨t2_ªsour˚s
,

107 .
	gdev
 = {

108 .
∂©f‹m_d©a
 = &
u¨t_pd©a
,

112 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

113 &
cs89x0_devi˚
,

114 &
imx_u¨t1_devi˚
,

115 &
imx_u¨t2_devi˚
,

118 #ifde‡
CONFIG_MMC_IMX


119 
	$mx1ads_mmc_ˇrd_¥e£¡
()

122  (
	`SSR
(1) & (1 << 20) ? 0 : 1);

123 
	}
}

125 
imxmmc_∂©f‹m_d©a
 
	gmx1ads_mmc_öfo
 = {

126 .
ˇrd_¥e£¡
 = 
mx1ads_mmc_ˇrd_¥e£¡
,

130 
__öô


131 
	$mx1ads_öô
()

133 #ifde‡
CONFIG_LEDS


134 
	`imx_gpio_mode
(
GPIO_PORTA
 | 
GPIO_OUT
 | 2);

136 #ifde‡
CONFIG_MMC_IMX


138 
	`imx_gpio_mode
(
GPIO_PORTB
 | 
GPIO_GIUS
 | 
GPIO_IN
 | 20);

139 
	`imx_£t_mmc_öfo
(&
mx1ads_mmc_öfo
);

142 
	`imx_gpio_mode
(
PC9_PF_UART1_CTS
);

143 
	`imx_gpio_mode
(
PC10_PF_UART1_RTS
);

144 
	`imx_gpio_mode
(
PC11_PF_UART1_TXD
);

145 
	`imx_gpio_mode
(
PC12_PF_UART1_RXD
);

147 
	`imx_gpio_mode
(
PB28_PF_UART2_CTS
);

148 
	`imx_gpio_mode
(
PB29_PF_UART2_RTS
);

149 
	`imx_gpio_mode
(
PB30_PF_UART2_TXD
);

150 
	`imx_gpio_mode
(
PB31_PF_UART2_RXD
);

152 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

153 
	}
}

155 
__öô


156 
	$mx1ads_m≠_io
()

158 
	`imx_m≠_io
();

159 
	}
}

161 
MACHINE_START
(
MX1ADS
, "Motorola MX1ADS")

163 .
	gphys_io
 = 0x00200000,

164 .
	gio_pg_off°
 = ((0xe0000000) >> 18) & 0xfffc,

165 .
	gboŸ_∑øms
 = 0x08000100,

166 .
	gm≠_io
 = 
mx1ads_m≠_io
,

167 .
	göô_úq
 = 
imx_öô_úq
,

168 .
	gtimî
 = &
imx_timî
,

169 .
	göô_machöe
 = 
mx1ads_öô
,

170 
	gMACHINE_END


	@arch/arm/mach-imx/time.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/sched.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/úq.h
>

16 
	~<löux/time.h
>

17 
	~<löux/˛ocksour˚.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/io.h
>

21 
	~<asm/Àds.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mach/time.h
>

26 
	#TIMER_BASE
 
IMX_TIM1_BASE


	)

28 
	gevt_diff
;

33 
úqªtu∫_t


34 
	$imx_timî_öãºu±
(
úq
, *
dev_id
)

36 
uöt32_t
 
t°©
;

39 
t°©
 = 
	`IMX_TSTAT
(
TIMER_BASE
);

40 
	`IMX_TSTAT
(
TIMER_BASE
) = 0;

42 i‡(
t°©
 & 
TSTAT_COMP
) {

45 
	`wrôe_£qlock
(&
xtime_lock
);

46 
	`timî_tick
();

47 
	`wrôe_£qu∆ock
(&
xtime_lock
);

48 
	`IMX_TCMP
(
TIMER_BASE
Ë+
evt_diff
;

50 } 
	`u∆ikñy
((
öt32_t
)(
	`IMX_TCMP
(
TIMER_BASE
)

51 - 
	`IMX_TCN
(
TIMER_BASE
)) < 0));

54  
IRQ_HANDLED
;

55 
	}
}

57 
úqa˘i⁄
 
	gimx_timî_úq
 = {

58 .
«me
 = "i.MX Timer Tick",

59 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

60 .
	gh™dÀr
 = 
imx_timî_öãºu±
,

66 
__öô
 
	$imx_timî_h¨dw¨e_öô
()

71 
	`IMX_TCTL
(
TIMER_BASE
) = 0;

72 
	`IMX_TPRER
(
TIMER_BASE
) = 0;

73 
	`IMX_TCMP
(
TIMER_BASE
Ë
LATCH
 - 1;

75 
	`IMX_TCTL
(
TIMER_BASE
Ë
TCTL_FRR
 | 
TCTL_CLK_PCLK1
 | 
TCTL_IRQEN
 | 
TCTL_TEN
;

76 
evt_diff
 = 
LATCH
;

77 
	}
}

79 
cy˛e_t
 
	$imx_gë_cy˛es
()

81  
	`IMX_TCN
(
TIMER_BASE
);

82 
	}
}

84 
˛ocksour˚
 
	g˛ocksour˚_imx
 = {

85 .
«me
 = "imx_timer1",

86 .
	gøtög
 = 200,

87 .
	gªad
 = 
imx_gë_cy˛es
,

88 .
	gmask
 = 0xFFFFFFFF,

89 .
	gshi·
 = 20,

90 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

93 
__öô
 
	$imx_˛ocksour˚_öô
()

95 
˛ocksour˚_imx
.
mu…
 =

96 
	`˛ocksour˚_hz2mu…
(
	`imx_gë_≥r˛k1
(), 
˛ocksour˚_imx
.
shi·
);

97 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_imx
);

100 
	}
}

102 
__öô
 
	$imx_timî_öô
()

104 
	`imx_timî_h¨dw¨e_öô
();

105 
	`imx_˛ocksour˚_öô
();

110 
	`£tup_úq
(
TIM1_INT
, &
imx_timî_úq
);

111 
	}
}

113 
sys_timî
 
	gimx_timî
 = {

114 .
öô
 = 
imx_timî_öô
,

	@arch/arm/mach-integrator/clock.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/li°.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/îr.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/˛k.h
>

18 
	~<löux/muãx.h
>

20 
	~<asm/£m≠h‹e.h
>

21 
	~<asm/h¨dw¨e/ic°525.h
>

23 
	~"˛ock.h
"

25 
LIST_HEAD
(
˛ocks
);

26 
DEFINE_MUTEX
(
˛ocks_muãx
);

28 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

30 
˛k
 *
p
, *˛k = 
	`ERR_PTR
(-
ENOENT
);

32 
	`muãx_lock
(&
˛ocks_muãx
);

33 
	`li°_f‹_óch_íåy
(
p
, &
˛ocks
, 
node
) {

34 i‡(
	`°rcmp
(
id
, 
p
->
«me
Ë=0 && 
	`åy_moduÀ_gë
’->
ow√r
)) {

35 
˛k
 = 
p
;

39 
	`muãx_u∆ock
(&
˛ocks_muãx
);

41  
˛k
;

42 
	}
}

43 
EXPORT_SYMBOL
(
˛k_gë
);

45 
	$˛k_put
(
˛k
 *clk)

47 
	`moduÀ_put
(
˛k
->
ow√r
);

48 
	}
}

49 
EXPORT_SYMBOL
(
˛k_put
);

51 
	$˛k_íabÀ
(
˛k
 *clk)

54 
	}
}

55 
EXPORT_SYMBOL
(
˛k_íabÀ
);

57 
	$˛k_dißbÀ
(
˛k
 *clk)

59 
	}
}

60 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

62 
	$˛k_gë_øã
(
˛k
 *clk)

64  
˛k
->
øã
;

65 
	}
}

66 
EXPORT_SYMBOL
(
˛k_gë_øã
);

68 
	$˛k_round_øã
(
˛k
 *˛k, 
øã
)

70 
ic°525_vco
 
vco
;

72 
vco
 = 
	`ic°525_khz_to_vco
(
˛k
->
∑øms
, 
øã
 / 1000);

73  
	`ic°525_khz
(
˛k
->
∑øms
, 
vco
) * 1000;

74 
	}
}

75 
EXPORT_SYMBOL
(
˛k_round_øã
);

77 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

79 
ªt
 = -
EIO
;

80 i‡(
˛k
->
£tvco
) {

81 
ic°525_vco
 
vco
;

83 
vco
 = 
	`ic°525_khz_to_vco
(
˛k
->
∑øms
, 
øã
 / 1000);

84 
˛k
->
øã
 = 
	`ic°525_khz
(˛k->
∑øms
, 
vco
) * 1000;

86 
	`¥ötk
("Clock %s: setting VCOÑegÖarams: S=%d R=%d V=%d\n",

87 
˛k
->
«me
, 
vco
.
s
, vco.
r
, vco.
v
);

89 
˛k
->
	`£tvco
(˛k, 
vco
);

90 
ªt
 = 0;

93 
	}
}

94 
EXPORT_SYMBOL
(
˛k_£t_øã
);

99 
˛k
 
	gkmi_˛k
 = {

100 .
«me
 = "KMIREFCLK",

101 .
	gøã
 = 24000000,

104 
˛k
 
	gu¨t_˛k
 = {

105 .
«me
 = "UARTCLK",

106 .
	gøã
 = 14745600,

109 
	$˛k_ªgi°î
(
˛k
 *clk)

111 
	`muãx_lock
(&
˛ocks_muãx
);

112 
	`li°_add
(&
˛k
->
node
, &
˛ocks
);

113 
	`muãx_u∆ock
(&
˛ocks_muãx
);

115 
	}
}

116 
EXPORT_SYMBOL
(
˛k_ªgi°î
);

118 
	$˛k_uƒegi°î
(
˛k
 *clk)

120 
	`muãx_lock
(&
˛ocks_muãx
);

121 
	`li°_dñ
(&
˛k
->
node
);

122 
	`muãx_u∆ock
(&
˛ocks_muãx
);

123 
	}
}

124 
EXPORT_SYMBOL
(
˛k_uƒegi°î
);

126 
__öô
 
	$˛k_öô
()

128 
	`˛k_ªgi°î
(&
kmi_˛k
);

129 
	`˛k_ªgi°î
(&
u¨t_˛k
);

131 
	}
}

132 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-integrator/clock.h

11 
	gmoduÀ
;

12 
	gic°525_∑øms
;

14 
	s˛k
 {

15 
li°_hód
 
	mnode
;

16 
	møã
;

17 
moduÀ
 *
	mow√r
;

18 c⁄° *
	m«me
;

19 c⁄° 
ic°525_∑øms
 *
	m∑øms
;

20 *
	md©a
;

21 (*
	m£tvco
)(
	m˛k
 *, 
ic°525_vco
 
	mvco
);

24 
˛k_ªgi°î
(
˛k
 *clk);

25 
˛k_uƒegi°î
(
˛k
 *clk);

	@arch/arm/mach-integrator/common.h

1 
öãgøt‹_time_öô
(, );

2 
öãgøt‹_gëtimeoff£t
();

	@arch/arm/mach-integrator/core.c

10 
	~<löux/ty≥s.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/•ölock.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<löux/úq.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/smp.h
>

19 
	~<löux/ãrmios.h
>

20 
	~<löux/amba/bus.h
>

21 
	~<löux/amba/£rül.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/úq.h
>

25 
	~<asm/io.h
>

26 
	~<asm/h¨dw¨e/¨m_timî.h
>

27 
	~<asm/¨ch/cm.h
>

28 
	~<asm/sy°em.h
>

29 
	~<asm/Àds.h
>

30 
	~<asm/mach/time.h
>

32 
	~"comm⁄.h
"

34 
amba_∂010_d©a
 
	göãgøt‹_u¨t_d©a
;

36 
amba_devi˚
 
	gπc_devi˚
 = {

37 .
dev
 = {

38 .
bus_id
 = "mb:15",

40 .
	gªs
 = {

41 .
°¨t
 = 
INTEGRATOR_RTC_BASE
,

42 .
	gíd
 = 
INTEGRATOR_RTC_BASE
 + 
SZ_4K
 - 1,

43 .
	gÊags
 = 
IORESOURCE_MEM
,

45 .
	gúq
 = { 
IRQ_RTCINT
, 
NO_IRQ
 },

46 .
	g≥rùhid
 = 0x00041030,

49 
amba_devi˚
 
	gu¨t0_devi˚
 = {

50 .
dev
 = {

51 .
bus_id
 = "mb:16",

52 .
	g∂©f‹m_d©a
 = &
öãgøt‹_u¨t_d©a
,

54 .
	gªs
 = {

55 .
°¨t
 = 
INTEGRATOR_UART0_BASE
,

56 .
	gíd
 = 
INTEGRATOR_UART0_BASE
 + 
SZ_4K
 - 1,

57 .
	gÊags
 = 
IORESOURCE_MEM
,

59 .
	gúq
 = { 
IRQ_UARTINT0
, 
NO_IRQ
 },

60 .
	g≥rùhid
 = 0x0041010,

63 
amba_devi˚
 
	gu¨t1_devi˚
 = {

64 .
dev
 = {

65 .
bus_id
 = "mb:17",

66 .
	g∂©f‹m_d©a
 = &
öãgøt‹_u¨t_d©a
,

68 .
	gªs
 = {

69 .
°¨t
 = 
INTEGRATOR_UART1_BASE
,

70 .
	gíd
 = 
INTEGRATOR_UART1_BASE
 + 
SZ_4K
 - 1,

71 .
	gÊags
 = 
IORESOURCE_MEM
,

73 .
	gúq
 = { 
IRQ_UARTINT1
, 
NO_IRQ
 },

74 .
	g≥rùhid
 = 0x0041010,

77 
amba_devi˚
 
	gkmi0_devi˚
 = {

78 .
dev
 = {

79 .
bus_id
 = "mb:18",

81 .
	gªs
 = {

82 .
°¨t
 = 
KMI0_BASE
,

83 .
	gíd
 = 
KMI0_BASE
 + 
SZ_4K
 - 1,

84 .
	gÊags
 = 
IORESOURCE_MEM
,

86 .
	gúq
 = { 
IRQ_KMIINT0
, 
NO_IRQ
 },

87 .
	g≥rùhid
 = 0x00041050,

90 
amba_devi˚
 
	gkmi1_devi˚
 = {

91 .
dev
 = {

92 .
bus_id
 = "mb:19",

94 .
	gªs
 = {

95 .
°¨t
 = 
KMI1_BASE
,

96 .
	gíd
 = 
KMI1_BASE
 + 
SZ_4K
 - 1,

97 .
	gÊags
 = 
IORESOURCE_MEM
,

99 .
	gúq
 = { 
IRQ_KMIINT1
, 
NO_IRQ
 },

100 .
	g≥rùhid
 = 0x00041050,

103 
amba_devi˚
 *
	gamba_devs
[] 
	g__öôd©a
 = {

104 &
πc_devi˚
,

105 &
u¨t0_devi˚
,

106 &
u¨t1_devi˚
,

107 &
kmi0_devi˚
,

108 &
kmi1_devi˚
,

111 
__öô
 
	$öãgøt‹_öô
()

113 
i
;

115 
i
 = 0; i < 
	`ARRAY_SIZE
(
amba_devs
); i++) {

116 
amba_devi˚
 *
d
 = 
amba_devs
[
i
];

117 
	`amba_devi˚_ªgi°î
(
d
, &
iomem_ªsour˚
);

121 
	}
}

123 
¨ch_öôˇŒ
(
öãgøt‹_öô
);

132 
	#SC_CTRLC
 (
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
Ë+ 
INTEGRATOR_SC_CTRLC_OFFSET
)

	)

133 
	#SC_CTRLS
 (
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
Ë+ 
INTEGRATOR_SC_CTRLS_OFFSET
)

	)

135 
	$öãgøt‹_u¨t_£t_m˘æ
(
amba_devi˚
 *
dev
, 
__iomem
 *
ba£
, 
m˘æ
)

137 
˘æs
 = 0, 
˘æc
 = 0, 
πs_mask
, 
då_mask
;

139 i‡(
dev
 =&
u¨t0_devi˚
) {

140 
πs_mask
 = 1 << 4;

141 
då_mask
 = 1 << 5;

143 
πs_mask
 = 1 << 6;

144 
då_mask
 = 1 << 7;

147 i‡(
m˘æ
 & 
TIOCM_RTS
)

148 
˘æc
 |
πs_mask
;

150 
˘æs
 |
πs_mask
;

152 i‡(
m˘æ
 & 
TIOCM_DTR
)

153 
˘æc
 |
då_mask
;

155 
˘æs
 |
då_mask
;

157 
	`__øw_wrôñ
(
˘æs
, 
SC_CTRLS
);

158 
	`__øw_wrôñ
(
˘æc
, 
SC_CTRLC
);

159 
	}
}

161 
amba_∂010_d©a
 
	göãgøt‹_u¨t_d©a
 = {

162 .
£t_m˘æ
 = 
öãgøt‹_u¨t_£t_m˘æ
,

165 
	#CM_CTRL
 
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
Ë+ 
INTEGRATOR_HDR_CTRL_OFFSET


	)

167 
DEFINE_SPINLOCK
(
cm_lock
);

174 
	$cm_c⁄åﬁ
(
u32
 
mask
, u32 
£t
)

176 
Êags
;

177 
u32
 
vÆ
;

179 
	`•ö_lock_úqßve
(&
cm_lock
, 
Êags
);

180 
vÆ
 = 
	`ªadl
(
CM_CTRL
Ë& ~
mask
;

181 
	`wrôñ
(
vÆ
 | 
£t
, 
CM_CTRL
);

182 
	`•ö_u∆ock_úqª°‹e
(&
cm_lock
, 
Êags
);

183 
	}
}

185 
EXPORT_SYMBOL
(
cm_c⁄åﬁ
);

190 
	#TIMER0_VA_BASE
 (
	`IO_ADDRESS
(
INTEGRATOR_CT_BASE
)+0x00000000)

	)

191 
	#TIMER1_VA_BASE
 (
	`IO_ADDRESS
(
INTEGRATOR_CT_BASE
)+0x00000100)

	)

192 
	#TIMER2_VA_BASE
 (
	`IO_ADDRESS
(
INTEGRATOR_CT_BASE
)+0x00000200)

	)

193 
	#VA_IC_BASE
 
	`IO_ADDRESS
(
INTEGRATOR_IC_BASE
)

	)

198 
	#TIMER_INTERVAL
 (
TICKS_PER_uSEC
 * 
mSEC_10
)

	)

199 #i‡
TIMER_INTERVAL
 >= 0x100000

200 
	#TICKS2USECS
(
x
Ë(256 * (xË/ 
TICKS_PER_uSEC
)

	)

201 #ñi‡
TIMER_INTERVAL
 >= 0x10000

202 
	#TICKS2USECS
(
x
Ë(16 * (xË/ 
TICKS_PER_uSEC
)

	)

204 
	#TICKS2USECS
(
x
Ë((xË/ 
TICKS_PER_uSEC
)

	)

207 
	gtimî_ªlﬂd
;

213 
	$öãgøt‹_gëtimeoff£t
()

215 
ticks1
, 
ticks2
, 
°©us
;

223 
ticks2
 = 
	`ªadl
(
TIMER1_VA_BASE
 + 
TIMER_VALUE
) & 0xffff;

225 
ticks1
 = 
ticks2
;

226 
°©us
 = 
	`__øw_ªadl
(
VA_IC_BASE
 + 
IRQ_RAW_STATUS
);

227 
ticks2
 = 
	`ªadl
(
TIMER1_VA_BASE
 + 
TIMER_VALUE
) & 0xffff;

228 } 
ticks2
 > 
ticks1
);

233 
ticks1
 = 
timî_ªlﬂd
 - 
ticks2
;

238 i‡(
°©us
 & (1 << 
IRQ_TIMERINT1
))

239 
ticks1
 +
timî_ªlﬂd
;

244  
	`TICKS2USECS
(
ticks1
);

245 
	}
}

250 
úqªtu∫_t


251 
	$öãgøt‹_timî_öãºu±
(
úq
, *
dev_id
)

253 
	`wrôe_£qlock
(&
xtime_lock
);

258 
	`wrôñ
(1, 
TIMER1_VA_BASE
 + 
TIMER_INTCLR
);

260 
	`timî_tick
();

262 
	`wrôe_£qu∆ock
(&
xtime_lock
);

264  
IRQ_HANDLED
;

265 
	}
}

267 
úqa˘i⁄
 
	göãgøt‹_timî_úq
 = {

268 .
«me
 = "Integrator Timer Tick",

269 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

270 .
	gh™dÀr
 = 
öãgøt‹_timî_öãºu±
,

276 
__öô
 
	$öãgøt‹_time_öô
(
ªlﬂd
, 
˘æ
)

278 
timî_˘æ
 = 
TIMER_CTRL_ENABLE
 | 
TIMER_CTRL_PERIODIC
;

280 
timî_ªlﬂd
 = 
ªlﬂd
;

281 
timî_˘æ
 |
˘æ
;

283 i‡(
timî_ªlﬂd
 > 0x100000) {

284 
timî_ªlﬂd
 >>= 8;

285 
timî_˘æ
 |
TIMER_CTRL_DIV256
;

286 } i‡(
timî_ªlﬂd
 > 0x010000) {

287 
timî_ªlﬂd
 >>= 4;

288 
timî_˘æ
 |
TIMER_CTRL_DIV16
;

294 
	`wrôñ
(0, 
TIMER0_VA_BASE
 + 
TIMER_CTRL
);

295 
	`wrôñ
(0, 
TIMER1_VA_BASE
 + 
TIMER_CTRL
);

296 
	`wrôñ
(0, 
TIMER2_VA_BASE
 + 
TIMER_CTRL
);

298 
	`wrôñ
(
timî_ªlﬂd
, 
TIMER1_VA_BASE
 + 
TIMER_LOAD
);

299 
	`wrôñ
(
timî_ªlﬂd
, 
TIMER1_VA_BASE
 + 
TIMER_VALUE
);

300 
	`wrôñ
(
timî_˘æ
, 
TIMER1_VA_BASE
 + 
TIMER_CTRL
);

305 
	`£tup_úq
(
IRQ_TIMERINT1
, &
öãgøt‹_timî_úq
);

306 
	}
}

	@arch/arm/mach-integrator/cpu.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/˝u‰eq.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/sched.h
>

20 
	~<löux/smp.h
>

21 
	~<löux/öô.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/io.h
>

25 
	~<asm/mach-ty≥s.h
>

26 
	~<asm/h¨dw¨e/ic°525.h
>

28 
˝u‰eq_drivî
 
	göãgøt‹_drivî
;

30 
	#CM_ID
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+
INTEGRATOR_HDR_ID_OFFSET
)

	)

31 
	#CM_OSC
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+
INTEGRATOR_HDR_OSC_OFFSET
)

	)

32 
	#CM_STAT
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+
INTEGRATOR_HDR_STAT_OFFSET
)

	)

33 
	#CM_LOCK
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+
INTEGRATOR_HDR_LOCK_OFFSET
)

	)

35 c⁄° 
ic°525_∑øms
 
	gl˛k_∑øms
 = {

36 .
ªf
 = 24000,

37 .
	gvco_max
 = 320000,

38 .
	gvd_mö
 = 8,

39 .
	gvd_max
 = 132,

40 .
	grd_mö
 = 24,

41 .
	grd_max
 = 24,

44 c⁄° 
ic°525_∑øms
 
	gc˛k_∑øms
 = {

45 .
ªf
 = 24000,

46 .
	gvco_max
 = 320000,

47 .
	gvd_mö
 = 12,

48 .
	gvd_max
 = 160,

49 .
	grd_mö
 = 24,

50 .
	grd_max
 = 24,

56 
	$öãgøt‹_vîify_pﬁicy
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

58 
ic°525_vco
 
vco
;

60 
	`˝u‰eq_vîify_wôhö_limôs
(
pﬁicy
,

61 
pﬁicy
->
˝uöfo
.
mö_‰eq
,

62 
pﬁicy
->
˝uöfo
.
max_‰eq
);

64 
vco
 = 
	`ic°525_khz_to_vco
(&
c˛k_∑øms
, 
pﬁicy
->
max
);

65 
pﬁicy
->
max
 = 
	`ic°525_khz
(&
c˛k_∑øms
, 
vco
);

67 
vco
 = 
	`ic°525_khz_to_vco
(&
c˛k_∑øms
, 
pﬁicy
->
mö
);

68 
pﬁicy
->
mö
 = 
	`ic°525_khz
(&
c˛k_∑øms
, 
vco
);

70 
	`˝u‰eq_vîify_wôhö_limôs
(
pﬁicy
,

71 
pﬁicy
->
˝uöfo
.
mö_‰eq
,

72 
pﬁicy
->
˝uöfo
.
max_‰eq
);

75 
	}
}

78 
	$öãgøt‹_£t_èrgë
(
˝u‰eq_pﬁicy
 *
pﬁicy
,

79 
èrgë_‰eq
,

80 
ªœti⁄
)

82 
˝umask_t
 
˝us_Ælowed
;

83 
˝u
 = 
pﬁicy
->cpu;

84 
ic°525_vco
 
vco
;

85 
˝u‰eq_‰eqs
 
‰eqs
;

86 
u_öt
 
cm_osc
;

91 
˝us_Ælowed
 = 
cuºít
->cpus_allowed;

97 
	`£t_˝us_Ælowed
(
cuºít
, 
	`˝umask_of_˝u
(
˝u
));

98 
	`BUG_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

101 
cm_osc
 = 
	`__øw_ªadl
(
CM_OSC
);

103 i‡(
	`machöe_is_öãgøt‹
()) {

104 
vco
.
s
 = (
cm_osc
 >> 8) & 7;

105 } i‡(
	`machöe_is_cöãgøt‹
()) {

106 
vco
.
s
 = 1;

108 
vco
.
v
 = 
cm_osc
 & 255;

109 
vco
.
r
 = 22;

110 
‰eqs
.
ﬁd
 = 
	`ic°525_khz
(&
c˛k_∑øms
, 
vco
);

115 i‡(
ªœti⁄
 =
CPUFREQ_RELATION_L
)

116 
èrgë_‰eq
 += 999;

117 i‡(
èrgë_‰eq
 > 
pﬁicy
->
max
)

118 
èrgë_‰eq
 = 
pﬁicy
->
max
;

119 
vco
 = 
	`ic°525_khz_to_vco
(&
c˛k_∑øms
, 
èrgë_‰eq
);

120 
‰eqs
.
√w
 = 
	`ic°525_khz
(&
c˛k_∑øms
, 
vco
);

122 
‰eqs
.
˝u
 = 
pﬁicy
->cpu;

124 i‡(
‰eqs
.
ﬁd
 =‰eqs.
√w
) {

125 
	`£t_˝us_Ælowed
(
cuºít
, 
˝us_Ælowed
);

129 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_PRECHANGE
);

131 
cm_osc
 = 
	`__øw_ªadl
(
CM_OSC
);

133 i‡(
	`machöe_is_öãgøt‹
()) {

134 
cm_osc
 &= 0xfffff800;

135 
cm_osc
 |
vco
.
s
 << 8;

136 } i‡(
	`machöe_is_cöãgøt‹
()) {

137 
cm_osc
 &= 0xffffff00;

139 
cm_osc
 |
vco
.
v
;

141 
	`__øw_wrôñ
(0xa05f, 
CM_LOCK
);

142 
	`__øw_wrôñ
(
cm_osc
, 
CM_OSC
);

143 
	`__øw_wrôñ
(0, 
CM_LOCK
);

148 
	`£t_˝us_Ælowed
(
cuºít
, 
˝us_Ælowed
);

150 
	`˝u‰eq_nŸify_å™sôi⁄
(&
‰eqs
, 
CPUFREQ_POSTCHANGE
);

153 
	}
}

155 
	$öãgøt‹_gë
(
˝u
)

157 
˝umask_t
 
˝us_Ælowed
;

158 
cuºít_‰eq
;

159 
u_öt
 
cm_osc
;

160 
ic°525_vco
 
vco
;

162 
˝us_Ælowed
 = 
cuºít
->cpus_allowed;

164 
	`£t_˝us_Ælowed
(
cuºít
, 
	`˝umask_of_˝u
(
˝u
));

165 
	`BUG_ON
(
˝u
 !
	`smp_¥o˚ss‹_id
());

168 
cm_osc
 = 
	`__øw_ªadl
(
CM_OSC
);

170 i‡(
	`machöe_is_öãgøt‹
()) {

171 
vco
.
s
 = (
cm_osc
 >> 8) & 7;

172 } i‡(
	`machöe_is_cöãgøt‹
()) {

173 
vco
.
s
 = 1;

175 
vco
.
v
 = 
cm_osc
 & 255;

176 
vco
.
r
 = 22;

178 
cuºít_‰eq
 = 
	`ic°525_khz
(&
c˛k_∑øms
, 
vco
);

180 
	`£t_˝us_Ælowed
(
cuºít
, 
˝us_Ælowed
);

182  
cuºít_‰eq
;

183 
	}
}

185 
	$öãgøt‹_˝u‰eq_öô
(
˝u‰eq_pﬁicy
 *
pﬁicy
)

189 
pﬁicy
->
govîn‹
 = 
CPUFREQ_DEFAULT_GOVERNOR
;

190 
pﬁicy
->
˝uöfo
.
max_‰eq
 = 160000;

191 
pﬁicy
->
˝uöfo
.
mö_‰eq
 = 12000;

192 
pﬁicy
->
˝uöfo
.
å™sôi⁄_œãncy
 = 1000000;

193 
pﬁicy
->
cur
 =Öﬁicy->
mö
 =Öﬁicy->
max
 = 
	`öãgøt‹_gë
’ﬁicy->
˝u
);

196 
	}
}

198 
˝u‰eq_drivî
 
	göãgøt‹_drivî
 = {

199 .
vîify
 = 
öãgøt‹_vîify_pﬁicy
,

200 .
	gèrgë
 = 
öãgøt‹_£t_èrgë
,

201 .
	ggë
 = 
öãgøt‹_gë
,

202 .
	göô
 = 
öãgøt‹_˝u‰eq_öô
,

203 .
	g«me
 = "integrator",

206 
__öô
 
	$öãgøt‹_˝u_öô
()

208  
	`˝u‰eq_ªgi°î_drivî
(&
öãgøt‹_drivî
);

209 
	}
}

211 
__exô
 
	$öãgøt‹_˝u_exô
()

213 
	`˝u‰eq_uƒegi°î_drivî
(&
öãgøt‹_drivî
);

214 
	}
}

216 
MODULE_AUTHOR
 ("Russell M. King");

217 
MODULE_DESCRIPTION
 ("cpufreq driver for ARM Integrator CPUs");

218 
MODULE_LICENSE
 ("GPL");

220 
moduÀ_öô
(
öãgøt‹_˝u_öô
);

221 
moduÀ_exô
(
öãgøt‹_˝u_exô
);

	@arch/arm/mach-integrator/impd1.c

15 
	~<löux/moduÀ.h
>

16 
	~<löux/moduÀ∑øm.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/devi˚.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/amba/bus.h
>

22 
	~<löux/amba/˛cd.h
>

24 
	~<asm/io.h
>

25 
	~<asm/h¨dw¨e/ic°525.h
>

26 
	~<asm/¨ch/lm.h
>

27 
	~<asm/¨ch/impd1.h
>

28 
	~<asm/sizes.h
>

30 
	~"˛ock.h
"

32 
	gmoduÀ_id
;

34 
moduÀ_∑øm_«med
(
lmid
, 
moduÀ_id
, , 0444);

35 
MODULE_PARM_DESC
(
lmid
, "logic module stackÖosition");

37 
	simpd1_moduÀ
 {

38 
__iomem
 *
	mba£
;

39 
˛k
 
	mvcos
[2];

42 c⁄° 
ic°525_∑øms
 
	gimpd1_vco_∑øms
 = {

43 .
ªf
 = 24000,

44 .
	gvco_max
 = 200000,

45 .
	gvd_mö
 = 12,

46 .
	gvd_max
 = 519,

47 .
	grd_mö
 = 3,

48 .
	grd_max
 = 120,

51 
	$impd1_£tvco
(
˛k
 *˛k, 
ic°525_vco
 
vco
)

53 
impd1_moduÀ
 *
impd1
 = 
˛k
->
d©a
;

54 
vc⁄r
 = 
˛k
 - 
impd1
->
vcos
;

55 
u32
 
vÆ
;

57 
vÆ
 = 
vco
.
v
 | (vco.
r
 << 9Ë| (vco.
s
 << 16);

59 
	`wrôñ
(0xa05f, 
impd1
->
ba£
 + 
IMPD1_LOCK
);

60 
vc⁄r
) {

62 
	`wrôñ
(
vÆ
, 
impd1
->
ba£
 + 
IMPD1_OSC1
);

65 
	`wrôñ
(
vÆ
, 
impd1
->
ba£
 + 
IMPD1_OSC2
);

68 
	`wrôñ
(0, 
impd1
->
ba£
 + 
IMPD1_LOCK
);

70 #ifde‡
DEBUG


71 
vco
.
v
 = 
vÆ
 & 0x1ff;

72 
vco
.
r
 = (
vÆ
 >> 9) & 0x7f;

73 
vco
.
s
 = (
vÆ
 >> 16) & 7;

75 
	`¥_debug
("IM-PD1: VCO%d clock is %ld kHz\n",

76 
vc⁄r
, 
	`ic°525_khz
(&
impd1_vco_∑øms
, 
vco
));

78 
	}
}

80 
	$impd1_twók_c⁄åﬁ
(
devi˚
 *
dev
, 
u32
 
mask
, u32 
vÆ
)

82 
impd1_moduÀ
 *
impd1
 = 
	`dev_gë_drvd©a
(
dev
);

83 
u32
 
cur
;

85 
vÆ
 &
mask
;

86 
cur
 = 
	`ªadl
(
impd1
->
ba£
 + 
IMPD1_CTRL
Ë& ~
mask
;

87 
	`wrôñ
(
cur
 | 
vÆ
, 
impd1
->
ba£
 + 
IMPD1_CTRL
);

88 
	}
}

90 
EXPORT_SYMBOL
(
impd1_twók_c⁄åﬁ
);

95 
	#PANEL
 
PROSPECTOR


	)

97 
	#LTM10C209
 1

	)

98 
	#PROSPECTOR
 2

	)

99 
	#SVGA
 3

	)

100 
	#VGA
 4

	)

102 #i‡
PANEL
 =
VGA


103 
	#PANELTYPE
 
vga


	)

104 
˛cd_∑√l
 
	gvga
 = {

105 .
mode
 = {

106 .
«me
 = "VGA",

107 .
	gª‰esh
 = 60,

108 .
	gxªs
 = 640,

109 .
	gyªs
 = 480,

110 .
	gpix˛ock
 = 39721,

111 .
	gÀ·_m¨gö
 = 40,

112 .
	gright_m¨gö
 = 24,

113 .
	guµî_m¨gö
 = 32,

114 .
	glowî_m¨gö
 = 11,

115 .
	ghsync_Àn
 = 96,

116 .
	gvsync_Àn
 = 2,

117 .
	gsync
 = 0,

118 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

120 .
	gwidth
 = -1,

121 .
	gheight
 = -1,

122 .
	gtim2
 = 
TIM2_BCD
 | 
TIM2_IPC
,

123 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

124 .
	gc⁄√˘‹
 = 
IMPD1_CTRL_DISP_VGA
,

125 .
	gbµ
 = 16,

126 .
	ggøysˇÀ
 = 0,

129 #ñi‡
PANEL
 =
SVGA


130 
	#PANELTYPE
 
svga


	)

131 
˛cd_∑√l
 
	gsvga
 = {

132 .
mode
 = {

133 .
«me
 = "SVGA",

134 .
	gª‰esh
 = 0,

135 .
	gxªs
 = 800,

136 .
	gyªs
 = 600,

137 .
	gpix˛ock
 = 27778,

138 .
	gÀ·_m¨gö
 = 20,

139 .
	gright_m¨gö
 = 20,

140 .
	guµî_m¨gö
 = 5,

141 .
	glowî_m¨gö
 = 5,

142 .
	ghsync_Àn
 = 164,

143 .
	gvsync_Àn
 = 62,

144 .
	gsync
 = 0,

145 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

147 .
	gwidth
 = -1,

148 .
	gheight
 = -1,

149 .
	gtim2
 = 
TIM2_BCD
,

150 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

151 .
	gc⁄√˘‹
 = 
IMPD1_CTRL_DISP_VGA
,

152 .
	gbµ
 = 16,

153 .
	ggøysˇÀ
 = 0,

156 #ñi‡
PANEL
 =
PROSPECTOR


157 
	#PANELTYPE
 
¥o•e˘‹


	)

158 
˛cd_∑√l
 
	g¥o•e˘‹
 = {

159 .
mode
 = {

160 .
«me
 = "PROSPECTOR",

161 .
	gª‰esh
 = 0,

162 .
	gxªs
 = 640,

163 .
	gyªs
 = 480,

164 .
	gpix˛ock
 = 40000,

165 .
	gÀ·_m¨gö
 = 33,

166 .
	gright_m¨gö
 = 64,

167 .
	guµî_m¨gö
 = 36,

168 .
	glowî_m¨gö
 = 7,

169 .
	ghsync_Àn
 = 64,

170 .
	gvsync_Àn
 = 25,

171 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

172 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

174 .
	gwidth
 = -1,

175 .
	gheight
 = -1,

176 .
	gtim2
 = 
TIM2_BCD
,

177 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

178 .
	gfixedtimögs
 = 1,

179 .
	gc⁄√˘‹
 = 
IMPD1_CTRL_DISP_LCD
,

180 .
	gbµ
 = 16,

181 .
	ggøysˇÀ
 = 0,

184 #ñi‡
PANEL
 =
LTM10C209


185 
	#PANELTYPE
 
…m10c209


	)

189 
˛cd_∑√l
 
	g…m10c209
 = {

190 .
mode
 = {

191 .
«me
 = "LTM10C209",

192 .
	gª‰esh
 = 0,

193 .
	gxªs
 = 640,

194 .
	gyªs
 = 480,

195 .
	gpix˛ock
 = 40000,

196 .
	gÀ·_m¨gö
 = 20,

197 .
	gright_m¨gö
 = 20,

198 .
	guµî_m¨gö
 = 19,

199 .
	glowî_m¨gö
 = 19,

200 .
	ghsync_Àn
 = 20,

201 .
	gvsync_Àn
 = 10,

202 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

203 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

205 .
	gwidth
 = -1,

206 .
	gheight
 = -1,

207 .
	gtim2
 = 
TIM2_BCD
,

208 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

209 .
	gfixedtimögs
 = 1,

210 .
	gc⁄√˘‹
 = 
IMPD1_CTRL_DISP_LCD
,

211 .
	gbµ
 = 16,

212 .
	ggøysˇÀ
 = 0,

219 
	$impd1fb_˛cd_dißbÀ
(
˛cd_fb
 *
fb
)

221 
	`impd1_twók_c⁄åﬁ
(
fb
->
dev
->dev.
∑ª¡
, 
IMPD1_CTRL_DISP_MASK
, 0);

222 
	}
}

227 
	$impd1fb_˛cd_íabÀ
(
˛cd_fb
 *
fb
)

229 
	`impd1_twók_c⁄åﬁ
(
fb
->
dev
->dev.
∑ª¡
, 
IMPD1_CTRL_DISP_MASK
,

230 
fb
->
∑√l
->
c⁄√˘‹
 | 
IMPD1_CTRL_DISP_ENABLE
);

231 
	}
}

233 
	$impd1fb_˛cd_£tup
(
˛cd_fb
 *
fb
)

235 
‰ameba£
 = 
fb
->
dev
->
ªs
.
°¨t
 + 0x01000000;

236 
‰amesize
 = 
SZ_1M
;

237 
ªt
 = 0;

239 
fb
->
∑√l
 = &
PANELTYPE
;

241 i‡(!
	`ªque°_mem_ªgi⁄
(
‰ameba£
, 
‰amesize
, "clcd framebuffer")) {

242 
	`¥ötk
(
KERN_ERR
 "IM-PD1: unableÅoÑeserve framebuffer\n");

243  -
EBUSY
;

246 
fb
->fb.
s¸ìn_ba£
 = 
	`i‹em≠
(
‰ameba£
, 
‰amesize
);

247 i‡(!
fb
->fb.
s¸ìn_ba£
) {

248 
	`¥ötk
(
KERN_ERR
 "IM-PD1: unableÅo map framebuffer\n");

249 
ªt
 = -
ENOMEM
;

250 
‰ì_buf„r
;

253 
fb
->fb.
fix
.
smem_°¨t
 = 
‰ameba£
;

254 
fb
->fb.
fix
.
smem_Àn
 = 
‰amesize
;

258 
‰ì_buf„r
:

259 
	`ªÀa£_mem_ªgi⁄
(
‰ameba£
, 
‰amesize
);

260  
ªt
;

261 
	}
}

263 
	$impd1fb_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

265 
°¨t
, 
size
;

267 
°¨t
 = 
vma
->
vm_pgoff
 + (
fb
->fb.
fix
.
smem_°¨t
 >> 
PAGE_SHIFT
);

268 
size
 = 
vma
->
vm_íd
 - vma->
vm_°¨t
;

270  
	`ªm≠_p‚_ønge
(
vma
, vma->
vm_°¨t
, 
°¨t
, 
size
,

271 
vma
->
vm_∑ge_¥Ÿ
);

272 
	}
}

274 
	$impd1fb_˛cd_ªmove
(
˛cd_fb
 *
fb
)

276 
	`iounm≠
(
fb
->fb.
s¸ìn_ba£
);

277 
	`ªÀa£_mem_ªgi⁄
(
fb
->fb.
fix
.
smem_°¨t
, fb->fb.fix.
smem_Àn
);

278 
	}
}

280 
˛cd_bﬂrd
 
	gimpd1_˛cd_d©a
 = {

281 .
«me
 = "IM-PD/1",

282 .
	gcheck
 = 
˛cdfb_check
,

283 .
	gdecode
 = 
˛cdfb_decode
,

284 .
	gdißbÀ
 = 
impd1fb_˛cd_dißbÀ
,

285 .
	gíabÀ
 = 
impd1fb_˛cd_íabÀ
,

286 .
	g£tup
 = 
impd1fb_˛cd_£tup
,

287 .
	gmm≠
 = 
impd1fb_˛cd_mm≠
,

288 .
	gªmove
 = 
impd1fb_˛cd_ªmove
,

291 
	simpd1_devi˚
 {

292 
	moff£t
;

293 
	múq
[2];

294 
	mid
;

295 *
	m∂©f‹m_d©a
;

298 
impd1_devi˚
 
	gimpd1_devs
[] = {

300 .
off£t
 = 0x03000000,

301 .
	gid
 = 0x00041190,

303 .
	goff£t
 = 0x00100000,

304 .
	gúq
 = { 1 },

305 .
	gid
 = 0x00141011,

307 .
	goff£t
 = 0x00200000,

308 .
	gúq
 = { 2 },

309 .
	gid
 = 0x00141011,

311 .
	goff£t
 = 0x00300000,

312 .
	gúq
 = { 3 },

313 .
	gid
 = 0x00041022,

315 .
	goff£t
 = 0x00400000,

316 .
	gúq
 = { 4 },

317 .
	gid
 = 0x00041061,

319 .
	goff£t
 = 0x00500000,

320 .
	gúq
 = { 5 },

321 .
	gid
 = 0x00041061,

323 .
	goff£t
 = 0x00600000,

324 .
	gúq
 = { 6 },

325 .
	gid
 = 0x00041130,

327 .
	goff£t
 = 0x00700000,

328 .
	gúq
 = { 7, 8 },

329 .
	gid
 = 0x00041181,

331 .
	goff£t
 = 0x00800000,

332 .
	gúq
 = { 9 },

333 .
	gid
 = 0x00041041,

335 .
	goff£t
 = 0x01000000,

336 .
	gúq
 = { 11 },

337 .
	gid
 = 0x00041110,

338 .
	g∂©f‹m_d©a
 = &
impd1_˛cd_d©a
,

342 c⁄° *
	gimpd1_vc⁄ames
[2] = {

347 
	$impd1_¥obe
(
lm_devi˚
 *
dev
)

349 
impd1_moduÀ
 *
impd1
;

350 
i
, 
ªt
;

352 i‡(
dev
->
id
 !
moduÀ_id
)

353  -
EINVAL
;

355 i‡(!
	`ªque°_mem_ªgi⁄
(
dev
->
ªsour˚
.
°¨t
, 
SZ_4K
, "LMÑegisters"))

356  -
EBUSY
;

358 
impd1
 = 
	`kzÆloc
((
impd1_moduÀ
), 
GFP_KERNEL
);

359 i‡(!
impd1
) {

360 
ªt
 = -
ENOMEM
;

361 
ªÀa£_lm
;

364 
impd1
->
ba£
 = 
	`i‹em≠
(
dev
->
ªsour˚
.
°¨t
, 
SZ_4K
);

365 i‡(!
impd1
->
ba£
) {

366 
ªt
 = -
ENOMEM
;

367 
‰ì_impd1
;

370 
	`lm_£t_drvd©a
(
dev
, 
impd1
);

372 
	`¥ötk
("IM-PD1 foundáà0x%08lx\n", 
dev
->
ªsour˚
.
°¨t
);

374 
i
 = 0; i < 
	`ARRAY_SIZE
(
impd1
->
vcos
); i++) {

375 
impd1
->
vcos
[
i
].
ow√r
 = 
THIS_MODULE
,

376 
impd1
->
vcos
[
i
].
«me
 = 
impd1_vc⁄ames
[i],

377 
impd1
->
vcos
[
i
].
∑øms
 = &
impd1_vco_∑øms
,

378 
impd1
->
vcos
[
i
].
d©a
 = impd1,

379 
impd1
->
vcos
[
i
].
£tvco
 = 
impd1_£tvco
;

381 
	`˛k_ªgi°î
(&
impd1
->
vcos
[
i
]);

384 
i
 = 0; i < 
	`ARRAY_SIZE
(
impd1_devs
); i++) {

385 
impd1_devi˚
 *
idev
 = 
impd1_devs
 + 
i
;

386 
amba_devi˚
 *
d
;

387 
pc_ba£
;

389 
pc_ba£
 = 
dev
->
ªsour˚
.
°¨t
 + 
idev
->
off£t
;

391 
d
 = 
	`kzÆloc
((
amba_devi˚
), 
GFP_KERNEL
);

392 i‡(!
d
)

395 
	`¢¥ötf
(
d
->
dev
.
bus_id
, (d->dev.bus_id),

396 "lm%x:%5.5lx", 
dev
->
id
, 
idev
->
off£t
 >> 12);

398 
d
->
dev
.
∑ª¡
 = &dev->dev;

399 
d
->
ªs
.
°¨t
 = 
dev
->
ªsour˚
.°¨à+ 
idev
->
off£t
;

400 
d
->
ªs
.
íd
 = d->ªs.
°¨t
 + 
SZ_4K
 - 1;

401 
d
->
ªs
.
Êags
 = 
IORESOURCE_MEM
;

402 
d
->
úq
[0] = 
dev
->irq;

403 
d
->
úq
[1] = 
dev
->irq;

404 
d
->
≥rùhid
 = 
idev
->
id
;

405 
d
->
dev
.
∂©f‹m_d©a
 = 
idev
->platform_data;

407 
ªt
 = 
	`amba_devi˚_ªgi°î
(
d
, &
dev
->
ªsour˚
);

408 i‡(
ªt
) {

409 
	`¥ötk
("unableÅoÑegister device %s: %d\n",

410 
d
->
dev
.
bus_id
, 
ªt
);

411 
	`k‰ì
(
d
);

417 
‰ì_impd1
:

418 i‡(
impd1
 && impd1->
ba£
)

419 
	`iounm≠
(
impd1
->
ba£
);

420 
	`k‰ì
(
impd1
);

421 
ªÀa£_lm
:

422 
	`ªÀa£_mem_ªgi⁄
(
dev
->
ªsour˚
.
°¨t
, 
SZ_4K
);

423  
ªt
;

424 
	}
}

426 
	$impd1_ªmove_⁄e
(
devi˚
 *
dev
, *
d©a
)

428 
	`devi˚_uƒegi°î
(
dev
);

430 
	}
}

432 
	$impd1_ªmove
(
lm_devi˚
 *
dev
)

434 
impd1_moduÀ
 *
impd1
 = 
	`lm_gë_drvd©a
(
dev
);

435 
i
;

437 
	`devi˚_f‹_óch_chûd
(&
dev
->dev, 
NULL
, 
impd1_ªmove_⁄e
);

439 
i
 = 0; i < 
	`ARRAY_SIZE
(
impd1
->
vcos
); i++)

440 
	`˛k_uƒegi°î
(&
impd1
->
vcos
[
i
]);

442 
	`lm_£t_drvd©a
(
dev
, 
NULL
);

444 
	`iounm≠
(
impd1
->
ba£
);

445 
	`k‰ì
(
impd1
);

446 
	`ªÀa£_mem_ªgi⁄
(
dev
->
ªsour˚
.
°¨t
, 
SZ_4K
);

447 
	}
}

449 
lm_drivî
 
	gimpd1_drivî
 = {

450 .
drv
 = {

451 .
«me
 = "impd1",

453 .
	g¥obe
 = 
impd1_¥obe
,

454 .
	gªmove
 = 
impd1_ªmove
,

457 
__öô
 
	$impd1_öô
()

459  
	`lm_drivî_ªgi°î
(&
impd1_drivî
);

460 
	}
}

462 
__exô
 
	$impd1_exô
()

464 
	`lm_drivî_uƒegi°î
(&
impd1_drivî
);

465 
	}
}

467 
moduÀ_öô
(
impd1_öô
);

468 
moduÀ_exô
(
impd1_exô
);

470 
MODULE_LICENSE
("GPL");

471 
MODULE_DESCRIPTION
("Integrator/IM-PD1Üogic module core driver");

472 
MODULE_AUTHOR
("Deep Blue Solutions Ltd");

	@arch/arm/mach-integrator/integrator_ap.c

20 
	~<löux/ty≥s.h
>

21 
	~<löux/kî√l.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/li°.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/sysdev.h
>

28 
	~<löux/amba/bus.h
>

29 
	~<löux/amba/kmi.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/io.h
>

33 
	~<asm/úq.h
>

34 
	~<asm/£tup.h
>

35 
	~<asm/∑øm.h
>

36 
	~<asm/mach-ty≥s.h
>

38 
	~<asm/¨ch/lm.h
>

40 
	~<asm/mach/¨ch.h
>

41 
	~<asm/mach/Êash.h
>

42 
	~<asm/mach/úq.h
>

43 
	~<asm/mach/m≠.h
>

44 
	~<asm/mach/time.h
>

46 
	~"comm⁄.h
"

55 
	#VA_IC_BASE
 
	`IO_ADDRESS
(
INTEGRATOR_IC_BASE
)

	)

56 
	#VA_SC_BASE
 
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
)

	)

57 
	#VA_EBI_BASE
 
	`IO_ADDRESS
(
INTEGRATOR_EBI_BASE
)

	)

58 
	#VA_CMIC_BASE
 
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
Ë+ 
INTEGRATOR_HDR_IC_OFFSET


	)

78 
m≠_desc
 
	g≠_io_desc
[] 
	g__öôd©a
 = {

80 .
vútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_HDR_BASE
),

81 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_HDR_BASE
),

82 .
	gÀngth
 = 
SZ_4K
,

83 .
	gty≥
 = 
MT_DEVICE


85 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_SC_BASE
),

86 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_SC_BASE
),

87 .
	gÀngth
 = 
SZ_4K
,

88 .
	gty≥
 = 
MT_DEVICE


90 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_EBI_BASE
),

91 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_EBI_BASE
),

92 .
	gÀngth
 = 
SZ_4K
,

93 .
	gty≥
 = 
MT_DEVICE


95 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_CT_BASE
),

96 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_CT_BASE
),

97 .
	gÀngth
 = 
SZ_4K
,

98 .
	gty≥
 = 
MT_DEVICE


100 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_IC_BASE
),

101 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_IC_BASE
),

102 .
	gÀngth
 = 
SZ_4K
,

103 .
	gty≥
 = 
MT_DEVICE


105 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_UART0_BASE
),

106 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_UART0_BASE
),

107 .
	gÀngth
 = 
SZ_4K
,

108 .
	gty≥
 = 
MT_DEVICE


110 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_UART1_BASE
),

111 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_UART1_BASE
),

112 .
	gÀngth
 = 
SZ_4K
,

113 .
	gty≥
 = 
MT_DEVICE


115 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_DBG_BASE
),

116 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_DBG_BASE
),

117 .
	gÀngth
 = 
SZ_4K
,

118 .
	gty≥
 = 
MT_DEVICE


120 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_GPIO_BASE
),

121 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_GPIO_BASE
),

122 .
	gÀngth
 = 
SZ_4K
,

123 .
	gty≥
 = 
MT_DEVICE


125 .
	gvútuÆ
 = 
PCI_MEMORY_VADDR
,

126 .
	gp‚
 = 
__phys_to_p‚
(
PHYS_PCI_MEM_BASE
),

127 .
	gÀngth
 = 
SZ_16M
,

128 .
	gty≥
 = 
MT_DEVICE


130 .
	gvútuÆ
 = 
PCI_CONFIG_VADDR
,

131 .
	gp‚
 = 
__phys_to_p‚
(
PHYS_PCI_CONFIG_BASE
),

132 .
	gÀngth
 = 
SZ_16M
,

133 .
	gty≥
 = 
MT_DEVICE


135 .
	gvútuÆ
 = 
PCI_V3_VADDR
,

136 .
	gp‚
 = 
__phys_to_p‚
(
PHYS_PCI_V3_BASE
),

137 .
	gÀngth
 = 
SZ_64K
,

138 .
	gty≥
 = 
MT_DEVICE


140 .
	gvútuÆ
 = 
PCI_IO_VADDR
,

141 .
	gp‚
 = 
__phys_to_p‚
(
PHYS_PCI_IO_BASE
),

142 .
	gÀngth
 = 
SZ_64K
,

143 .
	gty≥
 = 
MT_DEVICE


147 
__öô
 
	$≠_m≠_io
()

149 
	`iŸabÀ_öô
(
≠_io_desc
, 
	`ARRAY_SIZE
(ap_io_desc));

150 
	}
}

152 
	#INTEGRATOR_SC_VALID_INT
 0x003fffff

	)

154 
	$sc_mask_úq
(
úq
)

156 
	`wrôñ
(1 << 
úq
, 
VA_IC_BASE
 + 
IRQ_ENABLE_CLEAR
);

157 
	}
}

159 
	$sc_unmask_úq
(
úq
)

161 
	`wrôñ
(1 << 
úq
, 
VA_IC_BASE
 + 
IRQ_ENABLE_SET
);

162 
	}
}

164 
úq_chù
 
	gsc_chù
 = {

165 .
«me
 = "SC",

166 .
	gack
 = 
sc_mask_úq
,

167 .
	gmask
 = 
sc_mask_úq
,

168 .
	gunmask
 = 
sc_unmask_úq
,

171 
__öô
 
	$≠_öô_úq
()

173 
i
;

177 
	`wrôñ
(-1, 
VA_CMIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

180 
	`wrôñ
(-1, 
VA_IC_BASE
 + 
IRQ_ENABLE_CLEAR
);

181 
	`wrôñ
(-1, 
VA_IC_BASE
 + 
FIQ_ENABLE_CLEAR
);

183 
i
 = 0; i < 
NR_IRQS
; i++) {

184 i‡(((1 << 
i
Ë& 
INTEGRATOR_SC_VALID_INT
) != 0) {

185 
	`£t_úq_chù
(
i
, &
sc_chù
);

186 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

187 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

190 
	}
}

192 #ifde‡
CONFIG_PM


193 
	gic_úq_íabÀ
;

195 
	$úq_su•íd
(
sys_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

197 
ic_úq_íabÀ
 = 
	`ªadl
(
VA_IC_BASE
 + 
IRQ_ENABLE
);

199 
	}
}

201 
	$úq_ªsume
(
sys_devi˚
 *
dev
)

204 
	`wrôñ
(-1, 
VA_CMIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

205 
	`wrôñ
(-1, 
VA_IC_BASE
 + 
IRQ_ENABLE_CLEAR
);

206 
	`wrôñ
(-1, 
VA_IC_BASE
 + 
FIQ_ENABLE_CLEAR
);

208 
	`wrôñ
(
ic_úq_íabÀ
, 
VA_IC_BASE
 + 
IRQ_ENABLE_SET
);

210 
	}
}

212 
	#úq_su•íd
 
NULL


	)

213 
	#úq_ªsume
 
NULL


	)

216 
sysdev_˛ass
 
	gúq_˛ass
 = {

217 
£t_k£t_«me
("irq"),

218 .
su•íd
 = 
úq_su•íd
,

219 .
	gªsume
 = 
úq_ªsume
,

222 
sys_devi˚
 
	gúq_devi˚
 = {

223 .
id
 = 0,

224 .
	g˛s
 = &
úq_˛ass
,

227 
__öô
 
	$úq_öô_sysfs
()

229 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
úq_˛ass
);

230 i‡(
ªt
 == 0)

231 
ªt
 = 
	`sysdev_ªgi°î
(&
úq_devi˚
);

232  
ªt
;

233 
	}
}

235 
devi˚_öôˇŒ
(
úq_öô_sysfs
);

240 
	#SC_CTRLC
 (
VA_SC_BASE
 + 
INTEGRATOR_SC_CTRLC_OFFSET
)

	)

241 
	#SC_CTRLS
 (
VA_SC_BASE
 + 
INTEGRATOR_SC_CTRLS_OFFSET
)

	)

242 
	#EBI_CSR1
 (
VA_EBI_BASE
 + 
INTEGRATOR_EBI_CSR1_OFFSET
)

	)

243 
	#EBI_LOCK
 (
VA_EBI_BASE
 + 
INTEGRATOR_EBI_LOCK_OFFSET
)

	)

245 
	$≠_Êash_öô
()

247 
u32
 
tmp
;

249 
	`wrôñ
(
INTEGRATOR_SC_CTRL_nFLVPPEN
 | 
INTEGRATOR_SC_CTRL_nFLWP
, 
SC_CTRLC
);

251 
tmp
 = 
	`ªadl
(
EBI_CSR1
Ë| 
INTEGRATOR_EBI_WRITE_ENABLE
;

252 
	`wrôñ
(
tmp
, 
EBI_CSR1
);

254 i‡(!(
	`ªadl
(
EBI_CSR1
Ë& 
INTEGRATOR_EBI_WRITE_ENABLE
)) {

255 
	`wrôñ
(0xa05f, 
EBI_LOCK
);

256 
	`wrôñ
(
tmp
, 
EBI_CSR1
);

257 
	`wrôñ
(0, 
EBI_LOCK
);

260 
	}
}

262 
	$≠_Êash_exô
()

264 
u32
 
tmp
;

266 
	`wrôñ
(
INTEGRATOR_SC_CTRL_nFLVPPEN
 | 
INTEGRATOR_SC_CTRL_nFLWP
, 
SC_CTRLC
);

268 
tmp
 = 
	`ªadl
(
EBI_CSR1
Ë& ~
INTEGRATOR_EBI_WRITE_ENABLE
;

269 
	`wrôñ
(
tmp
, 
EBI_CSR1
);

271 i‡(
	`ªadl
(
EBI_CSR1
Ë& 
INTEGRATOR_EBI_WRITE_ENABLE
) {

272 
	`wrôñ
(0xa05f, 
EBI_LOCK
);

273 
	`wrôñ
(
tmp
, 
EBI_CSR1
);

274 
	`wrôñ
(0, 
EBI_LOCK
);

276 
	}
}

278 
	$≠_Êash_£t_vµ
(
⁄
)

280 
ªg
 = 
⁄
 ? 
SC_CTRLS
 : 
SC_CTRLC
;

282 
	`wrôñ
(
INTEGRATOR_SC_CTRL_nFLVPPEN
, 
ªg
);

283 
	}
}

285 
Êash_∂©f‹m_d©a
 
	g≠_Êash_d©a
 = {

286 .
m≠_«me
 = "cfi_probe",

287 .
	gwidth
 = 4,

288 .
	göô
 = 
≠_Êash_öô
,

289 .
	gexô
 = 
≠_Êash_exô
,

290 .
	g£t_vµ
 = 
≠_Êash_£t_vµ
,

293 
ªsour˚
 
	gcfi_Êash_ªsour˚
 = {

294 .
°¨t
 = 
INTEGRATOR_FLASH_BASE
,

295 .
	gíd
 = 
INTEGRATOR_FLASH_BASE
 + 
INTEGRATOR_FLASH_SIZE
 - 1,

296 .
	gÊags
 = 
IORESOURCE_MEM
,

299 
∂©f‹m_devi˚
 
	gcfi_Êash_devi˚
 = {

300 .
«me
 = "armflash",

301 .
	gid
 = 0,

302 .
	gdev
 = {

303 .
∂©f‹m_d©a
 = &
≠_Êash_d©a
,

305 .
	gnum_ªsour˚s
 = 1,

306 .
	gªsour˚
 = &
cfi_Êash_ªsour˚
,

309 
__öô
 
	$≠_öô
()

311 
sc_dec
;

312 
i
;

314 
	`∂©f‹m_devi˚_ªgi°î
(&
cfi_Êash_devi˚
);

316 
sc_dec
 = 
	`ªadl
(
VA_SC_BASE
 + 
INTEGRATOR_SC_DEC_OFFSET
);

317 
i
 = 0; i < 4; i++) {

318 
lm_devi˚
 *
lmdev
;

320 i‡((
sc_dec
 & (16 << 
i
)) == 0)

323 
lmdev
 = 
	`kzÆloc
((
lm_devi˚
), 
GFP_KERNEL
);

324 i‡(!
lmdev
)

327 
lmdev
->
ªsour˚
.
°¨t
 = 0xc0000000 + 0x10000000 * 
i
;

328 
lmdev
->
ªsour˚
.
íd
 =Ümdev->ªsour˚.
°¨t
 + 0x0fffffff;

329 
lmdev
->
ªsour˚
.
Êags
 = 
IORESOURCE_MEM
;

330 
lmdev
->
úq
 = 
IRQ_AP_EXPINT0
 + 
i
;

331 
lmdev
->
id
 = 
i
;

333 
	`lm_devi˚_ªgi°î
(
lmdev
);

335 
	}
}

337 
__öô
 
	$≠_öô_timî
()

339 
	`öãgøt‹_time_öô
(1000000 * 
TICKS_PER_uSEC
 / 
HZ
, 0);

340 
	}
}

342 
sys_timî
 
	g≠_timî
 = {

343 .
öô
 = 
≠_öô_timî
,

344 .
	goff£t
 = 
öãgøt‹_gëtimeoff£t
,

347 
MACHINE_START
(
INTEGRATOR
, "ARM-Integrator")

349 .
	gphys_io
 = 0x16000000,

350 .
	gio_pg_off°
 = ((0xf1600000) >> 18) & 0xfffc,

351 .
	gboŸ_∑øms
 = 0x00000100,

352 .
	gm≠_io
 = 
≠_m≠_io
,

353 .
	göô_úq
 = 
≠_öô_úq
,

354 .
	gtimî
 = &
≠_timî
,

355 .
	göô_machöe
 = 
≠_öô
,

356 
	gMACHINE_END


	@arch/arm/mach-integrator/integrator_cp.c

10 
	~<löux/ty≥s.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/li°.h
>

14 
	~<löux/∂©f‹m_devi˚.h
>

15 
	~<löux/dma-m≠pög.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/°rög.h
>

18 
	~<löux/sysdev.h
>

19 
	~<löux/amba/bus.h
>

20 
	~<löux/amba/kmi.h
>

21 
	~<löux/amba/˛cd.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/io.h
>

25 
	~<asm/úq.h
>

26 
	~<asm/£tup.h
>

27 
	~<asm/mach-ty≥s.h
>

28 
	~<asm/h¨dw¨e/ic°525.h
>

30 
	~<asm/¨ch/cm.h
>

31 
	~<asm/¨ch/lm.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/Êash.h
>

35 
	~<asm/mach/úq.h
>

36 
	~<asm/mach/mmc.h
>

37 
	~<asm/mach/m≠.h
>

38 
	~<asm/mach/time.h
>

40 
	~"comm⁄.h
"

41 
	~"˛ock.h
"

43 
	#INTCP_PA_MMC_BASE
 0x1c000000

	)

44 
	#INTCP_PA_AACI_BASE
 0x1d000000

	)

46 
	#INTCP_PA_FLASH_BASE
 0x24000000

	)

47 
	#INTCP_FLASH_SIZE
 
SZ_32M


	)

49 
	#INTCP_PA_CLCD_BASE
 0xc0000000

	)

51 
	#INTCP_VA_CIC_BASE
 0xf1000040

	)

52 
	#INTCP_VA_PIC_BASE
 0xf1400000

	)

53 
	#INTCP_VA_SIC_BASE
 0xfˇ00000

	)

55 
	#INTCP_PA_ETH_BASE
 0xc8000000

	)

56 
	#INTCP_ETH_SIZE
 0x10

	)

58 
	#INTCP_VA_CTRL_BASE
 0xfcb00000

	)

59 
	#INTCP_FLASHPROG
 0x04

	)

60 
	#CINTEGRATOR_FLASHPROG_FLVPPEN
 (1 << 0)

	)

61 
	#CINTEGRATOR_FLASHPROG_FLWREN
 (1 << 1)

	)

76 
m≠_desc
 
	göt˝_io_desc
[] 
	g__öôd©a
 = {

78 .
vútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_HDR_BASE
),

79 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_HDR_BASE
),

80 .
	gÀngth
 = 
SZ_4K
,

81 .
	gty≥
 = 
MT_DEVICE


83 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_SC_BASE
),

84 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_SC_BASE
),

85 .
	gÀngth
 = 
SZ_4K
,

86 .
	gty≥
 = 
MT_DEVICE


88 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_EBI_BASE
),

89 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_EBI_BASE
),

90 .
	gÀngth
 = 
SZ_4K
,

91 .
	gty≥
 = 
MT_DEVICE


93 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_CT_BASE
),

94 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_CT_BASE
),

95 .
	gÀngth
 = 
SZ_4K
,

96 .
	gty≥
 = 
MT_DEVICE


98 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_IC_BASE
),

99 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_IC_BASE
),

100 .
	gÀngth
 = 
SZ_4K
,

101 .
	gty≥
 = 
MT_DEVICE


103 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_UART0_BASE
),

104 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_UART0_BASE
),

105 .
	gÀngth
 = 
SZ_4K
,

106 .
	gty≥
 = 
MT_DEVICE


108 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_UART1_BASE
),

109 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_UART1_BASE
),

110 .
	gÀngth
 = 
SZ_4K
,

111 .
	gty≥
 = 
MT_DEVICE


113 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_DBG_BASE
),

114 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_DBG_BASE
),

115 .
	gÀngth
 = 
SZ_4K
,

116 .
	gty≥
 = 
MT_DEVICE


118 .
	gvútuÆ
 = 
IO_ADDRESS
(
INTEGRATOR_GPIO_BASE
),

119 .
	gp‚
 = 
__phys_to_p‚
(
INTEGRATOR_GPIO_BASE
),

120 .
	gÀngth
 = 
SZ_4K
,

121 .
	gty≥
 = 
MT_DEVICE


123 .
	gvútuÆ
 = 0xfca00000,

124 .
	gp‚
 = 
__phys_to_p‚
(0xca000000),

125 .
	gÀngth
 = 
SZ_4K
,

126 .
	gty≥
 = 
MT_DEVICE


128 .
	gvútuÆ
 = 0xfcb00000,

129 .
	gp‚
 = 
__phys_to_p‚
(0xcb000000),

130 .
	gÀngth
 = 
SZ_4K
,

131 .
	gty≥
 = 
MT_DEVICE


135 
__öô
 
	$öt˝_m≠_io
()

137 
	`iŸabÀ_öô
(
öt˝_io_desc
, 
	`ARRAY_SIZE
(intcp_io_desc));

138 
	}
}

140 
	#cic_wrôñ
 
__øw_wrôñ


	)

141 
	#cic_ªadl
 
__øw_ªadl


	)

142 
	#pic_wrôñ
 
__øw_wrôñ


	)

143 
	#pic_ªadl
 
__øw_ªadl


	)

144 
	#sic_wrôñ
 
__øw_wrôñ


	)

145 
	#sic_ªadl
 
__øw_ªadl


	)

147 
	$cic_mask_úq
(
úq
)

149 
úq
 -
IRQ_CIC_START
;

150 
	`cic_wrôñ
(1 << 
úq
, 
INTCP_VA_CIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

151 
	}
}

153 
	$cic_unmask_úq
(
úq
)

155 
úq
 -
IRQ_CIC_START
;

156 
	`cic_wrôñ
(1 << 
úq
, 
INTCP_VA_CIC_BASE
 + 
IRQ_ENABLE_SET
);

157 
	}
}

159 
úq_chù
 
	gcic_chù
 = {

160 .
«me
 = "CIC",

161 .
	gack
 = 
cic_mask_úq
,

162 .
	gmask
 = 
cic_mask_úq
,

163 .
	gunmask
 = 
cic_unmask_úq
,

166 
	$pic_mask_úq
(
úq
)

168 
úq
 -
IRQ_PIC_START
;

169 
	`pic_wrôñ
(1 << 
úq
, 
INTCP_VA_PIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

170 
	}
}

172 
	$pic_unmask_úq
(
úq
)

174 
úq
 -
IRQ_PIC_START
;

175 
	`pic_wrôñ
(1 << 
úq
, 
INTCP_VA_PIC_BASE
 + 
IRQ_ENABLE_SET
);

176 
	}
}

178 
úq_chù
 
	gpic_chù
 = {

179 .
«me
 = "PIC",

180 .
	gack
 = 
pic_mask_úq
,

181 .
	gmask
 = 
pic_mask_úq
,

182 .
	gunmask
 = 
pic_unmask_úq
,

185 
	$sic_mask_úq
(
úq
)

187 
úq
 -
IRQ_SIC_START
;

188 
	`sic_wrôñ
(1 << 
úq
, 
INTCP_VA_SIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

189 
	}
}

191 
	$sic_unmask_úq
(
úq
)

193 
úq
 -
IRQ_SIC_START
;

194 
	`sic_wrôñ
(1 << 
úq
, 
INTCP_VA_SIC_BASE
 + 
IRQ_ENABLE_SET
);

195 
	}
}

197 
úq_chù
 
	gsic_chù
 = {

198 .
«me
 = "SIC",

199 .
	gack
 = 
sic_mask_úq
,

200 .
	gmask
 = 
sic_mask_úq
,

201 .
	gunmask
 = 
sic_unmask_úq
,

205 
	$sic_h™dÀ_úq
(
úq
, 
úq_desc
 *
desc
)

207 
°©us
 = 
	`sic_ªadl
(
INTCP_VA_SIC_BASE
 + 
IRQ_STATUS
);

209 i‡(
°©us
 == 0) {

210 
	`do_bad_IRQ
(
úq
, 
desc
);

215 
úq
 = 
	`ffs
(
°©us
) - 1;

216 
°©us
 &~(1 << 
úq
);

218 
úq
 +
IRQ_SIC_START
;

220 
desc
 = 
úq_desc
 + 
úq
;

221 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

222 } 
°©us
);

223 
	}
}

225 
__öô
 
	$öt˝_öô_úq
()

227 
i
;

232 
	`pic_wrôñ
(0xffffffff, 
INTCP_VA_PIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

233 
	`pic_wrôñ
(0xffffffff, 
INTCP_VA_PIC_BASE
 + 
FIQ_ENABLE_CLEAR
);

235 
i
 = 
IRQ_PIC_START
; i <
IRQ_PIC_END
; i++) {

236 i‡(
i
 == 11)

237 
i
 = 22;

238 i‡(
i
 == 29)

240 
	`£t_úq_chù
(
i
, &
pic_chù
);

241 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

242 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

245 
	`cic_wrôñ
(0xffffffff, 
INTCP_VA_CIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

246 
	`cic_wrôñ
(0xffffffff, 
INTCP_VA_CIC_BASE
 + 
FIQ_ENABLE_CLEAR
);

248 
i
 = 
IRQ_CIC_START
; i <
IRQ_CIC_END
; i++) {

249 
	`£t_úq_chù
(
i
, &
cic_chù
);

250 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

251 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

254 
	`sic_wrôñ
(0x00000fff, 
INTCP_VA_SIC_BASE
 + 
IRQ_ENABLE_CLEAR
);

255 
	`sic_wrôñ
(0x00000fff, 
INTCP_VA_SIC_BASE
 + 
FIQ_ENABLE_CLEAR
);

257 
i
 = 
IRQ_SIC_START
; i <
IRQ_SIC_END
; i++) {

258 
	`£t_úq_chù
(
i
, &
sic_chù
);

259 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

260 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

263 
	`£t_úq_chaöed_h™dÀr
(
IRQ_CP_CPPLDINT
, 
sic_h™dÀ_úq
);

264 
	}
}

269 
	#CM_LOCK
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+
INTEGRATOR_HDR_LOCK_OFFSET
)

	)

270 
	#CM_AUXOSC
 (
	`IO_ADDRESS
(
INTEGRATOR_HDR_BASE
)+0x1c)

	)

272 c⁄° 
ic°525_∑øms
 
	g˝_auxvco_∑øms
 = {

273 .
ªf
 = 24000,

274 .
	gvco_max
 = 320000,

275 .
	gvd_mö
 = 8,

276 .
	gvd_max
 = 263,

277 .
	grd_mö
 = 3,

278 .
	grd_max
 = 65,

281 
	$˝_auxvco_£t
(
˛k
 *˛k, 
ic°525_vco
 
vco
)

283 
u32
 
vÆ
;

285 
vÆ
 = 
	`ªadl
(
CM_AUXOSC
) & ~0x7ffff;

286 
vÆ
 |
vco
.
v
 | (vco.
r
 << 9Ë| (vco.
s
 << 16);

288 
	`wrôñ
(0xa05f, 
CM_LOCK
);

289 
	`wrôñ
(
vÆ
, 
CM_AUXOSC
);

290 
	`wrôñ
(0, 
CM_LOCK
);

291 
	}
}

293 
˛k
 
	g˝_˛cd_˛k
 = {

294 .
«me
 = "CLCDCLK",

295 .
	g∑øms
 = &
˝_auxvco_∑øms
,

296 .
	g£tvco
 = 
˝_auxvco_£t
,

299 
˛k
 
	g˝_mmci_˛k
 = {

300 .
«me
 = "MCLK",

301 .
	gøã
 = 14745600,

307 
	$öt˝_Êash_öô
()

309 
u32
 
vÆ
;

311 
vÆ
 = 
	`ªadl
(
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

312 
vÆ
 |
CINTEGRATOR_FLASHPROG_FLWREN
;

313 
	`wrôñ
(
vÆ
, 
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

316 
	}
}

318 
	$öt˝_Êash_exô
()

320 
u32
 
vÆ
;

322 
vÆ
 = 
	`ªadl
(
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

323 
vÆ
 &~(
CINTEGRATOR_FLASHPROG_FLVPPEN
|
CINTEGRATOR_FLASHPROG_FLWREN
);

324 
	`wrôñ
(
vÆ
, 
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

325 
	}
}

327 
	$öt˝_Êash_£t_vµ
(
⁄
)

329 
u32
 
vÆ
;

331 
vÆ
 = 
	`ªadl
(
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

332 i‡(
⁄
)

333 
vÆ
 |
CINTEGRATOR_FLASHPROG_FLVPPEN
;

335 
vÆ
 &~
CINTEGRATOR_FLASHPROG_FLVPPEN
;

336 
	`wrôñ
(
vÆ
, 
INTCP_VA_CTRL_BASE
 + 
INTCP_FLASHPROG
);

337 
	}
}

339 
Êash_∂©f‹m_d©a
 
	göt˝_Êash_d©a
 = {

340 .
m≠_«me
 = "cfi_probe",

341 .
	gwidth
 = 4,

342 .
	göô
 = 
öt˝_Êash_öô
,

343 .
	gexô
 = 
öt˝_Êash_exô
,

344 .
	g£t_vµ
 = 
öt˝_Êash_£t_vµ
,

347 
ªsour˚
 
	göt˝_Êash_ªsour˚
 = {

348 .
°¨t
 = 
INTCP_PA_FLASH_BASE
,

349 .
	gíd
 = 
INTCP_PA_FLASH_BASE
 + 
INTCP_FLASH_SIZE
 - 1,

350 .
	gÊags
 = 
IORESOURCE_MEM
,

353 
∂©f‹m_devi˚
 
	göt˝_Êash_devi˚
 = {

354 .
«me
 = "armflash",

355 .
	gid
 = 0,

356 .
	gdev
 = {

357 .
∂©f‹m_d©a
 = &
öt˝_Êash_d©a
,

359 .
	gnum_ªsour˚s
 = 1,

360 .
	gªsour˚
 = &
öt˝_Êash_ªsour˚
,

363 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

365 .
°¨t
 = 
INTCP_PA_ETH_BASE
,

366 .
	gíd
 = 
INTCP_PA_ETH_BASE
 + 
INTCP_ETH_SIZE
 - 1,

367 .
	gÊags
 = 
IORESOURCE_MEM
,

370 .
°¨t
 = 
IRQ_CP_ETHINT
,

371 .
	gíd
 = 
IRQ_CP_ETHINT
,

372 .
	gÊags
 = 
IORESOURCE_IRQ
,

376 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

377 .
«me
 = "smc91x",

378 .
	gid
 = 0,

379 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

380 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

383 
∂©f‹m_devi˚
 *
	göt˝_devs
[] 
	g__öôd©a
 = {

384 &
öt˝_Êash_devi˚
,

385 &
smc91x_devi˚
,

394 
	$mmc_°©us
(
devi˚
 *
dev
)

396 
°©us
 = 
	`ªadl
(0xfca00004);

397 
	`wrôñ
(8, 0xfcb00008);

399  
°©us
 & 8;

400 
	}
}

402 
mmc_∂©f‹m_d©a
 
	gmmc_d©a
 = {

403 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

404 .
	g°©us
 = 
mmc_°©us
,

407 
amba_devi˚
 
	gmmc_devi˚
 = {

408 .
dev
 = {

409 .
bus_id
 = "mb:1c",

410 .
	g∂©f‹m_d©a
 = &
mmc_d©a
,

412 .
	gªs
 = {

413 .
°¨t
 = 
INTCP_PA_MMC_BASE
,

414 .
	gíd
 = 
INTCP_PA_MMC_BASE
 + 
SZ_4K
 - 1,

415 .
	gÊags
 = 
IORESOURCE_MEM
,

417 .
	gúq
 = { 
IRQ_CP_MMCIINT0
, 
IRQ_CP_MMCIINT1
 },

418 .
	g≥rùhid
 = 0,

421 
amba_devi˚
 
	gØci_devi˚
 = {

422 .
dev
 = {

423 .
bus_id
 = "mb:1d",

425 .
	gªs
 = {

426 .
°¨t
 = 
INTCP_PA_AACI_BASE
,

427 .
	gíd
 = 
INTCP_PA_AACI_BASE
 + 
SZ_4K
 - 1,

428 .
	gÊags
 = 
IORESOURCE_MEM
,

430 .
	gúq
 = { 
IRQ_CP_AACIINT
, 
NO_IRQ
 },

431 .
	g≥rùhid
 = 0,

438 
˛cd_∑√l
 
	gvga
 = {

439 .
mode
 = {

440 .
«me
 = "VGA",

441 .
	gª‰esh
 = 60,

442 .
	gxªs
 = 640,

443 .
	gyªs
 = 480,

444 .
	gpix˛ock
 = 39721,

445 .
	gÀ·_m¨gö
 = 40,

446 .
	gright_m¨gö
 = 24,

447 .
	guµî_m¨gö
 = 32,

448 .
	glowî_m¨gö
 = 11,

449 .
	ghsync_Àn
 = 96,

450 .
	gvsync_Àn
 = 2,

451 .
	gsync
 = 0,

452 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

454 .
	gwidth
 = -1,

455 .
	gheight
 = -1,

456 .
	gtim2
 = 
TIM2_BCD
 | 
TIM2_IPC
,

457 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

458 .
	gbµ
 = 16,

459 .
	ggøysˇÀ
 = 0,

465 
	$˝_˛cd_íabÀ
(
˛cd_fb
 *
fb
)

467 
u32
 
vÆ
;

469 i‡(
fb
->fb.
v¨
.
bôs_≥r_pixñ
 <= 8)

470 
vÆ
 = 
CM_CTRL_LCDMUXSEL_VGA_8421BPP
;

471 i‡(
fb
->fb.
v¨
.
bôs_≥r_pixñ
 <= 16)

472 
vÆ
 = 
CM_CTRL_LCDMUXSEL_VGA_16BPP


473 | 
CM_CTRL_LCDEN0
 | 
CM_CTRL_LCDEN1


474 | 
CM_CTRL_STATIC1
 | 
CM_CTRL_STATIC2
;

476 
vÆ
 = 0;

478 
	`cm_c⁄åﬁ
(
CM_CTRL_LCDMUXSEL_MASK
|

479 
CM_CTRL_LCDEN0
|

480 
CM_CTRL_LCDEN1
|

481 
CM_CTRL_STATIC1
|

482 
CM_CTRL_STATIC2
|

483 
CM_CTRL_STATIC
|

484 
CM_CTRL_n24BITEN
, 
vÆ
);

485 
	}
}

487 
	g‰amesize
 = 
SZ_1M
;

489 
	$˝_˛cd_£tup
(
˛cd_fb
 *
fb
)

491 
dma_addr_t
 
dma
;

493 
fb
->
∑√l
 = &
vga
;

495 
fb
->fb.
s¸ìn_ba£
 = 
	`dma_Æloc_wrôecomböe
(&fb->
dev
->dev, 
‰amesize
,

496 &
dma
, 
GFP_KERNEL
);

497 i‡(!
fb
->fb.
s¸ìn_ba£
) {

498 
	`¥ötk
(
KERN_ERR
 "CLCD: unableÅo map framebuffer\n");

499  -
ENOMEM
;

502 
fb
->fb.
fix
.
smem_°¨t
 = 
dma
;

503 
fb
->fb.
fix
.
smem_Àn
 = 
‰amesize
;

506 
	}
}

508 
	$˝_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

510  
	`dma_mm≠_wrôecomböe
(&
fb
->
dev
->dev, 
vma
,

511 
fb
->fb.
s¸ìn_ba£
,

512 
fb
->fb.
fix
.
smem_°¨t
,

513 
fb
->fb.
fix
.
smem_Àn
);

514 
	}
}

516 
	$˝_˛cd_ªmove
(
˛cd_fb
 *
fb
)

518 
	`dma_‰ì_wrôecomböe
(&
fb
->
dev
->dev, fb->fb.
fix
.
smem_Àn
,

519 
fb
->fb.
s¸ìn_ba£
, fb->fb.
fix
.
smem_°¨t
);

520 
	}
}

522 
˛cd_bﬂrd
 
	g˛cd_d©a
 = {

523 .
«me
 = "Integrator/CP",

524 .
	gcheck
 = 
˛cdfb_check
,

525 .
	gdecode
 = 
˛cdfb_decode
,

526 .
	gíabÀ
 = 
˝_˛cd_íabÀ
,

527 .
	g£tup
 = 
˝_˛cd_£tup
,

528 .
	gmm≠
 = 
˝_˛cd_mm≠
,

529 .
	gªmove
 = 
˝_˛cd_ªmove
,

532 
amba_devi˚
 
	g˛cd_devi˚
 = {

533 .
dev
 = {

534 .
bus_id
 = "mb:c0",

535 .
	gcohîít_dma_mask
 = ~0,

536 .
	g∂©f‹m_d©a
 = &
˛cd_d©a
,

538 .
	gªs
 = {

539 .
°¨t
 = 
INTCP_PA_CLCD_BASE
,

540 .
	gíd
 = 
INTCP_PA_CLCD_BASE
 + 
SZ_4K
 - 1,

541 .
	gÊags
 = 
IORESOURCE_MEM
,

543 .
	gdma_mask
 = ~0,

544 .
	gúq
 = { 
IRQ_CP_CLCDCINT
, 
NO_IRQ
 },

545 .
	g≥rùhid
 = 0,

548 
amba_devi˚
 *
	gamba_devs
[] 
	g__öôd©a
 = {

549 &
mmc_devi˚
,

550 &
Øci_devi˚
,

551 &
˛cd_devi˚
,

554 
__öô
 
	$öt˝_öô
()

556 
i
;

558 
	`˛k_ªgi°î
(&
˝_˛cd_˛k
);

559 
	`˛k_ªgi°î
(&
˝_mmci_˛k
);

561 
	`∂©f‹m_add_devi˚s
(
öt˝_devs
, 
	`ARRAY_SIZE
(intcp_devs));

563 
i
 = 0; i < 
	`ARRAY_SIZE
(
amba_devs
); i++) {

564 
amba_devi˚
 *
d
 = 
amba_devs
[
i
];

565 
	`amba_devi˚_ªgi°î
(
d
, &
iomem_ªsour˚
);

567 
	}
}

569 
	#TIMER_CTRL_IE
 (1 << 5Ë

	)

571 
__öô
 
	$öt˝_timî_öô
()

573 
	`öãgøt‹_time_öô
(1000000 / 
HZ
, 
TIMER_CTRL_IE
);

574 
	}
}

576 
sys_timî
 
	g˝_timî
 = {

577 .
öô
 = 
öt˝_timî_öô
,

578 .
	goff£t
 = 
öãgøt‹_gëtimeoff£t
,

581 
MACHINE_START
(
CINTEGRATOR
, "ARM-IntegratorCP")

583 .
	gphys_io
 = 0x16000000,

584 .
	gio_pg_off°
 = ((0xf1600000) >> 18) & 0xfffc,

585 .
	gboŸ_∑øms
 = 0x00000100,

586 .
	gm≠_io
 = 
öt˝_m≠_io
,

587 .
	göô_úq
 = 
öt˝_öô_úq
,

588 .
	gtimî
 = &
˝_timî
,

589 .
	göô_machöe
 = 
öt˝_öô
,

590 
	gMACHINE_END


	@arch/arm/mach-integrator/leds.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/smp.h
>

26 
	~<löux/•ölock.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/io.h
>

30 
	~<asm/Àds.h
>

31 
	~<asm/sy°em.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/¨ch/cm.h
>

35 
	gßved_Àds
;

37 
	$öãgøt‹_Àds_evít
(
Àd_evít_t
 
Àdevt
)

39 
Êags
;

40 c⁄° 
dbg_ba£
 = 
	`IO_ADDRESS
(
INTEGRATOR_DBG_BASE
);

41 
upd©e_Æpha_Àds
;

44 
	`loˇl_úq_ßve
(
Êags
);

45 
upd©e_Æpha_Àds
 = 0;

47 
Àdevt
) {

48 
Àd_idÀ_°¨t
:

49 
	`cm_c⁄åﬁ
(
CM_CTRL_LED
, 0);

52 
Àd_idÀ_íd
:

53 
	`cm_c⁄åﬁ
(
CM_CTRL_LED
, CM_CTRL_LED);

56 
Àd_timî
:

57 
ßved_Àds
 ^
GREEN_LED
;

58 
upd©e_Æpha_Àds
 = 1;

61 
Àd_ªd_⁄
:

62 
ßved_Àds
 |
RED_LED
;

63 
upd©e_Æpha_Àds
 = 1;

66 
Àd_ªd_off
:

67 
ßved_Àds
 &~
RED_LED
;

68 
upd©e_Æpha_Àds
 = 1;

75 i‡(
upd©e_Æpha_Àds
) {

76 
	`__øw_ªadl
(
dbg_ba£
 + 
INTEGRATOR_DBG_ALPHA_OFFSET
) & 1);

77 
	`__øw_wrôñ
(
ßved_Àds
, 
dbg_ba£
 + 
INTEGRATOR_DBG_LEDS_OFFSET
);

79 
	`loˇl_úq_ª°‹e
(
Êags
);

80 
	}
}

82 
__öô
 
	$Àds_öô
()

84 i‡(
	`machöe_is_öãgøt‹
(Ë|| 
	`machöe_is_cöãgøt‹
())

85 
Àds_evít
 = 
öãgøt‹_Àds_evít
;

88 
	}
}

90 
c‹e_öôˇŒ
(
Àds_öô
);

	@arch/arm/mach-integrator/lm.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/devi˚.h
>

13 
	~<löux/¶ab.h
>

15 
	~<asm/¨ch/lm.h
>

17 
	#to_lm_devi˚
(
d
Ë
	`c⁄èöî_of
(d, 
lm_devi˚
, 
dev
)

	)

18 
	#to_lm_drivî
(
d
Ë
	`c⁄èöî_of
(d, 
lm_drivî
, 
drv
)

	)

20 
	$lm_m©ch
(
devi˚
 *
dev
, 
devi˚_drivî
 *
drv
)

23 
	}
}

25 
	$lm_bus_¥obe
(
devi˚
 *
dev
)

27 
lm_devi˚
 *
lmdev
 = 
	`to_lm_devi˚
(
dev
);

28 
lm_drivî
 *
lmdrv
 = 
	`to_lm_drivî
(
dev
->
drivî
);

30  
lmdrv
->
	`¥obe
(
lmdev
);

31 
	}
}

33 
	$lm_bus_ªmove
(
devi˚
 *
dev
)

35 
lm_devi˚
 *
lmdev
 = 
	`to_lm_devi˚
(
dev
);

36 
lm_drivî
 *
lmdrv
 = 
	`to_lm_drivî
(
dev
->
drivî
);

38 i‡(
lmdrv
->
ªmove
)

39 
lmdrv
->
	`ªmove
(
lmdev
);

41 
	}
}

43 
bus_ty≥
 
	glm_bu°y≥
 = {

44 .
«me
 = "logicmodule",

45 .
	gm©ch
 = 
lm_m©ch
,

46 .
	g¥obe
 = 
lm_bus_¥obe
,

47 .
	gªmove
 = 
lm_bus_ªmove
,

52 
__öô
 
	$lm_öô
()

54  
	`bus_ªgi°î
(&
lm_bu°y≥
);

55 
	}
}

57 
po°c‹e_öôˇŒ
(
lm_öô
);

59 
	$lm_drivî_ªgi°î
(
lm_drivî
 *
drv
)

61 
drv
->drv.
bus
 = &
lm_bu°y≥
;

62  
	`drivî_ªgi°î
(&
drv
->drv);

63 
	}
}

65 
	$lm_drivî_uƒegi°î
(
lm_drivî
 *
drv
)

67 
	`drivî_uƒegi°î
(&
drv
->drv);

68 
	}
}

70 
	$lm_devi˚_ªÀa£
(
devi˚
 *
dev
)

72 
lm_devi˚
 *
d
 = 
	`to_lm_devi˚
(
dev
);

74 
	`k‰ì
(
d
);

75 
	}
}

77 
	$lm_devi˚_ªgi°î
(
lm_devi˚
 *
dev
)

79 
ªt
;

81 
dev
->dev.
ªÀa£
 = 
lm_devi˚_ªÀa£
;

82 
dev
->dev.
bus
 = &
lm_bu°y≥
;

84 
	`¢¥ötf
(
dev
->dev.
bus_id
, (dev->dev.bus_id), "lm%d", dev->
id
);

85 
dev
->
ªsour˚
.
«me
 = dev->dev.
bus_id
;

87 
ªt
 = 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
dev
->
ªsour˚
);

88 i‡(
ªt
 == 0) {

89 
ªt
 = 
	`devi˚_ªgi°î
(&
dev
->dev);

90 i‡(
ªt
)

91 
	`ªÀa£_ªsour˚
(&
dev
->
ªsour˚
);

93  
ªt
;

94 
	}
}

96 
EXPORT_SYMBOL
(
lm_drivî_ªgi°î
);

97 
EXPORT_SYMBOL
(
lm_drivî_uƒegi°î
);

	@arch/arm/mach-integrator/pci.c

24 
	~<löux/kî√l.h
>

25 
	~<löux/pci.h
>

26 
	~<löux/öãºu±.h
>

27 
	~<löux/öô.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/sy°em.h
>

31 
	~<asm/mach/pci.h
>

32 
	~<asm/mach-ty≥s.h
>

69 
ölöe
 
	$bridge_swizzÀ
(
pö
, 
¶Ÿ
)

71  (
pö
 + 
¶Ÿ
) & 3;

72 
	}
}

77 
u8
 
__öô
 
	$öãgøt‹_swizzÀ
(
pci_dev
 *
dev
, 
u8
 *
pöp
)

79 
pö
 = *
pöp
;

81 i‡(
pö
 == 0)

82 
pö
 = 1;

84 
pö
 -= 1;

85 
dev
->
bus
->
£lf
) {

86 
pö
 = 
	`bridge_swizzÀ
’ö, 
	`PCI_SLOT
(
dev
->
dev‚
));

90 
dev
 = dev->
bus
->
£lf
;

92 *
pöp
 = 
pö
 + 1;

94  
	`PCI_SLOT
(
dev
->
dev‚
);

95 
	}
}

97 
	gúq_èb
[4] 
	g__öôd©a
 = {

98 
IRQ_AP_PCIINT0
, 
IRQ_AP_PCIINT1
, 
IRQ_AP_PCIINT2
, 
IRQ_AP_PCIINT3


105 
__öô
 
	$öãgøt‹_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

107 
öär
 = ((
¶Ÿ
 - 9Ë+ (
pö
 - 1)) & 3;

109  
úq_èb
[
öär
];

110 
	}
}

112 
pci_v3_öô
(*);

114 
hw_pci
 
öãgøt‹_pci
 
	g__öôd©a
 = {

115 .
swizzÀ
 = 
öãgøt‹_swizzÀ
,

116 .
	gm≠_úq
 = 
öãgøt‹_m≠_úq
,

117 .
	g£tup
 = 
pci_v3_£tup
,

118 .
	gƒ_c⁄åﬁÀrs
 = 1,

119 .
	gsˇn
 = 
pci_v3_sˇn_bus
,

120 .
	g¥eöô
 = 
pci_v3_¥eöô
,

121 .
	gpo°öô
 = 
pci_v3_po°öô
,

124 
__öô
 
	$öãgøt‹_pci_öô
()

126 i‡(
	`machöe_is_öãgøt‹
())

127 
	`pci_comm⁄_öô
(&
öãgøt‹_pci
);

129 
	}
}

131 
subsys_öôˇŒ
(
öãgøt‹_pci_öô
);

	@arch/arm/mach-integrator/pci_v3.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/pci.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/i›‹t.h
>

27 
	~<löux/öãºu±.h
>

28 
	~<löux/•ölock.h
>

29 
	~<löux/öô.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/io.h
>

33 
	~<asm/úq.h
>

34 
	~<asm/sy°em.h
>

35 
	~<asm/mach/pci.h
>

36 
	~<asm/úq_ªgs.h
>

38 
	~<asm/h¨dw¨e/pci_v3.h
>

104 
	#v3_wrôeb
(
o
,
v
Ë
	`__øw_wrôeb
(v, 
PCI_V3_VADDR
 + ()(o))

	)

105 
	#v3_ªadb
(
o
Ë(
	`__øw_ªadb
(
PCI_V3_VADDR
 + ()(o)))

	)

107 
	#v3_wrôew
(
o
,
v
Ë
	`__øw_wrôew
(v, 
PCI_V3_VADDR
 + ()(o))

	)

108 
	#v3_ªadw
(
o
Ë(
	`__øw_ªadw
(
PCI_V3_VADDR
 + ()(o)))

	)

110 
	#v3_wrôñ
(
o
,
v
Ë
	`__øw_wrôñ
(v, 
PCI_V3_VADDR
 + ()(o))

	)

111 
	#v3_ªadl
(
o
Ë(
	`__øw_ªadl
(
PCI_V3_VADDR
 + ()(o)))

	)

165 
DEFINE_SPINLOCK
(
v3_lock
);

167 
	#PCI_BUS_NONMEM_START
 0x00000000

	)

168 
	#PCI_BUS_NONMEM_SIZE
 
SZ_256M


	)

170 
	#PCI_BUS_PREMEM_START
 
PCI_BUS_NONMEM_START
 + 
PCI_BUS_NONMEM_SIZE


	)

171 
	#PCI_BUS_PREMEM_SIZE
 
SZ_256M


	)

173 #i‡
PCI_BUS_NONMEM_START
 & 0x000fffff

174 #îr‹ 
PCI_BUS_NONMEM_START
 
mu°
 
be
 
megabyã
 
Æig√d


176 #i‡
PCI_BUS_PREMEM_START
 & 0x000fffff

177 #îr‹ 
PCI_BUS_PREMEM_START
 
mu°
 
be
 
megabyã
 
Æig√d


180 #unde‡
V3_LB_BASE_PREFETCH


181 
	#V3_LB_BASE_PREFETCH
 0

	)

183 
	$v3_›í_c⁄fig_wödow
(
pci_bus
 *
bus
,

184 
dev‚
, 
off£t
)

186 
addªss
, 
m≠addªss
, 
bu¢r
;

188 
bu¢r
 = 
bus
->
numbî
;

193 i‡(
off£t
 > 255)

194 
	`BUG
();

195 i‡(
bu¢r
 > 255)

196 
	`BUG
();

197 i‡(
dev‚
 > 255)

198 
	`BUG
();

200 i‡(
bu¢r
 == 0) {

201 
¶Ÿ
 = 
	`PCI_SLOT
(
dev‚
);

213 
addªss
 = 
	`PCI_FUNC
(
dev‚
) << 8;

214 
m≠addªss
 = 
V3_LB_MAP_TYPE_CONFIG
;

216 i‡(
¶Ÿ
 > 12)

220 
m≠addªss
 |1 << (
¶Ÿ
 - 5);

225 
addªss
 |1 << (
¶Ÿ
 + 11);

239 
m≠addªss
 = 
V3_LB_MAP_TYPE_CONFIG
 | 
V3_LB_MAP_AD_LOW_EN
;

240 
addªss
 = (
bu¢r
 << 16Ë| (
dev‚
 << 8);

248 
	`v3_wrôñ
(
V3_LB_BASE0
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_MEM_BASE
) |

249 
V3_LB_BASE_ADR_SIZE_512MB
 | 
V3_LB_BASE_ENABLE
);

254 
	`v3_wrôñ
(
V3_LB_BASE1
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_CONFIG_BASE
) |

255 
V3_LB_BASE_ADR_SIZE_16MB
 | 
V3_LB_BASE_ENABLE
);

256 
	`v3_wrôew
(
V3_LB_MAP1
, 
m≠addªss
);

258  
PCI_CONFIG_VADDR
 + 
addªss
 + 
off£t
;

259 
	}
}

261 
	$v3_˛o£_c⁄fig_wödow
()

266 
	`v3_wrôñ
(
V3_LB_BASE1
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_MEM_BASE
 + 
SZ_256M
) |

267 
V3_LB_BASE_ADR_SIZE_256MB
 | 
V3_LB_BASE_PREFETCH
 |

268 
V3_LB_BASE_ENABLE
);

269 
	`v3_wrôew
(
V3_LB_MAP1
, 
	`v3_addr_to_lb_m≠
(
PCI_BUS_PREMEM_START
) |

270 
V3_LB_MAP_TYPE_MEM_MULTIPLE
);

275 
	`v3_wrôñ
(
V3_LB_BASE0
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_MEM_BASE
) |

276 
V3_LB_BASE_ADR_SIZE_256MB
 | 
V3_LB_BASE_ENABLE
);

277 
	}
}

279 
	$v3_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

280 
size
, 
u32
 *
vÆ
)

282 
addr
;

283 
Êags
;

284 
u32
 
v
;

286 
	`•ö_lock_úqßve
(&
v3_lock
, 
Êags
);

287 
addr
 = 
	`v3_›í_c⁄fig_wödow
(
bus
, 
dev‚
, 
whîe
);

289 
size
) {

291 
v
 = 
	`__øw_ªadb
(
addr
);

295 
v
 = 
	`__øw_ªadw
(
addr
);

299 
v
 = 
	`__øw_ªadl
(
addr
);

303 
	`v3_˛o£_c⁄fig_wödow
();

304 
	`•ö_u∆ock_úqª°‹e
(&
v3_lock
, 
Êags
);

306 *
vÆ
 = 
v
;

307  
PCIBIOS_SUCCESSFUL
;

308 
	}
}

310 
	$v3_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

311 
size
, 
u32
 
vÆ
)

313 
addr
;

314 
Êags
;

316 
	`•ö_lock_úqßve
(&
v3_lock
, 
Êags
);

317 
addr
 = 
	`v3_›í_c⁄fig_wödow
(
bus
, 
dev‚
, 
whîe
);

319 
size
) {

321 
	`__øw_wrôeb
((
u8
)
vÆ
, 
addr
);

322 
	`__øw_ªadb
(
addr
);

326 
	`__øw_wrôew
((
u16
)
vÆ
, 
addr
);

327 
	`__øw_ªadw
(
addr
);

331 
	`__øw_wrôñ
(
vÆ
, 
addr
);

332 
	`__øw_ªadl
(
addr
);

336 
	`v3_˛o£_c⁄fig_wödow
();

337 
	`•ö_u∆ock_úqª°‹e
(&
v3_lock
, 
Êags
);

339  
PCIBIOS_SUCCESSFUL
;

340 
	}
}

342 
pci_›s
 
	gpci_v3_›s
 = {

343 .
ªad
 = 
v3_ªad_c⁄fig
,

344 .
	gwrôe
 = 
v3_wrôe_c⁄fig
,

347 
ªsour˚
 
	gn⁄_mem
 = {

348 .
«me
 = "PCIÇon-prefetchable",

349 .
	g°¨t
 = 
PHYS_PCI_MEM_BASE
 + 
PCI_BUS_NONMEM_START
,

350 .
	gíd
 = 
PHYS_PCI_MEM_BASE
 + 
PCI_BUS_NONMEM_START
 + 
PCI_BUS_NONMEM_SIZE
 - 1,

351 .
	gÊags
 = 
IORESOURCE_MEM
,

354 
ªsour˚
 
	g¥e_mem
 = {

355 .
«me
 = "PCIÖrefetchable",

356 .
	g°¨t
 = 
PHYS_PCI_MEM_BASE
 + 
PCI_BUS_PREMEM_START
,

357 .
	gíd
 = 
PHYS_PCI_MEM_BASE
 + 
PCI_BUS_PREMEM_START
 + 
PCI_BUS_PREMEM_SIZE
 - 1,

358 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_PREFETCH
,

361 
__öô
 
	$pci_v3_£tup_ªsour˚s
(
ªsour˚
 **resource)

363 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
n⁄_mem
)) {

364 
	`¥ötk
(
KERN_ERR
 "PCI: unableÅoállocateÇon-prefetchable "

366  -
EBUSY
;

368 i‡(
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
¥e_mem
)) {

369 
	`ªÀa£_ªsour˚
(&
n⁄_mem
);

370 
	`¥ötk
(
KERN_ERR
 "PCI: unableÅoállocateÖrefetchable "

372  -
EBUSY
;

380 
ªsour˚
[0] = &
i›‹t_ªsour˚
;

381 
ªsour˚
[1] = &
n⁄_mem
;

382 
ªsour˚
[2] = &
¥e_mem
;

385 
	}
}

392 
	#SC_PCI
 (
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
Ë+ 
INTEGRATOR_SC_PCIENABLE_OFFSET
)

	)

393 
	#SC_LBFADDR
 (
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
Ë+ 0x20)

	)

394 
	#SC_LBFCODE
 (
	`IO_ADDRESS
(
INTEGRATOR_SC_BASE
Ë+ 0x24)

	)

397 
	$v3_pci_Áu…
(
addr
, 
f§
, 
±_ªgs
 *
ªgs
)

399 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

400 
ö°r
 = *(*)
pc
;

402 
buf
[128];

404 
	`•rötf
(
buf
, "V3 fault:áddr 0x%08lx, FSR 0x%03x, PC 0x%08lx [%08lx] LBFADDR=%08x LBFCODE=%02x ISTAT=%02x\n",

405 
addr
, 
f§
, 
pc
, 
ö°r
, 
	`__øw_ªadl
(
SC_LBFADDR
), __øw_ªadl(
SC_LBFCODE
) & 255,

406 
	`v3_ªadb
(
V3_LB_ISTAT
));

407 
	`¥ötk
(
KERN_DEBUG
 "%s", 
buf
);

408 
	`¥öèscii
(
buf
);

411 
	`v3_wrôeb
(
V3_LB_ISTAT
, 0);

412 
	`__øw_wrôñ
(3, 
SC_PCI
);

418 i‡((
ö°r
 & 0x0c100000) == 0x04100000) {

419 
ªg
 = (
ö°r
 >> 12) & 15;

420 
vÆ
;

422 i‡(
ö°r
 & 0x00400000)

423 
vÆ
 = 255;

425 
vÆ
 = -1;

427 
ªgs
->
uªgs
[
ªg
] = 
vÆ
;

428 
ªgs
->
ARM_pc
 += 4;

432 i‡((
ö°r
 & 0x0e100090) == 0x00100090) {

433 
ªg
 = (
ö°r
 >> 12) & 15;

435 
ªgs
->
uªgs
[
ªg
] = -1;

436 
ªgs
->
ARM_pc
 += 4;

441 
	}
}

443 
úqªtu∫_t
 
	$v3_úq
(
úq
, *
devid
)

445 #ifde‡
CONFIG_DEBUG_LL


446 
±_ªgs
 *
ªgs
 = 
	`gë_úq_ªgs
();

447 
pc
 = 
	`ö°ru˘i⁄_poöãr
(
ªgs
);

448 
ö°r
 = *(*)
pc
;

449 
buf
[128];

451 
	`•rötf
(
buf
, "V3 i¡ %d:Öc=0x%08lx [%08lx] LBFADDR=%08x LBFCODE=%02x ISTAT=%02x\n", 
úq
,

452 
pc
, 
ö°r
, 
	`__øw_ªadl
(
SC_LBFADDR
), __øw_ªadl(
SC_LBFCODE
) & 255,

453 
	`v3_ªadb
(
V3_LB_ISTAT
));

454 
	`¥öèscii
(
buf
);

457 
	`v3_wrôew
(
V3_PCI_STAT
, 0xf000);

458 
	`v3_wrôeb
(
V3_LB_ISTAT
, 0);

459 
	`__øw_wrôñ
(3, 
SC_PCI
);

461 #ifde‡
CONFIG_DEBUG_LL


466 i‡((
ö°r
 & 0x0c100000) == 0x04100000) {

467 
ªg
 = (
ö°r
 >> 16) & 15;

468 
	`•rötf
(
buf
, "Ñeg%d = %08lx\n", 
ªg
, 
ªgs
->
uªgs
[reg]);

469 
	`¥öèscii
(
buf
);

472  
IRQ_HANDLED
;

473 
	}
}

475 
__öô
 
	$pci_v3_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

477 
ªt
 = 0;

479 i‡(
ƒ
 == 0) {

480 
sys
->
mem_off£t
 = 
PHYS_PCI_MEM_BASE
;

481 
ªt
 = 
	`pci_v3_£tup_ªsour˚s
(
sys
->
ªsour˚
);

484  
ªt
;

485 
	}
}

487 
pci_bus
 *
	$pci_v3_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sys
)

489  
	`pci_sˇn_bus
(
sys
->
bu¢r
, &
pci_v3_›s
, sys);

490 
	}
}

496 
__öô
 
	$pci_v3_¥eöô
()

498 
Êags
;

499 
ãmp
;

500 
ªt
;

505 
	`hook_Áu…_code
(4, 
v3_pci_Áu…
, 
SIGBUS
, "externalábort onÜinefetch");

506 
	`hook_Áu…_code
(6, 
v3_pci_Áu…
, 
SIGBUS
, "externalábort onÜinefetch");

507 
	`hook_Áu…_code
(8, 
v3_pci_Áu…
, 
SIGBUS
, "externalábort onÇon-linefetch");

508 
	`hook_Áu…_code
(10, 
v3_pci_Áu…
, 
SIGBUS
, "externalábort onÇon-linefetch");

510 
	`•ö_lock_úqßve
(&
v3_lock
, 
Êags
);

515 i‡(
	`v3_ªadw
(
V3_SYSTEM
Ë& 
V3_SYSTEM_M_LOCK
)

516 
	`v3_wrôew
(
V3_SYSTEM
, 0xa05f);

522 
	`v3_wrôñ
(
V3_LB_BASE0
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_MEM_BASE
) |

523 
V3_LB_BASE_ADR_SIZE_256MB
 | 
V3_LB_BASE_ENABLE
);

524 
	`v3_wrôew
(
V3_LB_MAP0
, 
	`v3_addr_to_lb_m≠
(
PCI_BUS_NONMEM_START
) |

525 
V3_LB_MAP_TYPE_MEM
);

531 
	`v3_wrôñ
(
V3_LB_BASE1
, 
	`v3_addr_to_lb_ba£
(
PHYS_PCI_MEM_BASE
 + 
SZ_256M
) |

532 
V3_LB_BASE_ADR_SIZE_256MB
 | 
V3_LB_BASE_PREFETCH
 |

533 
V3_LB_BASE_ENABLE
);

534 
	`v3_wrôew
(
V3_LB_MAP1
, 
	`v3_addr_to_lb_m≠
(
PCI_BUS_PREMEM_START
) |

535 
V3_LB_MAP_TYPE_MEM_MULTIPLE
);

540 
	`v3_wrôñ
(
V3_LB_BASE2
, 
	`v3_addr_to_lb_ba£2
(
PHYS_PCI_IO_BASE
) |

541 
V3_LB_BASE_ENABLE
);

542 
	`v3_wrôew
(
V3_LB_MAP2
, 
	`v3_addr_to_lb_m≠2
(0));

547 
ãmp
 = 
	`v3_ªadw
(
V3_PCI_CFG
Ë& ~
V3_PCI_CFG_M_I2O_EN
;

548 
ãmp
 |
V3_PCI_CFG_M_IO_REG_DIS
 | 
V3_PCI_CFG_M_IO_DIS
;

549 
	`v3_wrôew
(
V3_PCI_CFG
, 
ãmp
);

551 
	`¥ötk
(
KERN_DEBUG
 "FIFO_CFG: %04x FIFO_PRIO: %04x\n",

552 
	`v3_ªadw
(
V3_FIFO_CFG
), v3_ªadw(
V3_FIFO_PRIORITY
));

559 
	`v3_wrôew
(
V3_FIFO_PRIORITY
, 0x0a0a);

564 
ãmp
 = 
	`v3_ªadw
(
V3_SYSTEM
Ë| 
V3_SYSTEM_M_LOCK
;

565 
	`v3_wrôew
(
V3_SYSTEM
, 
ãmp
);

570 
	`v3_wrôeb
(
V3_LB_ISTAT
, 0);

571 
	`v3_wrôew
(
V3_LB_CFG
, 
	`v3_ªadw
(V3_LB_CFG) | (1 << 10));

572 
	`v3_wrôeb
(
V3_LB_IMASK
, 0x28);

573 
	`__øw_wrôñ
(3, 
SC_PCI
);

578 
ªt
 = 
	`ªque°_úq
(
IRQ_AP_V3INT
, 
v3_úq
, 0, "V3", 
NULL
);

579 i‡(
ªt
)

580 
	`¥ötk
(
KERN_ERR
 "PCI: unableÅo grab PCIÉrror "

581 "öãºu±: %d\n", 
ªt
);

583 
	`•ö_u∆ock_úqª°‹e
(&
v3_lock
, 
Êags
);

584 
	}
}

586 
__öô
 
	$pci_v3_po°öô
()

588 
pci_cmd
;

590 
pci_cmd
 = 
PCI_COMMAND_MEMORY
 |

591 
PCI_COMMAND_MASTER
 | 
PCI_COMMAND_INVALIDATE
;

593 
	`v3_wrôew
(
V3_PCI_CMD
, 
pci_cmd
);

595 
	`v3_wrôeb
(
V3_LB_ISTAT
, ~0x40);

596 
	`v3_wrôeb
(
V3_LB_IMASK
, 0x68);

599 
ªt
 = 
	`ªque°_úq
(
IRQ_AP_LBUSTIMEOUT
, 
lb_timeout
, 0, "bu†timeout", 
NULL
);

600 i‡(
ªt
)

601 
	`¥ötk
(
KERN_ERR
 "PCI: unableÅo grabÜocal busÅimeout "

602 "öãºu±: %d\n", 
ªt
);

605 
	`ªgi°î_iß_p‹ts
(
PHYS_PCI_MEM_BASE
, 
PHYS_PCI_IO_BASE
, 0);

606 
	}
}

	@arch/arm/mach-integrator/time.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/kî√l.h
>

12 
	~<löux/time.h
>

13 
	~<löux/mc146818πc.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/devi˚.h
>

17 
	~<löux/amba/bus.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/io.h
>

21 
	~<asm/uac˚ss.h
>

22 
	~<asm/πc.h
>

24 
	~<asm/mach/time.h
>

26 
	#RTC_DR
 (0)

	)

27 
	#RTC_MR
 (4)

	)

28 
	#RTC_STAT
 (8)

	)

29 
	#RTC_EOI
 (8)

	)

30 
	#RTC_LR
 (12)

	)

31 
	#RTC_CR
 (16)

	)

32 
	#RTC_CR_MIE
 (1 << 0)

	)

34 (*
£t_πc
)();

35 
__iomem
 *
πc_ba£
;

37 
	$öãgøt‹_£t_πc
()

39 
	`__øw_wrôñ
(
xtime
.
tv_£c
, 
πc_ba£
 + 
RTC_LR
);

41 
	}
}

43 
	$öãgøt‹_πc_ªad_Æ¨m
(
πc_wkÆrm
 *
Ærm
)

45 
	`πc_time_to_tm
(
	`ªadl
(
πc_ba£
 + 
RTC_MR
), &
Ærm
->
time
);

47 
	}
}

49 
ölöe
 
	$öãgøt‹_πc_£t_Æ¨m
(
πc_wkÆrm
 *
Ærm
)

51 
time
;

52 
ªt
;

57 
ªt
 = 
	`πc_vÆid_tm
(&
Ærm
->
time
);

58 i‡(
ªt
 == 0)

59 
ªt
 = 
	`πc_tm_to_time
(&
Ærm
->
time
, &time);

60 i‡(
ªt
 == 0)

61 
	`wrôñ
(
time
, 
πc_ba£
 + 
RTC_MR
);

62  
ªt
;

63 
	}
}

65 
	$öãgøt‹_πc_ªad_time
(
πc_time
 *
tm
)

67 
	`πc_time_to_tm
(
	`ªadl
(
πc_ba£
 + 
RTC_DR
), 
tm
);

69 
	}
}

79 
ölöe
 
	$öãgøt‹_πc_£t_time
(
πc_time
 *
tm
)

81 
time
;

82 
ªt
;

84 
ªt
 = 
	`πc_tm_to_time
(
tm
, &
time
);

85 i‡(
ªt
 == 0)

86 
	`wrôñ
(
time
 + 1, 
πc_ba£
 + 
RTC_LR
);

88  
ªt
;

89 
	}
}

91 
πc_›s
 
	gπc_›s
 = {

92 .
ow√r
 = 
THIS_MODULE
,

93 .
	gªad_time
 = 
öãgøt‹_πc_ªad_time
,

94 .
	g£t_time
 = 
öãgøt‹_πc_£t_time
,

95 .
	gªad_Æ¨m
 = 
öãgøt‹_πc_ªad_Æ¨m
,

96 .
	g£t_Æ¨m
 = 
öãgøt‹_πc_£t_Æ¨m
,

99 
úqªtu∫_t
 
	$¨m_πc_öãºu±
(
úq
, *
dev_id
)

101 
	`wrôñ
(0, 
πc_ba£
 + 
RTC_EOI
);

102  
IRQ_HANDLED
;

103 
	}
}

105 
	$πc_¥obe
(
amba_devi˚
 *
dev
, *
id
)

107 
ªt
;

109 i‡(
πc_ba£
)

110  -
EBUSY
;

112 
ªt
 = 
	`amba_ªque°_ªgi⁄s
(
dev
, 
NULL
);

113 i‡(
ªt
)

114 
out
;

116 
πc_ba£
 = 
	`i‹em≠
(
dev
->
ªs
.
°¨t
, 
SZ_4K
);

117 i‡(!
πc_ba£
) {

118 
ªt
 = -
ENOMEM
;

119 
ªs_out
;

122 
	`__øw_wrôñ
(0, 
πc_ba£
 + 
RTC_CR
);

123 
	`__øw_wrôñ
(0, 
πc_ba£
 + 
RTC_EOI
);

125 
xtime
.
tv_£c
 = 
	`__øw_ªadl
(
πc_ba£
 + 
RTC_DR
);

127 
ªt
 = 
	`ªque°_úq
(
dev
->
úq
[0], 
¨m_πc_öãºu±
, 
IRQF_DISABLED
,

128 "πc-∂030", 
dev
);

129 i‡(
ªt
)

130 
m≠_out
;

132 
ªt
 = 
	`ªgi°î_πc
(&
πc_›s
);

133 i‡(
ªt
)

134 
úq_out
;

136 
£t_πc
 = 
öãgøt‹_£t_πc
;

139 
úq_out
:

140 
	`‰ì_úq
(
dev
->
úq
[0], dev);

141 
m≠_out
:

142 
	`iounm≠
(
πc_ba£
);

143 
πc_ba£
 = 
NULL
;

144 
ªs_out
:

145 
	`amba_ªÀa£_ªgi⁄s
(
dev
);

146 
out
:

147  
ªt
;

148 
	}
}

150 
	$πc_ªmove
(
amba_devi˚
 *
dev
)

152 
£t_πc
 = 
NULL
;

154 
	`wrôñ
(0, 
πc_ba£
 + 
RTC_CR
);

156 
	`‰ì_úq
(
dev
->
úq
[0], dev);

157 
	`uƒegi°î_πc
(&
πc_›s
);

159 
	`iounm≠
(
πc_ba£
);

160 
πc_ba£
 = 
NULL
;

161 
	`amba_ªÀa£_ªgi⁄s
(
dev
);

164 
	}
}

166 
time•ec
 
	gπc_dñè
;

168 
	$πc_su•íd
(
amba_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

170 
time•ec
 
πc
;

172 
πc
.
tv_£c
 = 
	`ªadl
(
πc_ba£
 + 
RTC_DR
);

173 
πc
.
tv_n£c
 = 0;

174 
	`ßve_time_dñè
(&
πc_dñè
, &
πc
);

177 
	}
}

179 
	$πc_ªsume
(
amba_devi˚
 *
dev
)

181 
time•ec
 
πc
;

183 
πc
.
tv_£c
 = 
	`ªadl
(
πc_ba£
 + 
RTC_DR
);

184 
πc
.
tv_n£c
 = 0;

185 
	`ª°‹e_time_dñè
(&
πc_dñè
, &
πc
);

188 
	}
}

190 
amba_id
 
	gπc_ids
[] = {

192 .
id
 = 0x00041030,

193 .
	gmask
 = 0x000fffff,

198 
amba_drivî
 
	gπc_drivî
 = {

199 .
drv
 = {

200 .
«me
 = "rtc-pl030",

202 .
	g¥obe
 = 
πc_¥obe
,

203 .
	gªmove
 = 
πc_ªmove
,

204 .
	gsu•íd
 = 
πc_su•íd
,

205 .
	gªsume
 = 
πc_ªsume
,

206 .
	gid_èbÀ
 = 
πc_ids
,

209 
__öô
 
	$öãgøt‹_πc_öô
()

211  
	`amba_drivî_ªgi°î
(&
πc_drivî
);

212 
	}
}

214 
__exô
 
	$öãgøt‹_πc_exô
()

216 
	`amba_drivî_uƒegi°î
(&
πc_drivî
);

217 
	}
}

219 
moduÀ_öô
(
öãgøt‹_πc_öô
);

220 
moduÀ_exô
(
öãgøt‹_πc_exô
);

	@arch/arm/mach-iop13xx/io.c

19 
	~<löux/kî√l.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/io.h
>

24 * 
__iomem
 
	$__i›13xx_io
(
io_addr
)

26 
__iomem
 * 
io_vút
;

28 
io_addr
) {

29 
IOP13XX_PCIE_LOWER_IO_PA
 ... 
IOP13XX_PCIE_UPPER_IO_PA
:

30 
io_vút
 = (*Ë
	`IOP13XX_PCIE_IO_PHYS_TO_VIRT
(
io_addr
);

32 
IOP13XX_PCIX_LOWER_IO_PA
 ... 
IOP13XX_PCIX_UPPER_IO_PA
:

33 
io_vút
 = (*Ë
	`IOP13XX_PCIX_IO_PHYS_TO_VIRT
(
io_addr
);

36 
	`BUG
();

39  
io_vút
;

40 
	}
}

41 
EXPORT_SYMBOL
(
__i›13xx_io
);

43 * 
__iomem
 
	$__i›13xx_i‹em≠
(
cookõ
, 
size_t
 
size
,

44 
mty≥
)

46 
__iomem
 * 
ªtvÆ
;

48 
cookõ
) {

49 
IOP13XX_PCIX_LOWER_MEM_RA
 ... 
IOP13XX_PCIX_UPPER_MEM_RA
:

50 i‡(
	`u∆ikñy
(!
i›13xx_©ux_mem_ba£
))

51 
ªtvÆ
 = 
NULL
;

53 
ªtvÆ
 = (*)(
i›13xx_©ux_mem_ba£
 +

54 (
cookõ
 - 
IOP13XX_PCIX_LOWER_MEM_RA
));

56 
IOP13XX_PCIE_LOWER_MEM_RA
 ... 
IOP13XX_PCIE_UPPER_MEM_RA
:

57 i‡(
	`u∆ikñy
(!
i›13xx_©ue_mem_ba£
))

58 
ªtvÆ
 = 
NULL
;

60 
ªtvÆ
 = (*)(
i›13xx_©ue_mem_ba£
 +

61 (
cookõ
 - 
IOP13XX_PCIE_LOWER_MEM_RA
));

63 
IOP13XX_PBI_LOWER_MEM_RA
 ... 
IOP13XX_PBI_UPPER_MEM_RA
:

64 
ªtvÆ
 = 
	`__¨m_i‹em≠
(
IOP13XX_PBI_LOWER_MEM_PA
 +

65 (
cookõ
 - 
IOP13XX_PBI_LOWER_MEM_RA
),

66 
size
, 
mty≥
);

68 
IOP13XX_PCIE_LOWER_IO_PA
 ... 
IOP13XX_PCIE_UPPER_IO_PA
:

69 
ªtvÆ
 = (*Ë
	`IOP13XX_PCIE_IO_PHYS_TO_VIRT
(
cookõ
);

71 
IOP13XX_PCIX_LOWER_IO_PA
 ... 
IOP13XX_PCIX_UPPER_IO_PA
:

72 
ªtvÆ
 = (*Ë
	`IOP13XX_PCIX_IO_PHYS_TO_VIRT
(
cookõ
);

74 
IOP13XX_PMMR_PHYS_MEM_BASE
 ... 
IOP13XX_PMMR_UPPER_MEM_PA
:

75 
ªtvÆ
 = (*Ë
	`IOP13XX_PMMR_PHYS_TO_VIRT
(
cookõ
);

78 
ªtvÆ
 = 
	`__¨m_i‹em≠
(
cookõ
, 
size
, 
mty≥
);

81  
ªtvÆ
;

82 
	}
}

83 
EXPORT_SYMBOL
(
__i›13xx_i‹em≠
);

85 
	$__i›13xx_iounm≠
(
__iomem
 *
addr
)

87 
	`__iounm≠
(vﬁ©ûê
__iomem
 *
addr
);

89 i‡(
i›13xx_©ue_mem_ba£
)

90 i‡(
addr
 >(
__iomem
 *Ë
i›13xx_©ue_mem_ba£
 &&

91 
addr
 < (
__iomem
 *Ë(
i›13xx_©ue_mem_ba£
 +

92 
i›13xx_©ue_mem_size
))

93 
skù
;

95 i‡(
i›13xx_©ux_mem_ba£
)

96 i‡(
addr
 >(
__iomem
 *Ë
i›13xx_©ux_mem_ba£
 &&

97 
addr
 < (
__iomem
 *Ë(
i›13xx_©ux_mem_ba£
 +

98 
i›13xx_©ux_mem_size
))

99 
skù
;

101 (
u32
Ë
addr
) {

102 
IOP13XX_PCIE_LOWER_IO_VA
 ... 
IOP13XX_PCIE_UPPER_IO_VA
:

103 
IOP13XX_PCIX_LOWER_IO_VA
 ... 
IOP13XX_PCIX_UPPER_IO_VA
:

104 
IOP13XX_PMMR_VIRT_MEM_BASE
 ... 
IOP13XX_PMMR_UPPER_MEM_VA
:

105 
skù
;

107 
	`__iounm≠
(
addr
);

109 
skù
:

111 
	}
}

112 
EXPORT_SYMBOL
(
__i›13xx_iounm≠
);

	@arch/arm/mach-iop13xx/iq81340mc.c

19 
	~<löux/pci.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mach/pci.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/¨ch/pci.h
>

27 
	~<asm/mach/time.h
>

28 
	~<asm/¨ch/time.h
>

30 
öô_©u
;

32 
__öô


33 
	$iq81340mc_pcix_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
id£l
, u8 
pö
)

35 
id£l
) {

37 
pö
) {

38 1:  
ATUX_INTB
;

39 2:  
ATUX_INTC
;

40 3:  
ATUX_INTD
;

41 4:  
ATUX_INTA
;

45 
pö
) {

46 1:  
ATUX_INTC
;

47 2:  
ATUX_INTD
;

48 3:  
ATUX_INTC
;

49 4:  
ATUX_INTD
;

54 
	}
}

56 
hw_pci
 
iq81340mc_pci
 
	g__öôd©a
 = {

57 .
swizzÀ
 = 
pci_°d_swizzÀ
,

58 .
	gƒ_c⁄åﬁÀrs
 = 0,

59 .
	g£tup
 = 
i›13xx_pci_£tup
,

60 .
	gm≠_úq
 = 
iq81340mc_pcix_m≠_úq
,

61 .
	gsˇn
 = 
i›13xx_sˇn_bus
,

62 .
	g¥eöô
 = 
i›13xx_pci_öô
,

65 
__öô
 
	$iq81340mc_pci_öô
()

67 
	`i›13xx_©u_£À˘
(&
iq81340mc_pci
);

68 
	`pci_comm⁄_öô
(&
iq81340mc_pci
);

69 
	`i›13xx_m≠_pci_mem‹y
();

72 
	}
}

74 
__öô
 
	$iq81340mc_öô
()

76 
	`i›13xx_∂©f‹m_öô
();

77 
	`iq81340mc_pci_öô
();

78 
	`i›13xx_add_çmi_devi˚s
();

79 
	}
}

81 
__öô
 
	$iq81340mc_timî_öô
()

83 
bus_‰eq
 = 
	`i›13xx_c‹e_‰eq
(Ë/ 
	`i›13xx_xsi_bus_øtio
();

84 
	`¥ötk
(
KERN_DEBUG
 "%s: bu†‰equícy: %lu\n", 
__FUNCTION__
, 
bus_‰eq
);

85 
	`i›_öô_time
(
bus_‰eq
);

86 
	}
}

88 
sys_timî
 
	giq81340mc_timî
 = {

89 .
öô
 = 
iq81340mc_timî_öô
,

90 .
	goff£t
 = 
i›_gëtimeoff£t
,

93 
MACHINE_START
(
IQ81340MC
, "Intel IQ81340MC")

95 .
	gphys_io
 = 
IOP13XX_PMMR_PHYS_MEM_BASE
,

96 .
	gio_pg_off°
 = (
IOP13XX_PMMR_VIRT_MEM_BASE
 >> 18) & 0xfffc,

97 .
	gboŸ_∑øms
 = 0x00000100,

98 .
	gm≠_io
 = 
i›13xx_m≠_io
,

99 .
	göô_úq
 = 
i›13xx_öô_úq
,

100 .
	gtimî
 = &
iq81340mc_timî
,

101 .
	göô_machöe
 = 
iq81340mc_öô
,

102 
	gMACHINE_END


	@arch/arm/mach-iop13xx/iq81340sc.c

19 
	~<löux/pci.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/mach/pci.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/¨ch/pci.h
>

27 
	~<asm/mach/time.h
>

28 
	~<asm/¨ch/time.h
>

30 
öô_©u
;

32 
__öô


33 
	$iq81340sc_©ux_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
id£l
, u8 
pö
)

35 
	`WARN_ON
(
id£l
 < 1 || idsel > 2);

37 
id£l
) {

39 
pö
) {

40 1:  
ATUX_INTB
;

41 2:  
ATUX_INTC
;

42 3:  
ATUX_INTD
;

43 4:  
ATUX_INTA
;

47 
pö
) {

48 1:  
ATUX_INTC
;

49 2:  
ATUX_INTC
;

50 3:  
ATUX_INTC
;

51 4:  
ATUX_INTC
;

56 
	}
}

58 
hw_pci
 
iq81340sc_pci
 
	g__öôd©a
 = {

59 .
swizzÀ
 = 
pci_°d_swizzÀ
,

60 .
	gƒ_c⁄åﬁÀrs
 = 0,

61 .
	g£tup
 = 
i›13xx_pci_£tup
,

62 .
	gsˇn
 = 
i›13xx_sˇn_bus
,

63 .
	gm≠_úq
 = 
iq81340sc_©ux_m≠_úq
,

64 .
	g¥eöô
 = 
i›13xx_pci_öô


67 
__öô
 
	$iq81340sc_pci_öô
()

69 
	`i›13xx_©u_£À˘
(&
iq81340sc_pci
);

70 
	`pci_comm⁄_öô
(&
iq81340sc_pci
);

71 
	`i›13xx_m≠_pci_mem‹y
();

74 
	}
}

76 
__öô
 
	$iq81340sc_öô
()

78 
	`i›13xx_∂©f‹m_öô
();

79 
	`iq81340sc_pci_öô
();

80 
	`i›13xx_add_çmi_devi˚s
();

81 
	}
}

83 
__öô
 
	$iq81340sc_timî_öô
()

85 
bus_‰eq
 = 
	`i›13xx_c‹e_‰eq
(Ë/ 
	`i›13xx_xsi_bus_øtio
();

86 
	`¥ötk
(
KERN_DEBUG
 "%s: bu†‰equícy: %lu\n", 
__FUNCTION__
, 
bus_‰eq
);

87 
	`i›_öô_time
(
bus_‰eq
);

88 
	}
}

90 
sys_timî
 
	giq81340sc_timî
 = {

91 .
öô
 = 
iq81340sc_timî_öô
,

92 .
	goff£t
 = 
i›_gëtimeoff£t
,

95 
MACHINE_START
(
IQ81340SC
, "Intel IQ81340SC")

97 .
	gphys_io
 = 
IOP13XX_PMMR_PHYS_MEM_BASE
,

98 .
	gio_pg_off°
 = (
IOP13XX_PMMR_VIRT_MEM_BASE
 >> 18) & 0xfffc,

99 .
	gboŸ_∑øms
 = 0x00000100,

100 .
	gm≠_io
 = 
i›13xx_m≠_io
,

101 .
	göô_úq
 = 
i›13xx_öô_úq
,

102 .
	gtimî
 = &
iq81340sc_timî
,

103 .
	göô_machöe
 = 
iq81340sc_öô
,

104 
	gMACHINE_END


	@arch/arm/mach-iop13xx/irq.c

19 
	~<löux/öô.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/li°.h
>

22 
	~<löux/sys˘l.h
>

23 
	~<asm/uac˚ss.h
>

24 
	~<asm/mach/úq.h
>

25 
	~<asm/úq.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/mach-ty≥s.h
>

28 
	~<asm/¨ch/úqs.h
>

29 
	~<asm/¨ch/msi.h
>

33 
u32
 
	$ªad_öt˘l_0
()

35 
u32
 
vÆ
;

36 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c0, c4, 0":"Ù" (
vÆ
));

37  
vÆ
;

38 
	}
}

39 
	$wrôe_öt˘l_0
(
u32
 
vÆ
)

41 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c0, c4, 0"::"r" (
vÆ
));

42 
	}
}

46 
u32
 
	$ªad_öt˘l_1
()

48 
u32
 
vÆ
;

49 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c1, c4, 0":"Ù" (
vÆ
));

50  
vÆ
;

51 
	}
}

52 
	$wrôe_öt˘l_1
(
u32
 
vÆ
)

54 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c1, c4, 0"::"r" (
vÆ
));

55 
	}
}

59 
u32
 
	$ªad_öt˘l_2
()

61 
u32
 
vÆ
;

62 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c2, c4, 0":"Ù" (
vÆ
));

63  
vÆ
;

64 
	}
}

65 
	$wrôe_öt˘l_2
(
u32
 
vÆ
)

67 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c2, c4, 0"::"r" (
vÆ
));

68 
	}
}

72 
u32
 
	$ªad_öt˘l_3
()

74 
u32
 
vÆ
;

75 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c3, c4, 0":"Ù" (
vÆ
));

76  
vÆ
;

77 
	}
}

78 
	$wrôe_öt˘l_3
(
u32
 
vÆ
)

80 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c3, c4, 0"::"r" (
vÆ
));

81 
	}
}

85 
	$wrôe_öt°r_0
(
u32
 
vÆ
)

87 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c0, c5, 0"::"r" (
vÆ
));

88 
	}
}

92 
	$wrôe_öt°r_1
(
u32
 
vÆ
)

94 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c1, c5, 0"::"r" (
vÆ
));

95 
	}
}

99 
	$wrôe_öt°r_2
(
u32
 
vÆ
)

101 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c2, c5, 0"::"r" (
vÆ
));

102 
	}
}

106 
	$wrôe_öt°r_3
(
u32
 
vÆ
)

108 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c3, c5, 0"::"r" (
vÆ
));

109 
	}
}

113 
	$wrôe_ötba£
(
u32
 
vÆ
)

115 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c0, c2, 0"::"r" (
vÆ
));

116 
	}
}

120 
	$wrôe_ötsize
(
u32
 
vÆ
)

122 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c2, c2, 0"::"r" (
vÆ
));

123 
	}
}

127 
	$i›13xx_úq_mask0
 (
úq
)

129 
	`wrôe_öt˘l_0
(
	`ªad_öt˘l_0
(Ë& ~(1 << (
úq
 - 0)));

130 
	}
}

133 
	$i›13xx_úq_mask1
 (
úq
)

135 
	`wrôe_öt˘l_1
(
	`ªad_öt˘l_1
(Ë& ~(1 << (
úq
 - 32)));

136 
	}
}

139 
	$i›13xx_úq_mask2
 (
úq
)

141 
	`wrôe_öt˘l_2
(
	`ªad_öt˘l_2
(Ë& ~(1 << (
úq
 - 64)));

142 
	}
}

145 
	$i›13xx_úq_mask3
 (
úq
)

147 
	`wrôe_öt˘l_3
(
	`ªad_öt˘l_3
(Ë& ~(1 << (
úq
 - 96)));

148 
	}
}

151 
	$i›13xx_úq_unmask0
(
úq
)

153 
	`wrôe_öt˘l_0
(
	`ªad_öt˘l_0
(Ë| (1 << (
úq
 - 0)));

154 
	}
}

157 
	$i›13xx_úq_unmask1
(
úq
)

159 
	`wrôe_öt˘l_1
(
	`ªad_öt˘l_1
(Ë| (1 << (
úq
 - 32)));

160 
	}
}

163 
	$i›13xx_úq_unmask2
(
úq
)

165 
	`wrôe_öt˘l_2
(
	`ªad_öt˘l_2
(Ë| (1 << (
úq
 - 64)));

166 
	}
}

169 
	$i›13xx_úq_unmask3
(
úq
)

171 
	`wrôe_öt˘l_3
(
	`ªad_öt˘l_3
(Ë| (1 << (
úq
 - 96)));

172 
	}
}

174 
úq_chù
 
	gi›13xx_úqchù1
 = {

175 .
«me
 = "IOP13xx-1",

176 .
	gack
 = 
i›13xx_úq_mask0
,

177 .
	gmask
 = 
i›13xx_úq_mask0
,

178 .
	gunmask
 = 
i›13xx_úq_unmask0
,

181 
úq_chù
 
	gi›13xx_úqchù2
 = {

182 .
«me
 = "IOP13xx-2",

183 .
	gack
 = 
i›13xx_úq_mask1
,

184 .
	gmask
 = 
i›13xx_úq_mask1
,

185 .
	gunmask
 = 
i›13xx_úq_unmask1
,

188 
úq_chù
 
	gi›13xx_úqchù3
 = {

189 .
«me
 = "IOP13xx-3",

190 .
	gack
 = 
i›13xx_úq_mask2
,

191 .
	gmask
 = 
i›13xx_úq_mask2
,

192 .
	gunmask
 = 
i›13xx_úq_unmask2
,

195 
úq_chù
 
	gi›13xx_úqchù4
 = {

196 .
«me
 = "IOP13xx-4",

197 .
	gack
 = 
i›13xx_úq_mask3
,

198 .
	gmask
 = 
i›13xx_úq_mask3
,

199 .
	gunmask
 = 
i›13xx_úq_unmask3
,

202 
i›_öô_˝6_h™dÀr
();

204 
__öô
 
	$i›13xx_öô_úq
()

206 
i
;

208 
	`i›_öô_˝6_h™dÀr
();

211 
	`wrôe_öt˘l_0
(0);

212 
	`wrôe_öt˘l_1
(0);

213 
	`wrôe_öt˘l_2
(0);

214 
	`wrôe_öt˘l_3
(0);

217 
	`wrôe_öt°r_0
(0);

218 
	`wrôe_öt°r_1
(0);

219 
	`wrôe_öt°r_2
(0);

220 
	`wrôe_öt°r_3
(0);

223 
	`wrôe_ötba£
(
INTBASE
);

224 
	`wrôe_ötsize
(
INTSIZE_4
);

226 
i
 = 0; i <
IRQ_IOP13XX_HPI
; i++) {

227 i‡(
i
 < 32)

228 
	`£t_úq_chù
(
i
, &
i›13xx_úqchù1
);

229 i‡(
i
 < 64)

230 
	`£t_úq_chù
(
i
, &
i›13xx_úqchù2
);

231 i‡(
i
 < 96)

232 
	`£t_úq_chù
(
i
, &
i›13xx_úqchù3
);

234 
	`£t_úq_chù
(
i
, &
i›13xx_úqchù4
);

236 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

237 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

240 
	`i›13xx_msi_öô
();

241 
	}
}

	@arch/arm/mach-iop13xx/msi.c

22 
	~<löux/pci.h
>

23 
	~<löux/msi.h
>

24 
	~<asm/mach/úq.h
>

25 
	~<asm/úq.h
>

28 
	#IOP13XX_NUM_MSI_IRQS
 128

	)

29 
DECLARE_BITMAP
(
msi_úq_ö_u£
, 
IOP13XX_NUM_MSI_IRQS
);

33 
u32
 
	$ªad_imùr_0
()

35 
u32
 
vÆ
;

36 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c8, c1, 0":"Ù" (
vÆ
));

37  
vÆ
;

38 
	}
}

39 
	$wrôe_imùr_0
(
u32
 
vÆ
)

41 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c8, c1, 0"::"r" (
vÆ
));

42 
	}
}

46 
u32
 
	$ªad_imùr_1
()

48 
u32
 
vÆ
;

49 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c9, c1, 0":"Ù" (
vÆ
));

50  
vÆ
;

51 
	}
}

52 
	$wrôe_imùr_1
(
u32
 
vÆ
)

54 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c9, c1, 0"::"r" (
vÆ
));

55 
	}
}

59 
u32
 
	$ªad_imùr_2
()

61 
u32
 
vÆ
;

62 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c10, c1, 0":"Ù" (
vÆ
));

63  
vÆ
;

64 
	}
}

65 
	$wrôe_imùr_2
(
u32
 
vÆ
)

67 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c10, c1, 0"::"r" (
vÆ
));

68 
	}
}

72 
u32
 
	$ªad_imùr_3
()

74 
u32
 
vÆ
;

75 
asm
 vﬁ©ûe("mr¯p6, 0, %0, c11, c1, 0":"Ù" (
vÆ
));

76  
vÆ
;

77 
	}
}

78 
	$wrôe_imùr_3
(
u32
 
vÆ
)

80 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c11, c1, 0"::"r" (
vÆ
));

81 
	}
}

83 
	$u32
 (*
ªad_imùr
[])() = {

84 
ªad_imùr_0
,

85 
ªad_imùr_1
,

86 
ªad_imùr_2
,

87 
ªad_imùr_3
,

88 
	}
};

90 (*
wrôe_imùr
[])(
u32
) = {

91 
wrôe_imùr_0
,

92 
wrôe_imùr_1
,

93 
wrôe_imùr_2
,

94 
wrôe_imùr_3
,

95 
	}
};

97 
	$i›13xx_msi_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

99 
i
, 
j
;

100 
°©us
;

105 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªad_imùr
); i++) {

106 
°©us
 = (
ªad_imùr
[
i
])();

107 i‡(!
°©us
)

111 
j
 = 
	`föd_fú°_bô
(&
°©us
, 32);

112 (
wrôe_imùr
[
i
])(1 << 
j
);

113 
desc
 = 
úq_desc
 + 
IRQ_IOP13XX_MSI_0
 + 
j
 + (32*
i
);

114 
	`desc_h™dÀ_úq
(
IRQ_IOP13XX_MSI_0
 + 
j
 + (32*
i
), 
desc
);

115 
°©us
 = (
ªad_imùr
[
i
])();

116 } 
°©us
);

118 
	}
}

120 
__öô
 
	$i›13xx_msi_öô
()

122 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IOP13XX_INBD_MSI
, 
i›13xx_msi_h™dÀr
);

123 
	}
}

128 
	$¸óã_úq
()

130 
úq
, 
pos
;

132 
agaö
:

133 
pos
 = 
	`föd_fú°_zîo_bô
(
msi_úq_ö_u£
, 
IOP13XX_NUM_MSI_IRQS
);

134 
úq
 = 
IRQ_IOP13XX_MSI_0
 + 
pos
;

135 i‡(
úq
 > 
NR_IRQS
)

136  -
ENOSPC
;

138 i‡(
	`ã°_™d_£t_bô
(
pos
, 
msi_úq_ö_u£
))

139 
agaö
;

141 
	`dy«mic_úq_öô
(
úq
);

143  
úq
;

144 
	}
}

146 
	$de°roy_úq
(
úq
)

148 
pos
 = 
úq
 - 
IRQ_IOP13XX_MSI_0
;

150 
	`dy«mic_úq_˛ónup
(
úq
);

152 
	`˛ór_bô
(
pos
, 
msi_úq_ö_u£
);

153 
	}
}

155 
	$¨ch_ã¨down_msi_úq
(
úq
)

157 
	`de°roy_úq
(
úq
);

158 
	}
}

160 
	$i›13xx_msi_n›
(
úq
)

163 
	}
}

165 
úq_chù
 
	gi›13xx_msi_chù
 = {

166 .
«me
 = "PCI-MSI",

167 .
	gack
 = 
i›13xx_msi_n›
,

168 .
	gíabÀ
 = 
unmask_msi_úq
,

169 .
	gdißbÀ
 = 
mask_msi_úq
,

170 .
	gmask
 = 
mask_msi_úq
,

171 .
	gunmask
 = 
unmask_msi_úq
,

174 
	$¨ch_£tup_msi_úq
(
pci_dev
 *
pdev
, 
msi_desc
 *
desc
)

176 
id
, 
úq
 = 
	`¸óã_úq
();

177 
msi_msg
 
msg
;

179 i‡(
úq
 < 0)

180  
úq
;

182 
	`£t_úq_msi
(
úq
, 
desc
);

184 
msg
.
addªss_hi
 = 0x0;

185 
msg
.
addªss_lo
 = 
IOP13XX_MU_MIMR_PCI
;

187 
id
 = 
	`i›13xx_˝u_id
();

188 
msg
.
d©a
 = (
id
 << 
IOP13XX_MU_MIMR_CORE_SELECT
Ë| (
úq
 & 0x7f);

190 
	`wrôe_msi_msg
(
úq
, &
msg
);

191 
	`£t_úq_chù_™d_h™dÀr
(
úq
, &
i›13xx_msi_chù
, 
h™dÀ_sim∂e_úq
);

194 
	}
}

	@arch/arm/mach-iop13xx/pci.c

20 
	~<löux/pci.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/jiffõs.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/sizes.h
>

26 
	~<asm/sig«l.h
>

27 
	~<asm/mach/pci.h
>

28 
	~<asm/¨ch/pci.h
>

30 
	#IOP13XX_PCI_DEBUG
 0

	)

31 
	#PRINTK
(
x
...Ë(()(
IOP13XX_PCI_DEBUG
 && 
	`¥ötk
(x)))

	)

33 
u32
 
	gi›13xx_©ux_pmmr_off£t
;

34 
u32
 
	gi›13xx_©ue_pmmr_off£t
;

35 
pci_bus
 *
	gpci_bus_©ux
 = 0;

36 
pci_bus
 *
	gpci_bus_©ue
 = 0;

37 
u32
 
	gi›13xx_©ue_mem_ba£
;

38 
u32
 
	gi›13xx_©ux_mem_ba£
;

39 
size_t
 
	gi›13xx_©ue_mem_size
;

40 
size_t
 
	gi›13xx_©ux_mem_size
;

41 
	gi›13xx_pcibios_mö_io
 = 0;

42 
	gi›13xx_pcibios_mö_mem
 = 0;

44 
EXPORT_SYMBOL
(
i›13xx_©ue_mem_ba£
);

45 
EXPORT_SYMBOL
(
i›13xx_©ux_mem_ba£
);

46 
EXPORT_SYMBOL
(
i›13xx_©ue_mem_size
);

47 
EXPORT_SYMBOL
(
i›13xx_©ux_mem_size
);

49 
	göô_©u
 = 0;

50 
	g©ux_åhÁ_timeout
 = 0;

55 
	$i›13xx_m≠_pci_mem‹y
()

57 
©u
;

58 
pci_bus
 *
bus
;

59 
pci_dev
 *
dev
;

60 
ªsour˚_size_t
 
íd
 = 0;

62 
©u
 = 0;átu < 2;átu++) {

63 
bus
 = 
©u
 ? 
pci_bus_©ue
 : 
pci_bus_©ux
;

64 i‡(
bus
) {

65 
	`li°_f‹_óch_íåy
(
dev
, &
bus
->
devi˚s
, 
bus_li°
) {

66 
i
;

67 
max
 = 7;

69 i‡(
dev
->
sub‹dö©e
)

70 
max
 = 
DEVICE_COUNT_RESOURCE
;

72 
i
 = 0; i < 
max
; i++) {

73 
ªsour˚
 *
ªs
 = &
dev
->ªsour˚[
i
];

74 i‡(
ªs
->
Êags
 & 
IORESOURCE_MEM
)

75 
íd
 = 
	`max
(
ªs
->end,Énd);

79 
©u
) {

81 
i›13xx_©ux_mem_size
 =

82 (
íd
 - 
IOP13XX_PCIX_LOWER_MEM_RA
) + 1;

85 i‡(
i›13xx_©ux_mem_size
 & (
SZ_16M
 - 1)) {

86 
i›13xx_©ux_mem_size
 &~(
SZ_16M
 - 1);

87 
i›13xx_©ux_mem_size
 +
SZ_16M
;

90 i‡(
íd
) {

91 
i›13xx_©ux_mem_ba£
 =

92 (
u32
Ë
	`__¨m_i‹em≠_p‚
(

93 
	`__phys_to_p‚
(
IOP13XX_PCIX_LOWER_MEM_PA
)

94 , 0, 
i›13xx_©ux_mem_size
, 
MT_DEVICE
);

95 i‡(!
i›13xx_©ux_mem_ba£
) {

96 
	`¥ötk
("%s:átuxállocation "

97 "Áûed\n", 
__FUNCTION__
);

98 
	`BUG
();

101 
i›13xx_©ux_mem_size
 = 0;

102 
	`PRINTK
("%s:átu: %d bus_size: %d mem_base: %x\n",

103 
__FUNCTION__
, 
©u
, 
i›13xx_©ux_mem_size
,

104 
i›13xx_©ux_mem_ba£
);

107 
i›13xx_©ue_mem_size
 =

108 (
íd
 - 
IOP13XX_PCIE_LOWER_MEM_RA
) + 1;

111 i‡(
i›13xx_©ue_mem_size
 & (
SZ_16M
 - 1)) {

112 
i›13xx_©ue_mem_size
 &~(
SZ_16M
 - 1);

113 
i›13xx_©ue_mem_size
 +
SZ_16M
;

116 i‡(
íd
) {

117 
i›13xx_©ue_mem_ba£
 =

118 (
u32
Ë
	`__¨m_i‹em≠_p‚
(

119 
	`__phys_to_p‚
(
IOP13XX_PCIE_LOWER_MEM_PA
)

120 , 0, 
i›13xx_©ue_mem_size
, 
MT_DEVICE
);

121 i‡(!
i›13xx_©ue_mem_ba£
) {

122 
	`¥ötk
("%s:átueállocation "

123 "Áûed\n", 
__FUNCTION__
);

124 
	`BUG
();

127 
i›13xx_©ue_mem_size
 = 0;

128 
	`PRINTK
("%s:átu: %d bus_size: %d mem_base: %x\n",

129 
__FUNCTION__
, 
©u
, 
i›13xx_©ue_mem_size
,

130 
i›13xx_©ue_mem_ba£
);

134 
	`¥ötk
("%s: Initialized (%uM @Ñesource/virtual: %08lx/%08x)\n",

135 
©u
 ? "ATUE" : "ATUX",

136 (
©u
 ? 
i›13xx_©ue_mem_size
 : 
i›13xx_©ux_mem_size
) /

137 
SZ_1M
,

138 
©u
 ? 
IOP13XX_PCIE_LOWER_MEM_RA
 :

139 
IOP13XX_PCIX_LOWER_MEM_RA
,

140 
©u
 ? 
i›13xx_©ue_mem_ba£
 :

141 
i›13xx_©ux_mem_ba£
);

142 
íd
 = 0;

146 
	}
}

148 
	$i›13xx_©u_fun˘i⁄
(
©u
)

150 
func
 = 0;

155 
©u
) {

156 
IOP13XX_INIT_ATU_ATUX
:

157 i‡(
	`__øw_ªadl
(
IOP13XX_ESSR0
Ë& 
IOP13XX_INTERFACE_SEL_PCIX
)

158 
func
 = 5;

160 
func
 = 0;

162 
IOP13XX_INIT_ATU_ATUE
:

163 i‡(
	`__øw_ªadl
(
IOP13XX_ESSR0
Ë& 
IOP13XX_INTERFACE_SEL_PCIX
)

164 
func
 = 0;

166 
func
 = 5;

169 
	`BUG
();

172  
func
;

173 
	}
}

183 
u32
 
	$i›13xx_©ux_cfg_addªss
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
)

185 
pci_sys_d©a
 *
sys
 = 
bus
->
sysd©a
;

186 
u32
 
addr
;

188 i‡(
sys
->
bu¢r
 =
bus
->
numbî
)

189 
addr
 = 1 << (
	`PCI_SLOT
(
dev‚
) + 16) | (PCI_SLOT(devfn) << 11);

191 
addr
 = 
bus
->
numbî
 << 16 | 
	`PCI_SLOT
(
dev‚
) << 11 | 1;

193 
addr
 |
	`PCI_FUNC
(
dev‚
Ë<< 8 | ((
whîe
 & 0xff) & ~3);

194 
addr
 |((
whîe
 & 0xf00) >> 8) << 24;

196  
addr
;

197 
	}
}

206 
u32
 
	$i›13xx_©ue_cfg_addªss
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
)

208 
pci_sys_d©a
 *
sys
 = 
bus
->
sysd©a
;

209 
u32
 
addr
;

211 
	`PRINTK
("iop13xx_atue_cfg_address: bus: %d dev: %d func: %d",

212 
bus
->
numbî
, 
	`PCI_SLOT
(
dev‚
), 
	`PCI_FUNC
(devfn));

213 
addr
 = ((
u32
Ë
bus
->
numbî
Ë<< 
IOP13XX_ATUE_OCCAR_BUS_NUM
 |

214 ((
u32
Ë
	`PCI_SLOT
(
dev‚
)Ë<< 
IOP13XX_ATUE_OCCAR_DEV_NUM
 |

215 ((
u32
Ë
	`PCI_FUNC
(
dev‚
)Ë<< 
IOP13XX_ATUE_OCCAR_FUNC_NUM
 |

216 (
whîe
 & ~0x3);

218 i‡(
sys
->
bu¢r
 !
bus
->
numbî
)

219 
addr
 |= 1;

221  
addr
;

222 
	}
}

230 
	$i›13xx_©ux_pci_°©us
(
˛ór
)

232 
°©us
;

233 
îr
 = 0;

238 
°©us
 = 
	`__øw_ªadw
(
IOP13XX_ATUX_ATUSR
);

239 i‡(
°©us
 & 
IOP_PCI_STATUS_ERROR
)

241 
	`PRINTK
("\t\t\tPCIÉº‹: ATUSR %#08x", 
°©us
);

242 if(
˛ór
)

243 
	`__øw_wrôew
(
°©us
 & 
IOP_PCI_STATUS_ERROR
,

244 
IOP13XX_ATUX_ATUSR
);

245 
îr
 = 1;

247 
°©us
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_ATUISR
);

248 i‡(
°©us
 & 
IOP13XX_ATUX_ATUISR_ERROR
)

250 
	`PRINTK
("\t\t\tPCIÉº‹ i¡îru±: ATUISR %#08x", 
°©us
);

251 if(
˛ór
)

252 
	`__øw_wrôñ
(
°©us
 & 
IOP13XX_ATUX_ATUISR_ERROR
,

253 
IOP13XX_ATUX_ATUISR
);

254 
îr
 = 1;

256  
îr
;

257 
	}
}

263 
u32
 
	$i›13xx_©ux_ªad
(
addr
)

265 
u32
 
vÆ
;

267 
__asm__
 
	`__vﬁ©ûe__
(

271 : "Ù" (
vÆ
)

272 : "r" (
addr
), "r" (
IOP13XX_ATUX_OCCAR
), "r" (
IOP13XX_ATUX_OCCDR
));

274  
vÆ
;

275 
	}
}

281 
	$i›13xx_©ux_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

282 
size
, 
u32
 *
vÆue
)

284 
addr
 = 
	`i›13xx_©ux_cfg_addªss
(
bus
, 
dev‚
, 
whîe
);

285 
u32
 
vÆ
 = 
	`i›13xx_©ux_ªad
(
addr
Ë>> ((
whîe
 & 3) * 8);

287 i‡(
	`i›13xx_©ux_pci_°©us
(1Ë|| 
	`is_©ux_occdr_îr‹
()) {

288 
	`__øw_wrôñ
(
	`__øw_ªadl
(
IOP13XX_XBG_BECSR
) & 3,

289 
IOP13XX_XBG_BECSR
);

290 
vÆ
 = 0xffffffff;

293 *
vÆue
 = 
vÆ
;

295  
PCIBIOS_SUCCESSFUL
;

296 
	}
}

299 
	$i›13xx_©ux_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

300 
size
, 
u32
 
vÆue
)

302 
addr
 = 
	`i›13xx_©ux_cfg_addªss
(
bus
, 
dev‚
, 
whîe
);

303 
u32
 
vÆ
;

305 i‡(
size
 != 4) {

306 
vÆ
 = 
	`i›13xx_©ux_ªad
(
addr
);

307 i‡(!
	`i›13xx_©ux_pci_°©us
(1) == 0)

308  
PCIBIOS_SUCCESSFUL
;

310 
whîe
 = (where & 3) * 8;

312 i‡(
size
 == 1)

313 
vÆ
 &~(0xf‡<< 
whîe
);

315 
vÆ
 &~(0xfff‡<< 
whîe
);

317 
	`__øw_wrôñ
(
vÆ
 | 
vÆue
 << 
whîe
, 
IOP13XX_ATUX_OCCDR
);

319 
	`__øw_wrôñ
(
addr
, 
IOP13XX_ATUX_OCCAR
);

320 
	`__øw_wrôñ
(
vÆue
, 
IOP13XX_ATUX_OCCDR
);

323  
PCIBIOS_SUCCESSFUL
;

324 
	}
}

326 
pci_›s
 
	gi›13xx_©ux_›s
 = {

327 .
ªad
 = 
i›13xx_©ux_ªad_c⁄fig
,

328 .
	gwrôe
 = 
i›13xx_©ux_wrôe_c⁄fig
,

337 
	$i›13xx_©ue_pci_°©us
(
˛ór
)

339 
°©us
;

340 
îr
 = 0;

347 
°©us
 = 
	`__øw_ªadw
(
IOP13XX_ATUE_ATUSR
);

348 i‡(
°©us
 & 
IOP_PCI_STATUS_ERROR
) {

349 
	`PRINTK
("\t\t\tPCIÉº‹: ATUSR %#08x", 
°©us
);

350 if(
˛ór
)

351 
	`__øw_wrôew
(
°©us
 & 
IOP_PCI_STATUS_ERROR
,

352 
IOP13XX_ATUE_ATUSR
);

353 
îr
++;

357 
°©us
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_ATUISR
);

358 i‡(
°©us
 & 
IOP13XX_ATUE_ATUISR_ERROR
) {

359 
	`PRINTK
("\t\t\tPCIÉº‹: ATUISR %#08x", 
°©us
);

360 i‡(
˛ór
)

361 
	`__øw_wrôew
(
°©us
 & 
IOP13XX_ATUE_ATUISR_ERROR
,

362 
IOP13XX_ATUE_ATUISR
);

363 
îr
++;

366 i‡(
°©us
 & 
IOP13XX_ATUE_STAT_PCI_IFACE_ERR
) {

368 
°©us
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_PIE_STS
) &

369 ~(
	`__øw_ªadl
(
IOP13XX_ATUE_PIE_MSK
));

371 i‡(
°©us
) {

372 
	`PRINTK
("\t\t\tPCI-EÉrror: ATUE_PIE_STS %#08x",

373 
	`__øw_ªadl
(
IOP13XX_ATUE_PIE_STS
));

374 
îr
++;

376 
	`PRINTK
("\t\t\tPCI-EÉrror: ATUE_PIE_STS %#08x",

377 
	`__øw_ªadl
(
IOP13XX_ATUE_PIE_STS
));

378 
	`PRINTK
("\t\t\tPCI-EÉrror: ATUE_PIE_MSK %#08x",

379 
	`__øw_ªadl
(
IOP13XX_ATUE_PIE_MSK
));

380 
	`BUG
();

383 if(
˛ór
)

384 
	`__øw_wrôñ
(
°©us
, 
IOP13XX_ATUE_PIE_STS
);

388  
îr
;

389 
	}
}

392 
	$i›13xx_pcõ_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
id£l
, u8 
pö
)

394 
	`WARN_ON
(
id£l
 != 0);

396 
pö
) {

397 1:  
ATUE_INTA
;

398 2:  
ATUE_INTB
;

399 3:  
ATUE_INTC
;

400 4:  
ATUE_INTD
;

403 
	}
}

405 
u32
 
	$i›13xx_©ue_ªad
(
addr
)

407 
u32
 
vÆ
;

409 
	`__øw_wrôñ
(
addr
, 
IOP13XX_ATUE_OCCAR
);

410 
vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OCCDR
);

412 
	`rmb
();

414  
vÆ
;

415 
	}
}

421 
	$i›13xx_©ue_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

422 
size
, 
u32
 *
vÆue
)

424 
u32
 
vÆ
;

425 
addr
 = 
	`i›13xx_©ue_cfg_addªss
(
bus
, 
dev‚
, 
whîe
);

428 i‡(!
	`PCI_SLOT
(
dev‚
Ë|| (
addr
 & 1)) {

429 
vÆ
 = 
	`i›13xx_©ue_ªad
(
addr
Ë>> ((
whîe
 & 3) * 8);

430 if–
	`i›13xx_©ue_pci_°©us
(1Ë|| 
	`is_©ue_occdr_îr‹
() ) {

431 
	`__øw_wrôñ
(
	`__øw_ªadl
(
IOP13XX_XBG_BECSR
) & 3,

432 
IOP13XX_XBG_BECSR
);

433 
vÆ
 = 0xffffffff;

436 
	`PRINTK
("addr=%#0lx, vÆ=%#010x", 
addr
, 
vÆ
);

438 
vÆ
 = 0xffffffff;

440 *
vÆue
 = 
vÆ
;

442  
PCIBIOS_SUCCESSFUL
;

443 
	}
}

446 
	$i›13xx_©ue_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

447 
size
, 
u32
 
vÆue
)

449 
addr
 = 
	`i›13xx_©ue_cfg_addªss
(
bus
, 
dev‚
, 
whîe
);

450 
u32
 
vÆ
;

452 i‡(
size
 != 4) {

453 
vÆ
 = 
	`i›13xx_©ue_ªad
(
addr
);

454 i‡(!
	`i›13xx_©ue_pci_°©us
(1) == 0)

455  
PCIBIOS_SUCCESSFUL
;

457 
whîe
 = (where & 3) * 8;

459 i‡(
size
 == 1)

460 
vÆ
 &~(0xf‡<< 
whîe
);

462 
vÆ
 &~(0xfff‡<< 
whîe
);

464 
	`__øw_wrôñ
(
vÆ
 | 
vÆue
 << 
whîe
, 
IOP13XX_ATUE_OCCDR
);

466 
	`__øw_wrôñ
(
addr
, 
IOP13XX_ATUE_OCCAR
);

467 
	`__øw_wrôñ
(
vÆue
, 
IOP13XX_ATUE_OCCDR
);

470  
PCIBIOS_SUCCESSFUL
;

471 
	}
}

473 
pci_›s
 
	gi›13xx_©ue_›s
 = {

474 .
ªad
 = 
i›13xx_©ue_ªad_c⁄fig
,

475 .
	gwrôe
 = 
i›13xx_©ue_wrôe_c⁄fig
,

485 
	$i›13xx_pci_ab‹t
(
addr
, 
f§
, 
±_ªgs
 *
ªgs
)

487 
	`PRINTK
("Dataábort:áddress = 0x%08lx "

489 
addr
, 
f§
, 
ªgs
->
ARM_pc
,Ñegs->
ARM_Ã
);

491 
	`PRINTK
("IOP13XX_XBG_BECSR: %#10x", 
	`__øw_ªadl
(
IOP13XX_XBG_BECSR
));

492 
	`PRINTK
("IOP13XX_XBG_BERAR: %#10x", 
	`__øw_ªadl
(
IOP13XX_XBG_BERAR
));

493 
	`PRINTK
("IOP13XX_XBG_BERUAR: %#10x", 
	`__øw_ªadl
(
IOP13XX_XBG_BERUAR
));

498 i‡(
f§
 & (1 << 10))

499 
ªgs
->
ARM_pc
 += 4;

501 i‡(
	`is_©ue_occdr_îr‹
(Ë|| 
	`is_©ux_occdr_îr‹
())

505 
	}
}

509 
pci_bus
 *
	$i›13xx_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sys
)

511 
which_©u
;

512 
pci_bus
 *
bus
 = 
NULL
;

514 
öô_©u
) {

515 
IOP13XX_INIT_ATU_ATUX
:

516 
which_©u
 = 
ƒ
 ? 0 : 
IOP13XX_INIT_ATU_ATUX
;

518 
IOP13XX_INIT_ATU_ATUE
:

519 
which_©u
 = 
ƒ
 ? 0 : 
IOP13XX_INIT_ATU_ATUE
;

521 (
IOP13XX_INIT_ATU_ATUX
 | 
IOP13XX_INIT_ATU_ATUE
):

522 
which_©u
 = 
ƒ
 ? 
IOP13XX_INIT_ATU_ATUE
 : 
IOP13XX_INIT_ATU_ATUX
;

525 
which_©u
 = 0;

528 i‡(!
which_©u
) {

529 
	`BUG
();

530  
NULL
;

533 
which_©u
) {

534 
IOP13XX_INIT_ATU_ATUX
:

535 i‡(
	`time_a·î_eq
(
jiffõs
 + 
	`m£cs_to_jiffõs
(1000),

536 
©ux_åhÁ_timeout
))

537 
	`time_bef‹e
(
jiffõs
, 
©ux_åhÁ_timeout
))

538 
	`udñay
(100);

540 
bus
 = 
pci_bus_©ux
 = 
	`pci_sˇn_bus
(
sys
->
bu¢r
,

541 &
i›13xx_©ux_›s
,

542 
sys
);

544 
IOP13XX_INIT_ATU_ATUE
:

545 
bus
 = 
pci_bus_©ue
 = 
	`pci_sˇn_bus
(
sys
->
bu¢r
,

546 &
i›13xx_©ue_›s
,

547 
sys
);

551  
bus
;

552 
	}
}

558 
__öô
 
	$i›13xx_©ue_£tup
()

560 
func
 = 
	`i›13xx_©u_fun˘i⁄
(
IOP13XX_INIT_ATU_ATUE
);

561 
u32
 
ªg_vÆ
;

563 #ifde‡
CONFIG_PCI_MSI


565 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PHYS
, 
IOP13XX_MU_MUBAR
);

566 
	`__øw_wrôñ
(~(
IOP13XX_MU_WINDOW_SIZE
 - 1), 
IOP13XX_ATUE_IALR0
);

567 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PHYS
, 
IOP13XX_ATUE_IATVR0
);

568 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PCI
, 
IOP13XX_ATUE_IABAR0
);

573 
	`__øw_wrôñ
(~(
IOP13XX_MAX_RAM_SIZE
 - 
PHYS_OFFSET
 - 1) & ~0x1,

574 
IOP13XX_ATUE_IALR1
);

575 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUBAR1
);

578 
	`__øw_wrôñ
(
PHYS_OFFSET
 | 
PCI_BASE_ADDRESS_MEM_TYPE_64
 |

579 
PCI_BASE_ADDRESS_MEM_PREFETCH
, 
IOP13XX_ATUE_IABAR1
);

584 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUTVR1
);

585 
	`__øw_wrôñ
(
PHYS_OFFSET
, 
IOP13XX_ATUE_IATVR1
);

589 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_OUMWTVR1
);

591 
	`__øw_wrôñ
(
IOP13XX_ATUE_OUMBAR_ENABLE
 |

592 (
IOP13XX_PCIE_MEM_PHYS_OFFSET
 >> 32),

593 
IOP13XX_ATUE_OUMBAR1
);

598 
	`__øw_wrôñ
(((
IOP13XX_PCIE_LOWER_IO_PA
 >> 0x4) & 0xfffff000),

599 
IOP13XX_ATUE_OIOBAR
);

600 
	`__øw_wrôñ
(
IOP13XX_PCIE_LOWER_IO_BA
, 
IOP13XX_ATUE_OIOWTVR
);

603 
	`i›13xx_©ue_pci_°©us
(1);

607 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OIOBAR
);

608 
ªg_vÆ
 &= ~0x7;

609 
ªg_vÆ
 |
func
;

610 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OIOBAR
);

614 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR0
);

615 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

616 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

617 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

618 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR0
);

620 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR1
);

621 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

622 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

623 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

624 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR1
);

626 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR2
);

627 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

628 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

629 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

630 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR2
);

632 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR3
);

633 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

634 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

635 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

636 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR3
);

640 
ªg_vÆ
 = 
	`__øw_ªadw
(
IOP13XX_ATUE_ATUCMD
);

641 
ªg_vÆ
 |
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_MASTER
 |

642 
PCI_COMMAND_PARITY
 | 
PCI_COMMAND_SERR
;

643 
	`__øw_wrôew
(
ªg_vÆ
, 
IOP13XX_ATUE_ATUCMD
);

645 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_ATUCR
);

646 
ªg_vÆ
 |
IOP13XX_ATUE_ATUCR_OUT_EN
 |

647 
IOP13XX_ATUE_ATUCR_IVM
;

648 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_ATUCR
);

649 
	}
}

651 
__öô
 
	$i›13xx_©ue_dißbÀ
()

653 
u32
 
ªg_vÆ
;

655 
	`__øw_wrôew
(0x0, 
IOP13XX_ATUE_ATUCMD
);

656 
	`__øw_wrôñ
(
IOP13XX_ATUE_ATUCR_IVM
, 
IOP13XX_ATUE_ATUCR
);

659 
	`__øw_ªadl
(
IOP13XX_ATUE_PCSR
Ë& (
IOP13XX_ATUE_PCSR_OUT_Q_BUSY
 |

660 
IOP13XX_ATUE_PCSR_IN_Q_BUSY
 |

661 
IOP13XX_ATUE_PCSR_LLRB_BUSY
))

662 
	`˝u_ªœx
();

665 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUBAR0
);

666 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IABAR0
);

667 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUTVR0
);

668 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IATVR0
);

669 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IALR0
);

670 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR0
);

671 
ªg_vÆ
 &~
IOP13XX_ATUE_OUMBAR_ENABLE
;

672 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR0
);

675 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUBAR1
);

676 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IABAR1
);

677 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUTVR1
);

678 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IATVR1
);

679 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IALR1
);

680 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR1
);

681 
ªg_vÆ
 &~
IOP13XX_ATUE_OUMBAR_ENABLE
;

682 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR1
);

685 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUBAR2
);

686 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IABAR2
);

687 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IAUTVR2
);

688 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IATVR2
);

689 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUE_IALR2
);

690 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR2
);

691 
ªg_vÆ
 &~
IOP13XX_ATUE_OUMBAR_ENABLE
;

692 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR2
);

695 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_OUMBAR3
);

696 
ªg_vÆ
 &~
IOP13XX_ATUE_OUMBAR_ENABLE
;

697 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUE_OUMBAR3
);

702 
	`__øw_wrôñ
((
IOP13XX_PCIE_LOWER_IO_PA
 >> 0x4) & 0xfffff000,

703 
IOP13XX_ATUE_OIOBAR
);

704 
	`__øw_wrôñ
(
IOP13XX_PCIE_LOWER_IO_BA
, 
IOP13XX_ATUE_OIOWTVR
);

705 
	}
}

711 
__öô
 
	$i›13xx_©ux_£tup
()

713 
u32
 
ªg_vÆ
;

714 
func
 = 
	`i›13xx_©u_fun˘i⁄
(
IOP13XX_INIT_ATU_ATUX
);

721 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_PCSR
);

722 i‡(
ªg_vÆ
 & 
IOP13XX_ATUX_PCSR_P_RSTOUT
) {

723 
m£c
 = (
ªg_vÆ
 >> 
IOP13XX_ATUX_PCSR_FREQ_OFFSET
) & 0x7;

724 
m£c
 = 1000 / (8-msec);

725 
	`__øw_wrôñ
(
ªg_vÆ
 & ~
IOP13XX_ATUX_PCSR_P_RSTOUT
,

726 
IOP13XX_ATUX_PCSR
);

727 
©ux_åhÁ_timeout
 = 
jiffõs
 + 
	`m£cs_to_jiffõs
(
m£c
);

730 
©ux_åhÁ_timeout
 = 
jiffõs
;

732 #ifde‡
CONFIG_PCI_MSI


734 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PHYS
, 
IOP13XX_MU_MUBAR
);

735 
	`__øw_wrôñ
(~(
IOP13XX_MU_WINDOW_SIZE
 - 1), 
IOP13XX_ATUX_IALR0
);

736 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PHYS
, 
IOP13XX_ATUX_IATVR0
);

737 
	`__øw_wrôñ
(
IOP13XX_MU_BASE_PCI
, 
IOP13XX_ATUX_IABAR0
);

742 
	`__øw_wrôñ
(~(
IOP13XX_MAX_RAM_SIZE
 - 
PHYS_OFFSET
 - 1) & ~0x1,

743 
IOP13XX_ATUX_IALR1
);

744 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUBAR1
);

747 
	`__øw_wrôñ
(
PHYS_OFFSET
 | 
PCI_BASE_ADDRESS_MEM_TYPE_64
 |

748 
PCI_BASE_ADDRESS_MEM_PREFETCH
, 
IOP13XX_ATUX_IABAR1
);

753 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUTVR1
);

754 
	`__øw_wrôñ
(
PHYS_OFFSET
, 
IOP13XX_ATUX_IATVR1
);

758 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_OUMWTVR1
);

760 
	`__øw_wrôñ
(
IOP13XX_ATUX_OUMBAR_ENABLE
 |

761 
IOP13XX_PCIX_MEM_PHYS_OFFSET
 >> 32,

762 
IOP13XX_ATUX_OUMBAR1
);

767 
	`__øw_wrôñ
((
IOP13XX_PCIX_LOWER_IO_PA
 >> 0x4) & 0xfffff000,

768 
IOP13XX_ATUX_OIOBAR
);

769 
	`__øw_wrôñ
(
IOP13XX_PCIX_LOWER_IO_BA
, 
IOP13XX_ATUX_OIOWTVR
);

772 
	`i›13xx_©ux_pci_°©us
(1);

776 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OIOBAR
);

777 
ªg_vÆ
 &= ~0x7;

778 
ªg_vÆ
 |
func
;

779 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OIOBAR
);

783 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR0
);

784 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

785 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

786 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

787 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR0
);

789 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR1
);

790 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

791 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

792 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

793 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR1
);

795 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR2
);

796 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

797 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

798 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

799 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR2
);

801 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR3
);

802 
ªg_vÆ
 &~(
IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK
 <<

803 
IOP13XX_ATU_OUMBAR_FUNC_NUM
);

804 
ªg_vÆ
 |
func
 << 
IOP13XX_ATU_OUMBAR_FUNC_NUM
;

805 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR3
);

809 
ªg_vÆ
 = 
	`__øw_ªadw
(
IOP13XX_ATUX_ATUCMD
);

810 
ªg_vÆ
 |
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_MASTER
 |

811 
PCI_COMMAND_PARITY
 | 
PCI_COMMAND_SERR
;

812 
	`__øw_wrôew
(
ªg_vÆ
, 
IOP13XX_ATUX_ATUCMD
);

814 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_ATUCR
);

815 
ªg_vÆ
 |
IOP13XX_ATUX_ATUCR_OUT_EN
;

816 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_ATUCR
);

817 
	}
}

819 
__öô
 
	$i›13xx_©ux_dißbÀ
()

821 
u32
 
ªg_vÆ
;

823 
	`__øw_wrôew
(0x0, 
IOP13XX_ATUX_ATUCMD
);

824 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_ATUCR
);

827 
	`__øw_ªadl
(
IOP13XX_ATUX_PCSR
Ë& (
IOP13XX_ATUX_PCSR_OUT_Q_BUSY
 |

828 
IOP13XX_ATUX_PCSR_IN_Q_BUSY
))

829 
	`˝u_ªœx
();

832 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUBAR0
);

833 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IABAR0
);

834 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUTVR0
);

835 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IATVR0
);

836 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IALR0
);

837 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR0
);

838 
ªg_vÆ
 &~
IOP13XX_ATUX_OUMBAR_ENABLE
;

839 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR0
);

842 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUBAR1
);

843 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IABAR1
);

844 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUTVR1
);

845 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IATVR1
);

846 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IALR1
);

847 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR1
);

848 
ªg_vÆ
 &~
IOP13XX_ATUX_OUMBAR_ENABLE
;

849 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR1
);

852 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUBAR2
);

853 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IABAR2
);

854 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUTVR2
);

855 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IATVR2
);

856 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IALR2
);

857 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR2
);

858 
ªg_vÆ
 &~
IOP13XX_ATUX_OUMBAR_ENABLE
;

859 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR2
);

862 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUBAR3
);

863 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IABAR3
);

864 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IAUTVR3
);

865 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IATVR3
);

866 
	`__øw_wrôñ
(0x0, 
IOP13XX_ATUX_IALR3
);

867 
ªg_vÆ
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_OUMBAR3
);

868 
ªg_vÆ
 &~
IOP13XX_ATUX_OUMBAR_ENABLE
;

869 
	`__øw_wrôñ
(
ªg_vÆ
, 
IOP13XX_ATUX_OUMBAR3
);

874 
	`__øw_wrôñ
((
IOP13XX_PCIX_LOWER_IO_PA
 >> 0x4) & 0xfffff000,

875 
IOP13XX_ATUX_OIOBAR
);

876 
	`__øw_wrôñ
(
IOP13XX_PCIX_LOWER_IO_BA
, 
IOP13XX_ATUX_OIOWTVR
);

877 
	}
}

879 
__öô
 
	$i›13xx_£t_©u_mmr_ba£s
()

882 
	`__øw_ªadl
(
IOP13XX_ESSR0
) &

883 (
IOP13XX_CONTROLLER_ONLY
 | 
IOP13XX_INTERFACE_SEL_PCIX
)) {

886 
i›13xx_©ux_pmmr_off£t
 = 
IOP13XX_ATU1_PMMR_OFFSET
;

887 
i›13xx_©ue_pmmr_off£t
 = 
IOP13XX_ATU2_PMMR_OFFSET
;

892 
IOP13XX_CONTROLLER_ONLY
:

893 
i›13xx_©ux_pmmr_off£t
 = 
IOP13XX_ATU0_PMMR_OFFSET
;

894 
i›13xx_©ue_pmmr_off£t
 = 
IOP13XX_ATU2_PMMR_OFFSET
;

899 
IOP13XX_INTERFACE_SEL_PCIX
:

900 
i›13xx_©ux_pmmr_off£t
 = 
IOP13XX_ATU1_PMMR_OFFSET
;

901 
i›13xx_©ue_pmmr_off£t
 = 
IOP13XX_ATU2_PMMR_OFFSET
;

904 
IOP13XX_CONTROLLER_ONLY
 | 
IOP13XX_INTERFACE_SEL_PCIX
:

905 
i›13xx_©ux_pmmr_off£t
 = 
IOP13XX_ATU2_PMMR_OFFSET
;

906 
i›13xx_©ue_pmmr_off£t
 = 
IOP13XX_ATU0_PMMR_OFFSET
;

909 
	`BUG
();

911 
	}
}

913 
__öô
 
	$i›13xx_©u_£À˘
(
hw_pci
 *
∂©_pci
)

915 
i
;

921 i‡(
öô_©u
 =
IOP13XX_INIT_ATU_DEFAULT
) {

923 i‡(
	`__øw_ªadl
(
IOP13XX_ESSR0
Ë& 
IOP13XX_INTERFACE_SEL_PCIX
) {

927 
öô_©u
 |
IOP13XX_INIT_ATU_ATUE
;

928 
	`__øw_ªadw
(
IOP13XX_ATUE_DID
) & 0xf0) {

932 
öô_©u
 |
IOP13XX_INIT_ATU_ATUX
;

939 
öô_©u
 |
IOP13XX_INIT_ATU_ATUX
;

940 
	`__øw_ªadw
(
IOP13XX_ATUX_DID
) & 0xf0) {

944 
öô_©u
 |
IOP13XX_INIT_ATU_ATUE
;

950 i‡(
öô_©u
 & 
IOP13XX_INIT_ATU_ATUX
)

951 i‡(!(
	`__øw_ªadl
(
IOP13XX_ATUX_PCSR
) &

952 
IOP13XX_ATUX_PCSR_CENTRAL_RES
))

953 
öô_©u
 &~
IOP13XX_INIT_ATU_ATUX
;

955 i‡(
öô_©u
 & 
IOP13XX_INIT_ATU_ATUE
)

956 i‡(
	`__øw_ªadl
(
IOP13XX_ATUE_PCSR
) &

957 
IOP13XX_ATUE_PCSR_END_POINT
)

958 
öô_©u
 &~
IOP13XX_INIT_ATU_ATUE
;

961 
i
 = 0; i < 2; i++) {

962 if((
öô_©u
 & (1 << 
i
)) == (1 << i))

963 
∂©_pci
->
ƒ_c⁄åﬁÀrs
++;

965 
	}
}

967 
__öô
 
	$i›13xx_pci_öô
()

970 
	`__øw_wrôñ
(
	`__øw_ªadl
(
IOP13XX_XBG_BECSR
) & 3, IOP13XX_XBG_BECSR);

973 
i›13xx_pcibios_mö_mem
 = 
IOP13XX_PCIX_LOWER_MEM_BA
;

979 i‡(
öô_©u
 & 
IOP13XX_INIT_ATU_ATUE
) {

980 
	`i›13xx_©ue_dißbÀ
();

981 
	`i›13xx_©ue_£tup
();

984 i‡(
öô_©u
 & 
IOP13XX_INIT_ATU_ATUX
) {

985 
	`i›13xx_©ux_dißbÀ
();

986 
	`i›13xx_©ux_£tup
();

989 
	`hook_Áu…_code
(16+6, 
i›13xx_pci_ab‹t
, 
SIGBUS
,

991 
	}
}

996 
	$i›13xx_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

998 
ªsour˚
 *
ªs
;

999 
which_©u
;

1000 
u32
 
pcix§
, 
pc§
;

1002 i‡(
ƒ
 > 1)

1005 
ªs
 = 
	`kmÆloc
((
ªsour˚
Ë* 2, 
GFP_KERNEL
);

1006 i‡(!
ªs
)

1007 
	`∑nic
("PCI: unableÅoállocÑesources");

1009 
	`mem£t
(
ªs
, 0, (
ªsour˚
) * 2);

1016 
öô_©u
) {

1017 
IOP13XX_INIT_ATU_ATUX
:

1018 
which_©u
 = 
ƒ
 ? 0 : 
IOP13XX_INIT_ATU_ATUX
;

1020 
IOP13XX_INIT_ATU_ATUE
:

1021 
which_©u
 = 
ƒ
 ? 0 : 
IOP13XX_INIT_ATU_ATUE
;

1023 (
IOP13XX_INIT_ATU_ATUX
 | 
IOP13XX_INIT_ATU_ATUE
):

1024 
which_©u
 = 
ƒ
 ? 
IOP13XX_INIT_ATU_ATUE
 : 
IOP13XX_INIT_ATU_ATUX
;

1027 
which_©u
 = 0;

1030 i‡(!
which_©u
)

1033 
which_©u
) {

1034 
IOP13XX_INIT_ATU_ATUX
:

1035 
pcix§
 = 
	`__øw_ªadl
(
IOP13XX_ATUX_PCIXSR
);

1036 
pcix§
 &= ~0xffff;

1037 
pcix§
 |
sys
->
bu¢r
 << 
IOP13XX_ATUX_PCIXSR_BUS_NUM
 |

1038 0 << 
IOP13XX_ATUX_PCIXSR_DEV_NUM
 |

1039 
	`i›13xx_©u_fun˘i⁄
(
IOP13XX_INIT_ATU_ATUX
)

1040 << 
IOP13XX_ATUX_PCIXSR_FUNC_NUM
;

1041 
	`__øw_wrôñ
(
pcix§
, 
IOP13XX_ATUX_PCIXSR
);

1043 
ªs
[0].
°¨t
 = 
IOP13XX_PCIX_LOWER_IO_PA
 + 
IOP13XX_PCIX_IO_BUS_OFFSET
;

1044 
ªs
[0].
íd
 = 
IOP13XX_PCIX_UPPER_IO_PA
;

1045 
ªs
[0].
«me
 = "IQ81340 ATUX PCI I/O Space";

1046 
ªs
[0].
Êags
 = 
IORESOURCE_IO
;

1048 
ªs
[1].
°¨t
 = 
IOP13XX_PCIX_LOWER_MEM_RA
;

1049 
ªs
[1].
íd
 = 
IOP13XX_PCIX_UPPER_MEM_RA
;

1050 
ªs
[1].
«me
 = "IQ81340 ATUX PCI Memory Space";

1051 
ªs
[1].
Êags
 = 
IORESOURCE_MEM
;

1052 
sys
->
mem_off£t
 = 
IOP13XX_PCIX_MEM_OFFSET
;

1053 
sys
->
io_off£t
 = 
IOP13XX_PCIX_LOWER_IO_PA
;

1055 
IOP13XX_INIT_ATU_ATUE
:

1057 
pc§
 = 
	`__øw_ªadl
(
IOP13XX_ATUE_PCSR
);

1058 
pc§
 &= ~(0xfff8 << 16);

1059 
pc§
 |
sys
->
bu¢r
 << 
IOP13XX_ATUE_PCSR_BUS_NUM
 |

1060 0 << 
IOP13XX_ATUE_PCSR_DEV_NUM
;

1062 
	`__øw_wrôñ
(
pc§
, 
IOP13XX_ATUE_PCSR
);

1064 
ªs
[0].
°¨t
 = 
IOP13XX_PCIE_LOWER_IO_PA
 + 
IOP13XX_PCIE_IO_BUS_OFFSET
;

1065 
ªs
[0].
íd
 = 
IOP13XX_PCIE_UPPER_IO_PA
;

1066 
ªs
[0].
«me
 = "IQ81340 ATUE PCI I/O Space";

1067 
ªs
[0].
Êags
 = 
IORESOURCE_IO
;

1069 
ªs
[1].
°¨t
 = 
IOP13XX_PCIE_LOWER_MEM_RA
;

1070 
ªs
[1].
íd
 = 
IOP13XX_PCIE_UPPER_MEM_RA
;

1071 
ªs
[1].
«me
 = "IQ81340 ATUE PCI Memory Space";

1072 
ªs
[1].
Êags
 = 
IORESOURCE_MEM
;

1073 
sys
->
mem_off£t
 = 
IOP13XX_PCIE_MEM_OFFSET
;

1074 
sys
->
io_off£t
 = 
IOP13XX_PCIE_LOWER_IO_PA
;

1075 
sys
->
m≠_úq
 = 
i›13xx_pcõ_m≠_úq
;

1081 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
ªs
[0]);

1082 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
ªs
[1]);

1084 
sys
->
ªsour˚
[0] = &
ªs
[0];

1085 
sys
->
ªsour˚
[1] = &
ªs
[1];

1086 
sys
->
ªsour˚
[2] = 
NULL
;

1089 
	}
}

1091 
u16
 
	$i›13xx_dev_id
()

1093 i‡(
	`__øw_ªadl
(
IOP13XX_ESSR0
Ë& 
IOP13XX_INTERFACE_SEL_PCIX
)

1094  
	`__øw_ªadw
(
IOP13XX_ATUE_DID
);

1096  
	`__øw_ªadw
(
IOP13XX_ATUX_DID
);

1097 
	}
}

1099 
__öô
 
	$i›13xx_öô_©u_£tup
(*
°r
)

1101 
öô_©u
 = 
IOP13XX_INIT_ATU_NONE
;

1102 i‡(
°r
) {

1103 *
°r
 != '\0') {

1104 *
°r
) {

1107 
öô_©u
 |
IOP13XX_INIT_ATU_ATUX
;

1108 
öô_©u
 &~
IOP13XX_INIT_ATU_NONE
;

1112 
öô_©u
 |
IOP13XX_INIT_ATU_ATUE
;

1113 
öô_©u
 &~
IOP13XX_INIT_ATU_NONE
;

1119 
	`PRINTK
("\"iop13xx_init_atu\" malformedát "

1120 "ch¨a˘î: \'%c\'", *
°r
);

1121 *(
°r
 + 1) = '\0';

1122 
öô_©u
 = 
IOP13XX_INIT_ATU_DEFAULT
;

1124 
°r
++;

1128 
	}
}

1130 
__£tup
("i›13xx_öô_©u", 
i›13xx_öô_©u_£tup
);

	@arch/arm/mach-iop13xx/setup.c

20 
	~<löux/£rül_8250.h
>

21 #ifde‡
CONFIG_MTD_PHYSMAP


22 
	~<löux/mtd/physm≠.h
>

24 
	~<asm/mach/m≠.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/io.h
>

29 
	#IOP13XX_UART_XTAL
 33334000

	)

30 
	#IOP13XX_SETUP_DEBUG
 0

	)

31 
	#PRINTK
(
x
...Ë(()(
IOP13XX_SETUP_DEBUG
 && 
	`¥ötk
(x)))

	)

35 
m≠_desc
 
	gi›13xx_°d_desc
[] 
	g__öôd©a
 = {

37 .
vútuÆ
 = 
IOP13XX_PMMR_VIRT_MEM_BASE
,

38 .
	gp‚
 = 
__phys_to_p‚
(
IOP13XX_PMMR_PHYS_MEM_BASE
),

39 .
	gÀngth
 = 
IOP13XX_PMMR_SIZE
,

40 .
	gty≥
 = 
MT_DEVICE
,

42 .
	gvútuÆ
 = 
IOP13XX_PCIE_LOWER_IO_VA
,

43 .
	gp‚
 = 
__phys_to_p‚
(
IOP13XX_PCIE_LOWER_IO_PA
),

44 .
	gÀngth
 = 
IOP13XX_PCIX_IO_WINDOW_SIZE
,

45 .
	gty≥
 = 
MT_DEVICE
,

47 .
	gvútuÆ
 = 
IOP13XX_PCIX_LOWER_IO_VA
,

48 .
	gp‚
 = 
__phys_to_p‚
(
IOP13XX_PCIX_LOWER_IO_PA
),

49 .
	gÀngth
 = 
IOP13XX_PCIX_IO_WINDOW_SIZE
,

50 .
	gty≥
 = 
MT_DEVICE
,

54 
ªsour˚
 
	gi›13xx_u¨t0_ªsour˚s
[] = {

56 .
°¨t
 = 
IOP13XX_UART0_PHYS
,

57 .
	gíd
 = 
IOP13XX_UART0_PHYS
 + 0x3f,

58 .
	gÊags
 = 
IORESOURCE_MEM
,

61 .
°¨t
 = 
IRQ_IOP13XX_UART0
,

62 .
	gíd
 = 
IRQ_IOP13XX_UART0
,

63 .
	gÊags
 = 
IORESOURCE_IRQ


67 
ªsour˚
 
	gi›13xx_u¨t1_ªsour˚s
[] = {

69 .
°¨t
 = 
IOP13XX_UART1_PHYS
,

70 .
	gíd
 = 
IOP13XX_UART1_PHYS
 + 0x3f,

71 .
	gÊags
 = 
IORESOURCE_MEM
,

74 .
°¨t
 = 
IRQ_IOP13XX_UART1
,

75 .
	gíd
 = 
IRQ_IOP13XX_UART1
,

76 .
	gÊags
 = 
IORESOURCE_IRQ


80 
∂©_£rül8250_p‹t
 
	gi›13xx_u¨t0_d©a
[] = {

82 .
memba£
 = (*)(
IOP13XX_UART0_VIRT
),

83 .
	gm≠ba£
 = (
IOP13XX_UART0_PHYS
),

84 .
	gúq
 = 
IRQ_IOP13XX_UART0
,

85 .
	gu¨t˛k
 = 
IOP13XX_UART_XTAL
,

86 .
	gªgshi·
 = 2,

87 .
	giŸy≥
 = 
UPIO_MEM
,

88 .
	gÊags
 = 
UPF_SKIP_TEST
,

93 
∂©_£rül8250_p‹t
 
	gi›13xx_u¨t1_d©a
[] = {

95 .
memba£
 = (*)(
IOP13XX_UART1_VIRT
),

96 .
	gm≠ba£
 = (
IOP13XX_UART1_PHYS
),

97 .
	gúq
 = 
IRQ_IOP13XX_UART1
,

98 .
	gu¨t˛k
 = 
IOP13XX_UART_XTAL
,

99 .
	gªgshi·
 = 2,

100 .
	giŸy≥
 = 
UPIO_MEM
,

101 .
	gÊags
 = 
UPF_SKIP_TEST
,

107 
∂©f‹m_devi˚
 
	gi›13xx_u¨t0
 = {

108 .
«me
 = "serial8250",

109 .
	gid
 = 0,

110 .
	gdev
.
	g∂©f‹m_d©a
 = 
i›13xx_u¨t0_d©a
,

111 .
	gnum_ªsour˚s
 = 2,

112 .
	gªsour˚
 = 
i›13xx_u¨t0_ªsour˚s
,

115 
∂©f‹m_devi˚
 
	gi›13xx_u¨t1
 = {

116 .
«me
 = "serial8250",

117 .
	gid
 = 0,

118 .
	gdev
.
	g∂©f‹m_d©a
 = 
i›13xx_u¨t1_d©a
,

119 .
	gnum_ªsour˚s
 = 2,

120 .
	gªsour˚
 = 
i›13xx_u¨t1_ªsour˚s


123 
ªsour˚
 
	gi›13xx_i2c_0_ªsour˚s
[] = {

125 .
°¨t
 = 
IOP13XX_I2C0_PHYS
,

126 .
	gíd
 = 
IOP13XX_I2C0_PHYS
 + 0x18,

127 .
	gÊags
 = 
IORESOURCE_MEM
,

130 .
°¨t
 = 
IRQ_IOP13XX_I2C_0
,

131 .
	gíd
 = 
IRQ_IOP13XX_I2C_0
,

132 .
	gÊags
 = 
IORESOURCE_IRQ


136 
ªsour˚
 
	gi›13xx_i2c_1_ªsour˚s
[] = {

138 .
°¨t
 = 
IOP13XX_I2C1_PHYS
,

139 .
	gíd
 = 
IOP13XX_I2C1_PHYS
 + 0x18,

140 .
	gÊags
 = 
IORESOURCE_MEM
,

143 .
°¨t
 = 
IRQ_IOP13XX_I2C_1
,

144 .
	gíd
 = 
IRQ_IOP13XX_I2C_1
,

145 .
	gÊags
 = 
IORESOURCE_IRQ


149 
ªsour˚
 
	gi›13xx_i2c_2_ªsour˚s
[] = {

151 .
°¨t
 = 
IOP13XX_I2C2_PHYS
,

152 .
	gíd
 = 
IOP13XX_I2C2_PHYS
 + 0x18,

153 .
	gÊags
 = 
IORESOURCE_MEM
,

156 .
°¨t
 = 
IRQ_IOP13XX_I2C_2
,

157 .
	gíd
 = 
IRQ_IOP13XX_I2C_2
,

158 .
	gÊags
 = 
IORESOURCE_IRQ


167 
∂©f‹m_devi˚
 
	gi›13xx_i2c_0_c⁄åﬁÀr
 = {

168 .
«me
 = "IOP3xx-I2C",

169 .
	gid
 = 0,

170 .
	gnum_ªsour˚s
 = 2,

171 .
	gªsour˚
 = 
i›13xx_i2c_0_ªsour˚s


174 
∂©f‹m_devi˚
 
	gi›13xx_i2c_1_c⁄åﬁÀr
 = {

175 .
«me
 = "IOP3xx-I2C",

176 .
	gid
 = 0,

177 .
	gnum_ªsour˚s
 = 2,

178 .
	gªsour˚
 = 
i›13xx_i2c_1_ªsour˚s


181 
∂©f‹m_devi˚
 
	gi›13xx_i2c_2_c⁄åﬁÀr
 = {

182 .
«me
 = "IOP3xx-I2C",

183 .
	gid
 = 0,

184 .
	gnum_ªsour˚s
 = 2,

185 .
	gªsour˚
 = 
i›13xx_i2c_2_ªsour˚s


188 #ifde‡
CONFIG_MTD_PHYSMAP


191 
physm≠_Êash_d©a
 
	giq8134x_Êash_d©a
 = {

192 .
width
 = 2,

195 
ªsour˚
 
	giq8134x_Êash_ªsour˚
 = {

196 .
°¨t
 = 
IQ81340_FLASHBASE
,

197 .
	gíd
 = 0,

198 .
	gÊags
 = 
IORESOURCE_MEM
,

201 
∂©f‹m_devi˚
 
	giq8134x_Êash
 = {

202 .
«me
 = "physmap-flash",

203 .
	gid
 = 0,

204 .
	gdev
 = { .
∂©f‹m_d©a
 = &
iq8134x_Êash_d©a
, },

205 .
	gnum_ªsour˚s
 = 1,

206 .
	gªsour˚
 = &
iq8134x_Êash_ªsour˚
,

209 
	$iq8134x_¥obe_Êash_size
()

211 
uöt8_t
 
__iomem
 *
Êash_addr
 = 
	`i‹em≠
(
IQ81340_FLASHBASE
, 
PAGE_SIZE
);

212 
i
;

213 
quîy
[3];

214 
size
 = 0;

215 
width
 = 
iq8134x_Êash_d©a
.width;

217 i‡(
Êash_addr
) {

219 
	`wrôew
(0x98, 
Êash_addr
);

222 
i
 = 0; i < 3 * 
width
; i += width)

223 
quîy
[
i
 / 
width
] = 
	`ªadb
(
Êash_addr
 + (0x10 * width) + i);

226 i‡(
	`memcmp
(
quîy
, "QRY", 3) == 0)

227 
size
 = 1 << 
	`ªadb
(
Êash_addr
 + (0x27 * 
width
));

230 
	`wrôew
(0xff, 
Êash_addr
);

232 
	`iounm≠
(
Êash_addr
);

235  
size
;

236 
	}
}

239 
__öô
 
	$i›13xx_m≠_io
()

242 
	`iŸabÀ_öô
(
i›13xx_°d_desc
, 
	`ARRAY_SIZE
(iop13xx_std_desc));

243 
	}
}

245 
	göô_u¨t
 = 0;

246 
	göô_i2c
 = 0;

248 
__öô
 
	$i›13xx_∂©f‹m_öô
()

250 
i
;

251 
u32
 
u¨t_idx
, 
i2c_idx
, 
∂©_idx
;

252 
∂©f‹m_devi˚
 *
i›13xx_devi˚s
[
IQ81340_MAX_PLAT_DEVICES
];

255 
	`i›13xx_£t_©u_mmr_ba£s
();

257 
	`mem£t
(
i›13xx_devi˚s
, 0, (iop13xx_devices));

259 i‡(
öô_u¨t
 =
IOP13XX_INIT_UART_DEFAULT
) {

260 
	`i›13xx_dev_id
()) {

266 
öô_u¨t
 |
IOP13XX_INIT_UART_0
;

267 
öô_u¨t
 |
IOP13XX_INIT_UART_1
;

271 
öô_u¨t
 |
IOP13XX_INIT_UART_1
;

275 i‡(
öô_i2c
 =
IOP13XX_INIT_I2C_DEFAULT
) {

276 
	`i›13xx_dev_id
()) {

286 
öô_i2c
 |
IOP13XX_INIT_I2C_0
;

287 
öô_i2c
 |
IOP13XX_INIT_I2C_1
;

288 
öô_i2c
 |
IOP13XX_INIT_I2C_2
;

292 
öô_i2c
 |
IOP13XX_INIT_I2C_1
;

293 
öô_i2c
 |
IOP13XX_INIT_I2C_2
;

297 
∂©_idx
 = 0;

298 
u¨t_idx
 = 0;

299 
i2c_idx
 = 0;

302 i‡(
öô_u¨t
 & 
IOP13XX_INIT_UART_1
) {

303 
	`PRINTK
("Adding uart1ÅoÖlatform deviceÜist\n");

304 
i›13xx_u¨t1
.
id
 = 
u¨t_idx
++;

305 
i›13xx_devi˚s
[
∂©_idx
++] = &
i›13xx_u¨t1
;

307 i‡(
öô_u¨t
 & 
IOP13XX_INIT_UART_0
) {

308 
	`PRINTK
("Adding uart0ÅoÖlatform deviceÜist\n");

309 
i›13xx_u¨t0
.
id
 = 
u¨t_idx
++;

310 
i›13xx_devi˚s
[
∂©_idx
++] = &
i›13xx_u¨t0
;

313 
i
 = 0; i < 
IQ81340_NUM_I2C
; i++) {

314 i‡((
öô_i2c
 & (1 << 
i
)Ë&& 
IOP13XX_SETUP_DEBUG
)

315 
	`¥ötk
("Addög i2c%dÅÿ∂©f‹m devi˚Üi°\n", 
i
);

316 
öô_i2c
 & (1 << 
i
)) {

317 
IOP13XX_INIT_I2C_0
:

318 
i›13xx_i2c_0_c⁄åﬁÀr
.
id
 = 
i2c_idx
++;

319 
i›13xx_devi˚s
[
∂©_idx
++] =

320 &
i›13xx_i2c_0_c⁄åﬁÀr
;

322 
IOP13XX_INIT_I2C_1
:

323 
i›13xx_i2c_1_c⁄åﬁÀr
.
id
 = 
i2c_idx
++;

324 
i›13xx_devi˚s
[
∂©_idx
++] =

325 &
i›13xx_i2c_1_c⁄åﬁÀr
;

327 
IOP13XX_INIT_I2C_2
:

328 
i›13xx_i2c_2_c⁄åﬁÀr
.
id
 = 
i2c_idx
++;

329 
i›13xx_devi˚s
[
∂©_idx
++] =

330 &
i›13xx_i2c_2_c⁄åﬁÀr
;

335 #ifde‡
CONFIG_MTD_PHYSMAP


336 
iq8134x_Êash_ªsour˚
.
íd
 = iq8134x_Êash_ªsour˚.
°¨t
 +

337 
	`iq8134x_¥obe_Êash_size
() - 1;

338 i‡(
iq8134x_Êash_ªsour˚
.
íd
 > iq8134x_Êash_ªsour˚.
°¨t
)

339 
i›13xx_devi˚s
[
∂©_idx
++] = &
iq8134x_Êash
;

341 
	`¥ötk
(
KERN_ERR
 "%s: FaûedÅÿ¥obêÊash size\n", 
__FUNCTION__
);

344 
	`∂©f‹m_add_devi˚s
(
i›13xx_devi˚s
, 
∂©_idx
);

345 
	}
}

347 
__öô
 
	$i›13xx_öô_u¨t_£tup
(*
°r
)

349 i‡(
°r
) {

350 *
°r
 != '\0') {

351 *
°r
) {

353 
öô_u¨t
 |
IOP13XX_INIT_UART_0
;

356 
öô_u¨t
 |
IOP13XX_INIT_UART_1
;

362 
	`PRINTK
("\"iop13xx_init_uart\" malformed"

363 "áàch¨a˘î: \'%c\'", *
°r
);

364 *(
°r
 + 1) = '\0';

365 
öô_u¨t
 = 
IOP13XX_INIT_UART_DEFAULT
;

367 
°r
++;

371 
	}
}

373 
__öô
 
	$i›13xx_öô_i2c_£tup
(*
°r
)

375 i‡(
°r
) {

376 *
°r
 != '\0') {

377 *
°r
) {

379 
öô_i2c
 |
IOP13XX_INIT_I2C_0
;

382 
öô_i2c
 |
IOP13XX_INIT_I2C_1
;

385 
öô_i2c
 |
IOP13XX_INIT_I2C_2
;

391 
	`PRINTK
("\"iop13xx_init_i2c\" malformed"

392 "áàch¨a˘î: \'%c\'", *
°r
);

393 *(
°r
 + 1) = '\0';

394 
öô_i2c
 = 
IOP13XX_INIT_I2C_DEFAULT
;

396 
°r
++;

400 
	}
}

402 
__£tup
("i›13xx_öô_u¨t", 
i›13xx_öô_u¨t_£tup
);

403 
__£tup
("i›13xx_öô_i2c", 
i›13xx_öô_i2c_£tup
);

	@arch/arm/mach-iop13xx/tpmi.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/dma-m≠pög.h
>

24 
	~<asm/io.h
>

25 
	~<asm/úq.h
>

26 
	~<asm/sizes.h
>

29 
	#IOP13XX_TPMI_MMR
(
dev
Ë
	`IOP13XX_REG_ADDR32_PHYS
(0x48000 + (dev << 12))

	)

30 
	#IOP13XX_TPMI_MEM
(
dev
Ë
	`IOP13XX_REG_ADDR32_PHYS
(0x60000 + (dev << 13))

	)

31 
	#IOP13XX_TPMI_CTRL
(
dev
Ë
	`IOP13XX_REG_ADDR32_PHYS
(0x50000 + (dev << 10))

	)

32 
	#IOP13XX_TPMI_MMR_SIZE
 (
SZ_4K
 - 1)

	)

33 
	#IOP13XX_TPMI_MEM_SIZE
 (255)

	)

34 
	#IOP13XX_TPMI_MEM_CTRL
 (
SZ_1K
 - 1)

	)

35 
	#IOP13XX_TPMI_RESOURCE_MMR
 0

	)

36 
	#IOP13XX_TPMI_RESOURCE_MEM
 1

	)

37 
	#IOP13XX_TPMI_RESOURCE_CTRL
 2

	)

38 
	#IOP13XX_TPMI_RESOURCE_IRQ
 3

	)

40 
ªsour˚
 
	gi›13xx_çmi_0_ªsour˚s
[] = {

41 [
IOP13XX_TPMI_RESOURCE_MMR
] = {

42 .
°¨t
 = 
IOP13XX_TPMI_MMR
(4),

43 .
	gíd
 = 
IOP13XX_TPMI_MMR
(4Ë+ 
IOP13XX_TPMI_MMR_SIZE
,

44 .
	gÊags
 = 
IORESOURCE_MEM
,

46 [
IOP13XX_TPMI_RESOURCE_MEM
] = {

47 .
°¨t
 = 
IOP13XX_TPMI_MEM
(0),

48 .
	gíd
 = 
IOP13XX_TPMI_MEM
(0Ë+ 
IOP13XX_TPMI_MEM_SIZE
,

49 .
	gÊags
 = 
IORESOURCE_MEM
,

51 [
IOP13XX_TPMI_RESOURCE_CTRL
] = {

52 .
°¨t
 = 
IOP13XX_TPMI_CTRL
(0),

53 .
	gíd
 = 
IOP13XX_TPMI_CTRL
(0Ë+ 
IOP13XX_TPMI_MEM_CTRL
,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

56 [
IOP13XX_TPMI_RESOURCE_IRQ
] = {

57 .
°¨t
 = 
IRQ_IOP13XX_TPMI0_OUT
,

58 .
	gíd
 = 
IRQ_IOP13XX_TPMI0_OUT
,

59 .
	gÊags
 = 
IORESOURCE_IRQ


63 
ªsour˚
 
	gi›13xx_çmi_1_ªsour˚s
[] = {

64 [
IOP13XX_TPMI_RESOURCE_MMR
] = {

65 .
°¨t
 = 
IOP13XX_TPMI_MMR
(1),

66 .
	gíd
 = 
IOP13XX_TPMI_MMR
(1Ë+ 
IOP13XX_TPMI_MMR_SIZE
,

67 .
	gÊags
 = 
IORESOURCE_MEM
,

69 [
IOP13XX_TPMI_RESOURCE_MEM
] = {

70 .
°¨t
 = 
IOP13XX_TPMI_MEM
(1),

71 .
	gíd
 = 
IOP13XX_TPMI_MEM
(1Ë+ 
IOP13XX_TPMI_MEM_SIZE
,

72 .
	gÊags
 = 
IORESOURCE_MEM
,

74 [
IOP13XX_TPMI_RESOURCE_CTRL
] = {

75 .
°¨t
 = 
IOP13XX_TPMI_CTRL
(1),

76 .
	gíd
 = 
IOP13XX_TPMI_CTRL
(1Ë+ 
IOP13XX_TPMI_MEM_CTRL
,

77 .
	gÊags
 = 
IORESOURCE_MEM
,

79 [
IOP13XX_TPMI_RESOURCE_IRQ
] = {

80 .
°¨t
 = 
IRQ_IOP13XX_TPMI1_OUT
,

81 .
	gíd
 = 
IRQ_IOP13XX_TPMI1_OUT
,

82 .
	gÊags
 = 
IORESOURCE_IRQ


86 
ªsour˚
 
	gi›13xx_çmi_2_ªsour˚s
[] = {

87 [
IOP13XX_TPMI_RESOURCE_MMR
] = {

88 .
°¨t
 = 
IOP13XX_TPMI_MMR
(2),

89 .
	gíd
 = 
IOP13XX_TPMI_MMR
(2Ë+ 
IOP13XX_TPMI_MMR_SIZE
,

90 .
	gÊags
 = 
IORESOURCE_MEM
,

92 [
IOP13XX_TPMI_RESOURCE_MEM
] = {

93 .
°¨t
 = 
IOP13XX_TPMI_MEM
(2),

94 .
	gíd
 = 
IOP13XX_TPMI_MEM
(2Ë+ 
IOP13XX_TPMI_MEM_SIZE
,

95 .
	gÊags
 = 
IORESOURCE_MEM
,

97 [
IOP13XX_TPMI_RESOURCE_CTRL
] = {

98 .
°¨t
 = 
IOP13XX_TPMI_CTRL
(2),

99 .
	gíd
 = 
IOP13XX_TPMI_CTRL
(2Ë+ 
IOP13XX_TPMI_MEM_CTRL
,

100 .
	gÊags
 = 
IORESOURCE_MEM
,

102 [
IOP13XX_TPMI_RESOURCE_IRQ
] = {

103 .
°¨t
 = 
IRQ_IOP13XX_TPMI2_OUT
,

104 .
	gíd
 = 
IRQ_IOP13XX_TPMI2_OUT
,

105 .
	gÊags
 = 
IORESOURCE_IRQ


109 
ªsour˚
 
	gi›13xx_çmi_3_ªsour˚s
[] = {

110 [
IOP13XX_TPMI_RESOURCE_MMR
] = {

111 .
°¨t
 = 
IOP13XX_TPMI_MMR
(3),

112 .
	gíd
 = 
IOP13XX_TPMI_MMR
(3Ë+ 
IOP13XX_TPMI_MMR_SIZE
,

113 .
	gÊags
 = 
IORESOURCE_MEM
,

115 [
IOP13XX_TPMI_RESOURCE_MEM
] = {

116 .
°¨t
 = 
IOP13XX_TPMI_MEM
(3),

117 .
	gíd
 = 
IOP13XX_TPMI_MEM
(3Ë+ 
IOP13XX_TPMI_MEM_SIZE
,

118 .
	gÊags
 = 
IORESOURCE_MEM
,

120 [
IOP13XX_TPMI_RESOURCE_CTRL
] = {

121 .
°¨t
 = 
IOP13XX_TPMI_CTRL
(3),

122 .
	gíd
 = 
IOP13XX_TPMI_CTRL
(3Ë+ 
IOP13XX_TPMI_MEM_CTRL
,

123 .
	gÊags
 = 
IORESOURCE_MEM
,

125 [
IOP13XX_TPMI_RESOURCE_IRQ
] = {

126 .
°¨t
 = 
IRQ_IOP13XX_TPMI3_OUT
,

127 .
	gíd
 = 
IRQ_IOP13XX_TPMI3_OUT
,

128 .
	gÊags
 = 
IORESOURCE_IRQ


132 
u64
 
	gi›13xx_çmi_mask
 = 
DMA_64BIT_MASK
;

133 
∂©f‹m_devi˚
 
	gi›13xx_çmi_0_devi˚
 = {

134 .
«me
 = "iop-tpmi",

135 .
	gid
 = 0,

136 .
	gnum_ªsour˚s
 = 4,

137 .
	gªsour˚
 = 
i›13xx_çmi_0_ªsour˚s
,

138 .
	gdev
 = {

139 .
dma_mask
 = &
i›13xx_çmi_mask
,

140 .
	gcohîít_dma_mask
 = 
DMA_64BIT_MASK
,

144 
∂©f‹m_devi˚
 
	gi›13xx_çmi_1_devi˚
 = {

145 .
«me
 = "iop-tpmi",

146 .
	gid
 = 1,

147 .
	gnum_ªsour˚s
 = 4,

148 .
	gªsour˚
 = 
i›13xx_çmi_1_ªsour˚s
,

149 .
	gdev
 = {

150 .
dma_mask
 = &
i›13xx_çmi_mask
,

151 .
	gcohîít_dma_mask
 = 
DMA_64BIT_MASK
,

155 
∂©f‹m_devi˚
 
	gi›13xx_çmi_2_devi˚
 = {

156 .
«me
 = "iop-tpmi",

157 .
	gid
 = 2,

158 .
	gnum_ªsour˚s
 = 4,

159 .
	gªsour˚
 = 
i›13xx_çmi_2_ªsour˚s
,

160 .
	gdev
 = {

161 .
dma_mask
 = &
i›13xx_çmi_mask
,

162 .
	gcohîít_dma_mask
 = 
DMA_64BIT_MASK
,

166 
∂©f‹m_devi˚
 
	gi›13xx_çmi_3_devi˚
 = {

167 .
«me
 = "iop-tpmi",

168 .
	gid
 = 3,

169 .
	gnum_ªsour˚s
 = 4,

170 .
	gªsour˚
 = 
i›13xx_çmi_3_ªsour˚s
,

171 .
	gdev
 = {

172 .
dma_mask
 = &
i›13xx_çmi_mask
,

173 .
	gcohîít_dma_mask
 = 
DMA_64BIT_MASK
,

177 
__öô
 
	$i›13xx_add_çmi_devi˚s
()

179 
devi˚_id
;

182 i‡(
	`__øw_ªadl
(
IOP13XX_ESSR0
Ë& 
IOP13XX_INTERFACE_SEL_PCIX
)

184 
devi˚_id
 = 
	`__øw_ªadw
(
IOP13XX_ATUE_DID
);

187 
devi˚_id
 = 
	`__øw_ªadw
(
IOP13XX_ATUX_DID
);

189 
devi˚_id
) {

225 
	`∂©f‹m_devi˚_ªgi°î
(&
i›13xx_çmi_0_devi˚
);

228 
	`∂©f‹m_devi˚_ªgi°î
(&
i›13xx_çmi_0_devi˚
);

229 
	`∂©f‹m_devi˚_ªgi°î
(&
i›13xx_çmi_1_devi˚
);

230 
	`∂©f‹m_devi˚_ªgi°î
(&
i›13xx_çmi_2_devi˚
);

231 
	`∂©f‹m_devi˚_ªgi°î
(&
i›13xx_çmi_3_devi˚
);

234 
	}
}

	@arch/arm/mach-iop32x/glantank.c

15 
	~<löux/mm.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/£rül_c‹e.h
>

22 
	~<löux/£rül_8250.h
>

23 
	~<löux/mtd/physm≠.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/¨ch.h
>

29 
	~<asm/mach/m≠.h
>

30 
	~<asm/mach/pci.h
>

31 
	~<asm/mach/time.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/∑ge.h
>

34 
	~<asm/¨ch/time.h
>

39 
__öô
 
	$gœ¡™k_timî_öô
()

42 
	`i›_öô_time
(200000000);

43 
	}
}

45 
sys_timî
 
	ggœ¡™k_timî
 = {

46 .
öô
 = 
gœ¡™k_timî_öô
,

47 .
	goff£t
 = 
i›_gëtimeoff£t
,

54 
m≠_desc
 
	ggœ¡™k_io_desc
[] 
	g__öôd©a
 = {

56 .
vútuÆ
 = 
GLANTANK_UART
,

57 .
	gp‚
 = 
__phys_to_p‚
(
GLANTANK_UART
),

58 .
	gÀngth
 = 0x00100000,

59 .
	gty≥
 = 
MT_DEVICE


63 
__öô
 
	$gœ¡™k_m≠_io
()

65 
	`i›3xx_m≠_io
();

66 
	`iŸabÀ_öô
(
gœ¡™k_io_desc
, 
	`ARRAY_SIZE
(glantank_io_desc));

67 
	}
}

73 
	#INTA
 
IRQ_IOP32X_XINT0


	)

74 
	#INTB
 
IRQ_IOP32X_XINT1


	)

75 
	#INTC
 
IRQ_IOP32X_XINT2


	)

76 
	#INTD
 
IRQ_IOP32X_XINT3


	)

78 
__öô


79 
	$gœ¡™k_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

81 
pci_úq_èbÀ
[][4] = {

86 {
INTD
, INTD, INTD, INTD},

87 {
INTA
, INTA, INTA, INTA},

88 {
INTB
, INTB, INTB, INTB},

89 {
INTC
, INTC, INTC, INTC},

92 
	`BUG_ON
(
pö
 < 1 ||Öin > 4);

94  
pci_úq_èbÀ
[
¶Ÿ
 % 4][
pö
 - 1];

95 
	}
}

97 
hw_pci
 
gœ¡™k_pci
 
	g__öôd©a
 = {

98 .
swizzÀ
 = 
pci_°d_swizzÀ
,

99 .
	gƒ_c⁄åﬁÀrs
 = 1,

100 .
	g£tup
 = 
i›3xx_pci_£tup
,

101 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

102 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

103 .
	gm≠_úq
 = 
gœ¡™k_pci_m≠_úq
,

106 
__öô
 
	$gœ¡™k_pci_öô
()

108 i‡(
	`machöe_is_gœ¡™k
())

109 
	`pci_comm⁄_öô
(&
gœ¡™k_pci
);

112 
	}
}

114 
subsys_öôˇŒ
(
gœ¡™k_pci_öô
);

120 
physm≠_Êash_d©a
 
	ggœ¡™k_Êash_d©a
 = {

121 .
width
 = 1,

124 
ªsour˚
 
	ggœ¡™k_Êash_ªsour˚
 = {

125 .
°¨t
 = 0xf0000000,

126 .
	gíd
 = 0xf007ffff,

127 .
	gÊags
 = 
IORESOURCE_MEM
,

130 
∂©f‹m_devi˚
 
	ggœ¡™k_Êash_devi˚
 = {

131 .
«me
 = "physmap-flash",

132 .
	gid
 = 0,

133 .
	gdev
 = {

134 .
∂©f‹m_d©a
 = &
gœ¡™k_Êash_d©a
,

136 .
	gnum_ªsour˚s
 = 1,

137 .
	gªsour˚
 = &
gœ¡™k_Êash_ªsour˚
,

140 
∂©_£rül8250_p‹t
 
	ggœ¡™k_£rül_p‹t
[] = {

142 .
m≠ba£
 = 
GLANTANK_UART
,

143 .
	gmemba£
 = (*)
GLANTANK_UART
,

144 .
	gúq
 = 
IRQ_IOP32X_XINT3
,

145 .
	gÊags
 = 
UPF_SKIP_TEST
,

146 .
	giŸy≥
 = 
UPIO_MEM
,

147 .
	gªgshi·
 = 0,

148 .
	gu¨t˛k
 = 1843200,

153 
ªsour˚
 
	ggœ¡™k_u¨t_ªsour˚
 = {

154 .
°¨t
 = 
GLANTANK_UART
,

155 .
	gíd
 = 
GLANTANK_UART
 + 7,

156 .
	gÊags
 = 
IORESOURCE_MEM
,

159 
∂©f‹m_devi˚
 
	ggœ¡™k_£rül_devi˚
 = {

160 .
«me
 = "serial8250",

161 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

162 .
	gdev
 = {

163 .
∂©f‹m_d©a
 = 
gœ¡™k_£rül_p‹t
,

165 .
	gnum_ªsour˚s
 = 1,

166 .
	gªsour˚
 = &
gœ¡™k_u¨t_ªsour˚
,

169 
	$gœ¡™k_powî_off
()

171 
	`__øw_wrôeb
(0x01, 0xfe8d0004);

175 
	}
}

177 
__öô
 
	$gœ¡™k_öô_machöe
()

179 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

180 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c1_devi˚
);

181 
	`∂©f‹m_devi˚_ªgi°î
(&
gœ¡™k_Êash_devi˚
);

182 
	`∂©f‹m_devi˚_ªgi°î
(&
gœ¡™k_£rül_devi˚
);

184 
pm_powî_off
 = 
gœ¡™k_powî_off
;

185 
	}
}

187 
MACHINE_START
(
GLANTANK
, "GLAN Tank")

189 .
	gphys_io
 = 
GLANTANK_UART
,

190 .
	gio_pg_off°
 = ((
GLANTANK_UART
) >> 18) & 0xfffc,

191 .
	gboŸ_∑øms
 = 0xa0000100,

192 .
	gm≠_io
 = 
gœ¡™k_m≠_io
,

193 .
	göô_úq
 = 
i›32x_öô_úq
,

194 .
	gtimî
 = &
gœ¡™k_timî
,

195 .
	göô_machöe
 = 
gœ¡™k_öô_machöe
,

196 
	gMACHINE_END


	@arch/arm/mach-iop32x/iq31244.c

17 
	~<löux/mm.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/dñay.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/pci.h
>

22 
	~<löux/pm.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/£rül_c‹e.h
>

26 
	~<löux/£rül_8250.h
>

27 
	~<löux/mtd/physm≠.h
>

28 
	~<löux/∂©f‹m_devi˚.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/io.h
>

31 
	~<asm/úq.h
>

32 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mach/m≠.h
>

34 
	~<asm/mach/pci.h
>

35 
	~<asm/mach/time.h
>

36 
	~<asm/mach-ty≥s.h
>

37 
	~<asm/∑ge.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/¨ch/time.h
>

48 
	gf‹˚_ï80219
;

50 
	$is_80219
()

52 
¥o˚ss‹_id
;

53  !!((
¥o˚ss‹_id
 & 0xffffffe0) == 0x69052e20);

54 
	}
}

56 
	$is_ï80219
()

58 i‡(
	`machöe_is_ï80219
(Ë|| 
f‹˚_ï80219
)

62 
	}
}

68 
__öô
 
	$iq31244_timî_öô
()

70 i‡(
	`is_ï80219
()) {

72 
	`i›_öô_time
(200000000);

75 
	`i›_öô_time
(198000000);

77 
	}
}

79 
sys_timî
 
	giq31244_timî
 = {

80 .
öô
 = 
iq31244_timî_öô
,

81 .
	goff£t
 = 
i›_gëtimeoff£t
,

88 
m≠_desc
 
	giq31244_io_desc
[] 
	g__öôd©a
 = {

90 .
vútuÆ
 = 
IQ31244_UART
,

91 .
	gp‚
 = 
__phys_to_p‚
(
IQ31244_UART
),

92 .
	gÀngth
 = 0x00100000,

93 .
	gty≥
 = 
MT_DEVICE
,

97 
__öô
 
	$iq31244_m≠_io
()

99 
	`i›3xx_m≠_io
();

100 
	`iŸabÀ_öô
(
iq31244_io_desc
, 
	`ARRAY_SIZE
(iq31244_io_desc));

101 
	}
}

107 
__öô


108 
	$ï80219_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

110 
úq
;

112 i‡(
¶Ÿ
 == 0) {

114 
úq
 = 
IRQ_IOP32X_XINT1
;

115 } i‡(
¶Ÿ
 == 1) {

117 
úq
 = 
IRQ_IOP32X_XINT0
;

118 } i‡(
¶Ÿ
 == 2) {

120 
úq
 = 
IRQ_IOP32X_XINT3
;

121 } i‡(
¶Ÿ
 == 3) {

123 
úq
 = 
IRQ_IOP32X_XINT2
;

125 
	`¥ötk
(
KERN_ERR
 "ep80219_pci_map_irq() called for unknown "

126 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

127 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

128 
úq
 = -1;

131  
úq
;

132 
	}
}

134 
hw_pci
 
ï80219_pci
 
	g__öôd©a
 = {

135 .
swizzÀ
 = 
pci_°d_swizzÀ
,

136 .
	gƒ_c⁄åﬁÀrs
 = 1,

137 .
	g£tup
 = 
i›3xx_pci_£tup
,

138 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

139 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

140 .
	gm≠_úq
 = 
ï80219_pci_m≠_úq
,

143 
__öô


144 
	$iq31244_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

146 
úq
;

148 i‡(
¶Ÿ
 == 0) {

150 
úq
 = 
IRQ_IOP32X_XINT1
;

151 } i‡(
¶Ÿ
 == 1) {

153 
úq
 = 
IRQ_IOP32X_XINT2
;

154 } i‡(
¶Ÿ
 == 2) {

156 
úq
 = 
IRQ_IOP32X_XINT3
;

157 } i‡(
¶Ÿ
 == 3) {

159 
úq
 = 
IRQ_IOP32X_XINT0
;

161 
	`¥ötk
(
KERN_ERR
 "iq31244_pci_map_irq called for unknown "

162 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

163 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

164 
úq
 = -1;

167  
úq
;

168 
	}
}

170 
hw_pci
 
iq31244_pci
 
	g__öôd©a
 = {

171 .
swizzÀ
 = 
pci_°d_swizzÀ
,

172 .
	gƒ_c⁄åﬁÀrs
 = 1,

173 .
	g£tup
 = 
i›3xx_pci_£tup
,

174 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

175 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

176 .
	gm≠_úq
 = 
iq31244_pci_m≠_úq
,

179 
__öô
 
	$iq31244_pci_öô
()

181 i‡(
	`is_ï80219
()) {

182 i‡(
	`i›3xx_gë_öô_©u
(Ë=
IOP3XX_INIT_ATU_ENABLE
)

183 
	`pci_comm⁄_öô
(&
ï80219_pci
);

184 } i‡(
	`machöe_is_iq31244
()) {

185 i‡(
	`is_80219
()) {

186 
	`¥ötk
("note: iq31244 boardÅype has been selected\n");

187 
	`¥ötk
("note:Åo selectÉp80219 operation:\n");

188 
	`¥ötk
("\t1/ specify \"force_ep80219\" onÅhe kernel"

190 
	`¥ötk
("\t2/ update bootÜoaderÅoÖass"

191 "Åhêï80219 id: %d\n", 
MACH_TYPE_EP80219
);

194 i‡(
	`i›3xx_gë_öô_©u
(Ë=
IOP3XX_INIT_ATU_ENABLE
)

195 
	`pci_comm⁄_öô
(&
iq31244_pci
);

199 
	}
}

201 
subsys_öôˇŒ
(
iq31244_pci_öô
);

207 
physm≠_Êash_d©a
 
	giq31244_Êash_d©a
 = {

208 .
width
 = 2,

211 
ªsour˚
 
	giq31244_Êash_ªsour˚
 = {

212 .
°¨t
 = 0xf0000000,

213 .
	gíd
 = 0xf07fffff,

214 .
	gÊags
 = 
IORESOURCE_MEM
,

217 
∂©f‹m_devi˚
 
	giq31244_Êash_devi˚
 = {

218 .
«me
 = "physmap-flash",

219 .
	gid
 = 0,

220 .
	gdev
 = {

221 .
∂©f‹m_d©a
 = &
iq31244_Êash_d©a
,

223 .
	gnum_ªsour˚s
 = 1,

224 .
	gªsour˚
 = &
iq31244_Êash_ªsour˚
,

227 
∂©_£rül8250_p‹t
 
	giq31244_£rül_p‹t
[] = {

229 .
m≠ba£
 = 
IQ31244_UART
,

230 .
	gmemba£
 = (*)
IQ31244_UART
,

231 .
	gúq
 = 
IRQ_IOP32X_XINT1
,

232 .
	gÊags
 = 
UPF_SKIP_TEST
,

233 .
	giŸy≥
 = 
UPIO_MEM
,

234 .
	gªgshi·
 = 0,

235 .
	gu¨t˛k
 = 1843200,

240 
ªsour˚
 
	giq31244_u¨t_ªsour˚
 = {

241 .
°¨t
 = 
IQ31244_UART
,

242 .
	gíd
 = 
IQ31244_UART
 + 7,

243 .
	gÊags
 = 
IORESOURCE_MEM
,

246 
∂©f‹m_devi˚
 
	giq31244_£rül_devi˚
 = {

247 .
«me
 = "serial8250",

248 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

249 .
	gdev
 = {

250 .
∂©f‹m_d©a
 = 
iq31244_£rül_p‹t
,

252 .
	gnum_ªsour˚s
 = 1,

253 .
	gªsour˚
 = &
iq31244_u¨t_ªsour˚
,

261 
	$ï80219_powî_off
()

266 *
IOP3XX_IDBR1
 = 0x60;

267 *
IOP3XX_ICR1
 = 0xE9;

268 
	`mdñay
(1);

273 *
IOP3XX_IDBR1
 = 0x0F;

274 *
IOP3XX_ICR1
 = 0xE8;

275 
	`mdñay
(1);

281 *
IOP3XX_IDBR1
 = 0x03;

282 *
IOP3XX_ICR1
 = 0xE8;

283 
	`mdñay
(1);

288 *
IOP3XX_IDBR1
 = 0x00;

289 *
IOP3XX_ICR1
 = 0xEA;

293 
	}
}

295 
__öô
 
	$iq31244_öô_machöe
()

297 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

298 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c1_devi˚
);

299 
	`∂©f‹m_devi˚_ªgi°î
(&
iq31244_Êash_devi˚
);

300 
	`∂©f‹m_devi˚_ªgi°î
(&
iq31244_£rül_devi˚
);

302 i‡(
	`is_ï80219
())

303 
pm_powî_off
 = 
ï80219_powî_off
;

304 
	}
}

306 
__öô
 
	$f‹˚_ï80219_£tup
(*
°r
)

308 
f‹˚_ï80219
 = 1;

310 
	}
}

312 
__£tup
("f‹˚_ï80219", 
f‹˚_ï80219_£tup
);

314 
MACHINE_START
(
IQ31244
, "Intel IQ31244")

316 .
	gphys_io
 = 
IQ31244_UART
,

317 .
	gio_pg_off°
 = ((
IQ31244_UART
) >> 18) & 0xfffc,

318 .
	gboŸ_∑øms
 = 0xa0000100,

319 .
	gm≠_io
 = 
iq31244_m≠_io
,

320 .
	göô_úq
 = 
i›32x_öô_úq
,

321 .
	gtimî
 = &
iq31244_timî
,

322 .
	göô_machöe
 = 
iq31244_öô_machöe
,

323 
MACHINE_END


330 
MACHINE_START
(
EP80219
, "Intel EP80219")

332 .
	gphys_io
 = 
IQ31244_UART
,

333 .
	gio_pg_off°
 = ((
IQ31244_UART
) >> 18) & 0xfffc,

334 .
	gboŸ_∑øms
 = 0xa0000100,

335 .
	gm≠_io
 = 
iq31244_m≠_io
,

336 .
	göô_úq
 = 
i›32x_öô_úq
,

337 .
	gtimî
 = &
iq31244_timî
,

338 .
	göô_machöe
 = 
iq31244_öô_machöe
,

339 
	gMACHINE_END


	@arch/arm/mach-iop32x/iq80321.c

16 
	~<löux/mm.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/pci.h
>

20 
	~<löux/°rög.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/£rül_c‹e.h
>

23 
	~<löux/£rül_8250.h
>

24 
	~<löux/mtd/physm≠.h
>

25 
	~<löux/∂©f‹m_devi˚.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/úq.h
>

29 
	~<asm/mach/¨ch.h
>

30 
	~<asm/mach/m≠.h
>

31 
	~<asm/mach/pci.h
>

32 
	~<asm/mach/time.h
>

33 
	~<asm/mach-ty≥s.h
>

34 
	~<asm/∑ge.h
>

35 
	~<asm/pgèbÀ.h
>

36 
	~<asm/¨ch/time.h
>

41 
__öô
 
	$iq80321_timî_öô
()

44 
	`i›_öô_time
(200000000);

45 
	}
}

47 
sys_timî
 
	giq80321_timî
 = {

48 .
öô
 = 
iq80321_timî_öô
,

49 .
	goff£t
 = 
i›_gëtimeoff£t
,

56 
m≠_desc
 
	giq80321_io_desc
[] 
	g__öôd©a
 = {

58 .
vútuÆ
 = 
IQ80321_UART
,

59 .
	gp‚
 = 
__phys_to_p‚
(
IQ80321_UART
),

60 .
	gÀngth
 = 0x00100000,

61 .
	gty≥
 = 
MT_DEVICE
,

65 
__öô
 
	$iq80321_m≠_io
()

67 
	`i›3xx_m≠_io
();

68 
	`iŸabÀ_öô
(
iq80321_io_desc
, 
	`ARRAY_SIZE
(iq80321_io_desc));

69 
	}
}

75 
__öô


76 
	$iq80321_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

78 
úq
;

80 i‡((
¶Ÿ
 =2 || slŸ =6Ë&& 
pö
 == 1) {

82 
úq
 = 
IRQ_IOP32X_XINT2
;

83 } i‡((
¶Ÿ
 =2 || slŸ =6Ë&& 
pö
 == 2) {

85 
úq
 = 
IRQ_IOP32X_XINT3
;

86 } i‡((
¶Ÿ
 =2 || slŸ =6Ë&& 
pö
 == 3) {

88 
úq
 = 
IRQ_IOP32X_XINT0
;

89 } i‡((
¶Ÿ
 =2 || slŸ =6Ë&& 
pö
 == 4) {

91 
úq
 = 
IRQ_IOP32X_XINT1
;

92 } i‡(
¶Ÿ
 == 4 || slot == 8) {

94 
úq
 = 
IRQ_IOP32X_XINT0
;

96 
	`¥ötk
(
KERN_ERR
 "iq80321_pci_map_irq() called for unknown "

97 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

98 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

99 
úq
 = -1;

102  
úq
;

103 
	}
}

105 
hw_pci
 
iq80321_pci
 
	g__öôd©a
 = {

106 .
swizzÀ
 = 
pci_°d_swizzÀ
,

107 .
	gƒ_c⁄åﬁÀrs
 = 1,

108 .
	g£tup
 = 
i›3xx_pci_£tup
,

109 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

110 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

111 .
	gm≠_úq
 = 
iq80321_pci_m≠_úq
,

114 
__öô
 
	$iq80321_pci_öô
()

116 i‡((
	`i›3xx_gë_öô_©u
(Ë=
IOP3XX_INIT_ATU_ENABLE
) &&

117 
	`machöe_is_iq80321
())

118 
	`pci_comm⁄_öô
(&
iq80321_pci
);

121 
	}
}

123 
subsys_öôˇŒ
(
iq80321_pci_öô
);

129 
physm≠_Êash_d©a
 
	giq80321_Êash_d©a
 = {

130 .
width
 = 1,

133 
ªsour˚
 
	giq80321_Êash_ªsour˚
 = {

134 .
°¨t
 = 0xf0000000,

135 .
	gíd
 = 0xf07fffff,

136 .
	gÊags
 = 
IORESOURCE_MEM
,

139 
∂©f‹m_devi˚
 
	giq80321_Êash_devi˚
 = {

140 .
«me
 = "physmap-flash",

141 .
	gid
 = 0,

142 .
	gdev
 = {

143 .
∂©f‹m_d©a
 = &
iq80321_Êash_d©a
,

145 .
	gnum_ªsour˚s
 = 1,

146 .
	gªsour˚
 = &
iq80321_Êash_ªsour˚
,

149 
∂©_£rül8250_p‹t
 
	giq80321_£rül_p‹t
[] = {

151 .
m≠ba£
 = 
IQ80321_UART
,

152 .
	gmemba£
 = (*)
IQ80321_UART
,

153 .
	gúq
 = 
IRQ_IOP32X_XINT1
,

154 .
	gÊags
 = 
UPF_SKIP_TEST
,

155 .
	giŸy≥
 = 
UPIO_MEM
,

156 .
	gªgshi·
 = 0,

157 .
	gu¨t˛k
 = 1843200,

162 
ªsour˚
 
	giq80321_u¨t_ªsour˚
 = {

163 .
°¨t
 = 
IQ80321_UART
,

164 .
	gíd
 = 
IQ80321_UART
 + 7,

165 .
	gÊags
 = 
IORESOURCE_MEM
,

168 
∂©f‹m_devi˚
 
	giq80321_£rül_devi˚
 = {

169 .
«me
 = "serial8250",

170 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

171 .
	gdev
 = {

172 .
∂©f‹m_d©a
 = 
iq80321_£rül_p‹t
,

174 .
	gnum_ªsour˚s
 = 1,

175 .
	gªsour˚
 = &
iq80321_u¨t_ªsour˚
,

178 
__öô
 
	$iq80321_öô_machöe
()

180 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

181 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c1_devi˚
);

182 
	`∂©f‹m_devi˚_ªgi°î
(&
iq80321_Êash_devi˚
);

183 
	`∂©f‹m_devi˚_ªgi°î
(&
iq80321_£rül_devi˚
);

184 
	}
}

186 
MACHINE_START
(
IQ80321
, "Intel IQ80321")

188 .
	gphys_io
 = 
IQ80321_UART
,

189 .
	gio_pg_off°
 = ((
IQ80321_UART
) >> 18) & 0xfffc,

190 .
	gboŸ_∑øms
 = 0xa0000100,

191 .
	gm≠_io
 = 
iq80321_m≠_io
,

192 .
	göô_úq
 = 
i›32x_öô_úq
,

193 .
	gtimî
 = &
iq80321_timî
,

194 .
	göô_machöe
 = 
iq80321_öô_machöe
,

195 
	gMACHINE_END


	@arch/arm/mach-iop32x/irq.c

14 
	~<löux/öô.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<löux/li°.h
>

17 
	~<asm/mach/úq.h
>

18 
	~<asm/úq.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/mach-ty≥s.h
>

22 
u32
 
	gi›32x_mask
;

24 
	$öt˘l_wrôe
(
u32
 
vÆ
)

26 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c0, c0, 0" : : "r" (
vÆ
));

27 
	}
}

29 
	$öt°r_wrôe
(
u32
 
vÆ
)

31 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c4, c0, 0" : : "r" (
vÆ
));

32 
	}
}

35 
	$i›32x_úq_mask
(
úq
)

37 
i›32x_mask
 &~(1 << 
úq
);

38 
	`öt˘l_wrôe
(
i›32x_mask
);

39 
	}
}

42 
	$i›32x_úq_unmask
(
úq
)

44 
i›32x_mask
 |1 << 
úq
;

45 
	`öt˘l_wrôe
(
i›32x_mask
);

46 
	}
}

48 
úq_chù
 
	gext_chù
 = {

49 .
«me
 = "IOP32x",

50 .
	gack
 = 
i›32x_úq_mask
,

51 .
	gmask
 = 
i›32x_úq_mask
,

52 .
	gunmask
 = 
i›32x_úq_unmask
,

55 
__öô
 
	$i›32x_öô_úq
()

57 
i
;

59 
	`i›_öô_˝6_h™dÀr
();

61 
	`öt˘l_wrôe
(0);

62 
	`öt°r_wrôe
(0);

63 i‡(
	`machöe_is_gœ¡™k
() ||

64 
	`machöe_is_iq80321
() ||

65 
	`machöe_is_iq31244
() ||

66 
	`machöe_is_n2100
())

67 *
IOP3XX_PCIIRSR
 = 0x0f;

69 
i
 = 0; i < 
NR_IRQS
; i++) {

70 
	`£t_úq_chù
(
i
, &
ext_chù
);

71 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

72 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

74 
	}
}

	@arch/arm/mach-iop32x/n2100.c

17 
	~<löux/mm.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/dñay.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/pci.h
>

22 
	~<löux/pm.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/¶ab.h
>

25 
	~<löux/£rül_c‹e.h
>

26 
	~<löux/£rül_8250.h
>

27 
	~<löux/mtd/physm≠.h
>

28 
	~<löux/∂©f‹m_devi˚.h
>

29 
	~<löux/ªboŸ.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/io.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/pci.h
>

36 
	~<asm/mach/time.h
>

37 
	~<asm/mach-ty≥s.h
>

38 
	~<asm/∑ge.h
>

39 
	~<asm/pgèbÀ.h
>

40 
	~<asm/¨ch/time.h
>

45 
__öô
 
	$n2100_timî_öô
()

48 
	`i›_öô_time
(198000000);

49 
	}
}

51 
sys_timî
 
	gn2100_timî
 = {

52 .
öô
 = 
n2100_timî_öô
,

53 .
	goff£t
 = 
i›_gëtimeoff£t
,

60 
m≠_desc
 
	gn2100_io_desc
[] 
	g__öôd©a
 = {

62 .
vútuÆ
 = 
N2100_UART
,

63 .
	gp‚
 = 
__phys_to_p‚
(
N2100_UART
),

64 .
	gÀngth
 = 0x00100000,

65 .
	gty≥
 = 
MT_DEVICE


69 
__öô
 
	$n2100_m≠_io
()

71 
	`i›3xx_m≠_io
();

72 
	`iŸabÀ_öô
(
n2100_io_desc
, 
	`ARRAY_SIZE
(n2100_io_desc));

73 
	}
}

79 
__öô


80 
	$n2100_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

82 
úq
;

84 i‡(
	`PCI_SLOT
(
dev
->
dev‚
) == 1) {

86 
úq
 = 
IRQ_IOP32X_XINT0
;

87 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
) == 2) {

89 
úq
 = 
IRQ_IOP32X_XINT3
;

90 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
) == 3) {

92 
úq
 = 
IRQ_IOP32X_XINT2
;

93 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
Ë=4 && 
pö
 == 1) {

95 
úq
 = 
IRQ_IOP32X_XINT1
;

96 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
Ë=4 && 
pö
 == 2) {

98 
úq
 = 
IRQ_IOP32X_XINT0
;

99 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
Ë=4 && 
pö
 == 3) {

101 
úq
 = 
IRQ_IOP32X_XINT2
;

102 } i‡(
	`PCI_SLOT
(
dev
->
dev‚
) == 5) {

104 
úq
 = 
IRQ_IOP32X_XINT3
;

106 
	`¥ötk
(
KERN_ERR
 "n2100_pci_map_irq() called for unknown "

107 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

108 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

109 
úq
 = -1;

112  
úq
;

113 
	}
}

115 
hw_pci
 
n2100_pci
 
	g__öôd©a
 = {

116 .
swizzÀ
 = 
pci_°d_swizzÀ
,

117 .
	gƒ_c⁄åﬁÀrs
 = 1,

118 .
	g£tup
 = 
i›3xx_pci_£tup
,

119 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

120 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

121 .
	gm≠_úq
 = 
n2100_pci_m≠_úq
,

129 
	$n2100_fixup_r8169
(
pci_dev
 *
dev
)

131 i‡(
dev
->
bus
->
numbî
 == 0 &&

132 (
dev
->
dev‚
 =
	`PCI_DEVFN
(1, 0) ||

133 
dev
->
dev‚
 =
	`PCI_DEVFN
(2, 0)))

134 
dev
->
brokí_∑rôy_°©us
 = 1;

135 
	}
}

136 
DECLARE_PCI_FIXUP_FINAL
(
PCI_VENDOR_ID_REALTEK
, 
PCI_ANY_ID
, 
n2100_fixup_r8169
);

138 
__öô
 
	$n2100_pci_öô
()

140 i‡(
	`machöe_is_n2100
())

141 
	`pci_comm⁄_öô
(&
n2100_pci
);

144 
	}
}

146 
subsys_öôˇŒ
(
n2100_pci_öô
);

152 
physm≠_Êash_d©a
 
	gn2100_Êash_d©a
 = {

153 .
width
 = 2,

156 
ªsour˚
 
	gn2100_Êash_ªsour˚
 = {

157 .
°¨t
 = 0xf0000000,

158 .
	gíd
 = 0xf0ffffff,

159 .
	gÊags
 = 
IORESOURCE_MEM
,

162 
∂©f‹m_devi˚
 
	gn2100_Êash_devi˚
 = {

163 .
«me
 = "physmap-flash",

164 .
	gid
 = 0,

165 .
	gdev
 = {

166 .
∂©f‹m_d©a
 = &
n2100_Êash_d©a
,

168 .
	gnum_ªsour˚s
 = 1,

169 .
	gªsour˚
 = &
n2100_Êash_ªsour˚
,

173 
∂©_£rül8250_p‹t
 
	gn2100_£rül_p‹t
[] = {

175 .
m≠ba£
 = 
N2100_UART
,

176 .
	gmemba£
 = (*)
N2100_UART
,

177 .
	gúq
 = 0,

178 .
	gÊags
 = 
UPF_SKIP_TEST
,

179 .
	giŸy≥
 = 
UPIO_MEM
,

180 .
	gªgshi·
 = 0,

181 .
	gu¨t˛k
 = 1843200,

186 
ªsour˚
 
	gn2100_u¨t_ªsour˚
 = {

187 .
°¨t
 = 
N2100_UART
,

188 .
	gíd
 = 
N2100_UART
 + 7,

189 .
	gÊags
 = 
IORESOURCE_MEM
,

192 
∂©f‹m_devi˚
 
	gn2100_£rül_devi˚
 = {

193 .
«me
 = "serial8250",

194 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

195 .
	gdev
 = {

196 .
∂©f‹m_d©a
 = 
n2100_£rül_p‹t
,

198 .
	gnum_ªsour˚s
 = 1,

199 .
	gªsour˚
 = &
n2100_u¨t_ªsour˚
,

206 
	$n2100_powî_off
()

208 
	`loˇl_úq_dißbÀ
();

211 *
IOP3XX_IDBR0
 = 0xc0;

212 *
IOP3XX_ICR0
 = 0xe9;

213 
	`mdñay
(1);

216 *
IOP3XX_IDBR0
 = 0x08;

217 *
IOP3XX_ICR0
 = 0xe8;

218 
	`mdñay
(1);

221 *
IOP3XX_IDBR0
 = 0x01;

222 *
IOP3XX_ICR0
 = 0xea;

226 
	}
}

229 
timî_li°
 
	gpowî_buâ⁄_pﬁl_timî
;

231 
	$powî_buâ⁄_pﬁl
(
dummy
)

233 i‡(
	`gpio_löe_gë
(
N2100_POWER_BUTTON
) == 0) {

234 
	`˘æ_Æt_dñ
();

238 
powî_buâ⁄_pﬁl_timî
.
expúes
 = 
jiffõs
 + (
HZ
 / 10);

239 
	`add_timî
(&
powî_buâ⁄_pﬁl_timî
);

240 
	}
}

243 
__öô
 
	$n2100_öô_machöe
()

245 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

246 
	`∂©f‹m_devi˚_ªgi°î
(&
n2100_Êash_devi˚
);

247 
	`∂©f‹m_devi˚_ªgi°î
(&
n2100_£rül_devi˚
);

249 
pm_powî_off
 = 
n2100_powî_off
;

251 
	`öô_timî
(&
powî_buâ⁄_pﬁl_timî
);

252 
powî_buâ⁄_pﬁl_timî
.
fun˘i⁄
 = 
powî_buâ⁄_pﬁl
;

253 
powî_buâ⁄_pﬁl_timî
.
expúes
 = 
jiffõs
 + (
HZ
 / 10);

254 
	`add_timî
(&
powî_buâ⁄_pﬁl_timî
);

255 
	}
}

257 
MACHINE_START
(
N2100
, "Thecus N2100")

259 .
	gphys_io
 = 
N2100_UART
,

260 .
	gio_pg_off°
 = ((
N2100_UART
) >> 18) & 0xfffc,

261 .
	gboŸ_∑øms
 = 0xa0000100,

262 .
	gm≠_io
 = 
n2100_m≠_io
,

263 .
	göô_úq
 = 
i›32x_öô_úq
,

264 .
	gtimî
 = &
n2100_timî
,

265 .
	göô_machöe
 = 
n2100_öô_machöe
,

266 
	gMACHINE_END


	@arch/arm/mach-iop33x/iq80331.c

15 
	~<löux/mm.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/£rül_c‹e.h
>

22 
	~<löux/£rül_8250.h
>

23 
	~<löux/mtd/physm≠.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/¨ch.h
>

29 
	~<asm/mach/m≠.h
>

30 
	~<asm/mach/pci.h
>

31 
	~<asm/mach/time.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/∑ge.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/¨ch/time.h
>

40 
__öô
 
	$iq80331_timî_öô
()

43 i‡(*
IOP3XX_ATURID
 >= 0xa)

44 
	`i›_öô_time
(333000000);

46 
	`i›_öô_time
(266000000);

47 
	}
}

49 
sys_timî
 
	giq80331_timî
 = {

50 .
öô
 = 
iq80331_timî_öô
,

51 .
	goff£t
 = 
i›_gëtimeoff£t
,

58 
__öô


59 
	$iq80331_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

61 
úq
;

63 i‡(
¶Ÿ
 =1 && 
pö
 == 1) {

65 
úq
 = 
IRQ_IOP33X_XINT1
;

66 } i‡(
¶Ÿ
 =1 && 
pö
 == 2) {

68 
úq
 = 
IRQ_IOP33X_XINT2
;

69 } i‡(
¶Ÿ
 =1 && 
pö
 == 3) {

71 
úq
 = 
IRQ_IOP33X_XINT3
;

72 } i‡(
¶Ÿ
 =1 && 
pö
 == 4) {

74 
úq
 = 
IRQ_IOP33X_XINT0
;

75 } i‡(
¶Ÿ
 == 2) {

77 
úq
 = 
IRQ_IOP33X_XINT2
;

79 
	`¥ötk
(
KERN_ERR
 "iq80331_pci_map_irq() called for unknown "

80 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

81 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

82 
úq
 = -1;

85  
úq
;

86 
	}
}

88 
hw_pci
 
iq80331_pci
 
	g__öôd©a
 = {

89 .
swizzÀ
 = 
pci_°d_swizzÀ
,

90 .
	gƒ_c⁄åﬁÀrs
 = 1,

91 .
	g£tup
 = 
i›3xx_pci_£tup
,

92 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

93 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

94 .
	gm≠_úq
 = 
iq80331_pci_m≠_úq
,

97 
__öô
 
	$iq80331_pci_öô
()

99 i‡((
	`i›3xx_gë_öô_©u
(Ë=
IOP3XX_INIT_ATU_ENABLE
) &&

100 
	`machöe_is_iq80331
())

101 
	`pci_comm⁄_öô
(&
iq80331_pci
);

104 
	}
}

106 
subsys_öôˇŒ
(
iq80331_pci_öô
);

112 
physm≠_Êash_d©a
 
	giq80331_Êash_d©a
 = {

113 .
width
 = 1,

116 
ªsour˚
 
	giq80331_Êash_ªsour˚
 = {

117 .
°¨t
 = 0xc0000000,

118 .
	gíd
 = 0xc07fffff,

119 .
	gÊags
 = 
IORESOURCE_MEM
,

122 
∂©f‹m_devi˚
 
	giq80331_Êash_devi˚
 = {

123 .
«me
 = "physmap-flash",

124 .
	gid
 = 0,

125 .
	gdev
 = {

126 .
∂©f‹m_d©a
 = &
iq80331_Êash_d©a
,

128 .
	gnum_ªsour˚s
 = 1,

129 .
	gªsour˚
 = &
iq80331_Êash_ªsour˚
,

132 
__öô
 
	$iq80331_öô_machöe
()

134 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

135 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c1_devi˚
);

136 
	`∂©f‹m_devi˚_ªgi°î
(&
i›33x_u¨t0_devi˚
);

137 
	`∂©f‹m_devi˚_ªgi°î
(&
i›33x_u¨t1_devi˚
);

138 
	`∂©f‹m_devi˚_ªgi°î
(&
iq80331_Êash_devi˚
);

139 
	}
}

141 
MACHINE_START
(
IQ80331
, "Intel IQ80331")

143 .
	gphys_io
 = 0xfefff000,

144 .
	gio_pg_off°
 = ((0xfffff000) >> 18) & 0xfffc,

145 .
	gboŸ_∑øms
 = 0x00000100,

146 .
	gm≠_io
 = 
i›3xx_m≠_io
,

147 .
	göô_úq
 = 
i›33x_öô_úq
,

148 .
	gtimî
 = &
iq80331_timî
,

149 .
	göô_machöe
 = 
iq80331_öô_machöe
,

150 
	gMACHINE_END


	@arch/arm/mach-iop33x/iq80332.c

15 
	~<löux/mm.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/£rül_c‹e.h
>

22 
	~<löux/£rül_8250.h
>

23 
	~<löux/mtd/physm≠.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/¨ch.h
>

29 
	~<asm/mach/m≠.h
>

30 
	~<asm/mach/pci.h
>

31 
	~<asm/mach/time.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/∑ge.h
>

34 
	~<asm/pgèbÀ.h
>

35 
	~<asm/¨ch/time.h
>

40 
__öô
 
	$iq80332_timî_öô
()

43 i‡(*
IOP3XX_ATURID
 >0x®|| *
IOP3XX_ATUDID
 == 0x374)

44 
	`i›_öô_time
(333000000);

46 
	`i›_öô_time
(266000000);

47 
	}
}

49 
sys_timî
 
	giq80332_timî
 = {

50 .
öô
 = 
iq80332_timî_öô
,

51 .
	goff£t
 = 
i›_gëtimeoff£t
,

58 
__öô


59 
	$iq80332_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

61 
úq
;

63 i‡(
¶Ÿ
 =4 && 
pö
 == 1) {

65 
úq
 = 
IRQ_IOP33X_XINT0
;

66 } i‡(
¶Ÿ
 =4 && 
pö
 == 2) {

68 
úq
 = 
IRQ_IOP33X_XINT1
;

69 } i‡(
¶Ÿ
 =4 && 
pö
 == 3) {

71 
úq
 = 
IRQ_IOP33X_XINT2
;

72 } i‡(
¶Ÿ
 =4 && 
pö
 == 4) {

74 
úq
 = 
IRQ_IOP33X_XINT3
;

75 } i‡(
¶Ÿ
 == 6) {

77 
úq
 = 
IRQ_IOP33X_XINT2
;

79 
	`¥ötk
(
KERN_ERR
 "iq80332_pci_map_irq() called for unknown "

80 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

81 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

82 
úq
 = -1;

85  
úq
;

86 
	}
}

88 
hw_pci
 
iq80332_pci
 
	g__öôd©a
 = {

89 .
swizzÀ
 = 
pci_°d_swizzÀ
,

90 .
	gƒ_c⁄åﬁÀrs
 = 1,

91 .
	g£tup
 = 
i›3xx_pci_£tup
,

92 .
	g¥eöô
 = 
i›3xx_pci_¥eöô
,

93 .
	gsˇn
 = 
i›3xx_pci_sˇn_bus
,

94 .
	gm≠_úq
 = 
iq80332_pci_m≠_úq
,

97 
__öô
 
	$iq80332_pci_öô
()

99 i‡((
	`i›3xx_gë_öô_©u
(Ë=
IOP3XX_INIT_ATU_ENABLE
) &&

100 
	`machöe_is_iq80332
())

101 
	`pci_comm⁄_öô
(&
iq80332_pci
);

104 
	}
}

106 
subsys_öôˇŒ
(
iq80332_pci_öô
);

112 
physm≠_Êash_d©a
 
	giq80332_Êash_d©a
 = {

113 .
width
 = 1,

116 
ªsour˚
 
	giq80332_Êash_ªsour˚
 = {

117 .
°¨t
 = 0xc0000000,

118 .
	gíd
 = 0xc07fffff,

119 .
	gÊags
 = 
IORESOURCE_MEM
,

122 
∂©f‹m_devi˚
 
	giq80332_Êash_devi˚
 = {

123 .
«me
 = "physmap-flash",

124 .
	gid
 = 0,

125 .
	gdev
 = {

126 .
∂©f‹m_d©a
 = &
iq80332_Êash_d©a
,

128 .
	gnum_ªsour˚s
 = 1,

129 .
	gªsour˚
 = &
iq80332_Êash_ªsour˚
,

132 
__öô
 
	$iq80332_öô_machöe
()

134 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c0_devi˚
);

135 
	`∂©f‹m_devi˚_ªgi°î
(&
i›3xx_i2c1_devi˚
);

136 
	`∂©f‹m_devi˚_ªgi°î
(&
i›33x_u¨t0_devi˚
);

137 
	`∂©f‹m_devi˚_ªgi°î
(&
i›33x_u¨t1_devi˚
);

138 
	`∂©f‹m_devi˚_ªgi°î
(&
iq80332_Êash_devi˚
);

139 
	}
}

141 
MACHINE_START
(
IQ80332
, "Intel IQ80332")

143 .
	gphys_io
 = 0xfefff000,

144 .
	gio_pg_off°
 = ((0xfffff000) >> 18) & 0xfffc,

145 .
	gboŸ_∑øms
 = 0x00000100,

146 .
	gm≠_io
 = 
i›3xx_m≠_io
,

147 .
	göô_úq
 = 
i›33x_öô_úq
,

148 .
	gtimî
 = &
iq80332_timî
,

149 .
	göô_machöe
 = 
iq80332_öô_machöe
,

150 
	gMACHINE_END


	@arch/arm/mach-iop33x/irq.c

14 
	~<löux/öô.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<löux/li°.h
>

17 
	~<asm/mach/úq.h
>

18 
	~<asm/úq.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/mach-ty≥s.h
>

22 
u32
 
	gi›33x_mask0
;

23 
u32
 
	gi›33x_mask1
;

25 
	$öt˘l0_wrôe
(
u32
 
vÆ
)

27 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c0, c0, 0" : : "r" (
vÆ
));

28 
	}
}

30 
	$öt˘l1_wrôe
(
u32
 
vÆ
)

32 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c1, c0, 0" : : "r" (
vÆ
));

33 
	}
}

35 
	$öt°r0_wrôe
(
u32
 
vÆ
)

37 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c2, c0, 0" : : "r" (
vÆ
));

38 
	}
}

40 
	$öt°r1_wrôe
(
u32
 
vÆ
)

42 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c3, c0, 0" : : "r" (
vÆ
));

43 
	}
}

45 
	$ötba£_wrôe
(
u32
 
vÆ
)

47 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c12, c0, 0" : : "r" (
vÆ
));

48 
	}
}

50 
	$ötsize_wrôe
(
u32
 
vÆ
)

52 
asm
 vﬁ©ûe("m¸Ö6, 0, %0, c13, c0, 0" : : "r" (
vÆ
));

53 
	}
}

56 
	$i›33x_úq_mask1
 (
úq
)

58 
i›33x_mask0
 &~(1 << 
úq
);

59 
	`öt˘l0_wrôe
(
i›33x_mask0
);

60 
	}
}

63 
	$i›33x_úq_mask2
 (
úq
)

65 
i›33x_mask1
 &~(1 << (
úq
 - 32));

66 
	`öt˘l1_wrôe
(
i›33x_mask1
);

67 
	}
}

70 
	$i›33x_úq_unmask1
(
úq
)

72 
i›33x_mask0
 |1 << 
úq
;

73 
	`öt˘l0_wrôe
(
i›33x_mask0
);

74 
	}
}

77 
	$i›33x_úq_unmask2
(
úq
)

79 
i›33x_mask1
 |(1 << (
úq
 - 32));

80 
	`öt˘l1_wrôe
(
i›33x_mask1
);

81 
	}
}

83 
úq_chù
 
	gi›33x_úqchù1
 = {

84 .
«me
 = "IOP33x-1",

85 .
	gack
 = 
i›33x_úq_mask1
,

86 .
	gmask
 = 
i›33x_úq_mask1
,

87 .
	gunmask
 = 
i›33x_úq_unmask1
,

90 
úq_chù
 
	gi›33x_úqchù2
 = {

91 .
«me
 = "IOP33x-2",

92 .
	gack
 = 
i›33x_úq_mask2
,

93 .
	gmask
 = 
i›33x_úq_mask2
,

94 .
	gunmask
 = 
i›33x_úq_unmask2
,

97 
__öô
 
	$i›33x_öô_úq
()

99 
i
;

101 
	`i›_öô_˝6_h™dÀr
();

103 
	`öt˘l0_wrôe
(0);

104 
	`öt˘l1_wrôe
(0);

105 
	`öt°r0_wrôe
(0);

106 
	`öt°r1_wrôe
(0);

107 
	`ötba£_wrôe
(0);

108 
	`ötsize_wrôe
(1);

109 i‡(
	`machöe_is_iq80331
())

110 *
IOP3XX_PCIIRSR
 = 0x0f;

112 
i
 = 0; i < 
NR_IRQS
; i++) {

113 
	`£t_úq_chù
(
i
, (ò< 32Ë? &
i›33x_úqchù1
 : &
i›33x_úqchù2
);

114 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

115 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
 | 
IRQF_PROBE
);

117 
	}
}

	@arch/arm/mach-iop33x/uart.c

12 
	~<löux/mm.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/maj‹.h
>

15 
	~<löux/fs.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<löux/£rül.h
>

18 
	~<löux/ây.h
>

19 
	~<löux/£rül_8250.h
>

20 
	~<asm/io.h
>

21 
	~<asm/pgèbÀ.h
>

22 
	~<asm/∑ge.h
>

23 
	~<asm/mach/m≠.h
>

24 
	~<asm/£tup.h
>

25 
	~<asm/sy°em.h
>

26 
	~<asm/mem‹y.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/h¨dw¨e/i›3xx.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/mach/¨ch.h
>

32 
	#IOP33X_UART_XTAL
 33334000

	)

34 
∂©_£rül8250_p‹t
 
	gi›33x_u¨t0_d©a
[] = {

36 .
memba£
 = (*)
IOP33X_UART0_VIRT
,

37 .
	gm≠ba£
 = 
IOP33X_UART0_PHYS
,

38 .
	gúq
 = 
IRQ_IOP33X_UART0
,

39 .
	gu¨t˛k
 = 
IOP33X_UART_XTAL
,

40 .
	gªgshi·
 = 2,

41 .
	giŸy≥
 = 
UPIO_MEM
,

42 .
	gÊags
 = 
UPF_SKIP_TEST
,

47 
ªsour˚
 
	gi›33x_u¨t0_ªsour˚s
[] = {

49 .
°¨t
 = 
IOP33X_UART0_PHYS
,

50 .
	gíd
 = 
IOP33X_UART0_PHYS
 + 0x3f,

51 .
	gÊags
 = 
IORESOURCE_MEM
,

54 .
°¨t
 = 
IRQ_IOP33X_UART0
,

55 .
	gíd
 = 
IRQ_IOP33X_UART0
,

56 .
	gÊags
 = 
IORESOURCE_IRQ
,

60 
∂©f‹m_devi˚
 
	gi›33x_u¨t0_devi˚
 = {

61 .
«me
 = "serial8250",

62 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

63 .
	gdev
 = {

64 .
∂©f‹m_d©a
 = 
i›33x_u¨t0_d©a
,

66 .
	gnum_ªsour˚s
 = 2,

67 .
	gªsour˚
 = 
i›33x_u¨t0_ªsour˚s
,

71 
ªsour˚
 
	gi›33x_u¨t1_ªsour˚s
[] = {

73 .
°¨t
 = 
IOP33X_UART1_PHYS
,

74 .
	gíd
 = 
IOP33X_UART1_PHYS
 + 0x3f,

75 .
	gÊags
 = 
IORESOURCE_MEM
,

78 .
°¨t
 = 
IRQ_IOP33X_UART1
,

79 .
	gíd
 = 
IRQ_IOP33X_UART1
,

80 .
	gÊags
 = 
IORESOURCE_IRQ
,

84 
∂©_£rül8250_p‹t
 
	gi›33x_u¨t1_d©a
[] = {

86 .
memba£
 = (*)
IOP33X_UART1_VIRT
,

87 .
	gm≠ba£
 = 
IOP33X_UART1_PHYS
,

88 .
	gúq
 = 
IRQ_IOP33X_UART1
,

89 .
	gu¨t˛k
 = 
IOP33X_UART_XTAL
,

90 .
	gªgshi·
 = 2,

91 .
	giŸy≥
 = 
UPIO_MEM
,

92 .
	gÊags
 = 
UPF_SKIP_TEST
,

97 
∂©f‹m_devi˚
 
	gi›33x_u¨t1_devi˚
 = {

98 .
«me
 = "serial8250",

99 .
	gid
 = 
PLAT8250_DEV_PLATFORM1
,

100 .
	gdev
 = {

101 .
∂©f‹m_d©a
 = 
i›33x_u¨t1_d©a
,

103 .
	gnum_ªsour˚s
 = 2,

104 .
	gªsour˚
 = 
i›33x_u¨t1_ªsour˚s
,

	@arch/arm/mach-ixp2000/core.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/úq.h
>

23 
	~<löux/£rül.h
>

24 
	~<löux/ây.h
>

25 
	~<löux/bô›s.h
>

26 
	~<löux/£rül_8250.h
>

27 
	~<löux/mm.h
>

29 
	~<asm/ty≥s.h
>

30 
	~<asm/£tup.h
>

31 
	~<asm/mem‹y.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/úq.h
>

34 
	~<asm/sy°em.h
>

35 
	~<asm/ébÊush.h
>

36 
	~<asm/pgèbÀ.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/time.h
>

40 
	~<asm/mach/úq.h
>

42 
	~<asm/¨ch/gpio.h
>

44 
DEFINE_SPINLOCK
(
ixp2000_¶owp‹t_lock
);

45 
	gixp2000_¶owp‹t_úq_Êags
;

50 
	$ixp2000_acquúe_¶owp‹t
(
¶owp‹t_cfg
 *
√w_cfg
, ¶owp‹t_cfg *
ﬁd_cfg
)

52 
	`•ö_lock_úqßve
(&
ixp2000_¶owp‹t_lock
, 
ixp2000_¶owp‹t_úq_Êags
);

54 
ﬁd_cfg
->
CCR
 = *
IXP2000_SLOWPORT_CCR
;

55 
ﬁd_cfg
->
WTC
 = *
IXP2000_SLOWPORT_WTC2
;

56 
ﬁd_cfg
->
RTC
 = *
IXP2000_SLOWPORT_RTC2
;

57 
ﬁd_cfg
->
PCR
 = *
IXP2000_SLOWPORT_PCR
;

58 
ﬁd_cfg
->
ADC
 = *
IXP2000_SLOWPORT_ADC
;

60 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_CCR
, 
√w_cfg
->
CCR
);

61 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_WTC2
, 
√w_cfg
->
WTC
);

62 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_RTC2
, 
√w_cfg
->
RTC
);

63 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_PCR
, 
√w_cfg
->
PCR
);

64 
	`ixp2000_ªg_wrb
(
IXP2000_SLOWPORT_ADC
, 
√w_cfg
->
ADC
);

65 
	}
}

67 
	$ixp2000_ªÀa£_¶owp‹t
(
¶owp‹t_cfg
 *
ﬁd_cfg
)

69 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_CCR
, 
ﬁd_cfg
->
CCR
);

70 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_WTC2
, 
ﬁd_cfg
->
WTC
);

71 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_RTC2
, 
ﬁd_cfg
->
RTC
);

72 
	`ixp2000_ªg_wrôe
(
IXP2000_SLOWPORT_PCR
, 
ﬁd_cfg
->
PCR
);

73 
	`ixp2000_ªg_wrb
(
IXP2000_SLOWPORT_ADC
, 
ﬁd_cfg
->
ADC
);

75 
	`•ö_u∆ock_úqª°‹e
(&
ixp2000_¶owp‹t_lock
,

76 
ixp2000_¶owp‹t_úq_Êags
);

77 
	}
}

82 
m≠_desc
 
	gixp2000_io_desc
[] 
	g__öôd©a
 = {

84 .
vútuÆ
 = 
IXP2000_CAP_VIRT_BASE
,

85 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_CAP_PHYS_BASE
),

86 .
	gÀngth
 = 
IXP2000_CAP_SIZE
,

87 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

89 .
	gvútuÆ
 = 
IXP2000_INTCTL_VIRT_BASE
,

90 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_INTCTL_PHYS_BASE
),

91 .
	gÀngth
 = 
IXP2000_INTCTL_SIZE
,

92 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

94 .
	gvútuÆ
 = 
IXP2000_PCI_CREG_VIRT_BASE
,

95 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_PCI_CREG_PHYS_BASE
),

96 .
	gÀngth
 = 
IXP2000_PCI_CREG_SIZE
,

97 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

99 .
	gvútuÆ
 = 
IXP2000_PCI_CSR_VIRT_BASE
,

100 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_PCI_CSR_PHYS_BASE
),

101 .
	gÀngth
 = 
IXP2000_PCI_CSR_SIZE
,

102 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

104 .
	gvútuÆ
 = 
IXP2000_MSF_VIRT_BASE
,

105 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_MSF_PHYS_BASE
),

106 .
	gÀngth
 = 
IXP2000_MSF_SIZE
,

107 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

109 .
	gvútuÆ
 = 
IXP2000_SCRATCH_RING_VIRT_BASE
,

110 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_SCRATCH_RING_PHYS_BASE
),

111 .
	gÀngth
 = 
IXP2000_SCRATCH_RING_SIZE
,

112 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

114 .
	gvútuÆ
 = 
IXP2000_SRAM0_VIRT_BASE
,

115 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_SRAM0_PHYS_BASE
),

116 .
	gÀngth
 = 
IXP2000_SRAM0_SIZE
,

117 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

119 .
	gvútuÆ
 = 
IXP2000_PCI_IO_VIRT_BASE
,

120 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_PCI_IO_PHYS_BASE
),

121 .
	gÀngth
 = 
IXP2000_PCI_IO_SIZE
,

122 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

124 .
	gvútuÆ
 = 
IXP2000_PCI_CFG0_VIRT_BASE
,

125 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_PCI_CFG0_PHYS_BASE
),

126 .
	gÀngth
 = 
IXP2000_PCI_CFG0_SIZE
,

127 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

129 .
	gvútuÆ
 = 
IXP2000_PCI_CFG1_VIRT_BASE
,

130 .
	gp‚
 = 
__phys_to_p‚
(
IXP2000_PCI_CFG1_PHYS_BASE
),

131 .
	gÀngth
 = 
IXP2000_PCI_CFG1_SIZE
,

132 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

136 
__öô
 
	$ixp2000_m≠_io
()

145 
	`iŸabÀ_öô
(
ixp2000_io_desc
, 
	`ARRAY_SIZE
(ixp2000_io_desc));

148 
	`ixp2000_ªg_wrb
(
IXP2000_SLOWPORT_FRM
, 1);

149 
	}
}

155 
∂©_£rül8250_p‹t
 
	gixp2000_£rül_p‹t
[] = {

157 .
m≠ba£
 = 
IXP2000_UART_PHYS_BASE
,

158 .
	gmemba£
 = (*)(
IXP2000_UART_VIRT_BASE
 + 3),

159 .
	gúq
 = 
IRQ_IXP2000_UART
,

160 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

161 .
	giŸy≥
 = 
UPIO_MEM
,

162 .
	gªgshi·
 = 2,

163 .
	gu¨t˛k
 = 50000000,

168 
ªsour˚
 
	gixp2000_u¨t_ªsour˚
 = {

169 .
°¨t
 = 
IXP2000_UART_PHYS_BASE
,

170 .
	gíd
 = 
IXP2000_UART_PHYS_BASE
 + 0x1f,

171 .
	gÊags
 = 
IORESOURCE_MEM
,

174 
∂©f‹m_devi˚
 
	gixp2000_£rül_devi˚
 = {

175 .
«me
 = "serial8250",

176 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

177 .
	gdev
 = {

178 .
∂©f‹m_d©a
 = 
ixp2000_£rül_p‹t
,

180 .
	gnum_ªsour˚s
 = 1,

181 .
	gªsour˚
 = &
ixp2000_u¨t_ªsour˚
,

184 
__öô
 
	$ixp2000_u¨t_öô
()

186 
	`∂©f‹m_devi˚_ªgi°î
(&
ixp2000_£rül_devi˚
);

187 
	}
}

193 
	gticks_≥r_jiffy
;

194 
	gticks_≥r_u£c
;

195 
	g√xt_jiffy_time
;

196 vﬁ©ûê*
	gmissög_jiffy_timî_c§
;

198 
	$ixp2000_gëtimeoff£t
 ()

200 
off£t
;

202 
off£t
 = 
√xt_jiffy_time
 - *
missög_jiffy_timî_c§
;

204  
off£t
 / 
ticks_≥r_u£c
;

205 
	}
}

207 
	$ixp2000_timî_öãºu±
(
úq
, *
dev_id
)

209 
	`wrôe_£qlock
(&
xtime_lock
);

212 
	`ixp2000_ªg_wrb
(
IXP2000_T1_CLR
, 1);

214 (sig√d )(
√xt_jiffy_time
 - *
missög_jiffy_timî_c§
)

215 >
ticks_≥r_jiffy
) {

216 
	`timî_tick
();

217 
√xt_jiffy_time
 -
ticks_≥r_jiffy
;

220 
	`wrôe_£qu∆ock
(&
xtime_lock
);

222  
IRQ_HANDLED
;

223 
	}
}

225 
úqa˘i⁄
 
	gixp2000_timî_úq
 = {

226 .
«me
 = "IXP2000 Timer Tick",

227 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

228 .
	gh™dÀr
 = 
ixp2000_timî_öãºu±
,

231 
__öô
 
	$ixp2000_öô_time
(
tick_øã
)

233 
ticks_≥r_jiffy
 = (
tick_øã
 + 
HZ
/2) / HZ;

234 
ticks_≥r_u£c
 = 
tick_øã
 / 1000000;

239 
	`ixp2000_ªg_wrôe
(
IXP2000_T1_CLR
, 0);

240 
	`ixp2000_ªg_wrôe
(
IXP2000_T1_CLD
, 
ticks_≥r_jiffy
 - 1);

241 
	`ixp2000_ªg_wrôe
(
IXP2000_T1_CTL
, (1 << 7));

251 i‡((*
IXP2000_PRODUCT_ID
 & 0x001ffef0) == 0x00000000) {

252 
	`¥ötk
(
KERN_INFO
 "Enabling IXP2800Érratum #25 workaround\n");

254 
	`ixp2000_ªg_wrôe
(
IXP2000_T4_CLR
, 0);

255 
	`ixp2000_ªg_wrôe
(
IXP2000_T4_CLD
, -1);

256 
	`ixp2000_ªg_wrb
(
IXP2000_T4_CTL
, (1 << 7));

257 
missög_jiffy_timî_c§
 = 
IXP2000_T4_CSR
;

259 
	`ixp2000_ªg_wrôe
(
IXP2000_T2_CLR
, 0);

260 
	`ixp2000_ªg_wrôe
(
IXP2000_T2_CLD
, -1);

261 
	`ixp2000_ªg_wrb
(
IXP2000_T2_CTL
, (1 << 7));

262 
missög_jiffy_timî_c§
 = 
IXP2000_T2_CSR
;

264 
√xt_jiffy_time
 = 0xffffffff;

267 
	`£tup_úq
(
IRQ_IXP2000_TIMER1
, &
ixp2000_timî_úq
);

268 
	}
}

273 
	gGPIO_IRQ_ÁŒög_edge
;

274 
	gGPIO_IRQ_risög_edge
;

275 
	gGPIO_IRQ_Àvñ_low
;

276 
	gGPIO_IRQ_Àvñ_high
;

278 
	$upd©e_gpio_öt_c§s
()

280 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_FEDR
, 
GPIO_IRQ_ÁŒög_edge
);

281 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_REDR
, 
GPIO_IRQ_risög_edge
);

282 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_LSLR
, 
GPIO_IRQ_Àvñ_low
);

283 
	`ixp2000_ªg_wrb
(
IXP2000_GPIO_LSHR
, 
GPIO_IRQ_Àvñ_high
);

284 
	}
}

286 
	$gpio_löe_c⁄fig
(
löe
, 
dúe˘i⁄
)

288 
Êags
;

290 
	`loˇl_úq_ßve
(
Êags
);

291 i‡(
dúe˘i⁄
 =
GPIO_OUT
) {

293 
GPIO_IRQ_ÁŒög_edge
 &~(1 << 
löe
);

294 
GPIO_IRQ_risög_edge
 &~(1 << 
löe
);

295 
GPIO_IRQ_Àvñ_low
 &~(1 << 
löe
);

296 
GPIO_IRQ_Àvñ_high
 &~(1 << 
löe
);

297 
	`upd©e_gpio_öt_c§s
();

299 
	`ixp2000_ªg_wrb
(
IXP2000_GPIO_PDSR
, 1 << 
löe
);

300 } i‡(
dúe˘i⁄
 =
GPIO_IN
) {

301 
	`ixp2000_ªg_wrb
(
IXP2000_GPIO_PDCR
, 1 << 
löe
);

303 
	`loˇl_úq_ª°‹e
(
Êags
);

304 
	}
}

305 
EXPORT_SYMBOL
(
gpio_löe_c⁄fig
);

311 
	$ixp2000_GPIO_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

313 
i
;

314 
°©us
 = *
IXP2000_GPIO_INST
;

316 
i
 = 0; i <= 7; i++) {

317 i‡(
°©us
 & (1<<
i
)) {

318 
desc
 = 
úq_desc
 + 
i
 + 
IRQ_IXP2000_GPIO0
;

319 
	`desc_h™dÀ_úq
(
i
 + 
IRQ_IXP2000_GPIO0
, 
desc
);

322 
	}
}

324 
	$ixp2000_GPIO_úq_ty≥
(
úq
, 
ty≥
)

326 
löe
 = 
úq
 - 
IRQ_IXP2000_GPIO0
;

331 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_PDCR
, 1 << 
löe
);

336 i‡(
ty≥
 & 
IRQT_FALLING
)

337 
GPIO_IRQ_ÁŒög_edge
 |1 << 
löe
;

339 
GPIO_IRQ_ÁŒög_edge
 &~(1 << 
löe
);

340 i‡(
ty≥
 & 
IRQT_RISING
)

341 
GPIO_IRQ_risög_edge
 |1 << 
löe
;

343 
GPIO_IRQ_risög_edge
 &~(1 << 
löe
);

344 i‡(
ty≥
 & 
IRQT_LOW
)

345 
GPIO_IRQ_Àvñ_low
 |1 << 
löe
;

347 
GPIO_IRQ_Àvñ_low
 &~(1 << 
löe
);

348 i‡(
ty≥
 & 
IRQT_HIGH
)

349 
GPIO_IRQ_Àvñ_high
 |1 << 
löe
;

351 
GPIO_IRQ_Àvñ_high
 &~(1 << 
löe
);

352 
	`upd©e_gpio_öt_c§s
();

355 
	}
}

357 
	$ixp2000_GPIO_úq_mask_ack
(
úq
)

359 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_INCR
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

361 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_EDSR
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

362 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_LDSR
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

363 
	`ixp2000_ªg_wrb
(
IXP2000_GPIO_INST
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

364 
	}
}

366 
	$ixp2000_GPIO_úq_mask
(
úq
)

368 
	`ixp2000_ªg_wrb
(
IXP2000_GPIO_INCR
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

369 
	}
}

371 
	$ixp2000_GPIO_úq_unmask
(
úq
)

373 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_INSR
, (1 << (
úq
 - 
IRQ_IXP2000_GPIO0
)));

374 
	}
}

376 
úq_chù
 
	gixp2000_GPIO_úq_chù
 = {

377 .
ack
 = 
ixp2000_GPIO_úq_mask_ack
,

378 .
	gmask
 = 
ixp2000_GPIO_úq_mask
,

379 .
	gunmask
 = 
ixp2000_GPIO_úq_unmask
,

380 .
	g£t_ty≥
 = 
ixp2000_GPIO_úq_ty≥
,

383 
	$ixp2000_pci_úq_mask
(
úq
)

385 
ãmp
 = *
IXP2000_PCI_XSCALE_INT_ENABLE
;

386 i‡(
úq
 =
IRQ_IXP2000_PCIA
)

387 
	`ixp2000_ªg_wrb
(
IXP2000_PCI_XSCALE_INT_ENABLE
, (
ãmp
 & ~(1 << 26)));

388 i‡(
úq
 =
IRQ_IXP2000_PCIB
)

389 
	`ixp2000_ªg_wrb
(
IXP2000_PCI_XSCALE_INT_ENABLE
, (
ãmp
 & ~(1 << 27)));

390 
	}
}

392 
	$ixp2000_pci_úq_unmask
(
úq
)

394 
ãmp
 = *
IXP2000_PCI_XSCALE_INT_ENABLE
;

395 i‡(
úq
 =
IRQ_IXP2000_PCIA
)

396 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_XSCALE_INT_ENABLE
, (
ãmp
 | (1 << 26)));

397 i‡(
úq
 =
IRQ_IXP2000_PCIB
)

398 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_XSCALE_INT_ENABLE
, (
ãmp
 | (1 << 27)));

399 
	}
}

404 
	$ixp2000_îr_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

406 
i
;

407 
°©us
 = *
IXP2000_IRQ_ERR_STATUS
;

409 
i
 = 31; i >= 0; i--) {

410 if(
°©us
 & (1 << 
i
)) {

411 
desc
 = 
úq_desc
 + 
IRQ_IXP2000_DRAM0_MIN_ERR
 + 
i
;

412 
	`desc_h™dÀ_úq
(
IRQ_IXP2000_DRAM0_MIN_ERR
 + 
i
, 
desc
);

415 
	}
}

417 
	$ixp2000_îr_úq_mask
(
úq
)

419 
	`ixp2000_ªg_wrôe
(
IXP2000_IRQ_ERR_ENABLE_CLR
,

420 (1 << (
úq
 - 
IRQ_IXP2000_DRAM0_MIN_ERR
)));

421 
	}
}

423 
	$ixp2000_îr_úq_unmask
(
úq
)

425 
	`ixp2000_ªg_wrôe
(
IXP2000_IRQ_ERR_ENABLE_SET
,

426 (1 << (
úq
 - 
IRQ_IXP2000_DRAM0_MIN_ERR
)));

427 
	}
}

429 
úq_chù
 
	gixp2000_îr_úq_chù
 = {

430 .
ack
 = 
ixp2000_îr_úq_mask
,

431 .
	gmask
 = 
ixp2000_îr_úq_mask
,

432 .
	gunmask
 = 
ixp2000_îr_úq_unmask


435 
úq_chù
 
	gixp2000_pci_úq_chù
 = {

436 .
ack
 = 
ixp2000_pci_úq_mask
,

437 .
	gmask
 = 
ixp2000_pci_úq_mask
,

438 .
	gunmask
 = 
ixp2000_pci_úq_unmask


441 
	$ixp2000_úq_mask
(
úq
)

443 
	`ixp2000_ªg_wrb
(
IXP2000_IRQ_ENABLE_CLR
, (1 << 
úq
));

444 
	}
}

446 
	$ixp2000_úq_unmask
(
úq
)

448 
	`ixp2000_ªg_wrôe
(
IXP2000_IRQ_ENABLE_SET
, (1 << 
úq
));

449 
	}
}

451 
úq_chù
 
	gixp2000_úq_chù
 = {

452 .
ack
 = 
ixp2000_úq_mask
,

453 .
	gmask
 = 
ixp2000_úq_mask
,

454 .
	gunmask
 = 
ixp2000_úq_unmask


457 
__öô
 
	$ixp2000_öô_úq
()

459 
úq
;

464 
	`ixp2000_ªg_wrôe
(
IXP2000_IRQ_ENABLE_CLR
, 0xffffffff);

465 
	`ixp2000_ªg_wrôe
(
IXP2000_FIQ_ENABLE_CLR
, 0xffffffff);

468 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_REDR
, 0);

469 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_FEDR
, 0);

470 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_LSHR
, 0);

471 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_LSLR
, 0);

472 
	`ixp2000_ªg_wrôe
(
IXP2000_GPIO_INCR
, -1);

475 
	`ixp2000_ªg_wrb
(
IXP2000_PCI_XSCALE_INT_ENABLE
, 0);

484 
úq
 = 
IRQ_IXP2000_SOFT_INT
; irq <
IRQ_IXP2000_THDB3
; irq++) {

485 i‡((1 << 
úq
Ë& 
IXP2000_VALID_IRQ_MASK
) {

486 
	`£t_úq_chù
(
úq
, &
ixp2000_úq_chù
);

487 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

488 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

489 } 
	`£t_úq_Êags
(
úq
, 0);

492 
úq
 = 
IRQ_IXP2000_DRAM0_MIN_ERR
; irq <
IRQ_IXP2000_SP_INT
; irq++) {

493 if((1 << (
úq
 - 
IRQ_IXP2000_DRAM0_MIN_ERR
)) &

494 
IXP2000_VALID_ERR_IRQ_MASK
) {

495 
	`£t_úq_chù
(
úq
, &
ixp2000_îr_úq_chù
);

496 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

497 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

500 
	`£t_úq_Êags
(
úq
, 0);

502 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP2000_ERRSUM
, 
ixp2000_îr_úq_h™dÀr
);

504 
úq
 = 
IRQ_IXP2000_GPIO0
; irq <
IRQ_IXP2000_GPIO7
; irq++) {

505 
	`£t_úq_chù
(
úq
, &
ixp2000_GPIO_úq_chù
);

506 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

507 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

509 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP2000_GPIO
, 
ixp2000_GPIO_úq_h™dÀr
);

516 
	`ixp2000_ªg_wrôe
(
IXP2000_IRQ_ENABLE_SET
, (1 << 
IRQ_IXP2000_PCI
));

517 
úq
 = 
IRQ_IXP2000_PCIA
; irq <
IRQ_IXP2000_PCIB
; irq++) {

518 
	`£t_úq_chù
(
úq
, &
ixp2000_pci_úq_chù
);

519 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

520 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

522 
	}
}

	@arch/arm/mach-ixp2000/enp2611.c

21 
	~<löux/kî√l.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bô›s.h
>

27 
	~<löux/pci.h
>

28 
	~<löux/i›‹t.h
>

29 
	~<löux/¶ab.h
>

30 
	~<löux/dñay.h
>

31 
	~<löux/£rül.h
>

32 
	~<löux/ây.h
>

33 
	~<löux/£rül_c‹e.h
>

34 
	~<löux/∂©f‹m_devi˚.h
>

36 
	~<asm/io.h
>

37 
	~<asm/úq.h
>

38 
	~<asm/pgèbÀ.h
>

39 
	~<asm/∑ge.h
>

40 
	~<asm/sy°em.h
>

41 
	~<asm/h¨dw¨e.h
>

42 
	~<asm/mach-ty≥s.h
>

44 
	~<asm/mach/pci.h
>

45 
	~<asm/mach/m≠.h
>

46 
	~<asm/mach/úq.h
>

47 
	~<asm/mach/time.h
>

48 
	~<asm/mach/¨ch.h
>

49 
	~<asm/mach/Êash.h
>

54 
__öô
 
	$íp2611_timî_öô
()

56 
	`ixp2000_öô_time
(50 * 1000 * 1000);

57 
	}
}

59 
sys_timî
 
	gíp2611_timî
 = {

60 .
öô
 = 
íp2611_timî_öô
,

61 .
	goff£t
 = 
ixp2000_gëtimeoff£t
,

68 
m≠_desc
 
	gíp2611_io_desc
[] 
	g__öôd©a
 = {

70 .
vútuÆ
 = 
ENP2611_CALEB_VIRT_BASE
,

71 .
	gp‚
 = 
__phys_to_p‚
(
ENP2611_CALEB_PHYS_BASE
),

72 .
	gÀngth
 = 
ENP2611_CALEB_SIZE
,

73 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

75 .
	gvútuÆ
 = 
ENP2611_PM3386_0_VIRT_BASE
,

76 .
	gp‚
 = 
__phys_to_p‚
(
ENP2611_PM3386_0_PHYS_BASE
),

77 .
	gÀngth
 = 
ENP2611_PM3386_0_SIZE
,

78 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

80 .
	gvútuÆ
 = 
ENP2611_PM3386_1_VIRT_BASE
,

81 .
	gp‚
 = 
__phys_to_p‚
(
ENP2611_PM3386_1_PHYS_BASE
),

82 .
	gÀngth
 = 
ENP2611_PM3386_1_SIZE
,

83 .
	gty≥
 = 
MT_DEVICE_IXP2000
,

87 
__öô
 
	$íp2611_m≠_io
()

89 
	`ixp2000_m≠_io
();

90 
	`iŸabÀ_öô
(
íp2611_io_desc
, 
	`ARRAY_SIZE
(enp2611_io_desc));

91 
	}
}

97 
	$íp2611_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

99 
sys
->
mem_off£t
 = 0xe0000000;

100 
	`ixp2000_pci_£tup
(
ƒ
, 
sys
);

102 
	}
}

104 
__öô
 
	$íp2611_pci_¥eöô
()

106 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_ADDR_EXT
, 0x00100000);

107 
	`ixp2000_pci_¥eöô
();

108 
	`pcibios_£tup
("firmware");

109 
	}
}

111 
ölöe
 
	$íp2611_pci_vÆid_devi˚
(
pci_bus
 *
bus
,

112 
dev‚
)

117 i‡(
bus
->
numbî
 =0x01 && 
dev‚
 == 0x10)

121 
	}
}

123 
	$íp2611_pci_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
,

124 
whîe
, 
size
, 
u32
 *
vÆue
)

126 i‡(
	`íp2611_pci_vÆid_devi˚
(
bus
, 
dev‚
))

127  
	`ixp2000_pci_ªad_c⁄fig
(
bus
, 
dev‚
, 
whîe
, 
size
, 
vÆue
);

129  
PCIBIOS_DEVICE_NOT_FOUND
;

130 
	}
}

132 
	$íp2611_pci_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
,

133 
whîe
, 
size
, 
u32
 
vÆue
)

135 i‡(
	`íp2611_pci_vÆid_devi˚
(
bus
, 
dev‚
))

136  
	`ixp2000_pci_wrôe_c⁄fig
(
bus
, 
dev‚
, 
whîe
, 
size
, 
vÆue
);

138  
PCIBIOS_DEVICE_NOT_FOUND
;

139 
	}
}

141 
pci_›s
 
	gíp2611_pci_›s
 = {

142 .
ªad
 = 
íp2611_pci_ªad_c⁄fig
,

143 .
	gwrôe
 = 
íp2611_pci_wrôe_c⁄fig


146 
pci_bus
 * 
__öô
 
	$íp2611_pci_sˇn_bus
(
ƒ
,

147 
pci_sys_d©a
 *
sys
)

149  
	`pci_sˇn_bus
(
sys
->
bu¢r
, &
íp2611_pci_›s
, sys);

150 
	}
}

152 
__öô
 
	$íp2611_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

154 
úq
;

156 i‡(
dev
->
bus
->
numbî
 =0 && 
	`PCI_SLOT
(dev->
dev‚
) == 0) {

158 
úq
 = 
IRQ_IXP2000_PCIA
;

159 } i‡(
dev
->
bus
->
numbî
 =0 && 
	`PCI_SLOT
(dev->
dev‚
) == 1) {

161 
úq
 = 
IRQ_IXP2000_PCIB
;

162 } i‡(
dev
->
bus
->
numbî
 =0 && 
	`PCI_SLOT
(dev->
dev‚
) == 4) {

164 
úq
 = -1;

165 } i‡(
dev
->
bus
->
numbî
 =1 && 
	`PCI_SLOT
(dev->
dev‚
) == 0) {

167 
úq
 = 
IRQ_IXP2000_PCIA
;

168 } i‡(
dev
->
bus
->
numbî
 =1 && 
	`PCI_SLOT
(dev->
dev‚
) == 1) {

170 
úq
 = 
IRQ_IXP2000_PCIB
;

172 
	`¥ötk
(
KERN_ERR
 "enp2611_pci_map_irq() called for unknown "

173 "devi˚ PCI:%d:%d:%d\n", 
dev
->
bus
->
numbî
,

174 
	`PCI_SLOT
(
dev
->
dev‚
), 
	`PCI_FUNC
(dev->devfn));

175 
úq
 = -1;

178  
úq
;

179 
	}
}

181 
hw_pci
 
íp2611_pci
 
	g__öôd©a
 = {

182 .
ƒ_c⁄åﬁÀrs
 = 1,

183 .
	g£tup
 = 
íp2611_pci_£tup
,

184 .
	g¥eöô
 = 
íp2611_pci_¥eöô
,

185 .
	gsˇn
 = 
íp2611_pci_sˇn_bus
,

186 .
	gm≠_úq
 = 
íp2611_pci_m≠_úq
,

189 
__öô
 
	$íp2611_pci_öô
()

191 i‡(
	`machöe_is_íp2611
())

192 
	`pci_comm⁄_öô
(&
íp2611_pci
);

195 
	}
}

197 
subsys_öôˇŒ
(
íp2611_pci_öô
);

203 
Êash_∂©f‹m_d©a
 
	gíp2611_Êash_∂©f‹m_d©a
 = {

204 .
m≠_«me
 = "cfi_probe",

205 .
	gwidth
 = 1,

208 
ixp2000_Êash_d©a
 
	gíp2611_Êash_d©a
 = {

209 .
∂©f‹m_d©a
 = &
íp2611_Êash_∂©f‹m_d©a
,

210 .
	gƒ_b™ks
 = 1

213 
ªsour˚
 
	gíp2611_Êash_ªsour˚
 = {

214 .
°¨t
 = 0xc4000000,

215 .
	gíd
 = 0xc4000000 + 0x00ffffff,

216 .
	gÊags
 = 
IORESOURCE_MEM
,

219 
∂©f‹m_devi˚
 
	gíp2611_Êash
 = {

220 .
«me
 = "IXP2000-Flash",

221 .
	gid
 = 0,

222 .
	gdev
 = {

223 .
∂©f‹m_d©a
 = &
íp2611_Êash_d©a
,

225 .
	gnum_ªsour˚s
 = 1,

226 .
	gªsour˚
 = &
íp2611_Êash_ªsour˚
,

229 
ixp2000_i2c_pös
 
	gíp2611_i2c_gpio_pös
 = {

230 .
sda_pö
 = 
ENP2611_GPIO_SDA
,

231 .
	gs˛_pö
 = 
ENP2611_GPIO_SCL
,

234 
∂©f‹m_devi˚
 
	gíp2611_i2c_c⁄åﬁÀr
 = {

235 .
«me
 = "IXP2000-I2C",

236 .
	gid
 = 0,

237 .
	gdev
 = {

238 .
∂©f‹m_d©a
 = &
íp2611_i2c_gpio_pös


240 .
	gnum_ªsour˚s
 = 0

243 
∂©f‹m_devi˚
 *
	gíp2611_devi˚s
[] 
	g__öôd©a
 = {

244 &
íp2611_Êash
,

245 &
íp2611_i2c_c⁄åﬁÀr


248 
__öô
 
	$íp2611_öô_machöe
()

250 
	`∂©f‹m_add_devi˚s
(
íp2611_devi˚s
, 
	`ARRAY_SIZE
(enp2611_devices));

251 
	`ixp2000_u¨t_öô
();

252 
	}
}

255 
MACHINE_START
(
ENP2611
, "Radisys ENP-2611 PCIÇetworkÖrocessor board")

257 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

258 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

259 .
	gboŸ_∑øms
 = 0x00000100,

260 .
	gm≠_io
 = 
íp2611_m≠_io
,

261 .
	göô_úq
 = 
ixp2000_öô_úq
,

262 .
	gtimî
 = &
íp2611_timî
,

263 .
	göô_machöe
 = 
íp2611_öô_machöe
,

264 
	gMACHINE_END


	@arch/arm/mach-ixp2000/ixdp2400.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/devi˚.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/pci.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/dñay.h
>

29 
	~<asm/io.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/pgèbÀ.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/sy°em.h
>

34 
	~<asm/h¨dw¨e.h
>

35 
	~<asm/mach-ty≥s.h
>

37 
	~<asm/mach/pci.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/úq.h
>

40 
	~<asm/mach/time.h
>

41 
	~<asm/mach/Êash.h
>

42 
	~<asm/mach/¨ch.h
>

47 
__öô
 
	$ixdp2400_timî_öô
()

49 
numî©‹
, 
díomö©‹
;

50 
díom_¨øy
[] = {2, 4, 8, 16, 1, 2, 4, 8};

52 
numî©‹
 = (*(
IXDP2400_CPLD_SYS_CLK_M
) & 0xFF) *2;

53 
díomö©‹
 = 
díom_¨øy
[(*(
IXDP2400_CPLD_SYS_CLK_N
) & 0x7)];

55 
	`ixp2000_öô_time
(((3125000 * 
numî©‹
Ë/ (
díomö©‹
)) / 2);

56 
	}
}

58 
sys_timî
 
	gixdp2400_timî
 = {

59 .
öô
 = 
ixdp2400_timî_öô
,

60 .
	goff£t
 = 
ixp2000_gëtimeoff£t
,

66 
__öô
 
	$ixdp2400_pci_¥eöô
()

68 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_ADDR_EXT
, 0x00100000);

69 
	`ixp2000_pci_¥eöô
();

70 
	`pcibios_£tup
("firmware");

71 
	}
}

73 
	$ixdp2400_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

75 
sys
->
mem_off£t
 = 0xe0000000;

77 
	`ixp2000_pci_£tup
(
ƒ
, 
sys
);

80 
	}
}

82 
__öô
 
	$ixdp2400_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

84 i‡(
	`ixdp2x00_ma°î_≈u
()) {

91 if(!
dev
->
bus
->
£lf
) {

92 if(
dev
->
dev‚
 =
IXDP2X00_SLAVE_NPU_DEVFN
 )

93  
IRQ_IXDP2400_INGRESS_NPU
;

102 if(
dev
->
bus
->
£lf
->
dev‚
 =
IXDP2X00_PMC_DEVFN
 &&

103 
dev
->
bus
->
∑ª¡
->
£lf
->
dev‚
 =
IXDP2X00_P2P_DEVFN
 &&

104 !
dev
->
bus
->
∑ª¡
->
£lf
->bus->parent)

105  
IRQ_IXDP2400_PMC
;

110 if(
dev
->
bus
->
£lf
->
dev‚
 =
IXDP2X00_P2P_DEVFN
) {

111 
dev
->
dev‚
) {

112 
IXDP2400_MASTER_ENET_DEVFN
:

113  
IRQ_IXDP2400_ENET
;

115 
IXDP2400_MEDIA_DEVFN
:

116  
IRQ_IXDP2400_MEDIA_PCI
;

118 
IXDP2400_SWITCH_FABRIC_DEVFN
:

119  
IRQ_IXDP2400_SF_PCI
;

121 
IXDP2X00_PMC_DEVFN
:

122  
IRQ_IXDP2400_PMC
;

127 }  
IRQ_IXP2000_PCIB
;

128 
	}
}

131 
	$ixdp2400_pci_po°öô
()

133 
pci_dev
 *
dev
;

135 i‡(
	`ixdp2x00_ma°î_≈u
()) {

136 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(1, 
IXDP2400_SLAVE_ENET_DEVFN
);

137 
	`pci_ªmove_bus_devi˚
(
dev
);

138 
	`pci_dev_put
(
dev
);

140 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(1, 
IXDP2400_MASTER_ENET_DEVFN
);

141 
	`pci_ªmove_bus_devi˚
(
dev
);

142 
	`pci_dev_put
(
dev
);

144 
	`ixdp2x00_¶ave_pci_po°öô
();

146 
	}
}

148 
hw_pci
 
ixdp2400_pci
 
	g__öôd©a
 = {

149 .
ƒ_c⁄åﬁÀrs
 = 1,

150 .
	g£tup
 = 
ixdp2400_pci_£tup
,

151 .
	g¥eöô
 = 
ixdp2400_pci_¥eöô
,

152 .
	gpo°öô
 = 
ixdp2400_pci_po°öô
,

153 .
	gsˇn
 = 
ixp2000_pci_sˇn_bus
,

154 .
	gm≠_úq
 = 
ixdp2400_pci_m≠_úq
,

157 
__öô
 
	$ixdp2400_pci_öô
()

159 i‡(
	`machöe_is_ixdp2400
())

160 
	`pci_comm⁄_öô
(&
ixdp2400_pci
);

163 
	}
}

165 
subsys_öôˇŒ
(
ixdp2400_pci_öô
);

167 
__öô
 
	$ixdp2400_öô_úq
()

169 
	`ixdp2x00_öô_úq
(
IXDP2400_CPLD_INT_STAT
, 
IXDP2400_CPLD_INT_MASK
, 
IXDP2400_NR_IRQS
);

170 
	}
}

172 
MACHINE_START
(
IXDP2400
, "Intel IXDP2400 Development Platform")

174 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

175 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

176 .
	gboŸ_∑øms
 = 0x00000100,

177 .
	gm≠_io
 = 
ixdp2x00_m≠_io
,

178 .
	göô_úq
 = 
ixdp2400_öô_úq
,

179 .
	gtimî
 = &
ixdp2400_timî
,

180 .
	göô_machöe
 = 
ixdp2x00_öô_machöe
,

181 
	gMACHINE_END


	@arch/arm/mach-ixp2000/ixdp2800.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/devi˚.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/pci.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/dñay.h
>

29 
	~<asm/io.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/pgèbÀ.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/sy°em.h
>

34 
	~<asm/h¨dw¨e.h
>

35 
	~<asm/mach-ty≥s.h
>

37 
	~<asm/mach/pci.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/úq.h
>

40 
	~<asm/mach/time.h
>

41 
	~<asm/mach/Êash.h
>

42 
	~<asm/mach/¨ch.h
>

48 
__öô
 
	$ixdp2800_timî_öô
()

50 
	`ixp2000_öô_time
(50000000);

51 
	}
}

53 
sys_timî
 
	gixdp2800_timî
 = {

54 .
öô
 = 
ixdp2800_timî_öô
,

55 .
	goff£t
 = 
ixp2000_gëtimeoff£t
,

61 
__öô
 
	$ixdp2800_¶ave_dißbÀ_pci_ma°î
()

63 *
IXP2000_PCI_CMDSTAT
 &~(
PCI_COMMAND_MASTER
 | 
PCI_COMMAND_MEMORY
);

64 
	}
}

66 
__öô
 
	$ixdp2800_ma°î_waô_f‹_¶ave
()

68 vﬁ©ûê
u32
 *
addr
;

70 
	`¥ötk
(
KERN_INFO
 "IXDP2800: waiting for slave NPUÅo configure "

73 
addr
 = 
	`ixp2000_pci_c⁄fig_addr
(0, 
IXDP2X00_SLAVE_NPU_DEVFN
,

74 
PCI_BASE_ADDRESS_1
);

76 *
addr
 = 0xffffffff;

77 
	`˝u_ªœx
();

78 } *
addr
 != 0xfe000008);

80 
addr
 = 
	`ixp2000_pci_c⁄fig_addr
(0, 
IXDP2X00_SLAVE_NPU_DEVFN
,

81 
PCI_BASE_ADDRESS_2
);

83 *
addr
 = 0xffffffff;

84 
	`˝u_ªœx
();

85 } *
addr
 != 0xc0000008);

90 *
addr
 = 0x40000008;

91 
	}
}

93 
__öô
 
	$ixdp2800_¶ave_waô_f‹_ma°î_íabÀ
()

95 
	`¥ötk
(
KERN_INFO
 "IXDP2800: waiting for master NPUÅoÉnable us\n");

97 (*
IXP2000_PCI_CMDSTAT
 & 
PCI_COMMAND_MASTER
) == 0)

98 
	`˝u_ªœx
();

99 
	}
}

101 
__öô
 
	$ixdp2800_pci_¥eöô
()

103 
	`¥ötk
("ixdp2x00_pci_preinit called\n");

105 *
IXP2000_PCI_ADDR_EXT
 = 0x0001e000;

107 i‡(!
	`ixdp2x00_ma°î_≈u
())

108 
	`ixdp2800_¶ave_dißbÀ_pci_ma°î
();

110 *
IXP2000_PCI_SRAM_BASE_ADDR_MASK
 = (0x2000000 - 1) & ~0x3ffff;

111 *
IXP2000_PCI_DRAM_BASE_ADDR_MASK
 = (0x40000000 - 1) & ~0xfffff;

113 
	`ixp2000_pci_¥eöô
();

115 i‡(
	`ixdp2x00_ma°î_≈u
()) {

121 
	`ixdp2800_ma°î_waô_f‹_¶ave
();

128 *
IXP2000_PCI_SDRAM_BAR
 = 0x00000008;

136 
	`ixdp2800_¶ave_waô_f‹_ma°î_íabÀ
();

137 
	`pcibios_£tup
("firmware");

139 
	}
}

146 
__devöô
 
	$ixp2800_pci_fixup
(
pci_dev
 *
dev
)

148 i‡(
	`machöe_is_ixdp2800
()) {

149 
dev
->
ªsour˚
[2].
°¨t
 = 0;

150 
dev
->
ªsour˚
[2].
íd
 = 0;

151 
dev
->
ªsour˚
[2].
Êags
 = 0;

153 
	}
}

154 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_IXP2800
, 
ixp2800_pci_fixup
);

156 
__öô
 
	$ixdp2800_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

158 
sys
->
mem_off£t
 = 0x00000000;

160 
	`ixp2000_pci_£tup
(
ƒ
, 
sys
);

163 
	}
}

165 
__öô
 
	$ixdp2800_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

167 i‡(
	`ixdp2x00_ma°î_≈u
()) {

173 if(!
dev
->
bus
->
£lf
) {

174 if(
dev
->
dev‚
 =
IXDP2X00_SLAVE_NPU_DEVFN
 )

175  
IRQ_IXDP2800_INGRESS_NPU
;

183 if(
dev
->
bus
->
£lf
->
dev‚
 =
IXDP2X00_PMC_DEVFN
 &&

184 
dev
->
bus
->
∑ª¡
->
£lf
->
dev‚
 =
IXDP2X00_P2P_DEVFN
 &&

185 !
dev
->
bus
->
∑ª¡
->
£lf
->bus->parent)

186  
IRQ_IXDP2800_PMC
;

191 if(
dev
->
bus
->
£lf
->
dev‚
 =
IXDP2X00_P2P_DEVFN
) {

192 
dev
->
dev‚
) {

193 
IXDP2X00_PMC_DEVFN
:

194  
IRQ_IXDP2800_PMC
;

196 
IXDP2800_MASTER_ENET_DEVFN
:

197  
IRQ_IXDP2800_EGRESS_ENET
;

199 
IXDP2800_SWITCH_FABRIC_DEVFN
:

200  
IRQ_IXDP2800_FABRIC
;

205 }  
IRQ_IXP2000_PCIB
;

206 
	}
}

208 
__öô
 
	$ixdp2800_ma°î_íabÀ_¶ave
()

210 vﬁ©ûê
u32
 *
addr
;

212 
	`¥ötk
(
KERN_INFO
 "IXDP2800:Énabling slave NPU\n");

214 
addr
 = (vﬁ©ûê
u32
 *)
	`ixp2000_pci_c⁄fig_addr
(0,

215 
IXDP2X00_SLAVE_NPU_DEVFN
,

216 
PCI_COMMAND
);

218 *
addr
 |
PCI_COMMAND_MASTER
;

219 
	}
}

221 
__öô
 
	$ixdp2800_ma°î_waô_f‹_¶ave_bus_sˇn
()

223 vﬁ©ûê
u32
 *
addr
;

225 
	`¥ötk
(
KERN_INFO
 "IXDP2800: waiting for slaveÅo finish bus scan\n");

227 
addr
 = (vﬁ©ûê
u32
 *)
	`ixp2000_pci_c⁄fig_addr
(0,

228 
IXDP2X00_SLAVE_NPU_DEVFN
,

229 
PCI_COMMAND
);

230 (*
addr
 & 
PCI_COMMAND_MEMORY
) == 0)

231 
	`˝u_ªœx
();

232 
	}
}

234 
__öô
 
	$ixdp2800_¶ave_sig«l_bus_sˇn_com∂ëi⁄
()

236 
	`¥ötk
(
KERN_INFO
 "IXDP2800: bus scan done, signaling master\n");

237 *
IXP2000_PCI_CMDSTAT
 |
PCI_COMMAND_MEMORY
;

238 
	}
}

240 
__öô
 
	$ixdp2800_pci_po°öô
()

242 i‡(!
	`ixdp2x00_ma°î_≈u
()) {

243 
	`ixdp2x00_¶ave_pci_po°öô
();

244 
	`ixdp2800_¶ave_sig«l_bus_sˇn_com∂ëi⁄
();

246 
	}
}

248 
__öôd©a
 
hw_pci
 
ixdp2800_pci
 
	g__öôd©a
 = {

249 .
ƒ_c⁄åﬁÀrs
 = 1,

250 .
	g£tup
 = 
ixdp2800_pci_£tup
,

251 .
	g¥eöô
 = 
ixdp2800_pci_¥eöô
,

252 .
	gpo°öô
 = 
ixdp2800_pci_po°öô
,

253 .
	gsˇn
 = 
ixp2000_pci_sˇn_bus
,

254 .
	gm≠_úq
 = 
ixdp2800_pci_m≠_úq
,

257 
__öô
 
	$ixdp2800_pci_öô
()

259 i‡(
	`machöe_is_ixdp2800
()) {

260 
pci_dev
 *
dev
;

262 
	`pci_comm⁄_öô
(&
ixdp2800_pci
);

263 i‡(
	`ixdp2x00_ma°î_≈u
()) {

264 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(1, 
IXDP2800_SLAVE_ENET_DEVFN
);

265 
	`pci_ªmove_bus_devi˚
(
dev
);

266 
	`pci_dev_put
(
dev
);

268 
	`ixdp2800_ma°î_íabÀ_¶ave
();

269 
	`ixdp2800_ma°î_waô_f‹_¶ave_bus_sˇn
();

271 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(1, 
IXDP2800_MASTER_ENET_DEVFN
);

272 
	`pci_ªmove_bus_devi˚
(
dev
);

273 
	`pci_dev_put
(
dev
);

278 
	}
}

280 
subsys_öôˇŒ
(
ixdp2800_pci_öô
);

282 
__öô
 
	$ixdp2800_öô_úq
()

284 
	`ixdp2x00_öô_úq
(
IXDP2800_CPLD_INT_STAT
, 
IXDP2800_CPLD_INT_MASK
, 
IXDP2800_NR_IRQS
);

285 
	}
}

287 
MACHINE_START
(
IXDP2800
, "Intel IXDP2800 Development Platform")

289 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

290 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

291 .
	gboŸ_∑øms
 = 0x00000100,

292 .
	gm≠_io
 = 
ixdp2x00_m≠_io
,

293 .
	göô_úq
 = 
ixdp2800_öô_úq
,

294 .
	gtimî
 = &
ixdp2800_timî
,

295 .
	göô_machöe
 = 
ixdp2x00_öô_machöe
,

296 
	gMACHINE_END


	@arch/arm/mach-ixp2000/ixdp2x00.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/pci.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/dñay.h
>

29 
	~<asm/io.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/pgèbÀ.h
>

32 
	~<asm/∑ge.h
>

33 
	~<asm/sy°em.h
>

34 
	~<asm/h¨dw¨e.h
>

35 
	~<asm/mach-ty≥s.h
>

37 
	~<asm/mach/pci.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/úq.h
>

40 
	~<asm/mach/time.h
>

41 
	~<asm/mach/Êash.h
>

42 
	~<asm/mach/¨ch.h
>

44 
	~<asm/¨ch/gpio.h
>

50 vﬁ©ûê*
	gbﬂrd_úq_mask
;

51 vﬁ©ûê*
	gbﬂrd_úq_°©
;

52 
	gbﬂrd_úq_cou¡
;

54 #ifde‡
CONFIG_ARCH_IXDP2400


58 
¶owp‹t_cfg
 
	g¶owp‹t_˝ld_cfg
 = {

59 .
CCR
 = 
SLOWPORT_CCR_DIV_2
,

60 .
	gWTC
 = 0x00000070,

61 .
	gRTC
 = 0x00000070,

62 .
	gPCR
 = 
SLOWPORT_MODE_FLASH
,

63 .
	gADC
 = 
SLOWPORT_ADDR_WIDTH_24
 | 
SLOWPORT_DATA_WIDTH_8


67 
	$ixdp2x00_úq_mask
(
úq
)

69 
dummy
;

70 
¶owp‹t_cfg
 
ﬁd_cfg
;

76 #ifde‡
CONFIG_ARCH_IXDP2400


77 i‡(
	`machöe_is_ixdp2400
())

78 
	`ixp2000_acquúe_¶owp‹t
(&
¶owp‹t_˝ld_cfg
, &
ﬁd_cfg
);

81 
dummy
 = *
bﬂrd_úq_mask
;

82 
dummy
 |
	`IXP2000_BOARD_IRQ_MASK
(
úq
);

83 
	`ixp2000_ªg_wrb
(
bﬂrd_úq_mask
, 
dummy
);

85 #ifde‡
CONFIG_ARCH_IXDP2400


86 i‡(
	`machöe_is_ixdp2400
())

87 
	`ixp2000_ªÀa£_¶owp‹t
(&
ﬁd_cfg
);

89 
	}
}

91 
	$ixdp2x00_úq_unmask
(
úq
)

93 
dummy
;

94 
¶owp‹t_cfg
 
ﬁd_cfg
;

96 #ifde‡
CONFIG_ARCH_IXDP2400


97 i‡(
	`machöe_is_ixdp2400
())

98 
	`ixp2000_acquúe_¶owp‹t
(&
¶owp‹t_˝ld_cfg
, &
ﬁd_cfg
);

101 
dummy
 = *
bﬂrd_úq_mask
;

102 
dummy
 &~
	`IXP2000_BOARD_IRQ_MASK
(
úq
);

103 
	`ixp2000_ªg_wrb
(
bﬂrd_úq_mask
, 
dummy
);

105 i‡(
	`machöe_is_ixdp2400
())

106 
	`ixp2000_ªÀa£_¶owp‹t
(&
ﬁd_cfg
);

107 
	}
}

109 
	$ixdp2x00_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

111 vﬁ©ûê
u32
 
ex_öãºu±
 = 0;

112 
¶owp‹t_cfg
 
ﬁd_cfg
;

113 
i
;

115 
desc
->
chù
->
	`mask
(
úq
);

117 #ifde‡
CONFIG_ARCH_IXDP2400


118 i‡(
	`machöe_is_ixdp2400
())

119 
	`ixp2000_acquúe_¶owp‹t
(&
¶owp‹t_˝ld_cfg
, &
ﬁd_cfg
);

121 
ex_öãºu±
 = *
bﬂrd_úq_°©
 & 0xff;

122 i‡(
	`machöe_is_ixdp2400
())

123 
	`ixp2000_ªÀa£_¶owp‹t
(&
ﬁd_cfg
);

125 if(!
ex_öãºu±
) {

126 
	`¥ötk
(
KERN_ERR
 "Spurious IXDP2x00 CPLD interrupt!\n");

130 
i
 = 0; i < 
bﬂrd_úq_cou¡
; i++) {

131 if(
ex_öãºu±
 & (1 << 
i
)) {

132 
úq_desc
 *
˝ld_desc
;

133 
˝ld_úq
 = 
	`IXP2000_BOARD_IRQ
(0Ë+ 
i
;

134 
˝ld_desc
 = 
úq_desc
 + 
˝ld_úq
;

135 
	`desc_h™dÀ_úq
(
˝ld_úq
, 
˝ld_desc
);

139 
desc
->
chù
->
	`unmask
(
úq
);

140 
	}
}

142 
úq_chù
 
	gixdp2x00_˝ld_úq_chù
 = {

143 .
ack
 = 
ixdp2x00_úq_mask
,

144 .
	gmask
 = 
ixdp2x00_úq_mask
,

145 .
	gunmask
 = 
ixdp2x00_úq_unmask


148 
__öô
 
	$ixdp2x00_öô_úq
(vﬁ©ûê*
°©_ªg
, vﬁ©ûê*
mask_ªg
, 
ƒ_úqs
)

150 
úq
;

152 
	`ixp2000_öô_úq
();

154 i‡(!
	`ixdp2x00_ma°î_≈u
())

157 
bﬂrd_úq_°©
 = 
°©_ªg
;

158 
bﬂrd_úq_mask
 = 
mask_ªg
;

159 
bﬂrd_úq_cou¡
 = 
ƒ_úqs
;

161 *
bﬂrd_úq_mask
 = 0xffffffff;

163 
úq
 = 
	`IXP2000_BOARD_IRQ
(0); irq < IXP2000_BOARD_IRQ(
bﬂrd_úq_cou¡
); irq++) {

164 
	`£t_úq_chù
(
úq
, &
ixdp2x00_˝ld_úq_chù
);

165 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

166 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

170 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP2000_PCIB
, 
ixdp2x00_úq_h™dÀr
);

171 
	}
}

176 
m≠_desc
 
ixdp2x00_io_desc
 
	g__öôd©a
 = {

177 .
vútuÆ
 = 
IXDP2X00_VIRT_CPLD_BASE
,

178 .
	gp‚
 = 
__phys_to_p‚
(
IXDP2X00_PHYS_CPLD_BASE
),

179 .
	gÀngth
 = 
IXDP2X00_CPLD_SIZE
,

180 .
	gty≥
 = 
MT_DEVICE


183 
__öô
 
	$ixdp2x00_m≠_io
()

185 
	`ixp2000_m≠_io
();

187 
	`iŸabÀ_öô
(&
ixdp2x00_io_desc
, 1);

188 
	}
}

237 
	$ixdp2x00_¶ave_pci_po°öô
()

239 
pci_dev
 *
dev
;

244 if((
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(1, 
IXDP2X00_PMC_DEVFN
))) {

245 
	`pci_ªmove_bus_devi˚
(
dev
);

246 
	`pci_dev_put
(
dev
);

249 
dev
 = 
	`pci_gë_bus_™d_¶Ÿ
(0, 
IXDP2X00_21555_DEVFN
);

250 
	`pci_ªmove_bus_devi˚
(
dev
);

251 
	`pci_dev_put
(
dev
);

252 
	}
}

257 
Êash_∂©f‹m_d©a
 
	gixdp2x00_∂©f‹m_d©a
 = {

258 .
m≠_«me
 = "cfi_probe",

259 .
	gwidth
 = 1,

262 
ixp2000_Êash_d©a
 
	gixdp2x00_Êash_d©a
 = {

263 .
∂©f‹m_d©a
 = &
ixdp2x00_∂©f‹m_d©a
,

264 .
	gƒ_b™ks
 = 1

267 
ªsour˚
 
	gixdp2x00_Êash_ªsour˚
 = {

268 .
°¨t
 = 0xc4000000,

269 .
	gíd
 = 0xc4000000 + 0x00ffffff,

270 .
	gÊags
 = 
IORESOURCE_MEM
,

273 
∂©f‹m_devi˚
 
	gixdp2x00_Êash
 = {

274 .
«me
 = "IXP2000-Flash",

275 .
	gid
 = 0,

276 .
	gdev
 = {

277 .
∂©f‹m_d©a
 = &
ixdp2x00_Êash_d©a
,

279 .
	gnum_ªsour˚s
 = 1,

280 .
	gªsour˚
 = &
ixdp2x00_Êash_ªsour˚
,

283 
ixp2000_i2c_pös
 
	gixdp2x00_i2c_gpio_pös
 = {

284 .
sda_pö
 = 
IXDP2X00_GPIO_SDA
,

285 .
	gs˛_pö
 = 
IXDP2X00_GPIO_SCL
,

288 
∂©f‹m_devi˚
 
	gixdp2x00_i2c_c⁄åﬁÀr
 = {

289 .
«me
 = "IXP2000-I2C",

290 .
	gid
 = 0,

291 .
	gdev
 = {

292 .
∂©f‹m_d©a
 = &
ixdp2x00_i2c_gpio_pös
,

294 .
	gnum_ªsour˚s
 = 0

297 
∂©f‹m_devi˚
 *
	gixdp2x00_devi˚s
[] 
	g__öôd©a
 = {

298 &
ixdp2x00_Êash
,

299 &
ixdp2x00_i2c_c⁄åﬁÀr


302 
__öô
 
	$ixdp2x00_öô_machöe
()

304 
	`gpio_löe_£t
(
IXDP2X00_GPIO_I2C_ENABLE
, 1);

305 
	`gpio_löe_c⁄fig
(
IXDP2X00_GPIO_I2C_ENABLE
, 
GPIO_OUT
);

307 
	`∂©f‹m_add_devi˚s
(
ixdp2x00_devi˚s
, 
	`ARRAY_SIZE
(ixdp2x00_devices));

308 
	`ixp2000_u¨t_öô
();

309 
	}
}

	@arch/arm/mach-ixp2000/ixdp2x01.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/sched.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/pci.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/dñay.h
>

28 
	~<löux/£rül.h
>

29 
	~<löux/ây.h
>

30 
	~<löux/£rül_c‹e.h
>

31 
	~<löux/∂©f‹m_devi˚.h
>

32 
	~<löux/£rül_8250.h
>

34 
	~<asm/io.h
>

35 
	~<asm/úq.h
>

36 
	~<asm/pgèbÀ.h
>

37 
	~<asm/∑ge.h
>

38 
	~<asm/sy°em.h
>

39 
	~<asm/h¨dw¨e.h
>

40 
	~<asm/mach-ty≥s.h
>

42 
	~<asm/mach/pci.h
>

43 
	~<asm/mach/m≠.h
>

44 
	~<asm/mach/úq.h
>

45 
	~<asm/mach/time.h
>

46 
	~<asm/mach/¨ch.h
>

47 
	~<asm/mach/Êash.h
>

52 
	$ixdp2x01_úq_mask
(
úq
)

54 
	`ixp2000_ªg_wrb
(
IXDP2X01_INT_MASK_SET_REG
,

55 
	`IXP2000_BOARD_IRQ_MASK
(
úq
));

56 
	}
}

58 
	$ixdp2x01_úq_unmask
(
úq
)

60 
	`ixp2000_ªg_wrôe
(
IXDP2X01_INT_MASK_CLR_REG
,

61 
	`IXP2000_BOARD_IRQ_MASK
(
úq
));

62 
	}
}

64 
u32
 
	gvÆid_úq_mask
;

66 
	$ixdp2x01_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

68 
u32
 
ex_öãºu±
;

69 
i
;

71 
desc
->
chù
->
	`mask
(
úq
);

73 
ex_öãºu±
 = *
IXDP2X01_INT_STAT_REG
 & 
vÆid_úq_mask
;

75 i‡(!
ex_öãºu±
) {

76 
	`¥ötk
(
KERN_ERR
 "Spurious IXDP2X01 CPLD interrupt!\n");

80 
i
 = 0; i < 
IXP2000_BOARD_IRQS
; i++) {

81 i‡(
ex_öãºu±
 & (1 << 
i
)) {

82 
úq_desc
 *
˝ld_desc
;

83 
˝ld_úq
 = 
	`IXP2000_BOARD_IRQ
(0Ë+ 
i
;

84 
˝ld_desc
 = 
úq_desc
 + 
˝ld_úq
;

85 
	`desc_h™dÀ_úq
(
˝ld_úq
, 
˝ld_desc
);

89 
desc
->
chù
->
	`unmask
(
úq
);

90 
	}
}

92 
úq_chù
 
	gixdp2x01_úq_chù
 = {

93 .
mask
 = 
ixdp2x01_úq_mask
,

94 .
	gack
 = 
ixdp2x01_úq_mask
,

95 .
	gunmask
 = 
ixdp2x01_úq_unmask


103 
__öô
 
	$ixdp2x01_öô_úq
()

105 
úq
 = 0;

108 
	`ixp2000_öô_úq
();

110 i‡(
	`machöe_is_ixdp2401
())

111 
vÆid_úq_mask
 = 
IXDP2401_VALID_IRQ_MASK
;

113 
vÆid_úq_mask
 = 
IXDP2801_VALID_IRQ_MASK
;

116 
	`ixp2000_ªg_wrôe
(
IXDP2X01_INT_MASK_SET_REG
, 0xffffffff);

117 
	`ixp2000_ªg_wrb
(
IXDP2X01_INT_SIM_REG
, 0);

119 
úq
 = 
NR_IXP2000_IRQS
; irq < 
NR_IXDP2X01_IRQS
; irq++) {

120 i‡(
úq
 & 
vÆid_úq_mask
) {

121 
	`£t_úq_chù
(
úq
, &
ixdp2x01_úq_chù
);

122 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

123 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

125 
	`£t_úq_Êags
(
úq
, 0);

130 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP2000_PCIB
, 
ixdp2x01_úq_h™dÀr
);

131 
	}
}

137 
m≠_desc
 
ixdp2x01_io_desc
 
	g__öôd©a
 = {

138 .
vútuÆ
 = 
IXDP2X01_VIRT_CPLD_BASE
,

139 .
	gp‚
 = 
__phys_to_p‚
(
IXDP2X01_PHYS_CPLD_BASE
),

140 .
	gÀngth
 = 
IXDP2X01_CPLD_REGION_SIZE
,

141 .
	gty≥
 = 
MT_DEVICE


144 
__öô
 
	$ixdp2x01_m≠_io
()

146 
	`ixp2000_m≠_io
();

147 
	`iŸabÀ_öô
(&
ixdp2x01_io_desc
, 1);

148 
	}
}

154 
∂©_£rül8250_p‹t
 
	gixdp2x01_£rül_p‹t1
[] = {

156 .
m≠ba£
 = ()
IXDP2X01_UART1_PHYS_BASE
,

157 .
	gmemba£
 = (*)
IXDP2X01_UART1_VIRT_BASE
,

158 .
	gúq
 = 
IRQ_IXDP2X01_UART1
,

159 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

160 .
	giŸy≥
 = 
UPIO_MEM32
,

161 .
	gªgshi·
 = 2,

162 .
	gu¨t˛k
 = 
IXDP2X01_UART_CLK
,

167 
ªsour˚
 
	gixdp2x01_u¨t_ªsour˚1
 = {

168 .
°¨t
 = 
IXDP2X01_UART1_PHYS_BASE
,

169 .
	gíd
 = 
IXDP2X01_UART1_PHYS_BASE
 + 0xffff,

170 .
	gÊags
 = 
IORESOURCE_MEM
,

173 
∂©f‹m_devi˚
 
	gixdp2x01_£rül_devi˚1
 = {

174 .
«me
 = "serial8250",

175 .
	gid
 = 
PLAT8250_DEV_PLATFORM1
,

176 .
	gdev
 = {

177 .
∂©f‹m_d©a
 = 
ixdp2x01_£rül_p‹t1
,

179 .
	gnum_ªsour˚s
 = 1,

180 .
	gªsour˚
 = &
ixdp2x01_u¨t_ªsour˚1
,

183 
∂©_£rül8250_p‹t
 
	gixdp2x01_£rül_p‹t2
[] = {

185 .
m≠ba£
 = ()
IXDP2X01_UART2_PHYS_BASE
,

186 .
	gmemba£
 = (*)
IXDP2X01_UART2_VIRT_BASE
,

187 .
	gúq
 = 
IRQ_IXDP2X01_UART2
,

188 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

189 .
	giŸy≥
 = 
UPIO_MEM32
,

190 .
	gªgshi·
 = 2,

191 .
	gu¨t˛k
 = 
IXDP2X01_UART_CLK
,

196 
ªsour˚
 
	gixdp2x01_u¨t_ªsour˚2
 = {

197 .
°¨t
 = 
IXDP2X01_UART2_PHYS_BASE
,

198 .
	gíd
 = 
IXDP2X01_UART2_PHYS_BASE
 + 0xffff,

199 .
	gÊags
 = 
IORESOURCE_MEM
,

202 
∂©f‹m_devi˚
 
	gixdp2x01_£rül_devi˚2
 = {

203 .
«me
 = "serial8250",

204 .
	gid
 = 
PLAT8250_DEV_PLATFORM2
,

205 .
	gdev
 = {

206 .
∂©f‹m_d©a
 = 
ixdp2x01_£rül_p‹t2
,

208 .
	gnum_ªsour˚s
 = 1,

209 .
	gªsour˚
 = &
ixdp2x01_u¨t_ªsour˚2
,

212 
	$ixdp2x01_u¨t_öô
()

214 
	`∂©f‹m_devi˚_ªgi°î
(&
ixdp2x01_£rül_devi˚1
);

215 
	`∂©f‹m_devi˚_ªgi°î
(&
ixdp2x01_£rül_devi˚2
);

216 
	}
}

222 
	gixdp2x01_˛ock
;

224 
__öô
 
	$ixdp2x01_˛ock_£tup
(*
°r
)

226 
ixdp2x01_˛ock
 = 
	`sim∂e_°πoul
(
°r
, 
NULL
, 10);

229 
	}
}

231 
__£tup
("ixdp2x01_˛ock=", 
ixdp2x01_˛ock_£tup
);

233 
__öô
 
	$ixdp2x01_timî_öô
()

235 i‡(!
ixdp2x01_˛ock
)

236 
ixdp2x01_˛ock
 = 50000000;

238 
	`ixp2000_öô_time
(
ixdp2x01_˛ock
);

239 
	}
}

241 
sys_timî
 
	gixdp2x01_timî
 = {

242 .
öô
 = 
ixdp2x01_timî_öô
,

243 .
	goff£t
 = 
ixp2000_gëtimeoff£t
,

249 
__öô
 
	$ixdp2x01_pci_¥eöô
()

251 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_ADDR_EXT
, 0x00000000);

252 
	`ixp2000_pci_¥eöô
();

253 
	`pcibios_£tup
("firmware");

254 
	}
}

256 
	#DEVPIN
(
dev
, 
pö
Ë(’öË| ((devË<< 3))

	)

258 
__öô
 
	$ixdp2x01_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

260 
u8
 
bus
 = 
dev
->bus->
numbî
;

261 
u32
 
devpö
 = 
	`DEVPIN
(
	`PCI_SLOT
(
dev
->
dev‚
), 
pö
);

262 
pci_bus
 *
tmp_bus
 = 
dev
->
bus
;

265 i‡(
bus
 == 0) {

270 (
tmp_bus
->
∑ª¡
 !
NULL
) && (tmp_bus->parent->parent != NULL)) {

271 
tmp_bus
 =Åmp_bus->
∑ª¡
;

275 
tmp_bus
->
£lf
->
dev‚
 | (tmp_bus->£lf->
bus
->
numbî
 << 8)) {

278 i‡(
tmp_bus
 =
dev
->
bus
) {

280 
devpö
) {

281 
	`DEVPIN
(1, 1):

282 i‡(
	`machöe_is_ixdp2401
())

283  
IRQ_IXDP2401_INTA_82546
;

285 
	`DEVPIN
(1, 2):

286 i‡(
	`machöe_is_ixdp2401
())

287  
IRQ_IXDP2401_INTB_82546
;

289 
	`DEVPIN
(0, 1):

290  
IRQ_IXDP2X01_SPCI_PMC_INTA
;

291 
	`DEVPIN
(0, 2):

292  
IRQ_IXDP2X01_SPCI_PMC_INTB
;

293 
	`DEVPIN
(0, 3):

294  
IRQ_IXDP2X01_SPCI_PMC_INTC
;

295 
	`DEVPIN
(0, 4):

296  
IRQ_IXDP2X01_SPCI_PMC_INTD
;

301 i‡(
tmp_bus
 =
dev
->
bus
) {

304 
devpö
) {

305 
	`DEVPIN
(0, 1):

306  
IRQ_IXDP2X01_SPCI_DB_0
;

307 
	`DEVPIN
(1, 1):

308  
IRQ_IXDP2X01_SPCI_DB_1
;

318 
	}
}

321 
	$ixdp2x01_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

323 
sys
->
mem_off£t
 = 0xe0000000;

325 i‡(
	`machöe_is_ixdp2801
(Ë|| 
	`machöe_is_ixdp28x5
())

326 
sys
->
mem_off£t
 -((*
IXP2000_PCI_ADDR_EXT
 & 0xE000) << 16);

328  
	`ixp2000_pci_£tup
(
ƒ
, 
sys
);

329 
	}
}

331 
hw_pci
 
ixdp2x01_pci
 
	g__öôd©a
 = {

332 .
ƒ_c⁄åﬁÀrs
 = 1,

333 .
	g£tup
 = 
ixdp2x01_pci_£tup
,

334 .
	g¥eöô
 = 
ixdp2x01_pci_¥eöô
,

335 .
	gsˇn
 = 
ixp2000_pci_sˇn_bus
,

336 .
	gm≠_úq
 = 
ixdp2x01_pci_m≠_úq
,

339 
__öô
 
	$ixdp2x01_pci_öô
()

341 i‡(
	`machöe_is_ixdp2401
(Ë|| 
	`machöe_is_ixdp2801
() ||\

342 
	`machöe_is_ixdp28x5
())

343 
	`pci_comm⁄_öô
(&
ixdp2x01_pci
);

346 
	}
}

348 
subsys_öôˇŒ
(
ixdp2x01_pci_öô
);

353 
Êash_∂©f‹m_d©a
 
	gixdp2x01_Êash_∂©f‹m_d©a
 = {

354 .
m≠_«me
 = "cfi_probe",

355 .
	gwidth
 = 1,

358 
	$ixdp2x01_Êash_b™k_£tup
(
ofs
)

360 
	`ixp2000_ªg_wrb
(
IXDP2X01_CPLD_FLASH_REG
,

361 ((
ofs
 >> 
IXDP2X01_FLASH_WINDOW_BITS
Ë| 
IXDP2X01_CPLD_FLASH_INTERN
));

362  (
ofs
 & 
IXDP2X01_FLASH_WINDOW_MASK
);

363 
	}
}

365 
ixp2000_Êash_d©a
 
	gixdp2x01_Êash_d©a
 = {

366 .
∂©f‹m_d©a
 = &
ixdp2x01_Êash_∂©f‹m_d©a
,

367 .
	gb™k_£tup
 = 
ixdp2x01_Êash_b™k_£tup


370 
ªsour˚
 
	gixdp2x01_Êash_ªsour˚
 = {

371 .
°¨t
 = 0xc4000000,

372 .
	gíd
 = 0xc4000000 + 0x01ffffff,

373 .
	gÊags
 = 
IORESOURCE_MEM
,

376 
∂©f‹m_devi˚
 
	gixdp2x01_Êash
 = {

377 .
«me
 = "IXP2000-Flash",

378 .
	gid
 = 0,

379 .
	gdev
 = {

380 .
∂©f‹m_d©a
 = &
ixdp2x01_Êash_d©a
,

382 .
	gnum_ªsour˚s
 = 1,

383 .
	gªsour˚
 = &
ixdp2x01_Êash_ªsour˚
,

386 
ixp2000_i2c_pös
 
	gixdp2x01_i2c_gpio_pös
 = {

387 .
sda_pö
 = 
IXDP2X01_GPIO_SDA
,

388 .
	gs˛_pö
 = 
IXDP2X01_GPIO_SCL
,

391 
∂©f‹m_devi˚
 
	gixdp2x01_i2c_c⁄åﬁÀr
 = {

392 .
«me
 = "IXP2000-I2C",

393 .
	gid
 = 0,

394 .
	gdev
 = {

395 .
∂©f‹m_d©a
 = &
ixdp2x01_i2c_gpio_pös
,

397 .
	gnum_ªsour˚s
 = 0

400 
∂©f‹m_devi˚
 *
	gixdp2x01_devi˚s
[] 
	g__öôd©a
 = {

401 &
ixdp2x01_Êash
,

402 &
ixdp2x01_i2c_c⁄åﬁÀr


405 
__öô
 
	$ixdp2x01_öô_machöe
()

407 
	`ixp2000_ªg_wrb
(
IXDP2X01_CPLD_FLASH_REG
,

408 (
IXDP2X01_CPLD_FLASH_BANK_MASK
 | 
IXDP2X01_CPLD_FLASH_INTERN
));

410 
ixdp2x01_Êash_d©a
.
ƒ_b™ks
 =

411 ((*
IXDP2X01_CPLD_FLASH_REG
 & 
IXDP2X01_CPLD_FLASH_BANK_MASK
) + 1);

413 
	`∂©f‹m_add_devi˚s
(
ixdp2x01_devi˚s
, 
	`ARRAY_SIZE
(ixdp2x01_devices));

414 
	`ixp2000_u¨t_öô
();

415 
	`ixdp2x01_u¨t_öô
();

416 
	}
}

419 #ifde‡
CONFIG_ARCH_IXDP2401


420 
MACHINE_START
(
IXDP2401
, "Intel IXDP2401 Development Platform")

422 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

423 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

424 .
	gboŸ_∑øms
 = 0x00000100,

425 .
	gm≠_io
 = 
ixdp2x01_m≠_io
,

426 .
	göô_úq
 = 
ixdp2x01_öô_úq
,

427 .
	gtimî
 = &
ixdp2x01_timî
,

428 .
	göô_machöe
 = 
ixdp2x01_öô_machöe
,

429 
	gMACHINE_END


432 #ifde‡
CONFIG_ARCH_IXDP2801


433 
MACHINE_START
(
IXDP2801
, "Intel IXDP2801 Development Platform")

435 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

436 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

437 .
	gboŸ_∑øms
 = 0x00000100,

438 .
	gm≠_io
 = 
ixdp2x01_m≠_io
,

439 .
	göô_úq
 = 
ixdp2x01_öô_úq
,

440 .
	gtimî
 = &
ixdp2x01_timî
,

441 .
	göô_machöe
 = 
ixdp2x01_öô_machöe
,

442 
MACHINE_END


448 
MACHINE_START
(
IXDP28X5
, "Intel IXDP2805/2855 Development Platform")

450 .
	gphys_io
 = 
IXP2000_UART_PHYS_BASE
,

451 .
	gio_pg_off°
 = ((
IXP2000_UART_VIRT_BASE
) >> 18) & 0xfffc,

452 .
	gboŸ_∑øms
 = 0x00000100,

453 .
	gm≠_io
 = 
ixdp2x01_m≠_io
,

454 .
	göô_úq
 = 
ixdp2x01_öô_úq
,

455 .
	gtimî
 = &
ixdp2x01_timî
,

456 .
	göô_machöe
 = 
ixdp2x01_öô_machöe
,

457 
	gMACHINE_END


	@arch/arm/mach-ixp2000/pci.c

18 
	~<löux/sched.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/pci.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/mm.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/dñay.h
>

28 
	~<asm/io.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/sy°em.h
>

31 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/mach/pci.h
>

35 vﬁ©ûê
	gpci_ma°î_ab‹ts
 = 0;

37 
˛ór_ma°î_ab‹ts
();

39 
u32
 *

40 
	$ixp2000_pci_c⁄fig_addr
(
bus_ƒ
, 
dev‚
, 
whîe
)

42 
u32
 *
∑ddªss
;

44 i‡(
	`PCI_SLOT
(
dev‚
) > 7)

48 
whîe
 &= ~3;

53 i‡(!
bus_ƒ
) {

55 
∑ddªss
 = (
u32
 *Ë(
IXP2000_PCI_CFG0_VIRT_BASE


56 | (1 << (
	`PCI_SLOT
(
dev‚
) + 16))

57 | (
	`PCI_FUNC
(
dev‚
Ë<< 8Ë| 
whîe
);

59 
∑ddªss
 = (
u32
 *Ë(
IXP2000_PCI_CFG1_VIRT_BASE


60 | (
bus_ƒ
 << 16)

61 | (
	`PCI_SLOT
(
dev‚
) << 11)

62 | (
	`PCI_FUNC
(
dev‚
Ë<< 8Ë| 
whîe
);

65  
∑ddªss
;

66 
	}
}

72 
u32
 
	gbyãmask
[] = {

81 
	$ixp2000_pci_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

82 
size
, 
u32
 *
vÆue
)

84 
u32
 
n
;

85 
u32
 *
addr
;

87 
n
 = 
whîe
 % 4;

89 
addr
 = 
	`ixp2000_pci_c⁄fig_addr
(
bus
->
numbî
, 
dev‚
, 
whîe
);

90 i‡(!
addr
)

91  
PCIBIOS_DEVICE_NOT_FOUND
;

93 
pci_ma°î_ab‹ts
 = 0;

94 *
vÆue
 = (*
addr
 >> (8*
n
)Ë& 
byãmask
[
size
];

95 i‡(
pci_ma°î_ab‹ts
) {

96 
pci_ma°î_ab‹ts
 = 0;

97 *
vÆue
 = 0xffffffff;

98  
PCIBIOS_DEVICE_NOT_FOUND
;

101  
PCIBIOS_SUCCESSFUL
;

102 
	}
}

109 
	$ixp2000_pci_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
,

110 
size
, 
u32
 
vÆue
)

112 
u32
 
mask
;

113 
u32
 *
addr
;

114 
u32
 
ãmp
;

116 
mask
 = ~(
byãmask
[
size
] << ((
whîe
 % 0x4) * 8));

117 
addr
 = 
	`ixp2000_pci_c⁄fig_addr
(
bus
->
numbî
, 
dev‚
, 
whîe
);

118 i‡(!
addr
)

119  
PCIBIOS_DEVICE_NOT_FOUND
;

120 
ãmp
 = (
u32
Ë(
vÆue
Ë<< ((
whîe
 % 0x4) * 8);

121 *
addr
 = (*add∏& 
mask
Ë| 
ãmp
;

123 
	`˛ór_ma°î_ab‹ts
();

125  
PCIBIOS_SUCCESSFUL
;

126 
	}
}

129 
pci_›s
 
	gixp2000_pci_›s
 = {

130 .
ªad
 = 
ixp2000_pci_ªad_c⁄fig
,

131 .
	gwrôe
 = 
ixp2000_pci_wrôe_c⁄fig


134 
pci_bus
 *
	$ixp2000_pci_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sysd©a
)

136  
	`pci_sˇn_bus
(
sysd©a
->
bu¢r
, &
ixp2000_pci_›s
, sysdata);

137 
	}
}

140 
	$ixp2000_pci_ab‹t_h™dÀr
(
addr
, 
f§
, 
±_ªgs
 *
ªgs
)

143 vﬁ©ûê
u32
 
ãmp
;

144 
Êags
;

146 
pci_ma°î_ab‹ts
 = 1;

148 
	`loˇl_úq_ßve
(
Êags
);

149 
ãmp
 = *(
IXP2000_PCI_CONTROL
);

150 i‡(
ãmp
 & ((1 << 8) | (1 << 5))) {

151 
	`ixp2000_ªg_wrb
(
IXP2000_PCI_CONTROL
, 
ãmp
);

154 
ãmp
 = *(
IXP2000_PCI_CMDSTAT
);

155 i‡(
ãmp
 & (1 << 29)) {

156 
ãmp
 & (1 << 29)) {

157 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_CMDSTAT
, 
ãmp
);

158 
ãmp
 = *(
IXP2000_PCI_CMDSTAT
);

161 
	`loˇl_úq_ª°‹e
(
Êags
);

167 i‡(
f§
 & (1 << 10))

168 
ªgs
->
ARM_pc
 += 4;

171 
	}
}

174 
	$˛ór_ma°î_ab‹ts
()

176 vﬁ©ûê
u32
 
ãmp
;

177 
Êags
;

179 
	`loˇl_úq_ßve
(
Êags
);

180 
ãmp
 = *(
IXP2000_PCI_CONTROL
);

181 i‡(
ãmp
 & ((1 << 8) | (1 << 5))) {

182 
	`ixp2000_ªg_wrb
(
IXP2000_PCI_CONTROL
, 
ãmp
);

185 
ãmp
 = *(
IXP2000_PCI_CMDSTAT
);

186 i‡(
ãmp
 & (1 << 29)) {

187 
ãmp
 & (1 << 29)) {

188 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_CMDSTAT
, 
ãmp
);

189 
ãmp
 = *(
IXP2000_PCI_CMDSTAT
);

192 
	`loˇl_úq_ª°‹e
(
Êags
);

195 
	}
}

197 
__öô


198 
	$ixp2000_pci_¥eöô
()

200 #i‚de‡
CONFIG_IXP2000_SUPPORT_BROKEN_PCI_IO


205 
	`ixp2000_ªg_wrôe
(
IXP2000_PCI_CONTROL
,

206 (*
IXP2000_PCI_CONTROL
 | 
PCI_CONTROL_IEE
));

208 i‡((*
IXP2000_PCI_CONTROL
 & 
PCI_CONTROL_IEE
) == 0)

209 
	`∑nic
("IXP2000: PCI I/O is broken onÅhis ixp model,ánd "

213 
	`hook_Áu…_code
(16+6, 
ixp2000_pci_ab‹t_h™dÀr
, 
SIGBUS
,

215 
	}
}

222 
ªsour˚
 
	gixp2000_pci_mem_•a˚
 = {

223 .
°¨t
 = 0xe0000000,

224 .
	gíd
 = 0xffffffff,

225 .
	gÊags
 = 
IORESOURCE_MEM
,

226 .
	g«me
 = "PCI Mem Space"

229 
ªsour˚
 
	gixp2000_pci_io_•a˚
 = {

230 .
°¨t
 = 0x00010000,

231 .
	gíd
 = 0x0001ffff,

232 .
	gÊags
 = 
IORESOURCE_IO
,

233 .
	g«me
 = "PCI I/O Space"

236 
	$ixp2000_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

238 i‡(
ƒ
 >= 1)

241 
sys
->
ªsour˚
[0] = &
ixp2000_pci_io_•a˚
;

242 
sys
->
ªsour˚
[1] = &
ixp2000_pci_mem_•a˚
;

243 
sys
->
ªsour˚
[2] = 
NULL
;

246 
	}
}

	@arch/arm/mach-ixp23xx/core.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/£rül.h
>

23 
	~<löux/ây.h
>

24 
	~<löux/bô›s.h
>

25 
	~<löux/£rül.h
>

26 
	~<löux/£rül_8250.h
>

27 
	~<löux/£rül_c‹e.h
>

28 
	~<löux/devi˚.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/time.h
>

31 
	~<löux/timex.h
>

33 
	~<asm/ty≥s.h
>

34 
	~<asm/£tup.h
>

35 
	~<asm/mem‹y.h
>

36 
	~<asm/h¨dw¨e.h
>

37 
	~<asm/mach-ty≥s.h
>

38 
	~<asm/úq.h
>

39 
	~<asm/sy°em.h
>

40 
	~<asm/ébÊush.h
>

41 
	~<asm/pgèbÀ.h
>

43 
	~<asm/mach/m≠.h
>

44 
	~<asm/mach/time.h
>

45 
	~<asm/mach/úq.h
>

46 
	~<asm/mach/¨ch.h
>

52 
m≠_desc
 
	gixp23xx_io_desc
[] 
	g__öôd©a
 = {

54 .
vútuÆ
 = 
IXP23XX_XSI2CPP_CSR_VIRT
,

55 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_XSI2CPP_CSR_PHYS
),

56 .
	gÀngth
 = 
IXP23XX_XSI2CPP_CSR_SIZE
,

57 .
	gty≥
 = 
MT_DEVICE
,

59 .
	gvútuÆ
 = 
IXP23XX_EXP_CFG_VIRT
,

60 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_EXP_CFG_PHYS
),

61 .
	gÀngth
 = 
IXP23XX_EXP_CFG_SIZE
,

62 .
	gty≥
 = 
MT_DEVICE
,

64 .
	gvútuÆ
 = 
IXP23XX_PERIPHERAL_VIRT
,

65 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_PERIPHERAL_PHYS
),

66 .
	gÀngth
 = 
IXP23XX_PERIPHERAL_SIZE
,

67 .
	gty≥
 = 
MT_DEVICE
,

69 .
	gvútuÆ
 = 
IXP23XX_CAP_CSR_VIRT
,

70 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_CAP_CSR_PHYS
),

71 .
	gÀngth
 = 
IXP23XX_CAP_CSR_SIZE
,

72 .
	gty≥
 = 
MT_DEVICE
,

74 .
	gvútuÆ
 = 
IXP23XX_MSF_CSR_VIRT
,

75 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_MSF_CSR_PHYS
),

76 .
	gÀngth
 = 
IXP23XX_MSF_CSR_SIZE
,

77 .
	gty≥
 = 
MT_DEVICE
,

79 .
	gvútuÆ
 = 
IXP23XX_PCI_IO_VIRT
,

80 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_PCI_IO_PHYS
),

81 .
	gÀngth
 = 
IXP23XX_PCI_IO_SIZE
,

82 .
	gty≥
 = 
MT_DEVICE
,

84 .
	gvútuÆ
 = 
IXP23XX_PCI_CFG_VIRT
,

85 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_PCI_CFG_PHYS
),

86 .
	gÀngth
 = 
IXP23XX_PCI_CFG_SIZE
,

87 .
	gty≥
 = 
MT_DEVICE
,

89 .
	gvútuÆ
 = 
IXP23XX_PCI_CREG_VIRT
,

90 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_PCI_CREG_PHYS
),

91 .
	gÀngth
 = 
IXP23XX_PCI_CREG_SIZE
,

92 .
	gty≥
 = 
MT_DEVICE
,

94 .
	gvútuÆ
 = 
IXP23XX_PCI_MEM_VIRT
,

95 .
	gp‚
 = 
__phys_to_p‚
(
IXP23XX_PCI_MEM_PHYS
),

96 .
	gÀngth
 = 
IXP23XX_PCI_MEM_SIZE
,

97 .
	gty≥
 = 
MT_DEVICE
,

101 
__öô
 
	$ixp23xx_m≠_io
()

103 
	`iŸabÀ_öô
(
ixp23xx_io_desc
, 
	`ARRAY_SIZE
(ixp23xx_io_desc));

104 
	}
}

110 
	eixp23xx_úq_ty≥
 {

111 
	mIXP23XX_IRQ_LEVEL
, 
	mIXP23XX_IRQ_EDGE


114 
ixp23xx_c⁄fig_úq
(, 
ixp23xx_úq_ty≥
);

116 
	$ixp23xx_úq_£t_ty≥
(
úq
, 
ty≥
)

118 
löe
 = 
úq
 - 
IRQ_IXP23XX_GPIO6
 + 6;

119 
u32
 
öt_°yÀ
;

120 
ixp23xx_úq_ty≥
 
úq_ty≥
;

121 vﬁ©ûê
u32
 *
öt_ªg
;

126 i‡(
löe
 < 6 ||Üine > 15)

127  -
EINVAL
;

129 
ty≥
) {

130 
IRQT_BOTHEDGE
:

131 
öt_°yÀ
 = 
IXP23XX_GPIO_STYLE_TRANSITIONAL
;

132 
úq_ty≥
 = 
IXP23XX_IRQ_EDGE
;

134 
IRQT_RISING
:

135 
öt_°yÀ
 = 
IXP23XX_GPIO_STYLE_RISING_EDGE
;

136 
úq_ty≥
 = 
IXP23XX_IRQ_EDGE
;

138 
IRQT_FALLING
:

139 
öt_°yÀ
 = 
IXP23XX_GPIO_STYLE_FALLING_EDGE
;

140 
úq_ty≥
 = 
IXP23XX_IRQ_EDGE
;

142 
IRQT_HIGH
:

143 
öt_°yÀ
 = 
IXP23XX_GPIO_STYLE_ACTIVE_HIGH
;

144 
úq_ty≥
 = 
IXP23XX_IRQ_LEVEL
;

146 
IRQT_LOW
:

147 
öt_°yÀ
 = 
IXP23XX_GPIO_STYLE_ACTIVE_LOW
;

148 
úq_ty≥
 = 
IXP23XX_IRQ_LEVEL
;

151  -
EINVAL
;

154 
	`ixp23xx_c⁄fig_úq
(
úq
, 
úq_ty≥
);

156 i‡(
löe
 >= 8) {

157 
löe
 -= 8;

158 
öt_ªg
 = (vﬁ©ûê
u32
 *)
IXP23XX_GPIO_GPIT2R
;

160 
öt_ªg
 = (vﬁ©ûê
u32
 *)
IXP23XX_GPIO_GPIT1R
;

166 *
IXP23XX_GPIO_GPISR
 = (1 << 
löe
);

169 *
öt_ªg
 &~(
IXP23XX_GPIO_STYLE_MASK
 <<

170 (
löe
 * 
IXP23XX_GPIO_STYLE_SIZE
));

173 *
öt_ªg
 |(
öt_°yÀ
 << (
löe
 * 
IXP23XX_GPIO_STYLE_SIZE
));

176 
	}
}

178 
	$ixp23xx_úq_mask
(
úq
)

180 vﬁ©ûê*
öå_ªg
;

182 i‡(
úq
 >= 56)

183 
úq
 += 8;

185 
öå_ªg
 = 
IXP23XX_INTR_EN1
 + (
úq
 / 32);

186 *
öå_ªg
 &~(1 << (
úq
 % 32));

187 
	}
}

189 
	$ixp23xx_úq_ack
(
úq
)

191 
löe
 = 
úq
 - 
IRQ_IXP23XX_GPIO6
 + 6;

193 i‡((
löe
 < 6) || (line > 15))

196 *
IXP23XX_GPIO_GPISR
 = (1 << 
löe
);

197 
	}
}

203 
	$ixp23xx_úq_Àvñ_unmask
(
úq
)

205 vﬁ©ûê*
öå_ªg
;

207 
	`ixp23xx_úq_ack
(
úq
);

209 i‡(
úq
 >= 56)

210 
úq
 += 8;

212 
öå_ªg
 = 
IXP23XX_INTR_EN1
 + (
úq
 / 32);

213 *
öå_ªg
 |(1 << (
úq
 % 32));

214 
	}
}

216 
	$ixp23xx_úq_edge_unmask
(
úq
)

218 vﬁ©ûê*
öå_ªg
;

220 i‡(
úq
 >= 56)

221 
úq
 += 8;

223 
öå_ªg
 = 
IXP23XX_INTR_EN1
 + (
úq
 / 32);

224 *
öå_ªg
 |(1 << (
úq
 % 32));

225 
	}
}

227 
úq_chù
 
	gixp23xx_úq_Àvñ_chù
 = {

228 .
ack
 = 
ixp23xx_úq_mask
,

229 .
	gmask
 = 
ixp23xx_úq_mask
,

230 .
	gunmask
 = 
ixp23xx_úq_Àvñ_unmask
,

231 .
	g£t_ty≥
 = 
ixp23xx_úq_£t_ty≥


234 
úq_chù
 
	gixp23xx_úq_edge_chù
 = {

235 .
ack
 = 
ixp23xx_úq_ack
,

236 .
	gmask
 = 
ixp23xx_úq_mask
,

237 .
	gunmask
 = 
ixp23xx_úq_edge_unmask
,

238 .
	g£t_ty≥
 = 
ixp23xx_úq_£t_ty≥


241 
	$ixp23xx_pci_úq_mask
(
úq
)

243 *
IXP23XX_PCI_XSCALE_INT_ENABLE
 &~(1 << (
IRQ_IXP23XX_INTA
 + 27 - 
úq
));

244 
	}
}

246 
	$ixp23xx_pci_úq_unmask
(
úq
)

248 *
IXP23XX_PCI_XSCALE_INT_ENABLE
 |(1 << (
IRQ_IXP23XX_INTA
 + 27 - 
úq
));

249 
	}
}

254 
	$pci_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

256 
u32
 
pci_öãºu±
;

257 
úqno
;

258 
úq_desc
 *
öt_desc
;

260 
pci_öãºu±
 = *
IXP23XX_PCI_XSCALE_INT_STATUS
;

262 
desc
->
chù
->
	`ack
(
úq
);

265 i‡(
pci_öãºu±
 & (1 << 26)) {

266 
úqno
 = 
IRQ_IXP23XX_INTB
;

267 } i‡(
pci_öãºu±
 & (1 << 27)) {

268 
úqno
 = 
IRQ_IXP23XX_INTA
;

270 
	`BUG
();

273 
öt_desc
 = 
úq_desc
 + 
úqno
;

274 
	`desc_h™dÀ_úq
(
úqno
, 
öt_desc
);

276 
desc
->
chù
->
	`unmask
(
úq
);

277 
	}
}

279 
úq_chù
 
	gixp23xx_pci_úq_chù
 = {

280 .
ack
 = 
ixp23xx_pci_úq_mask
,

281 .
	gmask
 = 
ixp23xx_pci_úq_mask
,

282 .
	gunmask
 = 
ixp23xx_pci_úq_unmask


285 
	$ixp23xx_c⁄fig_úq
(
úq
, 
ixp23xx_úq_ty≥
 
ty≥
)

287 
ty≥
) {

288 
IXP23XX_IRQ_LEVEL
:

289 
	`£t_úq_chù
(
úq
, &
ixp23xx_úq_Àvñ_chù
);

290 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

292 
IXP23XX_IRQ_EDGE
:

293 
	`£t_úq_chù
(
úq
, &
ixp23xx_úq_edge_chù
);

294 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

297 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

298 
	}
}

300 
__öô
 
	$ixp23xx_öô_úq
()

302 
úq
;

305 *
IXP23XX_INTR_SEL1
 = 0x0;

306 *
IXP23XX_INTR_SEL2
 = 0x0;

307 *
IXP23XX_INTR_SEL3
 = 0x0;

308 *
IXP23XX_INTR_SEL4
 = 0x0;

311 *
IXP23XX_INTR_EN1
 = 0x0;

312 *
IXP23XX_INTR_EN2
 = 0x0;

313 *
IXP23XX_INTR_EN3
 = 0x0;

314 *
IXP23XX_INTR_EN4
 = 0x0;

319 
úq
 = 0; irq <
NUM_IXP23XX_RAW_IRQS
; irq++) {

320 
	`ixp23xx_c⁄fig_úq
(
úq
, 
IXP23XX_IRQ_LEVEL
);

323 
úq
 = 
IRQ_IXP23XX_INTA
; irq <
IRQ_IXP23XX_INTB
; irq++) {

324 
	`£t_úq_chù
(
úq
, &
ixp23xx_pci_úq_chù
);

325 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

326 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

329 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP23XX_PCI_INT_RPH
, 
pci_h™dÀr
);

330 
	}
}

336 
	#CLOCK_TICKS_PER_USEC
 (
CLOCK_TICK_RATE
 / 
USEC_PER_SEC
)

	)

338 
	g√xt_jiffy_time
;

341 
	$ixp23xx_gëtimeoff£t
()

343 
ñ≠£d
;

345 
ñ≠£d
 = *
IXP23XX_TIMER_CONT
 - (
√xt_jiffy_time
 - 
LATCH
);

347  
ñ≠£d
 / 
CLOCK_TICKS_PER_USEC
;

348 
	}
}

350 
úqªtu∫_t


351 
	$ixp23xx_timî_öãºu±
(
úq
, *
dev_id
)

354 *
IXP23XX_TIMER_STATUS
 = 
IXP23XX_TIMER1_INT_PEND
;

355 (sig√d )(*
IXP23XX_TIMER_CONT
 - 
√xt_jiffy_time
Ë>
LATCH
) {

356 
	`timî_tick
();

357 
√xt_jiffy_time
 +
LATCH
;

360  
IRQ_HANDLED
;

361 
	}
}

363 
úqa˘i⁄
 
	gixp23xx_timî_úq
 = {

364 .
«me
 = "IXP23xx Timer Tick",

365 .
	gh™dÀr
 = 
ixp23xx_timî_öãºu±
,

366 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

369 
__öô
 
	$ixp23xx_öô_timî
()

372 *
IXP23XX_TIMER_STATUS
 = 
IXP23XX_TIMER1_INT_PEND
;

375 *
IXP23XX_TIMER1_RELOAD
 =

376 (
LATCH
 & ~
IXP23XX_TIMER_RELOAD_MASK
Ë| 
IXP23XX_TIMER_ENABLE
;

378 *
IXP23XX_TIMER_CONT
 = 0;

379 
√xt_jiffy_time
 = 
LATCH
;

382 
	`£tup_úq
(
IRQ_IXP23XX_TIMER1
, &
ixp23xx_timî_úq
);

383 
	}
}

385 
sys_timî
 
	gixp23xx_timî
 = {

386 .
öô
 = 
ixp23xx_öô_timî
,

387 .
	goff£t
 = 
ixp23xx_gëtimeoff£t
,

394 
ªsour˚
 
	gixp23xx_u¨t_ªsour˚s
[] = {

396 .
°¨t
 = 
IXP23XX_UART1_PHYS
,

397 .
	gíd
 = 
IXP23XX_UART1_PHYS
 + 0x0fff,

398 .
	gÊags
 = 
IORESOURCE_MEM


400 .
	g°¨t
 = 
IXP23XX_UART2_PHYS
,

401 .
	gíd
 = 
IXP23XX_UART2_PHYS
 + 0x0fff,

402 .
	gÊags
 = 
IORESOURCE_MEM


406 
∂©_£rül8250_p‹t
 
	gixp23xx_u¨t_d©a
[] = {

408 .
m≠ba£
 = 
IXP23XX_UART1_PHYS
,

409 .
	gmemba£
 = (*)(
IXP23XX_UART1_VIRT
 + 3),

410 .
	gúq
 = 
IRQ_IXP23XX_UART1
,

411 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

412 .
	giŸy≥
 = 
UPIO_MEM
,

413 .
	gªgshi·
 = 2,

414 .
	gu¨t˛k
 = 
IXP23XX_UART_XTAL
,

416 .
	gm≠ba£
 = 
IXP23XX_UART2_PHYS
,

417 .
	gmemba£
 = (*)(
IXP23XX_UART2_VIRT
 + 3),

418 .
	gúq
 = 
IRQ_IXP23XX_UART2
,

419 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

420 .
	giŸy≥
 = 
UPIO_MEM
,

421 .
	gªgshi·
 = 2,

422 .
	gu¨t˛k
 = 
IXP23XX_UART_XTAL
,

427 
∂©f‹m_devi˚
 
	gixp23xx_u¨t
 = {

428 .
«me
 = "serial8250",

429 .
	gid
 = 0,

430 .
	gdev
.
	g∂©f‹m_d©a
 = 
ixp23xx_u¨t_d©a
,

431 .
	gnum_ªsour˚s
 = 2,

432 .
	gªsour˚
 = 
ixp23xx_u¨t_ªsour˚s
,

435 
∂©f‹m_devi˚
 *
	gixp23xx_devi˚s
[] 
	g__öôd©a
 = {

436 &
ixp23xx_u¨t
,

439 
__öô
 
	$ixp23xx_sys_öô
()

441 *
IXP23XX_EXP_UNIT_FUSE
 |= 0xf;

442 
	`∂©f‹m_add_devi˚s
(
ixp23xx_devi˚s
, 
	`ARRAY_SIZE
(ixp23xx_devices));

443 
	}
}

	@arch/arm/mach-ixp23xx/espresso.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/•ölock.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/£rül.h
>

19 
	~<löux/ây.h
>

20 
	~<löux/bô›s.h
>

21 
	~<löux/i›‹t.h
>

22 
	~<löux/£rül.h
>

23 
	~<löux/£rül_8250.h
>

24 
	~<löux/£rül_c‹e.h
>

25 
	~<löux/devi˚.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/pci.h
>

28 
	~<löux/mtd/physm≠.h
>

30 
	~<asm/ty≥s.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/mem‹y.h
>

33 
	~<asm/h¨dw¨e.h
>

34 
	~<asm/mach-ty≥s.h
>

35 
	~<asm/úq.h
>

36 
	~<asm/sy°em.h
>

37 
	~<asm/ébÊush.h
>

38 
	~<asm/pgèbÀ.h
>

40 
	~<asm/mach/m≠.h
>

41 
	~<asm/mach/úq.h
>

42 
	~<asm/mach/¨ch.h
>

43 
	~<asm/mach/úq.h
>

44 
	~<asm/mach/pci.h
>

46 
__öô
 
	$e•ªsso_pci_öô
()

48 i‡(
	`machöe_is_e•ªsso
())

49 
	`ixp23xx_pci_¶ave_öô
();

52 
	}
};

53 
subsys_öôˇŒ
(
e•ªsso_pci_öô
);

55 
physm≠_Êash_d©a
 
	ge•ªsso_Êash_d©a
 = {

56 .
width
 = 2,

59 
ªsour˚
 
	ge•ªsso_Êash_ªsour˚
 = {

60 .
°¨t
 = 0x90000000,

61 .
	gíd
 = 0x91ffffff,

62 .
	gÊags
 = 
IORESOURCE_MEM
,

65 
∂©f‹m_devi˚
 
	ge•ªsso_Êash
 = {

66 .
«me
 = "physmap-flash",

67 .
	gid
 = 0,

68 .
	gdev
 = {

69 .
∂©f‹m_d©a
 = &
e•ªsso_Êash_d©a
,

71 .
	gnum_ªsour˚s
 = 1,

72 .
	gªsour˚
 = &
e•ªsso_Êash_ªsour˚
,

75 
__öô
 
	$e•ªsso_öô
()

77 
	`∂©f‹m_devi˚_ªgi°î
(&
e•ªsso_Êash
);

82 
IXP23XX_EXP_CS0
[0] |
IXP23XX_FLASH_WRITABLE
;

83 
IXP23XX_EXP_CS0
[1] |
IXP23XX_FLASH_WRITABLE
;

85 
	`ixp23xx_sys_öô
();

86 
	}
}

88 
MACHINE_START
(
ESPRESSO
, "IP Fabrics Double Espresso")

90 .
	gphys_io
 = 
IXP23XX_PERIPHERAL_PHYS
,

91 .
	gio_pg_off°
 = ((
IXP23XX_PERIPHERAL_VIRT
 >> 18)) & 0xfffc,

92 .
	gm≠_io
 = 
ixp23xx_m≠_io
,

93 .
	göô_úq
 = 
ixp23xx_öô_úq
,

94 .
	gtimî
 = &
ixp23xx_timî
,

95 .
	gboŸ_∑øms
 = 0x00000100,

96 .
	göô_machöe
 = 
e•ªsso_öô
,

97 
	gMACHINE_END


	@arch/arm/mach-ixp23xx/ixdp2351.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/úq.h
>

23 
	~<löux/£rül.h
>

24 
	~<löux/ây.h
>

25 
	~<löux/bô›s.h
>

26 
	~<löux/i›‹t.h
>

27 
	~<löux/£rül.h
>

28 
	~<löux/£rül_8250.h
>

29 
	~<löux/£rül_c‹e.h
>

30 
	~<löux/devi˚.h
>

31 
	~<löux/mm.h
>

32 
	~<löux/pci.h
>

33 
	~<löux/mtd/physm≠.h
>

35 
	~<asm/ty≥s.h
>

36 
	~<asm/£tup.h
>

37 
	~<asm/mem‹y.h
>

38 
	~<asm/h¨dw¨e.h
>

39 
	~<asm/mach-ty≥s.h
>

40 
	~<asm/sy°em.h
>

41 
	~<asm/ébÊush.h
>

42 
	~<asm/pgèbÀ.h
>

44 
	~<asm/mach/m≠.h
>

45 
	~<asm/mach/úq.h
>

46 
	~<asm/mach/¨ch.h
>

47 
	~<asm/mach/úq.h
>

48 
	~<asm/mach/pci.h
>

53 
	$ixdp2351_öè_mask
(
úq
)

55 *
IXDP2351_CPLD_INTA_MASK_SET_REG
 = 
	`IXDP2351_INTA_IRQ_MASK
(
úq
);

56 
	}
}

58 
	$ixdp2351_öè_unmask
(
úq
)

60 *
IXDP2351_CPLD_INTA_MASK_CLR_REG
 = 
	`IXDP2351_INTA_IRQ_MASK
(
úq
);

61 
	}
}

63 
	$ixdp2351_öè_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

65 
u16
 
ex_öãºu±
 =

66 *
IXDP2351_CPLD_INTA_STAT_REG
 & 
IXDP2351_INTA_IRQ_VALID
;

67 
i
;

69 
desc
->
chù
->
	`mask
(
úq
);

71 
i
 = 0; i < 
IXDP2351_INTA_IRQ_NUM
; i++) {

72 i‡(
ex_öãºu±
 & (1 << 
i
)) {

73 
úq_desc
 *
˝ld_desc
;

74 
˝ld_úq
 =

75 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTA_IRQ_BASE
 + 
i
);

76 
˝ld_desc
 = 
úq_desc
 + 
˝ld_úq
;

77 
	`desc_h™dÀ_úq
(
˝ld_úq
, 
˝ld_desc
);

81 
desc
->
chù
->
	`unmask
(
úq
);

82 
	}
}

84 
úq_chù
 
	gixdp2351_öè_chù
 = {

85 .
ack
 = 
ixdp2351_öè_mask
,

86 .
	gmask
 = 
ixdp2351_öè_mask
,

87 .
	gunmask
 = 
ixdp2351_öè_unmask


90 
	$ixdp2351_ötb_mask
(
úq
)

92 *
IXDP2351_CPLD_INTB_MASK_SET_REG
 = 
	`IXDP2351_INTB_IRQ_MASK
(
úq
);

93 
	}
}

95 
	$ixdp2351_ötb_unmask
(
úq
)

97 *
IXDP2351_CPLD_INTB_MASK_CLR_REG
 = 
	`IXDP2351_INTB_IRQ_MASK
(
úq
);

98 
	}
}

100 
	$ixdp2351_ötb_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

102 
u16
 
ex_öãºu±
 =

103 *
IXDP2351_CPLD_INTB_STAT_REG
 & 
IXDP2351_INTB_IRQ_VALID
;

104 
i
;

106 
desc
->
chù
->
	`ack
(
úq
);

108 
i
 = 0; i < 
IXDP2351_INTB_IRQ_NUM
; i++) {

109 i‡(
ex_öãºu±
 & (1 << 
i
)) {

110 
úq_desc
 *
˝ld_desc
;

111 
˝ld_úq
 =

112 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTB_IRQ_BASE
 + 
i
);

113 
˝ld_desc
 = 
úq_desc
 + 
˝ld_úq
;

114 
	`desc_h™dÀ_úq
(
˝ld_úq
, 
˝ld_desc
);

118 
desc
->
chù
->
	`unmask
(
úq
);

119 
	}
}

121 
úq_chù
 
	gixdp2351_ötb_chù
 = {

122 .
ack
 = 
ixdp2351_ötb_mask
,

123 .
	gmask
 = 
ixdp2351_ötb_mask
,

124 .
	gunmask
 = 
ixdp2351_ötb_unmask


127 
__öô
 
	$ixdp2351_öô_úq
()

129 
úq
;

132 *
IXDP2351_CPLD_INTA_MASK_SET_REG
 = (
u16
) -1;

133 *
IXDP2351_CPLD_INTB_MASK_SET_REG
 = (
u16
) -1;

134 *
IXDP2351_CPLD_INTA_SIM_REG
 = 0;

135 *
IXDP2351_CPLD_INTB_SIM_REG
 = 0;

137 
	`ixp23xx_öô_úq
();

139 
úq
 = 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTA_IRQ_BASE
);

140 
úq
 <

141 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTA_IRQ_BASE
 + 
IXDP2351_INTA_IRQ_NUM
);

142 
úq
++) {

143 i‡(
	`IXDP2351_INTA_IRQ_MASK
(
úq
Ë& 
IXDP2351_INTA_IRQ_VALID
) {

144 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

145 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

146 
	`£t_úq_chù
(
úq
, &
ixdp2351_öè_chù
);

150 
úq
 = 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTB_IRQ_BASE
);

151 
úq
 <

152 
	`IXP23XX_MACH_IRQ
(
IXDP2351_INTB_IRQ_BASE
 + 
IXDP2351_INTB_IRQ_NUM
);

153 
úq
++) {

154 i‡(
	`IXDP2351_INTB_IRQ_MASK
(
úq
Ë& 
IXDP2351_INTB_IRQ_VALID
) {

155 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

156 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

157 
	`£t_úq_chù
(
úq
, &
ixdp2351_ötb_chù
);

161 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP23XX_INTA
, 
ixdp2351_öè_h™dÀr
);

162 
	`£t_úq_chaöed_h™dÀr
(
IRQ_IXP23XX_INTB
, 
ixdp2351_ötb_h™dÀr
);

163 
	}
}

175 
	#DEVPIN
(
dev
, 
pö
Ë(’öË| ((devË<< 3))

	)

177 
__öô
 
	$ixdp2351_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

179 
u8
 
bus
 = 
dev
->bus->
numbî
;

180 
u32
 
devpö
 = 
	`DEVPIN
(
	`PCI_SLOT
(
dev
->
dev‚
), 
pö
);

181 
pci_bus
 *
tmp_bus
 = 
dev
->
bus
;

184 i‡(!
bus
)

188 (
tmp_bus
->
∑ª¡
 !
NULL
) && (tmp_bus->parent->parent != NULL))

189 
tmp_bus
 =Åmp_bus->
∑ª¡
;

192 
tmp_bus
->
£lf
->
dev‚
 | (tmp_bus->£lf->
bus
->
numbî
 << 8)) {

195 i‡(
tmp_bus
 =
dev
->
bus
) {

197 
devpö
) {

199 
	`DEVPIN
(1, 1):

200  
IRQ_IXDP2351_INTA_82546
;

201 
	`DEVPIN
(1, 2):

202  
IRQ_IXDP2351_INTB_82546
;

204 
	`DEVPIN
(0, 1):

205 
	`DEVPIN
(2, 4):

206  
IRQ_IXDP2351_SPCI_PMC_INTA
;

207 
	`DEVPIN
(0, 2):

208 
	`DEVPIN
(2, 1):

209  
IRQ_IXDP2351_SPCI_PMC_INTB
;

210 
	`DEVPIN
(0, 3):

211 
	`DEVPIN
(2, 2):

212  
IRQ_IXDP2351_SPCI_PMC_INTC
;

213 
	`DEVPIN
(0, 4):

214 
	`DEVPIN
(2, 3):

215  
IRQ_IXDP2351_SPCI_PMC_INTD
;

224 i‡(
tmp_bus
 =
dev
->
bus
) {

227 
devpö
) {

228 
	`DEVPIN
(0, 1):

229 
	`DEVPIN
(0, 2):

230 
	`DEVPIN
(0, 3):

231 
	`DEVPIN
(0, 4):

232  
IRQ_IXDP2351_SPCI_DB_0
;

233 
	`DEVPIN
(1, 1):

234 
	`DEVPIN
(1, 2):

235 
	`DEVPIN
(1, 3):

236 
	`DEVPIN
(1, 4):

237  
IRQ_IXDP2351_SPCI_DB_1
;

238 
	`DEVPIN
(2, 1):

239 
	`DEVPIN
(2, 2):

240 
	`DEVPIN
(2, 3):

241 
	`DEVPIN
(2, 4):

242 
	`DEVPIN
(3, 1):

243 
	`DEVPIN
(3, 2):

244 
	`DEVPIN
(3, 3):

245 
	`DEVPIN
(3, 4):

246  
IRQ_IXDP2351_SPCI_FIC
;

257 
	}
}

259 
hw_pci
 
ixdp2351_pci
 
	g__öôd©a
 = {

260 .
ƒ_c⁄åﬁÀrs
 = 1,

261 .
	g¥eöô
 = 
ixp23xx_pci_¥eöô
,

262 .
	g£tup
 = 
ixp23xx_pci_£tup
,

263 .
	gsˇn
 = 
ixp23xx_pci_sˇn_bus
,

264 .
	gm≠_úq
 = 
ixdp2351_m≠_úq
,

267 
__öô
 
	$ixdp2351_pci_öô
()

269 i‡(
	`machöe_is_ixdp2351
())

270 
	`pci_comm⁄_öô
(&
ixdp2351_pci
);

273 
	}
}

275 
subsys_öôˇŒ
(
ixdp2351_pci_öô
);

280 
m≠_desc
 
	gixdp2351_io_desc
[] 
	g__öôd©a
 = {

282 .
vútuÆ
 = 
IXDP2351_NP_VIRT_BASE
,

283 .
	gp‚
 = 
__phys_to_p‚
((
u64
)
IXDP2351_NP_PHYS_BASE
),

284 .
	gÀngth
 = 
IXDP2351_NP_PHYS_SIZE
,

285 .
	gty≥
 = 
MT_DEVICE


287 .
	gvútuÆ
 = 
IXDP2351_BB_BASE_VIRT
,

288 .
	gp‚
 = 
__phys_to_p‚
((
u64
)
IXDP2351_BB_BASE_PHYS
),

289 .
	gÀngth
 = 
IXDP2351_BB_SIZE
,

290 .
	gty≥
 = 
MT_DEVICE


294 
__öô
 
	$ixdp2351_m≠_io
()

296 
	`ixp23xx_m≠_io
();

297 
	`iŸabÀ_öô
(
ixdp2351_io_desc
, 
	`ARRAY_SIZE
(ixdp2351_io_desc));

298 
	}
}

300 
physm≠_Êash_d©a
 
	gixdp2351_Êash_d©a
 = {

301 .
width
 = 1,

304 
ªsour˚
 
	gixdp2351_Êash_ªsour˚
 = {

305 .
°¨t
 = 0x90000000,

306 .
	gíd
 = 0x93ffffff,

307 .
	gÊags
 = 
IORESOURCE_MEM
,

310 
∂©f‹m_devi˚
 
	gixdp2351_Êash
 = {

311 .
«me
 = "physmap-flash",

312 .
	gid
 = 0,

313 .
	gdev
 = {

314 .
∂©f‹m_d©a
 = &
ixdp2351_Êash_d©a
,

316 .
	gnum_ªsour˚s
 = 1,

317 .
	gªsour˚
 = &
ixdp2351_Êash_ªsour˚
,

320 
__öô
 
	$ixdp2351_öô
()

322 
	`∂©f‹m_devi˚_ªgi°î
(&
ixdp2351_Êash
);

327 
IXP23XX_EXP_CS0
[0] |
IXP23XX_FLASH_WRITABLE
;

328 
IXP23XX_EXP_CS0
[1] |
IXP23XX_FLASH_WRITABLE
;

329 
IXP23XX_EXP_CS0
[2] |
IXP23XX_FLASH_WRITABLE
;

330 
IXP23XX_EXP_CS0
[3] |
IXP23XX_FLASH_WRITABLE
;

332 
	`ixp23xx_sys_öô
();

333 
	}
}

335 
MACHINE_START
(
IXDP2351
, "Intel IXDP2351 Development Platform")

337 .
	gphys_io
 = 
IXP23XX_PERIPHERAL_PHYS
,

338 .
	gio_pg_off°
 = ((
IXP23XX_PERIPHERAL_VIRT
 >> 18)) & 0xfffc,

339 .
	gm≠_io
 = 
ixdp2351_m≠_io
,

340 .
	göô_úq
 = 
ixdp2351_öô_úq
,

341 .
	gtimî
 = &
ixp23xx_timî
,

342 .
	gboŸ_∑øms
 = 0x00000100,

343 .
	göô_machöe
 = 
ixdp2351_öô
,

344 
	gMACHINE_END


	@arch/arm/mach-ixp23xx/pci.c

19 
	~<löux/sched.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/pci.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/dñay.h
>

29 
	~<asm/io.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/sizes.h
>

32 
	~<asm/sy°em.h
>

33 
	~<asm/mach/pci.h
>

34 
	~<asm/mach-ty≥s.h
>

35 
	~<asm/h¨dw¨e.h
>

37 (*
exã∫Æ_Áu…
Ë(, 
±_ªgs
 *);

39 vﬁ©ûê
pci_ma°î_ab‹ts
 = 0;

41 #ifde‡
DEBUG


42 
	#DBG
(
x
...Ë
	`¥ötk
(x)

	)

44 
	#DBG
(
x
...)

	)

47 
	`˛ór_ma°î_ab‹ts
();

49 
u32


50 *
	$ixp23xx_pci_c⁄fig_addr
(
bus_ƒ
, 
dev‚
, 
whîe
)

52 
u32
 *
∑ddªss
;

57 
whîe
 &= ~3;

62 i‡(!
bus_ƒ
) {

63 i‡(
	`PCI_SLOT
(
dev‚
) >= 8)

66 
∑ddªss
 = (
u32
 *Ë(
IXP23XX_PCI_CFG0_VIRT


67 | (1 << (
	`PCI_SLOT
(
dev‚
) + 16))

68 | (
	`PCI_FUNC
(
dev‚
Ë<< 8Ë| 
whîe
);

70 
∑ddªss
 = (
u32
 *Ë(
IXP23XX_PCI_CFG1_VIRT


71 | (
bus_ƒ
 << 16)

72 | (
	`PCI_SLOT
(
dev‚
) << 11)

73 | (
	`PCI_FUNC
(
dev‚
Ë<< 8Ë| 
whîe
);

76  
∑ddªss
;

77 
	}
}

83 
u32
 
	gbyãmask
[] = {

91 
	$ixp23xx_pci_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
,

92 
whîe
, 
size
, 
u32
 *
vÆue
)

94 
u32
 
n
;

95 
u32
 *
addr
;

97 
n
 = 
whîe
 % 4;

99 
	`DBG
("I¿c⁄fig_ªad(%dË%d from dev %d:%d:%d\n", 
size
, 
whîe
,

100 
bus
->
numbî
, 
	`PCI_SLOT
(
dev‚
), 
	`PCI_FUNC
(devfn));

102 
addr
 = 
	`ixp23xx_pci_c⁄fig_addr
(
bus
->
numbî
, 
dev‚
, 
whîe
);

103 i‡(!
addr
)

104  
PCIBIOS_DEVICE_NOT_FOUND
;

106 
pci_ma°î_ab‹ts
 = 0;

107 *
vÆue
 = (*
addr
 >> (8*
n
)Ë& 
byãmask
[
size
];

108 i‡(
pci_ma°î_ab‹ts
) {

109 
pci_ma°î_ab‹ts
 = 0;

110 *
vÆue
 = 0xffffffff;

111  
PCIBIOS_DEVICE_NOT_FOUND
;

114  
PCIBIOS_SUCCESSFUL
;

115 
	}
}

122 
	$ixp23xx_pci_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
,

123 
whîe
, 
size
, 
u32
 
vÆue
)

125 
u32
 
mask
;

126 
u32
 *
addr
;

127 
u32
 
ãmp
;

129 
mask
 = ~(
byãmask
[
size
] << ((
whîe
 % 0x4) * 8));

130 
addr
 = 
	`ixp23xx_pci_c⁄fig_addr
(
bus
->
numbî
, 
dev‚
, 
whîe
);

131 i‡(!
addr
)

132  
PCIBIOS_DEVICE_NOT_FOUND
;

133 
ãmp
 = (
u32
Ë(
vÆue
Ë<< ((
whîe
 % 0x4) * 8);

134 *
addr
 = (*add∏& 
mask
Ë| 
ãmp
;

136 
	`˛ór_ma°î_ab‹ts
();

138  
PCIBIOS_SUCCESSFUL
;

139 
	}
}

141 
pci_›s
 
	gixp23xx_pci_›s
 = {

142 .
ªad
 = 
ixp23xx_pci_ªad_c⁄fig
,

143 .
	gwrôe
 = 
ixp23xx_pci_wrôe_c⁄fig
,

146 
pci_bus
 *
	$ixp23xx_pci_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sysd©a
)

148  
	`pci_sˇn_bus
(
sysd©a
->
bu¢r
, &
ixp23xx_pci_›s
, sysdata);

149 
	}
}

151 
	$ixp23xx_pci_ab‹t_h™dÀr
(
addr
, 
f§
, 
±_ªgs
 *
ªgs
)

153 vﬁ©ûê
ãmp
;

154 
Êags
;

156 
pci_ma°î_ab‹ts
 = 1;

158 
	`loˇl_úq_ßve
(
Êags
);

159 
ãmp
 = *
IXP23XX_PCI_CONTROL
;

164 i‡(
ãmp
 & ((1 << 8) | (1 << 5)))

165 *
IXP23XX_PCI_CONTROL
 = 
ãmp
;

167 
ãmp
 = *
IXP23XX_PCI_CMDSTAT
;

169 i‡(
ãmp
 & (1 << 29))

170 *
IXP23XX_PCI_CMDSTAT
 = 
ãmp
;

171 
	`loˇl_úq_ª°‹e
(
Êags
);

177 i‡(
f§
 & (1 << 10))

178 
ªgs
->
ARM_pc
 += 4;

181 
	}
}

183 
	$˛ór_ma°î_ab‹ts
()

185 vﬁ©ûê
u32
 
ãmp
;

187 
ãmp
 = *
IXP23XX_PCI_CONTROL
;

192 i‡(
ãmp
 & ((1 << 8) | (1 << 5)))

193 *
IXP23XX_PCI_CONTROL
 = 
ãmp
;

195 
ãmp
 = *
IXP23XX_PCI_CMDSTAT
;

197 i‡(
ãmp
 & (1 << 29))

198 *
IXP23XX_PCI_CMDSTAT
 = 
ãmp
;

201 
	}
}

203 
__öô
 
	$ixp23xx_pci_comm⁄_öô
()

205 #ifde‡
__ARMEB__


206 *
IXP23XX_PCI_CONTROL
 |= 0x20000;

211 *
IXP23XX_CPP2XSI_CURR_XFER_REG3
 &~
IXP23XX_CPP2XSI_ADDR_31
;

212 *
IXP23XX_CPP2XSI_CURR_XFER_REG3
 |
IXP23XX_CPP2XSI_PSH_OFF
;

217 i‡(
	`ixp23xx_˝p_boŸ
()) {

218 *
IXP23XX_PCI_CPP_ADDR_BITS
 &= ~(1 << 1);

220 *
IXP23XX_PCI_CPP_ADDR_BITS
 |= (1 << 1);

225 i‡(
	`¨ch_is_cohîít
())

226 *
IXP23XX_CPP2XSI_CURR_XFER_REG3
 &~
IXP23XX_CPP2XSI_COH_OFF
;

228 
	}
}

230 
__öô
 
	$ixp23xx_pci_¥eöô
()

232 
	`ixp23xx_pci_comm⁄_öô
();

234 
	`hook_Áu…_code
(16+6, 
ixp23xx_pci_ab‹t_h™dÀr
, 
SIGBUS
,

237 *
IXP23XX_PCI_ADDR_EXT
 = 0x0000e000;

238 
	}
}

243 
__devöô
 
	$pci_fixup_ixp23xx
(
pci_dev
 *
dev
)

245 
i
;

247 
dev
->
˛ass
 &= 0xff;

248 
dev
->
˛ass
 |
PCI_CLASS_BRIDGE_HOST
 << 8;

249 
i
 = 0; i < 
PCI_NUM_RESOURCES
; i++) {

250 
dev
->
ªsour˚
[
i
].
°¨t
 = 0;

251 
dev
->
ªsour˚
[
i
].
íd
 = 0;

252 
dev
->
ªsour˚
[
i
].
Êags
 = 0;

254 
	}
}

255 
DECLARE_PCI_FIXUP_HEADER
(
PCI_VENDOR_ID_INTEL
, 0x9002, 
pci_fixup_ixp23xx
);

261 
ªsour˚
 
	gixp23xx_pci_mem_•a˚
 = {

262 .
°¨t
 = 
IXP23XX_PCI_MEM_START
,

263 .
	gíd
 = 
IXP23XX_PCI_MEM_START
 + 
IXP23XX_PCI_MEM_SIZE
 - 1,

264 .
	gÊags
 = 
IORESOURCE_MEM
,

265 .
	g«me
 = "PCI Mem Space"

268 
ªsour˚
 
	gixp23xx_pci_io_•a˚
 = {

269 .
°¨t
 = 0x00000100,

270 .
	gíd
 = 0x01ffffff,

271 .
	gÊags
 = 
IORESOURCE_IO
,

272 .
	g«me
 = "PCI I/O Space"

275 
	$ixp23xx_pci_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

277 i‡(
ƒ
 >= 1)

280 
sys
->
ªsour˚
[0] = &
ixp23xx_pci_io_•a˚
;

281 
sys
->
ªsour˚
[1] = &
ixp23xx_pci_mem_•a˚
;

282 
sys
->
ªsour˚
[2] = 
NULL
;

285 
	}
}

287 
__öô
 
	$ixp23xx_pci_¶ave_öô
()

289 
	`ixp23xx_pci_comm⁄_öô
();

290 
	}
}

	@arch/arm/mach-ixp23xx/roadrunner.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/£rül.h
>

23 
	~<löux/ây.h
>

24 
	~<löux/bô›s.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/£rül.h
>

27 
	~<löux/£rül_8250.h
>

28 
	~<löux/£rül_c‹e.h
>

29 
	~<löux/devi˚.h
>

30 
	~<löux/mm.h
>

31 
	~<löux/pci.h
>

32 
	~<löux/mtd/physm≠.h
>

34 
	~<asm/ty≥s.h
>

35 
	~<asm/£tup.h
>

36 
	~<asm/mem‹y.h
>

37 
	~<asm/h¨dw¨e.h
>

38 
	~<asm/mach-ty≥s.h
>

39 
	~<asm/úq.h
>

40 
	~<asm/sy°em.h
>

41 
	~<asm/ébÊush.h
>

42 
	~<asm/pgèbÀ.h
>

44 
	~<asm/mach/m≠.h
>

45 
	~<asm/mach/úq.h
>

46 
	~<asm/mach/¨ch.h
>

47 
	~<asm/mach/úq.h
>

48 
	~<asm/mach/pci.h
>

53 
	#INTA
 
IRQ_ROADRUNNER_PCI_INTA


	)

54 
	#INTB
 
IRQ_ROADRUNNER_PCI_INTB


	)

55 
	#INTC
 
IRQ_ROADRUNNER_PCI_INTC


	)

56 
	#INTD
 
IRQ_ROADRUNNER_PCI_INTD


	)

58 
	#INTC_PIN
 
IXP23XX_GPIO_PIN_11


	)

59 
	#INTD_PIN
 
IXP23XX_GPIO_PIN_12


	)

61 
__öô
 
	$rﬂdru¬î_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
id£l
, u8 
pö
)

63 
pci_ˇrd_¶Ÿ_úq
[] = {
INTB
, 
INTC
, 
INTD
, 
INTA
};

64 
pmc_ˇrd_¶Ÿ_úq
[] = {
INTA
, 
INTB
, 
INTC
, 
INTD
};

65 
usb_úq
[] = {
INTB
, 
INTC
, 
INTD
, -1};

66 
möi_pci_1_úq
[] = {
INTB
, 
INTC
, -1, -1};

67 
möi_pci_2_úq
[] = {
INTC
, 
INTD
, -1, -1};

69 
dev
->
bus
->
numbî
) {

71 
dev
->
dev‚
) {

75  
pci_ˇrd_¶Ÿ_úq
[
pö
 - 1];

77  
pmc_ˇrd_¶Ÿ_úq
[
pö
 - 1];

83  
NO_IRQ
;

88 
dev
->
dev‚
) {

90  (
pö
 =1Ë? 
INTC
 : -1;

94  
usb_úq
[
pö
 - 1];

96  
möi_pci_1_úq
[
pö
-1];

98  
möi_pci_2_úq
[
pö
-1];

100  (
pö
 =1Ë? 
INTA
 : -1;

102  
NO_IRQ
;

107  
NO_IRQ
;

110  
NO_IRQ
;

111 
	}
}

113 
__öô
 
	$rﬂdru¬î_pci_¥eöô
()

115 
	`£t_úq_ty≥
(
IRQ_ROADRUNNER_PCI_INTC
, 
IRQT_LOW
);

116 
	`£t_úq_ty≥
(
IRQ_ROADRUNNER_PCI_INTD
, 
IRQT_LOW
);

118 
	`ixp23xx_pci_¥eöô
();

119 
	}
}

121 
hw_pci
 
rﬂdru¬î_pci
 
	g__öôd©a
 = {

122 .
ƒ_c⁄åﬁÀrs
 = 1,

123 .
	g¥eöô
 = 
rﬂdru¬î_pci_¥eöô
,

124 .
	g£tup
 = 
ixp23xx_pci_£tup
,

125 .
	gsˇn
 = 
ixp23xx_pci_sˇn_bus
,

126 .
	gm≠_úq
 = 
rﬂdru¬î_m≠_úq
,

129 
__öô
 
	$rﬂdru¬î_pci_öô
()

131 i‡(
	`machöe_is_rﬂdru¬î
())

132 
	`pci_comm⁄_öô
(&
rﬂdru¬î_pci
);

135 
	}
};

137 
subsys_öôˇŒ
(
rﬂdru¬î_pci_öô
);

139 
physm≠_Êash_d©a
 
	grﬂdru¬î_Êash_d©a
 = {

140 .
width
 = 2,

143 
ªsour˚
 
	grﬂdru¬î_Êash_ªsour˚
 = {

144 .
°¨t
 = 0x90000000,

145 .
	gíd
 = 0x93ffffff,

146 .
	gÊags
 = 
IORESOURCE_MEM
,

149 
∂©f‹m_devi˚
 
	grﬂdru¬î_Êash
 = {

150 .
«me
 = "physmap-flash",

151 .
	gid
 = 0,

152 .
	gdev
 = {

153 .
∂©f‹m_d©a
 = &
rﬂdru¬î_Êash_d©a
,

155 .
	gnum_ªsour˚s
 = 1,

156 .
	gªsour˚
 = &
rﬂdru¬î_Êash_ªsour˚
,

159 
__öô
 
	$rﬂdru¬î_öô
()

161 
	`∂©f‹m_devi˚_ªgi°î
(&
rﬂdru¬î_Êash
);

166 
IXP23XX_EXP_CS0
[0] |
IXP23XX_FLASH_WRITABLE
;

167 
IXP23XX_EXP_CS0
[1] |
IXP23XX_FLASH_WRITABLE
;

168 
IXP23XX_EXP_CS0
[2] |
IXP23XX_FLASH_WRITABLE
;

169 
IXP23XX_EXP_CS0
[3] |
IXP23XX_FLASH_WRITABLE
;

171 
	`ixp23xx_sys_öô
();

172 
	}
}

174 
MACHINE_START
(
ROADRUNNER
, "ADI Engineering RoadRunner Development Platform")

176 .
	gphys_io
 = 
IXP23XX_PERIPHERAL_PHYS
,

177 .
	gio_pg_off°
 = ((
IXP23XX_PERIPHERAL_VIRT
 >> 18)) & 0xfffc,

178 .
	gm≠_io
 = 
ixp23xx_m≠_io
,

179 .
	göô_úq
 = 
ixp23xx_öô_úq
,

180 .
	gtimî
 = &
ixp23xx_timî
,

181 .
	gboŸ_∑øms
 = 0x00000100,

182 .
	göô_machöe
 = 
rﬂdru¬î_öô
,

183 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/avila-pci.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/pci.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/úq.h
>

24 
	~<löux/dñay.h
>

26 
	~<asm/mach/pci.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/mach-ty≥s.h
>

31 
__öô
 
	$avûa_pci_¥eöô
()

33 
	`£t_úq_ty≥
(
IRQ_AVILA_PCI_INTA
, 
IRQT_LOW
);

34 
	`£t_úq_ty≥
(
IRQ_AVILA_PCI_INTB
, 
IRQT_LOW
);

35 
	`£t_úq_ty≥
(
IRQ_AVILA_PCI_INTC
, 
IRQT_LOW
);

36 
	`£t_úq_ty≥
(
IRQ_AVILA_PCI_INTD
, 
IRQT_LOW
);

38 
	`ixp4xx_pci_¥eöô
();

39 
	}
}

41 
__öô
 
	$avûa_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

43 
pci_úq_èbÀ
[
AVILA_PCI_IRQ_LINES
] = {

44 
IRQ_AVILA_PCI_INTA
,

45 
IRQ_AVILA_PCI_INTB
,

46 
IRQ_AVILA_PCI_INTC
,

47 
IRQ_AVILA_PCI_INTD


50 
úq
 = -1;

52 i‡(
¶Ÿ
 >= 1 &&

53 
¶Ÿ
 <(
	`machöe_is_lo·
(Ë? 
LOFT_PCI_MAX_DEV
 : 
AVILA_PCI_MAX_DEV
) &&

54 
pö
 >1 &&Öö <
AVILA_PCI_IRQ_LINES
) {

55 
úq
 = 
pci_úq_èbÀ
[(
¶Ÿ
 + 
pö
 - 2) % 4];

58  
úq
;

59 
	}
}

61 
hw_pci
 
avûa_pci
 
	g__öôd©a
 = {

62 .
ƒ_c⁄åﬁÀrs
 = 1,

63 .
	g¥eöô
 = 
avûa_pci_¥eöô
,

64 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

65 .
	g£tup
 = 
ixp4xx_£tup
,

66 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

67 .
	gm≠_úq
 = 
avûa_m≠_úq
,

70 
__öô
 
	$avûa_pci_öô
()

72 i‡(
	`machöe_is_avûa
(Ë|| 
	`machöe_is_lo·
())

73 
	`pci_comm⁄_öô
(&
avûa_pci
);

75 
	}
}

77 
subsys_öôˇŒ
(
avûa_pci_öô
);

	@arch/arm/mach-ixp4xx/avila-setup.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/devi˚.h
>

17 
	~<löux/£rül.h
>

18 
	~<löux/ây.h
>

19 
	~<löux/£rül_8250.h
>

20 
	~<löux/¶ab.h
>

22 
	~<asm/ty≥s.h
>

23 
	~<asm/£tup.h
>

24 
	~<asm/mem‹y.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/¨ch.h
>

29 
	~<asm/mach/Êash.h
>

31 
Êash_∂©f‹m_d©a
 
	gavûa_Êash_d©a
 = {

32 .
m≠_«me
 = "cfi_probe",

33 .
	gwidth
 = 2,

36 
ªsour˚
 
	gavûa_Êash_ªsour˚
 = {

37 .
Êags
 = 
IORESOURCE_MEM
,

40 
∂©f‹m_devi˚
 
	gavûa_Êash
 = {

41 .
«me
 = "IXP4XX-Flash",

42 .
	gid
 = 0,

43 .
	gdev
 = {

44 .
∂©f‹m_d©a
 = &
avûa_Êash_d©a
,

46 .
	gnum_ªsour˚s
 = 1,

47 .
	gªsour˚
 = &
avûa_Êash_ªsour˚
,

50 
ixp4xx_i2c_pös
 
	gavûa_i2c_gpio_pös
 = {

51 .
sda_pö
 = 
AVILA_SDA_PIN
,

52 .
	gs˛_pö
 = 
AVILA_SCL_PIN
,

55 
∂©f‹m_devi˚
 
	gavûa_i2c_c⁄åﬁÀr
 = {

56 .
«me
 = "IXP4XX-I2C",

57 .
	gid
 = 0,

58 .
	gdev
 = {

59 .
∂©f‹m_d©a
 = &
avûa_i2c_gpio_pös
,

61 .
	gnum_ªsour˚s
 = 0

64 
ªsour˚
 
	gavûa_u¨t_ªsour˚s
[] = {

66 .
°¨t
 = 
IXP4XX_UART1_BASE_PHYS
,

67 .
	gíd
 = 
IXP4XX_UART1_BASE_PHYS
 + 0x0fff,

68 .
	gÊags
 = 
IORESOURCE_MEM


71 .
	g°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

72 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

73 .
	gÊags
 = 
IORESOURCE_MEM


77 
∂©_£rül8250_p‹t
 
	gavûa_u¨t_d©a
[] = {

79 .
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
,

80 .
	gmemba£
 = (*)
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
,

81 .
	gúq
 = 
IRQ_IXP4XX_UART1
,

82 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

83 .
	giŸy≥
 = 
UPIO_MEM
,

84 .
	gªgshi·
 = 2,

85 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

88 .
	gm≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

89 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

90 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

91 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

92 .
	giŸy≥
 = 
UPIO_MEM
,

93 .
	gªgshi·
 = 2,

94 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

99 
∂©f‹m_devi˚
 
	gavûa_u¨t
 = {

100 .
«me
 = "serial8250",

101 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

102 .
	gdev
.
	g∂©f‹m_d©a
 = 
avûa_u¨t_d©a
,

103 .
	gnum_ªsour˚s
 = 2,

104 .
	gªsour˚
 = 
avûa_u¨t_ªsour˚s


107 
ªsour˚
 
	gavûa_∑è_ªsour˚s
[] = {

109 .
Êags
 = 
IORESOURCE_MEM


112 .
	gÊags
 = 
IORESOURCE_MEM
,

115 .
	g«me
 = "intrq",

116 .
	g°¨t
 = 
IRQ_IXP4XX_GPIO12
,

117 .
	gíd
 = 
IRQ_IXP4XX_GPIO12
,

118 .
	gÊags
 = 
IORESOURCE_IRQ
,

122 
ixp4xx_∑è_d©a
 
	gavûa_∑è_d©a
 = {

123 .
cs0_bôs
 = 0xbfff0043,

124 .
	gcs1_bôs
 = 0xbfff0043,

127 
∂©f‹m_devi˚
 
	gavûa_∑è
 = {

128 .
«me
 = "pata_ixp4xx_cf",

129 .
	gid
 = 0,

130 .
	gdev
.
	g∂©f‹m_d©a
 = &
avûa_∑è_d©a
,

131 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
avûa_∑è_ªsour˚s
),

132 .
	gªsour˚
 = 
avûa_∑è_ªsour˚s
,

135 
∂©f‹m_devi˚
 *
	gavûa_devi˚s
[] 
	g__öôd©a
 = {

136 &
avûa_i2c_c⁄åﬁÀr
,

137 &
avûa_Êash
,

138 &
avûa_u¨t


141 
__öô
 
	$avûa_öô
()

143 
	`ixp4xx_sys_öô
();

145 
avûa_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

146 
avûa_Êash_ªsour˚
.
íd
 =

147 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
ixp4xx_exp_bus_size
 - 1;

149 
	`∂©f‹m_add_devi˚s
(
avûa_devi˚s
, 
	`ARRAY_SIZE
(avila_devices));

151 
avûa_∑è_ªsour˚s
[0].
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(1);

152 
avûa_∑è_ªsour˚s
[0].
íd
 = 
	`IXP4XX_EXP_BUS_END
(1);

154 
avûa_∑è_ªsour˚s
[1].
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(2);

155 
avûa_∑è_ªsour˚s
[1].
íd
 = 
	`IXP4XX_EXP_BUS_END
(2);

157 
avûa_∑è_d©a
.
cs0_cfg
 = 
IXP4XX_EXP_CS1
;

158 
avûa_∑è_d©a
.
cs1_cfg
 = 
IXP4XX_EXP_CS2
;

160 
	`∂©f‹m_devi˚_ªgi°î
(&
avûa_∑è
);

162 
	}
}

164 
MACHINE_START
(
AVILA
, "Gateworks Avila Network Platform")

166 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

167 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

168 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

169 .
	göô_úq
 = 
ixp4xx_öô_úq
,

170 .
	gtimî
 = &
ixp4xx_timî
,

171 .
	gboŸ_∑øms
 = 0x0100,

172 .
	göô_machöe
 = 
avûa_öô
,

173 
	gMACHINE_END


180 #ifde‡
CONFIG_MACH_LOFT


181 
MACHINE_START
(
LOFT
, "Giant Shoulder Inc Loft board")

183 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

184 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

185 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

186 .
	göô_úq
 = 
ixp4xx_öô_úq
,

187 .
	gtimî
 = &
ixp4xx_timî
,

188 .
	gboŸ_∑øms
 = 0x0100,

189 .
	göô_machöe
 = 
avûa_öô
,

190 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/common-pci.c

18 
	~<löux/sched.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/pci.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/mm.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/devi˚.h
>

28 
	~<asm/dma-m≠pög.h
>

30 
	~<asm/io.h
>

31 
	~<asm/úq.h
>

32 
	~<asm/sizes.h
>

33 
	~<asm/sy°em.h
>

34 
	~<asm/mach/pci.h
>

35 
	~<asm/h¨dw¨e.h
>

42 (*
ixp4xx_pci_ªad
)(
u32
 
addr
, u32 
cmd
, u32* 
d©a
);

47 
ixp4xx_pci_ªg_ba£
 = 0;

56 
	`DEFINE_SPINLOCK
(
ixp4xx_pci_lock
);

61 
	$¸p_ªad
(
u32
 
ad_cbe
, u32 *
d©a
)

63 
Êags
;

64 
	`•ö_lock_úqßve
(&
ixp4xx_pci_lock
, 
Êags
);

65 *
PCI_CRP_AD_CBE
 = 
ad_cbe
;

66 *
d©a
 = *
PCI_CRP_RDATA
;

67 
	`•ö_u∆ock_úqª°‹e
(&
ixp4xx_pci_lock
, 
Êags
);

68 
	}
}

73 
	$¸p_wrôe
(
u32
 
ad_cbe
, u32 
d©a
)

75 
Êags
;

76 
	`•ö_lock_úqßve
(&
ixp4xx_pci_lock
, 
Êags
);

77 *
PCI_CRP_AD_CBE
 = 
CRP_AD_CBE_WRITE
 | 
ad_cbe
;

78 *
PCI_CRP_WDATA
 = 
d©a
;

79 
	`•ö_u∆ock_úqª°‹e
(&
ixp4xx_pci_lock
, 
Êags
);

80 
	}
}

82 
ölöe
 
	$check_ma°î_ab‹t
()

85 
i§
 = *
PCI_ISR
;

87 i‡(
i§
 & 
PCI_ISR_PFE
) {

89 *
PCI_ISR
 = 
PCI_ISR_PFE
;

90 
	`¥_debug
("%†Áûed\n", 
__FUNCTION__
);

95 
	}
}

97 
	$ixp4xx_pci_ªad_îøè
(
u32
 
addr
, u32 
cmd
, u32* 
d©a
)

99 
Êags
;

100 
ªtvÆ
 = 0;

101 
i
;

103 
	`•ö_lock_úqßve
(&
ixp4xx_pci_lock
, 
Êags
);

105 *
PCI_NP_AD
 = 
addr
;

111 
i
 = 0; i < 8; i++) {

112 *
PCI_NP_CBE
 = 
cmd
;

113 *
d©a
 = *
PCI_NP_RDATA
;

114 *
d©a
 = *
PCI_NP_RDATA
;

117 if(
	`check_ma°î_ab‹t
())

118 
ªtvÆ
 = 1;

120 
	`•ö_u∆ock_úqª°‹e
(&
ixp4xx_pci_lock
, 
Êags
);

121  
ªtvÆ
;

122 
	}
}

124 
	$ixp4xx_pci_ªad_no_îøè
(
u32
 
addr
, u32 
cmd
, u32* 
d©a
)

126 
Êags
;

127 
ªtvÆ
 = 0;

129 
	`•ö_lock_úqßve
(&
ixp4xx_pci_lock
, 
Êags
);

131 *
PCI_NP_AD
 = 
addr
;

134 *
PCI_NP_CBE
 = 
cmd
;

137 *
d©a
 = *
PCI_NP_RDATA
;

139 if(
	`check_ma°î_ab‹t
())

140 
ªtvÆ
 = 1;

142 
	`•ö_u∆ock_úqª°‹e
(&
ixp4xx_pci_lock
, 
Êags
);

143  
ªtvÆ
;

144 
	}
}

146 
	$ixp4xx_pci_wrôe
(
u32
 
addr
, u32 
cmd
, u32 
d©a
)

148 
Êags
;

149 
ªtvÆ
 = 0;

151 
	`•ö_lock_úqßve
(&
ixp4xx_pci_lock
, 
Êags
);

153 *
PCI_NP_AD
 = 
addr
;

156 *
PCI_NP_CBE
 = 
cmd
;

159 *
PCI_NP_WDATA
 = 
d©a
;

161 if(
	`check_ma°î_ab‹t
())

162 
ªtvÆ
 = 1;

164 
	`•ö_u∆ock_úqª°‹e
(&
ixp4xx_pci_lock
, 
Êags
);

165  
ªtvÆ
;

166 
	}
}

168 
u32
 
	$ixp4xx_c⁄fig_addr
(
u8
 
bus_num
, 
u16
 
dev‚
, 
whîe
)

170 
u32
 
addr
;

171 i‡(!
bus_num
) {

173 
addr
 = 
	`BIT
(32-
	`PCI_SLOT
(
dev‚
)Ë| ((
	`PCI_FUNC
(devfn)) << 8) |

174 (
whîe
 & ~3);

177 
addr
 = (
bus_num
 << 16Ë| ((
	`PCI_SLOT
(
dev‚
)) << 11) |

178 ((
	`PCI_FUNC
(
dev‚
)Ë<< 8Ë| (
whîe
 & ~3) | 1;

180  
addr
;

181 
	}
}

187 
u32
 
	gbyãmask
[] = {

195 
u32
 
	$loˇl_byã_œ√_íabÀ_bôs
(
u32
 
n
, 
size
)

197 i‡(
size
 == 1)

198  (0x‡& ~
	`BIT
(
n
)Ë<< 
CRP_AD_CBE_BESL
;

199 i‡(
size
 == 2)

200  (0x‡& ~(
	`BIT
(
n
Ë| BIT“+1))Ë<< 
CRP_AD_CBE_BESL
;

201 i‡(
size
 == 4)

204 
	}
}

206 
	$loˇl_ªad_c⁄fig
(
whîe
, 
size
, 
u32
 *
vÆue
)

208 
u32
 
n
, 
d©a
;

209 
	`¥_debug
("loˇl_ªad_c⁄fig from %d sizê%d\n", 
whîe
, 
size
);

210 
n
 = 
whîe
 % 4;

211 
	`¸p_ªad
(
whîe
 & ~3, &
d©a
);

212 *
vÆue
 = (
d©a
 >> (8*
n
)Ë& 
byãmask
[
size
];

213 
	`¥_debug
("loˇl_ªad_c⁄figÑód %#x\n", *
vÆue
);

214  
PCIBIOS_SUCCESSFUL
;

215 
	}
}

217 
	$loˇl_wrôe_c⁄fig
(
whîe
, 
size
, 
u32
 
vÆue
)

219 
u32
 
n
, 
byã_íabÀs
, 
d©a
;

220 
	`¥_debug
("loˇl_wrôe_c⁄fig %#xÅÿ%d sizê%d\n", 
vÆue
, 
whîe
, 
size
);

221 
n
 = 
whîe
 % 4;

222 
byã_íabÀs
 = 
	`loˇl_byã_œ√_íabÀ_bôs
(
n
, 
size
);

223 i‡(
byã_íabÀs
 == 0xffffffff)

224  
PCIBIOS_BAD_REGISTER_NUMBER
;

225 
d©a
 = 
vÆue
 << (8*
n
);

226 
	`¸p_wrôe
((
whîe
 & ~3Ë| 
byã_íabÀs
, 
d©a
);

227  
PCIBIOS_SUCCESSFUL
;

228 
	}
}

230 
u32
 
	$byã_œ√_íabÀ_bôs
(
u32
 
n
, 
size
)

232 i‡(
size
 == 1)

233  (0x‡& ~
	`BIT
(
n
)) << 4;

234 i‡(
size
 == 2)

235  (0x‡& ~(
	`BIT
(
n
) | BIT(n+1))) << 4;

236 i‡(
size
 == 4)

239 
	}
}

241 
	$ixp4xx_pci_ªad_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
, 
u32
 *
vÆue
)

243 
u32
 
n
, 
byã_íabÀs
, 
addr
, 
d©a
;

244 
u8
 
bus_num
 = 
bus
->
numbî
;

246 
	`¥_debug
("ªad_c⁄fig from %d sizê%d dev %d:%d:%d\n", 
whîe
, 
size
,

247 
bus_num
, 
	`PCI_SLOT
(
dev‚
), 
	`PCI_FUNC
(devfn));

249 *
vÆue
 = 0xffffffff;

250 
n
 = 
whîe
 % 4;

251 
byã_íabÀs
 = 
	`byã_œ√_íabÀ_bôs
(
n
, 
size
);

252 i‡(
byã_íabÀs
 == 0xffffffff)

253  
PCIBIOS_BAD_REGISTER_NUMBER
;

255 
addr
 = 
	`ixp4xx_c⁄fig_addr
(
bus_num
, 
dev‚
, 
whîe
);

256 i‡(
	`ixp4xx_pci_ªad
(
addr
, 
byã_íabÀs
 | 
NP_CMD_CONFIGREAD
, &
d©a
))

257  
PCIBIOS_DEVICE_NOT_FOUND
;

259 *
vÆue
 = (
d©a
 >> (8*
n
)Ë& 
byãmask
[
size
];

260 
	`¥_debug
("ªad_c⁄fig_byãÑód %#x\n", *
vÆue
);

261  
PCIBIOS_SUCCESSFUL
;

262 
	}
}

264 
	$ixp4xx_pci_wrôe_c⁄fig
(
pci_bus
 *
bus
, 
dev‚
, 
whîe
, 
size
, 
u32
 
vÆue
)

266 
u32
 
n
, 
byã_íabÀs
, 
addr
, 
d©a
;

267 
u8
 
bus_num
 = 
bus
->
numbî
;

269 
	`¥_debug
("wrôe_c⁄fig_byã %#xÅÿ%d sizê%d dev %d:%d:%d\n", 
vÆue
, 
whîe
,

270 
size
, 
bus_num
, 
	`PCI_SLOT
(
dev‚
), 
	`PCI_FUNC
(devfn));

272 
n
 = 
whîe
 % 4;

273 
byã_íabÀs
 = 
	`byã_œ√_íabÀ_bôs
(
n
, 
size
);

274 i‡(
byã_íabÀs
 == 0xffffffff)

275  
PCIBIOS_BAD_REGISTER_NUMBER
;

277 
addr
 = 
	`ixp4xx_c⁄fig_addr
(
bus_num
, 
dev‚
, 
whîe
);

278 
d©a
 = 
vÆue
 << (8*
n
);

279 i‡(
	`ixp4xx_pci_wrôe
(
addr
, 
byã_íabÀs
 | 
NP_CMD_CONFIGWRITE
, 
d©a
))

280  
PCIBIOS_DEVICE_NOT_FOUND
;

282  
PCIBIOS_SUCCESSFUL
;

283 
	}
}

285 
pci_›s
 
	gixp4xx_›s
 = {

286 .
ªad
 = 
ixp4xx_pci_ªad_c⁄fig
,

287 .
	gwrôe
 = 
ixp4xx_pci_wrôe_c⁄fig
,

293 
	$ab‹t_h™dÀr
(
addr
, 
f§
, 
±_ªgs
 *
ªgs
)

295 
u32
 
i§
, 
°©us
;

297 
i§
 = *
PCI_ISR
;

298 
	`loˇl_ªad_c⁄fig
(
PCI_STATUS
, 2, &
°©us
);

299 
	`¥_debug
("PCI:ábort_handleráddr = %#lx, isr = %#x, "

300 "°©u†%#x\n", 
addr
, 
i§
, 
°©us
);

303 *
PCI_ISR
 = 
PCI_ISR_PFE
;

304 
°©us
 |
PCI_STATUS_REC_MASTER_ABORT
;

305 
	`loˇl_wrôe_c⁄fig
(
PCI_STATUS
, 2, 
°©us
);

311 i‡(
f§
 & (1 << 10))

312 
ªgs
->
ARM_pc
 += 4;

315 
	}
}

321 
	$ixp4xx_pci_∂©f‹m_nŸify
(
devi˚
 *
dev
)

323 if(
dev
->
bus
 =&
pci_bus_ty≥
) {

324 *
dev
->
dma_mask
 = 
SZ_64M
 - 1;

325 
dev
->
cohîít_dma_mask
 = 
SZ_64M
 - 1;

326 
	`dmaboun˚_ªgi°î_dev
(
dev
, 2048, 4096);

329 
	}
}

331 
	$ixp4xx_pci_∂©f‹m_nŸify_ªmove
(
devi˚
 *
dev
)

333 if(
dev
->
bus
 =&
pci_bus_ty≥
) {

334 
	`dmaboun˚_uƒegi°î_dev
(
dev
);

337 
	}
}

339 
	$dma_√eds_boun˚
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
, 
size_t
 
size
)

341  (
dev
->
bus
 =&
pci_bus_ty≥
 ) && ((
dma_addr
 + 
size
Ë>
SZ_64M
);

342 
	}
}

350 
__öô
 
	$ixp4xx_adju°_z⁄es
(
node
, *
z⁄e_size
,

351 *
zhﬁe_size
)

353 
sz
 = 
SZ_64M
 >> 
PAGE_SHIFT
;

358 i‡(
node
 || (
z⁄e_size
[0] <
sz
))

361 
z⁄e_size
[1] = z⁄e_size[0] - 
sz
;

362 
z⁄e_size
[0] = 
sz
;

363 
zhﬁe_size
[1] = zhole_size[0];

364 
zhﬁe_size
[0] = 0;

365 
	}
}

367 
__öô
 
	$ixp4xx_pci_¥eöô
()

369 
¥o˚ss‹_id
;

371 
	`asm
("mr¯p15, 0, %0, cr0, cr0, 0;" : "Ù"(
¥o˚ss‹_id
) :);

377 i‡(!(
¥o˚ss‹_id
 & 0xfË&& 
	`˝u_is_ixp42x
()) {

378 
	`¥ötk
("PCI: IXP42x A0 silicon detected - "

380 
ixp4xx_pci_ªad
 = 
ixp4xx_pci_ªad_îøè
;

382 
ixp4xx_pci_ªad
 = 
ixp4xx_pci_ªad_no_îøè
;

386 
	`hook_Áu…_code
(16+6, 
ab‹t_h™dÀr
, 
SIGBUS
, "impreciseÉxternalábort");

388 
	`¥_debug
("setup PCI-AHB(inbound)ánd AHB-PCI(outbound)áddress mappings\n");

394 *
PCI_PCIMEMBASE
 = 0x48494A4B;

400 *
PCI_AHBMEMBASE
 = (
PHYS_OFFSET
 & 0xFF000000) +

401 ((
PHYS_OFFSET
 & 0xFF000000) >> 8) +

402 ((
PHYS_OFFSET
 & 0xFF000000) >> 16) +

403 ((
PHYS_OFFSET
 & 0xFF000000) >> 24) +

406 i‡(*
PCI_CSR
 & 
PCI_CSR_HOST
) {

407 
	`¥ötk
("PCI: IXP4xx is host\n");

409 
	`¥_debug
("setup BARs in controller\n");

415 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_0
, 4, 
PHYS_OFFSET
 + 0x00000000);

416 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_1
, 4, 
PHYS_OFFSET
 + 0x01000000);

417 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_2
, 4, 
PHYS_OFFSET
 + 0x02000000);

418 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_3
, 4, 
PHYS_OFFSET
 + 0x03000000);

423 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_4
, 4, 0xff000008);

428 
	`loˇl_wrôe_c⁄fig
(
PCI_BASE_ADDRESS_5
, 4, 0xfffffc01);

430 
	`¥ötk
("PCI: IXP4xx isÅarget - No bus scanÖerformed\n");

433 
	`¥ötk
("PCI: IXP4xx Using %sáccess for memory space\n",

434 #i‚de‡
CONFIG_IXP4XX_INDIRECT_PCI


441 
	`¥_debug
("clearÉrror bits in ISR\n");

442 *
PCI_ISR
 = 
PCI_ISR_PSE
 | 
PCI_ISR_PFE
 | 
PCI_ISR_PPE
 | 
PCI_ISR_AHBE
;

450 #ifde‡
__ARMEB__


451 *
PCI_CSR
 = 
PCI_CSR_IC
 | 
PCI_CSR_ABE
 | 
PCI_CSR_PDS
 | 
PCI_CSR_ADS
;

453 *
PCI_CSR
 = 
PCI_CSR_IC
 | 
PCI_CSR_ABE
;

456 
	`¥_debug
("DONE\n");

457 
	}
}

459 
	$ixp4xx_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
)

461 
ªsour˚
 *
ªs
;

463 i‡(
ƒ
 >= 1)

466 
ªs
 = 
	`kzÆloc
((*ªsË* 2, 
GFP_KERNEL
);

467 i‡(
ªs
 =
NULL
) {

472 
	`∑nic
("PCI: unableÅoállocateÑesources?\n");

475 
	`loˇl_wrôe_c⁄fig
(
PCI_COMMAND
, 2, 
PCI_COMMAND_MASTER
 | 
PCI_COMMAND_MEMORY
);

477 
ªs
[0].
«me
 = "PCI I/O Space";

478 
ªs
[0].
°¨t
 = 0x00000000;

479 
ªs
[0].
íd
 = 0x0000ffff;

480 
ªs
[0].
Êags
 = 
IORESOURCE_IO
;

482 
ªs
[1].
«me
 = "PCI Memory Space";

483 
ªs
[1].
°¨t
 = 
PCIBIOS_MIN_MEM
;

484 #i‚de‡
CONFIG_IXP4XX_INDIRECT_PCI


485 
ªs
[1].
íd
 = 0x4bffffff;

487 
ªs
[1].
íd
 = 0x4fffffff;

489 
ªs
[1].
Êags
 = 
IORESOURCE_MEM
;

491 
	`ªque°_ªsour˚
(&
i›‹t_ªsour˚
, &
ªs
[0]);

492 
	`ªque°_ªsour˚
(&
iomem_ªsour˚
, &
ªs
[1]);

494 
sys
->
ªsour˚
[0] = &
ªs
[0];

495 
sys
->
ªsour˚
[1] = &
ªs
[1];

496 
sys
->
ªsour˚
[2] = 
NULL
;

498 
∂©f‹m_nŸify
 = 
ixp4xx_pci_∂©f‹m_nŸify
;

499 
∂©f‹m_nŸify_ªmove
 = 
ixp4xx_pci_∂©f‹m_nŸify_ªmove
;

502 
	}
}

504 
pci_bus
 *
	$ixp4xx_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sys
)

506  
	`pci_sˇn_bus
(
sys
->
bu¢r
, &
ixp4xx_›s
, sys);

507 
	}
}

518 
	$pci_£t_dma_mask
(
pci_dev
 *
dev
, 
u64
 
mask
)

520 i‡(
mask
 >
SZ_64M
 - 1 )

523  -
EIO
;

524 
	}
}

527 
	$pci_£t_c⁄si°ít_dma_mask
(
pci_dev
 *
dev
, 
u64
 
mask
)

529 i‡(
mask
 >
SZ_64M
 - 1 )

532  -
EIO
;

533 
	}
}

535 
EXPORT_SYMBOL
(
ixp4xx_pci_ªad
);

536 
EXPORT_SYMBOL
(
ixp4xx_pci_wrôe
);

	@arch/arm/mach-ixp4xx/common.c

16 
	~<löux/kî√l.h
>

17 
	~<löux/mm.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/£rül.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/ây.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/£rül_c‹e.h
>

24 
	~<löux/boŸmem.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/bô›s.h
>

27 
	~<löux/time.h
>

28 
	~<löux/timex.h
>

29 
	~<löux/˛ocksour˚.h
>

30 
	~<löux/˛ockchùs.h
>

32 
	~<asm/¨ch/udc.h
>

33 
	~<asm/h¨dw¨e.h
>

34 
	~<asm/uac˚ss.h
>

35 
	~<asm/io.h
>

36 
	~<asm/pgèbÀ.h
>

37 
	~<asm/∑ge.h
>

38 
	~<asm/úq.h
>

40 
	~<asm/mach/m≠.h
>

41 
	~<asm/mach/úq.h
>

42 
	~<asm/mach/time.h
>

44 
__öô
 
ixp4xx_˛ocksour˚_öô
();

45 
__öô
 
ixp4xx_˛ockevít_öô
();

46 
˛ock_evít_devi˚
 
	g˛ockevít_ixp4xx
;

51 
m≠_desc
 
	gixp4xx_io_desc
[] 
	g__öôd©a
 = {

53 .
vútuÆ
 = 
IXP4XX_PERIPHERAL_BASE_VIRT
,

54 .
	gp‚
 = 
__phys_to_p‚
(
IXP4XX_PERIPHERAL_BASE_PHYS
),

55 .
	gÀngth
 = 
IXP4XX_PERIPHERAL_REGION_SIZE
,

56 .
	gty≥
 = 
MT_DEVICE


58 .
	gvútuÆ
 = 
IXP4XX_EXP_CFG_BASE_VIRT
,

59 .
	gp‚
 = 
__phys_to_p‚
(
IXP4XX_EXP_CFG_BASE_PHYS
),

60 .
	gÀngth
 = 
IXP4XX_EXP_CFG_REGION_SIZE
,

61 .
	gty≥
 = 
MT_DEVICE


63 .
	gvútuÆ
 = 
IXP4XX_PCI_CFG_BASE_VIRT
,

64 .
	gp‚
 = 
__phys_to_p‚
(
IXP4XX_PCI_CFG_BASE_PHYS
),

65 .
	gÀngth
 = 
IXP4XX_PCI_CFG_REGION_SIZE
,

66 .
	gty≥
 = 
MT_DEVICE


68 #ifde‡
CONFIG_DEBUG_LL


70 .
	gvútuÆ
 = 
IXP4XX_DEBUG_UART_BASE_VIRT
,

71 .
	gp‚
 = 
__phys_to_p‚
(
IXP4XX_DEBUG_UART_BASE_PHYS
),

72 .
	gÀngth
 = 
IXP4XX_DEBUG_UART_REGION_SIZE
,

73 .
	gty≥
 = 
MT_DEVICE


78 
__öô
 
	$ixp4xx_m≠_io
()

80 
	`iŸabÀ_öô
(
ixp4xx_io_desc
, 
	`ARRAY_SIZE
(ixp4xx_io_desc));

81 
	}
}

91 
	eixp4xx_úq_ty≥
 {

92 
	mIXP4XX_IRQ_LEVEL
, 
	mIXP4XX_IRQ_EDGE


96 
	gixp4xx_úq_edge
 = 0;

101 sig√d 
	gúq2gpio
[32] = {

108 
	$gpio_to_úq
(
gpio
)

110 
úq
;

112 
úq
 = 0; irq < 32; irq++) {

113 i‡(
úq2gpio
[
úq
] =
gpio
)

114  
úq
;

116  -
EINVAL
;

117 
	}
}

118 
EXPORT_SYMBOL
(
gpio_to_úq
);

120 
	$úq_to_gpio
(
úq
)

122 
gpio
 = (
úq
 < 32Ë? 
úq2gpio
[úq] : -
EINVAL
;

124 i‡(
gpio
 == -1)

125  -
EINVAL
;

127  
gpio
;

128 
	}
}

129 
EXPORT_SYMBOL
(
úq_to_gpio
);

131 
	$ixp4xx_£t_úq_ty≥
(
úq
, 
ty≥
)

133 
löe
 = 
úq2gpio
[
úq
];

134 
u32
 
öt_°yÀ
;

135 
ixp4xx_úq_ty≥
 
úq_ty≥
;

136 vﬁ©ûê
u32
 *
öt_ªg
;

141 i‡(
löe
 < 0)

142  -
EINVAL
;

144 
ty≥
){

145 
IRQT_BOTHEDGE
:

146 
öt_°yÀ
 = 
IXP4XX_GPIO_STYLE_TRANSITIONAL
;

147 
úq_ty≥
 = 
IXP4XX_IRQ_EDGE
;

149 
IRQT_RISING
:

150 
öt_°yÀ
 = 
IXP4XX_GPIO_STYLE_RISING_EDGE
;

151 
úq_ty≥
 = 
IXP4XX_IRQ_EDGE
;

153 
IRQT_FALLING
:

154 
öt_°yÀ
 = 
IXP4XX_GPIO_STYLE_FALLING_EDGE
;

155 
úq_ty≥
 = 
IXP4XX_IRQ_EDGE
;

157 
IRQT_HIGH
:

158 
öt_°yÀ
 = 
IXP4XX_GPIO_STYLE_ACTIVE_HIGH
;

159 
úq_ty≥
 = 
IXP4XX_IRQ_LEVEL
;

161 
IRQT_LOW
:

162 
öt_°yÀ
 = 
IXP4XX_GPIO_STYLE_ACTIVE_LOW
;

163 
úq_ty≥
 = 
IXP4XX_IRQ_LEVEL
;

166  -
EINVAL
;

169 i‡(
úq_ty≥
 =
IXP4XX_IRQ_EDGE
)

170 
ixp4xx_úq_edge
 |(1 << 
úq
);

172 
ixp4xx_úq_edge
 &~(1 << 
úq
);

174 i‡(
löe
 >= 8) {

175 
löe
 -= 8;

176 
öt_ªg
 = 
IXP4XX_GPIO_GPIT2R
;

178 
öt_ªg
 = 
IXP4XX_GPIO_GPIT1R
;

182 *
öt_ªg
 &~(
IXP4XX_GPIO_STYLE_CLEAR
 <<

183 (
löe
 * 
IXP4XX_GPIO_STYLE_SIZE
));

185 *
IXP4XX_GPIO_GPISR
 = (1 << 
löe
);

188 *
öt_ªg
 |(
öt_°yÀ
 << (
löe
 * 
IXP4XX_GPIO_STYLE_SIZE
));

191 
	`gpio_löe_c⁄fig
(
löe
, 
IXP4XX_GPIO_IN
);

194 
	}
}

196 
	$ixp4xx_úq_mask
(
úq
)

198 i‡((
	`˝u_is_ixp46x
(Ë|| 
	`˝u_is_ixp43x
()Ë&& 
úq
 >= 32)

199 *
IXP4XX_ICMR2
 &~(1 << (
úq
 - 32));

201 *
IXP4XX_ICMR
 &~(1 << 
úq
);

202 
	}
}

204 
	$ixp4xx_úq_ack
(
úq
)

206 
löe
 = (
úq
 < 32Ë? 
úq2gpio
[irq] : -1;

208 i‡(
löe
 >= 0)

209 *
IXP4XX_GPIO_GPISR
 = (1 << 
löe
);

210 
	}
}

216 
	$ixp4xx_úq_unmask
(
úq
)

218 i‡(!(
ixp4xx_úq_edge
 & (1 << 
úq
)))

219 
	`ixp4xx_úq_ack
(
úq
);

221 i‡((
	`˝u_is_ixp46x
(Ë|| 
	`˝u_is_ixp43x
()Ë&& 
úq
 >= 32)

222 *
IXP4XX_ICMR2
 |(1 << (
úq
 - 32));

224 *
IXP4XX_ICMR
 |(1 << 
úq
);

225 
	}
}

227 
úq_chù
 
	gixp4xx_úq_chù
 = {

228 .
«me
 = "IXP4xx",

229 .
	gack
 = 
ixp4xx_úq_ack
,

230 .
	gmask
 = 
ixp4xx_úq_mask
,

231 .
	gunmask
 = 
ixp4xx_úq_unmask
,

232 .
	g£t_ty≥
 = 
ixp4xx_£t_úq_ty≥
,

235 
__öô
 
	$ixp4xx_öô_úq
()

237 
i
 = 0;

240 *
IXP4XX_ICLR
 = 0x0;

243 *
IXP4XX_ICMR
 = 0x0;

245 i‡(
	`˝u_is_ixp46x
(Ë|| 
	`˝u_is_ixp43x
()) {

247 *
IXP4XX_ICLR2
 = 0x00;

250 *
IXP4XX_ICMR2
 = 0x00;

254 
i
 = 0; i < 
NR_IRQS
; i++) {

255 
	`£t_úq_chù
(
i
, &
ixp4xx_úq_chù
);

256 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

257 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

259 
	}
}

268 
úqªtu∫_t
 
	$ixp4xx_timî_öãºu±
(
úq
, *
dev_id
)

270 
˛ock_evít_devi˚
 *
evt
 = &
˛ockevít_ixp4xx
;

273 *
IXP4XX_OSST
 = 
IXP4XX_OSST_TIMER_1_PEND
;

275 
evt
->
	`evít_h™dÀr
(evt);

277  
IRQ_HANDLED
;

278 
	}
}

280 
úqa˘i⁄
 
	gixp4xx_timî_úq
 = {

281 .
«me
 = "timer1",

282 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

283 .
	gh™dÀr
 = 
ixp4xx_timî_öãºu±
,

286 
__öô
 
	$ixp4xx_timî_öô
()

289 *
IXP4XX_OSRT1
 = 0;

292 *
IXP4XX_OSST
 = 
IXP4XX_OSST_TIMER_1_PEND
;

295 *
IXP4XX_OSTS
 = 0;

298 
	`£tup_úq
(
IRQ_IXP4XX_TIMER1
, &
ixp4xx_timî_úq
);

300 
	`ixp4xx_˛ocksour˚_öô
();

301 
	`ixp4xx_˛ockevít_öô
();

302 
	}
}

304 
sys_timî
 
	gixp4xx_timî
 = {

305 .
öô
 = 
ixp4xx_timî_öô
,

308 
pxa2xx_udc_mach_öfo
 
	gixp4xx_udc_öfo
;

310 
__öô
 
	$ixp4xx_£t_udc_öfo
(
pxa2xx_udc_mach_öfo
 *
öfo
)

312 
	`mem˝y
(&
ixp4xx_udc_öfo
, 
öfo
,  *info);

313 
	}
}

315 
ªsour˚
 
	gixp4xx_udc_ªsour˚s
[] = {

317 .
°¨t
 = 0xc800b000,

318 .
	gíd
 = 0xc800bfff,

319 .
	gÊags
 = 
IORESOURCE_MEM
,

322 .
°¨t
 = 
IRQ_IXP4XX_USB
,

323 .
	gíd
 = 
IRQ_IXP4XX_USB
,

324 .
	gÊags
 = 
IORESOURCE_IRQ
,

332 
∂©f‹m_devi˚
 
	gixp4xx_udc_devi˚
 = {

333 .
«me
 = "pxa2xx-udc",

334 .
	gid
 = -1,

335 .
	gnum_ªsour˚s
 = 2,

336 .
	gªsour˚
 = 
ixp4xx_udc_ªsour˚s
,

337 .
	gdev
 = {

338 .
∂©f‹m_d©a
 = &
ixp4xx_udc_öfo
,

342 
∂©f‹m_devi˚
 *
	gixp4xx_devi˚s
[] 
	g__öôd©a
 = {

343 &
ixp4xx_udc_devi˚
,

346 
ªsour˚
 
	gixp46x_i2c_ªsour˚s
[] = {

348 .
°¨t
 = 0xc8011000,

349 .
	gíd
 = 0xc801101c,

350 .
	gÊags
 = 
IORESOURCE_MEM
,

353 .
°¨t
 = 
IRQ_IXP4XX_I2C
,

354 .
	gíd
 = 
IRQ_IXP4XX_I2C
,

355 .
	gÊags
 = 
IORESOURCE_IRQ


363 
∂©f‹m_devi˚
 
	gixp46x_i2c_c⁄åﬁÀr
 = {

364 .
«me
 = "IOP3xx-I2C",

365 .
	gid
 = 0,

366 .
	gnum_ªsour˚s
 = 2,

367 .
	gªsour˚
 = 
ixp46x_i2c_ªsour˚s


370 
∂©f‹m_devi˚
 *
	gixp46x_devi˚s
[] 
	g__öôd©a
 = {

371 &
ixp46x_i2c_c⁄åﬁÀr


374 
	gixp4xx_exp_bus_size
;

375 
EXPORT_SYMBOL
(
ixp4xx_exp_bus_size
);

377 
__öô
 
	$ixp4xx_sys_öô
()

379 
ixp4xx_exp_bus_size
 = 
SZ_16M
;

381 
	`∂©f‹m_add_devi˚s
(
ixp4xx_devi˚s
, 
	`ARRAY_SIZE
(ixp4xx_devices));

383 i‡(
	`˝u_is_ixp46x
()) {

384 
ªgi⁄
;

386 
	`∂©f‹m_add_devi˚s
(
ixp46x_devi˚s
,

387 
	`ARRAY_SIZE
(
ixp46x_devi˚s
));

389 
ªgi⁄
 = 0;Ñegion < 7;Ñegion++) {

390 if((*(
	`IXP4XX_EXP_REG
(0x4 * 
ªgi⁄
)) & 0x200)) {

391 
ixp4xx_exp_bus_size
 = 
SZ_32M
;

397 
	`¥ötk
("IXP4xx: Using %luMiBÉxpansion bus window size\n",

398 
ixp4xx_exp_bus_size
 >> 20);

399 
	}
}

404 
cy˛e_t
 
	$ixp4xx_gë_cy˛es
()

406  *
IXP4XX_OSTS
;

407 
	}
}

409 
˛ocksour˚
 
	g˛ocksour˚_ixp4xx
 = {

410 .
«me
 = "OSTS",

411 .
	gøtög
 = 200,

412 .
	gªad
 = 
ixp4xx_gë_cy˛es
,

413 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

414 .
	gshi·
 = 20,

415 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

418 
	gixp4xx_timî_‰eq
 = 
FREQ
;

419 
__öô
 
	$ixp4xx_˛ocksour˚_öô
()

421 
˛ocksour˚_ixp4xx
.
mu…
 =

422 
	`˛ocksour˚_hz2mu…
(
ixp4xx_timî_‰eq
,

423 
˛ocksour˚_ixp4xx
.
shi·
);

424 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_ixp4xx
);

427 
	}
}

432 
	$ixp4xx_£t_√xt_evít
(
evt
,

433 
˛ock_evít_devi˚
 *
unu£d
)

435 
›ts
 = *
IXP4XX_OSRT1
 & 
IXP4XX_OST_RELOAD_MASK
;

437 *
IXP4XX_OSRT1
 = (
evt
 & ~
IXP4XX_OST_RELOAD_MASK
Ë| 
›ts
;

440 
	}
}

442 
	$ixp4xx_£t_mode
(
˛ock_evít_mode
 
mode
,

443 
˛ock_evít_devi˚
 *
evt
)

445 
›ts
, 
o§t
 = *
IXP4XX_OSRT1
 & ~
IXP4XX_OST_RELOAD_MASK
;

447 
mode
) {

448 
CLOCK_EVT_MODE_PERIODIC
:

449 
o§t
 = 
LATCH
 & ~
IXP4XX_OST_RELOAD_MASK
;

450 
›ts
 = 
IXP4XX_OST_ENABLE
;

452 
CLOCK_EVT_MODE_ONESHOT
:

454 
o§t
 = 0;

455 
›ts
 = 
IXP4XX_OST_ENABLE
 | 
IXP4XX_OST_ONE_SHOT
;

457 
CLOCK_EVT_MODE_SHUTDOWN
:

458 
CLOCK_EVT_MODE_UNUSED
:

460 
o§t
 = 
›ts
 = 0;

464 *
IXP4XX_OSRT1
 = 
o§t
 | 
›ts
;

465 
	}
}

467 
˛ock_evít_devi˚
 
	g˛ockevít_ixp4xx
 = {

468 .
«me
 = "ixp4xxÅimer1",

469 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
 | 
CLOCK_EVT_FEAT_ONESHOT
,

470 .
	gøtög
 = 200,

471 .
	gshi·
 = 24,

472 .
	g£t_mode
 = 
ixp4xx_£t_mode
,

473 .
	g£t_√xt_evít
 = 
ixp4xx_£t_√xt_evít
,

476 
__öô
 
	$ixp4xx_˛ockevít_öô
()

478 
˛ockevít_ixp4xx
.
mu…
 = 
	`div_sc
(
FREQ
, 
NSEC_PER_SEC
,

479 
˛ockevít_ixp4xx
.
shi·
);

480 
˛ockevít_ixp4xx
.
max_dñè_ns
 =

481 
	`˛ockevít_dñè2ns
(0xffffff„, &
˛ockevít_ixp4xx
);

482 
˛ockevít_ixp4xx
.
mö_dñè_ns
 =

483 
	`˛ockevít_dñè2ns
(0xf, &
˛ockevít_ixp4xx
);

484 
˛ockevít_ixp4xx
.
˝umask
 = 
	`˝umask_of_˝u
(0);

486 
	`˛ockevíts_ªgi°î_devi˚
(&
˛ockevít_ixp4xx
);

488 
	}
}

	@arch/arm/mach-ixp4xx/coyote-pci.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/úq.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/úq.h
>

26 
	~<asm/mach/pci.h
>

28 
__öô
 
	$coyŸe_pci_¥eöô
()

30 
	`£t_úq_ty≥
(
IRQ_COYOTE_PCI_SLOT0
, 
IRQT_LOW
);

31 
	`£t_úq_ty≥
(
IRQ_COYOTE_PCI_SLOT1
, 
IRQT_LOW
);

33 
	`ixp4xx_pci_¥eöô
();

34 
	}
}

36 
__öô
 
	$coyŸe_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

38 i‡(
¶Ÿ
 =
COYOTE_PCI_SLOT0_DEVID
)

39  
IRQ_COYOTE_PCI_SLOT0
;

40 i‡(
¶Ÿ
 =
COYOTE_PCI_SLOT1_DEVID
)

41  
IRQ_COYOTE_PCI_SLOT1
;

43 
	}
}

45 
hw_pci
 
coyŸe_pci
 
	g__öôd©a
 = {

46 .
ƒ_c⁄åﬁÀrs
 = 1,

47 .
	g¥eöô
 = 
coyŸe_pci_¥eöô
,

48 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

49 .
	g£tup
 = 
ixp4xx_£tup
,

50 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

51 .
	gm≠_úq
 = 
coyŸe_m≠_úq
,

54 
__öô
 
	$coyŸe_pci_öô
()

56 i‡(
	`machöe_is_adi_coyŸe
())

57 
	`pci_comm⁄_öô
(&
coyŸe_pci
);

59 
	}
}

61 
subsys_öôˇŒ
(
coyŸe_pci_öô
);

	@arch/arm/mach-ixp4xx/coyote-setup.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/£rül.h
>

15 
	~<löux/ây.h
>

16 
	~<löux/£rül_8250.h
>

17 
	~<löux/¶ab.h
>

19 
	~<asm/ty≥s.h
>

20 
	~<asm/£tup.h
>

21 
	~<asm/mem‹y.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/Êash.h
>

28 
Êash_∂©f‹m_d©a
 
	gcoyŸe_Êash_d©a
 = {

29 .
m≠_«me
 = "cfi_probe",

30 .
	gwidth
 = 2,

33 
ªsour˚
 
	gcoyŸe_Êash_ªsour˚
 = {

34 .
Êags
 = 
IORESOURCE_MEM
,

37 
∂©f‹m_devi˚
 
	gcoyŸe_Êash
 = {

38 .
«me
 = "IXP4XX-Flash",

39 .
	gid
 = 0,

40 .
	gdev
 = {

41 .
∂©f‹m_d©a
 = &
coyŸe_Êash_d©a
,

43 .
	gnum_ªsour˚s
 = 1,

44 .
	gªsour˚
 = &
coyŸe_Êash_ªsour˚
,

47 
ªsour˚
 
	gcoyŸe_u¨t_ªsour˚
 = {

48 .
°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

49 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

50 .
	gÊags
 = 
IORESOURCE_MEM
,

53 
∂©_£rül8250_p‹t
 
	gcoyŸe_u¨t_d©a
[] = {

55 .
m≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

56 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

57 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

58 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

59 .
	giŸy≥
 = 
UPIO_MEM
,

60 .
	gªgshi·
 = 2,

61 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

66 
∂©f‹m_devi˚
 
	gcoyŸe_u¨t
 = {

67 .
«me
 = "serial8250",

68 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

69 .
	gdev
 = {

70 .
∂©f‹m_d©a
 = 
coyŸe_u¨t_d©a
,

72 .
	gnum_ªsour˚s
 = 1,

73 .
	gªsour˚
 = &
coyŸe_u¨t_ªsour˚
,

76 
∂©f‹m_devi˚
 *
	gcoyŸe_devi˚s
[] 
	g__öôd©a
 = {

77 &
coyŸe_Êash
,

78 &
coyŸe_u¨t


81 
__öô
 
	$coyŸe_öô
()

83 
	`ixp4xx_sys_öô
();

85 
coyŸe_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

86 
coyŸe_Êash_ªsour˚
.
íd
 = 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
SZ_32M
 - 1;

88 *
IXP4XX_EXP_CS0
 |
IXP4XX_FLASH_WRITABLE
;

89 *
IXP4XX_EXP_CS1
 = *
IXP4XX_EXP_CS0
;

91 i‡(
	`machöe_is_ixdpg425
()) {

92 
coyŸe_u¨t_d©a
[0].
memba£
 =

93 (*)(
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
);

94 
coyŸe_u¨t_d©a
[0].
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
;

95 
coyŸe_u¨t_d©a
[0].
úq
 = 
IRQ_IXP4XX_UART1
;

98 
	`∂©f‹m_add_devi˚s
(
coyŸe_devi˚s
, 
	`ARRAY_SIZE
(coyote_devices));

99 
	}
}

101 #ifde‡
CONFIG_ARCH_ADI_COYOTE


102 
MACHINE_START
(
ADI_COYOTE
, "ADI Engineering Coyote")

104 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

105 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

106 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

107 .
	göô_úq
 = 
ixp4xx_öô_úq
,

108 .
	gtimî
 = &
ixp4xx_timî
,

109 .
	gboŸ_∑øms
 = 0x0100,

110 .
	göô_machöe
 = 
coyŸe_öô
,

111 
	gMACHINE_END


118 #ifde‡
CONFIG_MACH_IXDPG425


119 
MACHINE_START
(
IXDPG425
, "Intel IXDPG425")

121 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

122 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

123 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

124 .
	göô_úq
 = 
ixp4xx_öô_úq
,

125 .
	gtimî
 = &
ixp4xx_timî
,

126 .
	gboŸ_∑øms
 = 0x0100,

127 .
	göô_machöe
 = 
coyŸe_öô
,

128 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/dsmg600-pci.c

19 
	~<löux/pci.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/úq.h
>

23 
	~<asm/mach/pci.h
>

24 
	~<asm/mach-ty≥s.h
>

26 
__öô
 
	$dsmg600_pci_¥eöô
()

28 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTA
, 
IRQT_LOW
);

29 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTB
, 
IRQT_LOW
);

30 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTC
, 
IRQT_LOW
);

31 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTD
, 
IRQT_LOW
);

32 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTE
, 
IRQT_LOW
);

33 
	`£t_úq_ty≥
(
IRQ_DSMG600_PCI_INTF
, 
IRQT_LOW
);

35 
	`ixp4xx_pci_¥eöô
();

36 
	}
}

38 
__öô
 
	$dsmg600_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

40 
pci_úq_èbÀ
[
DSMG600_PCI_MAX_DEV
][
DSMG600_PCI_IRQ_LINES
] =

42 { 
IRQ_DSMG600_PCI_INTE
, -1, -1 },

43 { 
IRQ_DSMG600_PCI_INTA
, -1, -1 },

44 { 
IRQ_DSMG600_PCI_INTB
, 
IRQ_DSMG600_PCI_INTC
, 
IRQ_DSMG600_PCI_INTD
 },

45 { 
IRQ_DSMG600_PCI_INTF
, -1, -1 },

48 
úq
 = -1;

50 i‡(
¶Ÿ
 >1 && slŸ <
DSMG600_PCI_MAX_DEV
 &&

51 
pö
 >1 &&Öö <
DSMG600_PCI_IRQ_LINES
)

52 
úq
 = 
pci_úq_èbÀ
[
¶Ÿ
-1][
pö
-1];

54  
úq
;

55 
	}
}

57 
hw_pci
 
__öôd©a
 
	gdsmg600_pci
 = {

58 .
ƒ_c⁄åﬁÀrs
 = 1,

59 .
	g¥eöô
 = 
dsmg600_pci_¥eöô
,

60 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

61 .
	g£tup
 = 
ixp4xx_£tup
,

62 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

63 .
	gm≠_úq
 = 
dsmg600_m≠_úq
,

66 
__öô
 
	$dsmg600_pci_öô
()

68 i‡(
	`machöe_is_dsmg600
())

69 
	`pci_comm⁄_öô
(&
dsmg600_pci
);

72 
	}
}

74 
subsys_öôˇŒ
(
dsmg600_pci_öô
);

	@arch/arm/mach-ixp4xx/dsmg600-power.c

22 
	~<löux/moduÀ.h
>

23 
	~<löux/ªboŸ.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/úq.h
>

26 
	~<löux/jiffõs.h
>

27 
	~<löux/timî.h
>

29 
	~<asm/mach-ty≥s.h
>

31 
˘æ_Æt_dñ
();

36 vﬁ©ûê
	gpowî_buâ⁄_cou¡down
;

39 
	#PBUTTON_HOLDDOWN_COUNT
 4

	)

41 
dsmg600_powî_h™dÀr
(
d©a
);

42 
DEFINE_TIMER
(
dsmg600_powî_timî
, 
dsmg600_powî_h™dÀr
, 0, 0);

44 
	$dsmg600_powî_h™dÀr
(
d©a
)

50 i‡(*
IXP4XX_GPIO_GPINR
 & 
DSMG600_PB_BM
) {

53 i‡(
powî_buâ⁄_cou¡down
 == 0) {

57 
	`˘æ_Æt_dñ
();

60 
	`gpio_löe_£t
(
DSMG600_LED_PWR_GPIO
, 
IXP4XX_GPIO_LOW
);

62 
powî_buâ⁄_cou¡down
--;

65 
powî_buâ⁄_cou¡down
 = 
PBUTTON_HOLDDOWN_COUNT
;

68 
	`mod_timî
(&
dsmg600_powî_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(500));

69 
	}
}

71 
úqªtu∫_t
 
	$dsmg600_ª£t_h™dÀr
(
úq
, *
dev_id
)

74 
	`machöe_powî_off
();

76  
IRQ_HANDLED
;

77 
	}
}

79 
__öô
 
	$dsmg600_powî_öô
()

81 i‡(!(
	`machöe_is_dsmg600
()))

84 i‡(
	`ªque°_úq
(
DSMG600_RB_IRQ
, &
dsmg600_ª£t_h™dÀr
,

85 
IRQF_DISABLED
 | 
IRQF_TRIGGER_LOW
, "DSM-G600Ñeset button",

86 
NULL
) < 0) {

88 
	`¥ötk
(
KERN_DEBUG
 "Reset Button IRQ %dÇotávailable\n",

89 
DSMG600_RB_IRQ
);

91  -
EIO
;

100 
	`gpio_löe_c⁄fig
(
DSMG600_PB_GPIO
, 
IXP4XX_GPIO_IN
);

103 
powî_buâ⁄_cou¡down
 = 
PBUTTON_HOLDDOWN_COUNT
;

105 
	`mod_timî
(&
dsmg600_powî_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(500));

108 
	}
}

110 
__exô
 
	$dsmg600_powî_exô
()

112 i‡(!(
	`machöe_is_dsmg600
()))

115 
	`dñ_timî_sync
(&
dsmg600_powî_timî
);

117 
	`‰ì_úq
(
DSMG600_RB_IRQ
, 
NULL
);

118 
	}
}

120 
moduÀ_öô
(
dsmg600_powî_öô
);

121 
moduÀ_exô
(
dsmg600_powî_exô
);

123 
MODULE_AUTHOR
("Michael Westerhof <mwester@dls.net>");

124 
MODULE_DESCRIPTION
("DSM-G600 Power/Reset driver");

125 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-ixp4xx/dsmg600-setup.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/£rül.h
>

16 
	~<löux/£rül_8250.h
>

18 
	~<asm/mach-ty≥s.h
>

19 
	~<asm/mach/¨ch.h
>

20 
	~<asm/mach/Êash.h
>

21 
	~<asm/mach/time.h
>

23 
Êash_∂©f‹m_d©a
 
	gdsmg600_Êash_d©a
 = {

24 .
m≠_«me
 = "cfi_probe",

25 .
	gwidth
 = 2,

28 
ªsour˚
 
	gdsmg600_Êash_ªsour˚
 = {

29 .
Êags
 = 
IORESOURCE_MEM
,

32 
∂©f‹m_devi˚
 
	gdsmg600_Êash
 = {

33 .
«me
 = "IXP4XX-Flash",

34 .
	gid
 = 0,

35 .
	gdev
.
	g∂©f‹m_d©a
 = &
dsmg600_Êash_d©a
,

36 .
	gnum_ªsour˚s
 = 1,

37 .
	gªsour˚
 = &
dsmg600_Êash_ªsour˚
,

40 
ixp4xx_i2c_pös
 
	gdsmg600_i2c_gpio_pös
 = {

41 .
sda_pö
 = 
DSMG600_SDA_PIN
,

42 .
	gs˛_pö
 = 
DSMG600_SCL_PIN
,

45 
∂©f‹m_devi˚
 
	gdsmg600_i2c_c⁄åﬁÀr
 = {

46 .
«me
 = "IXP4XX-I2C",

47 .
	gid
 = 0,

48 .
	gdev
.
	g∂©f‹m_d©a
 = &
dsmg600_i2c_gpio_pös
,

51 #ifde‡
CONFIG_LEDS_CLASS


52 
ªsour˚
 
	gdsmg600_Àd_ªsour˚s
[] = {

54 .
«me
 = "power",

55 .
	g°¨t
 = 
DSMG600_LED_PWR_GPIO
,

56 .
	gíd
 = 
DSMG600_LED_PWR_GPIO
,

57 .
	gÊags
 = 
IXP4XX_GPIO_HIGH
,

60 .
	g«me
 = "wlan",

61 .
	g°¨t
 = 
DSMG600_LED_WLAN_GPIO
,

62 .
	gíd
 = 
DSMG600_LED_WLAN_GPIO
,

63 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

67 
∂©f‹m_devi˚
 
	gdsmg600_Àds
 = {

68 .
«me
 = "IXP4XX-GPIO-LED",

69 .
	gid
 = -1,

70 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dsmg600_Àd_ªsour˚s
),

71 .
	gªsour˚
 = 
dsmg600_Àd_ªsour˚s
,

75 
ªsour˚
 
	gdsmg600_u¨t_ªsour˚s
[] = {

77 .
°¨t
 = 
IXP4XX_UART1_BASE_PHYS
,

78 .
	gíd
 = 
IXP4XX_UART1_BASE_PHYS
 + 0x0fff,

79 .
	gÊags
 = 
IORESOURCE_MEM
,

82 .
	g°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

83 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

84 .
	gÊags
 = 
IORESOURCE_MEM
,

88 
∂©_£rül8250_p‹t
 
	gdsmg600_u¨t_d©a
[] = {

90 .
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
,

91 .
	gmemba£
 = (*)
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
,

92 .
	gúq
 = 
IRQ_IXP4XX_UART1
,

93 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

94 .
	giŸy≥
 = 
UPIO_MEM
,

95 .
	gªgshi·
 = 2,

96 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

99 .
	gm≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

100 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

101 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

102 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

103 .
	giŸy≥
 = 
UPIO_MEM
,

104 .
	gªgshi·
 = 2,

105 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

110 
∂©f‹m_devi˚
 
	gdsmg600_u¨t
 = {

111 .
«me
 = "serial8250",

112 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

113 .
	gdev
.
	g∂©f‹m_d©a
 = 
dsmg600_u¨t_d©a
,

114 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dsmg600_u¨t_ªsour˚s
),

115 .
	gªsour˚
 = 
dsmg600_u¨t_ªsour˚s
,

118 
∂©f‹m_devi˚
 *
	gdsmg600_devi˚s
[] 
	g__öôd©a
 = {

119 &
dsmg600_i2c_c⁄åﬁÀr
,

120 &
dsmg600_Êash
,

123 
	$dsmg600_powî_off
()

126 
	`gpio_löe_c⁄fig
(
DSMG600_PO_GPIO
, 
IXP4XX_GPIO_OUT
);

129 
	`gpio_löe_£t
(
DSMG600_PO_GPIO
, 
IXP4XX_GPIO_HIGH
);

130 
	}
}

132 
__öô
 
	$dsmg600_timî_öô
()

135 
ixp4xx_timî_‰eq
 = 
DSMG600_FREQ
;

138 
	`ixp4xx_timî_öô
();

139 
	}
}

141 
sys_timî
 
	gdsmg600_timî
 = {

142 .
öô
 = 
dsmg600_timî_öô
,

145 
__öô
 
	$dsmg600_öô
()

147 
	`ixp4xx_sys_öô
();

150 *
IXP4XX_GPIO_GPCLKR
 = 0;

152 
dsmg600_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

153 
dsmg600_Êash_ªsour˚
.
íd
 =

154 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
ixp4xx_exp_bus_size
 - 1;

156 
pm_powî_off
 = 
dsmg600_powî_off
;

162 ()
	`∂©f‹m_devi˚_ªgi°î
(&
dsmg600_u¨t
);

164 
	`∂©f‹m_add_devi˚s
(
dsmg600_devi˚s
, 
	`ARRAY_SIZE
(dsmg600_devices));

166 #ifde‡
CONFIG_LEDS_CLASS


168 ()
	`∂©f‹m_devi˚_ªgi°î
(&
dsmg600_Àds
);

170 
	}
}

172 
MACHINE_START
(
DSMG600
, "D-Link DSM-G600 RevA")

174 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

175 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xFFFC,

176 .
	gboŸ_∑øms
 = 0x00000100,

177 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

178 .
	göô_úq
 = 
ixp4xx_öô_úq
,

179 .
	gtimî
 = &
dsmg600_timî
,

180 .
	göô_machöe
 = 
dsmg600_öô
,

181 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/gtwx5715-pci.c

25 
	~<löux/pci.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/dñay.h
>

28 
	~<asm/mach-ty≥s.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/¨ch/gtwx5715.h
>

32 
	~<asm/mach/pci.h
>

34 
ixp4xx_pci_¥eöô
();

35 
ixp4xx_£tup
(
ƒ
, 
pci_sys_d©a
 *
sys
);

36 
pci_bus
 *
ixp4xx_sˇn_bus
(
ƒ
, 
pci_sys_d©a
 *
sys
);

46 
__öô
 
	$gtwx5715_pci_¥eöô
()

48 
	`£t_úq_ty≥
(
GTWX5715_PCI_SLOT0_INTA_IRQ
, 
IRQT_LOW
);

49 
	`£t_úq_ty≥
(
GTWX5715_PCI_SLOT0_INTB_IRQ
, 
IRQT_LOW
);

50 
	`£t_úq_ty≥
(
GTWX5715_PCI_SLOT1_INTA_IRQ
, 
IRQT_LOW
);

51 
	`£t_úq_ty≥
(
GTWX5715_PCI_SLOT1_INTB_IRQ
, 
IRQT_LOW
);

53 
	`ixp4xx_pci_¥eöô
();

54 
	}
}

57 
__öô
 
	$gtwx5715_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

59 
rc
;

60 
gtwx5715_úqm≠


61 [
GTWX5715_PCI_SLOT_COUNT
]

62 [
GTWX5715_PCI_INT_PIN_COUNT
] = {

63 {
GTWX5715_PCI_SLOT0_INTA_IRQ
, 
GTWX5715_PCI_SLOT0_INTB_IRQ
},

64 {
GTWX5715_PCI_SLOT1_INTA_IRQ
, 
GTWX5715_PCI_SLOT1_INTB_IRQ
},

67 i‡(
¶Ÿ
 >
GTWX5715_PCI_SLOT_COUNT
 ||

68 
pö
 >
GTWX5715_PCI_INT_PIN_COUNT
Ë
rc
 = -1;

70 
rc
 = 
gtwx5715_úqm≠
[
¶Ÿ
][
pö
-1];

72 
	`¥ötk
("%s: M≠≥d slŸ %dÖö %dÅÿIRQ %d\n", 
__FUNCTION__
,
¶Ÿ
, 
pö
, 
rc
);

73 (
rc
);

74 
	}
}

76 
hw_pci
 
gtwx5715_pci
 
	g__öôd©a
 = {

77 .
ƒ_c⁄åﬁÀrs
 = 1,

78 .
	g¥eöô
 = 
gtwx5715_pci_¥eöô
,

79 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

80 .
	g£tup
 = 
ixp4xx_£tup
,

81 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

82 .
	gm≠_úq
 = 
gtwx5715_m≠_úq
,

85 
__öô
 
	$gtwx5715_pci_öô
()

87 i‡(
	`machöe_is_gtwx5715
())

89 
	`pci_comm⁄_öô
(&
gtwx5715_pci
);

93 
	}
}

95 
subsys_öôˇŒ
(
gtwx5715_pci_öô
);

	@arch/arm/mach-ixp4xx/gtwx5715-setup.c

25 
	~<löux/öô.h
>

26 
	~<löux/devi˚.h
>

27 
	~<löux/£rül.h
>

28 
	~<löux/ây.h
>

29 
	~<löux/£rül_8250.h
>

30 
	~<löux/¶ab.h
>

32 
	~<asm/ty≥s.h
>

33 
	~<asm/£tup.h
>

34 
	~<asm/mem‹y.h
>

35 
	~<asm/h¨dw¨e.h
>

36 
	~<asm/úq.h
>

37 
	~<asm/mach-ty≥s.h
>

38 
	~<asm/mach/¨ch.h
>

39 
	~<asm/mach/Êash.h
>

40 
	~<asm/¨ch/gtwx5715.h
>

57 #ifdef 
__ARMEB__


58 
	#REG_OFFSET
 3

	)

60 
	#REG_OFFSET
 0

	)

67 
ªsour˚
 
	ggtwx5715_u¨t_ªsour˚s
[] = {

69 .
°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

70 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

71 .
	gÊags
 = 
IORESOURCE_MEM
,

74 .
	g°¨t
 = 
IRQ_IXP4XX_UART2
,

75 .
	gíd
 = 
IRQ_IXP4XX_UART2
,

76 .
	gÊags
 = 
IORESOURCE_IRQ
,

82 
∂©_£rül8250_p‹t
 
	ggtwx5715_u¨t_∂©f‹m_d©a
[] = {

84 .
m≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

85 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

86 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

87 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

88 .
	giŸy≥
 = 
UPIO_MEM
,

89 .
	gªgshi·
 = 2,

90 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

95 
∂©f‹m_devi˚
 
	ggtwx5715_u¨t_devi˚
 = {

96 .
«me
 = "serial8250",

97 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

98 .
	gdev
 = {

99 .
∂©f‹m_d©a
 = 
gtwx5715_u¨t_∂©f‹m_d©a
,

101 .
	gnum_ªsour˚s
 = 2,

102 .
	gªsour˚
 = 
gtwx5715_u¨t_ªsour˚s
,

105 
Êash_∂©f‹m_d©a
 
	ggtwx5715_Êash_d©a
 = {

106 .
m≠_«me
 = "cfi_probe",

107 .
	gwidth
 = 2,

110 
ªsour˚
 
	ggtwx5715_Êash_ªsour˚
 = {

111 .
Êags
 = 
IORESOURCE_MEM
,

114 
∂©f‹m_devi˚
 
	ggtwx5715_Êash
 = {

115 .
«me
 = "IXP4XX-Flash",

116 .
	gid
 = 0,

117 .
	gdev
 = {

118 .
∂©f‹m_d©a
 = &
gtwx5715_Êash_d©a
,

120 .
	gnum_ªsour˚s
 = 1,

121 .
	gªsour˚
 = &
gtwx5715_Êash_ªsour˚
,

124 
∂©f‹m_devi˚
 *
	ggtwx5715_devi˚s
[] 
	g__öôd©a
 = {

125 &
gtwx5715_u¨t_devi˚
,

126 &
gtwx5715_Êash
,

129 
__öô
 
	$gtwx5715_öô
()

131 
	`ixp4xx_sys_öô
();

133 
gtwx5715_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

134 
gtwx5715_Êash_ªsour˚
.
íd
 = 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
SZ_8M
 - 1;

136 
	`∂©f‹m_add_devi˚s
(
gtwx5715_devi˚s
, 
	`ARRAY_SIZE
(gtwx5715_devices));

137 
	}
}

140 
MACHINE_START
(
GTWX5715
, "Gemtek GTWX5715 (Linksys WRV54G)")

142 .
	gphys_io
 = 
IXP4XX_UART2_BASE_PHYS
,

143 .
	gio_pg_off°
 = ((
IXP4XX_UART2_BASE_VIRT
) >> 18) & 0xfffc,

144 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

145 .
	göô_úq
 = 
ixp4xx_öô_úq
,

146 .
	gtimî
 = &
ixp4xx_timî
,

147 .
	gboŸ_∑øms
 = 0x0100,

148 .
	göô_machöe
 = 
gtwx5715_öô
,

149 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/ixdp425-pci.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/pci.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/úq.h
>

21 
	~<löux/dñay.h
>

23 
	~<asm/mach/pci.h
>

24 
	~<asm/úq.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/mach-ty≥s.h
>

28 
__öô
 
	$ixdp425_pci_¥eöô
()

30 
	`£t_úq_ty≥
(
IRQ_IXDP425_PCI_INTA
, 
IRQT_LOW
);

31 
	`£t_úq_ty≥
(
IRQ_IXDP425_PCI_INTB
, 
IRQT_LOW
);

32 
	`£t_úq_ty≥
(
IRQ_IXDP425_PCI_INTC
, 
IRQT_LOW
);

33 
	`£t_úq_ty≥
(
IRQ_IXDP425_PCI_INTD
, 
IRQT_LOW
);

35 
	`ixp4xx_pci_¥eöô
();

36 
	}
}

38 
__öô
 
	$ixdp425_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

40 
pci_úq_èbÀ
[
IXDP425_PCI_IRQ_LINES
] = {

41 
IRQ_IXDP425_PCI_INTA
,

42 
IRQ_IXDP425_PCI_INTB
,

43 
IRQ_IXDP425_PCI_INTC
,

44 
IRQ_IXDP425_PCI_INTD


47 
úq
 = -1;

49 i‡(
¶Ÿ
 >1 && slŸ <
IXDP425_PCI_MAX_DEV
 &&

50 
pö
 >1 &&Öö <
IXDP425_PCI_IRQ_LINES
) {

51 
úq
 = 
pci_úq_èbÀ
[(
¶Ÿ
 + 
pö
 - 2) % 4];

54  
úq
;

55 
	}
}

57 
hw_pci
 
ixdp425_pci
 
	g__öôd©a
 = {

58 .
ƒ_c⁄åﬁÀrs
 = 1,

59 .
	g¥eöô
 = 
ixdp425_pci_¥eöô
,

60 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

61 .
	g£tup
 = 
ixp4xx_£tup
,

62 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

63 .
	gm≠_úq
 = 
ixdp425_m≠_úq
,

66 
__öô
 
	$ixdp425_pci_öô
()

68 i‡(
	`machöe_is_ixdp425
(Ë|| 
	`machöe_is_ixcdp1100
() ||

69 
	`machöe_is_ixdp465
(Ë|| 
	`machöe_is_kixΩ435
())

70 
	`pci_comm⁄_öô
(&
ixdp425_pci
);

72 
	}
}

74 
subsys_öôˇŒ
(
ixdp425_pci_öô
);

	@arch/arm/mach-ixp4xx/ixdp425-setup.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/£rül.h
>

15 
	~<löux/ây.h
>

16 
	~<löux/£rül_8250.h
>

17 
	~<löux/¶ab.h
>

19 
	~<asm/ty≥s.h
>

20 
	~<asm/£tup.h
>

21 
	~<asm/mem‹y.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/úq.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/Êash.h
>

28 
Êash_∂©f‹m_d©a
 
	gixdp425_Êash_d©a
 = {

29 .
m≠_«me
 = "cfi_probe",

30 .
	gwidth
 = 2,

33 
ªsour˚
 
	gixdp425_Êash_ªsour˚
 = {

34 .
Êags
 = 
IORESOURCE_MEM
,

37 
∂©f‹m_devi˚
 
	gixdp425_Êash
 = {

38 .
«me
 = "IXP4XX-Flash",

39 .
	gid
 = 0,

40 .
	gdev
 = {

41 .
∂©f‹m_d©a
 = &
ixdp425_Êash_d©a
,

43 .
	gnum_ªsour˚s
 = 1,

44 .
	gªsour˚
 = &
ixdp425_Êash_ªsour˚
,

47 
ixp4xx_i2c_pös
 
	gixdp425_i2c_gpio_pös
 = {

48 .
sda_pö
 = 
IXDP425_SDA_PIN
,

49 .
	gs˛_pö
 = 
IXDP425_SCL_PIN
,

52 
∂©f‹m_devi˚
 
	gixdp425_i2c_c⁄åﬁÀr
 = {

53 .
«me
 = "IXP4XX-I2C",

54 .
	gid
 = 0,

55 .
	gdev
 = {

56 .
∂©f‹m_d©a
 = &
ixdp425_i2c_gpio_pös
,

58 .
	gnum_ªsour˚s
 = 0

61 
ªsour˚
 
	gixdp425_u¨t_ªsour˚s
[] = {

63 .
°¨t
 = 
IXP4XX_UART1_BASE_PHYS
,

64 .
	gíd
 = 
IXP4XX_UART1_BASE_PHYS
 + 0x0fff,

65 .
	gÊags
 = 
IORESOURCE_MEM


68 .
	g°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

69 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

70 .
	gÊags
 = 
IORESOURCE_MEM


74 
∂©_£rül8250_p‹t
 
	gixdp425_u¨t_d©a
[] = {

76 .
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
,

77 .
	gmemba£
 = (*)
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
,

78 .
	gúq
 = 
IRQ_IXP4XX_UART1
,

79 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

80 .
	giŸy≥
 = 
UPIO_MEM
,

81 .
	gªgshi·
 = 2,

82 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

85 .
	gm≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

86 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

87 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

88 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SKIP_TEST
,

89 .
	giŸy≥
 = 
UPIO_MEM
,

90 .
	gªgshi·
 = 2,

91 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

96 
∂©f‹m_devi˚
 
	gixdp425_u¨t
 = {

97 .
«me
 = "serial8250",

98 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

99 .
	gdev
.
	g∂©f‹m_d©a
 = 
ixdp425_u¨t_d©a
,

100 .
	gnum_ªsour˚s
 = 2,

101 .
	gªsour˚
 = 
ixdp425_u¨t_ªsour˚s


104 
∂©f‹m_devi˚
 *
	gixdp425_devi˚s
[] 
	g__öôd©a
 = {

105 &
ixdp425_i2c_c⁄åﬁÀr
,

106 &
ixdp425_Êash
,

107 &
ixdp425_u¨t


110 
__öô
 
	$ixdp425_öô
()

112 
	`ixp4xx_sys_öô
();

114 
ixdp425_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

115 
ixdp425_Êash_ªsour˚
.
íd
 =

116 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
ixp4xx_exp_bus_size
 - 1;

118 i‡(
	`˝u_is_ixp43x
()) {

119 
ixdp425_u¨t
.
num_ªsour˚s
 = 1;

120 
ixdp425_u¨t_d©a
[1].
Êags
 = 0;

123 
	`∂©f‹m_add_devi˚s
(
ixdp425_devi˚s
, 
	`ARRAY_SIZE
(ixdp425_devices));

124 
	}
}

126 #ifde‡
CONFIG_ARCH_IXDP425


127 
MACHINE_START
(
IXDP425
, "Intel IXDP425 Development Platform")

129 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

130 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

131 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

132 .
	göô_úq
 = 
ixp4xx_öô_úq
,

133 .
	gtimî
 = &
ixp4xx_timî
,

134 .
	gboŸ_∑øms
 = 0x0100,

135 .
	göô_machöe
 = 
ixdp425_öô
,

136 
	gMACHINE_END


139 #ifde‡
CONFIG_MACH_IXDP465


140 
MACHINE_START
(
IXDP465
, "Intel IXDP465 Development Platform")

142 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

143 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

144 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

145 .
	göô_úq
 = 
ixp4xx_öô_úq
,

146 .
	gtimî
 = &
ixp4xx_timî
,

147 .
	gboŸ_∑øms
 = 0x0100,

148 .
	göô_machöe
 = 
ixdp425_öô
,

149 
	gMACHINE_END


152 #ifde‡
CONFIG_ARCH_PRPMC1100


153 
MACHINE_START
(
IXCDP1100
, "Intel IXCDP1100 Development Platform")

155 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

156 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

157 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

158 .
	göô_úq
 = 
ixp4xx_öô_úq
,

159 .
	gtimî
 = &
ixp4xx_timî
,

160 .
	gboŸ_∑øms
 = 0x0100,

161 .
	göô_machöe
 = 
ixdp425_öô
,

162 
	gMACHINE_END


165 #ifde‡
CONFIG_MACH_KIXRP435


166 
MACHINE_START
(
KIXRP435
, "Intel KIXRP435 Reference Platform")

168 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

169 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xfffc,

170 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

171 .
	göô_úq
 = 
ixp4xx_öô_úq
,

172 .
	gtimî
 = &
ixp4xx_timî
,

173 .
	gboŸ_∑øms
 = 0x0100,

174 .
	göô_machöe
 = 
ixdp425_öô
,

175 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/ixdpg425-pci.c

16 
	~<löux/kî√l.h
>

17 
	~<löux/pci.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/úq.h
>

21 
	~<asm/mach-ty≥s.h
>

22 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach/pci.h
>

26 
__öô
 
	$ixdpg425_pci_¥eöô
()

28 
	`£t_úq_ty≥
(
IRQ_IXP4XX_GPIO6
, 
IRQT_LOW
);

29 
	`£t_úq_ty≥
(
IRQ_IXP4XX_GPIO7
, 
IRQT_LOW
);

31 
	`ixp4xx_pci_¥eöô
();

32 
	}
}

34 
__öô
 
	$ixdpg425_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

36 i‡(
¶Ÿ
 == 12 || slot == 13)

37  
IRQ_IXP4XX_GPIO7
;

38 i‡(
¶Ÿ
 == 14)

39  
IRQ_IXP4XX_GPIO6
;

41 
	}
}

43 
hw_pci
 
ixdpg425_pci
 
	g__öôd©a
 = {

44 .
ƒ_c⁄åﬁÀrs
 = 1,

45 .
	g¥eöô
 = 
ixdpg425_pci_¥eöô
,

46 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

47 .
	g£tup
 = 
ixp4xx_£tup
,

48 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

49 .
	gm≠_úq
 = 
ixdpg425_m≠_úq
,

52 
__öô
 
	$ixdpg425_pci_öô
()

54 i‡(
	`machöe_is_ixdpg425
())

55 
	`pci_comm⁄_öô
(&
ixdpg425_pci
);

57 
	}
}

59 
subsys_öôˇŒ
(
ixdpg425_pci_öô
);

	@arch/arm/mach-ixp4xx/nas100d-pci.c

18 
	~<löux/pci.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/úq.h
>

22 
	~<asm/mach/pci.h
>

23 
	~<asm/mach-ty≥s.h
>

25 
__öô
 
	$«s100d_pci_¥eöô
()

27 
	`£t_úq_ty≥
(
IRQ_NAS100D_PCI_INTA
, 
IRQT_LOW
);

28 
	`£t_úq_ty≥
(
IRQ_NAS100D_PCI_INTB
, 
IRQT_LOW
);

29 
	`£t_úq_ty≥
(
IRQ_NAS100D_PCI_INTC
, 
IRQT_LOW
);

30 
	`£t_úq_ty≥
(
IRQ_NAS100D_PCI_INTD
, 
IRQT_LOW
);

31 
	`£t_úq_ty≥
(
IRQ_NAS100D_PCI_INTE
, 
IRQT_LOW
);

33 
	`ixp4xx_pci_¥eöô
();

34 
	}
}

36 
__öô
 
	$«s100d_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

38 
pci_úq_èbÀ
[
NAS100D_PCI_MAX_DEV
][
NAS100D_PCI_IRQ_LINES
] =

40 { 
IRQ_NAS100D_PCI_INTA
, -1, -1 },

41 { 
IRQ_NAS100D_PCI_INTB
, -1, -1 },

42 { 
IRQ_NAS100D_PCI_INTC
, 
IRQ_NAS100D_PCI_INTD
, 
IRQ_NAS100D_PCI_INTE
 },

45 
úq
 = -1;

47 i‡(
¶Ÿ
 >1 && slŸ <
NAS100D_PCI_MAX_DEV
 &&

48 
pö
 >1 &&Öö <
NAS100D_PCI_IRQ_LINES
)

49 
úq
 = 
pci_úq_èbÀ
[
¶Ÿ
-1][
pö
-1];

51  
úq
;

52 
	}
}

54 
hw_pci
 
__öôd©a
 
	g«s100d_pci
 = {

55 .
ƒ_c⁄åﬁÀrs
 = 1,

56 .
	g¥eöô
 = 
«s100d_pci_¥eöô
,

57 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

58 .
	g£tup
 = 
ixp4xx_£tup
,

59 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

60 .
	gm≠_úq
 = 
«s100d_m≠_úq
,

63 
__öô
 
	$«s100d_pci_öô
()

65 i‡(
	`machöe_is_«s100d
())

66 
	`pci_comm⁄_öô
(&
«s100d_pci
);

69 
	}
}

71 
subsys_öôˇŒ
(
«s100d_pci_öô
);

	@arch/arm/mach-ixp4xx/nas100d-power.c

20 
	~<löux/öãºu±.h
>

21 
	~<löux/úq.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/ªboŸ.h
>

25 
	~<asm/mach-ty≥s.h
>

27 
úqªtu∫_t
 
	$«s100d_ª£t_h™dÀr
(
úq
, *
dev_id
)

32 
	`˘æ_Æt_dñ
();

34  
IRQ_HANDLED
;

35 
	}
}

37 
__öô
 
	$«s100d_powî_öô
()

39 i‡(!(
	`machöe_is_«s100d
()))

42 
	`£t_úq_ty≥
(
NAS100D_RB_IRQ
, 
IRQT_LOW
);

44 i‡(
	`ªque°_úq
(
NAS100D_RB_IRQ
, &
«s100d_ª£t_h™dÀr
,

45 
IRQF_DISABLED
, "NAS100DÑe£àbuâ⁄", 
NULL
) < 0) {

47 
	`¥ötk
(
KERN_DEBUG
 "Reset Button IRQ %dÇotávailable\n",

48 
NAS100D_RB_IRQ
);

50  -
EIO
;

54 
	}
}

56 
__exô
 
	$«s100d_powî_exô
()

58 i‡(!(
	`machöe_is_«s100d
()))

61 
	`‰ì_úq
(
NAS100D_RB_IRQ
, 
NULL
);

62 
	}
}

64 
moduÀ_öô
(
«s100d_powî_öô
);

65 
moduÀ_exô
(
«s100d_powî_exô
);

67 
MODULE_AUTHOR
("Alessandro Zummo <a.zummo@towertech.it>");

68 
MODULE_DESCRIPTION
("NAS100D Power/Reset driver");

69 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-ixp4xx/nas100d-setup.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/£rül.h
>

17 
	~<löux/£rül_8250.h
>

18 
	~<löux/Àds.h
>

20 
	~<asm/mach-ty≥s.h
>

21 
	~<asm/mach/¨ch.h
>

22 
	~<asm/mach/Êash.h
>

24 
Êash_∂©f‹m_d©a
 
	g«s100d_Êash_d©a
 = {

25 .
m≠_«me
 = "cfi_probe",

26 .
	gwidth
 = 2,

29 
ªsour˚
 
	g«s100d_Êash_ªsour˚
 = {

30 .
Êags
 = 
IORESOURCE_MEM
,

33 
∂©f‹m_devi˚
 
	g«s100d_Êash
 = {

34 .
«me
 = "IXP4XX-Flash",

35 .
	gid
 = 0,

36 .
	gdev
.
	g∂©f‹m_d©a
 = &
«s100d_Êash_d©a
,

37 .
	gnum_ªsour˚s
 = 1,

38 .
	gªsour˚
 = &
«s100d_Êash_ªsour˚
,

41 #ifde‡
CONFIG_LEDS_IXP4XX


42 
ªsour˚
 
	g«s100d_Àd_ªsour˚s
[] = {

44 .
«me
 = "wlan",

45 .
	g°¨t
 = 0,

46 .
	gíd
 = 0,

47 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

50 .
	g«me
 = "ready",

51 .
	g°¨t
 = 15,

52 .
	gíd
 = 15,

53 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

56 .
	g«me
 = "disk",

57 .
	g°¨t
 = 3,

58 .
	gíd
 = 3,

59 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

63 
∂©f‹m_devi˚
 
	g«s100d_Àds
 = {

64 .
«me
 = "IXP4XX-GPIO-LED",

65 .
	gid
 = -1,

66 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
«s100d_Àd_ªsour˚s
),

67 .
	gªsour˚
 = 
«s100d_Àd_ªsour˚s
,

71 
ixp4xx_i2c_pös
 
	g«s100d_i2c_gpio_pös
 = {

72 .
sda_pö
 = 
NAS100D_SDA_PIN
,

73 .
	gs˛_pö
 = 
NAS100D_SCL_PIN
,

76 
∂©f‹m_devi˚
 
	g«s100d_i2c_c⁄åﬁÀr
 = {

77 .
«me
 = "IXP4XX-I2C",

78 .
	gid
 = 0,

79 .
	gdev
.
	g∂©f‹m_d©a
 = &
«s100d_i2c_gpio_pös
,

80 .
	gnum_ªsour˚s
 = 0,

83 
ªsour˚
 
	g«s100d_u¨t_ªsour˚s
[] = {

85 .
°¨t
 = 
IXP4XX_UART1_BASE_PHYS
,

86 .
	gíd
 = 
IXP4XX_UART1_BASE_PHYS
 + 0x0fff,

87 .
	gÊags
 = 
IORESOURCE_MEM
,

90 .
	g°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

91 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

92 .
	gÊags
 = 
IORESOURCE_MEM
,

96 
∂©_£rül8250_p‹t
 
	g«s100d_u¨t_d©a
[] = {

98 .
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
,

99 .
	gmemba£
 = (*)
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
,

100 .
	gúq
 = 
IRQ_IXP4XX_UART1
,

101 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

102 .
	giŸy≥
 = 
UPIO_MEM
,

103 .
	gªgshi·
 = 2,

104 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

107 .
	gm≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

108 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

109 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

110 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

111 .
	giŸy≥
 = 
UPIO_MEM
,

112 .
	gªgshi·
 = 2,

113 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

118 
∂©f‹m_devi˚
 
	g«s100d_u¨t
 = {

119 .
«me
 = "serial8250",

120 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

121 .
	gdev
.
	g∂©f‹m_d©a
 = 
«s100d_u¨t_d©a
,

122 .
	gnum_ªsour˚s
 = 2,

123 .
	gªsour˚
 = 
«s100d_u¨t_ªsour˚s
,

126 
∂©f‹m_devi˚
 *
	g«s100d_devi˚s
[] 
	g__öôd©a
 = {

127 &
«s100d_i2c_c⁄åﬁÀr
,

128 &
«s100d_Êash
,

129 #ifde‡
CONFIG_LEDS_IXP4XX


130 &
«s100d_Àds
,

134 
	$«s100d_powî_off
()

139 
	`gpio_löe_c⁄fig
(
NAS100D_PO_GPIO
, 
IXP4XX_GPIO_OUT
);

142 
	`gpio_löe_£t
(
NAS100D_PO_GPIO
, 
IXP4XX_GPIO_HIGH
);

143 
	}
}

145 
__öô
 
	$«s100d_öô
()

147 
	`ixp4xx_sys_öô
();

150 *
IXP4XX_GPIO_GPCLKR
 = 0;

152 
«s100d_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

153 
«s100d_Êash_ªsour˚
.
íd
 =

154 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
ixp4xx_exp_bus_size
 - 1;

156 
pm_powî_off
 = 
«s100d_powî_off
;

163 ()
	`∂©f‹m_devi˚_ªgi°î
(&
«s100d_u¨t
);

165 
	`∂©f‹m_add_devi˚s
(
«s100d_devi˚s
, 
	`ARRAY_SIZE
(nas100d_devices));

166 
	}
}

168 
MACHINE_START
(
NAS100D
, "Iomega NAS 100d")

170 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

171 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xFFFC,

172 .
	gboŸ_∑øms
 = 0x00000100,

173 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

174 .
	göô_úq
 = 
ixp4xx_öô_úq
,

175 .
	gtimî
 = &
ixp4xx_timî
,

176 .
	göô_machöe
 = 
«s100d_öô
,

177 
	gMACHINE_END


	@arch/arm/mach-ixp4xx/nslu2-pci.c

18 
	~<löux/pci.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/úq.h
>

22 
	~<asm/mach/pci.h
>

23 
	~<asm/mach-ty≥s.h
>

25 
__öô
 
	$n¶u2_pci_¥eöô
()

27 
	`£t_úq_ty≥
(
IRQ_NSLU2_PCI_INTA
, 
IRQT_LOW
);

28 
	`£t_úq_ty≥
(
IRQ_NSLU2_PCI_INTB
, 
IRQT_LOW
);

29 
	`£t_úq_ty≥
(
IRQ_NSLU2_PCI_INTC
, 
IRQT_LOW
);

31 
	`ixp4xx_pci_¥eöô
();

32 
	}
}

34 
__öô
 
	$n¶u2_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

36 
pci_úq_èbÀ
[
NSLU2_PCI_IRQ_LINES
] = {

37 
IRQ_NSLU2_PCI_INTA
,

38 
IRQ_NSLU2_PCI_INTB
,

39 
IRQ_NSLU2_PCI_INTC
,

42 
úq
 = -1;

44 i‡(
¶Ÿ
 >1 && slŸ <
NSLU2_PCI_MAX_DEV
 &&

45 
pö
 >1 &&Öö <
NSLU2_PCI_IRQ_LINES
) {

46 
úq
 = 
pci_úq_èbÀ
[(
¶Ÿ
 + 
pö
 - 2Ë% 
NSLU2_PCI_IRQ_LINES
];

49  
úq
;

50 
	}
}

52 
hw_pci
 
__öôd©a
 
	gn¶u2_pci
 = {

53 .
ƒ_c⁄åﬁÀrs
 = 1,

54 .
	g¥eöô
 = 
n¶u2_pci_¥eöô
,

55 .
	gswizzÀ
 = 
pci_°d_swizzÀ
,

56 .
	g£tup
 = 
ixp4xx_£tup
,

57 .
	gsˇn
 = 
ixp4xx_sˇn_bus
,

58 .
	gm≠_úq
 = 
n¶u2_m≠_úq
,

61 
__öô
 
	$n¶u2_pci_öô
()

63 i‡(
	`machöe_is_n¶u2
())

64 
	`pci_comm⁄_öô
(&
n¶u2_pci
);

67 
	}
}

69 
subsys_öôˇŒ
(
n¶u2_pci_öô
);

	@arch/arm/mach-ixp4xx/nslu2-power.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/ªboŸ.h
>

22 
	~<löux/úq.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/ªboŸ.h
>

26 
	~<asm/mach-ty≥s.h
>

28 
úqªtu∫_t
 
	$n¶u2_powî_h™dÀr
(
úq
, *
dev_id
)

33 
	`˘æ_Æt_dñ
();

35  
IRQ_HANDLED
;

36 
	}
}

38 
úqªtu∫_t
 
	$n¶u2_ª£t_h™dÀr
(
úq
, *
dev_id
)

42 
	`machöe_powî_off
();

44  
IRQ_HANDLED
;

45 
	}
}

47 
__öô
 
	$n¶u2_powî_öô
()

49 i‡(!(
	`machöe_is_n¶u2
()))

52 *
IXP4XX_GPIO_GPISR
 = 0x20400000;

54 
	`£t_úq_ty≥
(
NSLU2_RB_IRQ
, 
IRQT_LOW
);

55 
	`£t_úq_ty≥
(
NSLU2_PB_IRQ
, 
IRQT_HIGH
);

57 i‡(
	`ªque°_úq
(
NSLU2_RB_IRQ
, &
n¶u2_ª£t_h™dÀr
,

58 
IRQF_DISABLED
, "NSLU2Ñe£àbuâ⁄", 
NULL
) < 0) {

60 
	`¥ötk
(
KERN_DEBUG
 "Reset Button IRQ %dÇotávailable\n",

61 
NSLU2_RB_IRQ
);

63  -
EIO
;

66 i‡(
	`ªque°_úq
(
NSLU2_PB_IRQ
, &
n¶u2_powî_h™dÀr
,

67 
IRQF_DISABLED
, "NSLU2Öowî buâ⁄", 
NULL
) < 0) {

69 
	`¥ötk
(
KERN_DEBUG
 "Power Button IRQ %dÇotávailable\n",

70 
NSLU2_PB_IRQ
);

72  -
EIO
;

76 
	}
}

78 
__exô
 
	$n¶u2_powî_exô
()

80 i‡(!(
	`machöe_is_n¶u2
()))

83 
	`‰ì_úq
(
NSLU2_RB_IRQ
, 
NULL
);

84 
	`‰ì_úq
(
NSLU2_PB_IRQ
, 
NULL
);

85 
	}
}

87 
moduÀ_öô
(
n¶u2_powî_öô
);

88 
moduÀ_exô
(
n¶u2_powî_exô
);

90 
MODULE_AUTHOR
("Alessandro Zummo <a.zummo@towertech.it>");

91 
MODULE_DESCRIPTION
("NSLU2 Power/Reset driver");

92 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-ixp4xx/nslu2-setup.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/£rül.h
>

19 
	~<löux/£rül_8250.h
>

20 
	~<löux/Àds.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/mach/¨ch.h
>

24 
	~<asm/mach/Êash.h
>

25 
	~<asm/mach/time.h
>

27 
Êash_∂©f‹m_d©a
 
	gn¶u2_Êash_d©a
 = {

28 .
m≠_«me
 = "cfi_probe",

29 .
	gwidth
 = 2,

32 
ªsour˚
 
	gn¶u2_Êash_ªsour˚
 = {

33 .
Êags
 = 
IORESOURCE_MEM
,

36 
∂©f‹m_devi˚
 
	gn¶u2_Êash
 = {

37 .
«me
 = "IXP4XX-Flash",

38 .
	gid
 = 0,

39 .
	gdev
.
	g∂©f‹m_d©a
 = &
n¶u2_Êash_d©a
,

40 .
	gnum_ªsour˚s
 = 1,

41 .
	gªsour˚
 = &
n¶u2_Êash_ªsour˚
,

44 
ixp4xx_i2c_pös
 
	gn¶u2_i2c_gpio_pös
 = {

45 .
sda_pö
 = 
NSLU2_SDA_PIN
,

46 .
	gs˛_pö
 = 
NSLU2_SCL_PIN
,

49 #ifde‡
CONFIG_LEDS_IXP4XX


50 
ªsour˚
 
	gn¶u2_Àd_ªsour˚s
[] = {

52 .
«me
 = "ready",

53 .
	g°¨t
 = 
NSLU2_LED_GRN_GPIO
,

54 .
	gíd
 = 
NSLU2_LED_GRN_GPIO
,

55 .
	gÊags
 = 
IXP4XX_GPIO_HIGH
,

58 .
	g«me
 = "status",

59 .
	g°¨t
 = 
NSLU2_LED_RED_GPIO
,

60 .
	gíd
 = 
NSLU2_LED_RED_GPIO
,

61 .
	gÊags
 = 
IXP4XX_GPIO_HIGH
,

64 .
	g«me
 = "disk-1",

65 .
	g°¨t
 = 
NSLU2_LED_DISK1_GPIO
,

66 .
	gíd
 = 
NSLU2_LED_DISK1_GPIO
,

67 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

70 .
	g«me
 = "disk-2",

71 .
	g°¨t
 = 
NSLU2_LED_DISK2_GPIO
,

72 .
	gíd
 = 
NSLU2_LED_DISK2_GPIO
,

73 .
	gÊags
 = 
IXP4XX_GPIO_LOW
,

77 
∂©f‹m_devi˚
 
	gn¶u2_Àds
 = {

78 .
«me
 = "IXP4XX-GPIO-LED",

79 .
	gid
 = -1,

80 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
n¶u2_Àd_ªsour˚s
),

81 .
	gªsour˚
 = 
n¶u2_Àd_ªsour˚s
,

85 
∂©f‹m_devi˚
 
	gn¶u2_i2c_c⁄åﬁÀr
 = {

86 .
«me
 = "IXP4XX-I2C",

87 .
	gid
 = 0,

88 .
	gdev
.
	g∂©f‹m_d©a
 = &
n¶u2_i2c_gpio_pös
,

89 .
	gnum_ªsour˚s
 = 0,

92 
∂©f‹m_devi˚
 
	gn¶u2_bì≥r
 = {

93 .
«me
 = "ixp4xx-beeper",

94 .
	gid
 = 
NSLU2_GPIO_BUZZ
,

95 .
	gnum_ªsour˚s
 = 0,

98 
ªsour˚
 
	gn¶u2_u¨t_ªsour˚s
[] = {

100 .
°¨t
 = 
IXP4XX_UART1_BASE_PHYS
,

101 .
	gíd
 = 
IXP4XX_UART1_BASE_PHYS
 + 0x0fff,

102 .
	gÊags
 = 
IORESOURCE_MEM
,

105 .
	g°¨t
 = 
IXP4XX_UART2_BASE_PHYS
,

106 .
	gíd
 = 
IXP4XX_UART2_BASE_PHYS
 + 0x0fff,

107 .
	gÊags
 = 
IORESOURCE_MEM
,

111 
∂©_£rül8250_p‹t
 
	gn¶u2_u¨t_d©a
[] = {

113 .
m≠ba£
 = 
IXP4XX_UART1_BASE_PHYS
,

114 .
	gmemba£
 = (*)
IXP4XX_UART1_BASE_VIRT
 + 
REG_OFFSET
,

115 .
	gúq
 = 
IRQ_IXP4XX_UART1
,

116 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

117 .
	giŸy≥
 = 
UPIO_MEM
,

118 .
	gªgshi·
 = 2,

119 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

122 .
	gm≠ba£
 = 
IXP4XX_UART2_BASE_PHYS
,

123 .
	gmemba£
 = (*)
IXP4XX_UART2_BASE_VIRT
 + 
REG_OFFSET
,

124 .
	gúq
 = 
IRQ_IXP4XX_UART2
,

125 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

126 .
	giŸy≥
 = 
UPIO_MEM
,

127 .
	gªgshi·
 = 2,

128 .
	gu¨t˛k
 = 
IXP4XX_UART_XTAL
,

133 
∂©f‹m_devi˚
 
	gn¶u2_u¨t
 = {

134 .
«me
 = "serial8250",

135 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

136 .
	gdev
.
	g∂©f‹m_d©a
 = 
n¶u2_u¨t_d©a
,

137 .
	gnum_ªsour˚s
 = 2,

138 .
	gªsour˚
 = 
n¶u2_u¨t_ªsour˚s
,

141 
∂©f‹m_devi˚
 *
	gn¶u2_devi˚s
[] 
	g__öôd©a
 = {

142 &
n¶u2_i2c_c⁄åﬁÀr
,

143 &
n¶u2_Êash
,

144 &
n¶u2_bì≥r
,

145 #ifde‡
CONFIG_LEDS_IXP4XX


146 &
n¶u2_Àds
,

150 
	$n¶u2_powî_off
()

155 
	`gpio_löe_c⁄fig
(
NSLU2_PO_GPIO
, 
IXP4XX_GPIO_OUT
);

158 
	`gpio_löe_£t
(
NSLU2_PO_GPIO
, 
IXP4XX_GPIO_HIGH
);

159 
	}
}

161 
__öô
 
	$n¶u2_timî_öô
()

164 
ixp4xx_timî_‰eq
 = 
NSLU2_FREQ
;

167 
	`ixp4xx_timî_öô
();

168 
	}
}

170 
sys_timî
 
	gn¶u2_timî
 = {

171 .
öô
 = 
n¶u2_timî_öô
,

174 
__öô
 
	$n¶u2_öô
()

176 
	`ixp4xx_sys_öô
();

178 
n¶u2_Êash_ªsour˚
.
°¨t
 = 
	`IXP4XX_EXP_BUS_BASE
(0);

179 
n¶u2_Êash_ªsour˚
.
íd
 =

180 
	`IXP4XX_EXP_BUS_BASE
(0Ë+ 
ixp4xx_exp_bus_size
 - 1;

182 
pm_powî_off
 = 
n¶u2_powî_off
;

189 ()
	`∂©f‹m_devi˚_ªgi°î
(&
n¶u2_u¨t
);

191 
	`∂©f‹m_add_devi˚s
(
n¶u2_devi˚s
, 
	`ARRAY_SIZE
(nslu2_devices));

192 
	}
}

194 
MACHINE_START
(
NSLU2
, "Linksys NSLU2")

196 .
	gphys_io
 = 
IXP4XX_PERIPHERAL_BASE_PHYS
,

197 .
	gio_pg_off°
 = ((
IXP4XX_PERIPHERAL_BASE_VIRT
) >> 18) & 0xFFFC,

198 .
	gboŸ_∑øms
 = 0x00000100,

199 .
	gm≠_io
 = 
ixp4xx_m≠_io
,

200 .
	göô_úq
 = 
ixp4xx_öô_úq
,

201 .
	gtimî
 = &
n¶u2_timî
,

202 .
	göô_machöe
 = 
n¶u2_öô
,

203 
	gMACHINE_END


	@arch/arm/mach-ks8695/board-micrel.c

9 
	~<löux/kî√l.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/öãºu±.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/∂©f‹m_devi˚.h
>

15 
	~<asm/mach-ty≥s.h
>

17 
	~<asm/mach/¨ch.h
>

18 
	~<asm/mach/m≠.h
>

19 
	~<asm/mach/úq.h
>

21 
	~<asm/¨ch/devi˚s.h
>

23 
	~"gíîic.h
"

25 #ifde‡
CONFIG_PCI


26 
__öô
 
	$mi¸ñ_pci_m≠_úq
(
pci_dev
 *
dev
, 
u8
 
¶Ÿ
, u8 
pö
)

28  
KS8695_IRQ_EXTERN0
;

29 
	}
}

31 
ks8695_pci_cfg
 
	gmi¸ñ_pci
 = {

32 .
mode
 = 
KS8695_MODE_MINIPCI
,

33 .
	gm≠_úq
 = 
mi¸ñ_pci_m≠_úq
,

38 
	$mi¸ñ_öô
()

40 
	`¥ötk
(
KERN_INFO
 "Micrel KS8695 Development Board initializing\n");

42 #ifde‡
CONFIG_PCI


43 
	`ks8695_öô_pci
(&
mi¸ñ_pci
);

47 
	`ks8695_add_devi˚_w™
();

48 
	`ks8695_add_devi˚_œn
();

49 
	}
}

51 
MACHINE_START
(
KS8695
, "KS8695 Centaur Development Board")

53 .
	gphys_io
 = 
KS8695_IO_PA
,

54 .
	gio_pg_off°
 = (
KS8695_IO_VA
 >> 18) & 0xfffc,

55 .
	gboŸ_∑øms
 = 
KS8695_SDRAM_PA
 + 0x100,

56 .
	gm≠_io
 = 
ks8695_m≠_io
,

57 .
	göô_úq
 = 
ks8695_öô_úq
,

58 .
	göô_machöe
 = 
mi¸ñ_öô
,

59 .
	gtimî
 = &
ks8695_timî
,

60 
	gMACHINE_END


	@arch/arm/mach-ks8695/cpu.c

24 
	~<löux/kî√l.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/öô.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/io.h
>

30 
	~<asm/mach/¨ch.h
>

31 
	~<asm/mach/m≠.h
>

33 
	~<asm/¨ch/ªgs-sys.h
>

34 
	~<asm/¨ch/ªgs-misc.h
>

37 
__öôd©a
 
m≠_desc
 
	gks8695_io_desc
[] = {

39 .
vútuÆ
 = 
KS8695_IO_VA
,

40 .
	gp‚
 = 
__phys_to_p‚
(
KS8695_IO_PA
),

41 .
	gÀngth
 = 
KS8695_IO_SIZE
,

42 .
	gty≥
 = 
MT_DEVICE
,

46 
__öô
 
	$ks8695_¥o˚ss‹_öfo
()

48 
id
, 
ªv
;

50 
id
 = 
	`__øw_ªadl
(
KS8695_MISC_VA
 + 
KS8695_DID
);

51 
ªv
 = 
	`__øw_ªadl
(
KS8695_MISC_VA
 + 
KS8695_RID
);

53 
	`¥ötk
("KS8695 ID=%04lx SubID=%02lx Revisi⁄=%02lx\n", (
id
 & 
DID_ID
), (
ªv
 & 
RID_SUBID
), (ªv & 
RID_REVISION
));

54 
	}
}

56 
	gsys˛k
[8] = { 125000000, 100000000, 62500000, 50000000, 41700000, 33300000, 31300000, 25000000 };

57 
	g˝u˛k
[8] = { 166000000, 166000000, 83000000, 83000000, 55300000, 55300000, 41500000, 41500000 };

59 
__öô
 
	$ks8695_˛ock_öfo
()

61 
scdc
 = 
	`__øw_ªadl
(
KS8695_SYS_VA
 + 
KS8695_CLKCON
Ë& 
CLKCON_SCDC
;

63 
	`¥ötk
("Clocks: System %u MHz, CPU %u MHz\n",

64 
sys˛k
[
scdc
] / 1000000, 
˝u˛k
[scdc] / 1000000);

65 
	}
}

67 
__öô
 
	$ks8695_m≠_io
()

69 
	`iŸabÀ_öô
(
ks8695_io_desc
, 
	`ARRAY_SIZE
(ks8695_io_desc));

71 
	`ks8695_¥o˚ss‹_öfo
();

72 
	`ks8695_˛ock_öfo
();

73 
	}
}

	@arch/arm/mach-ks8695/devices.c

20 
	~<asm/mach/¨ch.h
>

21 
	~<asm/mach/m≠.h
>

23 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<asm/¨ch/ªgs-w™.h
>

26 
	~<asm/¨ch/ªgs-œn.h
>

27 
	~<asm/¨ch/ªgs-h≤a.h
>

34 #i‡
deföed
(
CONFIG_ARM_KS8695_ETHER
Ë|| deföed(
CONFIG_ARM_KS8695_ETHER_MODULE
)

35 
u64
 
	gëh_dmamask
 = 0xffffffffUL;

37 
ªsour˚
 
	gks8695_w™_ªsour˚s
[] = {

39 .
°¨t
 = 
KS8695_WAN_VA
,

40 .
	gíd
 = 
KS8695_WAN_VA
 + 0x00ff,

41 .
	gÊags
 = 
IORESOURCE_MEM
,

44 .
«me
 = "WAN RX",

45 .
	g°¨t
 = 
KS8695_IRQ_WAN_RX_STATUS
,

46 .
	gíd
 = 
KS8695_IRQ_WAN_RX_STATUS
,

47 .
	gÊags
 = 
IORESOURCE_IRQ
,

50 .
«me
 = "WAN TX",

51 .
	g°¨t
 = 
KS8695_IRQ_WAN_TX_STATUS
,

52 .
	gíd
 = 
KS8695_IRQ_WAN_TX_STATUS
,

53 .
	gÊags
 = 
IORESOURCE_IRQ
,

56 .
«me
 = "WAN Link",

57 .
	g°¨t
 = 
KS8695_IRQ_WAN_LINK
,

58 .
	gíd
 = 
KS8695_IRQ_WAN_LINK
,

59 .
	gÊags
 = 
IORESOURCE_IRQ
,

63 
∂©f‹m_devi˚
 
	gks8695_w™_devi˚
 = {

64 .
«me
 = "ks8695_ether",

65 .
	gid
 = 0,

66 .
	gdev
 = {

67 .
dma_mask
 = &
ëh_dmamask
,

68 .
	gcohîít_dma_mask
 = 0xffffffff,

70 .
	gªsour˚
 = 
ks8695_w™_ªsour˚s
,

71 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ks8695_w™_ªsour˚s
),

75 
ªsour˚
 
	gks8695_œn_ªsour˚s
[] = {

77 .
°¨t
 = 
KS8695_LAN_VA
,

78 .
	gíd
 = 
KS8695_LAN_VA
 + 0x00ff,

79 .
	gÊags
 = 
IORESOURCE_MEM
,

82 .
«me
 = "LAN RX",

83 .
	g°¨t
 = 
KS8695_IRQ_LAN_RX_STATUS
,

84 .
	gíd
 = 
KS8695_IRQ_LAN_RX_STATUS
,

85 .
	gÊags
 = 
IORESOURCE_IRQ
,

88 .
«me
 = "LAN TX",

89 .
	g°¨t
 = 
KS8695_IRQ_LAN_TX_STATUS
,

90 .
	gíd
 = 
KS8695_IRQ_LAN_TX_STATUS
,

91 .
	gÊags
 = 
IORESOURCE_IRQ
,

95 
∂©f‹m_devi˚
 
	gks8695_œn_devi˚
 = {

96 .
«me
 = "ks8695_ether",

97 .
	gid
 = 1,

98 .
	gdev
 = {

99 .
dma_mask
 = &
ëh_dmamask
,

100 .
	gcohîít_dma_mask
 = 0xffffffff,

102 .
	gªsour˚
 = 
ks8695_œn_ªsour˚s
,

103 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ks8695_œn_ªsour˚s
),

107 
ªsour˚
 
	gks8695_h≤a_ªsour˚s
[] = {

109 .
°¨t
 = 
KS8695_HPNA_VA
,

110 .
	gíd
 = 
KS8695_HPNA_VA
 + 0x00ff,

111 .
	gÊags
 = 
IORESOURCE_MEM
,

114 .
«me
 = "HPNA RX",

115 .
	g°¨t
 = 
KS8695_IRQ_HPNA_RX_STATUS
,

116 .
	gíd
 = 
KS8695_IRQ_HPNA_RX_STATUS
,

117 .
	gÊags
 = 
IORESOURCE_IRQ
,

120 .
«me
 = "HPNA TX",

121 .
	g°¨t
 = 
KS8695_IRQ_HPNA_TX_STATUS
,

122 .
	gíd
 = 
KS8695_IRQ_HPNA_TX_STATUS
,

123 .
	gÊags
 = 
IORESOURCE_IRQ
,

127 
∂©f‹m_devi˚
 
	gks8695_h≤a_devi˚
 = {

128 .
«me
 = "ks8695_ether",

129 .
	gid
 = 2,

130 .
	gdev
 = {

131 .
dma_mask
 = &
ëh_dmamask
,

132 .
	gcohîít_dma_mask
 = 0xffffffff,

134 .
	gªsour˚
 = 
ks8695_h≤a_ªsour˚s
,

135 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ks8695_h≤a_ªsour˚s
),

138 
__öô
 
	$ks8695_add_devi˚_w™
()

140 
	`∂©f‹m_devi˚_ªgi°î
(&
ks8695_w™_devi˚
);

141 
	}
}

143 
__öô
 
	$ks8695_add_devi˚_œn
()

145 
	`∂©f‹m_devi˚_ªgi°î
(&
ks8695_œn_devi˚
);

146 
	}
}

148 
__öô
 
	$ks8696_add_devi˚_h≤a
()

150 
	`∂©f‹m_devi˚_ªgi°î
(&
ks8695_h≤a_devi˚
);

151 
	}
}

153 
__öô
 
	$ks8695_add_devi˚_w™
(Ë{
	}
}

154 
__öô
 
	$ks8695_add_devi˚_œn
(Ë{
	}
}

155 
__öô
 
	$ks8696_add_devi˚_h≤a
(Ë{
	}
}

163 #i‡
deföed
(
CONFIG_KS8695_WATCHDOG
Ë|| deföed(
CONFIG_KS8695_WATCHDOG_MODULE
)

164 
∂©f‹m_devi˚
 
	gks8695_wdt_devi˚
 = {

165 .
«me
 = "ks8695_wdt",

166 .
	gid
 = -1,

167 .
	gnum_ªsour˚s
 = 0,

170 
__öô
 
	$ks8695_add_devi˚_w©chdog
()

172 
	`∂©f‹m_devi˚_ªgi°î
(&
ks8695_wdt_devi˚
);

173 
	}
}

175 
__öô
 
	$ks8695_add_devi˚_w©chdog
(Ë{
	}
}

185 
__öô
 
	$ks8695_add_°™d¨d_devi˚s
()

187 
	`ks8695_add_devi˚_w©chdog
();

189 
	}
}

191 
¨ch_öôˇŒ
(
ks8695_add_°™d¨d_devi˚s
);

	@arch/arm/mach-ks8695/generic.h

13 
__öô
 
ks8695_m≠_io
();

14 
__öô
 
ks8695_öô_úq
();

15 
sys_timî
 
ks8695_timî
;

	@arch/arm/mach-ks8695/irq.c

22 
	~<löux/öô.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/öãºu±.h
>

25 
	~<löux/i›‹t.h
>

26 
	~<löux/±ø˚.h
>

27 
	~<löux/sysdev.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/io.h
>

33 
	~<asm/mach/úq.h
>

35 
	~<asm/¨ch/ªgs-úq.h
>

36 
	~<asm/¨ch/ªgs-gpio.h
>

38 
	$ks8695_úq_mask
(
úqno
)

40 
öãn
;

42 
öãn
 = 
	`__øw_ªadl
(
KS8695_IRQ_VA
 + 
KS8695_INTEN
);

43 
öãn
 &~(1 << 
úqno
);

45 
	`__øw_wrôñ
(
öãn
, 
KS8695_IRQ_VA
 + 
KS8695_INTEN
);

46 
	}
}

48 
	$ks8695_úq_unmask
(
úqno
)

50 
öãn
;

52 
öãn
 = 
	`__øw_ªadl
(
KS8695_IRQ_VA
 + 
KS8695_INTEN
);

53 
öãn
 |(1 << 
úqno
);

55 
	`__øw_wrôñ
(
öãn
, 
KS8695_IRQ_VA
 + 
KS8695_INTEN
);

56 
	}
}

58 
	$ks8695_úq_ack
(
úqno
)

60 
	`__øw_wrôñ
((1 << 
úqno
), 
KS8695_IRQ_VA
 + 
KS8695_INTST
);

61 
	}
}

64 
úq_chù
 
	gks8695_úq_Àvñ_chù
;

65 
úq_chù
 
	gks8695_úq_edge_chù
;

68 
	$ks8695_úq_£t_ty≥
(
úqno
, 
ty≥
)

70 
˘æ
, 
mode
;

71 
Àvñ_åiggîed
 = 0;

73 
˘æ
 = 
	`__øw_ªadl
(
KS8695_GPIO_VA
 + 
KS8695_IOPC
);

75 
ty≥
) {

76 
IRQT_HIGH
:

77 
mode
 = 
IOPC_TM_HIGH
;

78 
Àvñ_åiggîed
 = 1;

80 
IRQT_LOW
:

81 
mode
 = 
IOPC_TM_LOW
;

82 
Àvñ_åiggîed
 = 1;

84 
IRQT_RISING
:

85 
mode
 = 
IOPC_TM_RISING
;

87 
IRQT_FALLING
:

88 
mode
 = 
IOPC_TM_FALLING
;

90 
IRQT_BOTHEDGE
:

91 
mode
 = 
IOPC_TM_EDGE
;

94  -
EINVAL
;

97 
úqno
) {

98 
KS8695_IRQ_EXTERN0
:

99 
˘æ
 &~
IOPC_IOEINT0TM
;

100 
˘æ
 |
	`IOPC_IOEINT0_MODE
(
mode
);

102 
KS8695_IRQ_EXTERN1
:

103 
˘æ
 &~
IOPC_IOEINT1TM
;

104 
˘æ
 |
	`IOPC_IOEINT1_MODE
(
mode
);

106 
KS8695_IRQ_EXTERN2
:

107 
˘æ
 &~
IOPC_IOEINT2TM
;

108 
˘æ
 |
	`IOPC_IOEINT2_MODE
(
mode
);

110 
KS8695_IRQ_EXTERN3
:

111 
˘æ
 &~
IOPC_IOEINT3TM
;

112 
˘æ
 |
	`IOPC_IOEINT3_MODE
(
mode
);

115  -
EINVAL
;

118 i‡(
Àvñ_åiggîed
) {

119 
	`£t_úq_chù
(
úqno
, &
ks8695_úq_Àvñ_chù
);

120 
	`£t_úq_h™dÀr
(
úqno
, 
h™dÀ_Àvñ_úq
);

123 
	`£t_úq_chù
(
úqno
, &
ks8695_úq_edge_chù
);

124 
	`£t_úq_h™dÀr
(
úqno
, 
h™dÀ_edge_úq
);

127 
	`__øw_wrôñ
(
˘æ
, 
KS8695_GPIO_VA
 + 
KS8695_IOPC
);

129 
	}
}

131 
úq_chù
 
	gks8695_úq_Àvñ_chù
 = {

132 .
ack
 = 
ks8695_úq_mask
,

133 .
	gmask
 = 
ks8695_úq_mask
,

134 .
	gunmask
 = 
ks8695_úq_unmask
,

135 .
	g£t_ty≥
 = 
ks8695_úq_£t_ty≥
,

138 
úq_chù
 
	gks8695_úq_edge_chù
 = {

139 .
ack
 = 
ks8695_úq_ack
,

140 .
	gmask
 = 
ks8695_úq_mask
,

141 .
	gunmask
 = 
ks8695_úq_unmask
,

142 .
	g£t_ty≥
 = 
ks8695_úq_£t_ty≥
,

145 
__öô
 
	$ks8695_öô_úq
()

147 
úq
;

150 
	`__øw_wrôñ
(0, 
KS8695_IRQ_VA
 + 
KS8695_INTMC
);

151 
	`__øw_wrôñ
(0, 
KS8695_IRQ_VA
 + 
KS8695_INTEN
);

153 
úq
 = 0; irq < 
NR_IRQS
; irq++) {

154 
úq
) {

156 
KS8695_IRQ_BUS_ERROR
:

157 
KS8695_IRQ_UART_MODEM_STATUS
:

158 
KS8695_IRQ_UART_LINE_STATUS
:

159 
KS8695_IRQ_UART_RX
:

160 
KS8695_IRQ_COMM_TX
:

161 
KS8695_IRQ_COMM_RX
:

162 
	`£t_úq_chù
(
úq
, &
ks8695_úq_Àvñ_chù
);

163 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

168 
	`ks8695_úq_ack
(
úq
);

169 
	`£t_úq_chù
(
úq
, &
ks8695_úq_edge_chù
);

170 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

173 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

175 
	}
}

	@arch/arm/mach-ks8695/time.c

22 
	~<löux/öô.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/úq.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/sched.h
>

28 
	~<asm/io.h
>

29 
	~<asm/mach/time.h
>

31 
	~<asm/¨ch/ªgs-timî.h
>

32 
	~<asm/¨ch/ªgs-úq.h
>

34 
	~"gíîic.h
"

40 
	$ks8695_gëtimeoff£t
 ()

42 
ñ≠£d
, 
tick2
, 
öçídög
;

50 
ñ≠£d
 = 
	`__øw_ªadl
(
KS8695_TMR_VA
 + 
KS8695_T1TC
Ë+ __øw_ªadl(KS8695_TMR_VA + 
KS8695_T1PD
);

52 
tick2
 = 
ñ≠£d
;

53 
öçídög
 = 
	`__øw_ªadl
(
KS8695_IRQ_VA
 + 
KS8695_INTST
Ë& (1 << 
KS8695_IRQ_TIMER1
);

54 
ñ≠£d
 = 
	`__øw_ªadl
(
KS8695_TMR_VA
 + 
KS8695_T1TC
Ë+ __øw_ªadl(KS8695_TMR_VA + 
KS8695_T1PD
);

55 } 
ñ≠£d
 > 
tick2
);

58 
ñ≠£d
 = (
CLOCK_TICK_RATE
 / 
HZ
) -Élapsed;

61 i‡(
öçídög
)

62 
ñ≠£d
 +(
CLOCK_TICK_RATE
 / 
HZ
);

65  ()(
ñ≠£d
 * (
tick_n£c
 / 1000)Ë/ 
LATCH
;

66 
	}
}

71 
úqªtu∫_t
 
	$ks8695_timî_öãºu±
(
úq
, *
dev_id
)

73 
	`wrôe_£qlock
(&
xtime_lock
);

74 
	`timî_tick
();

75 
	`wrôe_£qu∆ock
(&
xtime_lock
);

77  
IRQ_HANDLED
;

78 
	}
}

80 
úqa˘i⁄
 
	gks8695_timî_úq
 = {

81 .
«me
 = "ks8695_tick",

82 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
,

83 .
	gh™dÀr
 = 
ks8695_timî_öãºu±
,

86 
	$ks8695_timî_£tup
()

88 
tmout
 = 
CLOCK_TICK_RATE
 / 
HZ
;

89 
tmc⁄
;

92 
tmc⁄
 = 
	`__øw_ªadl
(
KS8695_TMR_VA
 + 
KS8695_TMCON
);

93 
	`__øw_wrôñ
(
tmc⁄
 & ~
TMCON_T1EN
, 
KS8695_TMR_VA
 + 
KS8695_TMCON
);

95 
	`__øw_wrôñ
(
tmout
 / 2, 
KS8695_TMR_VA
 + 
KS8695_T1TC
);

96 
	`__øw_wrôñ
(
tmout
 / 2, 
KS8695_TMR_VA
 + 
KS8695_T1PD
);

99 
	`__øw_wrôñ
(
tmc⁄
 | 
TMCON_T1EN
, 
KS8695_TMR_VA
 + 
KS8695_TMCON
);

100 
	}
}

102 
__öô
 
	$ks8695_timî_öô
 ()

104 
	`ks8695_timî_£tup
();

107 
	`£tup_úq
(
KS8695_IRQ_TIMER1
, &
ks8695_timî_úq
);

108 
	}
}

110 
sys_timî
 
	gks8695_timî
 = {

111 .
öô
 = 
ks8695_timî_öô
,

112 .
	goff£t
 = 
ks8695_gëtimeoff£t
,

113 .
	gªsume
 = 
ks8695_timî_£tup
,

	@arch/arm/mach-l7200/core.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/úq.h
>

11 
	~<löux/devi˚.h
>

13 
	~<asm/ty≥s.h
>

14 
	~<asm/úq.h
>

15 
	~<asm/mach-ty≥s.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/∑ge.h
>

19 
	~<asm/mach/¨ch.h
>

20 
	~<asm/mach/m≠.h
>

21 
	~<asm/mach/úq.h
>

26 
	#IRQ_BASE
 (
IO_BASE_2
 + 0x1000)

	)

31 
	#IRQ_STATUS
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x000))

	)

32 
	#IRQ_RAWSTATUS
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x004))

	)

33 
	#IRQ_ENABLE
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x008))

	)

34 
	#IRQ_ENABLECLEAR
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x00c))

	)

35 
	#IRQ_SOFT
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x010))

	)

36 
	#IRQ_SOURCESEL
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x018))

	)

41 
	#FIQ_STATUS
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x100))

	)

42 
	#FIQ_RAWSTATUS
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x104))

	)

43 
	#FIQ_ENABLE
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x108))

	)

44 
	#FIQ_ENABLECLEAR
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x10c))

	)

45 
	#FIQ_SOFT
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x110))

	)

46 
	#FIQ_SOURCESEL
 (*(vﬁ©ûê*Ë(
IRQ_BASE
 + 0x118))

	)

48 
	$l7200_mask_úq
(
úq
)

50 
IRQ_ENABLECLEAR
 = 1 << 
úq
;

51 
	}
}

53 
	$l7200_unmask_úq
(
úq
)

55 
IRQ_ENABLE
 = 1 << 
úq
;

56 
	}
}

58 
úq_chù
 
	gl7200_úq_chù
 = {

59 .
ack
 = 
l7200_mask_úq
,

60 .
	gmask
 = 
l7200_mask_úq
,

61 .
	gunmask
 = 
l7200_unmask_úq


64 
__öô
 
	$l7200_öô_úq
()

66 
úq
;

68 
IRQ_ENABLECLEAR
 = 0xffffffff;

69 
FIQ_ENABLECLEAR
 = 0xffffffff;

71 
úq
 = 0; irq < 
NR_IRQS
; irq++) {

72 
	`£t_úq_chù
(
úq
, &
l7200_úq_chù
);

73 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

74 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

77 
	`öô_FIQ
();

78 
	}
}

80 
m≠_desc
 
	gl7200_io_desc
[] 
	g__öôd©a
 = {

81 { 
IO_BASE
, 
IO_START
, 
IO_SIZE
, 
MT_DEVICE
 },

82 { 
IO_BASE_2
, 
IO_START_2
, 
IO_SIZE_2
, 
MT_DEVICE
 },

83 { 
AUX_BASE
, 
AUX_START
, 
AUX_SIZE
, 
MT_DEVICE
 },

84 { 
FLASH1_BASE
, 
FLASH1_START
, 
FLASH1_SIZE
, 
MT_DEVICE
 },

85 { 
FLASH2_BASE
, 
FLASH2_START
, 
FLASH2_SIZE
, 
MT_DEVICE
 }

88 
__öô
 
	$l7200_m≠_io
()

90 
	`iŸabÀ_öô
(
l7200_io_desc
, 
	`ARRAY_SIZE
(l7200_io_desc));

91 
	}
}

93 
MACHINE_START
(
L7200
, "LinkUp Systems L7200")

95 .
	gphys_io
 = 0x80040000,

96 .
	gio_pg_off°
 = ((0xd0000000) >> 18) & 0xfffc,

97 .
	gm≠_io
 = 
l7200_m≠_io
,

98 .
	göô_úq
 = 
l7200_öô_úq
,

99 
	gMACHINE_END


	@arch/arm/mach-lh7a40x/arch-kev7a400.c

11 
	~<löux/ây.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/öãºu±.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/£tup.h
>

18 
	~<asm/mach-ty≥s.h
>

19 
	~<asm/mach/¨ch.h
>

20 
	~<asm/úq.h
>

21 
	~<asm/mach/úq.h
>

22 
	~<asm/mach/m≠.h
>

24 
	~"comm⁄.h
"

28 
m≠_desc
 
	gkev7a400_io_desc
[] 
	g__öôd©a
 = {

30 .
vútuÆ
 = 
IO_VIRT
,

31 .
	gp‚
 = 
__phys_to_p‚
(
IO_PHYS
),

32 .
	gÀngth
 = 
IO_SIZE
,

33 .
	gty≥
 = 
MT_DEVICE


35 .
	gvútuÆ
 = 
CPLD_VIRT
,

36 .
	gp‚
 = 
__phys_to_p‚
(
CPLD_PHYS
),

37 .
	gÀngth
 = 
CPLD_SIZE
,

38 .
	gty≥
 = 
MT_DEVICE


42 
__öô
 
	$kev7a400_m≠_io
()

44 
	`iŸabÀ_öô
 (
kev7a400_io_desc
, 
	`ARRAY_SIZE
 (kev7a400_io_desc));

45 
	}
}

47 
u16
 
	gCPLD_IRQ_mask
;

49 
	$kev7a400_ack_˝ld_úq
 (
u32
 
úq
)

51 
CPLD_CL_INT
 = 1 << (
úq
 - 
IRQ_KEV7A400_CPLD
);

52 
	}
}

54 
	$kev7a400_mask_˝ld_úq
 (
u32
 
úq
)

56 
CPLD_IRQ_mask
 &~(1 << (
úq
 - 
IRQ_KEV7A400_CPLD
));

57 
CPLD_WR_PB_INT_MASK
 = 
CPLD_IRQ_mask
;

58 
	}
}

60 
	$kev7a400_unmask_˝ld_úq
 (
u32
 
úq
)

62 
CPLD_IRQ_mask
 |1 << (
úq
 - 
IRQ_KEV7A400_CPLD
);

63 
CPLD_WR_PB_INT_MASK
 = 
CPLD_IRQ_mask
;

64 
	}
}

66 
úq_chù
 
	gkev7a400_˝ld_chù
 = {

67 .
«me
 = "CPLD",

68 .
	gack
 = 
kev7a400_ack_˝ld_úq
,

69 .
	gmask
 = 
kev7a400_mask_˝ld_úq
,

70 .
	gunmask
 = 
kev7a400_unmask_˝ld_úq
,

74 
	$kev7a400_˝ld_h™dÀr
 (
úq
, 
úq_desc
 *
desc
)

76 
u32
 
mask
 = 
CPLD_LATCHED_INTS
;

77 
úq
 = 
IRQ_KEV7A400_CPLD
;

78 ; 
mask
; mask >>1, ++
úq
) {

79 i‡(
mask
 & 1)

80 
desc
[
úq
].
	`h™dÀ
 (irq, desc);

82 
	}
}

84 
__öô
 
	$lh7a40x_öô_bﬂrd_úq
 ()

86 
úq
;

88 
úq
 = 
IRQ_KEV7A400_CPLD
;

89 
úq
 < 
IRQ_KEV7A400_CPLD
 + 
NR_IRQ_BOARD
; ++irq) {

90 
	`£t_úq_chù
 (
úq
, &
kev7a400_˝ld_chù
);

91 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_edge_úq
);

92 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

94 
	`£t_úq_chaöed_h™dÀr
 (
IRQ_CPLD
, 
kev7a400_˝ld_h™dÀr
);

97 
CPLD_CL_INT
 = 0xff;

99 
GPIO_GPIOINTEN
 = 0;

100 
	`b¨rõr
();

103 
GPIO_INTTYPE1


104 (
GPIO_INTR_PCC1_CD
 | GPIO_INTR_PCC1_CD);

105 
GPIO_INTTYPE2
 = 0;

106 
GPIO_GPIOFEOI
 = 0xff;

107 
GPIO_GPIOINTEN
 = 0xff;

109 
	`öô_FIQ
();

111 
	}
}

113 
MACHINE_START
 (
KEV7A400
, "Sharp KEV7a400")

115 .
	gphys_io
 = 0x80000000,

116 .
	gio_pg_off°
 = ((
io_p2v
 (0x80000000))>>18) & 0xfffc,

117 .
	gboŸ_∑øms
 = 0xc0000100,

118 .
	gm≠_io
 = 
kev7a400_m≠_io
,

119 .
	göô_úq
 = 
lh7a400_öô_úq
,

120 .
	gtimî
 = &
lh7a40x_timî
,

121 
	gMACHINE_END


	@arch/arm/mach-lh7a40x/arch-lpd7a40x.c

11 
	~<löux/ây.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/∂©f‹m_devi˚.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/úq.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/£tup.h
>

19 
	~<asm/mach-ty≥s.h
>

20 
	~<asm/mach/¨ch.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mach/úq.h
>

23 
	~<asm/mach/m≠.h
>

25 
	~"comm⁄.h
"

27 
	#CPLD_INT_NETHERNET
 (1<<0)

	)

28 
	#CPLD_INTMASK_ETHERNET
 (1<<2)

	)

29 #i‡
deföed
 (
CONFIG_MACH_LPD7A400
)

30 
	#CPLD_INT_NTOUCH
 (1<<1)

	)

31 
	#CPLD_INTMASK_TOUCH
 (1<<3)

	)

32 
	#CPLD_INT_PEN
 (1<<4)

	)

33 
	#CPLD_INTMASK_PEN
 (1<<4)

	)

34 
	#CPLD_INT_PIRQ
 (1<<4)

	)

36 
	#CPLD_INTMASK_CPLD
 (1<<7)

	)

37 
	#CPLD_INT_CPLD
 (1<<6)

	)

39 
	#CPLD_CONTROL_SWINT
 (1<<7Ë

	)

40 
	#CPLD_CONTROL_OCMSK
 (1<<6Ë

	)

41 
	#CPLD_CONTROL_PDRV
 (1<<5Ë

	)

42 
	#CPLD_CONTROL_USB1C
 (1<<4Ë

	)

43 
	#CPLD_CONTROL_USB1P
 (1<<3Ë

	)

44 
	#CPLD_CONTROL_AWKP
 (1<<2Ë

	)

45 
	#CPLD_CONTROL_LCD_ENABLE
 (1<<1Ë

	)

46 
	#CPLD_CONTROL_WRLAN_NENABLE
 (1<<0Ë

	)

49 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

51 .
°¨t
 = 
CPLD00_PHYS
,

52 .
	gíd
 = 
CPLD00_PHYS
 + 
CPLD00_SIZE
 - 1,

53 .
	gÊags
 = 
IORESOURCE_MEM
,

57 .
°¨t
 = 
IRQ_LPD7A40X_ETH_INT
,

58 .
	gíd
 = 
IRQ_LPD7A40X_ETH_INT
,

59 .
	gÊags
 = 
IORESOURCE_IRQ
,

64 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

65 .
«me
 = "smc91x",

66 .
	gid
 = 0,

67 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

68 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

71 
ªsour˚
 
	glh7a40x_usb˛õ¡_ªsour˚s
[] = {

73 .
°¨t
 = 
USB_PHYS
,

74 .
	gíd
 = (
USB_PHYS
 + 
PAGE_SIZE
),

75 .
	gÊags
 = 
IORESOURCE_MEM
,

78 .
°¨t
 = 
IRQ_USB
,

79 .
	gíd
 = 
IRQ_USB
,

80 .
	gÊags
 = 
IORESOURCE_IRQ
,

84 
u64
 
	glh7a40x_usb˛õ¡_dma_mask
 = 0xffffffffUL;

86 
∂©f‹m_devi˚
 
	glh7a40x_usb˛õ¡_devi˚
 = {

88 .
«me
 = "lh7-udc",

89 .
	gid
 = 0,

90 .
	gdev
 = {

91 .
dma_mask
 = &
lh7a40x_usb˛õ¡_dma_mask
,

92 .
	gcohîít_dma_mask
 = 0xffffffffUL,

94 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
 (
lh7a40x_usb˛õ¡_ªsour˚s
),

95 .
	gªsour˚
 = 
lh7a40x_usb˛õ¡_ªsour˚s
,

98 #i‡
deföed
 (
CONFIG_ARCH_LH7A404
)

100 
ªsour˚
 
	glh7a404_usbho°_ªsour˚s
 [] = {

102 .
°¨t
 = 
USBH_PHYS
,

103 .
	gíd
 = (
USBH_PHYS
 + 0xFF),

104 .
	gÊags
 = 
IORESOURCE_MEM
,

107 .
°¨t
 = 
IRQ_USHINTR
,

108 .
	gíd
 = 
IRQ_USHINTR
,

109 .
	gÊags
 = 
IORESOURCE_IRQ
,

113 
u64
 
	glh7a404_usbho°_dma_mask
 = 0xffffffffUL;

115 
∂©f‹m_devi˚
 
	glh7a404_usbho°_devi˚
 = {

116 .
«me
 = "lh7a404-ohci",

117 .
	gid
 = 0,

118 .
	gdev
 = {

119 .
dma_mask
 = &
lh7a404_usbho°_dma_mask
,

120 .
	gcohîít_dma_mask
 = 0xffffffffUL,

122 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
 (
lh7a404_usbho°_ªsour˚s
),

123 .
	gªsour˚
 = 
lh7a404_usbho°_ªsour˚s
,

128 
∂©f‹m_devi˚
* 
	gÕd7a40x_devs
[] 
	g__öôd©a
 = {

129 &
smc91x_devi˚
,

130 &
lh7a40x_usb˛õ¡_devi˚
,

131 #i‡
deföed
 (
CONFIG_ARCH_LH7A404
)

132 &
lh7a404_usbho°_devi˚
,

136 
Õd7a400_m≠_io
 ();

138 
__öô
 
	$Õd7a40x_öô
 ()

140 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

141 
CPLD_CONTROL
 |= 0

142 | 
CPLD_CONTROL_SWINT


143 | 
CPLD_CONTROL_OCMSK
;

144 
CPLD_CONTROL
 &= ~(0

145 | 
CPLD_CONTROL_LCD_ENABLE


146 | 
CPLD_CONTROL_WRLAN_NENABLE


150 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A404
)

151 
CPLD_CONTROL
 &= ~(0

152 | 
CPLD_CONTROL_WRLAN_NENABLE


156 
	`∂©f‹m_add_devi˚s
 (
Õd7a40x_devs
, 
	`ARRAY_SIZE
 (lpd7a40x_devs));

157 #i‡
	`deföed
 (
CONFIG_FB_ARMCLCD
)

158 
	`lh7a40x_˛cd_öô
 ();

160 
	}
}

162 
	$lh7a40x_ack_˝ld_úq
 (
u32
 
úq
)

166 #i‡
	`deföed
 (
CPLD_INTMASK_TOUCH
)

170 i‡(
úq
 =
IRQ_TOUCH
)

171 
CPLD_INTERRUPTS
 |
CPLD_INTMASK_TOUCH
;

173 
	}
}

175 
	$lh7a40x_mask_˝ld_úq
 (
u32
 
úq
)

177 
úq
) {

178 
IRQ_LPD7A40X_ETH_INT
:

179 
CPLD_INTERRUPTS
 |
CPLD_INTMASK_ETHERNET
;

181 #i‡
	`deföed
 (
IRQ_TOUCH
)

182 
IRQ_TOUCH
:

183 
CPLD_INTERRUPTS
 |
CPLD_INTMASK_TOUCH
;

187 
	}
}

189 
	$lh7a40x_unmask_˝ld_úq
 (
u32
 
úq
)

191 
úq
) {

192 
IRQ_LPD7A40X_ETH_INT
:

193 
CPLD_INTERRUPTS
 &~
CPLD_INTMASK_ETHERNET
;

195 #i‡
	`deföed
 (
IRQ_TOUCH
)

196 
IRQ_TOUCH
:

197 
CPLD_INTERRUPTS
 &~
CPLD_INTMASK_TOUCH
;

201 
	}
}

203 
úq_chù
 
	gÕd7a40x_˝ld_chù
 = {

204 .
«me
 = "CPLD",

205 .
	gack
 = 
lh7a40x_ack_˝ld_úq
,

206 .
	gmask
 = 
lh7a40x_mask_˝ld_úq
,

207 .
	gunmask
 = 
lh7a40x_unmask_˝ld_úq
,

210 
	$Õd7a40x_˝ld_h™dÀr
 (
úq
, 
úq_desc
 *
desc
)

212 
mask
 = 
CPLD_INTERRUPTS
;

214 
desc
->
chù
->
	`ack
 (
úq
);

216 i‡((
mask
 & (1<<0)) == 0)

217 
	`IRQ_DISPATCH
 (
IRQ_LPD7A40X_ETH_INT
);

219 #i‡
	`deföed
 (
IRQ_TOUCH
)

220 i‡((
mask
 & (1<<1)) == 0)

221 
	`IRQ_DISPATCH
 (
IRQ_TOUCH
);

224 
desc
->
chù
->
	`unmask
 (
úq
);

225 
	}
}

228 
__öô
 
	$lh7a40x_öô_bﬂrd_úq
 ()

230 
úq
;

241 
˝ld_vîsi⁄
 = 
CPLD_REVISION
;

242 
pöCPLD
 = (
˝ld_vîsi⁄
 == 0x28) ? 7 : 3;

244 #i‡
deföed
 
CONFIG_MACH_LPD7A404


245 
˝ld_vîsi⁄
 = 0x34;

250 
GPIO_PFDD
 &= ~0x0f;

251 
GPIO_INTTYPE1
 &= ~0x0f;

252 
GPIO_INTTYPE2
 &= ~0x0f;

253 
	`b¨rõr
 ();

254 
GPIO_GPIOFINTEN
 |= 0x0f;

259 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

260 
CPLD_INTERRUPTS
 = 
CPLD_INTMASK_TOUCH
 | 
CPLD_INTMASK_PEN


261 | 
CPLD_INTMASK_ETHERNET
;

266 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A404
)

267 
CPLD_INTERRUPTS
 = 
CPLD_INTMASK_ETHERNET
;

271 
GPIO_PFDD
 &~(1 << 
pöCPLD
);

272 
GPIO_INTTYPE1
 &~(1 << 
pöCPLD
);

273 
GPIO_INTTYPE2
 &~(1 << 
pöCPLD
);

274 
	`b¨rõr
 ();

275 
GPIO_GPIOFINTEN
 |(1 << 
pöCPLD
);

279 
úq
 = 
IRQ_BOARD_START
;

280 
úq
 < 
IRQ_BOARD_START
 + 
NR_IRQ_BOARD
; ++irq) {

281 
	`£t_úq_chù
 (
úq
, &
Õd7a40x_˝ld_chù
);

282 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_Àvñ_úq
);

283 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

286 
	`£t_úq_chaöed_h™dÀr
 ((
˝ld_vîsi⁄
 == 0x28)

287 ? 
IRQ_CPLD_V28


288 : 
IRQ_CPLD_V34
,

289 
Õd7a40x_˝ld_h™dÀr
);

290 
	}
}

292 
m≠_desc
 
	gÕd7a40x_io_desc
[] 
	g__öôd©a
 = {

294 .
vútuÆ
 = 
IO_VIRT
,

295 .
	gp‚
 = 
__phys_to_p‚
(
IO_PHYS
),

296 .
	gÀngth
 = 
IO_SIZE
,

297 .
	gty≥
 = 
MT_DEVICE


300 .
	gvútuÆ
 = 
IOBARRIER_VIRT
,

301 .
	gp‚
 = 
__phys_to_p‚
(
IOBARRIER_PHYS
),

302 .
	gÀngth
 = 
IOBARRIER_SIZE
,

303 .
	gty≥
 = 
MT_DEVICE


306 .
	gvútuÆ
 = 
CF_VIRT
,

307 .
	gp‚
 = 
__phys_to_p‚
(
CF_PHYS
),

308 .
	gÀngth
 = 
CF_SIZE
,

309 .
	gty≥
 = 
MT_DEVICE


312 .
	gvútuÆ
 = 
CPLD02_VIRT
,

313 .
	gp‚
 = 
__phys_to_p‚
(
CPLD02_PHYS
),

314 .
	gÀngth
 = 
CPLD02_SIZE
,

315 .
	gty≥
 = 
MT_DEVICE


318 .
	gvútuÆ
 = 
CPLD06_VIRT
,

319 .
	gp‚
 = 
__phys_to_p‚
(
CPLD06_PHYS
),

320 .
	gÀngth
 = 
CPLD06_SIZE
,

321 .
	gty≥
 = 
MT_DEVICE


324 .
	gvútuÆ
 = 
CPLD08_VIRT
,

325 .
	gp‚
 = 
__phys_to_p‚
(
CPLD08_PHYS
),

326 .
	gÀngth
 = 
CPLD08_SIZE
,

327 .
	gty≥
 = 
MT_DEVICE


330 .
	gvútuÆ
 = 
CPLD08_VIRT
,

331 .
	gp‚
 = 
__phys_to_p‚
(
CPLD08_PHYS
),

332 .
	gÀngth
 = 
CPLD08_SIZE
,

333 .
	gty≥
 = 
MT_DEVICE


336 .
	gvútuÆ
 = 
CPLD0A_VIRT
,

337 .
	gp‚
 = 
__phys_to_p‚
(
CPLD0A_PHYS
),

338 .
	gÀngth
 = 
CPLD0A_SIZE
,

339 .
	gty≥
 = 
MT_DEVICE


342 .
	gvútuÆ
 = 
CPLD0C_VIRT
,

343 .
	gp‚
 = 
__phys_to_p‚
(
CPLD0C_PHYS
),

344 .
	gÀngth
 = 
CPLD0C_SIZE
,

345 .
	gty≥
 = 
MT_DEVICE


348 .
	gvútuÆ
 = 
CPLD0E_VIRT
,

349 .
	gp‚
 = 
__phys_to_p‚
(
CPLD0E_PHYS
),

350 .
	gÀngth
 = 
CPLD0E_SIZE
,

351 .
	gty≥
 = 
MT_DEVICE


354 .
	gvútuÆ
 = 
CPLD10_VIRT
,

355 .
	gp‚
 = 
__phys_to_p‚
(
CPLD10_PHYS
),

356 .
	gÀngth
 = 
CPLD10_SIZE
,

357 .
	gty≥
 = 
MT_DEVICE


360 .
	gvútuÆ
 = 
CPLD12_VIRT
,

361 .
	gp‚
 = 
__phys_to_p‚
(
CPLD12_PHYS
),

362 .
	gÀngth
 = 
CPLD12_SIZE
,

363 .
	gty≥
 = 
MT_DEVICE


366 .
	gvútuÆ
 = 
CPLD14_VIRT
,

367 .
	gp‚
 = 
__phys_to_p‚
(
CPLD14_PHYS
),

368 .
	gÀngth
 = 
CPLD14_SIZE
,

369 .
	gty≥
 = 
MT_DEVICE


372 .
	gvútuÆ
 = 
CPLD16_VIRT
,

373 .
	gp‚
 = 
__phys_to_p‚
(
CPLD16_PHYS
),

374 .
	gÀngth
 = 
CPLD16_SIZE
,

375 .
	gty≥
 = 
MT_DEVICE


378 .
	gvútuÆ
 = 
CPLD18_VIRT
,

379 .
	gp‚
 = 
__phys_to_p‚
(
CPLD18_PHYS
),

380 .
	gÀngth
 = 
CPLD18_SIZE
,

381 .
	gty≥
 = 
MT_DEVICE


384 .
	gvútuÆ
 = 
CPLD1A_VIRT
,

385 .
	gp‚
 = 
__phys_to_p‚
(
CPLD1A_PHYS
),

386 .
	gÀngth
 = 
CPLD1A_SIZE
,

387 .
	gty≥
 = 
MT_DEVICE


391 
__öô


392 
	$Õd7a40x_m≠_io
()

394 
	`iŸabÀ_öô
 (
Õd7a40x_io_desc
, 
	`ARRAY_SIZE
 (lpd7a40x_io_desc));

395 
	}
}

397 #ifde‡
CONFIG_MACH_LPD7A400


399 
MACHINE_START
 (
LPD7A400
, "Logic Product Development LPD7A400-10")

401 .
	gphys_io
 = 0x80000000,

402 .
	gio_pg_off°
 = ((
io_p2v
 (0x80000000))>>18) & 0xfffc,

403 .
	gboŸ_∑øms
 = 0xc0000100,

404 .
	gm≠_io
 = 
Õd7a40x_m≠_io
,

405 .
	göô_úq
 = 
lh7a400_öô_úq
,

406 .
	gtimî
 = &
lh7a40x_timî
,

407 .
	göô_machöe
 = 
Õd7a40x_öô
,

408 
	gMACHINE_END


412 #ifde‡
CONFIG_MACH_LPD7A404


414 
MACHINE_START
 (
LPD7A404
, "Logic Product Development LPD7A404-10")

416 .
	gphys_io
 = 0x80000000,

417 .
	gio_pg_off°
 = ((
io_p2v
 (0x80000000))>>18) & 0xfffc,

418 .
	gboŸ_∑øms
 = 0xc0000100,

419 .
	gm≠_io
 = 
Õd7a40x_m≠_io
,

420 .
	göô_úq
 = 
lh7a404_öô_úq
,

421 .
	gtimî
 = &
lh7a40x_timî
,

422 .
	göô_machöe
 = 
Õd7a40x_öô
,

423 
	gMACHINE_END


	@arch/arm/mach-lh7a40x/clcd.c

12 
	~<löux/öô.h
>

13 
	~<löux/devi˚.h
>

14 
	~<löux/dma-m≠pög.h
>

15 
	~<löux/sysdev.h
>

16 
	~<löux/öãºu±.h
>

23 
	~<asm/úq.h
>

24 
	~<asm/mach/úq.h
>

26 
	~<asm/sy°em.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<löux/amba/bus.h
>

29 
	~<löux/amba/˛cd.h
>

31 
	#HRTFTC_HRSETUP
 
	`__REG
(
HRTFTC_PHYS
 + 0x00)

	)

32 
	#HRTFTC_HRCON
 
	`__REG
(
HRTFTC_PHYS
 + 0x04)

	)

33 
	#HRTFTC_HRTIMING1
 
	`__REG
(
HRTFTC_PHYS
 + 0x08)

	)

34 
	#HRTFTC_HRTIMING2
 
	`__REG
(
HRTFTC_PHYS
 + 0x0c)

	)

36 
	#ALI_SETUP
 
	`__REG
(
ALI_PHYS
 + 0x00)

	)

37 
	#ALI_CONTROL
 
	`__REG
(
ALI_PHYS
 + 0x04)

	)

38 
	#ALI_TIMING1
 
	`__REG
(
ALI_PHYS
 + 0x08)

	)

39 
	#ALI_TIMING2
 
	`__REG
(
ALI_PHYS
 + 0x0c)

	)

41 
	~"lcd-∑√l.h
"

43 
	$lh7a40x_˛cd_dißbÀ
 (
˛cd_fb
 *
fb
)

45 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

46 
CPLD_CONTROL
 &= ~(1<<1);

49 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A404
)

50 
GPIO_PCD
 &= ~(1<<3);

53 #i‡
	`deföed
 (
CONFIG_ARCH_LH7A400
)

54 
HRTFTC_HRSETUP
 &= ~(1<<13);

57 #i‡
	`deföed
 (
CONFIG_ARCH_LH7A404
)

58 
ALI_SETUP
 &= ~(1<<13);

60 
	}
}

62 
	$lh7a40x_˛cd_íabÀ
 (
˛cd_fb
 *
fb
)

64 
˛cd_∑√l_exåa
* 
exåa


65 (
˛cd_∑√l_exåa
*Ë
fb
->
bﬂrd_d©a
;

67 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

68 
CPLD_CONTROL
 |= (1<<1);

71 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A404
)

72 
GPIO_PCDD
 &= ~(1<<3);

73 
GPIO_PCD
 |= (1<<3);

76 #i‡
	`deföed
 (
CONFIG_ARCH_LH7A400
)

78 i‡(
exåa
) {

79 
HRTFTC_HRSETUP


81 | ((
fb
->fb.
v¨
.
xªs
 - 1) << 4)

83 | (
exåa
->
hrmode
 ? 1 : 0);

84 
HRTFTC_HRCON


85 ((
exåa
->
˛£n
 ? 1 : 0) << 1)

86 | ((
exåa
->
•£n
 ? 1 : 0) << 0);

87 
HRTFTC_HRTIMING1


88 (
exåa
->
pcdñ
 << 8)

89 | (
exåa
->
ªvdñ
 << 4)

90 | (
exåa
->
Õdñ
 << 0);

91 
HRTFTC_HRTIMING2


92 (
exåa
->
•ldñ
 << 9)

93 | (
exåa
->
pc2dñ
 << 0);

96 
HRTFTC_HRSETUP


101 #i‡
	`deföed
 (
CONFIG_ARCH_LH7A404
)

103 i‡(
exåa
) {

104 
ALI_SETUP


106 | ((
fb
->fb.
v¨
.
xªs
 - 1) << 4)

108 | (
exåa
->
hrmode
 ? 1 : 0);

109 
ALI_CONTROL


110 ((
exåa
->
˛£n
 ? 1 : 0) << 1)

111 | ((
exåa
->
•£n
 ? 1 : 0) << 0);

112 
ALI_TIMING1


113 (
exåa
->
pcdñ
 << 8)

114 | (
exåa
->
ªvdñ
 << 4)

115 | (
exåa
->
Õdñ
 << 0);

116 
ALI_TIMING2


117 (
exåa
->
•ldñ
 << 9)

118 | (
exåa
->
pc2dñ
 << 0);

121 
ALI_SETUP


126 
	}
}

128 
	#FRAMESIZE
(
s
Ë(((sË+ 
PAGE_SIZE
 - 1)&
PAGE_MASK
)

	)

130 
	$lh7a40x_˛cd_£tup
 (
˛cd_fb
 *
fb
)

132 
dma_addr_t
 
dma
;

133 
u32
 
Àn
 = 
	`FRAMESIZE
 (
lcd_∑√l
.
mode
.
xªs
*lcd_∑√l.mode.
yªs


134 *(
lcd_∑√l
.
bµ
/8));

136 
fb
->
∑√l
 = &
lcd_∑√l
;

139 i‡(!(
fb
->
∑√l
->
tim2
 & 
TIM2_IHS
))

140 
fb
->fb.
v¨
.
sync
 |
FB_SYNC_HOR_HIGH_ACT
;

141 i‡(!(
fb
->
∑√l
->
tim2
 & 
TIM2_IVS
))

142 
fb
->fb.
v¨
.
sync
 |
FB_SYNC_VERT_HIGH_ACT
;

144 #i‡
	`deföed
 (
HAS_LCD_PANEL_EXTRA
)

145 
fb
->
bﬂrd_d©a
 = &
lcd_∑√l_exåa
;

148 
fb
->fb.
s¸ìn_ba£


149 
	`dma_Æloc_wrôecomböe
 (&
fb
->
dev
->dev, 
Àn
,

150 &
dma
, 
GFP_KERNEL
);

151 
	`¥ötk
 ("CLCD: LCD setup fb virt 0x%pÖhys 0x%pÜ %x io 0x%p \n",

152 
fb
->fb.
s¸ìn_ba£
, (*Ë
dma
, 
Àn
,

153 (*Ë
	`io_p2v
 (
CLCDC_PHYS
));

154 
	`¥ötk
 ("CLCD:Öix˛ock %d\n", 
lcd_∑√l
.
mode
.
pix˛ock
);

156 i‡(!
fb
->fb.
s¸ìn_ba£
) {

157 
	`¥ötk
(
KERN_ERR
 "CLCD: unableÅo map framebuffer\n");

158  -
ENOMEM
;

161 #i‡
	`deföed
 (
USE_RGB555
)

162 
fb
->fb.
v¨
.
gªí
.
Àngth
 = 5;

165 
fb
->fb.
fix
.
smem_°¨t
 = 
dma
;

166 
fb
->fb.
fix
.
smem_Àn
 = 
Àn
;

169 
GPIO_PEDD
 |= (1<<4);

170 
GPIO_PED
 |= (1<<4);

172 
GPIO_PINMUX
 |= (1<<1) | (1<<0);

178 
	}
}

180 
	$lh7a40x_˛cd_mm≠
 (
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

182  
	`dma_mm≠_wrôecomböe
(&
fb
->
dev
->dev, 
vma
,

183 
fb
->fb.
s¸ìn_ba£
,

184 
fb
->fb.
fix
.
smem_°¨t
,

185 
fb
->fb.
fix
.
smem_Àn
);

186 
	}
}

188 
	$lh7a40x_˛cd_ªmove
 (
˛cd_fb
 *
fb
)

190 
	`dma_‰ì_wrôecomböe
 (&
fb
->
dev
->dev, fb->fb.
fix
.
smem_Àn
,

191 
fb
->fb.
s¸ìn_ba£
, fb->fb.
fix
.
smem_°¨t
);

192 
	}
}

194 
˛cd_bﬂrd
 
	g˛cd_∂©f‹m_d©a
 = {

195 .
«me
 = "lh7a40x FB",

196 .
	gcheck
 = 
˛cdfb_check
,

197 .
	gdecode
 = 
˛cdfb_decode
,

198 .
	gíabÀ
 = 
lh7a40x_˛cd_íabÀ
,

199 .
	g£tup
 = 
lh7a40x_˛cd_£tup
,

200 .
	gmm≠
 = 
lh7a40x_˛cd_mm≠
,

201 .
	gªmove
 = 
lh7a40x_˛cd_ªmove
,

202 .
	gdißbÀ
 = 
lh7a40x_˛cd_dißbÀ
,

205 
	#IRQ_CLCDC
 (
IRQ_LCDINTR
)

	)

207 
	#AMBA_DEVICE
(
«me
,
busid
,
ba£
,
∂©
,
pid
) \

208 
amba_devi˚
 
«me
##
_devi˚
 = { \

209 .
dev
 = { \

210 .
cohîít_dma_mask
 = ~0, \

211 .
bus_id
 = 
busid
, \

212 .
∂©f‹m_d©a
 = 
∂©
, \

214 .
ªs
 = { \

215 .
°¨t
 = 
ba£
##
_PHYS
, \

216 .
íd
 = (
ba£
##
_PHYS
) + (4*1024) - 1, \

217 .
Êags
 = 
IORESOURCE_MEM
, \

219 .
dma_mask
 = ~0, \

220 .
úq
 = { 
IRQ_
##
ba£
, }, \

222 .
≥rùhid
 = 
pid
, \

223 }

	)

225 
AMBA_DEVICE
(
˛cd
, "˛dc-lh7a40x", 
CLCDC
, &
˛cd_∂©f‹m_d©a
, 0x41110);

227 
amba_devi˚
 *
	gamba_devs
[] 
	g__öôd©a
 = {

228 &
˛cd_devi˚
,

231 
__öô
 
	$lh7a40x_˛cd_öô
 ()

233 
i
;

234 
ªsu…
;

235 
	`¥ötk
 ("CLCD:Ñegisteringámba devices\n");

236 
i
 = 0; i < 
	`ARRAY_SIZE
(
amba_devs
); i++) {

237 
amba_devi˚
 *
d
 = 
amba_devs
[
i
];

238 
ªsu…
 = 
	`amba_devi˚_ªgi°î
(
d
, &
iomem_ªsour˚
);

239 
	`¥ötk
 (" %d -> %d\n", 
i
 ,
ªsu…
);

241 
	}
}

	@arch/arm/mach-lh7a40x/clocks.c

11 
	~<löux/˝u‰eq.h
>

12 
	~<asm/h¨dw¨e.h
>

13 
	~<asm/¨ch/˛ocks.h
>

14 
	~<löux/îr.h
>

16 
	gmoduÀ
;

17 
	gic°525_∑øms
;

19 
	s˛k
 {

20 
li°_hód
 
	mnode
;

21 
	møã
;

22 
moduÀ
 *
	mow√r
;

23 c⁄° *
	m«me
;

29 
˛k_ªgi°î
(
˛k
 *clk);

30 
˛k_uƒegi°î
(
˛k
 *clk);

34 
	#MAINDIV1
(
c
Ë(((cË>> 7Ë& 0x0f)

	)

35 
	#MAINDIV2
(
c
Ë(((cË>> 11Ë& 0x1f)

	)

36 
	#PS
(
c
Ë(((cË>> 18Ë& 0x03)

	)

37 
	#PREDIV
(
c
Ë(((cË>> 2Ë& 0x1f)

	)

38 
	#HCLKDIV
(
c
Ë(((cË>> 0Ë& 0x02)

	)

39 
	#PCLKDIV
(
c
Ë(((cË>> 16Ë& 0x03)

	)

41 
	$˝u‰eq_gë
 (
˝u
)

43  
	`f˛k‰eq_gë
 ()/1000;

44 
	}
}

45 
EXPORT_SYMBOL
(
˝u‰eq_gë
);

47 
	$f˛k‰eq_gë
 ()

49 
˛k£t
 = 
CSC_CLKSET
;

50 
g˛k


51 
XTAL_IN


52 / (1 << 
	`PS
(
˛k£t
))

53 * (
	`MAINDIV1
(
˛k£t
) + 2)

54 / (
	`PREDIV
(
˛k£t
) + 2)

55 * (
	`MAINDIV2
(
˛k£t
) + 2)

57  
g˛k
;

58 
	}
}

60 
	$h˛k‰eq_gë
 ()

62 
˛k£t
 = 
CSC_CLKSET
;

63 
h˛k
 = 
	`f˛k‰eq_gë
 (Ë/ (
	`HCLKDIV
(
˛k£t
) + 1);

65  
h˛k
;

66 
	}
}

68 
	$p˛k‰eq_gë
 ()

70 
˛k£t
 = 
CSC_CLKSET
;

71 
p˛kdiv
 = 
	`PCLKDIV
(
˛k£t
);

72 
p˛k
;

73 i‡(
p˛kdiv
 == 0x3)

74 
p˛kdiv
 = 0x2;

75 
p˛k
 = 
	`h˛k‰eq_gë
 (Ë/ (1 << 
p˛kdiv
);

77  
p˛k
;

78 
	}
}

82 
LIST_HEAD
(
˛ocks
);

83 
DECLARE_MUTEX
(
˛ocks_£m
);

85 
˛k
 *
	$˛k_gë
 (
devi˚
 *
dev
, c⁄° *
id
)

87 
˛k
 *
p
;

88 
˛k
 *˛k = 
	`ERR_PTR
(-
ENOENT
);

90 
	`down
 (&
˛ocks_£m
);

91 
	`li°_f‹_óch_íåy
 (
p
, &
˛ocks
, 
node
) {

92 i‡(
	`°rcmp
 (
id
, 
p
->
«me
) == 0

93 && 
	`åy_moduÀ_gë
(
p
->
ow√r
)) {

94 
˛k
 = 
p
;

98 
	`up
 (&
˛ocks_£m
);

100  
˛k
;

101 
	}
}

102 
EXPORT_SYMBOL
(
˛k_gë
);

104 
	$˛k_put
 (
˛k
 *clk)

106 
	`moduÀ_put
(
˛k
->
ow√r
);

107 
	}
}

108 
EXPORT_SYMBOL
(
˛k_put
);

110 
	$˛k_íabÀ
 (
˛k
 *clk)

113 
	}
}

114 
EXPORT_SYMBOL
(
˛k_íabÀ
);

116 
	$˛k_dißbÀ
 (
˛k
 *clk)

118 
	}
}

119 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

121 
	$˛k_u£
 (
˛k
 *clk)

124 
	}
}

125 
EXPORT_SYMBOL
(
˛k_u£
);

127 
	$˛k_unu£
 (
˛k
 *clk)

129 
	}
}

130 
EXPORT_SYMBOL
(
˛k_unu£
);

132 
	$˛k_gë_øã
 (
˛k
 *clk)

134  
˛k
->
øã
;

135 
	}
}

136 
EXPORT_SYMBOL
(
˛k_gë_øã
);

138 
	$˛k_round_øã
 (
˛k
 *˛k, 
øã
)

140  
øã
;

141 
	}
}

142 
EXPORT_SYMBOL
(
˛k_round_øã
);

144 
	$˛k_£t_øã
 (
˛k
 *˛k, 
øã
)

146 
ªt
 = -
EIO
;

147  
ªt
;

148 
	}
}

149 
EXPORT_SYMBOL
(
˛k_£t_øã
);

155 
˛k
 
	gkmi_˛k
 = {

156 .
«me
 = "KMIREFCLK",

157 .
	gøã
 = 24000000,

160 
˛k
 
	gu¨t_˛k
 = {

161 .
«me
 = "UARTCLK",

162 .
	gøã
 = 24000000,

165 
˛k
 
	gmmci_˛k
 = {

166 .
«me
 = "MCLK",

167 .
	gøã
 = 33000000,

171 
˛k
 
	g˛cd_˛k
 = {

172 .
«me
 = "CLCDCLK",

173 .
	gøã
 = 0,

176 
	$˛k_ªgi°î
 (
˛k
 *clk)

178 
	`down
 (&
˛ocks_£m
);

179 
	`li°_add
 (&
˛k
->
node
, &
˛ocks
);

180 
	`up
 (&
˛ocks_£m
);

182 
	}
}

183 
EXPORT_SYMBOL
(
˛k_ªgi°î
);

185 
	$˛k_uƒegi°î
 (
˛k
 *clk)

187 
	`down
 (&
˛ocks_£m
);

188 
	`li°_dñ
 (&
˛k
->
node
);

189 
	`up
 (&
˛ocks_£m
);

190 
	}
}

191 
EXPORT_SYMBOL
(
˛k_uƒegi°î
);

193 
__öô
 
	$˛k_öô
 ()

195 
	`˛k_ªgi°î
(&
˛cd_˛k
);

197 
	}
}

198 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-lh7a40x/common.h

11 
sys_timî
 
lh7a40x_timî
;

13 
lh7a400_öô_úq
 ();

14 
lh7a404_öô_úq
 ();

15 
lh7a40x_˛cd_öô
 ();

16 
lh7a40x_öô_bﬂrd_úq
 ();

18 
	#IRQ_DISPATCH
(
úq
Ë
	`desc_h™dÀ_úq
((úq),(
úq_desc
 + irq))

	)

	@arch/arm/mach-lh7a40x/irq-kev7a400.c

11 
	~<löux/öãºu±.h
>

12 
	~<löux/öô.h
>

14 
	~<asm/úq.h
>

15 
	~<asm/mach/úq.h
>

16 
	~<asm/mach/h¨dw¨e.h
>

17 
	~<asm/mach/úqs.h
>

19 
	~"comm⁄.h
"

23 
u16
 
	gCPLD_IRQ_mask
;

26 
	$lh7a400_ack_˝ld_úq
 (
u32
 
úq
)

28 
CPLD_CL_INT
 = 1 << (
úq
 - 
IRQ_KEV7A400_CPLD
);

29 
	}
}

32 
	$lh7a400_mask_˝ld_úq
 (
u32
 
úq
)

34 
CPLD_IRQ_mask
 &~(1 << (
úq
 - 
IRQ_KEV7A400_CPLD
));

35 
CPLD_WR_PB_INT_MASK
 = 
CPLD_IRQ_mask
;

36 
	}
}

39 
	$lh7a400_unmask_˝ld_úq
 (
u32
 
úq
)

41 
CPLD_IRQ_mask
 |1 << (
úq
 - 
IRQ_KEV7A400_CPLD
);

42 
CPLD_WR_PB_INT_MASK
 = 
CPLD_IRQ_mask
;

43 
	}
}

46 
úq_chù
 
	glh7a400_˝ld_chù
 = {

47 .
«me
 = "CPLD",

48 .
	gack
 = 
lh7a400_ack_˝ld_úq
,

49 .
	gmask
 = 
lh7a400_mask_˝ld_úq
,

50 .
	gunmask
 = 
lh7a400_unmask_˝ld_úq
,

54 
	$lh7a400_˝ld_h™dÀr
 (
úq
, 
úq_desc
 *
desc
)

56 
u32
 
mask
 = 
CPLD_LATCHED_INTS
;

57 
úq
 = 
IRQ_KEV_7A400_CPLD
;

58 ; 
mask
; mask >>1, ++
úq
) {

59 i‡(
mask
 & 1)

60 
desc
[
úq
].
	`h™dÀ
 (irq, desc);

62 
	}
}

66 
__öô


67 
	$lh7a400_öô_bﬂrd_úq
 ()

69 
úq
;

71 
úq
 = 
IRQ_KEV7A400_CPLD
;

72 
úq
 < 
IRQ_KEV7A400_CPLD
 + 
NR_IRQ_KEV7A400_CPLD
; ++irq) {

73 
	`£t_úq_chù
 (
úq
, &
lh7a400_˝ld_chù
);

74 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_edge_úq
);

75 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

77 
	`£t_úq_chaöed_h™dÀr
 (
IRQ_CPLD
, 
kev7a400_˝ld_h™dÀr
);

80 
CPLD_CL_INT
 = 0xff;

84 
GPIO_GPIOINTEN
 = 0;

85 
	`b¨rõr
();

86 
GPIO_INTTYPE1


87 (
GPIO_INTR_PCC1_CD
 | GPIO_INTR_PCC1_CD);

88 
GPIO_INTTYPE2
 = 0;

89 
GPIO_GPIOFEOI
 = 0xff;

90 
GPIO_GPIOINTEN
 = 0xff;

92 
	`öô_FIQ
();

93 
	}
}

	@arch/arm/mach-lh7a40x/irq-lh7a400.c

11 
	~<löux/öô.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/öãºu±.h
>

15 
	~<asm/h¨dw¨e.h
>

16 
	~<asm/úq.h
>

17 
	~<asm/mach/úq.h
>

18 
	~<asm/¨ch/úqs.h
>

20 
	~"comm⁄.h
"

24 
	$lh7a400_mask_úq
 (
u32
 
úq
)

26 
INTC_INTENC
 = (1 << 
úq
);

27 
	}
}

29 
	$lh7a400_unmask_úq
 (
u32
 
úq
)

31 
INTC_INTENS
 = (1 << 
úq
);

32 
	}
}

34 
	$lh7a400_ack_gpio_úq
 (
u32
 
úq
)

36 
GPIO_GPIOFEOI
 = (1 << 
	`IRQ_TO_GPIO
 (
úq
));

37 
INTC_INTENC
 = (1 << 
úq
);

38 
	}
}

40 
úq_chù
 
	glh7a400_öã∫Æ_chù
 = {

41 .
«me
 = "MPU",

42 .
	gack
 = 
lh7a400_mask_úq
,

43 .
	gmask
 = 
lh7a400_mask_úq
,

44 .
	gunmask
 = 
lh7a400_unmask_úq
,

47 
úq_chù
 
	glh7a400_gpio_chù
 = {

48 .
«me
 = "GPIO",

49 .
	gack
 = 
lh7a400_ack_gpio_úq
,

50 .
	gmask
 = 
lh7a400_mask_úq
,

51 .
	gunmask
 = 
lh7a400_unmask_úq
,

57 
__öô
 
	$lh7a400_öô_úq
 ()

59 
úq
;

61 
INTC_INTENC
 = 0xffffffff;

62 
GPIO_GPIOFINTEN
 = 0x00;

63 
	`b¨rõr
 ();

65 
úq
 = 0; irq < 
NR_IRQS
; ++irq) {

66 
úq
) {

67 
IRQ_GPIO0INTR
:

68 
IRQ_GPIO1INTR
:

69 
IRQ_GPIO2INTR
:

70 
IRQ_GPIO3INTR
:

71 
IRQ_GPIO4INTR
:

72 
IRQ_GPIO5INTR
:

73 
IRQ_GPIO6INTR
:

74 
IRQ_GPIO7INTR
:

75 
	`£t_úq_chù
 (
úq
, &
lh7a400_gpio_chù
);

76 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_Àvñ_úq
);

79 
	`£t_úq_chù
 (
úq
, &
lh7a400_öã∫Æ_chù
);

80 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_Àvñ_úq
);

82 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

85 
	`lh7a40x_öô_bﬂrd_úq
 ();

91 
	}
}

	@arch/arm/mach-lh7a40x/irq-lh7a404.c

11 
	~<löux/öô.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/öãºu±.h
>

15 
	~<asm/h¨dw¨e.h
>

16 
	~<asm/úq.h
>

17 
	~<asm/mach/úq.h
>

18 
	~<asm/¨ch/úqs.h
>

20 
	~"comm⁄.h
"

22 
	#USE_PRIORITIES


	)

28 
	gúq_¥i_vic1
[] = {

29 #i‡
deföed
 (
USE_PRIORITIES
)

30 
IRQ_GPIO3INTR
,

31 
IRQ_DMAM2P4
, 
IRQ_DMAM2P5
,

34 
	gúq_¥i_vic2
[] = {

35 #i‡
deföed
 (
USE_PRIORITIES
)

36 
IRQ_T3UI
,

37 
IRQ_GPIO7INTR
,

38 
IRQ_UART1INTR
, 
IRQ_UART2INTR
, 
IRQ_UART3INTR
,

39 
IRQ_LCDINTR
,

40 
IRQ_TSCINTR
,

46 
	$lh7a404_vic1_mask_úq
 (
u32
 
úq
)

48 
VIC1_INTENCLR
 = (1 << 
úq
);

49 
	}
}

51 
	$lh7a404_vic1_unmask_úq
 (
u32
 
úq
)

53 
VIC1_INTEN
 = (1 << 
úq
);

54 
	}
}

56 
	$lh7a404_vic2_mask_úq
 (
u32
 
úq
)

58 
VIC2_INTENCLR
 = (1 << (
úq
 - 32));

59 
	}
}

61 
	$lh7a404_vic2_unmask_úq
 (
u32
 
úq
)

63 
VIC2_INTEN
 = (1 << (
úq
 - 32));

64 
	}
}

66 
	$lh7a404_vic1_ack_gpio_úq
 (
u32
 
úq
)

68 
GPIO_GPIOFEOI
 = (1 << 
	`IRQ_TO_GPIO
 (
úq
));

69 
VIC1_INTENCLR
 = (1 << 
úq
);

70 
	}
}

72 
	$lh7a404_vic2_ack_gpio_úq
 (
u32
 
úq
)

74 
GPIO_GPIOFEOI
 = (1 << 
	`IRQ_TO_GPIO
 (
úq
));

75 
VIC2_INTENCLR
 = (1 << 
úq
);

76 
	}
}

78 
úq_chù
 
	glh7a404_vic1_chù
 = {

79 .
«me
 = "VIC1",

80 .
	gack
 = 
lh7a404_vic1_mask_úq
,

81 .
	gmask
 = 
lh7a404_vic1_mask_úq
,

82 .
	gunmask
 = 
lh7a404_vic1_unmask_úq
,

85 
úq_chù
 
	glh7a404_vic2_chù
 = {

86 .
«me
 = "VIC2",

87 .
	gack
 = 
lh7a404_vic2_mask_úq
,

88 .
	gmask
 = 
lh7a404_vic2_mask_úq
,

89 .
	gunmask
 = 
lh7a404_vic2_unmask_úq
,

92 
úq_chù
 
	glh7a404_gpio_vic1_chù
 = {

93 .
«me
 = "GPIO-VIC1",

94 .
	gack
 = 
lh7a404_vic1_ack_gpio_úq
,

95 .
	gmask
 = 
lh7a404_vic1_mask_úq
,

96 .
	gunmask
 = 
lh7a404_vic1_unmask_úq
,

99 
úq_chù
 
	glh7a404_gpio_vic2_chù
 = {

100 .
«me
 = "GPIO-VIC2",

101 .
	gack
 = 
lh7a404_vic2_ack_gpio_úq
,

102 .
	gmask
 = 
lh7a404_vic2_mask_úq
,

103 .
	gunmask
 = 
lh7a404_vic2_unmask_úq
,

108 #i‡
deföed
 (
CONFIG_ARCH_LH7A400
Ë&& deföed (
CONFIG_ARCH_LH7A404
)

109 * 
bønch_úq_lh7a400
;

112 
__öô
 
	$lh7a404_öô_úq
 ()

114 
úq
;

116 #i‡
	`deföed
 (
CONFIG_ARCH_LH7A400
Ë&& deföed (
CONFIG_ARCH_LH7A404
)

117 
	#NOP
 0xe1a00000

	)

118 
bønch_úq_lh7a400
 = 
NOP
;

121 
VIC1_INTENCLR
 = 0xffffffff;

122 
VIC2_INTENCLR
 = 0xffffffff;

123 
VIC1_INTSEL
 = 0;

124 
VIC2_INTSEL
 = 0;

125 
VIC1_NVADDR
 = 
VA_VIC1DEFAULT
;

126 
VIC2_NVADDR
 = 
VA_VIC2DEFAULT
;

127 
VIC1_VECTADDR
 = 0;

128 
VIC2_VECTADDR
 = 0;

130 
GPIO_GPIOFINTEN
 = 0x00;

131 
	`b¨rõr
 ();

135 
úq
 = 0; irq < 16; ++irq) {

136 (&
VIC1_VAD0
)[
úq
]

137 (
úq
 < 
	`ARRAY_SIZE
 (
úq_¥i_vic1
))

138 ? (
úq_¥i_vic1
[
úq
] | 
VA_VECTORED
) : 0;

139 (&
VIC1_VECTCNTL0
)[
úq
]

140 (
úq
 < 
	`ARRAY_SIZE
 (
úq_¥i_vic1
))

141 ? (
úq_¥i_vic1
[
úq
] | 
VIC_CNTL_ENABLE
) : 0;

142 (&
VIC2_VAD0
)[
úq
]

143 (
úq
 < 
	`ARRAY_SIZE
 (
úq_¥i_vic2
))

144 ? (
úq_¥i_vic2
[
úq
] | 
VA_VECTORED
) : 0;

145 (&
VIC2_VECTCNTL0
)[
úq
]

146 (
úq
 < 
	`ARRAY_SIZE
 (
úq_¥i_vic2
))

147 ? (
úq_¥i_vic2
[
úq
] | 
VIC_CNTL_ENABLE
) : 0;

150 
úq
 = 0; irq < 
NR_IRQS
; ++irq) {

151 
úq
) {

152 
IRQ_GPIO0INTR
:

153 
IRQ_GPIO1INTR
:

154 
IRQ_GPIO2INTR
:

155 
IRQ_GPIO3INTR
:

156 
IRQ_GPIO4INTR
:

157 
IRQ_GPIO5INTR
:

158 
IRQ_GPIO6INTR
:

159 
IRQ_GPIO7INTR
:

160 
	`£t_úq_chù
 (
úq
, irq < 32

161 ? &
lh7a404_gpio_vic1_chù


162 : &
lh7a404_gpio_vic2_chù
);

163 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_Àvñ_úq
);

166 
	`£t_úq_chù
 (
úq
, irq < 32

167 ? &
lh7a404_vic1_chù


168 : &
lh7a404_vic2_chù
);

169 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_Àvñ_úq
);

171 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

174 
	`lh7a40x_öô_bﬂrd_úq
 ();

175 
	}
}

	@arch/arm/mach-lh7a40x/irq-lpd7a40x.c

12 
	~<löux/öô.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/öãºu±.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/úq.h
>

18 
	~<asm/mach/úq.h
>

19 
	~<asm/¨ch/úqs.h
>

21 
	~"comm⁄.h
"

23 
	$lh7a40x_ack_˝ld_úq
 (
u32
 
úq
)

26 
	}
}

28 
	$lh7a40x_mask_˝ld_úq
 (
u32
 
úq
)

30 
úq
) {

31 
IRQ_LPD7A40X_ETH_INT
:

32 
CPLD_INTERRUPTS
 = CPLD_INTERRUPTS | 0x4;

34 
IRQ_LPD7A400_TS
:

35 
CPLD_INTERRUPTS
 = CPLD_INTERRUPTS | 0x8;

38 
	}
}

40 
	$lh7a40x_unmask_˝ld_úq
 (
u32
 
úq
)

42 
úq
) {

43 
IRQ_LPD7A40X_ETH_INT
:

44 
CPLD_INTERRUPTS
 = CPLD_INTERRUPTS & ~ 0x4;

46 
IRQ_LPD7A400_TS
:

47 
CPLD_INTERRUPTS
 = CPLD_INTERRUPTS & ~ 0x8;

50 
	}
}

52 
úq_chù
 
	glh7a40x_˝ld_chù
 = {

53 .
«me
 = "CPLD",

54 .
	gack
 = 
lh7a40x_ack_˝ld_úq
,

55 .
	gmask
 = 
lh7a40x_mask_˝ld_úq
,

56 .
	gunmask
 = 
lh7a40x_unmask_˝ld_úq
,

59 
	$lh7a40x_˝ld_h™dÀr
 (
úq
, 
úq_desc
 *
desc
)

61 
mask
 = 
CPLD_INTERRUPTS
;

63 
desc
->
chù
->
	`ack
 (
úq
);

65 i‡((
mask
 & 0x1) == 0)

66 
	`IRQ_DISPATCH
 (
IRQ_LPD7A40X_ETH_INT
);

68 i‡((
mask
 & 0x2) == 0)

69 
	`IRQ_DISPATCH
 (
IRQ_LPD7A400_TS
);

71 
desc
->
chù
->
	`unmask
 (
úq
);

72 
	}
}

77 
__öô
 
	$lh7a40x_öô_bﬂrd_úq
 ()

79 
úq
;

90 
˝ld_vîsi⁄
 = 
CPLD_REVISION
;

91 
pöCPLD
;

93 #i‡
deföed
 
CONFIG_MACH_LPD7A404


94 
˝ld_vîsi⁄
 = 0x34;

96 
pöCPLD
 = (
˝ld_vîsi⁄
 == 0x28) ? 7 : 3;

100 
GPIO_PFDD
 &= ~0x0f;

101 
GPIO_INTTYPE1
 &= ~0x0f;

102 
GPIO_INTTYPE2
 &= ~0x0f;

103 
	`b¨rõr
 ();

104 
GPIO_GPIOFINTEN
 |= 0x0f;

108 
CPLD_INTERRUPTS
 = 0x0c;

109 
GPIO_PFDD
 &~(1 << 
pöCPLD
);

110 
GPIO_INTTYPE1
 |(1 << 
pöCPLD
);

111 
GPIO_INTTYPE2
 &~(1 << 
pöCPLD
);

112 
	`b¨rõr
 ();

113 
GPIO_GPIOFINTEN
 |(1 << 
pöCPLD
);

117 
úq
 = 
IRQ_BOARD_START
;

118 
úq
 < 
IRQ_BOARD_START
 + 
NR_IRQ_BOARD
; ++irq) {

119 
	`£t_úq_chù
 (
úq
, &
lh7a40x_˝ld_chù
);

120 
	`£t_úq_h™dÀr
 (
úq
, 
h™dÀ_edge_úq
);

121 
	`£t_úq_Êags
 (
úq
, 
IRQF_VALID
);

124 
	`£t_úq_chaöed_h™dÀr
 ((
˝ld_vîsi⁄
 == 0x28)

125 ? 
IRQ_CPLD_V28


126 : 
IRQ_CPLD_V34
,

127 
lh7a40x_˝ld_h™dÀr
);

128 
	}
}

	@arch/arm/mach-lh7a40x/lcd-panel.h

37 #i‡!
deföed
 (
__LCD_PANEL_H__
)

38 
	#__LCD_PANEL_H__


	)

40 #i‡
deföed
 (
MACH_LPD79520
)\

41 || 
deföed
 (
MACH_LPD79524
)\

42 || 
deföed
 (
MACH_LPD7A400
)\

43 || 
	$deföed
 (
MACH_LPD7A404
)

44 
	#USE_RGB555


	)

47 
	s˛cd_∑√l_exåa
 {

48 
hrmode
;

49 
˛£n
;

50 
•£n
;

51 
pcdñ
;

52 
ªvdñ
;

53 
Õdñ
;

54 
•ldñ
;

55 
pc2dñ
;

58 
	#NS_TO_CLOCK
(
ns
,
c
Ë(((“s)*((c)/1000Ë+ (1000000 - 1))/1000000))

	)

59 
	#CLOCK_TO_DIV
(
e
,
c
Ë(((cË+ (eË- 1)/”))

	)

61 #i‡
deföed
 
CONFIG_FB_ARMCLCD_SHARP_LQ035Q7DB02_HRTFT


66 
	#PIX_CLOCK_TARGET
 (6800000)

	)

67 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

68 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

70 
˛cd_∑√l
 
lcd_∑√l
 = {

71 .
mode
 = {

72 .
«me
 = "3.5in QVGA (LQ035Q7DB02)",

73 .
xªs
 = 240,

74 .
yªs
 = 320,

75 .
pix˛ock
 = 
PIX_CLOCK
,

76 .
À·_m¨gö
 = 16,

77 .
right_m¨gö
 = 21,

78 .
uµî_m¨gö
 = 8,

79 .
lowî_m¨gö
 = 5,

80 .
hsync_Àn
 = 61,

81 .
vsync_Àn
 = 
	`NS_TO_CLOCK
 (60, 
PIX_CLOCK
),

82 .
vmode
 = 
FB_VMODE_NONINTERLACED
,

84 .
width
 = -1,

85 .
height
 = -1,

86 .
tim2
 = 
TIM2_IPC
 | (
PIX_CLOCK_DIVIDER
 - 2),

87 .
˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

88 .
bµ
 = 16,

89 
	}
};

91 
	#HAS_LCD_PANEL_EXTRA


	)

93 
˛cd_∑√l_exåa
 
	glcd_∑√l_exåa
 = {

94 .
hrmode
 = 1,

95 .
	g˛£n
 = 1,

96 .
	g•£n
 = 1,

97 .
	gpcdñ
 = 8,

98 .
	gªvdñ
 = 7,

99 .
	gÕdñ
 = 13,

100 .
	g•ldñ
 = 77,

101 .
	gpc2dñ
 = 208,

106 #i‡
deföed
 
CONFIG_FB_ARMCLCD_SHARP_LQ057Q3DC02


132 
	#PIX_CLOCK_TARGET
 (6300000Ë

	)

133 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

134 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

136 
˛cd_∑√l
 
	glcd_∑√l
 = {

137 .
mode
 = {

138 .
«me
 = "5.7in QVGA (LQ057Q3DC02)",

139 .
	gxªs
 = 320,

140 .
	gyªs
 = 240,

141 .
	gpix˛ock
 = 
PIX_CLOCK
,

142 .
	gÀ·_m¨gö
 = 11,

143 .
	gright_m¨gö
 = 400-11-320-2,

144 .
	guµî_m¨gö
 = 7,

145 .
	glowî_m¨gö
 = 262-7-240-2,

146 .
	ghsync_Àn
 = 2,

147 .
	gvsync_Àn
 = 2,

148 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

150 .
	gwidth
 = -1,

151 .
	gheight
 = -1,

152 .
	gtim2
 = 
TIM2_IHS
 | 
TIM2_IVS


153 | (
PIX_CLOCK_DIVIDER
 - 2),

154 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

155 .
	gbµ
 = 16,

160 #i‡
deföed
 
CONFIG_FB_ARMCLCD_SHARP_LQ64D343


168 
	#PIX_CLOCK_TARGET
 (28330000)

	)

169 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

170 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

172 
˛cd_∑√l
 
	glcd_∑√l
 = {

173 .
mode
 = {

174 .
«me
 = "6.4in QVGA (LQ64D343)",

175 .
	gxªs
 = 640,

176 .
	gyªs
 = 480,

177 .
	gpix˛ock
 = 
PIX_CLOCK
,

178 .
	gÀ·_m¨gö
 = 32,

179 .
	gright_m¨gö
 = 800-32-640-96,

180 .
	guµî_m¨gö
 = 32,

181 .
	glowî_m¨gö
 = 540-32-480-2,

182 .
	ghsync_Àn
 = 96,

183 .
	gvsync_Àn
 = 2,

184 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

186 .
	gwidth
 = -1,

187 .
	gheight
 = -1,

188 .
	gtim2
 = 
TIM2_IHS
 | 
TIM2_IVS


189 | (
PIX_CLOCK_DIVIDER
 - 2),

190 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

191 .
	gbµ
 = 16,

196 #i‡
deföed
 
CONFIG_FB_ARMCLCD_SHARP_LQ10D368


201 
	#PIX_CLOCK_TARGET
 (28330000)

	)

202 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

203 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

205 
˛cd_∑√l
 
	glcd_∑√l
 = {

206 .
mode
 = {

207 .
«me
 = "10.4in VGA (LQ10D368)",

208 .
	gxªs
 = 640,

209 .
	gyªs
 = 480,

210 .
	gpix˛ock
 = 
PIX_CLOCK
,

211 .
	gÀ·_m¨gö
 = 21,

212 .
	gright_m¨gö
 = 15,

213 .
	guµî_m¨gö
 = 34,

214 .
	glowî_m¨gö
 = 5,

215 .
	ghsync_Àn
 = 96,

216 .
	gvsync_Àn
 = 16,

217 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

219 .
	gwidth
 = -1,

220 .
	gheight
 = -1,

221 .
	gtim2
 = 
TIM2_IHS
 | 
TIM2_IVS


222 | (
PIX_CLOCK_DIVIDER
 - 2),

223 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

224 .
	gbµ
 = 16,

229 #i‡
deföed
 
CONFIG_FB_ARMCLCD_SHARP_LQ121S1DG41


248 
	#PIX_CLOCK_TARGET
 (20000000)

	)

249 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

250 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

252 
˛cd_∑√l
 
	glcd_∑√l
 = {

253 .
mode
 = {

254 .
«me
 = "12.1in SVGA (LQ121S1DG41)",

255 .
	gxªs
 = 800,

256 .
	gyªs
 = 600,

257 .
	gpix˛ock
 = 
PIX_CLOCK
,

258 .
	gÀ·_m¨gö
 = 89,

259 .
	gright_m¨gö
 = 1056-800-89-128,

260 .
	guµî_m¨gö
 = 23,

261 .
	glowî_m¨gö
 = 44,

262 .
	ghsync_Àn
 = 128,

263 .
	gvsync_Àn
 = 4,

264 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

266 .
	gwidth
 = -1,

267 .
	gheight
 = -1,

268 .
	gtim2
 = 
TIM2_IHS
 | 
TIM2_IVS


269 | (
PIX_CLOCK_DIVIDER
 - 2),

270 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

271 .
	gbµ
 = 16,

276 #i‡
deföed
 
CONFIG_FB_ARMCLCD_HITACHI


281 
	#PIX_CLOCK_TARGET
 (49000000)

	)

282 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

283 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

285 
˛cd_∑√l
 
	glcd_∑√l
 = {

286 .
mode
 = {

287 .
«me
 = "Hitachi 800x480",

288 .
	gxªs
 = 800,

289 .
	gyªs
 = 480,

290 .
	gpix˛ock
 = 
PIX_CLOCK
,

291 .
	gÀ·_m¨gö
 = 88,

292 .
	gright_m¨gö
 = 40,

293 .
	guµî_m¨gö
 = 32,

294 .
	glowî_m¨gö
 = 11,

295 .
	ghsync_Àn
 = 128,

296 .
	gvsync_Àn
 = 2,

297 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

299 .
	gwidth
 = -1,

300 .
	gheight
 = -1,

301 .
	gtim2
 = 
TIM2_IPC
 | 
TIM2_IHS
 | 
TIM2_IVS


302 | (
PIX_CLOCK_DIVIDER
 - 2),

303 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

304 .
	gbµ
 = 16,

310 #i‡
deföed
 
CONFIG_FB_ARMCLCD_AUO_A070VW01_WIDE


315 
	#PIX_CLOCK_TARGET
 (10000000)

	)

316 
	#PIX_CLOCK_DIVIDER
 
	`CLOCK_TO_DIV
 (
PIX_CLOCK_TARGET
, 
HCLK
)

	)

317 
	#PIX_CLOCK
 (
HCLK
/
PIX_CLOCK_DIVIDER
)

	)

319 
˛cd_∑√l
 
	glcd_∑√l
 = {

320 .
mode
 = {

321 .
«me
 = "7.0in Wide (A070VW01)",

322 .
	gxªs
 = 480,

323 .
	gyªs
 = 234,

324 .
	gpix˛ock
 = 
PIX_CLOCK
,

325 .
	gÀ·_m¨gö
 = 30,

326 .
	gright_m¨gö
 = 25,

327 .
	guµî_m¨gö
 = 14,

328 .
	glowî_m¨gö
 = 12,

329 .
	ghsync_Àn
 = 100,

330 .
	gvsync_Àn
 = 1,

331 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

333 .
	gwidth
 = -1,

334 .
	gheight
 = -1,

335 .
	gtim2
 = 
TIM2_IPC
 | 
TIM2_IHS
 | 
TIM2_IVS


336 | (
PIX_CLOCK_DIVIDER
 - 2),

337 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_WATERMARK
,

338 .
	gbµ
 = 16,

343 #unde‡
NS_TO_CLOCK


344 #unde‡
CLOCK_TO_DIV


	@arch/arm/mach-lh7a40x/ssp-cpld.c

37 
	~<löux/moduÀ.h
>

38 
	~<löux/kî√l.h
>

40 
	~<löux/î∫o.h
>

41 
	~<löux/öãºu±.h
>

43 
	~<löux/öô.h
>

44 
	~<löux/dñay.h
>

45 
	~<löux/•ölock.h
>

47 
	~<asm/io.h
>

48 
	~<asm/úq.h
>

49 
	~<asm/h¨dw¨e.h
>

51 
	~<asm/¨ch/s•.h
>

55 #i‡
deföed
 (
TALK
)

56 
	#PRINTK
(
f
...Ë
	`¥ötk
 (f)

	)

58 
	#PRINTK
(
f
...Ëdÿ{} 0)

	)

61 #i‡
deföed
 (
CONFIG_ARCH_LH7A400
)

62 
	#CPLD_SPID
 
	`__REGP16
(
CPLD06_VIRT
Ë

	)

63 
	#CPLD_SPIC
 
	`__REGP16
(
CPLD08_VIRT
Ë

	)

64 
	#CPLD_SPIC_CS_CODEC
 (1<<0)

	)

65 
	#CPLD_SPIC_CS_TOUCH
 (1<<1)

	)

66 
	#CPLD_SPIC_WRITE
 (0<<2)

	)

67 
	#CPLD_SPIC_READ
 (1<<2)

	)

68 
	#CPLD_SPIC_DONE
 (1<<3Ë

	)

69 
	#CPLD_SPIC_LOAD
 (1<<4)

	)

70 
	#CPLD_SPIC_START
 (1<<4)

	)

71 
	#CPLD_SPIC_LOADED
 (1<<5Ë

	)

74 
	#CPLD_SPI
 
	`__REGP16
(
CPLD0A_VIRT
Ë

	)

75 
	#CPLD_SPI_CS_EEPROM
 (1<<3)

	)

76 
	#CPLD_SPI_SCLK
 (1<<2)

	)

77 
	#CPLD_SPI_TX_SHIFT
 (1)

	)

78 
	#CPLD_SPI_TX
 (1<<
CPLD_SPI_TX_SHIFT
)

	)

79 
	#CPLD_SPI_RX_SHIFT
 (0)

	)

80 
	#CPLD_SPI_RX
 (1<<
CPLD_SPI_RX_SHIFT
)

	)

84 
	#T_SKH
 1

	)

85 
	#T_SKL
 1

	)

86 
	#T_CS
 1

	)

87 
	#T_CSS
 1

	)

88 
	#T_DIS
 1

	)

91 
	#P_START
 (1<<9)

	)

92 
	#P_WRITE
 (1<<7)

	)

93 
	#P_READ
 (2<<7)

	)

94 
	#P_ERASE
 (3<<7)

	)

95 
	#P_EWDS
 (0<<7)

	)

96 
	#P_WRAL
 (0<<7)

	)

97 
	#P_ERAL
 (0<<7)

	)

98 
	#P_EWEN
 (0<<7)

	)

99 
	#P_A_EWDS
 (0<<5)

	)

100 
	#P_A_WRAL
 (1<<5)

	)

101 
	#P_A_ERAL
 (2<<5)

	)

102 
	#P_A_EWEN
 (3<<5)

	)

104 
	ss•_c⁄figuøti⁄
 {

105 
	mdevi˚
;

106 
	mmode
;

107 
	m•ìd
;

108 
	m‰ame_size_wrôe
;

109 
	m‰ame_size_ªad
;

112 
s•_c⁄figuøti⁄
 
	gs•_c⁄figuøti⁄
;

113 
•ölock_t
 
	gs•_lock
;

115 
	$íabÀ_cs
 ()

117 
s•_c⁄figuøti⁄
.
devi˚
) {

118 
DEVICE_EEPROM
:

119 
CPLD_SPI
 |
CPLD_SPI_CS_EEPROM
;

122 
	`udñay
 (
T_CSS
);

123 
	}
}

125 
	$dißbÀ_cs
 ()

127 
s•_c⁄figuøti⁄
.
devi˚
) {

128 
DEVICE_EEPROM
:

129 
CPLD_SPI
 &~
CPLD_SPI_CS_EEPROM
;

132 
	`udñay
 (
T_CS
);

133 
	}
}

135 
	$pul£_˛ock
 ()

137 
CPLD_SPI
 |
CPLD_SPI_SCLK
;

138 
	`udñay
 (
T_SKH
);

139 
CPLD_SPI
 &~
CPLD_SPI_SCLK
;

140 
	`udñay
 (
T_SKL
);

141 
	}
}

158 
	$execuã_•i_comm™d
 (
v
, 
cwrôe
, 
¸ód
)

160 
l
 = 0;

162 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

166 i‡–
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_CODEC


167 || 
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_TOUCH
) {

168 
£À˘
 = 0;

170 
	`PRINTK
 ("spi(%d %d.%d) 0x%04x",

171 
s•_c⁄figuøti⁄
.
devi˚
, 
cwrôe
, 
¸ód
,

172 
v
);

173 #i‡
	`deföed
 (
TALK
)

174 i‡(
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_CODEC
)

175 
	`PRINTK
 (" 0x%03x -> %2d", 
v
 & 0x1ff, (v >> 9) & 0x7f);

177 
	`PRINTK
 ("\n");

179 i‡(
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_CODEC
)

180 
£À˘
 = 
CPLD_SPIC_CS_CODEC
;

181 i‡(
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_TOUCH
)

182 
£À˘
 = 
CPLD_SPIC_CS_TOUCH
;

183 i‡(
cwrôe
) {

184 
cwrôe
 = (cwrite + 7)/8; cwrite-- > 0; ) {

185 
CPLD_SPID
 = (
v
 >> (8*
cwrôe
)) & 0xff;

186 
CPLD_SPIC
 = 
£À˘
 | 
CPLD_SPIC_LOAD
;

187 !(
CPLD_SPIC
 & 
CPLD_SPIC_LOADED
))

189 
CPLD_SPIC
 = 
£À˘
;

190 !(
CPLD_SPIC
 & 
CPLD_SPIC_DONE
))

193 
v
 = 0;

195 i‡(
¸ód
) {

196 
	`mdñay
 (2);

197 
v
 = 0;

198 
¸ód
 = (cread + 7)/8; cread-- > 0;) {

199 
CPLD_SPID
 = 0;

200 
CPLD_SPIC
 = 
£À˘
 | 
CPLD_SPIC_READ


201 | 
CPLD_SPIC_START
;

202 !(
CPLD_SPIC
 & 
CPLD_SPIC_LOADED
))

204 
CPLD_SPIC
 = 
£À˘
 | 
CPLD_SPIC_READ
;

205 !(
CPLD_SPIC
 & 
CPLD_SPIC_DONE
))

207 
v
 = (v << 8Ë| 
CPLD_SPID
;

210  
v
;

214 
	`PRINTK
 ("•i(%dË0x%04x -> 0x%x\r\n", 
s•_c⁄figuøti⁄
.
devi˚
,

215 
v
 & 0x1ff, (v >> 9) & 0x7f);

217 
	`íabÀ_cs
 ();

219 
v
 <<
CPLD_SPI_TX_SHIFT
;

220 
cwrôe
--) {

221 
CPLD_SPI


222 (
CPLD_SPI
 & ~
CPLD_SPI_TX
)

223 | ((
v
 >> 
cwrôe
Ë& 
CPLD_SPI_TX
);

224 
	`udñay
 (
T_DIS
);

225 
	`pul£_˛ock
 ();

228 i‡(
¸ód
 < 0) {

229 
dñay
 = 10;

230 
	`dißbÀ_cs
 ();

231 
	`udñay
 (1);

232 
	`íabÀ_cs
 ();

234 
l
 = -1;

236 i‡(
CPLD_SPI
 & 
CPLD_SPI_RX
) {

237 
l
 = 0;

240 } 
	`udñay
 (1), --
dñay
);

244 
¸ód
-- > 0) {

245 
	`pul£_˛ock
 ();

246 
l
 = (l<<1)

247 | (((
CPLD_SPI
 & 
CPLD_SPI_RX
)

248 >> 
CPLD_SPI_RX_SHIFT
) & 0x1);

251 
	`dißbÀ_cs
 ();

252  
l
;

253 
	}
}

255 
	$s•_öô
 ()

257 
	`•ö_lock_öô
 (&
s•_lock
);

258 
	`mem£t
 (&
s•_c⁄figuøti⁄
, 0,  (ssp_configuration));

260 
	}
}

270 
	$s•_chù_£À˘
 (
íabÀ
)

272 #i‡
	`deföed
 (
CONFIG_MACH_LPD7A400
)

273 
£À˘
;

275 i‡(
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_CODEC
)

276 
£À˘
 = 
CPLD_SPIC_CS_CODEC
;

277 i‡(
s•_c⁄figuøti⁄
.
devi˚
 =
DEVICE_TOUCH
)

278 
£À˘
 = 
CPLD_SPIC_CS_TOUCH
;

282 i‡(
íabÀ
)

283 
CPLD_SPIC
 = 
£À˘
;

285 
CPLD_SPIC
 = 0;

287 
	}
}

289 
	$s•_acquúe
 ()

291 
	`•ö_lock
 (&
s•_lock
);

292 
	}
}

294 
	$s•_ªÀa£
 ()

296 
	`s•_chù_£À˘
 (0);

297 
	`•ö_u∆ock
 (&
s•_lock
);

298 
	}
}

300 
	$s•_c⁄figuª
 (
devi˚
, 
mode
, 
•ìd
,

301 
‰ame_size_wrôe
, 
‰ame_size_ªad
)

303 
s•_c⁄figuøti⁄
.
devi˚
 = device;

304 
s•_c⁄figuøti⁄
.
mode
 = mode;

305 
s•_c⁄figuøti⁄
.
•ìd
 = speed;

306 
s•_c⁄figuøti⁄
.
‰ame_size_wrôe
 = frame_size_write;

307 
s•_c⁄figuøti⁄
.
‰ame_size_ªad
 = frame_size_read;

310 
	}
}

312 
	$s•_ªad
 ()

314  
	`execuã_•i_comm™d
 (0, 0, 
s•_c⁄figuøti⁄
.
‰ame_size_ªad
);

315 
	}
}

317 
	$s•_wrôe
 (
u16
 
d©a
)

319 
	`execuã_•i_comm™d
 (
d©a
, 
s•_c⁄figuøti⁄
.
‰ame_size_wrôe
, 0);

321 
	}
}

323 
	$s•_wrôe_ªad
 (
u16
 
d©a
)

325  
	`execuã_•i_comm™d
 (
d©a
, 
s•_c⁄figuøti⁄
.
‰ame_size_wrôe
,

326 
s•_c⁄figuøti⁄
.
‰ame_size_ªad
);

327 
	}
}

329 
s•_drivî
 
	glh7a40x_˝ld_s•_drivî
 = {

330 .
öô
 = 
s•_öô
,

331 .
	gacquúe
 = 
s•_acquúe
,

332 .
	gªÀa£
 = 
s•_ªÀa£
,

333 .
	gc⁄figuª
 = 
s•_c⁄figuª
,

334 .
	gchù_£À˘
 = 
s•_chù_£À˘
,

335 .
	gªad
 = 
s•_ªad
,

336 .
	gwrôe
 = 
s•_wrôe
,

337 .
	gwrôe_ªad
 = 
s•_wrôe_ªad
,

341 
MODULE_AUTHOR
("Marc Singer");

342 
MODULE_DESCRIPTION
("LPD7A40X CPLD SPI driver");

343 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-lh7a40x/time.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/öãºu±.h
>

14 
	~<löux/úq.h
>

15 
	~<löux/time.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/io.h
>

19 
	~<asm/úq.h
>

20 
	~<asm/Àds.h
>

22 
	~<asm/mach/time.h
>

23 
	~"comm⁄.h
"

25 #i‡
HZ
 < 100

26 
	#TIMER_CONTROL
 
TIMER_CONTROL2


	)

27 
	#TIMER_LOAD
 
TIMER_LOAD2


	)

28 
	#TIMER_CONSTANT
 (508469/
HZ
)

	)

29 
	#TIMER_MODE
 (
TIMER_C_ENABLE
 | 
TIMER_C_PERIODIC
 | 
TIMER_C_508KHZ
)

	)

30 
	#TIMER_EOI
 
TIMER_EOI2


	)

31 
	#TIMER_IRQ
 
IRQ_T2UI


	)

33 
	#TIMER_CONTROL
 
TIMER_CONTROL3


	)

34 
	#TIMER_LOAD
 
TIMER_LOAD3


	)

35 
	#TIMER_CONSTANT
 (3686400/
HZ
)

	)

36 
	#TIMER_MODE
 (
TIMER_C_ENABLE
 | 
TIMER_C_PERIODIC
)

	)

37 
	#TIMER_EOI
 
TIMER_EOI3


	)

38 
	#TIMER_IRQ
 
IRQ_T3UI


	)

41 
úqªtu∫_t


42 
	$lh7a40x_timî_öãºu±
(
úq
, *
dev_id
)

44 
	`wrôe_£qlock
(&
xtime_lock
);

46 
TIMER_EOI
 = 0;

47 
	`timî_tick
();

49 
	`wrôe_£qu∆ock
(&
xtime_lock
);

51  
IRQ_HANDLED
;

52 
	}
}

54 
úqa˘i⁄
 
	glh7a40x_timî_úq
 = {

55 .
«me
 = "LHA740x Timer Tick",

56 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

57 .
	gh™dÀr
 = 
lh7a40x_timî_öãºu±
,

60 
__öô
 
	$lh7a40x_timî_öô
 ()

63 
TIMER_CONTROL1
 = 0;

64 
TIMER_CONTROL2
 = 0;

65 
TIMER_CONTROL3
 = 0;

67 
	`£tup_úq
 (
TIMER_IRQ
, &
lh7a40x_timî_úq
);

69 
TIMER_LOAD
 = 
TIMER_CONSTANT
;

70 
TIMER_CONTROL
 = 
TIMER_MODE
;

71 
	}
}

73 
sys_timî
 
	glh7a40x_timî
 = {

74 .
öô
 = &
lh7a40x_timî_öô
,

	@arch/arm/mach-netx/fb.c

20 
	~<löux/devi˚.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/dma-m≠pög.h
>

23 
	~<löux/amba/bus.h
>

24 
	~<löux/amba/˛cd.h
>

26 
	~<asm/¨ch/√tx-ªgs.h
>

27 
	~<asm/h¨dw¨e.h
>

29 
	s˛k
 {};

31 
˛k
 
	gfb_˛k
;

33 
˛cd_∑√l
 *
	g√tx_∑√l
;

35 
	$√tx_˛cd_íabÀ
(
˛cd_fb
 *
fb
)

37 
	}
}

39 
	$√tx_˛cd_£tup
(
˛cd_fb
 *
fb
)

41 
dma_addr_t
 
dma
;

43 
fb
->
∑√l
 = 
√tx_∑√l
;

45 
fb
->fb.
s¸ìn_ba£
 = 
	`dma_Æloc_wrôecomböe
(&fb->
dev
->dev, 1024*1024,

46 &
dma
, 
GFP_KERNEL
);

47 i‡(!
fb
->fb.
s¸ìn_ba£
) {

48 
	`¥ötk
(
KERN_ERR
 "CLCD: unableÅo map framebuffer\n");

49  -
ENOMEM
;

52 
fb
->fb.
fix
.
smem_°¨t
 = 
dma
;

53 
fb
->fb.
fix
.
smem_Àn
 = 1024*1024;

56 
	}
}

58 
	$√tx_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

60  
	`dma_mm≠_wrôecomböe
(&
fb
->
dev
->dev, 
vma
,

61 
fb
->fb.
s¸ìn_ba£
,

62 
fb
->fb.
fix
.
smem_°¨t
,

63 
fb
->fb.
fix
.
smem_Àn
);

64 
	}
}

66 
	$√tx_˛cd_ªmove
(
˛cd_fb
 *
fb
)

68 
	`dma_‰ì_wrôecomböe
(&
fb
->
dev
->dev, fb->fb.
fix
.
smem_Àn
,

69 
fb
->fb.
s¸ìn_ba£
, fb->fb.
fix
.
smem_°¨t
);

70 
	}
}

72 
	$˛k_dißbÀ
(
˛k
 *clk)

74 
	}
}

76 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

79 
	}
}

81 
	$˛k_íabÀ
(
˛k
 *clk)

84 
	}
}

86 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

88  &
fb_˛k
;

89 
	}
}

91 
	$˛k_put
(
˛k
 *clk)

93 
	}
}

95 
amba_devi˚
 
	gfb_devi˚
 = {

96 .
dev
 = {

97 .
bus_id
 = "fb",

98 .
	gcohîít_dma_mask
 = ~0,

100 .
	gªs
 = {

101 .
°¨t
 = 0x00104000,

102 .
	gíd
 = 0x00104fff,

103 .
	gÊags
 = 
IORESOURCE_MEM
,

105 .
	gúq
 = { 
NETX_IRQ_LCD
, 
NO_IRQ
 },

106 .
	g≥rùhid
 = 0x10112400,

109 
	$√tx_fb_öô
(
˛cd_bﬂrd
 *
bﬂrd
, 
˛cd_∑√l
 *
∑√l
)

111 
√tx_∑√l
 = 
∑√l
;

112 
fb_devi˚
.
dev
.
∂©f‹m_d©a
 = 
bﬂrd
;

113  
	`amba_devi˚_ªgi°î
(&
fb_devi˚
, &
iomem_ªsour˚
);

114 
	}
}

	@arch/arm/mach-netx/fb.h

20 
√tx_˛cd_íabÀ
(
˛cd_fb
 *
fb
);

21 
√tx_˛cd_£tup
(
˛cd_fb
 *
fb
);

22 
√tx_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
);

23 
√tx_˛cd_ªmove
(
˛cd_fb
 *
fb
);

24 
√tx_fb_öô
(
˛cd_bﬂrd
 *
bﬂrd
, 
˛cd_∑√l
 *
∑√l
);

	@arch/arm/mach-netx/generic.c

20 
	~<löux/devi˚.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/mach/m≠.h
>

27 
	~<asm/h¨dw¨e/vic.h
>

28 
	~<asm/io.h
>

29 
	~<asm/¨ch/√tx-ªgs.h
>

30 
	~<asm/mach/úq.h
>

32 
m≠_desc
 
	g√tx_io_desc
[] 
	g__öôd©a
 = {

34 .
vútuÆ
 = 
NETX_IO_VIRT
,

35 .
	gp‚
 = 
__phys_to_p‚
(
NETX_IO_PHYS
),

36 .
	gÀngth
 = 
NETX_IO_SIZE
,

37 .
	gty≥
 = 
MT_DEVICE


41 
__öô
 
	$√tx_m≠_io
()

43 
	`iŸabÀ_öô
(
√tx_io_desc
, 
	`ARRAY_SIZE
(netx_io_desc));

44 
	}
}

46 
ªsour˚
 
	g√tx_πc_ªsour˚s
[] = {

48 .
°¨t
 = 0x00101200,

49 .
	gíd
 = 0x00101220,

50 .
	gÊags
 = 
IORESOURCE_MEM
,

54 
∂©f‹m_devi˚
 
	g√tx_πc_devi˚
 = {

55 .
«me
 = "netx-rtc",

56 .
	gid
 = 0,

57 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_πc_ªsour˚s
),

58 .
	gªsour˚
 = 
√tx_πc_ªsour˚s
,

61 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

62 &
√tx_πc_devi˚
,

66 
	#DEBUG_IRQ
(
fmt
...Ë
	`¥ötk
(fmt)

	)

68 
	#DEBUG_IRQ
(
fmt
...Ë0Ë{}

	)

72 
	$√tx_hif_demux_h™dÀr
(
úq_unu£d
, 
úq_desc
 *
desc
)

74 
úq
 = 
	`NETX_IRQ_HIF_CHAINED
(0);

75 
°©
;

77 
°©
 = ((
	`ªadl
(
NETX_DPMAS_INT_EN
) &

78 
	`ªadl
(
NETX_DPMAS_INT_STAT
)) >> 24) & 0x1f;

80 
desc
 = 
úq_desc
 + 
	`NETX_IRQ_HIF_CHAINED
(0);

82 
°©
) {

83 i‡(
°©
 & 1) {

84 
	`DEBUG_IRQ
("h™dlög irq %d\n", 
úq
);

85 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

87 
úq
++;

88 
desc
++;

89 
°©
 >>= 1;

91 
	}
}

94 
	$√tx_hif_úq_ty≥
(
_úq
, 
ty≥
)

96 
vÆ
, 
úq
;

98 
vÆ
 = 
	`ªadl
(
NETX_DPMAS_IF_CONF1
);

100 
úq
 = 
_úq
 - 
	`NETX_IRQ_HIF_CHAINED
(0);

102 i‡(
ty≥
 & 
__IRQT_RISEDGE
) {

103 
	`DEBUG_IRQ
("risingÉdges\n");

104 
vÆ
 |(1 << 26Ë<< 
úq
;

106 i‡(
ty≥
 & 
__IRQT_FALEDGE
) {

107 
	`DEBUG_IRQ
("fallingÉdges\n");

108 
vÆ
 &~((1 << 26Ë<< 
úq
);

110 i‡(
ty≥
 & 
__IRQT_LOWLVL
) {

111 
	`DEBUG_IRQ
("lowÜevel\n");

112 
vÆ
 &~((1 << 26Ë<< 
úq
);

114 i‡(
ty≥
 & 
__IRQT_HIGHLVL
) {

115 
	`DEBUG_IRQ
("highÜevel\n");

116 
vÆ
 |(1 << 26Ë<< 
úq
;

119 
	`wrôñ
(
vÆ
, 
NETX_DPMAS_IF_CONF1
);

122 
	}
}

125 
	$√tx_hif_ack_úq
(
_úq
)

127 
vÆ
, 
úq
;

129 
úq
 = 
_úq
 - 
	`NETX_IRQ_HIF_CHAINED
(0);

130 
	`wrôñ
((1 << 24Ë<< 
úq
, 
NETX_DPMAS_INT_STAT
);

132 
vÆ
 = 
	`ªadl
(
NETX_DPMAS_INT_EN
);

133 
vÆ
 &~((1 << 24Ë<< 
úq
);

134 
	`wrôñ
(
vÆ
, 
NETX_DPMAS_INT_EN
);

136 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
_úq
);

137 
	}
}

140 
	$√tx_hif_mask_úq
(
_úq
)

142 
vÆ
, 
úq
;

144 
úq
 = 
_úq
 - 
	`NETX_IRQ_HIF_CHAINED
(0);

145 
vÆ
 = 
	`ªadl
(
NETX_DPMAS_INT_EN
);

146 
vÆ
 &~((1 << 24Ë<< 
úq
);

147 
	`wrôñ
(
vÆ
, 
NETX_DPMAS_INT_EN
);

148 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
_úq
);

149 
	}
}

152 
	$√tx_hif_unmask_úq
(
_úq
)

154 
vÆ
, 
úq
;

156 
úq
 = 
_úq
 - 
	`NETX_IRQ_HIF_CHAINED
(0);

157 
vÆ
 = 
	`ªadl
(
NETX_DPMAS_INT_EN
);

158 
vÆ
 |(1 << 24Ë<< 
úq
;

159 
	`wrôñ
(
vÆ
, 
NETX_DPMAS_INT_EN
);

160 
	`DEBUG_IRQ
("%s: irq %d\n", 
__FUNCTION__
, 
_úq
);

161 
	}
}

163 
úq_chù
 
	g√tx_hif_chù
 = {

164 .
ack
 = 
√tx_hif_ack_úq
,

165 .
	gmask
 = 
√tx_hif_mask_úq
,

166 .
	gunmask
 = 
√tx_hif_unmask_úq
,

167 .
	g£t_ty≥
 = 
√tx_hif_úq_ty≥
,

170 
__öô
 
	$√tx_öô_úq
()

172 
úq
;

174 
	`vic_öô
(
	`__io
(
	`io_p2v
(
NETX_PA_VIC
)), 0, ~0);

176 
úq
 = 
	`NETX_IRQ_HIF_CHAINED
(0); irq <
NETX_IRQ_HIF_LAST
; irq++) {

177 
	`£t_úq_chù
(
úq
, &
√tx_hif_chù
);

178 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

179 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

182 
	`wrôñ
(
NETX_DPMAS_INT_EN_GLB_EN
, 
NETX_DPMAS_INT_EN
);

183 
	`£t_úq_chaöed_h™dÀr
(
NETX_IRQ_HIF
, 
√tx_hif_demux_h™dÀr
);

184 
	}
}

186 
__öô
 
	$√tx_öô
()

188  
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

189 
	}
}

191 
subsys_öôˇŒ
(
√tx_öô
);

	@arch/arm/mach-netx/generic.h

20 
__öô
 
√tx_m≠_io
();

21 
__öô
 
√tx_öô_úq
();

23 
	gsys_timî
;

24 
sys_timî
 
√tx_timî
;

	@arch/arm/mach-netx/nxdb500.c

20 
	~<löux/dma-m≠pög.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/mtd/∂©-øm.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/amba/bus.h
>

26 
	~<löux/amba/˛cd.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/mach/¨ch.h
>

31 
	~<asm/¨ch/√tx-ªgs.h
>

32 
	~<asm/¨ch/ëh.h
>

34 
	~"gíîic.h
"

35 
	~"fb.h
"

37 
˛cd_∑√l
 
	gqvga
 = {

38 .
mode
 = {

39 .
«me
 = "QVGA",

40 .
	gª‰esh
 = 60,

41 .
	gxªs
 = 240,

42 .
	gyªs
 = 320,

43 .
	gpix˛ock
 = 187617,

44 .
	gÀ·_m¨gö
 = 6,

45 .
	gright_m¨gö
 = 26,

46 .
	guµî_m¨gö
 = 0,

47 .
	glowî_m¨gö
 = 6,

48 .
	ghsync_Àn
 = 6,

49 .
	gvsync_Àn
 = 1,

50 .
	gsync
 = 0,

51 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

53 .
	gwidth
 = -1,

54 .
	gheight
 = -1,

55 .
	gtim2
 = 16,

56 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_BGR
,

57 .
	gbµ
 = 16,

58 .
	ggøysˇÀ
 = 0,

61 
ölöe
 
	$nxdb500_check
(
˛cd_fb
 *
fb
, 
fb_v¨_s¸ìnöfo
 *
v¨
)

63 
v¨
->
gªí
.
Àngth
 = 5;

64 
v¨
->
gªí
.
msb_right
 = 0;

66  
	`˛cdfb_check
(
fb
, 
v¨
);

67 
	}
}

69 
	$nxdb500_˛cd_£tup
(
˛cd_fb
 *
fb
)

71 
vÆ
;

73 
fb
->fb.
v¨
.
gªí
.
Àngth
 = 5;

74 
fb
->fb.
v¨
.
gªí
.
msb_right
 = 0;

77 
vÆ
 = 
	`ªadl
(
NETX_SYSTEM_IOC_ACCESS_KEY
);

78 
	`wrôñ
(
vÆ
, 
NETX_SYSTEM_IOC_ACCESS_KEY
);

80 
	`wrôñ
(3, 
NETX_SYSTEM_IOC_CR
);

82 
vÆ
 = 
	`ªadl
(
NETX_PIO_OUTPIO
);

83 
	`wrôñ
(
vÆ
 | 1, 
NETX_PIO_OUTPIO
);

85 
vÆ
 = 
	`ªadl
(
NETX_PIO_OEPIO
);

86 
	`wrôñ
(
vÆ
 | 1, 
NETX_PIO_OEPIO
);

87  
	`√tx_˛cd_£tup
(
fb
);

88 
	}
}

90 
˛cd_bﬂrd
 
	g˛cd_d©a
 = {

91 .
«me
 = "netX",

92 .
	gcheck
 = 
nxdb500_check
,

93 .
	gdecode
 = 
˛cdfb_decode
,

94 .
	gíabÀ
 = 
√tx_˛cd_íabÀ
,

95 .
	g£tup
 = 
nxdb500_˛cd_£tup
,

96 .
	gmm≠
 = 
√tx_˛cd_mm≠
,

97 .
	gªmove
 = 
√tx_˛cd_ªmove
,

100 
√txëh_∂©f‹m_d©a
 
	gëh0_∂©f‹m_d©a
 = {

101 .
x˙o
 = 0,

104 
∂©f‹m_devi˚
 
	g√tx_ëh0_devi˚
 = {

105 .
«me
 = "netx-eth",

106 .
	gid
 = 0,

107 .
	gnum_ªsour˚s
 = 0,

108 .
	gªsour˚
 = 
NULL
,

109 .
	gdev
 = {

110 .
∂©f‹m_d©a
 = &
ëh0_∂©f‹m_d©a
,

114 
√txëh_∂©f‹m_d©a
 
	gëh1_∂©f‹m_d©a
 = {

115 .
x˙o
 = 1,

118 
∂©f‹m_devi˚
 
	g√tx_ëh1_devi˚
 = {

119 .
«me
 = "netx-eth",

120 .
	gid
 = 1,

121 .
	gnum_ªsour˚s
 = 0,

122 .
	gªsour˚
 = 
NULL
,

123 .
	gdev
 = {

124 .
∂©f‹m_d©a
 = &
ëh1_∂©f‹m_d©a
,

128 
ªsour˚
 
	g√tx_u¨t0_ªsour˚s
[] = {

130 .
°¨t
 = 0x00100A00,

131 .
	gíd
 = 0x00100A3F,

132 .
	gÊags
 = 
IORESOURCE_MEM
,

135 .
°¨t
 = (
NETX_IRQ_UART0
),

136 .
	gíd
 = (
NETX_IRQ_UART0
),

137 .
	gÊags
 = 
IORESOURCE_IRQ
,

141 
∂©f‹m_devi˚
 
	g√tx_u¨t0_devi˚
 = {

142 .
«me
 = "netx-uart",

143 .
	gid
 = 0,

144 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_u¨t0_ªsour˚s
),

145 .
	gªsour˚
 = 
√tx_u¨t0_ªsour˚s
,

148 
ªsour˚
 
	g√tx_u¨t1_ªsour˚s
[] = {

150 .
°¨t
 = 0x00100A40,

151 .
	gíd
 = 0x00100A7F,

152 .
	gÊags
 = 
IORESOURCE_MEM
,

155 .
°¨t
 = (
NETX_IRQ_UART1
),

156 .
	gíd
 = (
NETX_IRQ_UART1
),

157 .
	gÊags
 = 
IORESOURCE_IRQ
,

161 
∂©f‹m_devi˚
 
	g√tx_u¨t1_devi˚
 = {

162 .
«me
 = "netx-uart",

163 .
	gid
 = 1,

164 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_u¨t1_ªsour˚s
),

165 .
	gªsour˚
 = 
√tx_u¨t1_ªsour˚s
,

168 
ªsour˚
 
	g√tx_u¨t2_ªsour˚s
[] = {

170 .
°¨t
 = 0x00100A80,

171 .
	gíd
 = 0x00100ABF,

172 .
	gÊags
 = 
IORESOURCE_MEM
,

175 .
°¨t
 = (
NETX_IRQ_UART2
),

176 .
	gíd
 = (
NETX_IRQ_UART2
),

177 .
	gÊags
 = 
IORESOURCE_IRQ
,

181 
∂©f‹m_devi˚
 
	g√tx_u¨t2_devi˚
 = {

182 .
«me
 = "netx-uart",

183 .
	gid
 = 2,

184 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_u¨t2_ªsour˚s
),

185 .
	gªsour˚
 = 
√tx_u¨t2_ªsour˚s
,

188 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

189 &
√tx_ëh0_devi˚
,

190 &
√tx_ëh1_devi˚
,

191 &
√tx_u¨t0_devi˚
,

192 &
√tx_u¨t1_devi˚
,

193 &
√tx_u¨t2_devi˚
,

196 
__öô
 
	$nxdb500_öô
()

198 
	`√tx_fb_öô
(&
˛cd_d©a
, &
qvga
);

199 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

200 
	}
}

202 
MACHINE_START
(
NXDB500
, "HilscherÇxdb500")

203 .
	gphys_io
 = 0x00100000,

204 .
	gio_pg_off°
 = (
io_p2v
(0x00100000) >> 18) & 0xfffc,

205 .
	gboŸ_∑øms
 = 0x80000100,

206 .
	gm≠_io
 = 
√tx_m≠_io
,

207 .
	göô_úq
 = 
√tx_öô_úq
,

208 .
	gtimî
 = &
√tx_timî
,

209 .
	göô_machöe
 = 
nxdb500_öô
,

210 
	gMACHINE_END


	@arch/arm/mach-netx/nxdkn.c

20 
	~<löux/dma-m≠pög.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/mtd/∂©-øm.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/amba/bus.h
>

26 
	~<löux/amba/˛cd.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/mach/¨ch.h
>

31 
	~<asm/¨ch/√tx-ªgs.h
>

32 
	~<asm/¨ch/ëh.h
>

34 
	~"gíîic.h
"

36 
√txëh_∂©f‹m_d©a
 
	gëh0_∂©f‹m_d©a
 = {

37 .
x˙o
 = 0,

40 
∂©f‹m_devi˚
 
	gnxdkn_ëh0_devi˚
 = {

41 .
«me
 = "netx-eth",

42 .
	gid
 = 0,

43 .
	gnum_ªsour˚s
 = 0,

44 .
	gªsour˚
 = 
NULL
,

45 .
	gdev
 = {

46 .
∂©f‹m_d©a
 = &
ëh0_∂©f‹m_d©a
,

50 
√txëh_∂©f‹m_d©a
 
	gëh1_∂©f‹m_d©a
 = {

51 .
x˙o
 = 1,

54 
∂©f‹m_devi˚
 
	gnxdkn_ëh1_devi˚
 = {

55 .
«me
 = "netx-eth",

56 .
	gid
 = 1,

57 .
	gnum_ªsour˚s
 = 0,

58 .
	gªsour˚
 = 
NULL
,

59 .
	gdev
 = {

60 .
∂©f‹m_d©a
 = &
ëh1_∂©f‹m_d©a
,

64 
ªsour˚
 
	g√tx_u¨t0_ªsour˚s
[] = {

66 .
°¨t
 = 0x00100A00,

67 .
	gíd
 = 0x00100A3F,

68 .
	gÊags
 = 
IORESOURCE_MEM
,

71 .
°¨t
 = (
NETX_IRQ_UART0
),

72 .
	gíd
 = (
NETX_IRQ_UART0
),

73 .
	gÊags
 = 
IORESOURCE_IRQ
,

77 
∂©f‹m_devi˚
 
	g√tx_u¨t0_devi˚
 = {

78 .
«me
 = "netx-uart",

79 .
	gid
 = 0,

80 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_u¨t0_ªsour˚s
),

81 .
	gªsour˚
 = 
√tx_u¨t0_ªsour˚s
,

84 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

85 &
nxdkn_ëh0_devi˚
,

86 &
nxdkn_ëh1_devi˚
,

87 &
√tx_u¨t0_devi˚
,

90 
__öô
 
	$nxdkn_öô
()

92 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

93 
	}
}

95 
MACHINE_START
(
NXDKN
, "HilscherÇxdkn")

96 .
	gphys_io
 = 0x00100000,

97 .
	gio_pg_off°
 = (
io_p2v
(0x00100000) >> 18) & 0xfffc,

98 .
	gboŸ_∑øms
 = 0x80000100,

99 .
	gm≠_io
 = 
√tx_m≠_io
,

100 .
	göô_úq
 = 
√tx_öô_úq
,

101 .
	gtimî
 = &
√tx_timî
,

102 .
	göô_machöe
 = 
nxdkn_öô
,

103 
	gMACHINE_END


	@arch/arm/mach-netx/nxeb500hmi.c

20 
	~<löux/dma-m≠pög.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/öãºu±.h
>

23 
	~<löux/mtd/∂©-øm.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/amba/bus.h
>

26 
	~<löux/amba/˛cd.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/mach/¨ch.h
>

31 
	~<asm/¨ch/√tx-ªgs.h
>

32 
	~<asm/¨ch/ëh.h
>

34 
	~"gíîic.h
"

35 
	~"fb.h
"

37 
˛cd_∑√l
 
	gqvga
 = {

38 .
mode
 = {

39 .
«me
 = "QVGA",

40 .
	gª‰esh
 = 60,

41 .
	gxªs
 = 240,

42 .
	gyªs
 = 320,

43 .
	gpix˛ock
 = 187617,

44 .
	gÀ·_m¨gö
 = 6,

45 .
	gright_m¨gö
 = 26,

46 .
	guµî_m¨gö
 = 0,

47 .
	glowî_m¨gö
 = 6,

48 .
	ghsync_Àn
 = 6,

49 .
	gvsync_Àn
 = 1,

50 .
	gsync
 = 0,

51 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

53 .
	gwidth
 = -1,

54 .
	gheight
 = -1,

55 .
	gtim2
 = 16,

56 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_BGR
,

57 .
	gbµ
 = 16,

58 .
	ggøysˇÀ
 = 0,

61 
ölöe
 
	$nxeb500hmi_check
(
˛cd_fb
 *
fb
, 
fb_v¨_s¸ìnöfo
 *
v¨
)

63 
v¨
->
gªí
.
Àngth
 = 5;

64 
v¨
->
gªí
.
msb_right
 = 0;

66  
	`˛cdfb_check
(
fb
, 
v¨
);

67 
	}
}

69 
	$nxeb500hmi_˛cd_£tup
(
˛cd_fb
 *
fb
)

71 
vÆ
;

73 
fb
->fb.
v¨
.
gªí
.
Àngth
 = 5;

74 
fb
->fb.
v¨
.
gªí
.
msb_right
 = 0;

77 
vÆ
 = 
	`ªadl
(
NETX_SYSTEM_IOC_ACCESS_KEY
);

78 
	`wrôñ
(
vÆ
, 
NETX_SYSTEM_IOC_ACCESS_KEY
);

80 
	`wrôñ
(3, 
NETX_SYSTEM_IOC_CR
);

83 
	`wrôñ
(9, 
	`NETX_GPIO_CFG
(14));

85 
vÆ
 = 
	`ªadl
(
NETX_PIO_OUTPIO
);

86 
	`wrôñ
(
vÆ
 | 1, 
NETX_PIO_OUTPIO
);

88 
vÆ
 = 
	`ªadl
(
NETX_PIO_OEPIO
);

89 
	`wrôñ
(
vÆ
 | 1, 
NETX_PIO_OEPIO
);

90  
	`√tx_˛cd_£tup
(
fb
);

91 
	}
}

93 
˛cd_bﬂrd
 
	g˛cd_d©a
 = {

94 .
«me
 = "netX",

95 .
	gcheck
 = 
nxeb500hmi_check
,

96 .
	gdecode
 = 
˛cdfb_decode
,

97 .
	gíabÀ
 = 
√tx_˛cd_íabÀ
,

98 .
	g£tup
 = 
nxeb500hmi_˛cd_£tup
,

99 .
	gmm≠
 = 
√tx_˛cd_mm≠
,

100 .
	gªmove
 = 
√tx_˛cd_ªmove
,

103 
√txëh_∂©f‹m_d©a
 
	gëh0_∂©f‹m_d©a
 = {

104 .
x˙o
 = 0,

107 
∂©f‹m_devi˚
 
	g√tx_ëh0_devi˚
 = {

108 .
«me
 = "netx-eth",

109 .
	gid
 = 0,

110 .
	gnum_ªsour˚s
 = 0,

111 .
	gªsour˚
 = 
NULL
,

112 .
	gdev
 = {

113 .
∂©f‹m_d©a
 = &
ëh0_∂©f‹m_d©a
,

117 
√txëh_∂©f‹m_d©a
 
	gëh1_∂©f‹m_d©a
 = {

118 .
x˙o
 = 1,

121 
∂©f‹m_devi˚
 
	g√tx_ëh1_devi˚
 = {

122 .
«me
 = "netx-eth",

123 .
	gid
 = 1,

124 .
	gnum_ªsour˚s
 = 0,

125 .
	gªsour˚
 = 
NULL
,

126 .
	gdev
 = {

127 .
∂©f‹m_d©a
 = &
ëh1_∂©f‹m_d©a
,

131 
ªsour˚
 
	g√tx_cf_ªsour˚s
[] = {

133 .
°¨t
 = 0x20000000,

134 .
	gíd
 = 0x25ffffff,

135 .
	gÊags
 = 
IORESOURCE_MEM
 | 
IORESOURCE_MEM_8AND16BIT
,

139 
∂©f‹m_devi˚
 
	g√tx_cf_devi˚
 = {

140 .
«me
 = "netx-cf",

141 .
	gid
 = 0,

142 .
	gªsour˚
 = 
√tx_cf_ªsour˚s
,

143 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_cf_ªsour˚s
),

146 
ªsour˚
 
	g√tx_u¨t0_ªsour˚s
[] = {

148 .
°¨t
 = 0x00100A00,

149 .
	gíd
 = 0x00100A3F,

150 .
	gÊags
 = 
IORESOURCE_MEM
,

153 .
°¨t
 = (
NETX_IRQ_UART0
),

154 .
	gíd
 = (
NETX_IRQ_UART0
),

155 .
	gÊags
 = 
IORESOURCE_IRQ
,

159 
∂©f‹m_devi˚
 
	g√tx_u¨t0_devi˚
 = {

160 .
«me
 = "netx-uart",

161 .
	gid
 = 0,

162 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
√tx_u¨t0_ªsour˚s
),

163 .
	gªsour˚
 = 
√tx_u¨t0_ªsour˚s
,

166 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

167 &
√tx_ëh0_devi˚
,

168 &
√tx_ëh1_devi˚
,

169 &
√tx_cf_devi˚
,

170 &
√tx_u¨t0_devi˚
,

173 
__öô
 
	$nxeb500hmi_öô
()

175 
	`√tx_fb_öô
(&
˛cd_d©a
, &
qvga
);

176 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

177 
	}
}

179 
MACHINE_START
(
NXEB500HMI
, "HilscherÇxeb500hmi")

180 .
	gphys_io
 = 0x00100000,

181 .
	gio_pg_off°
 = (
io_p2v
(0x00100000) >> 18) & 0xfffc,

182 .
	gboŸ_∑øms
 = 0x80000100,

183 .
	gm≠_io
 = 
√tx_m≠_io
,

184 .
	göô_úq
 = 
√tx_öô_úq
,

185 .
	gtimî
 = &
√tx_timî
,

186 .
	göô_machöe
 = 
nxeb500hmi_öô
,

187 
	gMACHINE_END


	@arch/arm/mach-netx/pfifo.c

20 
	~<löux/öô.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/muãx.h
>

24 
	~<asm/io.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/¨ch/√tx-ªgs.h
>

27 
	~<asm/¨ch/pfifo.h
>

29 
DEFINE_MUTEX
(
pfifo_lock
);

31 
	gpfifo_u£d
 = 0;

33 
	$pfifo_ªque°
(
pfifo_mask
)

35 
îr
 = 0;

36 
vÆ
;

38 
	`muãx_lock
(&
pfifo_lock
);

40 i‡(
pfifo_mask
 & 
pfifo_u£d
) {

41 
îr
 = -
EBUSY
;

42 
out
;

45 
pfifo_u£d
 |
pfifo_mask
;

47 
vÆ
 = 
	`ªadl
(
NETX_PFIFO_RESET
);

48 
	`wrôñ
(
vÆ
 | 
pfifo_mask
, 
NETX_PFIFO_RESET
);

49 
	`wrôñ
(
vÆ
, 
NETX_PFIFO_RESET
);

51 
out
:

52 
	`muãx_u∆ock
(&
pfifo_lock
);

53  
îr
;

54 
	}
}

56 
	$pfifo_‰ì
(
pfifo_mask
)

58 
	`muãx_lock
(&
pfifo_lock
);

59 
pfifo_u£d
 &~
pfifo_mask
;

60 
	`muãx_u∆ock
(&
pfifo_lock
);

61 
	}
}

63 
EXPORT_SYMBOL
(
pfifo_push
);

64 
EXPORT_SYMBOL
(
pfifo_p›
);

65 
EXPORT_SYMBOL
(
pfifo_fûl_Àvñ
);

66 
EXPORT_SYMBOL
(
pfifo_em±y
);

67 
EXPORT_SYMBOL
(
pfifo_ªque°
);

68 
EXPORT_SYMBOL
(
pfifo_‰ì
);

	@arch/arm/mach-netx/time.c

20 
	~<löux/öô.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/úq.h
>

23 
	~<löux/˛ocksour˚.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/mach/time.h
>

28 
	~<asm/¨ch/√tx-ªgs.h
>

33 
úqªtu∫_t


34 
	$√tx_timî_öãºu±
(
úq
, *
dev_id
)

36 
	`wrôe_£qlock
(&
xtime_lock
);

38 
	`timî_tick
();

40 
	`wrôe_£qu∆ock
(&
xtime_lock
);

43 
	`wrôñ
(
	`COUNTER_BIT
(0), 
NETX_GPIO_IRQ
);

45  
IRQ_HANDLED
;

46 
	}
}

48 
úqa˘i⁄
 
	g√tx_timî_úq
 = {

49 .
«me
 = "NetX Timer Tick",

50 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

51 .
	gh™dÀr
 = 
√tx_timî_öãºu±
,

54 
cy˛e_t
 
	$√tx_gë_cy˛es
()

56  
	`ªadl
(
	`NETX_GPIO_COUNTER_CURRENT
(1));

57 
	}
}

59 
˛ocksour˚
 
	g˛ocksour˚_√tx
 = {

60 .
«me
 = "netx_timer",

61 .
	gøtög
 = 200,

62 .
	gªad
 = 
√tx_gë_cy˛es
,

63 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

64 .
	gshi·
 = 20,

65 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

71 
__öô
 
	$√tx_timî_öô
()

74 
	`wrôñ
(0, 
	`NETX_GPIO_COUNTER_CTRL
(0));

77 
	`wrôñ
(0, 
	`NETX_GPIO_COUNTER_CURRENT
(0));

79 
	`wrôñ
(
LATCH
, 
	`NETX_GPIO_COUNTER_MAX
(0));

82 
	`wrôñ
(
	`COUNTER_BIT
(0), 
NETX_GPIO_IRQ
);

85 
	`wrôñ
(
	`COUNTER_BIT
(0), 
NETX_GPIO_IRQ_ENABLE
);

86 
	`wrôñ
(
NETX_GPIO_COUNTER_CTRL_IRQ_EN
 | 
NETX_GPIO_COUNTER_CTRL_RUN
,

87 
	`NETX_GPIO_COUNTER_CTRL
(0));

89 
	`£tup_úq
(
NETX_IRQ_TIMER0
, &
√tx_timî_úq
);

92 
	`wrôñ
(0, 
	`NETX_GPIO_COUNTER_CTRL
(1));

93 
	`wrôñ
(0, 
	`NETX_GPIO_COUNTER_CURRENT
(1));

94 
	`wrôñ
(0xFFFFFFFF, 
	`NETX_GPIO_COUNTER_MAX
(1));

96 
	`wrôñ
(
NETX_GPIO_COUNTER_CTRL_RUN
,

97 
	`NETX_GPIO_COUNTER_CTRL
(1));

99 
˛ocksour˚_√tx
.
mu…
 =

100 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
, 
˛ocksour˚_√tx
.
shi·
);

101 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_√tx
);

102 
	}
}

104 
sys_timî
 
	g√tx_timî
 = {

105 .
öô
 = 
√tx_timî_öô
,

	@arch/arm/mach-netx/xc.c

20 
	~<löux/öô.h
>

21 
	~<löux/devi˚.h
>

22 
	~<löux/fúmw¨e.h
>

23 
	~<löux/muãx.h
>

25 
	~<asm/io.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/¨ch/√tx-ªgs.h
>

29 
	~<asm/¨ch/xc.h
>

31 
DEFINE_MUTEX
(
xc_lock
);

33 
	gxc_ö_u£
 = 0;

35 
	sfw_desc
 {

36 
	mofs
;

37 
	msize
;

38 
	m∑tch_ofs
;

39 
	m∑tch_íåõs
;

42 
	sfw_hódî
 {

43 
	mmagic
;

44 
	mty≥
;

45 
	mvîsi⁄
;

46 
	mª£rved
[5];

47 
fw_desc
 
	mfw_desc
[3];

48 } 
__©åibuã__
 ((
∑cked
));

50 
	$xc_°›
(
xc
 *
x
)

52 
	`wrôñ
(
RPU_HOLD_PC
, 
x
->
xmac_ba£
 + 
NETX_XMAC_RPU_HOLD_PC_OFS
);

53 
	`wrôñ
(
TPU_HOLD_PC
, 
x
->
xmac_ba£
 + 
NETX_XMAC_TPU_HOLD_PC_OFS
);

54 
	`wrôñ
(
XPU_HOLD_PC
, 
x
->
x≥c_ba£
 + 
NETX_XPEC_XPU_HOLD_PC_OFS
);

56 
	}
}

58 
	$xc_°¨t
(
xc
 *
x
)

60 
	`wrôñ
(0, 
x
->
xmac_ba£
 + 
NETX_XMAC_RPU_HOLD_PC_OFS
);

61 
	`wrôñ
(0, 
x
->
xmac_ba£
 + 
NETX_XMAC_TPU_HOLD_PC_OFS
);

62 
	`wrôñ
(0, 
x
->
x≥c_ba£
 + 
NETX_XPEC_XPU_HOLD_PC_OFS
);

64 
	}
}

66 
	$xc_ru¬ög
(
xc
 *
x
)

68  (
	`ªadl
(
x
->
xmac_ba£
 + 
NETX_XMAC_RPU_HOLD_PC_OFS
Ë& 
RPU_HOLD_PC
)

69 || (
	`ªadl
(
x
->
xmac_ba£
 + 
NETX_XMAC_TPU_HOLD_PC_OFS
Ë& 
TPU_HOLD_PC
)

70 || (
	`ªadl
(
x
->
x≥c_ba£
 + 
NETX_XPEC_XPU_HOLD_PC_OFS
Ë& 
XPU_HOLD_PC
) ?

72 
	}
}

74 
	$xc_ª£t
(
xc
 *
x
)

76 
	`wrôñ
(0, 
x
->
x≥c_ba£
 + 
NETX_XPEC_PC_OFS
);

78 
	}
}

80 
	$xc_check_±r
(
xc
 *
x
, 
adr
, 
size
)

82 i‡(
adr
 >
	`NETX_PA_XMAC
(
x
->
no
) &&

83 
adr
 + 
size
 < 
	`NETX_PA_XMAC
(
x
->
no
Ë+ 
XMAC_MEM_SIZE
)

86 i‡(
adr
 >
	`NETX_PA_XPEC
(
x
->
no
) &&

87 
adr
 + 
size
 < 
	`NETX_PA_XPEC
(
x
->
no
Ë+ 
XPEC_MEM_SIZE
)

90 
	`dev_îr
(
x
->
dev
, "IllegalÖointer in firmware found.áborting\n");

93 
	}
}

95 
	$xc_∑tch
(
xc
 *
x
, *
∑tch
, 
cou¡
)

97 
vÆ
, 
adr
;

98 *
d©a
 = 
∑tch
;

100 
i
;

101 
i
 = 0; i < 
cou¡
; i++) {

102 
adr
 = *
d©a
++;

103 
vÆ
 = *
d©a
++;

104 i‡(
	`xc_check_±r
(
x
, 
adr
, 4) < 0)

105  -
EINVAL
;

107 
	`wrôñ
(
vÆ
, (
__iomem
 *)
	`io_p2v
(
adr
));

110 
	}
}

112 
	$xc_ªque°_fúmw¨e
(
xc
 *
x
)

114 
ªt
;

115 
«me
[16];

116 c⁄° 
fúmw¨e
 *
fw
;

117 
fw_hódî
 *
hód
;

118 
size
;

119 
i
;

120 *
§c
;

121 
d°
;

123 
	`•rötf
(
«me
, "xc%d.bö", 
x
->
no
);

125 
ªt
 = 
	`ªque°_fúmw¨e
(&
fw
, 
«me
, 
x
->
dev
);

127 i‡(
ªt
 < 0) {

128 
	`dev_îr
(
x
->
dev
, "request_firmware failed\n");

129  
ªt
;

132 
hód
 = (
fw_hódî
 *)
fw
->
d©a
;

133 i‡(
hód
->
magic
 != 0x4e657458) {

134 i‡(
hód
->
magic
 == 0x5874654e) {

135 
	`dev_îr
(
x
->
dev
,

137 
ªt
 = -
ENODEV
;

138 
exô_ªÀa£_fúmw¨e
;

140 
	`dev_îr
(
x
->
dev
, "unrecognized firmware magic 0x%08x\n",

141 
hód
->
magic
);

142 
ªt
 = -
ENODEV
;

143 
exô_ªÀa£_fúmw¨e
;

146 
x
->
ty≥
 = 
hód
->type;

147 
x
->
vîsi⁄
 = 
hód
->version;

149 
ªt
 = -
EINVAL
;

151 
i
 = 0; i < 3; i++) {

152 
§c
 = 
fw
->
d©a
 + 
hód
->
fw_desc
[
i
].
ofs
;

153 
d°
 = *(*)
§c
;

154 
§c
 +=  ();

155 
size
 = 
hód
->
fw_desc
[
i
].size -  ();

157 i‡(
	`xc_check_±r
(
x
, 
d°
, 
size
))

158 
exô_ªÀa£_fúmw¨e
;

160 
	`mem˝y
((*)
	`io_p2v
(
d°
), 
§c
, 
size
);

162 
§c
 = 
fw
->
d©a
 + 
hód
->
fw_desc
[
i
].
∑tch_ofs
;

163 
size
 = 
hód
->
fw_desc
[
i
].
∑tch_íåõs
;

164 
ªt
 = 
	`xc_∑tch
(
x
, 
§c
, 
size
);

165 i‡(
ªt
 < 0)

166 
exô_ªÀa£_fúmw¨e
;

169 
ªt
 = 0;

171 
exô_ªÀa£_fúmw¨e
:

172 
	`ªÀa£_fúmw¨e
(
fw
);

174  
ªt
;

175 
	}
}

177 
xc
 *
	$ªque°_xc
(
x˙o
, 
devi˚
 *
dev
)

179 
xc
 *
x
 = 
NULL
;

181 
	`muãx_lock
(&
xc_lock
);

183 i‡(
x˙o
 > 3)

184 
exô
;

185 i‡(
xc_ö_u£
 & (1 << 
x˙o
))

186 
exô
;

188 
x
 = 
	`kmÆloc
( (
xc
), 
GFP_KERNEL
);

189 i‡(!
x
)

190 
exô
;

192 i‡(!
ªque°_mem_ªgi⁄


193 (
	`NETX_PA_XPEC
(
x˙o
), 
XPEC_MEM_SIZE
, 
dev
->
kobj
.
«me
))

194 
exô_‰ì
;

196 i‡(!
ªque°_mem_ªgi⁄


197 (
	`NETX_PA_XMAC
(
x˙o
), 
XMAC_MEM_SIZE
, 
dev
->
kobj
.
«me
))

198 
exô_ªÀa£_1
;

200 i‡(!
ªque°_mem_ªgi⁄


201 (
	`SRAM_INTERNAL_PHYS
(
x˙o
), 
SRAM_MEM_SIZE
, 
dev
->
kobj
.
«me
))

202 
exô_ªÀa£_2
;

204 
x
->
x≥c_ba£
 = (* 
__iomem
)
	`io_p2v
(
	`NETX_PA_XPEC
(
x˙o
));

205 
x
->
xmac_ba£
 = (* 
__iomem
)
	`io_p2v
(
	`NETX_PA_XMAC
(
x˙o
));

206 
x
->
§am_ba£
 = 
	`i‹em≠
(
	`SRAM_INTERNAL_PHYS
(
x˙o
), 
SRAM_MEM_SIZE
);

207 i‡(!
x
->
§am_ba£
)

208 
exô_ªÀa£_3
;

210 
x
->
úq
 = 
	`NETX_IRQ_XPEC
(
x˙o
);

212 
x
->
no
 = 
x˙o
;

213 
x
->
dev
 = dev;

215 
xc_ö_u£
 |(1 << 
x˙o
);

217 
exô
;

219 
exô_ªÀa£_3
:

220 
	`ªÀa£_mem_ªgi⁄
(
	`SRAM_INTERNAL_PHYS
(
x˙o
), 
SRAM_MEM_SIZE
);

221 
exô_ªÀa£_2
:

222 
	`ªÀa£_mem_ªgi⁄
(
	`NETX_PA_XMAC
(
x˙o
), 
XMAC_MEM_SIZE
);

223 
exô_ªÀa£_1
:

224 
	`ªÀa£_mem_ªgi⁄
(
	`NETX_PA_XPEC
(
x˙o
), 
XPEC_MEM_SIZE
);

225 
exô_‰ì
:

226 
	`k‰ì
(
x
);

227 
x
 = 
NULL
;

228 
exô
:

229 
	`muãx_u∆ock
(&
xc_lock
);

230  
x
;

231 
	}
}

233 
	$‰ì_xc
(
xc
 *
x
)

235 
x˙o
 = 
x
->
no
;

237 
	`muãx_lock
(&
xc_lock
);

239 
	`iounm≠
(
x
->
§am_ba£
);

240 
	`ªÀa£_mem_ªgi⁄
(
	`SRAM_INTERNAL_PHYS
(
x˙o
), 
SRAM_MEM_SIZE
);

241 
	`ªÀa£_mem_ªgi⁄
(
	`NETX_PA_XMAC
(
x˙o
), 
XMAC_MEM_SIZE
);

242 
	`ªÀa£_mem_ªgi⁄
(
	`NETX_PA_XPEC
(
x˙o
), 
XPEC_MEM_SIZE
);

243 
xc_ö_u£
 &~(1 << 
x
->
no
);

244 
	`k‰ì
(
x
);

246 
	`muãx_u∆ock
(&
xc_lock
);

247 
	}
}

249 
EXPORT_SYMBOL
(
‰ì_xc
);

250 
EXPORT_SYMBOL
(
ªque°_xc
);

251 
EXPORT_SYMBOL
(
xc_ªque°_fúmw¨e
);

252 
EXPORT_SYMBOL
(
xc_ª£t
);

253 
EXPORT_SYMBOL
(
xc_ru¬ög
);

254 
EXPORT_SYMBOL
(
xc_°¨t
);

255 
EXPORT_SYMBOL
(
xc_°›
);

	@arch/arm/mach-ns9xxx/board-a9m9750dev.c

11 
	~<löux/∂©f‹m_devi˚.h
>

12 
	~<löux/£rül_8250.h
>

13 
	~<löux/úq.h
>

15 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch-ns9xxx/bﬂrd.h
>

18 
	~<asm/¨ch-ns9xxx/ªgs-sys.h
>

19 
	~<asm/¨ch-ns9xxx/ªgs-mem.h
>

20 
	~<asm/¨ch-ns9xxx/ªgs-bbu.h
>

21 
	~<asm/¨ch-ns9xxx/ªgs-bﬂrd-a9m9750dev.h
>

23 
	~"bﬂrd-a9m9750dev.h
"

25 
m≠_desc
 
	gbﬂrd_a9m9750dev_io_desc
[] 
	g__öôd©a
 = {

27 .
vútuÆ
 = 
io_p2v
(
NS9XXX_CSxSTAT_PHYS
(0)),

28 .
	gp‚
 = 
__phys_to_p‚
(
NS9XXX_CSxSTAT_PHYS
(0)),

29 .
	gÀngth
 = 
NS9XXX_CS0STAT_LENGTH
,

30 .
	gty≥
 = 
MT_DEVICE
,

34 
__öô
 
	$bﬂrd_a9m9750dev_m≠_io
()

36 
	`iŸabÀ_öô
(
bﬂrd_a9m9750dev_io_desc
,

37 
	`ARRAY_SIZE
(
bﬂrd_a9m9750dev_io_desc
));

38 
	}
}

40 
	$a9m9750dev_Âga_ack_úq
(
úq
)

43 
	}
}

45 
	$a9m9750dev_Âga_mask_úq
(
úq
)

47 
FPGA_IER
 &~(1 << (
úq
 - 
	`FPGA_IRQ
(0)));

48 
	}
}

50 
	$a9m9750dev_Âga_maskack_úq
(
úq
)

52 
	`a9m9750dev_Âga_mask_úq
(
úq
);

53 
	`a9m9750dev_Âga_ack_úq
(
úq
);

54 
	}
}

56 
	$a9m9750dev_Âga_unmask_úq
(
úq
)

58 
FPGA_IER
 |1 << (
úq
 - 
	`FPGA_IRQ
(0));

59 
	}
}

61 
úq_chù
 
	ga9m9750dev_Âga_chù
 = {

62 .
ack
 = 
a9m9750dev_Âga_ack_úq
,

63 .
	gmask
 = 
a9m9750dev_Âga_mask_úq
,

64 .
	gmask_ack
 = 
a9m9750dev_Âga_maskack_úq
,

65 .
	gunmask
 = 
a9m9750dev_Âga_unmask_úq
,

68 
	$a9m9750dev_Âga_demux_h™dÀr
(
úq
,

69 
úq_desc
 *
desc
)

71 
°©
 = 
FPGA_ISR
;

73 
°©
 != 0) {

74 
úqno
 = 
	`Ês
(
°©
) - 1;

76 
°©
 &~(1 << 
úqno
);

78 
desc
 = 
úq_desc
 + 
	`FPGA_IRQ
(
úqno
);

80 
	`desc_h™dÀ_úq
(
úqno
, 
desc
);

82 
	}
}

84 
__öô
 
	$bﬂrd_a9m9750dev_öô_úq
()

86 
u32
 
ªg
;

87 
i
;

94 
	`BBU_GC
(2) &= ~0x2000;

96 
i
 = 
	`FPGA_IRQ
(0); i <= FPGA_IRQ(7); ++i) {

97 
	`£t_úq_chù
(
i
, &
a9m9750dev_Âga_chù
);

98 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

99 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

103 
ªg
 = 
	`SYS_EIC
(2);

104 
	`REGSET
(
ªg
, 
SYS_EIC
, 
PLTY
, 
AL
);

105 
	`REGSET
(
ªg
, 
SYS_EIC
, 
LVEDG
, 
LEVEL
);

106 
	`SYS_EIC
(2Ë
ªg
;

108 
	`£t_úq_chaöed_h™dÀr
(
IRQ_EXT2
,

109 
a9m9750dev_Âga_demux_h™dÀr
);

110 
	}
}

112 
∂©_£rül8250_p‹t
 
	gbﬂrd_a9m9750dev_£rül8250_p‹t
[] = {

114 .
ioba£
 = 
FPGA_UARTA_BASE
,

115 .
	gmemba£
 = (*)
FPGA_UARTA_BASE
,

116 .
	gm≠ba£
 = 
FPGA_UARTA_BASE
,

117 .
	gúq
 = 
IRQ_FPGA_UARTA
,

118 .
	giŸy≥
 = 
UPIO_MEM
,

119 .
	gu¨t˛k
 = 18432000,

120 .
	gªgshi·
 = 0,

121 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SHARE_IRQ
,

123 .
	gioba£
 = 
FPGA_UARTB_BASE
,

124 .
	gmemba£
 = (*)
FPGA_UARTB_BASE
,

125 .
	gm≠ba£
 = 
FPGA_UARTB_BASE
,

126 .
	gúq
 = 
IRQ_FPGA_UARTB
,

127 .
	giŸy≥
 = 
UPIO_MEM
,

128 .
	gu¨t˛k
 = 18432000,

129 .
	gªgshi·
 = 0,

130 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SHARE_IRQ
,

132 .
	gioba£
 = 
FPGA_UARTC_BASE
,

133 .
	gmemba£
 = (*)
FPGA_UARTC_BASE
,

134 .
	gm≠ba£
 = 
FPGA_UARTC_BASE
,

135 .
	gúq
 = 
IRQ_FPGA_UARTC
,

136 .
	giŸy≥
 = 
UPIO_MEM
,

137 .
	gu¨t˛k
 = 18432000,

138 .
	gªgshi·
 = 0,

139 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SHARE_IRQ
,

141 .
	gioba£
 = 
FPGA_UARTD_BASE
,

142 .
	gmemba£
 = (*)
FPGA_UARTD_BASE
,

143 .
	gm≠ba£
 = 
FPGA_UARTD_BASE
,

144 .
	gúq
 = 
IRQ_FPGA_UARTD
,

145 .
	giŸy≥
 = 
UPIO_MEM
,

146 .
	gu¨t˛k
 = 18432000,

147 .
	gªgshi·
 = 0,

148 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_SHARE_IRQ
,

154 
∂©f‹m_devi˚
 
	gbﬂrd_a9m9750dev_£rül_devi˚
 = {

155 .
«me
 = "serial8250",

156 .
	gdev
 = {

157 .
∂©f‹m_d©a
 = 
bﬂrd_a9m9750dev_£rül8250_p‹t
,

161 
∂©f‹m_devi˚
 *
	gbﬂrd_a9m9750dev_devi˚s
[] 
	g__öôd©a
 = {

162 &
bﬂrd_a9m9750dev_£rül_devi˚
,

165 
__öô
 
	$bﬂrd_a9m9750dev_öô_machöe
()

167 
u32
 
ªg
;

170 
	`REGSETIM
(
	`SYS_SMCSSMB
(0), 
SYS_SMCSSMB
, 
CSxB
,

171 
	`NS9XXX_CSxSTAT_PHYS
(0) >> 12);

174 
ªg
 = 
	`SYS_SMCSSMM
(0);

175 
	`REGSETIM
(
ªg
, 
SYS_SMCSSMM
, 
CSxM
, 0xfffff);

176 
	`REGSET
(
ªg
, 
SYS_SMCSSMM
, 
CSEx
, 
EN
);

177 
	`SYS_SMCSSMM
(0Ë
ªg
;

180 
ªg
 = 
	`MEM_SMC
(0);

181 
	`REGSET
(
ªg
, 
MEM_SMC
, 
WSMC
, 
OFF
);

182 
	`REGSET
(
ªg
, 
MEM_SMC
, 
BSMC
, 
OFF
);

183 
	`REGSET
(
ªg
, 
MEM_SMC
, 
EW
, 
OFF
);

184 
	`REGSET
(
ªg
, 
MEM_SMC
, 
PB
, 1);

185 
	`REGSET
(
ªg
, 
MEM_SMC
, 
PC
, 
AL
);

186 
	`REGSET
(
ªg
, 
MEM_SMC
, 
PM
, 
DIS
);

187 
	`REGSET
(
ªg
, 
MEM_SMC
, 
MW
, 8);

188 
	`MEM_SMC
(0Ë
ªg
;

191 
	`MEM_SMWED
(0) = 0x2;

192 
	`MEM_SMOED
(0) = 0x2;

193 
	`MEM_SMRD
(0) = 0x6;

194 
	`MEM_SMWD
(0) = 0x6;

196 
	`∂©f‹m_add_devi˚s
(
bﬂrd_a9m9750dev_devi˚s
,

197 
	`ARRAY_SIZE
(
bﬂrd_a9m9750dev_devi˚s
));

198 
	}
}

	@arch/arm/mach-ns9xxx/board-a9m9750dev.h

11 
	~<löux/öô.h
>

13 
__öô
 
bﬂrd_a9m9750dev_m≠_io
();

14 
__öô
 
bﬂrd_a9m9750dev_öô_machöe
();

15 
__öô
 
bﬂrd_a9m9750dev_öô_úq
();

	@arch/arm/mach-ns9xxx/board-jscc9p9360.c

11 
	~"bﬂrd-jscc9p9360.h
"

13 
__öô
 
	$bﬂrd_jscc9p9360_öô_machöe
()

16 
	}
}

	@arch/arm/mach-ns9xxx/board-jscc9p9360.h

11 
	~<löux/öô.h
>

13 
__öô
 
bﬂrd_jscc9p9360_öô_machöe
();

	@arch/arm/mach-ns9xxx/generic.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<asm/mem‹y.h
>

14 
	~<asm/∑ge.h
>

15 
	~<asm/mach-ty≥s.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/¨ch-ns9xxx/ªgs-sys.h
>

18 
	~<asm/¨ch-ns9xxx/ªgs-mem.h
>

19 
	~<asm/¨ch-ns9xxx/bﬂrd.h
>

21 
m≠_desc
 
	g°™d¨d_io_desc
[] 
	g__öôd©a
 = {

23 .
vútuÆ
 = 
io_p2v
(0x90000000),

24 .
	gp‚
 = 
__phys_to_p‚
(0x90000000),

25 .
	gÀngth
 = 0x00700000,

26 .
	gty≥
 = 
MT_DEVICE
,

28 .
	gvútuÆ
 = 
io_p2v
(0xa0100000),

29 .
	gp‚
 = 
__phys_to_p‚
(0xa0100000),

30 .
	gÀngth
 = 0x00900000,

31 .
	gty≥
 = 
MT_DEVICE
,

35 
__öô
 
	$ns9xxx_m≠_io
()

37 
	`iŸabÀ_öô
(
°™d¨d_io_desc
, 
	`ARRAY_SIZE
(standard_io_desc));

38 
	}
}

40 
__öô
 
	$ns9xxx_öô_machöe
()

42 
	}
}

	@arch/arm/mach-ns9xxx/generic.h

11 
	~<löux/time.h
>

12 
	~<asm/mach/time.h
>

13 
	~<löux/öô.h
>

15 
__öô
 
ns9xxx_öô_úq
();

16 
__öô
 
ns9xxx_m≠_io
();

17 
__öô
 
ns9xxx_öô_machöe
();

19 
sys_timî
 
ns9xxx_timî
;

	@arch/arm/mach-ns9xxx/irq.c

11 
	~<löux/öãºu±.h
>

12 
	~<asm/mach/úq.h
>

13 
	~<asm/mach-ty≥s.h
>

14 
	~<asm/¨ch-ns9xxx/ªgs-sys.h
>

15 
	~<asm/¨ch-ns9xxx/úqs.h
>

16 
	~<asm/¨ch-ns9xxx/bﬂrd.h
>

18 
	~"gíîic.h
"

20 
	$ns9xxx_ack_úq_timî
(
úq
)

22 
u32
 
tc
 = 
	`SYS_TC
(
úq
 - 
IRQ_TIMER0
);

24 
	`REGSET
(
tc
, 
SYS_TCx
, 
INTC
, 
SET
);

25 
	`SYS_TC
(
úq
 - 
IRQ_TIMER0
Ë
tc
;

27 
	`REGSET
(
tc
, 
SYS_TCx
, 
INTC
, 
UNSET
);

28 
	`SYS_TC
(
úq
 - 
IRQ_TIMER0
Ë
tc
;

29 
	}
}

31 (*
ns9xxx_ack_úq_fun˘i⁄s
[
NR_IRQS
])() = {

32 [
IRQ_TIMER0
] = 
ns9xxx_ack_úq_timî
,

33 [
IRQ_TIMER1
] = 
ns9xxx_ack_úq_timî
,

34 [
IRQ_TIMER2
] = 
ns9xxx_ack_úq_timî
,

35 [
IRQ_TIMER3
] = 
ns9xxx_ack_úq_timî
,

36 
	}
};

38 
	$ns9xxx_mask_úq
(
úq
)

41 
	`SYS_IC
(
úq
 / 4) &= ~(1 << (7 + 8 * (3 - (irq & 3))));

42 
	}
}

44 
	$ns9xxx_ack_úq
(
úq
)

46 i‡(!
ns9xxx_ack_úq_fun˘i⁄s
[
úq
]) {

47 
	`¥ötk
(
KERN_ERR
 "nÿack fun˘i⁄ f‹ irq %u\n", 
úq
);

48 
	`BUG
();

51 
ns9xxx_ack_úq_fun˘i⁄s
[
úq
](irq);

52 
SYS_ISRADDR
 = 0;

53 
	}
}

55 
	$ns9xxx_maskack_úq
(
úq
)

57 
	`ns9xxx_mask_úq
(
úq
);

58 
	`ns9xxx_ack_úq
(
úq
);

59 
	}
}

61 
	$ns9xxx_unmask_úq
(
úq
)

64 
	`SYS_IC
(
úq
 / 4) |= 1 << (7 + 8 * (3 - (irq & 3)));

65 
	}
}

67 
úq_chù
 
	gns9xxx_chù
 = {

68 .
ack
 = 
ns9xxx_ack_úq
,

69 .
	gmask
 = 
ns9xxx_mask_úq
,

70 .
	gmask_ack
 = 
ns9xxx_maskack_úq
,

71 .
	gunmask
 = 
ns9xxx_unmask_úq
,

74 
__öô
 
	$ns9xxx_öô_úq
()

76 
i
;

79 
i
 = 0; i < 8; ++i)

80 
	`SYS_IC
(
i
) = (4 * i) << 24 | (4 * i + 1) << 16 |

81 (4 * 
i
 + 2) << 8 | (4 * i + 3);

86 
i
 = 0; i < 32; ++i)

87 
	`SYS_IVA
(
i
) = i;

89 
i
 = 
IRQ_WATCHDOG
; i <
IRQ_EXT3
; ++i) {

90 
	`£t_úq_chù
(
i
, &
ns9xxx_chù
);

91 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

92 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

94 
	}
}

	@arch/arm/mach-ns9xxx/mach-cc9p9360dev.c

11 
	~<asm/mach/¨ch.h
>

12 
	~<asm/mach-ty≥s.h
>

14 
	~"bﬂrd-a9m9750dev.h
"

15 
	~"gíîic.h
"

17 
__öô
 
	$mach_cc9p9360dev_m≠_io
()

19 
	`ns9xxx_m≠_io
();

20 
	`bﬂrd_a9m9750dev_m≠_io
();

21 
	}
}

23 
__öô
 
	$mach_cc9p9360dev_öô_úq
()

25 
	`ns9xxx_öô_úq
();

26 
	`bﬂrd_a9m9750dev_öô_úq
();

27 
	}
}

29 
__öô
 
	$mach_cc9p9360dev_öô_machöe
()

31 
	`ns9xxx_öô_machöe
();

32 
	`bﬂrd_a9m9750dev_öô_machöe
();

33 
	}
}

35 
MACHINE_START
(
CC9P9360DEV
, "Digi ConnectCore 9P 9360 onán A9M9750 Devboard")

36 .
	gm≠_io
 = 
mach_cc9p9360dev_m≠_io
,

37 .
	göô_úq
 = 
mach_cc9p9360dev_öô_úq
,

38 .
	göô_machöe
 = 
mach_cc9p9360dev_öô_machöe
,

39 .
	gtimî
 = &
ns9xxx_timî
,

40 .
	gboŸ_∑øms
 = 0x100,

41 
	gMACHINE_END


	@arch/arm/mach-ns9xxx/mach-cc9p9360js.c

11 
	~<asm/mach/¨ch.h
>

12 
	~<asm/mach-ty≥s.h
>

14 
	~"bﬂrd-jscc9p9360.h
"

15 
	~"gíîic.h
"

17 
__öô
 
	$mach_cc9p9360js_öô_machöe
()

19 
	`ns9xxx_öô_machöe
();

20 
	`bﬂrd_jscc9p9360_öô_machöe
();

21 
	}
}

23 
MACHINE_START
(
CC9P9360DEV
, "Digi ConnectCore 9P 9360 onán JSCC9P9360 Devboard")

24 .
	gm≠_io
 = 
ns9xxx_m≠_io
,

25 .
	göô_úq
 = 
ns9xxx_öô_úq
,

26 .
	göô_machöe
 = 
mach_cc9p9360js_öô_machöe
,

27 .
	gtimî
 = &
ns9xxx_timî
,

28 .
	gboŸ_∑øms
 = 0x100,

29 
	gMACHINE_END


	@arch/arm/mach-ns9xxx/time.c

11 
	~<löux/jiffõs.h
>

12 
	~<löux/öãºu±.h
>

13 
	~<löux/úq.h
>

14 
	~<asm/¨ch-ns9xxx/ªgs-sys.h
>

15 
	~<asm/¨ch-ns9xxx/˛ock.h
>

16 
	~<asm/¨ch-ns9xxx/úqs.h
>

17 
	~<asm/¨ch/sy°em.h
>

18 
	~"gíîic.h
"

20 
	#TIMERCLOCKSELECT
 64

	)

22 
u32
 
	gu£cs_≥r_tick
;

24 
úqªtu∫_t


25 
	$ns9xxx_timî_öãºu±
(
úq
, *
dev_id
)

27 
	`wrôe_£qlock
(&
xtime_lock
);

28 
	`timî_tick
();

29 
	`wrôe_£qu∆ock
(&
xtime_lock
);

31  
IRQ_HANDLED
;

32 
	}
}

34 
	$ns9xxx_timî_gëtimeoff£t
()

40 
u32
 
cou¡î1
 = 
	`SYS_TR
(0);

41 
≥ndög
 = 
SYS_ISR
 & (1 << 
IRQ_TIMER0
);

42 
u32
 
cou¡î2
 = 
	`SYS_TR
(0);

43 
u32
 
ñ≠£d
;

45 i‡(
≥ndög
 || 
cou¡î2
 > 
cou¡î1
)

46 
ñ≠£d
 = 2 * 
	`SYS_TRC
(0Ë- 
cou¡î2
;

48 
ñ≠£d
 = 
	`SYS_TRC
(0Ë- 
cou¡î1
;

50  (
ñ≠£d
 * 
u£cs_≥r_tick
) >> 16;

52 
	}
}

54 
úqa˘i⁄
 
	gns9xxx_timî_úq
 = {

55 .
«me
 = "NS9xxx Timer Tick",

56 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

57 .
	gh™dÀr
 = 
ns9xxx_timî_öãºu±
,

60 
__öô
 
	$ns9xxx_timî_öô
()

62 
tc
;

64 
u£cs_≥r_tick
 =

65 
	`SH_DIV
(1000000 * 
TIMERCLOCKSELECT
, 
	`ns9xxx_˝u˛ock
(), 16);

68 i‡((
tc
 = 
	`SYS_TC
(0)Ë& 
SYS_TCx_TEN
)

69 
	`SYS_TC
(0Ë
tc
 & ~
SYS_TCx_TEN
;

71 
	`SYS_TRC
(0Ë
	`SH_DIV
(
	`ns9xxx_˝u˛ock
(), (
TIMERCLOCKSELECT
 * 
HZ
), 0);

73 
	`REGSET
(
tc
, 
SYS_TCx
, 
TEN
, 
EN
);

74 
	`REGSET
(
tc
, 
SYS_TCx
, 
TLCS
, 
DIV64
);

75 
	`REGSET
(
tc
, 
SYS_TCx
, 
INTS
, 
EN
);

76 
	`REGSET
(
tc
, 
SYS_TCx
, 
UDS
, 
DOWN
);

77 
	`REGSET
(
tc
, 
SYS_TCx
, 
TDBG
, 
STOP
);

78 
	`REGSET
(
tc
, 
SYS_TCx
, 
TSZ
, 32);

79 
	`REGSET
(
tc
, 
SYS_TCx
, 
REN
, 
EN
);

80 
	`SYS_TC
(0Ë
tc
;

82 
	`£tup_úq
(
IRQ_TIMER0
, &
ns9xxx_timî_úq
);

83 
	}
}

85 
sys_timî
 
	gns9xxx_timî
 = {

86 .
öô
 = 
ns9xxx_timî_öô
,

87 .
	goff£t
 = 
ns9xxx_timî_gëtimeoff£t
,

	@arch/arm/mach-omap1/board-ams-delta.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/mach-ty≥s.h
>

21 
	~<asm/mach/¨ch.h
>

22 
	~<asm/mach/m≠.h
>

24 
	~<asm/¨ch/bﬂrd-ams-dñè.h
>

25 
	~<asm/¨ch/gpio.h
>

26 
	~<asm/¨ch/mux.h
>

27 
	~<asm/¨ch/usb.h
>

28 
	~<asm/¨ch/bﬂrd.h
>

29 
	~<asm/¨ch/comm⁄.h
>

31 
u8
 
	gams_dñè_œtch1_ªg
;

32 
u16
 
	gams_dñè_œtch2_ªg
;

34 
	$ams_dñè_œtch1_wrôe
(
u8
 
mask
, u8 
vÆue
)

36 
ams_dñè_œtch1_ªg
 &~
mask
;

37 
ams_dñè_œtch1_ªg
 |
vÆue
;

38 *(vﬁ©ûê
__u8
 *Ë
AMS_DELTA_LATCH1_VIRT
 = 
ams_dñè_œtch1_ªg
;

39 
	}
}

41 
	$ams_dñè_œtch2_wrôe
(
u16
 
mask
, u16 
vÆue
)

43 
ams_dñè_œtch2_ªg
 &~
mask
;

44 
ams_dñè_œtch2_ªg
 |
vÆue
;

45 *(vﬁ©ûê
__u16
 *Ë
AMS_DELTA_LATCH2_VIRT
 = 
ams_dñè_œtch2_ªg
;

46 
	}
}

48 
__öô
 
	$ams_dñè_öô_úq
()

50 
	`om≠1_öô_comm⁄_hw
();

51 
	`om≠_öô_úq
();

52 
	`om≠_gpio_öô
();

53 
	}
}

55 
m≠_desc
 
	gams_dñè_io_desc
[] 
	g__öôd©a
 = {

58 .
vútuÆ
 = 
AMS_DELTA_LATCH1_VIRT
,

59 .
	gp‚
 = 
__phys_to_p‚
(
AMS_DELTA_LATCH1_PHYS
),

60 .
	gÀngth
 = 0x01000000,

61 .
	gty≥
 = 
MT_DEVICE


65 .
	gvútuÆ
 = 
AMS_DELTA_LATCH2_VIRT
,

66 .
	gp‚
 = 
__phys_to_p‚
(
AMS_DELTA_LATCH2_PHYS
),

67 .
	gÀngth
 = 0x01000000,

68 .
	gty≥
 = 
MT_DEVICE


72 .
	gvútuÆ
 = 
AMS_DELTA_MODEM_VIRT
,

73 .
	gp‚
 = 
__phys_to_p‚
(
AMS_DELTA_MODEM_PHYS
),

74 .
	gÀngth
 = 0x01000000,

75 .
	gty≥
 = 
MT_DEVICE


79 
om≠_u¨t_c⁄fig
 
ams_dñè_u¨t_c⁄fig
 
	g__öôd©a
 = {

80 .
íabÀd_u¨ts
 = 1,

83 
om≠_usb_c⁄fig
 
ams_dñè_usb_c⁄fig
 
	g__öôd©a
 = {

84 .
ªgi°î_ho°
 = 1,

85 .
	ghmc_mode
 = 16,

86 .
	gpös
[0] = 2,

89 
om≠_bﬂrd_c⁄fig_kî√l
 
	gams_dñè_c⁄fig
[] = {

90 { 
OMAP_TAG_UART
, &
ams_dñè_u¨t_c⁄fig
 },

91 { 
OMAP_TAG_USB
, &
ams_dñè_usb_c⁄fig
 },

94 
∂©f‹m_devi˚
 
	gams_dñè_Àd_devi˚
 = {

95 .
«me
 = "ams-delta-led",

96 .
	gid
 = -1

99 
∂©f‹m_devi˚
 *
	gams_dñè_devi˚s
[] 
	g__öôd©a
 = {

100 &
ams_dñè_Àd_devi˚
,

103 
__öô
 
	$ams_dñè_öô
()

105 
	`iŸabÀ_öô
(
ams_dñè_io_desc
, 
	`ARRAY_SIZE
(ams_delta_io_desc));

107 
om≠_bﬂrd_c⁄fig
 = 
ams_dñè_c⁄fig
;

108 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
ams_dñè_c⁄fig
);

109 
	`om≠_£rül_öô
();

112 
	`ams_dñè_œtch2_wrôe
(~0, 0);

114 
	`∂©f‹m_add_devi˚s
(
ams_dñè_devi˚s
, 
	`ARRAY_SIZE
(ams_delta_devices));

115 
	}
}

117 
__öô
 
	$ams_dñè_m≠_io
()

119 
	`om≠1_m≠_comm⁄_io
();

120 
	}
}

122 
MACHINE_START
(
AMS_DELTA
, "Amstrad E3 (Delta)")

124 .
	gphys_io
 = 0xfff00000,

125 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

126 .
	gboŸ_∑øms
 = 0x10000100,

127 .
	gm≠_io
 = 
ams_dñè_m≠_io
,

128 .
	göô_úq
 = 
ams_dñè_öô_úq
,

129 .
	göô_machöe
 = 
ams_dñè_öô
,

130 .
	gtimî
 = &
om≠_timî
,

131 
MACHINE_END


133 
EXPORT_SYMBOL
(
ams_dñè_œtch1_wrôe
);

134 
EXPORT_SYMBOL
(
ams_dñè_œtch2_wrôe
);

	@arch/arm/mach-omap1/board-fsample.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/mtd/mtd.h
>

19 
	~<löux/mtd/«nd.h
>

20 
	~<löux/mtd/∑πôi⁄s.h
>

21 
	~<löux/öput.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/Êash.h
>

27 
	~<asm/mach/m≠.h
>

29 
	~<asm/¨ch/tc.h
>

30 
	~<asm/¨ch/gpio.h
>

31 
	~<asm/¨ch/mux.h
>

32 
	~<asm/¨ch/Âga.h
>

33 
	~<asm/¨ch/key∑d.h
>

34 
	~<asm/¨ch/comm⁄.h
>

35 
	~<asm/¨ch/bﬂrd.h
>

36 
	~<asm/¨ch/bﬂrd-fßm∂e.h
>

38 
	gfßm∂e_keym≠
[] = {

39 
KEY
(0,0,
KEY_UP
),

40 
KEY
(0,1,
KEY_RIGHT
),

41 
KEY
(0,2,
KEY_LEFT
),

42 
KEY
(0,3,
KEY_DOWN
),

43 
KEY
(0,4,
KEY_CENTER
),

44 
KEY
(0,5,
KEY_0_5
),

45 
KEY
(1,0,
KEY_SOFT2
),

46 
KEY
(1,1,
KEY_SEND
),

47 
KEY
(1,2,
KEY_END
),

48 
KEY
(1,3,
KEY_VOLUMEDOWN
),

49 
KEY
(1,4,
KEY_VOLUMEUP
),

50 
KEY
(1,5,
KEY_RECORD
),

51 
KEY
(2,0,
KEY_SOFT1
),

52 
KEY
(2,1,
KEY_3
),

53 
KEY
(2,2,
KEY_6
),

54 
KEY
(2,3,
KEY_9
),

55 
KEY
(2,4,
KEY_SHARP
),

56 
KEY
(2,5,
KEY_2_5
),

57 
KEY
(3,0,
KEY_BACK
),

58 
KEY
(3,1,
KEY_2
),

59 
KEY
(3,2,
KEY_5
),

60 
KEY
(3,3,
KEY_8
),

61 
KEY
(3,4,
KEY_0
),

62 
KEY
(3,5,
KEY_HEADSETHOOK
),

63 
KEY
(4,0,
KEY_HOME
),

64 
KEY
(4,1,
KEY_1
),

65 
KEY
(4,2,
KEY_4
),

66 
KEY
(4,3,
KEY_7
),

67 
KEY
(4,4,
KEY_STAR
),

68 
KEY
(4,5,
KEY_POWER
),

72 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

74 .
°¨t
 = 
H2P2_DBG_FPGA_ETHR_START
,

75 .
	gíd
 = 
H2P2_DBG_FPGA_ETHR_START
 + 0xf,

76 .
	gÊags
 = 
IORESOURCE_MEM
,

79 .
°¨t
 = 
INT_730_MPU_EXT_NIRQ
,

80 .
	gíd
 = 0,

81 .
	gÊags
 = 
IORESOURCE_IRQ
,

85 
mtd_∑πôi⁄
 
	gn‹_∑πôi⁄s
[] = {

88 .
«me
 = "bootloader",

89 .
	goff£t
 = 0,

90 .
	gsize
 = 
SZ_128K
,

91 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

95 .
	g«me
 = "params",

96 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

97 .
	gsize
 = 
SZ_128K
,

98 .
	gmask_Êags
 = 0,

102 .
	g«me
 = "kernel",

103 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

104 .
	gsize
 = 
SZ_2M
,

105 .
	gmask_Êags
 = 0

109 .
	g«me
 = "rootfs",

110 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

111 .
	gsize
 = 
MTDPART_SIZ_FULL
,

112 .
	gmask_Êags
 = 0

116 
Êash_∂©f‹m_d©a
 
	gn‹_d©a
 = {

117 .
m≠_«me
 = "cfi_probe",

118 .
	gwidth
 = 2,

119 .
	g∑πs
 = 
n‹_∑πôi⁄s
,

120 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
n‹_∑πôi⁄s
),

123 
ªsour˚
 
	gn‹_ªsour˚
 = {

124 .
°¨t
 = 
OMAP_CS0_PHYS
,

125 .
	gíd
 = 
OMAP_CS0_PHYS
 + 
SZ_32M
 - 1,

126 .
	gÊags
 = 
IORESOURCE_MEM
,

129 
∂©f‹m_devi˚
 
	gn‹_devi˚
 = {

130 .
«me
 = "omapflash",

131 .
	gid
 = 0,

132 .
	gdev
 = {

133 .
∂©f‹m_d©a
 = &
n‹_d©a
,

135 .
	gnum_ªsour˚s
 = 1,

136 .
	gªsour˚
 = &
n‹_ªsour˚
,

139 
«nd_∂©f‹m_d©a
 
	g«nd_d©a
 = {

140 .
›ti⁄s
 = 
NAND_SAMSUNG_LP_OPTIONS
,

143 
ªsour˚
 
	g«nd_ªsour˚
 = {

144 .
°¨t
 = 
OMAP_CS3_PHYS
,

145 .
	gíd
 = 
OMAP_CS3_PHYS
 + 
SZ_4K
 - 1,

146 .
	gÊags
 = 
IORESOURCE_MEM
,

149 
∂©f‹m_devi˚
 
	g«nd_devi˚
 = {

150 .
«me
 = "omapnand",

151 .
	gid
 = 0,

152 .
	gdev
 = {

153 .
∂©f‹m_d©a
 = &
«nd_d©a
,

155 .
	gnum_ªsour˚s
 = 1,

156 .
	gªsour˚
 = &
«nd_ªsour˚
,

159 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

160 .
«me
 = "smc91x",

161 .
	gid
 = 0,

162 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

163 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

166 
ªsour˚
 
	gkp_ªsour˚s
[] = {

168 .
°¨t
 = 
INT_730_MPUIO_KEYPAD
,

169 .
	gíd
 = 
INT_730_MPUIO_KEYPAD
,

170 .
	gÊags
 = 
IORESOURCE_IRQ
,

174 
om≠_kp_∂©f‹m_d©a
 
	gkp_d©a
 = {

175 .
rows
 = 8,

176 .
	gcﬁs
 = 8,

177 .
	gkeym≠
 = 
fßm∂e_keym≠
,

178 .
	gkeym≠size
 = 
ARRAY_SIZE
(
fßm∂e_keym≠
),

179 .
	gdñay
 = 4,

182 
∂©f‹m_devi˚
 
	gkp_devi˚
 = {

183 .
«me
 = "omap-keypad",

184 .
	gid
 = -1,

185 .
	gdev
 = {

186 .
∂©f‹m_d©a
 = &
kp_d©a
,

188 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
kp_ªsour˚s
),

189 .
	gªsour˚
 = 
kp_ªsour˚s
,

192 
∂©f‹m_devi˚
 
	glcd_devi˚
 = {

193 .
«me
 = "lcd_p2",

194 .
	gid
 = -1,

197 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

198 &
n‹_devi˚
,

199 &
«nd_devi˚
,

200 &
smc91x_devi˚
,

201 &
kp_devi˚
,

202 &
lcd_devi˚
,

205 
	#P2_NAND_RB_GPIO_PIN
 62

	)

207 
	$«nd_dev_ªady
(
«nd_∂©f‹m_d©a
 *
d©a
)

209  
	`om≠_gë_gpio_d©aö
(
P2_NAND_RB_GPIO_PIN
);

210 
	}
}

212 
om≠_u¨t_c⁄fig
 
fßm∂e_u¨t_c⁄fig
 
	g__öôd©a
 = {

213 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1)),

216 
om≠_lcd_c⁄fig
 
fßm∂e_lcd_c⁄fig
 
	g__öôd©a
 = {

217 .
˘æ_«me
 = "internal",

220 
om≠_bﬂrd_c⁄fig_kî√l
 
	gfßm∂e_c⁄fig
[] = {

221 { 
OMAP_TAG_UART
, &
fßm∂e_u¨t_c⁄fig
 },

222 { 
OMAP_TAG_LCD
, &
fßm∂e_lcd_c⁄fig
 },

225 
__öô
 
	$om≠_fßm∂e_öô
()

227 i‡(!(
	`om≠_ªque°_gpio
(
P2_NAND_RB_GPIO_PIN
)))

228 
«nd_d©a
.
dev_ªady
 = 
«nd_dev_ªady
;

230 
	`om≠_cfg_ªg
(
L3_1610_FLASH_CS2B_OE
);

231 
	`om≠_cfg_ªg
(
M8_1610_FLASH_CS2B_WE
);

233 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

235 
om≠_bﬂrd_c⁄fig
 = 
fßm∂e_c⁄fig
;

236 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
fßm∂e_c⁄fig
);

237 
	`om≠_£rül_öô
();

238 
	}
}

240 
__öô
 
	$fßm∂e_öô_smc91x
()

242 
	`Âga_wrôe
(1, 
H2P2_DBG_FPGA_LAN_RESET
);

243 
	`mdñay
(50);

244 
	`Âga_wrôe
(
	`Âga_ªad
(
H2P2_DBG_FPGA_LAN_RESET
) & ~1,

245 
H2P2_DBG_FPGA_LAN_RESET
);

246 
	`mdñay
(50);

247 
	}
}

249 
__öô
 
	$om≠_fßm∂e_öô_úq
()

251 
	`om≠1_öô_comm⁄_hw
();

252 
	`om≠_öô_úq
();

253 
	`om≠_gpio_öô
();

254 
	`fßm∂e_öô_smc91x
();

255 
	}
}

258 
m≠_desc
 
	gom≠_fßm∂e_io_desc
[] 
	g__öôd©a
 = {

260 .
vútuÆ
 = 
H2P2_DBG_FPGA_BASE
,

261 .
	gp‚
 = 
__phys_to_p‚
(
H2P2_DBG_FPGA_START
),

262 .
	gÀngth
 = 
H2P2_DBG_FPGA_SIZE
,

263 .
	gty≥
 = 
MT_DEVICE


266 .
	gvútuÆ
 = 
FSAMPLE_CPLD_BASE
,

267 .
	gp‚
 = 
__phys_to_p‚
(
FSAMPLE_CPLD_START
),

268 .
	gÀngth
 = 
FSAMPLE_CPLD_SIZE
,

269 .
	gty≥
 = 
MT_DEVICE


273 
__öô
 
	$om≠_fßm∂e_m≠_io
()

275 
	`om≠1_m≠_comm⁄_io
();

276 
	`iŸabÀ_öô
(
om≠_fßm∂e_io_desc
,

277 
	`ARRAY_SIZE
(
om≠_fßm∂e_io_desc
));

284 
	`om≠_wrôew
(
	`om≠_ªadw
(
OMAP730_DSP_M_CTL
) & ~1, OMAP730_DSP_M_CTL);

295 
	`om≠_wrôñ
(0x0000fff3, 
OMAP730_FLASH_CFG_0
);

296 
	`om≠_wrôñ
(0x00000088, 
OMAP730_FLASH_ACFG_0
);

302 
	`om≠_wrôñ
(0x0000fff3, 
OMAP730_FLASH_CFG_1
);

303 
	`om≠_wrôñ
(0x00000000, 
OMAP730_FLASH_ACFG_1
);

309 
	`om≠_wrôñ
(
	`om≠_ªadl
(
OMAP730_IO_CONF_9
) & 0x1FFFFFFF, OMAP730_IO_CONF_9);

310 
	}
}

312 
MACHINE_START
(
OMAP_FSAMPLE
, "OMAP730 F-Sample")

314 .
	gphys_io
 = 0xfff00000,

315 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

316 .
	gboŸ_∑øms
 = 0x10000100,

317 .
	gm≠_io
 = 
om≠_fßm∂e_m≠_io
,

318 .
	göô_úq
 = 
om≠_fßm∂e_öô_úq
,

319 .
	göô_machöe
 = 
om≠_fßm∂e_öô
,

320 .
	gtimî
 = &
om≠_timî
,

321 
	gMACHINE_END


	@arch/arm/mach-omap1/board-generic.c

16 
	~<löux/kî√l.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/∂©f‹m_devi˚.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/mach-ty≥s.h
>

22 
	~<asm/mach/¨ch.h
>

23 
	~<asm/mach/m≠.h
>

25 
	~<asm/¨ch/gpio.h
>

26 
	~<asm/¨ch/mux.h
>

27 
	~<asm/¨ch/usb.h
>

28 
	~<asm/¨ch/bﬂrd.h
>

29 
	~<asm/¨ch/comm⁄.h
>

31 
__öô
 
	$om≠_gíîic_öô_úq
()

33 
	`om≠1_öô_comm⁄_hw
();

34 
	`om≠_öô_úq
();

35 
	}
}

39 #ifde‡
CONFIG_ARCH_OMAP15XX


40 
om≠_usb_c⁄fig
 
gíîic1510_usb_c⁄fig
 
	g__öôd©a
 = {

41 .
ªgi°î_ho°
 = 1,

42 .
	gªgi°î_dev
 = 1,

43 .
	ghmc_mode
 = 16,

44 .
	gpös
[0] = 3,

48 #i‡
deföed
(
CONFIG_ARCH_OMAP16XX
)

49 
om≠_usb_c⁄fig
 
gíîic1610_usb_c⁄fig
 
	g__öôd©a
 = {

50 #ifde‡
CONFIG_USB_OTG


51 .
Ÿg
 = 1,

53 .
	gªgi°î_ho°
 = 1,

54 .
	gªgi°î_dev
 = 1,

55 .
	ghmc_mode
 = 16,

56 .
	gpös
[0] = 6,

59 
om≠_mmc_c⁄fig
 
gíîic_mmc_c⁄fig
 
	g__öôd©a
 = {

60 .
mmc
 [0] = {

61 .
íabÀd
 = 0,

62 .
	gwúe4
 = 0,

63 .
	gwp_pö
 = -1,

64 .
	gpowî_pö
 = -1,

65 .
	gswôch_pö
 = -1,

67 .
	gmmc
 [1] = {

68 .
íabÀd
 = 0,

69 .
	gwúe4
 = 0,

70 .
	gwp_pö
 = -1,

71 .
	gpowî_pö
 = -1,

72 .
	gswôch_pö
 = -1,

78 
om≠_u¨t_c⁄fig
 
gíîic_u¨t_c⁄fig
 
	g__öôd©a
 = {

79 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

82 
om≠_bﬂrd_c⁄fig_kî√l
 
	ggíîic_c⁄fig
[] = {

83 { 
OMAP_TAG_USB
, 
NULL
 },

84 { 
OMAP_TAG_MMC
, &
gíîic_mmc_c⁄fig
 },

85 { 
OMAP_TAG_UART
, &
gíîic_u¨t_c⁄fig
 },

88 
__öô
 
	$om≠_gíîic_öô
()

90 #ifde‡
CONFIG_ARCH_OMAP15XX


91 i‡(
	`˝u_is_om≠15xx
()) {

92 
gíîic_c⁄fig
[0].
d©a
 = &
gíîic1510_usb_c⁄fig
;

95 #i‡
	`deföed
(
CONFIG_ARCH_OMAP16XX
)

96 i‡(!
	`˝u_is_om≠1510
()) {

97 
gíîic_c⁄fig
[0].
d©a
 = &
gíîic1610_usb_c⁄fig
;

101 
om≠_bﬂrd_c⁄fig
 = 
gíîic_c⁄fig
;

102 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
gíîic_c⁄fig
);

103 
	`om≠_£rül_öô
();

104 
	}
}

106 
__öô
 
	$om≠_gíîic_m≠_io
()

108 
	`om≠1_m≠_comm⁄_io
();

109 
	}
}

111 
MACHINE_START
(
OMAP_GENERIC
, "Generic OMAP1510/1610/1710")

113 .
	gphys_io
 = 0xfff00000,

114 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

115 .
	gboŸ_∑øms
 = 0x10000100,

116 .
	gm≠_io
 = 
om≠_gíîic_m≠_io
,

117 .
	göô_úq
 = 
om≠_gíîic_öô_úq
,

118 .
	göô_machöe
 = 
om≠_gíîic_öô
,

119 .
	gtimî
 = &
om≠_timî
,

120 
	gMACHINE_END


	@arch/arm/mach-omap1/board-h2.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/∂©f‹m_devi˚.h
>

25 
	~<löux/dñay.h
>

26 
	~<löux/mtd/mtd.h
>

27 
	~<löux/mtd/«nd.h
>

28 
	~<löux/mtd/∑πôi⁄s.h
>

29 
	~<löux/öput.h
>

30 
	~<löux/w‹kqueue.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/mach-ty≥s.h
>

34 
	~<asm/mach/¨ch.h
>

35 
	~<asm/mach/Êash.h
>

36 
	~<asm/mach/m≠.h
>

38 
	~<asm/¨ch/gpio.h
>

39 
	~<asm/¨ch/mux.h
>

40 
	~<asm/¨ch/tc.h
>

41 
	~<asm/¨ch/úda.h
>

42 
	~<asm/¨ch/usb.h
>

43 
	~<asm/¨ch/key∑d.h
>

44 
	~<asm/¨ch/comm⁄.h
>

45 
	~<asm/¨ch/mcb•.h
>

46 
	~<asm/¨ch/om≠-Æß.h
>

48 
om≠_gpio_öô
();

50 
	gh2_keym≠
[] = {

51 
KEY
(0, 0, 
KEY_LEFT
),

52 
KEY
(0, 1, 
KEY_RIGHT
),

53 
KEY
(0, 2, 
KEY_3
),

54 
KEY
(0, 3, 
KEY_F10
),

55 
KEY
(0, 4, 
KEY_F5
),

56 
KEY
(0, 5, 
KEY_9
),

57 
KEY
(1, 0, 
KEY_DOWN
),

58 
KEY
(1, 1, 
KEY_UP
),

59 
KEY
(1, 2, 
KEY_2
),

60 
KEY
(1, 3, 
KEY_F9
),

61 
KEY
(1, 4, 
KEY_F7
),

62 
KEY
(1, 5, 
KEY_0
),

63 
KEY
(2, 0, 
KEY_ENTER
),

64 
KEY
(2, 1, 
KEY_6
),

65 
KEY
(2, 2, 
KEY_1
),

66 
KEY
(2, 3, 
KEY_F2
),

67 
KEY
(2, 4, 
KEY_F6
),

68 
KEY
(2, 5, 
KEY_HOME
),

69 
KEY
(3, 0, 
KEY_8
),

70 
KEY
(3, 1, 
KEY_5
),

71 
KEY
(3, 2, 
KEY_F12
),

72 
KEY
(3, 3, 
KEY_F3
),

73 
KEY
(3, 4, 
KEY_F8
),

74 
KEY
(3, 5, 
KEY_END
),

75 
KEY
(4, 0, 
KEY_7
),

76 
KEY
(4, 1, 
KEY_4
),

77 
KEY
(4, 2, 
KEY_F11
),

78 
KEY
(4, 3, 
KEY_F1
),

79 
KEY
(4, 4, 
KEY_F4
),

80 
KEY
(4, 5, 
KEY_ESC
),

81 
KEY
(5, 0, 
KEY_F13
),

82 
KEY
(5, 1, 
KEY_F14
),

83 
KEY
(5, 2, 
KEY_F15
),

84 
KEY
(5, 3, 
KEY_F16
),

85 
KEY
(5, 4, 
KEY_SLEEP
),

89 
mtd_∑πôi⁄
 
	gh2_n‹_∑πôi⁄s
[] = {

92 .
«me
 = "bootloader",

93 .
	goff£t
 = 0,

94 .
	gsize
 = 
SZ_128K
,

95 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

99 .
	g«me
 = "params",

100 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

101 .
	gsize
 = 
SZ_128K
,

102 .
	gmask_Êags
 = 0,

106 .
	g«me
 = "kernel",

107 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

108 .
	gsize
 = 
SZ_2M
,

109 .
	gmask_Êags
 = 0

113 .
	g«me
 = "filesystem",

114 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

115 .
	gsize
 = 
MTDPART_SIZ_FULL
,

116 .
	gmask_Êags
 = 0

120 
Êash_∂©f‹m_d©a
 
	gh2_n‹_d©a
 = {

121 .
m≠_«me
 = "cfi_probe",

122 .
	gwidth
 = 2,

123 .
	g∑πs
 = 
h2_n‹_∑πôi⁄s
,

124 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
h2_n‹_∑πôi⁄s
),

127 
ªsour˚
 
	gh2_n‹_ªsour˚
 = {

129 .
Êags
 = 
IORESOURCE_MEM
,

132 
∂©f‹m_devi˚
 
	gh2_n‹_devi˚
 = {

133 .
«me
 = "omapflash",

134 .
	gid
 = 0,

135 .
	gdev
 = {

136 .
∂©f‹m_d©a
 = &
h2_n‹_d©a
,

138 .
	gnum_ªsour˚s
 = 1,

139 .
	gªsour˚
 = &
h2_n‹_ªsour˚
,

142 
ªsour˚
 
	gh2_smc91x_ªsour˚s
[] = {

144 .
°¨t
 = 
OMAP1610_ETHR_START
,

145 .
	gíd
 = 
OMAP1610_ETHR_START
 + 0xf,

146 .
	gÊags
 = 
IORESOURCE_MEM
,

149 .
°¨t
 = 
OMAP_GPIO_IRQ
(0),

150 .
	gíd
 = 
OMAP_GPIO_IRQ
(0),

151 .
	gÊags
 = 
IORESOURCE_IRQ
,

155 
∂©f‹m_devi˚
 
	gh2_smc91x_devi˚
 = {

156 .
«me
 = "smc91x",

157 .
	gid
 = 0,

158 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h2_smc91x_ªsour˚s
),

159 .
	gªsour˚
 = 
h2_smc91x_ªsour˚s
,

162 
ªsour˚
 
	gh2_kp_ªsour˚s
[] = {

164 .
°¨t
 = 
INT_KEYBOARD
,

165 .
	gíd
 = 
INT_KEYBOARD
,

166 .
	gÊags
 = 
IORESOURCE_IRQ
,

170 
om≠_kp_∂©f‹m_d©a
 
	gh2_kp_d©a
 = {

171 .
rows
 = 8,

172 .
	gcﬁs
 = 8,

173 .
	gkeym≠
 = 
h2_keym≠
,

174 .
	gkeym≠size
 = 
ARRAY_SIZE
(
h2_keym≠
),

175 .
	gªp
 = 1,

176 .
	gdñay
 = 9,

177 .
	gdboun˚
 = 1,

180 
∂©f‹m_devi˚
 
	gh2_kp_devi˚
 = {

181 .
«me
 = "omap-keypad",

182 .
	gid
 = -1,

183 .
	gdev
 = {

184 .
∂©f‹m_d©a
 = &
h2_kp_d©a
,

186 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h2_kp_ªsour˚s
),

187 .
	gªsour˚
 = 
h2_kp_ªsour˚s
,

190 
	#H2_IRDA_FIRSEL_GPIO_PIN
 17

	)

192 #i‡
deföed
(
CONFIG_OMAP_IR
Ë|| deföed(
CONFIG_OMAP_IR_MODULE
)

193 
	$h2_å™s˚ivî_mode
(
devi˚
 *
dev
, 
°©e
)

195 i‡(
°©e
 & 
IR_SIRMODE
)

196 
	`om≠_£t_gpio_d©aout
(
H2_IRDA_FIRSEL_GPIO_PIN
, 0);

198 
	`om≠_£t_gpio_d©aout
(
H2_IRDA_FIRSEL_GPIO_PIN
, 1);

201 
	}
}

204 
om≠_úda_c⁄fig
 
	gh2_úda_d©a
 = {

205 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_MIRMODE
 | 
IR_FIRMODE
,

206 .
	grx_ch™√l
 = 
OMAP_DMA_UART3_RX
,

207 .
	gtx_ch™√l
 = 
OMAP_DMA_UART3_TX
,

208 .
	gde°_°¨t
 = 
UART3_THR
,

209 .
	g§c_°¨t
 = 
UART3_RHR
,

210 .
	gtx_åiggî
 = 0,

211 .
	grx_åiggî
 = 0,

214 
ªsour˚
 
	gh2_úda_ªsour˚s
[] = {

216 .
°¨t
 = 
INT_UART3
,

217 .
	gíd
 = 
INT_UART3
,

218 .
	gÊags
 = 
IORESOURCE_IRQ
,

221 
∂©f‹m_devi˚
 
	gh2_úda_devi˚
 = {

222 .
«me
 = "omapirda",

223 .
	gid
 = 0,

224 .
	gdev
 = {

225 .
∂©f‹m_d©a
 = &
h2_úda_d©a
,

227 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h2_úda_ªsour˚s
),

228 .
	gªsour˚
 = 
h2_úda_ªsour˚s
,

231 
∂©f‹m_devi˚
 
	gh2_lcd_devi˚
 = {

232 .
«me
 = "lcd_h2",

233 .
	gid
 = -1,

236 
om≠_mcb•_ªg_cfg
 
	gmcb•_ªgs
 = {

237 .
•¸2
 = 
FREE
 | 
FRST
 | 
GRST
 | 
XRST
 | 
XINTM
(3),

238 .
	g•¸1
 = 
RINTM
(3Ë| 
RRST
,

239 .
	gr¸2
 = 
RPHASE
 | 
RFRLEN2
(
OMAP_MCBSP_WORD_8
) |

240 
RWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
RDATDLY
(1),

241 .
	gr¸1
 = 
RFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
RWDLEN1
(
OMAP_MCBSP_WORD_16
),

242 .
	gx¸2
 = 
XPHASE
 | 
XFRLEN2
(
OMAP_MCBSP_WORD_8
) |

243 
XWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
XDATDLY
(1Ë| 
XFIG
,

244 .
	gx¸1
 = 
XFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
XWDLEN1
(
OMAP_MCBSP_WORD_16
),

245 .
	g§gr1
 = 
FWID
(15),

246 .
	g§gr2
 = 
GSYNC
 | 
CLKSP
 | 
FSGM
 | 
FPER
(31),

248 .
	gp¸0
 = 
CLKXM
 | 
CLKRM
 | 
FSXP
 | 
FSRP
 | 
CLKXP
 | 
CLKRP
,

252 
om≠_Æß_codec_c⁄fig
 
	gÆß_c⁄fig
 = {

253 .
«me
 = "H2 TSC2101",

254 .
	gmcb•_ªgs_Æß
 = &
mcb•_ªgs
,

255 .
	gcodec_c⁄figuª_dev
 = 
NULL
,

256 .
	gcodec_£t_ßm∂î©e
 = 
NULL
,

257 .
	gcodec_˛ock_£tup
 = 
NULL
,

258 .
	gcodec_˛ock_⁄
 = 
NULL
,

259 .
	gcodec_˛ock_off
 = 
NULL
,

260 .
	ggë_deÁu…_ßm∂î©e
 = 
NULL
,

263 
∂©f‹m_devi˚
 
	gh2_mcb•1_devi˚
 = {

264 .
«me
 = "omap_alsa_mcbsp",

265 .
	gid
 = 1,

266 .
	gdev
 = {

267 .
∂©f‹m_d©a
 = &
Æß_c⁄fig
,

271 
∂©f‹m_devi˚
 *
	gh2_devi˚s
[] 
	g__öôd©a
 = {

272 &
h2_n‹_devi˚
,

273 &
h2_smc91x_devi˚
,

274 &
h2_úda_devi˚
,

275 &
h2_kp_devi˚
,

276 &
h2_lcd_devi˚
,

277 &
h2_mcb•1_devi˚
,

280 
__öô
 
	$h2_öô_smc91x
()

282 i‡((
	`om≠_ªque°_gpio
(0)) < 0) {

283 
	`¥ötk
("ErrorÑequesting gpio 0 for smc91x irq\n");

286 
	}
}

288 
__öô
 
	$h2_öô_úq
()

290 
	`om≠1_öô_comm⁄_hw
();

291 
	`om≠_öô_úq
();

292 
	`om≠_gpio_öô
();

293 
	`h2_öô_smc91x
();

294 
	}
}

296 
om≠_usb_c⁄fig
 
h2_usb_c⁄fig
 
	g__öôd©a
 = {

298 .
Ÿg
 = 2,

300 #ifdef 
CONFIG_USB_GADGET_OMAP


301 .
	ghmc_mode
 = 19,

303 #ñif 
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

305 .
	ghmc_mode
 = 20,

308 .
	gpös
[1] = 3,

311 
om≠_mmc_c⁄fig
 
h2_mmc_c⁄fig
 
	g__öôd©a
 = {

312 .
mmc
 [0] = {

313 .
íabÀd
 = 1,

314 .
	gwúe4
 = 1,

315 .
	gwp_pö
 = 
OMAP_MPUIO
(3),

316 .
	gpowî_pö
 = -1,

317 .
	gswôch_pö
 = 
OMAP_MPUIO
(1),

321 
om≠_u¨t_c⁄fig
 
h2_u¨t_c⁄fig
 
	g__öôd©a
 = {

322 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

325 
om≠_lcd_c⁄fig
 
h2_lcd_c⁄fig
 
	g__öôd©a
 = {

326 .
˘æ_«me
 = "internal",

329 
om≠_bﬂrd_c⁄fig_kî√l
 
	gh2_c⁄fig
[] 
	g__öôd©a
 = {

330 { 
OMAP_TAG_USB
, &
h2_usb_c⁄fig
 },

331 { 
OMAP_TAG_MMC
, &
h2_mmc_c⁄fig
 },

332 { 
OMAP_TAG_UART
, &
h2_u¨t_c⁄fig
 },

333 { 
OMAP_TAG_LCD
, &
h2_lcd_c⁄fig
 },

336 
__öô
 
	$h2_öô
()

347 
h2_n‹_ªsour˚
.
íd
 = h2_n‹_ªsour˚.
°¨t
 = 
	`om≠_cs3_phys
();

348 
h2_n‹_ªsour˚
.
íd
 +
SZ_32M
 - 1;

350 
	`om≠_cfg_ªg
(
L3_1610_FLASH_CS2B_OE
);

351 
	`om≠_cfg_ªg
(
M8_1610_FLASH_CS2B_WE
);

355 
	`om≠_cfg_ªg
(
BALLOUT_V8_ARMIO3
);

358 #i‡
	`deföed
(
CONFIG_OMAP_IR
Ë|| deföed(
CONFIG_OMAP_IR_MODULE
)

359 
	`om≠_wrôñ
(
	`om≠_ªadl
(
FUNC_MUX_CTRL_A
) | 7, FUNC_MUX_CTRL_A);

360 i‡(!(
	`om≠_ªque°_gpio
(
H2_IRDA_FIRSEL_GPIO_PIN
))) {

361 
	`om≠_£t_gpio_dúe˘i⁄
(
H2_IRDA_FIRSEL_GPIO_PIN
, 0);

362 
h2_úda_d©a
.
å™s˚ivî_mode
 = 
h2_å™s˚ivî_mode
;

366 
	`∂©f‹m_add_devi˚s
(
h2_devi˚s
, 
	`ARRAY_SIZE
(h2_devices));

367 
om≠_bﬂrd_c⁄fig
 = 
h2_c⁄fig
;

368 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
h2_c⁄fig
);

369 
	`om≠_£rül_öô
();

370 
	}
}

372 
__öô
 
	$h2_m≠_io
()

374 
	`om≠1_m≠_comm⁄_io
();

375 
	}
}

377 
MACHINE_START
(
OMAP_H2
, "TI-H2")

379 .
	gphys_io
 = 0xfff00000,

380 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

381 .
	gboŸ_∑øms
 = 0x10000100,

382 .
	gm≠_io
 = 
h2_m≠_io
,

383 .
	göô_úq
 = 
h2_öô_úq
,

384 .
	göô_machöe
 = 
h2_öô
,

385 .
	gtimî
 = &
om≠_timî
,

386 
	gMACHINE_END


	@arch/arm/mach-omap1/board-h3.c

17 
	~<löux/ty≥s.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/maj‹.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<löux/î∫o.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/mtd/mtd.h
>

25 
	~<löux/mtd/«nd.h
>

26 
	~<löux/mtd/∑πôi⁄s.h
>

27 
	~<löux/öput.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/∑ge.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/Êash.h
>

35 
	~<asm/mach/m≠.h
>

37 
	~<asm/¨ch/gpio.h
>

38 
	~<asm/¨ch/gpi€x∑ndî.h
>

39 
	~<asm/¨ch/úqs.h
>

40 
	~<asm/¨ch/mux.h
>

41 
	~<asm/¨ch/tc.h
>

42 
	~<asm/¨ch/úda.h
>

43 
	~<asm/¨ch/usb.h
>

44 
	~<asm/¨ch/key∑d.h
>

45 
	~<asm/¨ch/dma.h
>

46 
	~<asm/¨ch/comm⁄.h
>

48 
om≠_gpio_öô
();

50 
	gh3_keym≠
[] = {

51 
KEY
(0, 0, 
KEY_LEFT
),

52 
KEY
(0, 1, 
KEY_RIGHT
),

53 
KEY
(0, 2, 
KEY_3
),

54 
KEY
(0, 3, 
KEY_F10
),

55 
KEY
(0, 4, 
KEY_F5
),

56 
KEY
(0, 5, 
KEY_9
),

57 
KEY
(1, 0, 
KEY_DOWN
),

58 
KEY
(1, 1, 
KEY_UP
),

59 
KEY
(1, 2, 
KEY_2
),

60 
KEY
(1, 3, 
KEY_F9
),

61 
KEY
(1, 4, 
KEY_F7
),

62 
KEY
(1, 5, 
KEY_0
),

63 
KEY
(2, 0, 
KEY_ENTER
),

64 
KEY
(2, 1, 
KEY_6
),

65 
KEY
(2, 2, 
KEY_1
),

66 
KEY
(2, 3, 
KEY_F2
),

67 
KEY
(2, 4, 
KEY_F6
),

68 
KEY
(2, 5, 
KEY_HOME
),

69 
KEY
(3, 0, 
KEY_8
),

70 
KEY
(3, 1, 
KEY_5
),

71 
KEY
(3, 2, 
KEY_F12
),

72 
KEY
(3, 3, 
KEY_F3
),

73 
KEY
(3, 4, 
KEY_F8
),

74 
KEY
(3, 5, 
KEY_END
),

75 
KEY
(4, 0, 
KEY_7
),

76 
KEY
(4, 1, 
KEY_4
),

77 
KEY
(4, 2, 
KEY_F11
),

78 
KEY
(4, 3, 
KEY_F1
),

79 
KEY
(4, 4, 
KEY_F4
),

80 
KEY
(4, 5, 
KEY_ESC
),

81 
KEY
(5, 0, 
KEY_F13
),

82 
KEY
(5, 1, 
KEY_F14
),

83 
KEY
(5, 2, 
KEY_F15
),

84 
KEY
(5, 3, 
KEY_F16
),

85 
KEY
(5, 4, 
KEY_SLEEP
),

90 
mtd_∑πôi⁄
 
	gn‹_∑πôi⁄s
[] = {

93 .
«me
 = "bootloader",

94 .
	goff£t
 = 0,

95 .
	gsize
 = 
SZ_128K
,

96 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

100 .
	g«me
 = "params",

101 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

102 .
	gsize
 = 
SZ_128K
,

103 .
	gmask_Êags
 = 0,

107 .
	g«me
 = "kernel",

108 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

109 .
	gsize
 = 
SZ_2M
,

110 .
	gmask_Êags
 = 0

114 .
	g«me
 = "filesystem",

115 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

116 .
	gsize
 = 
MTDPART_SIZ_FULL
,

117 .
	gmask_Êags
 = 0

121 
Êash_∂©f‹m_d©a
 
	gn‹_d©a
 = {

122 .
m≠_«me
 = "cfi_probe",

123 .
	gwidth
 = 2,

124 .
	g∑πs
 = 
n‹_∑πôi⁄s
,

125 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
n‹_∑πôi⁄s
),

128 
ªsour˚
 
	gn‹_ªsour˚
 = {

130 .
Êags
 = 
IORESOURCE_MEM
,

133 
∂©f‹m_devi˚
 
	gn‹_devi˚
 = {

134 .
«me
 = "omapflash",

135 .
	gid
 = 0,

136 .
	gdev
 = {

137 .
∂©f‹m_d©a
 = &
n‹_d©a
,

139 .
	gnum_ªsour˚s
 = 1,

140 .
	gªsour˚
 = &
n‹_ªsour˚
,

143 
mtd_∑πôi⁄
 
	g«nd_∑πôi⁄s
[] = {

147 .
«me
 = "xloader",

148 .
	goff£t
 = 0,

149 .
	gsize
 = 64 * 1024,

150 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

153 .
	g«me
 = "bootloader",

154 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

155 .
	gsize
 = 256 * 1024,

156 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

159 .
	g«me
 = "params",

160 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

161 .
	gsize
 = 192 * 1024,

164 .
	g«me
 = "kernel",

165 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

166 .
	gsize
 = 2 * 
SZ_1M
,

170 .
	g«me
 = "filesystem",

171 .
	gsize
 = 
MTDPART_SIZ_FULL
,

172 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

177 
«nd_∂©f‹m_d©a
 
	g«nd_d©a
 = {

178 .
›ti⁄s
 = 
NAND_SAMSUNG_LP_OPTIONS
,

179 .
	g∑πs
 = 
«nd_∑πôi⁄s
,

180 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
«nd_∑πôi⁄s
),

183 
ªsour˚
 
	g«nd_ªsour˚
 = {

184 .
Êags
 = 
IORESOURCE_MEM
,

187 
∂©f‹m_devi˚
 
	g«nd_devi˚
 = {

188 .
«me
 = "omapnand",

189 .
	gid
 = 0,

190 .
	gdev
 = {

191 .
∂©f‹m_d©a
 = &
«nd_d©a
,

193 .
	gnum_ªsour˚s
 = 1,

194 .
	gªsour˚
 = &
«nd_ªsour˚
,

197 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

199 .
°¨t
 = 
OMAP1710_ETHR_START
,

200 .
	gíd
 = 
OMAP1710_ETHR_START
 + 0xf,

201 .
	gÊags
 = 
IORESOURCE_MEM
,

204 .
°¨t
 = 
OMAP_GPIO_IRQ
(40),

205 .
	gíd
 = 
OMAP_GPIO_IRQ
(40),

206 .
	gÊags
 = 
IORESOURCE_IRQ
,

210 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

211 .
«me
 = "smc91x",

212 .
	gid
 = 0,

213 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

214 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

217 
	#GPTIMER_BASE
 0xFFFB1400

	)

218 
	#GPTIMER_REGS
(
x
Ë(0xFFFB1400 + (x * 0x800))

	)

219 
	#GPTIMER_REGS_SIZE
 0x46

	)

221 
ªsour˚
 
	göé©_ªsour˚s
[] = {

223 .
°¨t
 = 
GPTIMER_REGS
(0),

224 .
	gíd
 = 
GPTIMER_REGS
(0Ë+ 
GPTIMER_REGS_SIZE
,

225 .
	gÊags
 = 
IORESOURCE_MEM
,

228 .
°¨t
 = 
INT_1610_GPTIMER1
,

229 .
	gíd
 = 
INT_1610_GPTIMER1
,

230 .
	gÊags
 = 
IORESOURCE_IRQ
,

234 
∂©f‹m_devi˚
 
	göé©_devi˚
 = {

235 .
«me
 = "omap_intlat",

236 .
	gid
 = 0,

237 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
öé©_ªsour˚s
),

238 .
	gªsour˚
 = 
öé©_ªsour˚s
,

241 
ªsour˚
 
	gh3_kp_ªsour˚s
[] = {

243 .
°¨t
 = 
INT_KEYBOARD
,

244 .
	gíd
 = 
INT_KEYBOARD
,

245 .
	gÊags
 = 
IORESOURCE_IRQ
,

249 
om≠_kp_∂©f‹m_d©a
 
	gh3_kp_d©a
 = {

250 .
rows
 = 8,

251 .
	gcﬁs
 = 8,

252 .
	gkeym≠
 = 
h3_keym≠
,

253 .
	gkeym≠size
 = 
ARRAY_SIZE
(
h3_keym≠
),

254 .
	gªp
 = 1,

255 .
	gdñay
 = 9,

256 .
	gdboun˚
 = 1,

259 
∂©f‹m_devi˚
 
	gh3_kp_devi˚
 = {

260 .
«me
 = "omap-keypad",

261 .
	gid
 = -1,

262 .
	gdev
 = {

263 .
∂©f‹m_d©a
 = &
h3_kp_d©a
,

265 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h3_kp_ªsour˚s
),

266 .
	gªsour˚
 = 
h3_kp_ªsour˚s
,

272 
	$h3_£À˘_úda
(
devi˚
 *
dev
, 
°©e
)

274 
ex∑
;

275 
îr
 = 0;

277 i‡((
îr
 = 
	`ªad_gpio_ex∑
(&
ex∑
, 0x26))) {

278 
	`¥ötk
(
KERN_ERR
 "ErrorÑeading from I/O EXPANDER \n");

279  
îr
;

283 i‡(
°©e
 & 
IR_SEL
) {

284 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
 | 0x40, 0x26))) {

285 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/O EXPANDER \n");

286  
îr
;

289 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
 & ~0x40, 0x26))) {

290 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/O EXPANDER \n");

291  
îr
;

294  
îr
;

295 
	}
}

297 
	$£t_å™s_mode
(*
d©a
)

299 *
mode
 = 
d©a
;

300 
ex∑
;

301 
îr
 = 0;

303 i‡((
îr
 = 
	`ªad_gpio_ex∑
(&
ex∑
, 0x27)) != 0) {

304 
	`¥ötk
(
KERN_ERR
 "ErrorÑeading from I/OÉxpander\n");

307 
ex∑
 &= ~0x03;

309 i‡(*
mode
 & 
IR_SIRMODE
) {

310 
ex∑
 |= 0x01;

312 
ex∑
 |= 0x03;

315 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
, 0x27)) != 0) {

316 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/OÉxpander\n");

318 
	}
}

320 
	$h3_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

322 
om≠_úda_c⁄fig
 *
úda_c⁄fig
 = 
dev
->
∂©f‹m_d©a
;

324 
	`ˇn˚l_dñayed_w‹k
(&
úda_c⁄fig
->
gpio_ex∑
);

325 
	`PREPARE_WORK
(&
úda_c⁄fig
->
gpio_ex∑
, 
£t_å™s_mode
, &
mode
);

326 #îr‹ 
this
 
is
 
nŸ
 
≥rmôãd
 - 
mode
 i†
™
 
¨gumít
 
v¨übÀ


327 
	`scheduÀ_dñayed_w‹k
(&
úda_c⁄fig
->
gpio_ex∑
, 0);

330 
	}
}

332 
om≠_úda_c⁄fig
 
	gh3_úda_d©a
 = {

333 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_MIRMODE
 | 
IR_FIRMODE
,

334 .
	gå™s˚ivî_mode
 = 
h3_å™s˚ivî_mode
,

335 .
	g£À˘_úda
 = 
h3_£À˘_úda
,

336 .
	grx_ch™√l
 = 
OMAP_DMA_UART3_RX
,

337 .
	gtx_ch™√l
 = 
OMAP_DMA_UART3_TX
,

338 .
	gde°_°¨t
 = 
UART3_THR
,

339 .
	g§c_°¨t
 = 
UART3_RHR
,

340 .
	gtx_åiggî
 = 0,

341 .
	grx_åiggî
 = 0,

344 
ªsour˚
 
	gh3_úda_ªsour˚s
[] = {

346 .
°¨t
 = 
INT_UART3
,

347 .
	gíd
 = 
INT_UART3
,

348 .
	gÊags
 = 
IORESOURCE_IRQ
,

352 
∂©f‹m_devi˚
 
	gh3_úda_devi˚
 = {

353 .
«me
 = "omapirda",

354 .
	gid
 = 0,

355 .
	gdev
 = {

356 .
∂©f‹m_d©a
 = &
h3_úda_d©a
,

358 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h3_úda_ªsour˚s
),

359 .
	gªsour˚
 = 
h3_úda_ªsour˚s
,

362 
∂©f‹m_devi˚
 
	gh3_lcd_devi˚
 = {

363 .
«me
 = "lcd_h3",

364 .
	gid
 = -1,

367 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

368 &
n‹_devi˚
,

369 &
«nd_devi˚
,

370 &
smc91x_devi˚
,

371 &
öé©_devi˚
,

372 &
h3_úda_devi˚
,

373 &
h3_kp_devi˚
,

374 &
h3_lcd_devi˚
,

377 
om≠_usb_c⁄fig
 
h3_usb_c⁄fig
 
	g__öôd©a
 = {

379 .
Ÿg
 = 2,

381 #ifde‡
CONFIG_USB_GADGET_OMAP


382 .
	ghmc_mode
 = 19,

383 #ñi‡ 
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

385 .
	ghmc_mode
 = 20,

388 .
	gpös
[1] = 3,

391 
om≠_mmc_c⁄fig
 
h3_mmc_c⁄fig
 
	g__öôd©a
 = {

392 .
mmc
[0] = {

393 .
íabÀd
 = 1,

394 .
	gpowî_pö
 = -1,

395 .
	gswôch_pö
 = 
OMAP_MPUIO
(1),

399 
om≠_u¨t_c⁄fig
 
h3_u¨t_c⁄fig
 
	g__öôd©a
 = {

400 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

403 
om≠_lcd_c⁄fig
 
h3_lcd_c⁄fig
 
	g__öôd©a
 = {

404 .
˘æ_«me
 = "internal",

407 
om≠_bﬂrd_c⁄fig_kî√l
 
	gh3_c⁄fig
[] = {

408 { 
OMAP_TAG_USB
, &
h3_usb_c⁄fig
 },

409 { 
OMAP_TAG_MMC
, &
h3_mmc_c⁄fig
 },

410 { 
OMAP_TAG_UART
, &
h3_u¨t_c⁄fig
 },

411 { 
OMAP_TAG_LCD
, &
h3_lcd_c⁄fig
 },

414 
	#H3_NAND_RB_GPIO_PIN
 10

	)

416 
	$«nd_dev_ªady
(
«nd_∂©f‹m_d©a
 *
d©a
)

418  
	`om≠_gë_gpio_d©aö
(
H3_NAND_RB_GPIO_PIN
);

419 
	}
}

421 
__öô
 
	$h3_öô
()

431 
n‹_ªsour˚
.
íd
 =Ç‹_ªsour˚.
°¨t
 = 
	`om≠_cs3_phys
();

432 
n‹_ªsour˚
.
íd
 +
SZ_32M
 - 1;

434 
«nd_ªsour˚
.
íd
 =Ç™d_ªsour˚.
°¨t
 = 
OMAP_CS2B_PHYS
;

435 
«nd_ªsour˚
.
íd
 +
SZ_4K
 - 1;

436 i‡(!(
	`om≠_ªque°_gpio
(
H3_NAND_RB_GPIO_PIN
)))

437 
«nd_d©a
.
dev_ªady
 = 
«nd_dev_ªady
;

441 
	`om≠_cfg_ªg
(
V2_1710_GPIO10
);

443 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

444 
om≠_bﬂrd_c⁄fig
 = 
h3_c⁄fig
;

445 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
h3_c⁄fig
);

446 
	`om≠_£rül_öô
();

447 
	}
}

449 
__öô
 
	$h3_öô_smc91x
()

451 
	`om≠_cfg_ªg
(
W15_1710_GPIO40
);

452 i‡(
	`om≠_ªque°_gpio
(40) < 0) {

453 
	`¥ötk
("ErrorÑequesting gpio 40 for smc91x irq\n");

456 
	}
}

458 
__öô
 
	$h3_öô_úq
()

460 
	`om≠1_öô_comm⁄_hw
();

461 
	`om≠_öô_úq
();

462 
	`om≠_gpio_öô
();

463 
	`h3_öô_smc91x
();

464 
	}
}

466 
__öô
 
	$h3_m≠_io
()

468 
	`om≠1_m≠_comm⁄_io
();

469 
	}
}

471 
MACHINE_START
(
OMAP_H3
, "TI OMAP1710 H3 board")

473 .
	gphys_io
 = 0xfff00000,

474 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

475 .
	gboŸ_∑øms
 = 0x10000100,

476 .
	gm≠_io
 = 
h3_m≠_io
,

477 .
	göô_úq
 = 
h3_öô_úq
,

478 .
	göô_machöe
 = 
h3_öô
,

479 .
	gtimî
 = &
om≠_timî
,

480 
	gMACHINE_END


	@arch/arm/mach-omap1/board-innovator.c

19 
	~<löux/kî√l.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/mtd/mtd.h
>

24 
	~<löux/mtd/∑πôi⁄s.h
>

25 
	~<löux/öput.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/mach-ty≥s.h
>

29 
	~<asm/mach/¨ch.h
>

30 
	~<asm/mach/Êash.h
>

31 
	~<asm/mach/m≠.h
>

33 
	~<asm/¨ch/mux.h
>

34 
	~<asm/¨ch/Âga.h
>

35 
	~<asm/¨ch/gpio.h
>

36 
	~<asm/¨ch/tc.h
>

37 
	~<asm/¨ch/usb.h
>

38 
	~<asm/¨ch/key∑d.h
>

39 
	~<asm/¨ch/comm⁄.h
>

40 
	~<asm/¨ch/mcb•.h
>

41 
	~<asm/¨ch/om≠-Æß.h
>

43 
	gönov©‹_keym≠
[] = {

44 
KEY
(0, 0, 
KEY_F1
),

45 
KEY
(0, 3, 
KEY_DOWN
),

46 
KEY
(1, 1, 
KEY_F2
),

47 
KEY
(1, 2, 
KEY_RIGHT
),

48 
KEY
(2, 0, 
KEY_F3
),

49 
KEY
(2, 1, 
KEY_F4
),

50 
KEY
(2, 2, 
KEY_UP
),

51 
KEY
(3, 2, 
KEY_ENTER
),

52 
KEY
(3, 3, 
KEY_LEFT
),

56 
mtd_∑πôi⁄
 
	gönov©‹_∑πôi⁄s
[] = {

59 .
«me
 = "bootloader",

60 .
	goff£t
 = 0,

61 .
	gsize
 = 
SZ_128K
,

62 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

66 .
	g«me
 = "params",

67 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

68 .
	gsize
 = 
SZ_128K
,

69 .
	gmask_Êags
 = 0,

73 .
	g«me
 = "kernel",

74 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

75 .
	gsize
 = 
SZ_2M
,

76 .
	gmask_Êags
 = 0

80 .
	g«me
 = "rootfs",

81 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

82 .
	gsize
 = 
SZ_16M
 - 
SZ_2M
 - 2 * 
SZ_128K
,

83 .
	gmask_Êags
 = 0

87 .
	g«me
 = "filesystem",

88 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

89 .
	gsize
 = 
MTDPART_SIZ_FULL
,

90 .
	gmask_Êags
 = 0

94 
Êash_∂©f‹m_d©a
 
	gönov©‹_Êash_d©a
 = {

95 .
m≠_«me
 = "cfi_probe",

96 .
	gwidth
 = 2,

97 .
	g∑πs
 = 
önov©‹_∑πôi⁄s
,

98 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
önov©‹_∑πôi⁄s
),

101 
ªsour˚
 
	gönov©‹_Êash_ªsour˚
 = {

102 .
°¨t
 = 
OMAP_CS0_PHYS
,

103 .
	gíd
 = 
OMAP_CS0_PHYS
 + 
SZ_32M
 - 1,

104 .
	gÊags
 = 
IORESOURCE_MEM
,

107 
∂©f‹m_devi˚
 
	gönov©‹_Êash_devi˚
 = {

108 .
«me
 = "omapflash",

109 .
	gid
 = 0,

110 .
	gdev
 = {

111 .
∂©f‹m_d©a
 = &
önov©‹_Êash_d©a
,

113 .
	gnum_ªsour˚s
 = 1,

114 .
	gªsour˚
 = &
önov©‹_Êash_ªsour˚
,

117 
	#DEFAULT_BITPERSAMPLE
 16

	)

119 
om≠_mcb•_ªg_cfg
 
	gmcb•_ªgs
 = {

120 .
•¸2
 = 
FREE
 | 
FRST
 | 
GRST
 | 
XRST
 | 
XINTM
(3),

121 .
	g•¸1
 = 
RINTM
(3Ë| 
RRST
,

122 .
	gr¸2
 = 
RPHASE
 | 
RFRLEN2
(
OMAP_MCBSP_WORD_8
) |

123 
RWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
RDATDLY
(0),

124 .
	gr¸1
 = 
RFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
RWDLEN1
(
OMAP_MCBSP_WORD_16
),

125 .
	gx¸2
 = 
XPHASE
 | 
XFRLEN2
(
OMAP_MCBSP_WORD_8
) |

126 
XWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
XDATDLY
(0Ë| 
XFIG
,

127 .
	gx¸1
 = 
XFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
XWDLEN1
(
OMAP_MCBSP_WORD_16
),

128 .
	g§gr1
 = 
FWID
(
DEFAULT_BITPERSAMPLE
 - 1),

129 .
	g§gr2
 = 
GSYNC
 | 
CLKSP
 | 
FSGM
 | 
FPER
(
DEFAULT_BITPERSAMPLE
 * 2 - 1),

131 .
	gp¸0
 = 
CLKXP
 | 
CLKRP
,

134 
om≠_Æß_codec_c⁄fig
 
	gÆß_c⁄fig
 = {

135 .
«me
 = "OMAP Innovator AIC23",

136 .
	gmcb•_ªgs_Æß
 = &
mcb•_ªgs
,

137 .
	gcodec_c⁄figuª_dev
 = 
NULL
,

138 .
	gcodec_£t_ßm∂î©e
 = 
NULL
,

139 .
	gcodec_˛ock_£tup
 = 
NULL
,

140 .
	gcodec_˛ock_⁄
 = 
NULL
,

141 .
	gcodec_˛ock_off
 = 
NULL
,

142 .
	ggë_deÁu…_ßm∂î©e
 = 
NULL
,

145 
∂©f‹m_devi˚
 
	gönov©‹_mcb•1_devi˚
 = {

146 .
«me
 = "omap_alsa_mcbsp",

147 .
	gid
 = 1,

148 .
	gdev
 = {

149 .
∂©f‹m_d©a
 = &
Æß_c⁄fig
,

153 
ªsour˚
 
	gönov©‹_kp_ªsour˚s
[] = {

155 .
°¨t
 = 
INT_KEYBOARD
,

156 .
	gíd
 = 
INT_KEYBOARD
,

157 .
	gÊags
 = 
IORESOURCE_IRQ
,

161 
om≠_kp_∂©f‹m_d©a
 
	gönov©‹_kp_d©a
 = {

162 .
rows
 = 8,

163 .
	gcﬁs
 = 8,

164 .
	gkeym≠
 = 
önov©‹_keym≠
,

165 .
	gkeym≠size
 = 
ARRAY_SIZE
(
önov©‹_keym≠
),

166 .
	gdñay
 = 4,

169 
∂©f‹m_devi˚
 
	gönov©‹_kp_devi˚
 = {

170 .
«me
 = "omap-keypad",

171 .
	gid
 = -1,

172 .
	gdev
 = {

173 .
∂©f‹m_d©a
 = &
önov©‹_kp_d©a
,

175 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
önov©‹_kp_ªsour˚s
),

176 .
	gªsour˚
 = 
önov©‹_kp_ªsour˚s
,

180 #ifde‡
CONFIG_ARCH_OMAP15XX


182 
	~<löux/•i/•i.h
>

183 
	~<löux/•i/ads7846.h
>

187 
m≠_desc
 
	gönov©‹1510_io_desc
[] 
	g__öôd©a
 = {

189 .
vútuÆ
 = 
OMAP1510_FPGA_BASE
,

190 .
	gp‚
 = 
__phys_to_p‚
(
OMAP1510_FPGA_START
),

191 .
	gÀngth
 = 
OMAP1510_FPGA_SIZE
,

192 .
	gty≥
 = 
MT_DEVICE


196 
ªsour˚
 
	gönov©‹1510_smc91x_ªsour˚s
[] = {

198 .
°¨t
 = 
OMAP1510_FPGA_ETHR_START
,

199 .
	gíd
 = 
OMAP1510_FPGA_ETHR_START
 + 0xf,

200 .
	gÊags
 = 
IORESOURCE_MEM
,

203 .
°¨t
 = 
OMAP1510_INT_ETHER
,

204 .
	gíd
 = 
OMAP1510_INT_ETHER
,

205 .
	gÊags
 = 
IORESOURCE_IRQ
,

209 
∂©f‹m_devi˚
 
	gönov©‹1510_smc91x_devi˚
 = {

210 .
«me
 = "smc91x",

211 .
	gid
 = 0,

212 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
önov©‹1510_smc91x_ªsour˚s
),

213 .
	gªsour˚
 = 
önov©‹1510_smc91x_ªsour˚s
,

216 
∂©f‹m_devi˚
 
	gönov©‹1510_lcd_devi˚
 = {

217 .
«me
 = "lcd_inn1510",

218 .
	gid
 = -1,

221 
∂©f‹m_devi˚
 
	gönov©‹1510_•i_devi˚
 = {

222 .
«me
 = "spi_inn1510",

223 .
	gid
 = -1,

226 
∂©f‹m_devi˚
 *
	gönov©‹1510_devi˚s
[] 
	g__öôd©a
 = {

227 &
önov©‹_Êash_devi˚
,

228 &
önov©‹1510_smc91x_devi˚
,

229 &
önov©‹_mcb•1_devi˚
,

230 &
önov©‹_kp_devi˚
,

231 &
önov©‹1510_lcd_devi˚
,

232 &
önov©‹1510_•i_devi˚
,

235 
	$önov©‹_gë_≥ndown_°©e
()

237  !(
	`Âga_ªad
(
OMAP1510_FPGA_TOUCHSCREEN
) & (1 << 5));

238 
	}
}

240 c⁄° 
ads7846_∂©f‹m_d©a
 
	gönov©‹1510_ts_öfo
 = {

241 .
modñ
 = 7846,

242 .
	gvªf_dñay_u£cs
 = 100,

243 .
	gx_∂©e_ohms
 = 419,

244 .
	gy_∂©e_ohms
 = 486,

245 .
	ggë_≥ndown_°©e
 = 
önov©‹_gë_≥ndown_°©e
,

248 
•i_bﬂrd_öfo
 
__öôd©a
 
	gönov©‹1510_bﬂrdöfo
[] = { {

250 .
modÆüs
 = "ads7846",

251 .
	g∂©f‹m_d©a
 = &
önov©‹1510_ts_öfo
,

252 .
	gúq
 = 
OMAP1510_INT_FPGA_TS
,

253 .
	gmax_•ìd_hz
 = 120000

255 .
	gbus_num
 = 10,

256 .
	gchù_£À˘
 = 0,

261 #ifde‡
CONFIG_ARCH_OMAP16XX


263 
ªsour˚
 
	gönov©‹1610_smc91x_ªsour˚s
[] = {

265 .
°¨t
 = 
INNOVATOR1610_ETHR_START
,

266 .
	gíd
 = 
INNOVATOR1610_ETHR_START
 + 0xf,

267 .
	gÊags
 = 
IORESOURCE_MEM
,

270 .
°¨t
 = 
OMAP_GPIO_IRQ
(0),

271 .
	gíd
 = 
OMAP_GPIO_IRQ
(0),

272 .
	gÊags
 = 
IORESOURCE_IRQ
,

276 
∂©f‹m_devi˚
 
	gönov©‹1610_smc91x_devi˚
 = {

277 .
«me
 = "smc91x",

278 .
	gid
 = 0,

279 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
önov©‹1610_smc91x_ªsour˚s
),

280 .
	gªsour˚
 = 
önov©‹1610_smc91x_ªsour˚s
,

283 
∂©f‹m_devi˚
 
	gönov©‹1610_lcd_devi˚
 = {

284 .
«me
 = "inn1610_lcd",

285 .
	gid
 = -1,

288 
∂©f‹m_devi˚
 *
	gönov©‹1610_devi˚s
[] 
	g__öôd©a
 = {

289 &
önov©‹_Êash_devi˚
,

290 &
önov©‹1610_smc91x_devi˚
,

291 &
önov©‹_kp_devi˚
,

292 &
önov©‹1610_lcd_devi˚
,

297 
__öô
 
	$önov©‹_öô_smc91x
()

299 i‡(
	`˝u_is_om≠1510
()) {

300 
	`Âga_wrôe
(
	`Âga_ªad
(
OMAP1510_FPGA_RST
) & ~1,

301 
OMAP1510_FPGA_RST
);

302 
	`udñay
(750);

304 i‡((
	`om≠_ªque°_gpio
(0)) < 0) {

305 
	`¥ötk
("ErrorÑequesting gpio 0 for smc91x irq\n");

309 
	}
}

311 
__öô
 
	$önov©‹_öô_úq
()

313 
	`om≠1_öô_comm⁄_hw
();

314 
	`om≠_öô_úq
();

315 
	`om≠_gpio_öô
();

316 #ifde‡
CONFIG_ARCH_OMAP15XX


317 i‡(
	`˝u_is_om≠1510
()) {

318 
	`om≠1510_Âga_öô_úq
();

321 
	`önov©‹_öô_smc91x
();

322 
	}
}

324 #ifde‡
CONFIG_ARCH_OMAP15XX


325 
om≠_usb_c⁄fig
 
önov©‹1510_usb_c⁄fig
 
	g__öôd©a
 = {

327 .
hmc_mode
 = 4,

329 .
	gªgi°î_ho°
 = 1,

330 .
	gpös
[1] = 6,

331 .
	gpös
[2] = 6,

333 .
	gªgi°î_dev
 = 1,

334 .
	gpös
[0] = 2,

337 
om≠_lcd_c⁄fig
 
önov©‹1510_lcd_c⁄fig
 
	g__öôd©a
 = {

338 .
˘æ_«me
 = "internal",

342 #ifde‡
CONFIG_ARCH_OMAP16XX


343 
om≠_usb_c⁄fig
 
h2_usb_c⁄fig
 
	g__öôd©a
 = {

345 .
Ÿg
 = 2,

347 #ifdef 
CONFIG_USB_GADGET_OMAP


348 .
	ghmc_mode
 = 19,

350 #ñif 
deföed
(
CONFIG_USB_OHCI_HCD
Ë|| deföed(
CONFIG_USB_OHCI_HCD_MODULE
)

352 .
	ghmc_mode
 = 20,

355 .
	gpös
[1] = 3,

358 
om≠_lcd_c⁄fig
 
önov©‹1610_lcd_c⁄fig
 
	g__öôd©a
 = {

359 .
˘æ_«me
 = "internal",

363 
om≠_mmc_c⁄fig
 
önov©‹_mmc_c⁄fig
 
	g__öôd©a
 = {

364 .
mmc
 [0] = {

365 .
íabÀd
 = 1,

366 .
	gwúe4
 = 1,

367 .
	gwp_pö
 = 
OMAP_MPUIO
(3),

368 .
	gpowî_pö
 = -1,

369 .
	gswôch_pö
 = -1,

373 
om≠_u¨t_c⁄fig
 
önov©‹_u¨t_c⁄fig
 
	g__öôd©a
 = {

374 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

377 
om≠_bﬂrd_c⁄fig_kî√l
 
	gönov©‹_c⁄fig
[] = {

378 { 
OMAP_TAG_USB
, 
NULL
 },

379 { 
OMAP_TAG_LCD
, 
NULL
 },

380 { 
OMAP_TAG_MMC
, &
önov©‹_mmc_c⁄fig
 },

381 { 
OMAP_TAG_UART
, &
önov©‹_u¨t_c⁄fig
 },

384 
__öô
 
	$önov©‹_öô
()

386 #ifde‡
CONFIG_ARCH_OMAP15XX


387 i‡(
	`˝u_is_om≠1510
()) {

388 
	`∂©f‹m_add_devi˚s
(
önov©‹1510_devi˚s
, 
	`ARRAY_SIZE
(innovator1510_devices));

389 
	`•i_ªgi°î_bﬂrd_öfo
(
önov©‹1510_bﬂrdöfo
,

390 
	`ARRAY_SIZE
(
önov©‹1510_bﬂrdöfo
));

393 #ifde‡
CONFIG_ARCH_OMAP16XX


394 i‡(!
	`˝u_is_om≠1510
()) {

395 
	`∂©f‹m_add_devi˚s
(
önov©‹1610_devi˚s
, 
	`ARRAY_SIZE
(innovator1610_devices));

399 #ifde‡
CONFIG_ARCH_OMAP15XX


400 i‡(
	`˝u_is_om≠1510
()) {

401 
önov©‹_c⁄fig
[0].
d©a
 = &
önov©‹1510_usb_c⁄fig
;

402 
önov©‹_c⁄fig
[1].
d©a
 = &
önov©‹1510_lcd_c⁄fig
;

405 #ifde‡
CONFIG_ARCH_OMAP16XX


406 i‡(
	`˝u_is_om≠1610
()) {

407 
önov©‹_c⁄fig
[0].
d©a
 = &
h2_usb_c⁄fig
;

408 
önov©‹_c⁄fig
[1].
d©a
 = &
önov©‹1610_lcd_c⁄fig
;

411 
om≠_bﬂrd_c⁄fig
 = 
önov©‹_c⁄fig
;

412 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
önov©‹_c⁄fig
);

413 
	`om≠_£rül_öô
();

414 
	}
}

416 
__öô
 
	$önov©‹_m≠_io
()

418 
	`om≠1_m≠_comm⁄_io
();

420 #ifde‡
CONFIG_ARCH_OMAP15XX


421 i‡(
	`˝u_is_om≠1510
()) {

422 
	`iŸabÀ_öô
(
önov©‹1510_io_desc
, 
	`ARRAY_SIZE
(innovator1510_io_desc));

423 
	`udñay
(10);

426 
	`¥ötk
("Innovator FPGA Rev %d.%d Board Rev %d\n",

427 
	`Âga_ªad
(
OMAP1510_FPGA_REV_HIGH
),

428 
	`Âga_ªad
(
OMAP1510_FPGA_REV_LOW
),

429 
	`Âga_ªad
(
OMAP1510_FPGA_BOARD_REV
));

432 
	}
}

434 
MACHINE_START
(
OMAP_INNOVATOR
, "TI-Innovator")

436 .
	gphys_io
 = 0xfff00000,

437 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

438 .
	gboŸ_∑øms
 = 0x10000100,

439 .
	gm≠_io
 = 
önov©‹_m≠_io
,

440 .
	göô_úq
 = 
önov©‹_öô_úq
,

441 .
	göô_machöe
 = 
önov©‹_öô
,

442 .
	gtimî
 = &
om≠_timî
,

443 
	gMACHINE_END


	@arch/arm/mach-omap1/board-nokia770.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/∂©f‹m_devi˚.h
>

14 
	~<löux/öput.h
>

15 
	~<löux/˛k.h
>

17 
	~<löux/•i/•i.h
>

18 
	~<löux/•i/ads7846.h
>

19 
	~<löux/w‹kqueue.h
>

20 
	~<löux/dñay.h
>

22 
	~<asm/h¨dw¨e.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/mach/¨ch.h
>

25 
	~<asm/mach/m≠.h
>

27 
	~<asm/¨ch/gpio.h
>

28 
	~<asm/¨ch/mux.h
>

29 
	~<asm/¨ch/usb.h
>

30 
	~<asm/¨ch/bﬂrd.h
>

31 
	~<asm/¨ch/key∑d.h
>

32 
	~<asm/¨ch/comm⁄.h
>

33 
	~<asm/¨ch/d•_comm⁄.h
>

34 
	~<asm/¨ch/aic23.h
>

35 
	~<asm/¨ch/gpio.h
>

37 
__öô
 
	$om≠_nokü770_öô_úq
()

44 
	`om≠_wrôew
((
	`om≠_ªadw
(0xfffb5008) & ~2), 0xfffb5008);

46 
	`om≠_wrôew
((
	`om≠_ªadw
(0xfffb5004) & ~2), 0xfffb5004);

48 
	`om≠1_öô_comm⁄_hw
();

49 
	`om≠_öô_úq
();

50 
	}
}

52 
	gnokü770_keym≠
[] = {

53 
KEY
(0, 1, 
GROUP_0
 | 
KEY_UP
),

54 
KEY
(0, 2, 
GROUP_1
 | 
KEY_F5
),

55 
KEY
(1, 0, 
GROUP_0
 | 
KEY_LEFT
),

56 
KEY
(1, 1, 
GROUP_0
 | 
KEY_ENTER
),

57 
KEY
(1, 2, 
GROUP_0
 | 
KEY_RIGHT
),

58 
KEY
(2, 0, 
GROUP_1
 | 
KEY_ESC
),

59 
KEY
(2, 1, 
GROUP_0
 | 
KEY_DOWN
),

60 
KEY
(2, 2, 
GROUP_1
 | 
KEY_F4
),

61 
KEY
(3, 0, 
GROUP_2
 | 
KEY_F7
),

62 
KEY
(3, 1, 
GROUP_2
 | 
KEY_F8
),

63 
KEY
(3, 2, 
GROUP_2
 | 
KEY_F6
),

67 
ªsour˚
 
	gnokü770_kp_ªsour˚s
[] = {

69 .
°¨t
 = 
INT_KEYBOARD
,

70 .
	gíd
 = 
INT_KEYBOARD
,

71 .
	gÊags
 = 
IORESOURCE_IRQ
,

75 
om≠_kp_∂©f‹m_d©a
 
	gnokü770_kp_d©a
 = {

76 .
rows
 = 8,

77 .
	gcﬁs
 = 8,

78 .
	gkeym≠
 = 
nokü770_keym≠
,

79 .
	gkeym≠size
 = 
ARRAY_SIZE
(
nokü770_keym≠
),

80 .
	gdñay
 = 4,

83 
∂©f‹m_devi˚
 
	gnokü770_kp_devi˚
 = {

84 .
«me
 = "omap-keypad",

85 .
	gid
 = -1,

86 .
	gdev
 = {

87 .
∂©f‹m_d©a
 = &
nokü770_kp_d©a
,

89 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
nokü770_kp_ªsour˚s
),

90 .
	gªsour˚
 = 
nokü770_kp_ªsour˚s
,

93 
∂©f‹m_devi˚
 *
	gnokü770_devi˚s
[] 
	g__öôd©a
 = {

94 &
nokü770_kp_devi˚
,

97 
ads7846_∂©f‹m_d©a
 
nokü770_ads7846_∂©f‹m_d©a
 
	g__öôd©a
 = {

98 .
x_max
 = 0x0fff,

99 .
	gy_max
 = 0x0fff,

100 .
	gx_∂©e_ohms
 = 180,

101 .
	g¥essuª_max
 = 255,

102 .
	gdeboun˚_max
 = 10,

103 .
	gdeboun˚_tﬁ
 = 3,

106 
•i_bﬂrd_öfo
 
	gnokü770_•i_bﬂrd_öfo
[] 
	g__öôd©a
 = {

108 .
modÆüs
 = "lcd_mipid",

109 .
	gbus_num
 = 2,

110 .
	gchù_£À˘
 = 3,

111 .
	gmax_•ìd_hz
 = 12000000,

114 .
modÆüs
 = "ads7846",

115 .
	gbus_num
 = 2,

116 .
	gchù_£À˘
 = 0,

117 .
	gmax_•ìd_hz
 = 2500000,

118 .
	gúq
 = 
OMAP_GPIO_IRQ
(15),

119 .
	g∂©f‹m_d©a
 = &
nokü770_ads7846_∂©f‹m_d©a
,

126 
om≠_usb_c⁄fig
 
nokü770_usb_c⁄fig
 
	g__öôd©a
 = {

127 .
Ÿg
 = 1,

128 .
	gªgi°î_ho°
 = 1,

129 .
	gªgi°î_dev
 = 1,

130 .
	ghmc_mode
 = 16,

131 .
	gpös
[0] = 6,

134 
om≠_mmc_c⁄fig
 
nokü770_mmc_c⁄fig
 
	g__öôd©a
 = {

135 .
mmc
[0] = {

136 .
íabÀd
 = 0,

137 .
	gwúe4
 = 0,

138 .
	gwp_pö
 = -1,

139 .
	gpowî_pö
 = -1,

140 .
	gswôch_pö
 = -1,

142 .
	gmmc
[1] = {

143 .
íabÀd
 = 0,

144 .
	gwúe4
 = 0,

145 .
	gwp_pö
 = -1,

146 .
	gpowî_pö
 = -1,

147 .
	gswôch_pö
 = -1,

151 
om≠_bﬂrd_c⁄fig_kî√l
 
	gnokü770_c⁄fig
[] = {

152 { 
OMAP_TAG_USB
, 
NULL
 },

153 { 
OMAP_TAG_MMC
, &
nokü770_mmc_c⁄fig
 },

159 
	#HEADPHONE_GPIO
 14

	)

160 
	#AMPLIFIER_CTRL_GPIO
 58

	)

162 
˛k
 *
	gd•x‹_ck
;

163 
DECLARE_MUTEX
(
audio_pwr_£m
);

176 
	gaudio_pwr_°©e
 = -1;

181 
	$nokü770_audio_pwr_up
()

183 
	`˛k_íabÀ
(
d•x‹_ck
);

186 
	`év320aic23_powî_up
();

188 i‡(
	`om≠_gë_gpio_d©aö
(
HEADPHONE_GPIO
))

190 
	`om≠_£t_gpio_d©aout
(
AMPLIFIER_CTRL_GPIO
, 1);

193 
	`¥ötk
("HP connected\n");

194 
	}
}

196 
	$codec_dñayed_powî_down
(
w‹k_°ru˘
 *
w‹k
)

198 
	`down
(&
audio_pwr_£m
);

199 i‡(
audio_pwr_°©e
 == -1)

200 
	`év320aic23_powî_down
();

201 
	`˛k_dißbÀ
(
d•x‹_ck
);

202 
	`up
(&
audio_pwr_£m
);

203 
	}
}

205 
DECLARE_DELAYED_WORK
(
codec_powî_down_w‹k
, 
codec_dñayed_powî_down
);

207 
	$nokü770_audio_pwr_down
()

210 
	`om≠_£t_gpio_d©aout
(
AMPLIFIER_CTRL_GPIO
, 0);

213 
	`scheduÀ_dñayed_w‹k
(&
codec_powî_down_w‹k
, 
HZ
 / 20);

214 
	}
}

216 
	$nokü770_audio_pwr_up_ªque°
(
°age
)

218 
	`down
(&
audio_pwr_£m
);

219 i‡(
audio_pwr_°©e
 == -1)

220 
	`nokü770_audio_pwr_up
();

222 
audio_pwr_°©e
 = 0;

223 
	`up
(&
audio_pwr_£m
);

224 
	}
}

226 
	$nokü770_audio_pwr_down_ªque°
(
°age
)

228 
	`down
(&
audio_pwr_£m
);

229 
°age
) {

231 i‡(
audio_pwr_°©e
 == 0)

232 
audio_pwr_°©e
 = 1;

235 i‡(
audio_pwr_°©e
 == 1) {

236 
	`nokü770_audio_pwr_down
();

237 
audio_pwr_°©e
 = -1;

241 
	`up
(&
audio_pwr_£m
);

242 
	}
}

244 
__öô
 
	$om≠_nokü770_öô
()

246 
nokü770_c⁄fig
[0].
d©a
 = &
nokü770_usb_c⁄fig
;

248 
	`∂©f‹m_add_devi˚s
(
nokü770_devi˚s
, 
	`ARRAY_SIZE
(nokia770_devices));

249 
	`•i_ªgi°î_bﬂrd_öfo
(
nokü770_•i_bﬂrd_öfo
,

250 
	`ARRAY_SIZE
(
nokü770_•i_bﬂrd_öfo
));

251 
om≠_bﬂrd_c⁄fig
 = 
nokü770_c⁄fig
;

252 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
nokü770_c⁄fig
);

253 
	`om≠_£rül_öô
();

254 
om≠_d•_audio_pwr_up_ªque°
 = 
nokü770_audio_pwr_up_ªque°
;

255 
om≠_d•_audio_pwr_down_ªque°
 = 
nokü770_audio_pwr_down_ªque°
;

256 
d•x‹_ck
 = 
	`˛k_gë
(0, "dspxor_ck");

257 
	}
}

259 
__öô
 
	$om≠_nokü770_m≠_io
()

261 
	`om≠1_m≠_comm⁄_io
();

262 
	}
}

264 
MACHINE_START
(
NOKIA770
, "Nokia 770")

265 .
	gphys_io
 = 0xfff00000,

266 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

267 .
	gboŸ_∑øms
 = 0x10000100,

268 .
	gm≠_io
 = 
om≠_nokü770_m≠_io
,

269 .
	göô_úq
 = 
om≠_nokü770_öô_úq
,

270 .
	göô_machöe
 = 
om≠_nokü770_öô
,

271 .
	gtimî
 = &
om≠_timî
,

272 
	gMACHINE_END


	@arch/arm/mach-omap1/board-osk.c

29 
	~<löux/kî√l.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/∂©f‹m_devi˚.h
>

32 
	~<löux/úq.h
>

33 
	~<löux/öãºu±.h
>

35 
	~<löux/mtd/mtd.h
>

36 
	~<löux/mtd/∑πôi⁄s.h
>

38 
	~<asm/h¨dw¨e.h
>

39 
	~<asm/mach-ty≥s.h
>

40 
	~<asm/mach/¨ch.h
>

41 
	~<asm/mach/m≠.h
>

42 
	~<asm/mach/Êash.h
>

44 
	~<asm/¨ch/gpio.h
>

45 
	~<asm/¨ch/usb.h
>

46 
	~<asm/¨ch/mux.h
>

47 
	~<asm/¨ch/tc.h
>

48 
	~<asm/¨ch/comm⁄.h
>

49 
	~<asm/¨ch/mcb•.h
>

50 
	~<asm/¨ch/om≠-Æß.h
>

52 
mtd_∑πôi⁄
 
	gosk_∑πôi⁄s
[] = {

55 .
«me
 = "bootloader",

56 .
	goff£t
 = 0,

57 .
	gsize
 = 
SZ_128K
,

58 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

62 .
	g«me
 = "params",

63 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

64 .
	gsize
 = 
SZ_128K
,

65 .
	gmask_Êags
 = 0,

67 .
	g«me
 = "kernel",

68 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

69 .
	gsize
 = 
SZ_2M
,

70 .
	gmask_Êags
 = 0

72 .
	g«me
 = "filesystem",

73 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

74 .
	gsize
 = 
MTDPART_SIZ_FULL
,

75 .
	gmask_Êags
 = 0

79 
Êash_∂©f‹m_d©a
 
	gosk_Êash_d©a
 = {

80 .
m≠_«me
 = "cfi_probe",

81 .
	gwidth
 = 2,

82 .
	g∑πs
 = 
osk_∑πôi⁄s
,

83 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
osk_∑πôi⁄s
),

86 
ªsour˚
 
	gosk_Êash_ªsour˚
 = {

88 .
Êags
 = 
IORESOURCE_MEM
,

91 
∂©f‹m_devi˚
 
	gosk5912_Êash_devi˚
 = {

92 .
«me
 = "omapflash",

93 .
	gid
 = 0,

94 .
	gdev
 = {

95 .
∂©f‹m_d©a
 = &
osk_Êash_d©a
,

97 .
	gnum_ªsour˚s
 = 1,

98 .
	gªsour˚
 = &
osk_Êash_ªsour˚
,

101 
ªsour˚
 
	gosk5912_smc91x_ªsour˚s
[] = {

103 .
°¨t
 = 
OMAP_OSK_ETHR_START
,

104 .
	gíd
 = 
OMAP_OSK_ETHR_START
 + 0xf,

105 .
	gÊags
 = 
IORESOURCE_MEM
,

108 .
°¨t
 = 
OMAP_GPIO_IRQ
(0),

109 .
	gíd
 = 
OMAP_GPIO_IRQ
(0),

110 .
	gÊags
 = 
IORESOURCE_IRQ
,

114 
∂©f‹m_devi˚
 
	gosk5912_smc91x_devi˚
 = {

115 .
«me
 = "smc91x",

116 .
	gid
 = -1,

117 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
osk5912_smc91x_ªsour˚s
),

118 .
	gªsour˚
 = 
osk5912_smc91x_ªsour˚s
,

121 
ªsour˚
 
	gosk5912_cf_ªsour˚s
[] = {

123 .
°¨t
 = 
OMAP_GPIO_IRQ
(62),

124 .
	gíd
 = 
OMAP_GPIO_IRQ
(62),

125 .
	gÊags
 = 
IORESOURCE_IRQ
,

129 
∂©f‹m_devi˚
 
	gosk5912_cf_devi˚
 = {

130 .
«me
 = "omap_cf",

131 .
	gid
 = -1,

132 .
	gdev
 = {

133 .
∂©f‹m_d©a
 = (*) 2 ,

135 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
osk5912_cf_ªsour˚s
),

136 .
	gªsour˚
 = 
osk5912_cf_ªsour˚s
,

139 
	#DEFAULT_BITPERSAMPLE
 16

	)

141 
om≠_mcb•_ªg_cfg
 
	gmcb•_ªgs
 = {

142 .
•¸2
 = 
FREE
 | 
FRST
 | 
GRST
 | 
XRST
 | 
XINTM
(3),

143 .
	g•¸1
 = 
RINTM
(3Ë| 
RRST
,

144 .
	gr¸2
 = 
RPHASE
 | 
RFRLEN2
(
OMAP_MCBSP_WORD_8
) |

145 
RWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
RDATDLY
(0),

146 .
	gr¸1
 = 
RFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
RWDLEN1
(
OMAP_MCBSP_WORD_16
),

147 .
	gx¸2
 = 
XPHASE
 | 
XFRLEN2
(
OMAP_MCBSP_WORD_8
) |

148 
XWDLEN2
(
OMAP_MCBSP_WORD_16
Ë| 
XDATDLY
(0Ë| 
XFIG
,

149 .
	gx¸1
 = 
XFRLEN1
(
OMAP_MCBSP_WORD_8
Ë| 
XWDLEN1
(
OMAP_MCBSP_WORD_16
),

150 .
	g§gr1
 = 
FWID
(
DEFAULT_BITPERSAMPLE
 - 1),

151 .
	g§gr2
 = 
GSYNC
 | 
CLKSP
 | 
FSGM
 | 
FPER
(
DEFAULT_BITPERSAMPLE
 * 2 - 1),

153 .
	gp¸0
 = 
CLKXP
 | 
CLKRP
,

156 
om≠_Æß_codec_c⁄fig
 
	gÆß_c⁄fig
 = {

157 .
«me
 = "OSK AIC23",

158 .
	gmcb•_ªgs_Æß
 = &
mcb•_ªgs
,

159 .
	gcodec_c⁄figuª_dev
 = 
NULL
,

160 .
	gcodec_£t_ßm∂î©e
 = 
NULL
,

161 .
	gcodec_˛ock_£tup
 = 
NULL
,

162 .
	gcodec_˛ock_⁄
 = 
NULL
,

163 .
	gcodec_˛ock_off
 = 
NULL
,

164 .
	ggë_deÁu…_ßm∂î©e
 = 
NULL
,

167 
∂©f‹m_devi˚
 
	gosk5912_mcb•1_devi˚
 = {

168 .
«me
 = "omap_alsa_mcbsp",

169 .
	gid
 = 1,

170 .
	gdev
 = {

171 .
∂©f‹m_d©a
 = &
Æß_c⁄fig
,

175 
∂©f‹m_devi˚
 *
	gosk5912_devi˚s
[] 
	g__öôd©a
 = {

176 &
osk5912_Êash_devi˚
,

177 &
osk5912_smc91x_devi˚
,

178 &
osk5912_cf_devi˚
,

179 &
osk5912_mcb•1_devi˚
,

182 
__öô
 
	$osk_öô_smc91x
()

184 i‡((
	`om≠_ªque°_gpio
(0)) < 0) {

185 
	`¥ötk
("ErrorÑequesting gpio 0 for smc91x irq\n");

190 
	`EMIFS_CCS
(1) |= 0x3;

191 
	}
}

193 
__öô
 
	$osk_öô_cf
()

195 
	`om≠_cfg_ªg
(
M7_1610_GPIO62
);

196 i‡((
	`om≠_ªque°_gpio
(62)) < 0) {

197 
	`¥ötk
("ErrorÑequesting gpio 62 for CF irq\n");

201 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(62), 
IRQT_FALLING
);

202 
	}
}

204 
__öô
 
	$osk_öô_úq
()

206 
	`om≠1_öô_comm⁄_hw
();

207 
	`om≠_öô_úq
();

208 
	`om≠_gpio_öô
();

209 
	`osk_öô_smc91x
();

210 
	`osk_öô_cf
();

211 
	}
}

213 
om≠_usb_c⁄fig
 
osk_usb_c⁄fig
 
	g__öôd©a
 = {

218 #ifdef 
CONFIG_USB_GADGET_OMAP


219 .
ªgi°î_dev
 = 1,

220 .
	ghmc_mode
 = 0,

222 .
	gªgi°î_ho°
 = 1,

223 .
	ghmc_mode
 = 16,

224 .
	grwc
 = 1,

226 .
	gpös
[0] = 2,

229 
om≠_u¨t_c⁄fig
 
osk_u¨t_c⁄fig
 
	g__öôd©a
 = {

230 .
íabÀd_u¨ts
 = (1 << 0),

233 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


234 
om≠_lcd_c⁄fig
 
osk_lcd_c⁄fig
 
	g__öôd©a
 = {

235 .
˘æ_«me
 = "internal",

239 
om≠_bﬂrd_c⁄fig_kî√l
 
	gosk_c⁄fig
[] = {

240 { 
OMAP_TAG_USB
, &
osk_usb_c⁄fig
 },

241 { 
OMAP_TAG_UART
, &
osk_u¨t_c⁄fig
 },

242 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


243 { 
OMAP_TAG_LCD
, &
osk_lcd_c⁄fig
 },

247 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


249 
	~<löux/öput.h
>

250 
	~<löux/•i/•i.h
>

251 
	~<löux/•i/ads7846.h
>

253 
	~<asm/¨ch/key∑d.h
>

255 c⁄° 
	gosk_keym≠
[] = {

257 
KEY
(0, 0, 
KEY_F1
),

258 
KEY
(0, 3, 
KEY_UP
),

259 
KEY
(1, 1, 
KEY_LEFTCTRL
),

260 
KEY
(1, 2, 
KEY_LEFT
),

261 
KEY
(2, 0, 
KEY_SPACE
),

262 
KEY
(2, 1, 
KEY_ESC
),

263 
KEY
(2, 2, 
KEY_DOWN
),

264 
KEY
(3, 2, 
KEY_ENTER
),

265 
KEY
(3, 3, 
KEY_RIGHT
),

269 
om≠_kp_∂©f‹m_d©a
 
	gosk_kp_d©a
 = {

270 .
rows
 = 8,

271 .
	gcﬁs
 = 8,

272 .
	gkeym≠
 = (*Ë
osk_keym≠
,

273 .
	gkeym≠size
 = 
ARRAY_SIZE
(
osk_keym≠
),

274 .
	gdñay
 = 9,

277 
ªsour˚
 
	gosk5912_kp_ªsour˚s
[] = {

279 .
°¨t
 = 
INT_KEYBOARD
,

280 .
	gíd
 = 
INT_KEYBOARD
,

281 .
	gÊags
 = 
IORESOURCE_IRQ
,

285 
∂©f‹m_devi˚
 
	gosk5912_kp_devi˚
 = {

286 .
«me
 = "omap-keypad",

287 .
	gid
 = -1,

288 .
	gdev
 = {

289 .
∂©f‹m_d©a
 = &
osk_kp_d©a
,

291 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
osk5912_kp_ªsour˚s
),

292 .
	gªsour˚
 = 
osk5912_kp_ªsour˚s
,

295 
∂©f‹m_devi˚
 
	gosk5912_lcd_devi˚
 = {

296 .
«me
 = "lcd_osk",

297 .
	gid
 = -1,

300 
∂©f‹m_devi˚
 *
	gmi°øl_devi˚s
[] 
	g__öôd©a
 = {

301 &
osk5912_kp_devi˚
,

302 &
osk5912_lcd_devi˚
,

305 
	$mi°øl_gë_≥ndown_°©e
()

307  !
	`om≠_gë_gpio_d©aö
(4);

308 
	}
}

310 c⁄° 
ads7846_∂©f‹m_d©a
 
	gmi°øl_ts_öfo
 = {

311 .
modñ
 = 7846,

312 .
	gvªf_dñay_u£cs
 = 100,

313 .
	gx_∂©e_ohms
 = 419,

314 .
	gy_∂©e_ohms
 = 486,

315 .
	ggë_≥ndown_°©e
 = 
mi°øl_gë_≥ndown_°©e
,

318 
•i_bﬂrd_öfo
 
__öôd©a
 
	gmi°øl_bﬂrdöfo
[] = { {

320 .
modÆüs
 = "ads7846",

321 .
	g∂©f‹m_d©a
 = &
mi°øl_ts_öfo
,

322 .
	gúq
 = 
OMAP_GPIO_IRQ
(4),

323 .
	gmax_•ìd_hz
 = 120000

325 .
	gbus_num
 = 2,

326 .
	gchù_£À˘
 = 0,

329 #ifdef 
CONFIG_PM


330 
úqªtu∫_t


331 
	$osk_mi°øl_wake_öãºu±
(
úq
, *
ign‹ed
)

333  
IRQ_HANDLED
;

334 
	}
}

337 
__öô
 
	$osk_mi°øl_öô
()

346 
	`om≠_cfg_ªg
(
P20_1610_GPIO4
);

347 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(4), 
IRQT_FALLING
);

348 
	`•i_ªgi°î_bﬂrd_öfo
(
mi°øl_bﬂrdöfo
,

349 
	`ARRAY_SIZE
(
mi°øl_bﬂrdöfo
));

352 
	`om≠_cfg_ªg
(
N15_1610_MPUIO2
);

353 i‡(
	`om≠_ªque°_gpio
(
	`OMAP_MPUIO
(2)) == 0) {

354 
ªt
 = 0;

355 
	`om≠_£t_gpio_dúe˘i⁄
(
	`OMAP_MPUIO
(2), 1);

356 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(
	`OMAP_MPUIO
(2)), 
IRQT_RISING
);

357 #ifdef 
CONFIG_PM


361 
ªt
 = 
	`ªque°_úq
(
	`OMAP_GPIO_IRQ
(
	`OMAP_MPUIO
(2)),

362 &
osk_mi°øl_wake_öãºu±
,

363 
IRQF_SHARED
, "mistral_wakeup",

364 &
osk_mi°øl_wake_öãºu±
);

365 i‡(
ªt
 != 0) {

366 
	`om≠_‰ì_gpio
(
	`OMAP_MPUIO
(2));

367 
	`¥ötk
(
KERN_ERR
 "OSK+Mistral:Ço wakeup irq, %d?\n",

368 
ªt
);

370 
	`íabÀ_úq_wake
(
	`OMAP_GPIO_IRQ
(
	`OMAP_MPUIO
(2)));

373 
	`¥ötk
(
KERN_ERR
 "OSK+Mistral: wakeup button isáwol\n");

375 
	`∂©f‹m_add_devi˚s
(
mi°øl_devi˚s
, 
	`ARRAY_SIZE
(mistral_devices));

376 
	}
}

378 
__öô
 
	$osk_mi°øl_öô
(Ë{ 
	}
}

381 
	#EMIFS_CS3_VAL
 (0x88013141)

	)

383 
__öô
 
	$osk_öô
()

390 i‡(
	`EMIFS_CCS
(3Ë!
EMIFS_CS3_VAL
)

391 
	`EMIFS_CCS
(3Ë
EMIFS_CS3_VAL
;

393 
osk_Êash_ªsour˚
.
íd
 = osk_Êash_ªsour˚.
°¨t
 = 
	`om≠_cs3_phys
();

394 
osk_Êash_ªsour˚
.
íd
 +
SZ_32M
 - 1;

395 
	`∂©f‹m_add_devi˚s
(
osk5912_devi˚s
, 
	`ARRAY_SIZE
(osk5912_devices));

396 
om≠_bﬂrd_c⁄fig
 = 
osk_c⁄fig
;

397 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
osk_c⁄fig
);

398 
USB_TRANSCEIVER_CTRL_REG
 |= (3 << 1);

400 
	`om≠_£rül_öô
();

401 
	`osk_mi°øl_öô
();

402 
	}
}

404 
__öô
 
	$osk_m≠_io
()

406 
	`om≠1_m≠_comm⁄_io
();

407 
	}
}

409 
MACHINE_START
(
OMAP_OSK
, "TI-OSK")

411 .
	gphys_io
 = 0xfff00000,

412 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

413 .
	gboŸ_∑øms
 = 0x10000100,

414 .
	gm≠_io
 = 
osk_m≠_io
,

415 .
	göô_úq
 = 
osk_öô_úq
,

416 .
	göô_machöe
 = 
osk_öô
,

417 .
	gtimî
 = &
om≠_timî
,

418 
	gMACHINE_END


	@arch/arm/mach-omap1/board-palmte.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<löux/nŸifõr.h
>

22 
	~<löux/˛k.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/mach-ty≥s.h
>

26 
	~<asm/mach/¨ch.h
>

27 
	~<asm/mach/m≠.h
>

29 
	~<asm/¨ch/gpio.h
>

30 
	~<asm/¨ch/mux.h
>

31 
	~<asm/¨ch/usb.h
>

32 
	~<asm/¨ch/bﬂrd.h
>

33 
	~<asm/¨ch/comm⁄.h
>

35 
__öô
 
	$om≠_gíîic_öô_úq
()

37 
	`om≠1_öô_comm⁄_hw
();

38 
	`om≠_öô_úq
();

39 
	}
}

41 
∂©f‹m_devi˚
 
	g∑lmã_lcd_devi˚
 = {

42 .
«me
 = "lcd_palmte",

43 .
	gid
 = -1,

46 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

47 &
∑lmã_lcd_devi˚
,

50 
om≠_usb_c⁄fig
 
∑lmã_usb_c⁄fig
 
	g__öôd©a
 = {

51 .
ªgi°î_dev
 = 1,

52 .
	ghmc_mode
 = 0,

53 .
	gpös
[0] = 3,

56 
om≠_mmc_c⁄fig
 
∑lmã_mmc_c⁄fig
 
	g__öôd©a
 = {

57 .
mmc
 [0] = {

58 .
íabÀd
 = 1,

59 .
	gwúe4
 = 1,

60 .
	gwp_pö
 = 
OMAP_MPUIO
(3),

61 .
	gpowî_pö
 = -1,

62 .
	gswôch_pö
 = -1,

66 
om≠_lcd_c⁄fig
 
∑lmã_lcd_c⁄fig
 
	g__öôd©a
 = {

67 .
˘æ_«me
 = "internal",

70 
om≠_bﬂrd_c⁄fig_kî√l
 
	g∑lmã_c⁄fig
[] = {

71 { 
OMAP_TAG_USB
, &
∑lmã_usb_c⁄fig
 },

72 { 
OMAP_TAG_MMC
, &
∑lmã_mmc_c⁄fig
 },

73 { 
OMAP_TAG_LCD
, &
∑lmã_lcd_c⁄fig
 },

76 
__öô
 
	$om≠_gíîic_öô
()

78 
om≠_bﬂrd_c⁄fig
 = 
∑lmã_c⁄fig
;

79 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
∑lmã_c⁄fig
);

81 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

82 
	}
}

84 
__öô
 
	$om≠_gíîic_m≠_io
()

86 
	`om≠1_m≠_comm⁄_io
();

87 
	}
}

89 
MACHINE_START
(
OMAP_PALMTE
, "OMAP310 based Palm Tungsten E")

90 .
	gphys_io
 = 0xfff00000,

91 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

92 .
	gboŸ_∑øms
 = 0x10000100,

93 .
	gm≠_io
 = 
om≠_gíîic_m≠_io
,

94 .
	göô_úq
 = 
om≠_gíîic_öô_úq
,

95 .
	göô_machöe
 = 
om≠_gíîic_öô
,

96 .
	gtimî
 = &
om≠_timî
,

97 
	gMACHINE_END


	@arch/arm/mach-omap1/board-perseus2.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/mtd/mtd.h
>

19 
	~<löux/mtd/«nd.h
>

20 
	~<löux/mtd/∑πôi⁄s.h
>

21 
	~<löux/öput.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/Êash.h
>

27 
	~<asm/mach/m≠.h
>

29 
	~<asm/¨ch/tc.h
>

30 
	~<asm/¨ch/gpio.h
>

31 
	~<asm/¨ch/mux.h
>

32 
	~<asm/¨ch/Âga.h
>

33 
	~<asm/¨ch/key∑d.h
>

34 
	~<asm/¨ch/comm⁄.h
>

35 
	~<asm/¨ch/bﬂrd.h
>

37 
	gp2_keym≠
[] = {

38 
KEY
(0,0,
KEY_UP
),

39 
KEY
(0,1,
KEY_RIGHT
),

40 
KEY
(0,2,
KEY_LEFT
),

41 
KEY
(0,3,
KEY_DOWN
),

42 
KEY
(0,4,
KEY_CENTER
),

43 
KEY
(0,5,
KEY_0_5
),

44 
KEY
(1,0,
KEY_SOFT2
),

45 
KEY
(1,1,
KEY_SEND
),

46 
KEY
(1,2,
KEY_END
),

47 
KEY
(1,3,
KEY_VOLUMEDOWN
),

48 
KEY
(1,4,
KEY_VOLUMEUP
),

49 
KEY
(1,5,
KEY_RECORD
),

50 
KEY
(2,0,
KEY_SOFT1
),

51 
KEY
(2,1,
KEY_3
),

52 
KEY
(2,2,
KEY_6
),

53 
KEY
(2,3,
KEY_9
),

54 
KEY
(2,4,
KEY_SHARP
),

55 
KEY
(2,5,
KEY_2_5
),

56 
KEY
(3,0,
KEY_BACK
),

57 
KEY
(3,1,
KEY_2
),

58 
KEY
(3,2,
KEY_5
),

59 
KEY
(3,3,
KEY_8
),

60 
KEY
(3,4,
KEY_0
),

61 
KEY
(3,5,
KEY_HEADSETHOOK
),

62 
KEY
(4,0,
KEY_HOME
),

63 
KEY
(4,1,
KEY_1
),

64 
KEY
(4,2,
KEY_4
),

65 
KEY
(4,3,
KEY_7
),

66 
KEY
(4,4,
KEY_STAR
),

67 
KEY
(4,5,
KEY_POWER
),

71 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

73 .
°¨t
 = 
H2P2_DBG_FPGA_ETHR_START
,

74 .
	gíd
 = 
H2P2_DBG_FPGA_ETHR_START
 + 0xf,

75 .
	gÊags
 = 
IORESOURCE_MEM
,

78 .
°¨t
 = 
INT_730_MPU_EXT_NIRQ
,

79 .
	gíd
 = 0,

80 .
	gÊags
 = 
IORESOURCE_IRQ
,

84 
mtd_∑πôi⁄
 
	gn‹_∑πôi⁄s
[] = {

87 .
«me
 = "bootloader",

88 .
	goff£t
 = 0,

89 .
	gsize
 = 
SZ_128K
,

90 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

94 .
	g«me
 = "params",

95 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

96 .
	gsize
 = 
SZ_128K
,

97 .
	gmask_Êags
 = 0,

101 .
	g«me
 = "kernel",

102 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

103 .
	gsize
 = 
SZ_2M
,

104 .
	gmask_Êags
 = 0

108 .
	g«me
 = "rootfs",

109 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

110 .
	gsize
 = 
MTDPART_SIZ_FULL
,

111 .
	gmask_Êags
 = 0

115 
Êash_∂©f‹m_d©a
 
	gn‹_d©a
 = {

116 .
m≠_«me
 = "cfi_probe",

117 .
	gwidth
 = 2,

118 .
	g∑πs
 = 
n‹_∑πôi⁄s
,

119 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
n‹_∑πôi⁄s
),

122 
ªsour˚
 
	gn‹_ªsour˚
 = {

123 .
°¨t
 = 
OMAP_CS0_PHYS
,

124 .
	gíd
 = 
OMAP_CS0_PHYS
 + 
SZ_32M
 - 1,

125 .
	gÊags
 = 
IORESOURCE_MEM
,

128 
∂©f‹m_devi˚
 
	gn‹_devi˚
 = {

129 .
«me
 = "omapflash",

130 .
	gid
 = 0,

131 .
	gdev
 = {

132 .
∂©f‹m_d©a
 = &
n‹_d©a
,

134 .
	gnum_ªsour˚s
 = 1,

135 .
	gªsour˚
 = &
n‹_ªsour˚
,

138 
«nd_∂©f‹m_d©a
 
	g«nd_d©a
 = {

139 .
›ti⁄s
 = 
NAND_SAMSUNG_LP_OPTIONS
,

142 
ªsour˚
 
	g«nd_ªsour˚
 = {

143 .
°¨t
 = 
OMAP_CS3_PHYS
,

144 .
	gíd
 = 
OMAP_CS3_PHYS
 + 
SZ_4K
 - 1,

145 .
	gÊags
 = 
IORESOURCE_MEM
,

148 
∂©f‹m_devi˚
 
	g«nd_devi˚
 = {

149 .
«me
 = "omapnand",

150 .
	gid
 = 0,

151 .
	gdev
 = {

152 .
∂©f‹m_d©a
 = &
«nd_d©a
,

154 .
	gnum_ªsour˚s
 = 1,

155 .
	gªsour˚
 = &
«nd_ªsour˚
,

158 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

159 .
«me
 = "smc91x",

160 .
	gid
 = 0,

161 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

162 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

165 
ªsour˚
 
	gkp_ªsour˚s
[] = {

167 .
°¨t
 = 
INT_730_MPUIO_KEYPAD
,

168 .
	gíd
 = 
INT_730_MPUIO_KEYPAD
,

169 .
	gÊags
 = 
IORESOURCE_IRQ
,

173 
om≠_kp_∂©f‹m_d©a
 
	gkp_d©a
 = {

174 .
rows
 = 8,

175 .
	gcﬁs
 = 8,

176 .
	gkeym≠
 = 
p2_keym≠
,

177 .
	gkeym≠size
 = 
ARRAY_SIZE
(
p2_keym≠
),

178 .
	gdñay
 = 4,

179 .
	gdboun˚
 = 1,

182 
∂©f‹m_devi˚
 
	gkp_devi˚
 = {

183 .
«me
 = "omap-keypad",

184 .
	gid
 = -1,

185 .
	gdev
 = {

186 .
∂©f‹m_d©a
 = &
kp_d©a
,

188 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
kp_ªsour˚s
),

189 .
	gªsour˚
 = 
kp_ªsour˚s
,

192 
∂©f‹m_devi˚
 
	glcd_devi˚
 = {

193 .
«me
 = "lcd_p2",

194 .
	gid
 = -1,

197 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

198 &
n‹_devi˚
,

199 &
«nd_devi˚
,

200 &
smc91x_devi˚
,

201 &
kp_devi˚
,

202 &
lcd_devi˚
,

205 
	#P2_NAND_RB_GPIO_PIN
 62

	)

207 
	$«nd_dev_ªady
(
«nd_∂©f‹m_d©a
 *
d©a
)

209  
	`om≠_gë_gpio_d©aö
(
P2_NAND_RB_GPIO_PIN
);

210 
	}
}

212 
om≠_u¨t_c⁄fig
 
≥r£us2_u¨t_c⁄fig
 
	g__öôd©a
 = {

213 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1)),

216 
om≠_lcd_c⁄fig
 
≥r£us2_lcd_c⁄fig
 
	g__öôd©a
 = {

217 .
˘æ_«me
 = "internal",

220 
om≠_bﬂrd_c⁄fig_kî√l
 
	g≥r£us2_c⁄fig
[] = {

221 { 
OMAP_TAG_UART
, &
≥r£us2_u¨t_c⁄fig
 },

222 { 
OMAP_TAG_LCD
, &
≥r£us2_lcd_c⁄fig
 },

225 
__öô
 
	$om≠_≥r£us2_öô
()

227 i‡(!(
	`om≠_ªque°_gpio
(
P2_NAND_RB_GPIO_PIN
)))

228 
«nd_d©a
.
dev_ªady
 = 
«nd_dev_ªady
;

230 
	`om≠_cfg_ªg
(
L3_1610_FLASH_CS2B_OE
);

231 
	`om≠_cfg_ªg
(
M8_1610_FLASH_CS2B_WE
);

233 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

235 
om≠_bﬂrd_c⁄fig
 = 
≥r£us2_c⁄fig
;

236 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
≥r£us2_c⁄fig
);

237 
	`om≠_£rül_öô
();

238 
	}
}

240 
__öô
 
	$≥r£us2_öô_smc91x
()

242 
	`Âga_wrôe
(1, 
H2P2_DBG_FPGA_LAN_RESET
);

243 
	`mdñay
(50);

244 
	`Âga_wrôe
(
	`Âga_ªad
(
H2P2_DBG_FPGA_LAN_RESET
) & ~1,

245 
H2P2_DBG_FPGA_LAN_RESET
);

246 
	`mdñay
(50);

247 
	}
}

249 
__öô
 
	$om≠_≥r£us2_öô_úq
()

251 
	`om≠1_öô_comm⁄_hw
();

252 
	`om≠_öô_úq
();

253 
	`om≠_gpio_öô
();

254 
	`≥r£us2_öô_smc91x
();

255 
	}
}

257 
m≠_desc
 
	gom≠_≥r£us2_io_desc
[] 
	g__öôd©a
 = {

259 .
vútuÆ
 = 
H2P2_DBG_FPGA_BASE
,

260 .
	gp‚
 = 
__phys_to_p‚
(
H2P2_DBG_FPGA_START
),

261 .
	gÀngth
 = 
H2P2_DBG_FPGA_SIZE
,

262 .
	gty≥
 = 
MT_DEVICE


266 
__öô
 
	$om≠_≥r£us2_m≠_io
()

268 
	`om≠1_m≠_comm⁄_io
();

269 
	`iŸabÀ_öô
(
om≠_≥r£us2_io_desc
,

270 
	`ARRAY_SIZE
(
om≠_≥r£us2_io_desc
));

277 
	`om≠_wrôew
(
	`om≠_ªadw
(
OMAP730_DSP_M_CTL
) & ~1, OMAP730_DSP_M_CTL);

288 
	`om≠_wrôñ
(0x0000fff3, 
OMAP730_FLASH_CFG_0
);

289 
	`om≠_wrôñ
(0x00000088, 
OMAP730_FLASH_ACFG_0
);

295 
	`om≠_wrôñ
(0x0000fff3, 
OMAP730_FLASH_CFG_1
);

296 
	`om≠_wrôñ
(0x00000000, 
OMAP730_FLASH_ACFG_1
);

302 
	`om≠_wrôñ
(
	`om≠_ªadl
(
OMAP730_IO_CONF_9
) & 0x1FFFFFFF, OMAP730_IO_CONF_9);

303 
	}
}

305 
MACHINE_START
(
OMAP_PERSEUS2
, "OMAP730 Perseus2")

307 .
	gphys_io
 = 0xfff00000,

308 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

309 .
	gboŸ_∑øms
 = 0x10000100,

310 .
	gm≠_io
 = 
om≠_≥r£us2_m≠_io
,

311 .
	göô_úq
 = 
om≠_≥r£us2_öô_úq
,

312 .
	göô_machöe
 = 
om≠_≥r£us2_öô
,

313 .
	gtimî
 = &
om≠_timî
,

314 
	gMACHINE_END


	@arch/arm/mach-omap1/board-voiceblue.c

15 
	~<löux/dñay.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/nŸifõr.h
>

21 
	~<löux/ªboŸ.h
>

22 
	~<löux/£rül_8250.h
>

23 
	~<löux/£rül_ªg.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/mach/¨ch.h
>

28 
	~<asm/mach/Êash.h
>

29 
	~<asm/mach/m≠.h
>

31 
	~<asm/¨ch/comm⁄.h
>

32 
	~<asm/¨ch/gpio.h
>

33 
	~<asm/¨ch/mux.h
>

34 
	~<asm/¨ch/tc.h
>

35 
	~<asm/¨ch/usb.h
>

37 
om≠_öô_time
();

38 
om≠_gpio_öô
();

40 
∂©_£rül8250_p‹t
 
	gvoi˚blue_p‹ts
[] = {

42 .
m≠ba£
 = ()(
OMAP_CS1_PHYS
 + 0x40000),

43 .
	gúq
 = 
OMAP_GPIO_IRQ
(12),

44 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
,

45 .
	giŸy≥
 = 
UPIO_MEM
,

46 .
	gªgshi·
 = 1,

47 .
	gu¨t˛k
 = 3686400,

50 .
	gm≠ba£
 = ()(
OMAP_CS1_PHYS
 + 0x50000),

51 .
	gúq
 = 
OMAP_GPIO_IRQ
(13),

52 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
,

53 .
	giŸy≥
 = 
UPIO_MEM
,

54 .
	gªgshi·
 = 1,

55 .
	gu¨t˛k
 = 3686400,

58 .
	gm≠ba£
 = ()(
OMAP_CS1_PHYS
 + 0x60000),

59 .
	gúq
 = 
OMAP_GPIO_IRQ
(14),

60 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
,

61 .
	giŸy≥
 = 
UPIO_MEM
,

62 .
	gªgshi·
 = 1,

63 .
	gu¨t˛k
 = 3686400,

66 .
	gm≠ba£
 = ()(
OMAP_CS1_PHYS
 + 0x70000),

67 .
	gúq
 = 
OMAP_GPIO_IRQ
(15),

68 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
,

69 .
	giŸy≥
 = 
UPIO_MEM
,

70 .
	gªgshi·
 = 1,

71 .
	gu¨t˛k
 = 3686400,

76 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

77 .
«me
 = "serial8250",

78 .
	gid
 = 
PLAT8250_DEV_PLATFORM1
,

79 .
	gdev
 = {

80 .
∂©f‹m_d©a
 = 
voi˚blue_p‹ts
,

84 
__öô
 
	$ext_u¨t_öô
()

86  
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

87 
	}
}

88 
¨ch_öôˇŒ
(
ext_u¨t_öô
);

90 
Êash_∂©f‹m_d©a
 
	gvoi˚blue_Êash_d©a
 = {

91 .
m≠_«me
 = "cfi_probe",

92 .
	gwidth
 = 2,

95 
ªsour˚
 
	gvoi˚blue_Êash_ªsour˚
 = {

96 .
°¨t
 = 
OMAP_CS0_PHYS
,

97 .
	gíd
 = 
OMAP_CS0_PHYS
 + 
SZ_32M
 - 1,

98 .
	gÊags
 = 
IORESOURCE_MEM
,

101 
∂©f‹m_devi˚
 
	gvoi˚blue_Êash_devi˚
 = {

102 .
«me
 = "omapflash",

103 .
	gid
 = 0,

104 .
	gdev
 = {

105 .
∂©f‹m_d©a
 = &
voi˚blue_Êash_d©a
,

107 .
	gnum_ªsour˚s
 = 1,

108 .
	gªsour˚
 = &
voi˚blue_Êash_ªsour˚
,

111 
ªsour˚
 
	gvoi˚blue_smc91x_ªsour˚s
[] = {

113 .
°¨t
 = 
OMAP_CS2_PHYS
 + 0x300,

114 .
	gíd
 = 
OMAP_CS2_PHYS
 + 0x300 + 16,

115 .
	gÊags
 = 
IORESOURCE_MEM
,

118 .
°¨t
 = 
OMAP_GPIO_IRQ
(8),

119 .
	gíd
 = 
OMAP_GPIO_IRQ
(8),

120 .
	gÊags
 = 
IORESOURCE_IRQ
,

124 
∂©f‹m_devi˚
 
	gvoi˚blue_smc91x_devi˚
 = {

125 .
«me
 = "smc91x",

126 .
	gid
 = 0,

127 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
voi˚blue_smc91x_ªsour˚s
),

128 .
	gªsour˚
 = 
voi˚blue_smc91x_ªsour˚s
,

131 
∂©f‹m_devi˚
 *
	gvoi˚blue_devi˚s
[] 
	g__öôd©a
 = {

132 &
voi˚blue_Êash_devi˚
,

133 &
voi˚blue_smc91x_devi˚
,

136 
om≠_usb_c⁄fig
 
voi˚blue_usb_c⁄fig
 
	g__öôd©a
 = {

137 .
hmc_mode
 = 3,

138 .
	gªgi°î_ho°
 = 1,

139 .
	gªgi°î_dev
 = 1,

140 .
	gpös
[0] = 2,

141 .
	gpös
[1] = 6,

142 .
	gpös
[2] = 6,

145 
om≠_mmc_c⁄fig
 
voi˚blue_mmc_c⁄fig
 
	g__öôd©a
 = {

146 .
mmc
[0] = {

147 .
íabÀd
 = 1,

148 .
	gpowî_pö
 = 2,

149 .
	gswôch_pö
 = -1,

153 
om≠_u¨t_c⁄fig
 
voi˚blue_u¨t_c⁄fig
 
	g__öôd©a
 = {

154 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

157 
om≠_bﬂrd_c⁄fig_kî√l
 
	gvoi˚blue_c⁄fig
[] = {

158 { 
OMAP_TAG_USB
, &
voi˚blue_usb_c⁄fig
 },

159 { 
OMAP_TAG_MMC
, &
voi˚blue_mmc_c⁄fig
 },

160 { 
OMAP_TAG_UART
, &
voi˚blue_u¨t_c⁄fig
 },

163 
__öô
 
	$voi˚blue_öô_úq
()

165 
	`om≠1_öô_comm⁄_hw
();

166 
	`om≠_öô_úq
();

167 
	`om≠_gpio_öô
();

168 
	}
}

170 
__öô
 
	$voi˚blue_öô
()

173 
	`om≠_ªque°_gpio
(0);

175 
	`om≠_ªque°_gpio
(7);

176 
	`om≠_£t_gpio_dúe˘i⁄
(7, 0);

177 
	`om≠_£t_gpio_d©aout
(7, 1);

178 
	`udñay
(2);

179 
	`om≠_£t_gpio_d©aout
(7, 0);

180 
	`mdñay
(50);

182 
	`om≠_ªque°_gpio
(8);

184 
	`om≠_ªque°_gpio
(6);

185 
	`om≠_£t_gpio_dúe˘i⁄
(6, 0);

186 
	`om≠_£t_gpio_d©aout
(6, 0);

188 
	`om≠_ªque°_gpio
(12);

189 
	`om≠_ªque°_gpio
(13);

190 
	`om≠_ªque°_gpio
(14);

191 
	`om≠_ªque°_gpio
(15);

192 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(12), 
IRQT_RISING
);

193 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(13), 
IRQT_RISING
);

194 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(14), 
IRQT_RISING
);

195 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(15), 
IRQT_RISING
);

197 
	`∂©f‹m_add_devi˚s
(
voi˚blue_devi˚s
, 
	`ARRAY_SIZE
(voiceblue_devices));

198 
om≠_bﬂrd_c⁄fig
 = 
voi˚blue_c⁄fig
;

199 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
voi˚blue_c⁄fig
);

200 
	`om≠_£rül_öô
();

204 
	`om≠_wrôeb
(0x00, 
OMAP_LPG1_LCR
);

205 
	`om≠_wrôeb
(0x00, 
OMAP_LPG1_PMR
);

206 
	}
}

208 
__öô
 
	$voi˚blue_m≠_io
()

210 
	`om≠1_m≠_comm⁄_io
();

211 
	}
}

213 
	#MACHINE_PANICED
 1

	)

214 
	#MACHINE_REBOOTING
 2

	)

215 
	#MACHINE_REBOOT
 4

	)

216 
	gmachöe_°©e
;

218 
	$∑nic_evít
(
nŸifõr_block
 *
this
, 
evít
,

219 *
±r
)

221 i‡(
	`ã°_™d_£t_bô
(
MACHINE_PANICED
, &
machöe_°©e
))

222  
NOTIFY_DONE
;

225 
	`om≠_wrôeb
(0x78, 
OMAP_LPG1_LCR
);

226 
	`om≠_wrôeb
(0x01, 
OMAP_LPG1_PMR
);

228  
NOTIFY_DONE
;

229 
	}
}

231 
nŸifõr_block
 
	g∑nic_block
 = {

232 .
nŸifõr_ˇŒ
 = 
∑nic_evít
,

235 
__öô
 
	$voi˚blue_£tup
()

238 
	`nŸifõr_chaö_ªgi°î
(&
∑nic_nŸifõr_li°
, &
∑nic_block
);

241 
	}
}

242 
po°c‹e_öôˇŒ
(
voi˚blue_£tup
);

244 
	gwdt_gpio_°©e
;

246 
	$voi˚blue_wdt_íabÀ
()

248 
	`om≠_£t_gpio_dúe˘i⁄
(0, 0);

249 
	`om≠_£t_gpio_d©aout
(0, 0);

250 
	`om≠_£t_gpio_d©aout
(0, 1);

251 
	`om≠_£t_gpio_d©aout
(0, 0);

252 
wdt_gpio_°©e
 = 0;

253 
	}
}

255 
	$voi˚blue_wdt_dißbÀ
()

257 
	`om≠_£t_gpio_d©aout
(0, 0);

258 
	`om≠_£t_gpio_d©aout
(0, 1);

259 
	`om≠_£t_gpio_d©aout
(0, 0);

260 
	`om≠_£t_gpio_dúe˘i⁄
(0, 1);

261 
	}
}

263 
	$voi˚blue_wdt_pög
()

265 i‡(
	`ã°_bô
(
MACHINE_REBOOT
, &
machöe_°©e
))

268 
wdt_gpio_°©e
 = !wdt_gpio_state;

269 
	`om≠_£t_gpio_d©aout
(0, 
wdt_gpio_°©e
);

270 
	}
}

272 
	$voi˚blue_ª£t
()

274 
	`£t_bô
(
MACHINE_REBOOT
, &
machöe_°©e
);

275 
	`voi˚blue_wdt_íabÀ
();

277 
	}
}

279 
EXPORT_SYMBOL
(
voi˚blue_wdt_íabÀ
);

280 
EXPORT_SYMBOL
(
voi˚blue_wdt_dißbÀ
);

281 
EXPORT_SYMBOL
(
voi˚blue_wdt_pög
);

283 
MACHINE_START
(
VOICEBLUE
, "VoiceBlue OMAP5910")

285 .
	gphys_io
 = 0xfff00000,

286 .
	gio_pg_off°
 = ((0xfef00000) >> 18) & 0xfffc,

287 .
	gboŸ_∑øms
 = 0x10000100,

288 .
	gm≠_io
 = 
voi˚blue_m≠_io
,

289 .
	göô_úq
 = 
voi˚blue_öô_úq
,

290 .
	göô_machöe
 = 
voi˚blue_öô
,

291 .
	gtimî
 = &
om≠_timî
,

292 
	gMACHINE_END


	@arch/arm/mach-omap1/clock.c

15 
	~<löux/moduÀ.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/li°.h
>

18 
	~<löux/î∫o.h
>

19 
	~<löux/îr.h
>

20 
	~<löux/˛k.h
>

22 
	~<asm/io.h
>

23 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/¨ch/˝u.h
>

26 
	~<asm/¨ch/usb.h
>

27 
	~<asm/¨ch/˛ock.h
>

28 
	~<asm/¨ch/§am.h
>

30 
	~"˛ock.h
"

32 
__u32
 
	g¨m_idÀ˘1_mask
;

38 
	$om≠1_w©chdog_ªˇlc
(
˛k
 * clk)

40 
˛k
->
øã
 = clk->
∑ª¡
->rate / 14;

41 
	}
}

43 
	$om≠1_u¨t_ªˇlc
(
˛k
 * clk)

45 
vÆ
 = 
	`om≠_ªadl
(
˛k
->
íabÀ_ªg
);

46 i‡(
vÆ
 & 
˛k
->
íabÀ_bô
)

47 
˛k
->
øã
 = 48000000;

49 
˛k
->
øã
 = 12000000;

50 
	}
}

52 
	$om≠1_˛k_íabÀ_d•_domaö
(
˛k
 *clk)

54 
ªtvÆ
;

56 
ªtvÆ
 = 
	`om≠1_˛k_íabÀ
(&
≠i_ck
.
˛k
);

57 i‡(!
ªtvÆ
) {

58 
ªtvÆ
 = 
	`om≠1_˛k_íabÀ_gíîic
(
˛k
);

59 
	`om≠1_˛k_dißbÀ
(&
≠i_ck
.
˛k
);

62  
ªtvÆ
;

63 
	}
}

65 
	$om≠1_˛k_dißbÀ_d•_domaö
(
˛k
 *clk)

67 i‡(
	`om≠1_˛k_íabÀ
(&
≠i_ck
.
˛k
) == 0) {

68 
	`om≠1_˛k_dißbÀ_gíîic
(
˛k
);

69 
	`om≠1_˛k_dißbÀ
(&
≠i_ck
.
˛k
);

71 
	}
}

73 
	$om≠1_˛k_íabÀ_u¨t_fun˘i⁄Æ
(
˛k
 *clk)

75 
ªt
;

76 
u¨t_˛k
 *
u˛k
;

78 
ªt
 = 
	`om≠1_˛k_íabÀ_gíîic
(
˛k
);

79 i‡(
ªt
 == 0) {

81 
u˛k
 = (
u¨t_˛k
 *)
˛k
;

82 
	`om≠_wrôeb
((
	`om≠_ªadb
(
u˛k
->
sysc_addr
) & ~0x10) | 8,

83 
u˛k
->
sysc_addr
);

86  
ªt
;

87 
	}
}

89 
	$om≠1_˛k_dißbÀ_u¨t_fun˘i⁄Æ
(
˛k
 *clk)

91 
u¨t_˛k
 *
u˛k
;

94 
u˛k
 = (
u¨t_˛k
 *)
˛k
;

95 
	`om≠_wrôeb
((
	`om≠_ªadb
(
u˛k
->
sysc_addr
) & ~0x18), uclk->sysc_addr);

97 
	`om≠1_˛k_dißbÀ_gíîic
(
˛k
);

98 
	}
}

100 
	$om≠1_˛k_Ælow_idÀ
(
˛k
 *clk)

102 
¨m_idÀ˘1_˛k
 * 
i˛k
 = (¨m_idÀ˘1_˛k *)
˛k
;

104 i‡(!(
˛k
->
Êags
 & 
CLOCK_IDLE_CONTROL
))

107 i‡(
i˛k
->
no_idÀ_cou¡
 > 0 && !(--iclk->no_idle_count))

108 
¨m_idÀ˘1_mask
 |1 << 
i˛k
->
idÀ˘_shi·
;

109 
	}
}

111 
	$om≠1_˛k_díy_idÀ
(
˛k
 *clk)

113 
¨m_idÀ˘1_˛k
 * 
i˛k
 = (¨m_idÀ˘1_˛k *)
˛k
;

115 i‡(!(
˛k
->
Êags
 & 
CLOCK_IDLE_CONTROL
))

118 i‡(
i˛k
->
no_idÀ_cou¡
++ == 0)

119 
¨m_idÀ˘1_mask
 &~(1 << 
i˛k
->
idÀ˘_shi·
);

120 
	}
}

122 
__u16
 
	$vîify_ck˘l_vÆue
(
__u16
 
√wvÆ
)

137 
__u8
 
≥r_exp
;

138 
__u8
 
lcd_exp
;

139 
__u8
 
¨m_exp
;

140 
__u8
 
d•_exp
;

141 
__u8
 
tc_exp
;

142 
__u8
 
d•mmu_exp
;

144 
≥r_exp
 = (
√wvÆ
 >> 
CKCTL_PERDIV_OFFSET
) & 3;

145 
lcd_exp
 = (
√wvÆ
 >> 
CKCTL_LCDDIV_OFFSET
) & 3;

146 
¨m_exp
 = (
√wvÆ
 >> 
CKCTL_ARMDIV_OFFSET
) & 3;

147 
d•_exp
 = (
√wvÆ
 >> 
CKCTL_DSPDIV_OFFSET
) & 3;

148 
tc_exp
 = (
√wvÆ
 >> 
CKCTL_TCDIV_OFFSET
) & 3;

149 
d•mmu_exp
 = (
√wvÆ
 >> 
CKCTL_DSPMMUDIV_OFFSET
) & 3;

151 i‡(
d•mmu_exp
 < 
d•_exp
)

152 
d•mmu_exp
 = 
d•_exp
;

153 i‡(
d•mmu_exp
 > 
d•_exp
+1)

154 
d•mmu_exp
 = 
d•_exp
+1;

155 i‡(
tc_exp
 < 
¨m_exp
)

156 
tc_exp
 = 
¨m_exp
;

157 i‡(
tc_exp
 < 
d•mmu_exp
)

158 
tc_exp
 = 
d•mmu_exp
;

159 i‡(
tc_exp
 > 
lcd_exp
)

160 
lcd_exp
 = 
tc_exp
;

161 i‡(
tc_exp
 > 
≥r_exp
)

162 
≥r_exp
 = 
tc_exp
;

164 
√wvÆ
 &= 0xf000;

165 
√wvÆ
 |
≥r_exp
 << 
CKCTL_PERDIV_OFFSET
;

166 
√wvÆ
 |
lcd_exp
 << 
CKCTL_LCDDIV_OFFSET
;

167 
√wvÆ
 |
¨m_exp
 << 
CKCTL_ARMDIV_OFFSET
;

168 
√wvÆ
 |
d•_exp
 << 
CKCTL_DSPDIV_OFFSET
;

169 
√wvÆ
 |
tc_exp
 << 
CKCTL_TCDIV_OFFSET
;

170 
√wvÆ
 |
d•mmu_exp
 << 
CKCTL_DSPMMUDIV_OFFSET
;

172  
√wvÆ
;

173 
	}
}

175 
	$ˇlc_ds‹_exp
(
˛k
 *˛k, 
øã
)

188 
ªÆøã
;

189 
˛k
 * 
∑ª¡
;

190 
ds‹_exp
;

192 i‡(
	`u∆ikñy
(!(
˛k
->
Êags
 & 
RATE_CKCTL
)))

193  -
EINVAL
;

195 
∑ª¡
 = 
˛k
->parent;

196 i‡(
	`u∆ikñy
(
∑ª¡
 == 0))

197  -
EIO
;

199 
ªÆøã
 = 
∑ª¡
->
øã
;

200 
ds‹_exp
=0; dsor_exp<4; dsor_exp++) {

201 i‡(
ªÆøã
 <
øã
)

204 
ªÆøã
 /= 2;

207  
ds‹_exp
;

208 
	}
}

210 
	$om≠1_ck˘l_ªˇlc
(
˛k
 * clk)

212 
ds‹
;

215 
ds‹
 = 1 << (3 & (
	`om≠_ªadw
(
ARM_CKCTL
Ë>> 
˛k
->
øã_off£t
));

217 i‡(
	`u∆ikñy
(
˛k
->
øã
 =˛k->
∑ª¡
->øã / 
ds‹
))

219 
˛k
->
øã
 = clk->
∑ª¡
->øã / 
ds‹
;

221 i‡(
	`u∆ikñy
(
˛k
->
Êags
 & 
RATE_PROPAGATES
))

222 
	`¥›ag©e_øã
(
˛k
);

223 
	}
}

225 
	$om≠1_ck˘l_ªˇlc_d•_domaö
(
˛k
 * clk)

227 
ds‹
;

236 
	`om≠1_˛k_íabÀ
(&
≠i_ck
.
˛k
);

237 
ds‹
 = 1 << (3 & (
	`__øw_ªadw
(
DSP_CKCTL
Ë>> 
˛k
->
øã_off£t
));

238 
	`om≠1_˛k_dißbÀ
(&
≠i_ck
.
˛k
);

240 i‡(
	`u∆ikñy
(
˛k
->
øã
 =˛k->
∑ª¡
->øã / 
ds‹
))

242 
˛k
->
øã
 = clk->
∑ª¡
->øã / 
ds‹
;

244 i‡(
	`u∆ikñy
(
˛k
->
Êags
 & 
RATE_PROPAGATES
))

245 
	`¥›ag©e_øã
(
˛k
);

246 
	}
}

249 
	$om≠1_£À˘_èbÀ_øã
(
˛k
 * clk, 
øã
)

252 
mpu_øã
 * 
±r
;

254 i‡(
˛k
 !&
vútuÆ_ck_mpu
)

255  -
EINVAL
;

257 
±r
 = 
øã_èbÀ
;Öå->
øã
;Ötr++) {

258 i‡(
±r
->
xèl
 !
ck_ªf
.
øã
)

262 i‡(
	`likñy
(
ck_d∂l1
.
øã
!=0Ë&& 
±r
->
∂l_øã
 != ck_dpll1.rate)

266 i‡(
±r
->
øã
 <=Ñate)

270 i‡(!
±r
->
øã
)

271  -
EINVAL
;

278 i‡(
	`˝u_is_om≠730
())

279 
	`om≠_§am_ª¥ogøm_˛ock
(
±r
->
d∂l˘l_vÆ
,Öå->
ck˘l_vÆ
 | 0x2000);

281 
	`om≠_§am_ª¥ogøm_˛ock
(
±r
->
d∂l˘l_vÆ
,Öå->
ck˘l_vÆ
);

283 
ck_d∂l1
.
øã
 = 
±r
->
∂l_øã
;

284 
	`¥›ag©e_øã
(&
ck_d∂l1
);

286 
	}
}

288 
	$om≠1_˛k_£t_øã_d•_domaö
(
˛k
 *˛k, 
øã
)

290 
ªt
 = -
EINVAL
;

291 
ds‹_exp
;

292 
__u16
 
ªgvÆ
;

294 i‡(
˛k
->
Êags
 & 
RATE_CKCTL
) {

295 
ds‹_exp
 = 
	`ˇlc_ds‹_exp
(
˛k
, 
øã
);

296 i‡(
ds‹_exp
 > 3)

297 
ds‹_exp
 = -
EINVAL
;

298 i‡(
ds‹_exp
 < 0)

299  
ds‹_exp
;

301 
ªgvÆ
 = 
	`__øw_ªadw
(
DSP_CKCTL
);

302 
ªgvÆ
 &~(3 << 
˛k
->
øã_off£t
);

303 
ªgvÆ
 |
ds‹_exp
 << 
˛k
->
øã_off£t
;

304 
	`__øw_wrôew
(
ªgvÆ
, 
DSP_CKCTL
);

305 
˛k
->
øã
 = clk->
∑ª¡
->øã / (1 << 
ds‹_exp
);

306 
ªt
 = 0;

309 i‡(
	`u∆ikñy
(
ªt
 =0 && (
˛k
->
Êags
 & 
RATE_PROPAGATES
)))

310 
	`¥›ag©e_øã
(
˛k
);

312  
ªt
;

313 
	}
}

315 
	$om≠1_round_to_èbÀ_øã
(
˛k
 * clk, 
øã
)

318 
mpu_øã
 * 
±r
;

319 
highe°_øã
;

321 i‡(
˛k
 !&
vútuÆ_ck_mpu
)

322  -
EINVAL
;

324 
highe°_øã
 = -
EINVAL
;

326 
±r
 = 
øã_èbÀ
;Öå->
øã
;Ötr++) {

327 i‡(
±r
->
xèl
 !
ck_ªf
.
øã
)

330 
highe°_øã
 = 
±r
->
øã
;

333 i‡(
±r
->
øã
 <=Ñate)

337  
highe°_øã
;

338 
	}
}

340 
	$ˇlc_ext_ds‹
(
øã
)

342 
ds‹
;

353 
ds‹
 = 2; dsor < 96; ++dsor) {

354 i‡((
ds‹
 & 1) && dsor > 8)

356 i‡(
øã
 >96000000 / 
ds‹
)

359  
ds‹
;

360 
	}
}

363 
	$om≠1_£t_u¨t_øã
(
˛k
 * clk, 
øã
)

365 
vÆ
;

367 
vÆ
 = 
	`om≠_ªadl
(
˛k
->
íabÀ_ªg
);

368 i‡(
øã
 == 12000000)

369 
vÆ
 &~(1 << 
˛k
->
íabÀ_bô
);

370 i‡(
øã
 == 48000000)

371 
vÆ
 |(1 << 
˛k
->
íabÀ_bô
);

373  -
EINVAL
;

374 
	`om≠_wrôñ
(
vÆ
, 
˛k
->
íabÀ_ªg
);

375 
˛k
->
øã
 =Ñate;

378 
	}
}

381 
	$om≠1_£t_ext_˛k_øã
(
˛k
 * clk, 
øã
)

383 
ds‹
;

384 
__u16
 
øtio_bôs
;

386 
ds‹
 = 
	`ˇlc_ext_ds‹
(
øã
);

387 
˛k
->
øã
 = 96000000 / 
ds‹
;

388 i‡(
ds‹
 > 8)

389 
øtio_bôs
 = ((
ds‹
 - 8) / 2 + 6) << 2;

391 
øtio_bôs
 = (
ds‹
 - 2) << 2;

393 
øtio_bôs
 |
	`om≠_ªadw
(
˛k
->
íabÀ_ªg
) & ~0xfd;

394 
	`om≠_wrôew
(
øtio_bôs
, 
˛k
->
íabÀ_ªg
);

397 
	}
}

399 
	$om≠1_round_ext_˛k_øã
(
˛k
 * clk, 
øã
)

401  96000000 / 
	`ˇlc_ext_ds‹
(
øã
);

402 
	}
}

404 
	$om≠1_öô_ext_˛k
(
˛k
 * clk)

406 
ds‹
;

407 
__u16
 
øtio_bôs
;

410 
øtio_bôs
 = 
	`om≠_ªadw
(
˛k
->
íabÀ_ªg
) & ~1;

411 
	`om≠_wrôew
(
øtio_bôs
, 
˛k
->
íabÀ_ªg
);

413 
øtio_bôs
 = (ratio_bits & 0xfc) >> 2;

414 i‡(
øtio_bôs
 > 6)

415 
ds‹
 = (
øtio_bôs
 - 6) * 2 + 8;

417 
ds‹
 = 
øtio_bôs
 + 2;

419 
˛k
-> 
øã
 = 96000000 / 
ds‹
;

420 
	}
}

422 
	$om≠1_˛k_íabÀ
(
˛k
 *clk)

424 
ªt
 = 0;

425 i‡(
˛k
->
u£cou¡
++ == 0) {

426 i‡(
	`likñy
(
˛k
->
∑ª¡
)) {

427 
ªt
 = 
	`om≠1_˛k_íabÀ
(
˛k
->
∑ª¡
);

429 i‡(
	`u∆ikñy
(
ªt
 != 0)) {

430 
˛k
->
u£cou¡
--;

431  
ªt
;

434 i‡(
˛k
->
Êags
 & 
CLOCK_NO_IDLE_PARENT
)

435 
	`om≠1_˛k_díy_idÀ
(
˛k
->
∑ª¡
);

438 
ªt
 = 
˛k
->
	`íabÀ
(clk);

440 i‡(
	`u∆ikñy
(
ªt
 !0Ë&& 
˛k
->
∑ª¡
) {

441 
	`om≠1_˛k_dißbÀ
(
˛k
->
∑ª¡
);

442 
˛k
->
u£cou¡
--;

446  
ªt
;

447 
	}
}

449 
	$om≠1_˛k_dißbÀ
(
˛k
 *clk)

451 i‡(
˛k
->
u£cou¡
 > 0 && !(--clk->usecount)) {

452 
˛k
->
	`dißbÀ
(clk);

453 i‡(
	`likñy
(
˛k
->
∑ª¡
)) {

454 
	`om≠1_˛k_dißbÀ
(
˛k
->
∑ª¡
);

455 i‡(
˛k
->
Êags
 & 
CLOCK_NO_IDLE_PARENT
)

456 
	`om≠1_˛k_Ælow_idÀ
(
˛k
->
∑ª¡
);

459 
	}
}

461 
	$om≠1_˛k_íabÀ_gíîic
(
˛k
 *clk)

463 
__u16
 
ªgvÆ16
;

464 
__u32
 
ªgvÆ32
;

466 i‡(
˛k
->
Êags
 & 
ALWAYS_ENABLED
)

469 i‡(
	`u∆ikñy
(
˛k
->
íabÀ_ªg
 == 0)) {

470 
	`¥ötk
(
KERN_ERR
 "clock.c: Enable for %s withoutÉnable code\n",

471 
˛k
->
«me
);

472  -
EINVAL
;

475 i‡(
˛k
->
Êags
 & 
ENABLE_REG_32BIT
) {

476 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
) {

477 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

478 
ªgvÆ32
 |(1 << 
˛k
->
íabÀ_bô
);

479 
	`__øw_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

481 
ªgvÆ32
 = 
	`om≠_ªadl
(
˛k
->
íabÀ_ªg
);

482 
ªgvÆ32
 |(1 << 
˛k
->
íabÀ_bô
);

483 
	`om≠_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

486 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
) {

487 
ªgvÆ16
 = 
	`__øw_ªadw
(
˛k
->
íabÀ_ªg
);

488 
ªgvÆ16
 |(1 << 
˛k
->
íabÀ_bô
);

489 
	`__øw_wrôew
(
ªgvÆ16
, 
˛k
->
íabÀ_ªg
);

491 
ªgvÆ16
 = 
	`om≠_ªadw
(
˛k
->
íabÀ_ªg
);

492 
ªgvÆ16
 |(1 << 
˛k
->
íabÀ_bô
);

493 
	`om≠_wrôew
(
ªgvÆ16
, 
˛k
->
íabÀ_ªg
);

498 
	}
}

500 
	$om≠1_˛k_dißbÀ_gíîic
(
˛k
 *clk)

502 
__u16
 
ªgvÆ16
;

503 
__u32
 
ªgvÆ32
;

505 i‡(
˛k
->
íabÀ_ªg
 == 0)

508 i‡(
˛k
->
Êags
 & 
ENABLE_REG_32BIT
) {

509 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
) {

510 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

511 
ªgvÆ32
 &~(1 << 
˛k
->
íabÀ_bô
);

512 
	`__øw_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

514 
ªgvÆ32
 = 
	`om≠_ªadl
(
˛k
->
íabÀ_ªg
);

515 
ªgvÆ32
 &~(1 << 
˛k
->
íabÀ_bô
);

516 
	`om≠_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

519 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
) {

520 
ªgvÆ16
 = 
	`__øw_ªadw
(
˛k
->
íabÀ_ªg
);

521 
ªgvÆ16
 &~(1 << 
˛k
->
íabÀ_bô
);

522 
	`__øw_wrôew
(
ªgvÆ16
, 
˛k
->
íabÀ_ªg
);

524 
ªgvÆ16
 = 
	`om≠_ªadw
(
˛k
->
íabÀ_ªg
);

525 
ªgvÆ16
 &~(1 << 
˛k
->
íabÀ_bô
);

526 
	`om≠_wrôew
(
ªgvÆ16
, 
˛k
->
íabÀ_ªg
);

529 
	}
}

531 
	$om≠1_˛k_round_øã
(
˛k
 *˛k, 
øã
)

533 
ds‹_exp
;

535 i‡(
˛k
->
Êags
 & 
RATE_FIXED
)

536  
˛k
->
øã
;

538 i‡(
˛k
->
Êags
 & 
RATE_CKCTL
) {

539 
ds‹_exp
 = 
	`ˇlc_ds‹_exp
(
˛k
, 
øã
);

540 i‡(
ds‹_exp
 < 0)

541  
ds‹_exp
;

542 i‡(
ds‹_exp
 > 3)

543 
ds‹_exp
 = 3;

544  
˛k
->
∑ª¡
->
øã
 / (1 << 
ds‹_exp
);

547 if(
˛k
->
round_øã
 != 0)

548  
˛k
->
	`round_øã
(˛k, 
øã
);

550  
˛k
->
øã
;

551 
	}
}

553 
	$om≠1_˛k_£t_øã
(
˛k
 *˛k, 
øã
)

555 
ªt
 = -
EINVAL
;

556 
ds‹_exp
;

557 
__u16
 
ªgvÆ
;

559 i‡(
˛k
->
£t_øã
)

560 
ªt
 = 
˛k
->
	`£t_øã
(˛k, 
øã
);

561 i‡(
˛k
->
Êags
 & 
RATE_CKCTL
) {

562 
ds‹_exp
 = 
	`ˇlc_ds‹_exp
(
˛k
, 
øã
);

563 i‡(
ds‹_exp
 > 3)

564 
ds‹_exp
 = -
EINVAL
;

565 i‡(
ds‹_exp
 < 0)

566  
ds‹_exp
;

568 
ªgvÆ
 = 
	`om≠_ªadw
(
ARM_CKCTL
);

569 
ªgvÆ
 &~(3 << 
˛k
->
øã_off£t
);

570 
ªgvÆ
 |
ds‹_exp
 << 
˛k
->
øã_off£t
;

571 
ªgvÆ
 = 
	`vîify_ck˘l_vÆue
(regval);

572 
	`om≠_wrôew
(
ªgvÆ
, 
ARM_CKCTL
);

573 
˛k
->
øã
 = clk->
∑ª¡
->øã / (1 << 
ds‹_exp
);

574 
ªt
 = 0;

577 i‡(
	`u∆ikñy
(
ªt
 =0 && (
˛k
->
Êags
 & 
RATE_PROPAGATES
)))

578 
	`¥›ag©e_øã
(
˛k
);

580  
ªt
;

581 
	}
}

587 #ifde‡
CONFIG_OMAP_RESET_CLOCKS


589 
__öô
 
	$om≠1_˛k_dißbÀ_unu£d
(
˛k
 *clk)

591 
__u32
 
ªgvÆ32
;

595 i‡((
u32
)
˛k
->
íabÀ_ªg
 =
DSP_IDLECT2
) {

596 
	`¥ötk
(
KERN_INFO
 "SkippingÑeset check for DSP domain "

597 "˛ock \"%s\"\n", 
˛k
->
«me
);

602 i‡(
˛k
->
Êags
 & 
ENABLE_REG_32BIT
) {

603 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
)

604 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

606 
ªgvÆ32
 = 
	`om≠_ªadl
(
˛k
->
íabÀ_ªg
);

608 i‡(
˛k
->
Êags
 & 
VIRTUAL_IO_ADDRESS
)

609 
ªgvÆ32
 = 
	`__øw_ªadw
(
˛k
->
íabÀ_ªg
);

611 
ªgvÆ32
 = 
	`om≠_ªadw
(
˛k
->
íabÀ_ªg
);

614 i‡((
ªgvÆ32
 & (1 << 
˛k
->
íabÀ_bô
)) == 0)

619 i‡(
˛k
 =&
tc2_ck


620 || 
˛k
 =&
ck_d∂l1out
.clk

621 || 
˛k
 =&
¨m_gpio_ck


623 
	`¥ötk
(
KERN_INFO
 "FIXME: Clock \"%s\" seems unused\n",

624 
˛k
->
«me
);

628 
	`¥ötk
(
KERN_INFO
 "Dißblög unu£d clock \"%s\"... ", 
˛k
->
«me
);

629 
˛k
->
	`dißbÀ
(clk);

630 
	`¥ötk
(" done\n");

631 
	}
}

634 
	#om≠1_˛k_dißbÀ_unu£d
 
NULL


	)

637 
˛k_fun˘i⁄s
 
	gom≠1_˛k_fun˘i⁄s
 = {

638 .
˛k_íabÀ
 = 
om≠1_˛k_íabÀ
,

639 .
	g˛k_dißbÀ
 = 
om≠1_˛k_dißbÀ
,

640 .
	g˛k_round_øã
 = 
om≠1_˛k_round_øã
,

641 .
	g˛k_£t_øã
 = 
om≠1_˛k_£t_øã
,

642 .
	g˛k_dißbÀ_unu£d
 = 
om≠1_˛k_dißbÀ_unu£d
,

645 
__öô
 
	$om≠1_˛k_öô
()

647 
˛k
 ** 
˛kp
;

648 c⁄° 
om≠_˛ock_c⁄fig
 *
öfo
;

649 
¸y°Æ_ty≥
 = 0;

650 
u32
 
ªg
;

652 #ifde‡
CONFIG_DEBUG_LL


656 
	`om≠_wrôñ
(0x3 << 29, 
MOD_CONF_CTRL_0
);

660 
ªg
 = 
	`om≠_ªadw
(
SOFT_REQ_REG
) & (1 << 4);

661 
	`om≠_wrôew
(
ªg
, 
SOFT_REQ_REG
);

662 i‡(!
	`˝u_is_om≠15xx
())

663 
	`om≠_wrôew
(0, 
SOFT_REQ_REG2
);

665 
	`˛k_öô
(&
om≠1_˛k_fun˘i⁄s
);

668 
¨m_idÀ˘1_mask
 = ~0;

670 
˛kp
 = 
⁄chù_˛ks
; clk∞< onchù_˛ks+
	`ARRAY_SIZE
(onchip_clks); clkp++) {

671 i‡(((*
˛kp
)->
Êags
 &
CLOCK_IN_OMAP1510
Ë&& 
	`˝u_is_om≠1510
()) {

672 
	`˛k_ªgi°î
(*
˛kp
);

676 i‡(((*
˛kp
)->
Êags
 &
CLOCK_IN_OMAP16XX
Ë&& 
	`˝u_is_om≠16xx
()) {

677 
	`˛k_ªgi°î
(*
˛kp
);

681 i‡(((*
˛kp
)->
Êags
 &
CLOCK_IN_OMAP730
Ë&& 
	`˝u_is_om≠730
()) {

682 
	`˛k_ªgi°î
(*
˛kp
);

686 i‡(((*
˛kp
)->
Êags
 &
CLOCK_IN_OMAP310
Ë&& 
	`˝u_is_om≠310
()) {

687 
	`˛k_ªgi°î
(*
˛kp
);

692 
öfo
 = 
	`om≠_gë_c⁄fig
(
OMAP_TAG_CLOCK
, 
om≠_˛ock_c⁄fig
);

693 i‡(
öfo
 !
NULL
) {

694 i‡(!
	`˝u_is_om≠15xx
())

695 
¸y°Æ_ty≥
 = 
öfo
->
sy°em_˛ock_ty≥
;

698 #i‡
	`deföed
(
CONFIG_ARCH_OMAP730
)

699 
ck_ªf
.
øã
 = 13000000;

700 #ñi‡
	`deföed
(
CONFIG_ARCH_OMAP16XX
)

701 i‡(
¸y°Æ_ty≥
 == 2)

702 
ck_ªf
.
øã
 = 19200000;

705 
	`¥ötk
("Clocks: ARM_SYSST: 0x%04x DPLL_CTL: 0x%04x ARM_CKCTL: 0x%04x\n",

706 
	`om≠_ªadw
(
ARM_SYSST
), om≠_ªadw(
DPLL_CTL
),

707 
	`om≠_ªadw
(
ARM_CKCTL
));

710 
	`om≠_wrôew
(0x1000, 
ARM_SYSST
);

712 #ifde‡
CONFIG_OMAP_CLOCKS_SET_BY_BOOTLOADER


717 
∂l_˘l_vÆ
 = 
	`om≠_ªadw
(
DPLL_CTL
);

719 
ck_d∂l1
.
øã
 = 
ck_ªf
.rate;

720 i‡(
∂l_˘l_vÆ
 & 0x10) {

722 i‡(
∂l_˘l_vÆ
 & 0xf80)

723 
ck_d∂l1
.
øã
 *(
∂l_˘l_vÆ
 & 0xf80) >> 7;

724 
ck_d∂l1
.
øã
 /((
∂l_˘l_vÆ
 & 0x60) >> 5) + 1;

727 
∂l_˘l_vÆ
 & 0xc) {

731 
ck_d∂l1
.
øã
 /= 2;

734 
ck_d∂l1
.
øã
 /= 4;

739 
	`¥›ag©e_øã
(&
ck_d∂l1
);

742 i‡(
	`om≠1_£À˘_èbÀ_øã
(&
vútuÆ_ck_mpu
, ~0)) {

743 
	`¥ötk
(
KERN_ERR
 "System frequenciesÇot set. Check your config.\n");

745 
	`om≠_wrôew
(0x2290, 
DPLL_CTL
);

746 
	`om≠_wrôew
(
	`˝u_is_om≠730
(Ë? 0x3005 : 0x1005, 
ARM_CKCTL
);

747 
ck_d∂l1
.
øã
 = 60000000;

748 
	`¥›ag©e_øã
(&
ck_d∂l1
);

752 
	`¥›ag©e_øã
(&
ck_ªf
);

753 
	`¥ötk
(
KERN_INFO
 "ClockingÑate (xtal/DPLL1/MPU): "

755 
ck_ªf
.
øã
 / 1000000, (ck_ref.rate / 100000) % 10,

756 
ck_d∂l1
.
øã
 / 1000000, (ck_dpll1.rate / 100000) % 10,

757 
¨m_ck
.
øã
 / 1000000, (arm_ck.rate / 100000) % 10);

759 #i‡
	`deföed
(
CONFIG_MACH_OMAP_PERSEUS2
Ë|| deföed(
CONFIG_MACH_OMAP_FSAMPLE
)

761 
	`om≠_wrôew
(
	`om≠_ªadw
(
OMAP730_PCC_UPLD_CTRL
) & ~0x1, OMAP730_PCC_UPLD_CTRL);

765 i‡(
	`machöe_is_ams_dñè
())

766 
	`om≠_wrôñ
(
	`om≠_ªadl
(
ULPD_CLOCK_CTRL
) |

767 (1 << 
SDW_MCLK_INV_BIT
),

768 
ULPD_CLOCK_CTRL
);

772 i‡(
	`˝u_is_om≠730
())

773 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_CKCTL
) & 0x2fff, ARM_CKCTL);

775 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_CKCTL
) & 0x0fff, ARM_CKCTL);

778 
	`om≠_wrôew
(0, 
ARM_RSTCT1
);

779 
	`om≠_wrôew
(1, 
ARM_RSTCT2
);

780 
	`om≠_wrôew
(0x400, 
ARM_IDLECT1
);

787 
	`om≠_wrôew
(0x0000, 
ARM_IDLECT2
);

793 
	`˛k_íabÀ
(&
¨m≥r_ck
.
˛k
);

794 
	`˛k_íabÀ
(&
¨mx‹_ck
.
˛k
);

795 
	`˛k_íabÀ
(&
¨mtim_ck
.
˛k
);

797 i‡(
	`˝u_is_om≠15xx
())

798 
	`˛k_íabÀ
(&
¨m_gpio_ck
);

801 
	}
}

	@arch/arm/mach-omap1/clock.h

13 #i‚de‡
__ARCH_ARM_MACH_OMAP1_CLOCK_H


14 
	#__ARCH_ARM_MACH_OMAP1_CLOCK_H


	)

16 
om≠1_˛k_íabÀ_gíîic
(
˛k
 * clk);

17 
om≠1_˛k_dißbÀ_gíîic
(
˛k
 * clk);

18 
om≠1_ck˘l_ªˇlc
(
˛k
 * clk);

19 
om≠1_w©chdog_ªˇlc
(
˛k
 * clk);

20 
om≠1_ck˘l_ªˇlc_d•_domaö
(
˛k
 * clk);

21 
om≠1_˛k_íabÀ_d•_domaö
(
˛k
 * clk);

22 
om≠1_˛k_£t_øã_d•_domaö
(
˛k
 * clk, 
øã
);

23 
om≠1_˛k_dißbÀ_d•_domaö
(
˛k
 * clk);

24 
om≠1_£t_u¨t_øã
(
˛k
 * clk, 
øã
);

25 
om≠1_u¨t_ªˇlc
(
˛k
 * clk);

26 
om≠1_˛k_íabÀ_u¨t_fun˘i⁄Æ
(
˛k
 * clk);

27 
om≠1_˛k_dißbÀ_u¨t_fun˘i⁄Æ
(
˛k
 * clk);

28 
om≠1_£t_ext_˛k_øã
(
˛k
 * clk, 
øã
);

29 
om≠1_round_ext_˛k_øã
(
˛k
 * clk, 
øã
);

30 
om≠1_öô_ext_˛k
(
˛k
 * clk);

31 
om≠1_£À˘_èbÀ_øã
(
˛k
 * clk, 
øã
);

32 
om≠1_round_to_èbÀ_øã
(
˛k
 * clk, 
øã
);

33 
om≠1_˛k_íabÀ
(
˛k
 *clk);

34 
om≠1_˛k_dißbÀ
(
˛k
 *clk);

36 
	smpu_øã
 {

37 
	møã
;

38 
	mxèl
;

39 
	m∂l_øã
;

40 
__u16
 
	mck˘l_vÆ
;

41 
__u16
 
	md∂l˘l_vÆ
;

44 
	su¨t_˛k
 {

45 
˛k
 
	m˛k
;

46 
	msysc_addr
;

50 
	s¨m_idÀ˘1_˛k
 {

51 
˛k
 
	m˛k
;

52 
	mno_idÀ_cou¡
;

53 
__u8
 
	midÀ˘_shi·
;

57 
	#CKCTL_PERDIV_OFFSET
 0

	)

58 
	#CKCTL_LCDDIV_OFFSET
 2

	)

59 
	#CKCTL_ARMDIV_OFFSET
 4

	)

60 
	#CKCTL_DSPDIV_OFFSET
 6

	)

61 
	#CKCTL_TCDIV_OFFSET
 8

	)

62 
	#CKCTL_DSPMMUDIV_OFFSET
 10

	)

64 
	#EN_DSPCK
 13

	)

67 
	#CKCTL_DSPPERDIV_OFFSET
 0

	)

70 
	#EN_WDTCK
 0

	)

71 
	#EN_XORPCK
 1

	)

72 
	#EN_PERCK
 2

	)

73 
	#EN_LCDCK
 3

	)

74 
	#EN_LBCK
 4

	)

76 
	#EN_APICK
 6

	)

77 
	#EN_TIMCK
 7

	)

78 
	#DMACK_REQ
 8

	)

79 
	#EN_GPIOCK
 9

	)

81 
	#EN_CKOUT_ARM
 11

	)

84 
	#EN_OCPI_CK
 0

	)

85 
	#EN_TC1_CK
 2

	)

86 
	#EN_TC2_CK
 4

	)

89 
	#EN_DSPTIMCK
 5

	)

92 
	#SDW_MCLK_INV_BIT
 2

	)

93 
	#USB_MCLK_EN_BIT
 4

	)

94 
	#USB_HOST_HHC_UHOST_EN
 9

	)

95 
	#SWD_ULPD_PLL_CLK_REQ
 1

	)

96 
	#COM_ULPD_PLL_CLK_REQ
 1

	)

97 
	#SWD_CLK_DIV_CTRL_SEL
 0xff„0874

	)

98 
	#COM_CLK_DIV_CTRL_SEL
 0xff„0878

	)

99 
	#SOFT_REQ_REG
 0xff„0834

	)

100 
	#SOFT_REQ_REG2
 0xff„0880

	)

105 
mpu_øã
 
	gøã_èbÀ
[] = {

110 #i‡
deföed
(
CONFIG_OMAP_ARM_216MHZ
)

113 #i‡
deföed
(
CONFIG_OMAP_ARM_195MHZ
)

116 #i‡
deföed
(
CONFIG_OMAP_ARM_192MHZ
)

123 #i‡
deföed
(
CONFIG_OMAP_ARM_182MHZ
)

126 #i‡
deföed
(
CONFIG_OMAP_ARM_168MHZ
)

129 #i‡
deföed
(
CONFIG_OMAP_ARM_150MHZ
)

132 #i‡
deföed
(
CONFIG_OMAP_ARM_120MHZ
)

135 #i‡
deföed
(
CONFIG_OMAP_ARM_96MHZ
)

138 #i‡
deföed
(
CONFIG_OMAP_ARM_60MHZ
)

141 #i‡
deföed
(
CONFIG_OMAP_ARM_30MHZ
)

151 
˛k
 
	gck_ªf
 = {

152 .
«me
 = "ck_ref",

153 .
	gøã
 = 12000000,

154 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

155 
CLOCK_IN_OMAP310
 | 
ALWAYS_ENABLED
,

156 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

157 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

160 
˛k
 
	gck_d∂l1
 = {

161 .
«me
 = "ck_dpll1",

162 .
	g∑ª¡
 = &
ck_ªf
,

163 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

164 
CLOCK_IN_OMAP310
 | 
RATE_PROPAGATES
 | 
ALWAYS_ENABLED
,

165 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

166 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

169 
¨m_idÀ˘1_˛k
 
	gck_d∂l1out
 = {

170 .
˛k
 = {

171 .
«me
 = "ck_dpll1out",

172 .
	g∑ª¡
 = &
ck_d∂l1
,

173 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
CLOCK_IDLE_CONTROL
,

174 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

175 .
	gíabÀ_bô
 = 
EN_CKOUT_ARM
,

176 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

177 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

178 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

180 .
	gidÀ˘_shi·
 = 12,

183 
˛k
 
	g¨m_ck
 = {

184 .
«me
 = "arm_ck",

185 .
	g∑ª¡
 = &
ck_d∂l1
,

186 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

187 
CLOCK_IN_OMAP310
 | 
RATE_CKCTL
 | 
RATE_PROPAGATES
 |

188 
ALWAYS_ENABLED
,

189 .
	gøã_off£t
 = 
CKCTL_ARMDIV_OFFSET
,

190 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

191 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

192 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

195 
¨m_idÀ˘1_˛k
 
	g¨m≥r_ck
 = {

196 .
˛k
 = {

197 .
«me
 = "armper_ck",

198 .
	g∑ª¡
 = &
ck_d∂l1
,

199 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

200 
CLOCK_IN_OMAP310
 | 
RATE_CKCTL
 |

201 
CLOCK_IDLE_CONTROL
,

202 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

203 .
	gíabÀ_bô
 = 
EN_PERCK
,

204 .
	gøã_off£t
 = 
CKCTL_PERDIV_OFFSET
,

205 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

206 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

207 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

209 .
	gidÀ˘_shi·
 = 2,

212 
˛k
 
	g¨m_gpio_ck
 = {

213 .
«me
 = "arm_gpio_ck",

214 .
	g∑ª¡
 = &
ck_d∂l1
,

215 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
,

216 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

217 .
	gíabÀ_bô
 = 
EN_GPIOCK
,

218 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

219 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

220 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

223 
¨m_idÀ˘1_˛k
 
	g¨mx‹_ck
 = {

224 .
˛k
 = {

225 .
«me
 = "armxor_ck",

226 .
	g∑ª¡
 = &
ck_ªf
,

227 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

228 
CLOCK_IN_OMAP310
 | 
CLOCK_IDLE_CONTROL
,

229 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

230 .
	gíabÀ_bô
 = 
EN_XORPCK
,

231 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

232 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

233 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

235 .
	gidÀ˘_shi·
 = 1,

238 
¨m_idÀ˘1_˛k
 
	g¨mtim_ck
 = {

239 .
˛k
 = {

240 .
«me
 = "armtim_ck",

241 .
	g∑ª¡
 = &
ck_ªf
,

242 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

243 
CLOCK_IN_OMAP310
 | 
CLOCK_IDLE_CONTROL
,

244 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

245 .
	gíabÀ_bô
 = 
EN_TIMCK
,

246 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

247 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

248 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

250 .
	gidÀ˘_shi·
 = 9,

253 
¨m_idÀ˘1_˛k
 
	g¨mwdt_ck
 = {

254 .
˛k
 = {

255 .
«me
 = "armwdt_ck",

256 .
	g∑ª¡
 = &
ck_ªf
,

257 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

258 
CLOCK_IN_OMAP310
 | 
CLOCK_IDLE_CONTROL
,

259 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

260 .
	gíabÀ_bô
 = 
EN_WDTCK
,

261 .
	gªˇlc
 = &
om≠1_w©chdog_ªˇlc
,

262 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

263 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

265 .
	gidÀ˘_shi·
 = 0,

268 
˛k
 
	g¨möth_ck16xx
 = {

269 .
«me
 = "arminth_ck",

270 .
	g∑ª¡
 = &
¨m_ck
,

271 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
ALWAYS_ENABLED
,

272 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

278 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

279 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

282 
˛k
 
	gd•_ck
 = {

283 .
«me
 = "dsp_ck",

284 .
	g∑ª¡
 = &
ck_d∂l1
,

285 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

286 
RATE_CKCTL
,

287 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_CKCTL
,

288 .
	gíabÀ_bô
 = 
EN_DSPCK
,

289 .
	gøã_off£t
 = 
CKCTL_DSPDIV_OFFSET
,

290 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

291 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

292 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

295 
˛k
 
	gd•mmu_ck
 = {

296 .
«me
 = "dspmmu_ck",

297 .
	g∑ª¡
 = &
ck_d∂l1
,

298 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

299 
RATE_CKCTL
 | 
ALWAYS_ENABLED
,

300 .
	gøã_off£t
 = 
CKCTL_DSPMMUDIV_OFFSET
,

301 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

302 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

303 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

306 
˛k
 
	gd•≥r_ck
 = {

307 .
«me
 = "dspper_ck",

308 .
	g∑ª¡
 = &
ck_d∂l1
,

309 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

310 
RATE_CKCTL
 | 
VIRTUAL_IO_ADDRESS
,

311 .
	gíabÀ_ªg
 = (
__iomem
 *)
DSP_IDLECT2
,

312 .
	gíabÀ_bô
 = 
EN_PERCK
,

313 .
	gøã_off£t
 = 
CKCTL_PERDIV_OFFSET
,

314 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc_d•_domaö
,

315 .
	g£t_øã
 = &
om≠1_˛k_£t_øã_d•_domaö
,

316 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_d•_domaö
,

317 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_d•_domaö
,

320 
˛k
 
	gd•x‹_ck
 = {

321 .
«me
 = "dspxor_ck",

322 .
	g∑ª¡
 = &
ck_ªf
,

323 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

324 
VIRTUAL_IO_ADDRESS
,

325 .
	gíabÀ_ªg
 = (
__iomem
 *)
DSP_IDLECT2
,

326 .
	gíabÀ_bô
 = 
EN_XORPCK
,

327 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

328 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_d•_domaö
,

329 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_d•_domaö
,

332 
˛k
 
	gd•tim_ck
 = {

333 .
«me
 = "dsptim_ck",

334 .
	g∑ª¡
 = &
ck_ªf
,

335 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

336 
VIRTUAL_IO_ADDRESS
,

337 .
	gíabÀ_ªg
 = (
__iomem
 *)
DSP_IDLECT2
,

338 .
	gíabÀ_bô
 = 
EN_DSPTIMCK
,

339 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

340 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_d•_domaö
,

341 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_d•_domaö
,

345 
¨m_idÀ˘1_˛k
 
	gtc_ck
 = {

346 .
˛k
 = {

347 .
«me
 = "tc_ck",

348 .
	g∑ª¡
 = &
ck_d∂l1
,

349 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

350 
CLOCK_IN_OMAP730
 | 
CLOCK_IN_OMAP310
 |

351 
RATE_CKCTL
 | 
RATE_PROPAGATES
 |

352 
ALWAYS_ENABLED
 | 
CLOCK_IDLE_CONTROL
,

353 .
	gøã_off£t
 = 
CKCTL_TCDIV_OFFSET
,

354 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

355 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

356 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

358 .
	gidÀ˘_shi·
 = 6,

361 
˛k
 
	g¨möth_ck1510
 = {

362 .
«me
 = "arminth_ck",

363 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

364 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

365 
ALWAYS_ENABLED
,

366 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

371 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

372 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

375 
˛k
 
	gtùb_ck
 = {

377 .
«me
 = "tibp_ck",

378 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

379 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

380 
ALWAYS_ENABLED
,

381 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

382 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

383 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

386 
˛k
 
	gl3_o˝i_ck
 = {

388 .
«me
 = "l3_ocpi_ck",

389 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

390 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
,

391 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT3
,

392 .
	gíabÀ_bô
 = 
EN_OCPI_CK
,

393 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

394 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

395 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

398 
˛k
 
	gtc1_ck
 = {

399 .
«me
 = "tc1_ck",

400 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

401 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
,

402 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT3
,

403 .
	gíabÀ_bô
 = 
EN_TC1_CK
,

404 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

405 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

406 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

409 
˛k
 
	gtc2_ck
 = {

410 .
«me
 = "tc2_ck",

411 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

412 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
,

413 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT3
,

414 .
	gíabÀ_bô
 = 
EN_TC2_CK
,

415 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

416 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

417 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

420 
˛k
 
	gdma_ck
 = {

422 .
«me
 = "dma_ck",

423 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

424 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

425 
CLOCK_IN_OMAP310
 | 
ALWAYS_ENABLED
,

426 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

427 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

428 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

431 
˛k
 
	gdma_lcd‰ì_ck
 = {

432 .
«me
 = "dma_lcdfree_ck",

433 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

434 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
ALWAYS_ENABLED
,

435 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

436 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

437 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

440 
¨m_idÀ˘1_˛k
 
	g≠i_ck
 = {

441 .
˛k
 = {

442 .
«me
 = "api_ck",

443 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

444 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

445 
CLOCK_IN_OMAP310
 | 
CLOCK_IDLE_CONTROL
,

446 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

447 .
	gíabÀ_bô
 = 
EN_APICK
,

448 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

449 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

450 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

452 .
	gidÀ˘_shi·
 = 8,

455 
¨m_idÀ˘1_˛k
 
	glb_ck
 = {

456 .
˛k
 = {

457 .
«me
 = "lb_ck",

458 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

459 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

460 
CLOCK_IDLE_CONTROL
,

461 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

462 .
	gíabÀ_bô
 = 
EN_LBCK
,

463 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

464 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

465 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

467 .
	gidÀ˘_shi·
 = 4,

470 
˛k
 
	grhó1_ck
 = {

471 .
«me
 = "rhea1_ck",

472 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

473 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
ALWAYS_ENABLED
,

474 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

475 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

476 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

479 
˛k
 
	grhó2_ck
 = {

480 .
«me
 = "rhea2_ck",

481 .
	g∑ª¡
 = &
tc_ck
.
˛k
,

482 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
ALWAYS_ENABLED
,

483 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

484 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

485 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

488 
˛k
 
	glcd_ck_16xx
 = {

489 .
«me
 = "lcd_ck",

490 .
	g∑ª¡
 = &
ck_d∂l1
,

491 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
CLOCK_IN_OMAP730
 | 
RATE_CKCTL
,

492 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

493 .
	gíabÀ_bô
 = 
EN_LCDCK
,

494 .
	gøã_off£t
 = 
CKCTL_LCDDIV_OFFSET
,

495 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

496 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

497 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

500 
¨m_idÀ˘1_˛k
 
	glcd_ck_1510
 = {

501 .
˛k
 = {

502 .
«me
 = "lcd_ck",

503 .
	g∑ª¡
 = &
ck_d∂l1
,

504 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

505 
RATE_CKCTL
 | 
CLOCK_IDLE_CONTROL
,

506 .
	gíabÀ_ªg
 = (
__iomem
 *)
ARM_IDLECT2
,

507 .
	gíabÀ_bô
 = 
EN_LCDCK
,

508 .
	gøã_off£t
 = 
CKCTL_LCDDIV_OFFSET
,

509 .
	gªˇlc
 = &
om≠1_ck˘l_ªˇlc
,

510 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

511 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

513 .
	gidÀ˘_shi·
 = 3,

516 
˛k
 
	gu¨t1_1510
 = {

517 .
«me
 = "uart1_ck",

519 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

520 .
	gøã
 = 12000000,

521 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

522 
ENABLE_REG_32BIT
 | 
ALWAYS_ENABLED
 |

523 
CLOCK_NO_IDLE_PARENT
,

524 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

525 .
	gíabÀ_bô
 = 29,

526 .
	g£t_øã
 = &
om≠1_£t_u¨t_øã
,

527 .
	gªˇlc
 = &
om≠1_u¨t_ªˇlc
,

528 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

529 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

532 
u¨t_˛k
 
	gu¨t1_16xx
 = {

533 .
˛k
 = {

534 .
«me
 = "uart1_ck",

536 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

537 .
	gøã
 = 48000000,

538 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
RATE_FIXED
 |

539 
ENABLE_REG_32BIT
 | 
CLOCK_NO_IDLE_PARENT
,

540 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

541 .
	gíabÀ_bô
 = 29,

542 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_u¨t_fun˘i⁄Æ
,

543 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_u¨t_fun˘i⁄Æ
,

545 .
	gsysc_addr
 = 0xfffb0054,

548 
˛k
 
	gu¨t2_ck
 = {

549 .
«me
 = "uart2_ck",

551 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

552 .
	gøã
 = 12000000,

553 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

554 
CLOCK_IN_OMAP310
 | 
ENABLE_REG_32BIT
 |

555 
ALWAYS_ENABLED
 | 
CLOCK_NO_IDLE_PARENT
,

556 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

557 .
	gíabÀ_bô
 = 30,

558 .
	g£t_øã
 = &
om≠1_£t_u¨t_øã
,

559 .
	gªˇlc
 = &
om≠1_u¨t_ªˇlc
,

560 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

561 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

564 
˛k
 
	gu¨t3_1510
 = {

565 .
«me
 = "uart3_ck",

567 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

568 .
	gøã
 = 12000000,

569 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

570 
ENABLE_REG_32BIT
 | 
ALWAYS_ENABLED
 |

571 
CLOCK_NO_IDLE_PARENT
,

572 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

573 .
	gíabÀ_bô
 = 31,

574 .
	g£t_øã
 = &
om≠1_£t_u¨t_øã
,

575 .
	gªˇlc
 = &
om≠1_u¨t_ªˇlc
,

576 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

577 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

580 
u¨t_˛k
 
	gu¨t3_16xx
 = {

581 .
˛k
 = {

582 .
«me
 = "uart3_ck",

584 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

585 .
	gøã
 = 48000000,

586 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
RATE_FIXED
 |

587 
ENABLE_REG_32BIT
 | 
CLOCK_NO_IDLE_PARENT
,

588 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

589 .
	gíabÀ_bô
 = 31,

590 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_u¨t_fun˘i⁄Æ
,

591 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_u¨t_fun˘i⁄Æ
,

593 .
	gsysc_addr
 = 0xfffb9854,

596 
˛k
 
	gusb_˛ko
 = {

597 .
«me
 = "usb_clko",

599 .
	gøã
 = 6000000,

600 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

601 
CLOCK_IN_OMAP310
 | 
RATE_FIXED
 | 
ENABLE_REG_32BIT
,

602 .
	gíabÀ_ªg
 = (
__iomem
 *)
ULPD_CLOCK_CTRL
,

603 .
	gíabÀ_bô
 = 
USB_MCLK_EN_BIT
,

604 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

605 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

608 
˛k
 
	gusb_hhc_ck1510
 = {

609 .
«me
 = "usb_hhc_ck",

611 .
	gøã
 = 48000000,

612 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 |

613 
RATE_FIXED
 | 
ENABLE_REG_32BIT
,

614 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

615 .
	gíabÀ_bô
 = 
USB_HOST_HHC_UHOST_EN
,

616 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

617 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

620 
˛k
 
	gusb_hhc_ck16xx
 = {

621 .
«me
 = "usb_hhc_ck",

623 .
	gøã
 = 48000000,

625 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 |

626 
RATE_FIXED
 | 
ENABLE_REG_32BIT
,

627 .
	gíabÀ_ªg
 = (
__iomem
 *)
OTG_BASE
 + 0x08 ,

628 .
	gíabÀ_bô
 = 8 ,

629 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

630 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

633 
˛k
 
	gusb_dc_ck
 = {

634 .
«me
 = "usb_dc_ck",

636 .
	gøã
 = 48000000,

637 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 | 
RATE_FIXED
,

638 .
	gíabÀ_ªg
 = (
__iomem
 *)
SOFT_REQ_REG
,

639 .
	gíabÀ_bô
 = 4,

640 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

641 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

644 
˛k
 
	gm˛k_1510
 = {

645 .
«me
 = "mclk",

647 .
	gøã
 = 12000000,

648 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 | 
RATE_FIXED
,

649 .
	gíabÀ_ªg
 = (
__iomem
 *)
SOFT_REQ_REG
,

650 .
	gíabÀ_bô
 = 6,

651 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

652 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

655 
˛k
 
	gm˛k_16xx
 = {

656 .
«me
 = "mclk",

658 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
,

659 .
	gíabÀ_ªg
 = (
__iomem
 *)
COM_CLK_DIV_CTRL_SEL
,

660 .
	gíabÀ_bô
 = 
COM_ULPD_PLL_CLK_REQ
,

661 .
	g£t_øã
 = &
om≠1_£t_ext_˛k_øã
,

662 .
	ground_øã
 = &
om≠1_round_ext_˛k_øã
,

663 .
	göô
 = &
om≠1_öô_ext_˛k
,

664 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

665 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

668 
˛k
 
	gb˛k_1510
 = {

669 .
«me
 = "bclk",

671 .
	gøã
 = 12000000,

672 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP310
 | 
RATE_FIXED
,

673 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

674 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

677 
˛k
 
	gb˛k_16xx
 = {

678 .
«me
 = "bclk",

680 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
,

681 .
	gíabÀ_ªg
 = (
__iomem
 *)
SWD_CLK_DIV_CTRL_SEL
,

682 .
	gíabÀ_bô
 = 
SWD_ULPD_PLL_CLK_REQ
,

683 .
	g£t_øã
 = &
om≠1_£t_ext_˛k_øã
,

684 .
	ground_øã
 = &
om≠1_round_ext_˛k_øã
,

685 .
	göô
 = &
om≠1_öô_ext_˛k
,

686 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

687 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

690 
˛k
 
	gmmc1_ck
 = {

691 .
«me
 = "mmc_ck",

692 .
	gid
 = 1,

694 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

695 .
	gøã
 = 48000000,

696 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

697 
CLOCK_IN_OMAP310
 | 
RATE_FIXED
 | 
ENABLE_REG_32BIT
 |

698 
CLOCK_NO_IDLE_PARENT
,

699 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

700 .
	gíabÀ_bô
 = 23,

701 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

702 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

705 
˛k
 
	gmmc2_ck
 = {

706 .
«me
 = "mmc_ck",

707 .
	gid
 = 2,

709 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

710 .
	gøã
 = 48000000,

711 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 |

712 
RATE_FIXED
 | 
ENABLE_REG_32BIT
 | 
CLOCK_NO_IDLE_PARENT
,

713 .
	gíabÀ_ªg
 = (
__iomem
 *)
MOD_CONF_CTRL_0
,

714 .
	gíabÀ_bô
 = 20,

715 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

716 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

719 
˛k
 
	gvútuÆ_ck_mpu
 = {

720 .
«me
 = "mpu",

721 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

722 
CLOCK_IN_OMAP310
 | 
VIRTUAL_CLOCK
 | 
ALWAYS_ENABLED
,

723 .
	g∑ª¡
 = &
¨m_ck
,

724 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

725 .
	g£t_øã
 = &
om≠1_£À˘_èbÀ_øã
,

726 .
	ground_øã
 = &
om≠1_round_to_èbÀ_øã
,

727 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

728 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

733 
˛k
 
	gi2c_fck
 = {

734 .
«me
 = "i2c_fck",

735 .
	gid
 = 1,

736 .
	gÊags
 = 
CLOCK_IN_OMAP1510
 | 
CLOCK_IN_OMAP16XX
 |

737 
VIRTUAL_CLOCK
 | 
CLOCK_NO_IDLE_PARENT
 |

738 
ALWAYS_ENABLED
,

739 .
	g∑ª¡
 = &
¨mx‹_ck
.
˛k
,

740 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

741 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

742 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

745 
˛k
 
	gi2c_ick
 = {

746 .
«me
 = "i2c_ick",

747 .
	gid
 = 1,

748 .
	gÊags
 = 
CLOCK_IN_OMAP16XX
 |

749 
VIRTUAL_CLOCK
 | 
CLOCK_NO_IDLE_PARENT
 |

750 
ALWAYS_ENABLED
,

751 .
	g∑ª¡
 = &
¨m≥r_ck
.
˛k
,

752 .
	gªˇlc
 = &
fﬁlow∑ª¡_ªˇlc
,

753 .
	gíabÀ
 = &
om≠1_˛k_íabÀ_gíîic
,

754 .
	gdißbÀ
 = &
om≠1_˛k_dißbÀ_gíîic
,

757 
˛k
 * 
	g⁄chù_˛ks
[] = {

759 &
ck_ªf
,

760 &
ck_d∂l1
,

762 &
ck_d∂l1out
.
˛k
,

763 &
¨m_ck
,

764 &
¨m≥r_ck
.
˛k
,

765 &
¨m_gpio_ck
,

766 &
¨mx‹_ck
.
˛k
,

767 &
¨mtim_ck
.
˛k
,

768 &
¨mwdt_ck
.
˛k
,

769 &
¨möth_ck1510
, &
¨möth_ck16xx
,

771 &
d•_ck
,

772 &
d•mmu_ck
,

773 &
d•≥r_ck
,

774 &
d•x‹_ck
,

775 &
d•tim_ck
,

777 &
tc_ck
.
˛k
,

778 &
tùb_ck
,

779 &
l3_o˝i_ck
,

780 &
tc1_ck
,

781 &
tc2_ck
,

782 &
dma_ck
,

783 &
dma_lcd‰ì_ck
,

784 &
≠i_ck
.
˛k
,

785 &
lb_ck
.
˛k
,

786 &
rhó1_ck
,

787 &
rhó2_ck
,

788 &
lcd_ck_16xx
,

789 &
lcd_ck_1510
.
˛k
,

791 &
u¨t1_1510
,

792 &
u¨t1_16xx
.
˛k
,

793 &
u¨t2_ck
,

794 &
u¨t3_1510
,

795 &
u¨t3_16xx
.
˛k
,

796 &
usb_˛ko
,

797 &
usb_hhc_ck1510
, &
usb_hhc_ck16xx
,

798 &
usb_dc_ck
,

799 &
m˛k_1510
, &
m˛k_16xx
,

800 &
b˛k_1510
, &
b˛k_16xx
,

801 &
mmc1_ck
,

802 &
mmc2_ck
,

804 &
vútuÆ_ck_mpu
,

805 &
i2c_fck
,

806 &
i2c_ick
,

	@arch/arm/mach-omap1/devices.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/io.h
>

19 
	~<asm/mach-ty≥s.h
>

20 
	~<asm/mach/m≠.h
>

22 
	~<asm/¨ch/tc.h
>

23 
	~<asm/¨ch/bﬂrd.h
>

24 
	~<asm/¨ch/mux.h
>

25 
	~<asm/¨ch/gpio.h
>

29 #i‡
deföed
(
CONFIG_RTC_DRV_OMAP
Ë|| deföed(
CONFIG_RTC_DRV_OMAP_MODULE
)

31 
	#OMAP_RTC_BASE
 0xfffb4800

	)

33 
ªsour˚
 
	gπc_ªsour˚s
[] = {

35 .
°¨t
 = 
OMAP_RTC_BASE
,

36 .
	gíd
 = 
OMAP_RTC_BASE
 + 0x5f,

37 .
	gÊags
 = 
IORESOURCE_MEM
,

40 .
	g°¨t
 = 
INT_RTC_TIMER
,

41 .
	gÊags
 = 
IORESOURCE_IRQ
,

44 .
	g°¨t
 = 
INT_RTC_ALARM
,

45 .
	gÊags
 = 
IORESOURCE_IRQ
,

49 
∂©f‹m_devi˚
 
	gom≠_πc_devi˚
 = {

50 .
«me
 = "omap_rtc",

51 .
	gid
 = -1,

52 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
πc_ªsour˚s
),

53 .
	gªsour˚
 = 
πc_ªsour˚s
,

56 
	$om≠_öô_πc
()

58 (Ë
	`∂©f‹m_devi˚_ªgi°î
(&
om≠_πc_devi˚
);

59 
	}
}

61 
ölöe
 
	$om≠_öô_πc
(Ë{
	}
}

64 #i‡
deföed
(
CONFIG_OMAP_DSP
Ë|| deföed(
CONFIG_OMAP_DSP_MODULE
)

66 #i‡
deföed
(
CONFIG_ARCH_OMAP15XX
)

67 
	#OMAP1_MBOX_SIZE
 0x23

	)

68 
	#INT_DSP_MAILBOX1
 
INT_1510_DSP_MAILBOX1


	)

69 #ñi‡
deföed
(
CONFIG_ARCH_OMAP16XX
)

70 
	#OMAP1_MBOX_SIZE
 0x2f

	)

71 
	#INT_DSP_MAILBOX1
 
INT_1610_DSP_MAILBOX1


	)

74 
	#OMAP1_MBOX_BASE
 
	`IO_ADDRESS
(
OMAP16XX_MAILBOX_BASE
)

	)

76 
ªsour˚
 
	gmbox_ªsour˚s
[] = {

78 .
°¨t
 = 
OMAP1_MBOX_BASE
,

79 .
	gíd
 = 
OMAP1_MBOX_BASE
 + 
OMAP1_MBOX_SIZE
,

80 .
	gÊags
 = 
IORESOURCE_MEM
,

83 .
	g°¨t
 = 
INT_DSP_MAILBOX1
,

84 .
	gÊags
 = 
IORESOURCE_IRQ
,

88 
∂©f‹m_devi˚
 
	gmbox_devi˚
 = {

89 .
«me
 = "mailbox",

90 .
	gid
 = -1,

91 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mbox_ªsour˚s
),

92 .
	gªsour˚
 = 
mbox_ªsour˚s
,

95 
ölöe
 
	$om≠_öô_mbox
()

97 
	`∂©f‹m_devi˚_ªgi°î
(&
mbox_devi˚
);

98 
	}
}

100 
ölöe
 
	$om≠_öô_mbox
(Ë{ 
	}
}

103 #i‡
deföed
(
CONFIG_OMAP_STI
)

105 
	#OMAP1_STI_BASE
 
	`IO_ADDRESS
(0xff„a000)

	)

106 
	#OMAP1_STI_CHANNEL_BASE
 (
OMAP1_STI_BASE
 + 0x400)

	)

108 
ªsour˚
 
	g°i_ªsour˚s
[] = {

110 .
°¨t
 = 
OMAP1_STI_BASE
,

111 .
	gíd
 = 
OMAP1_STI_BASE
 + 
SZ_1K
 - 1,

112 .
	gÊags
 = 
IORESOURCE_MEM
,

115 .
	g°¨t
 = 
OMAP1_STI_CHANNEL_BASE
,

116 .
	gíd
 = 
OMAP1_STI_CHANNEL_BASE
 + 
SZ_1K
 - 1,

117 .
	gÊags
 = 
IORESOURCE_MEM
,

120 .
	g°¨t
 = 
INT_1610_STI
,

121 .
	gÊags
 = 
IORESOURCE_IRQ
,

125 
∂©f‹m_devi˚
 
	g°i_devi˚
 = {

126 .
«me
 = "sti",

127 .
	gid
 = -1,

128 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
°i_ªsour˚s
),

129 .
	gªsour˚
 = 
°i_ªsour˚s
,

132 
ölöe
 
	$om≠_öô_°i
()

134 
	`∂©f‹m_devi˚_ªgi°î
(&
°i_devi˚
);

135 
	}
}

137 
ölöe
 
	$om≠_öô_°i
(Ë{
	}
}

162 
__öô
 
	$om≠1_öô_devi˚s
()

168 
	`om≠_öô_mbox
();

169 
	`om≠_öô_πc
();

170 
	`om≠_öô_°i
();

173 
	}
}

174 
¨ch_öôˇŒ
(
om≠1_öô_devi˚s
);

	@arch/arm/mach-omap1/fpga.c

19 
	~<löux/ty≥s.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/kî√l.h
>

22 
	~<löux/devi˚.h
>

23 
	~<löux/î∫o.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/úq.h
>

30 
	~<asm/¨ch/Âga.h
>

31 
	~<asm/¨ch/gpio.h
>

33 
	$Âga_mask_úq
(
úq
)

35 
úq
 -
OMAP1510_IH_FPGA_BASE
;

37 i‡(
úq
 < 8)

38 
	`__øw_wrôeb
((
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_LO
)

39 & ~(1 << 
úq
)), 
OMAP1510_FPGA_IMR_LO
);

40 i‡(
úq
 < 16)

41 
	`__øw_wrôeb
((
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_HI
)

42 & ~(1 << (
úq
 - 8))), 
OMAP1510_FPGA_IMR_HI
);

44 
	`__øw_wrôeb
((
	`__øw_ªadb
(
INNOVATOR_FPGA_IMR2
)

45 & ~(1 << (
úq
 - 16))), 
INNOVATOR_FPGA_IMR2
);

46 
	}
}

49 
ölöe
 
u32
 
	$gë_Âga_unmasked_úqs
()

52 ((
	`__øw_ªadb
(
OMAP1510_FPGA_ISR_LO
) &

53 
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_LO
))) |

54 ((
	`__øw_ªadb
(
OMAP1510_FPGA_ISR_HI
) &

55 
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_HI
)) << 8) |

56 ((
	`__øw_ªadb
(
INNOVATOR_FPGA_ISR2
) &

57 
	`__øw_ªadb
(
INNOVATOR_FPGA_IMR2
)) << 16);

58 
	}
}

61 
	$Âga_ack_úq
(
úq
)

64 
	}
}

66 
	$Âga_unmask_úq
(
úq
)

68 
úq
 -
OMAP1510_IH_FPGA_BASE
;

70 i‡(
úq
 < 8)

71 
	`__øw_wrôeb
((
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_LO
Ë| (1 << 
úq
)),

72 
OMAP1510_FPGA_IMR_LO
);

73 i‡(
úq
 < 16)

74 
	`__øw_wrôeb
((
	`__øw_ªadb
(
OMAP1510_FPGA_IMR_HI
)

75 | (1 << (
úq
 - 8))), 
OMAP1510_FPGA_IMR_HI
);

77 
	`__øw_wrôeb
((
	`__øw_ªadb
(
INNOVATOR_FPGA_IMR2
)

78 | (1 << (
úq
 - 16))), 
INNOVATOR_FPGA_IMR2
);

79 
	}
}

81 
	$Âga_mask_ack_úq
(
úq
)

83 
	`Âga_mask_úq
(
úq
);

84 
	`Âga_ack_úq
(
úq
);

85 
	}
}

87 
	$önov©‹_Âga_IRQ_demux
(
úq
, 
úq_desc
 *
desc
)

89 
úq_desc
 *
d
;

90 
u32
 
°©
;

91 
Âga_úq
;

93 
°©
 = 
	`gë_Âga_unmasked_úqs
();

95 i‡(!
°©
)

98 
Âga_úq
 = 
OMAP1510_IH_FPGA_BASE
;

99 (
Âga_úq
 < (
OMAP1510_IH_FPGA_BASE
 + 
NR_FPGA_IRQS
)Ë&& 
°©
;

100 
Âga_úq
++, 
°©
 >>= 1) {

101 i‡(
°©
 & 1) {

102 
d
 = 
úq_desc
 + 
Âga_úq
;

103 
	`desc_h™dÀ_úq
(
Âga_úq
, 
d
);

106 
	}
}

108 
úq_chù
 
	gom≠_Âga_úq_ack
 = {

109 .
«me
 = "FPGA-ack",

110 .
	gack
 = 
Âga_mask_ack_úq
,

111 .
	gmask
 = 
Âga_mask_úq
,

112 .
	gunmask
 = 
Âga_unmask_úq
,

116 
úq_chù
 
	gom≠_Âga_úq
 = {

117 .
«me
 = "FPGA",

118 .
	gack
 = 
Âga_ack_úq
,

119 .
	gmask
 = 
Âga_mask_úq
,

120 .
	gunmask
 = 
Âga_unmask_úq
,

146 
	$om≠1510_Âga_öô_úq
()

148 
i
;

150 
	`__øw_wrôeb
(0, 
OMAP1510_FPGA_IMR_LO
);

151 
	`__øw_wrôeb
(0, 
OMAP1510_FPGA_IMR_HI
);

152 
	`__øw_wrôeb
(0, 
INNOVATOR_FPGA_IMR2
);

154 
i
 = 
OMAP1510_IH_FPGA_BASE
; i < (OMAP1510_IH_FPGA_BASE + 
NR_FPGA_IRQS
); i++) {

156 i‡(
i
 =
OMAP1510_INT_FPGA_TS
) {

161 
	`£t_úq_chù
(
i
, &
om≠_Âga_úq_ack
);

168 
	`£t_úq_chù
(
i
, &
om≠_Âga_úq
);

171 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_edge_úq
);

172 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

182 
	`om≠_ªque°_gpio
(13);

183 
	`om≠_£t_gpio_dúe˘i⁄
(13, 1);

184 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(13), 
IRQT_RISING
);

185 
	`£t_úq_chaöed_h™dÀr
(
OMAP1510_INT_FPGA
, 
önov©‹_Âga_IRQ_demux
);

186 
	}
}

188 
EXPORT_SYMBOL
(
om≠1510_Âga_öô_úq
);

	@arch/arm/mach-omap1/id.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/io.h
>

20 
	#OMAP_DIE_ID_0
 0xff„1800

	)

21 
	#OMAP_DIE_ID_1
 0xff„1804

	)

22 
	#OMAP_PRODUCTION_ID_0
 0xff„2000

	)

23 
	#OMAP_PRODUCTION_ID_1
 0xff„2004

	)

24 
	#OMAP32_ID_0
 0xff„d400

	)

25 
	#OMAP32_ID_1
 0xff„d404

	)

27 
	som≠_id
 {

28 
u16
 
	mjèg_id
;

29 
u8
 
	mdõ_ªv
;

30 
u32
 
	mom≠_id
;

31 
u32
 
	mty≥
;

35 
om≠_id
 
	gom≠_ids
[] 
	g__öôd©a
 = {

36 { .
jèg_id
 = 0xb574, .
	gdõ_ªv
 = 0x2, .
	gom≠_id
 = 0x03310315, .
	gty≥
 = 0x03100000},

37 { .
	gjèg_id
 = 0x355f, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320000, .
	gty≥
 = 0x07300100},

38 { .
	gjèg_id
 = 0xb55f, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320000, .
	gty≥
 = 0x07300300},

39 { .
	gjèg_id
 = 0xb470, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03310100, .
	gty≥
 = 0x15100000},

40 { .
	gjèg_id
 = 0xb576, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320000, .
	gty≥
 = 0x16100000},

41 { .
	gjèg_id
 = 0xb576, .
	gdõ_ªv
 = 0x2, .
	gom≠_id
 = 0x03320100, .
	gty≥
 = 0x16110000},

42 { .
	gjèg_id
 = 0xb576, .
	gdõ_ªv
 = 0x3, .
	gom≠_id
 = 0x03320100, .
	gty≥
 = 0x16100c00},

43 { .
	gjèg_id
 = 0xb576, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320200, .
	gty≥
 = 0x16100d00},

44 { .
	gjèg_id
 = 0xb613, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320300, .
	gty≥
 = 0x1610ef00},

45 { .
	gjèg_id
 = 0xb613, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320300, .
	gty≥
 = 0x1610ef00},

46 { .
	gjèg_id
 = 0xb576, .
	gdõ_ªv
 = 0x1, .
	gom≠_id
 = 0x03320100, .
	gty≥
 = 0x16110000},

47 { .
	gjèg_id
 = 0xb58c, .
	gdõ_ªv
 = 0x2, .
	gom≠_id
 = 0x03320200, .
	gty≥
 = 0x16110b00},

48 { .
	gjèg_id
 = 0xb58c, .
	gdõ_ªv
 = 0x3, .
	gom≠_id
 = 0x03320200, .
	gty≥
 = 0x16110c00},

49 { .
	gjèg_id
 = 0xb65f, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03320400, .
	gty≥
 = 0x16212300},

50 { .
	gjèg_id
 = 0xb65f, .
	gdõ_ªv
 = 0x1, .
	gom≠_id
 = 0x03320400, .
	gty≥
 = 0x16212300},

51 { .
	gjèg_id
 = 0xb65f, .
	gdõ_ªv
 = 0x1, .
	gom≠_id
 = 0x03320500, .
	gty≥
 = 0x16212300},

52 { .
	gjèg_id
 = 0xb5f7, .
	gdõ_ªv
 = 0x0, .
	gom≠_id
 = 0x03330000, .
	gty≥
 = 0x17100000},

53 { .
	gjèg_id
 = 0xb5f7, .
	gdõ_ªv
 = 0x1, .
	gom≠_id
 = 0x03330100, .
	gty≥
 = 0x17100000},

54 { .
	gjèg_id
 = 0xb5f7, .
	gdõ_ªv
 = 0x2, .
	gom≠_id
 = 0x03330100, .
	gty≥
 = 0x17100000},

65 
u16
 
__öô
 
	$om≠_gë_jèg_id
()

67 
u32
 
¥od_id
, 
om≠_id
;

69 
¥od_id
 = 
	`om≠_ªadl
(
OMAP_PRODUCTION_ID_1
);

70 
om≠_id
 = 
	`om≠_ªadl
(
OMAP32_ID_1
);

73 i‡(((
¥od_id
 >> 20Ë=0Ë|| (¥od_id =
om≠_id
))

74 
¥od_id
 = 0;

76 
¥od_id
 &= 0xffff;

78 i‡(
¥od_id
)

79  
¥od_id
;

82 
¥od_id
 = ((
om≠_id
 >> 12) & 0xffff);

84  
¥od_id
;

85 
	}
}

93 
u8
 
__öô
 
	$om≠_gë_dõ_ªv
()

95 
u32
 
dõ_ªv
;

97 
dõ_ªv
 = 
	`om≠_ªadl
(
OMAP_DIE_ID_1
);

100 i‡(((
dõ_ªv
 >> 12Ë& 0xffffË=
	`om≠_gë_jèg_id
())

101 
dõ_ªv
 = 0;

103 
dõ_ªv
 = (die_rev >> 17) & 0xf;

104 i‡(
dõ_ªv
)

105  
dõ_ªv
;

107 
dõ_ªv
 = (
	`om≠_ªadl
(
OMAP32_ID_1
) >> 28) & 0xf;

109  
dõ_ªv
;

110 
	}
}

112 
__öô
 
	$om≠_check_ªvisi⁄
()

114 
i
;

115 
u16
 
jèg_id
;

116 
u8
 
dõ_ªv
;

117 
u32
 
om≠_id
;

118 
u8
 
˝u_ty≥
;

120 
jèg_id
 = 
	`om≠_gë_jèg_id
();

121 
dõ_ªv
 = 
	`om≠_gë_dõ_ªv
();

122 
om≠_id
 = 
	`om≠_ªadl
(
OMAP32_ID_0
);

124 #ifde‡
DEBUG


125 
	`¥ötk
("OMAP_DIE_ID_0: 0x%08x\n", 
	`om≠_ªadl
(
OMAP_DIE_ID_0
));

126 
	`¥ötk
("OMAP_DIE_ID_1: 0x%08x DIE_REV: %i\n",

127 
	`om≠_ªadl
(
OMAP_DIE_ID_1
),

128 (
	`om≠_ªadl
(
OMAP_DIE_ID_1
) >> 17) & 0xf);

129 
	`¥ötk
("OMAP_PRODUCTION_ID_0: 0x%08x\n", 
	`om≠_ªadl
(
OMAP_PRODUCTION_ID_0
));

130 
	`¥ötk
("OMAP_PRODUCTION_ID_1: 0x%08x JTAG_ID: 0x%04x\n",

131 
	`om≠_ªadl
(
OMAP_PRODUCTION_ID_1
),

132 
	`om≠_ªadl
(
OMAP_PRODUCTION_ID_1
) & 0xffff);

133 
	`¥ötk
("OMAP32_ID_0: 0x%08x\n", 
	`om≠_ªadl
(
OMAP32_ID_0
));

134 
	`¥ötk
("OMAP32_ID_1: 0x%08x\n", 
	`om≠_ªadl
(
OMAP32_ID_1
));

135 
	`¥ötk
("JTAG_ID: 0x%04x DIE_REV: %i\n", 
jèg_id
, 
dõ_ªv
);

138 
sy°em_£rül_high
 = 
	`om≠_ªadl
(
OMAP_DIE_ID_0
);

139 
sy°em_£rül_low
 = 
	`om≠_ªadl
(
OMAP_DIE_ID_1
);

142 
i
 = 0; i < 
	`ARRAY_SIZE
(
om≠_ids
); i++) {

143 i‡(
jèg_id
 =(
om≠_ids
[
i
].jtag_id)) {

144 
sy°em_ªv
 = 
om≠_ids
[
i
].
ty≥
;

150 
i
 = 0; i < 
	`ARRAY_SIZE
(
om≠_ids
); i++) {

151 i‡(
jèg_id
 =
om≠_ids
[
i
].jèg_id && 
dõ_ªv
 == omap_ids[i].die_rev) {

152 
sy°em_ªv
 = 
om≠_ids
[
i
].
ty≥
;

158 
i
 = 0; i < 
	`ARRAY_SIZE
(
om≠_ids
); i++) {

159 i‡(
jèg_id
 =
om≠_ids
[
i
].jtag_id

160 && 
dõ_ªv
 =
om≠_ids
[
i
].die_rev

161 && 
om≠_id
 =
om≠_ids
[
i
].omap_id) {

162 
sy°em_ªv
 = 
om≠_ids
[
i
].
ty≥
;

168 
˝u_ty≥
 = 
sy°em_ªv
 >> 24;

170 
˝u_ty≥
) {

172 
sy°em_ªv
 |= 0x07;

176 
sy°em_ªv
 |= 0x15;

180 
sy°em_ªv
 |= 0x16;

183 
sy°em_ªv
 |= 0x24;

186 
	`¥ötk
("Unknow¿OMAP cpuÅy≥: 0x%02x\n", 
˝u_ty≥
);

189 
	`¥ötk
("OMAP%04x", 
sy°em_ªv
 >> 16);

190 i‡((
sy°em_ªv
 >> 8) & 0xff)

191 
	`¥ötk
("%x", (
sy°em_ªv
 >> 8) & 0xff);

192 
	`¥ötk
("Ñevision %i handledás %02xxx id: %08x%08x\n",

193 
dõ_ªv
, 
sy°em_ªv
 & 0xff, 
sy°em_£rül_low
,

194 
sy°em_£rül_high
);

195 
	}
}

	@arch/arm/mach-omap1/io.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/öô.h
>

15 
	~<asm/éb.h
>

16 
	~<asm/mach/m≠.h
>

17 
	~<asm/io.h
>

18 
	~<asm/¨ch/mux.h
>

19 
	~<asm/¨ch/tc.h
>

21 
om≠1_˛k_öô
();

22 
om≠_check_ªvisi⁄
();

23 
om≠_§am_öô
();

24 
om≠fb_ª£rve_sdøm
();

30 
m≠_desc
 
	gom≠_io_desc
[] 
	g__öôd©a
 = {

32 .
vútuÆ
 = 
IO_VIRT
,

33 .
	gp‚
 = 
__phys_to_p‚
(
IO_PHYS
),

34 .
	gÀngth
 = 
IO_SIZE
,

35 .
	gty≥
 = 
MT_DEVICE


39 #ifde‡
CONFIG_ARCH_OMAP730


40 
m≠_desc
 
	gom≠730_io_desc
[] 
	g__öôd©a
 = {

42 .
vútuÆ
 = 
OMAP730_DSP_BASE
,

43 .
	gp‚
 = 
__phys_to_p‚
(
OMAP730_DSP_START
),

44 .
	gÀngth
 = 
OMAP730_DSP_SIZE
,

45 .
	gty≥
 = 
MT_DEVICE


47 .
	gvútuÆ
 = 
OMAP730_DSPREG_BASE
,

48 .
	gp‚
 = 
__phys_to_p‚
(
OMAP730_DSPREG_START
),

49 .
	gÀngth
 = 
OMAP730_DSPREG_SIZE
,

50 .
	gty≥
 = 
MT_DEVICE


55 #ifde‡
CONFIG_ARCH_OMAP15XX


56 
m≠_desc
 
	gom≠1510_io_desc
[] 
	g__öôd©a
 = {

58 .
vútuÆ
 = 
OMAP1510_DSP_BASE
,

59 .
	gp‚
 = 
__phys_to_p‚
(
OMAP1510_DSP_START
),

60 .
	gÀngth
 = 
OMAP1510_DSP_SIZE
,

61 .
	gty≥
 = 
MT_DEVICE


63 .
	gvútuÆ
 = 
OMAP1510_DSPREG_BASE
,

64 .
	gp‚
 = 
__phys_to_p‚
(
OMAP1510_DSPREG_START
),

65 .
	gÀngth
 = 
OMAP1510_DSPREG_SIZE
,

66 .
	gty≥
 = 
MT_DEVICE


71 #i‡
deföed
(
CONFIG_ARCH_OMAP16XX
)

72 
m≠_desc
 
	gom≠16xx_io_desc
[] 
	g__öôd©a
 = {

74 .
vútuÆ
 = 
OMAP16XX_DSP_BASE
,

75 .
	gp‚
 = 
__phys_to_p‚
(
OMAP16XX_DSP_START
),

76 .
	gÀngth
 = 
OMAP16XX_DSP_SIZE
,

77 .
	gty≥
 = 
MT_DEVICE


79 .
	gvútuÆ
 = 
OMAP16XX_DSPREG_BASE
,

80 .
	gp‚
 = 
__phys_to_p‚
(
OMAP16XX_DSPREG_START
),

81 .
	gÀngth
 = 
OMAP16XX_DSPREG_SIZE
,

82 .
	gty≥
 = 
MT_DEVICE


91 
__öô
 
	$om≠1_m≠_comm⁄_io
()

93 
	`iŸabÀ_öô
(
om≠_io_desc
, 
	`ARRAY_SIZE
(omap_io_desc));

99 
	`loˇl_Êush_éb_Æl
();

100 
	`Êush_ˇche_Æl
();

105 
	`om≠_check_ªvisi⁄
();

107 #ifde‡
CONFIG_ARCH_OMAP730


108 i‡(
	`˝u_is_om≠730
()) {

109 
	`iŸabÀ_öô
(
om≠730_io_desc
, 
	`ARRAY_SIZE
(omap730_io_desc));

112 #ifde‡
CONFIG_ARCH_OMAP15XX


113 i‡(
	`˝u_is_om≠15xx
()) {

114 
	`iŸabÀ_öô
(
om≠1510_io_desc
, 
	`ARRAY_SIZE
(omap1510_io_desc));

117 #i‡
	`deföed
(
CONFIG_ARCH_OMAP16XX
)

118 i‡(
	`˝u_is_om≠16xx
()) {

119 
	`iŸabÀ_öô
(
om≠16xx_io_desc
, 
	`ARRAY_SIZE
(omap16xx_io_desc));

123 
	`om≠_§am_öô
();

124 
	`om≠fb_ª£rve_sdøm
();

125 
	}
}

131 
__öô
 
	$om≠1_öô_comm⁄_hw
()

136 
	`om≠_wrôew
(0x0, 
MPU_PUBLIC_TIPB_CNTL
);

137 
	`om≠_wrôew
(0x0, 
MPU_PRIVATE_TIPB_CNTL
);

141 
	`om≠1_˛k_öô
();

143 
	`om≠1_mux_öô
();

144 
	}
}

	@arch/arm/mach-omap1/irq.c

39 
	~<löux/öô.h
>

40 
	~<löux/moduÀ.h
>

41 
	~<löux/sched.h
>

42 
	~<löux/öãºu±.h
>

44 
	~<asm/h¨dw¨e.h
>

45 
	~<asm/úq.h
>

46 
	~<asm/mach/úq.h
>

47 
	~<asm/¨ch/gpio.h
>

48 
	~<asm/¨ch/˝u.h
>

50 
	~<asm/io.h
>

52 
	#IRQ_BANK
(
úq
Ë((úqË>> 5)

	)

53 
	#IRQ_BIT
(
úq
Ë((úqË& 0x1f)

	)

55 
	som≠_úq_b™k
 {

56 
	mba£_ªg
;

57 
	måiggî_m≠
;

58 
	mwake_íabÀ
;

61 
	gúq_b™k_cou¡
;

62 
om≠_úq_b™k
 *
	gúq_b™ks
;

64 
ölöe
 
	$úq_b™k_ªadl
(
b™k
, 
off£t
)

66  
	`om≠_ªadl
(
úq_b™ks
[
b™k
].
ba£_ªg
 + 
off£t
);

67 
	}
}

69 
ölöe
 
	$úq_b™k_wrôñ
(
vÆue
, 
b™k
, 
off£t
)

71 
	`om≠_wrôñ
(
vÆue
, 
úq_b™ks
[
b™k
].
ba£_ªg
 + 
off£t
);

72 
	}
}

74 
	$om≠_ack_úq
(
úq
)

76 i‡(
úq
 > 31)

77 
	`om≠_wrôñ
(0x1, 
OMAP_IH2_BASE
 + 
IRQ_CONTROL_REG_OFFSET
);

79 
	`om≠_wrôñ
(0x1, 
OMAP_IH1_BASE
 + 
IRQ_CONTROL_REG_OFFSET
);

80 
	}
}

82 
	$om≠_mask_úq
(
úq
)

84 
b™k
 = 
	`IRQ_BANK
(
úq
);

85 
u32
 
l
;

87 
l
 = 
	`om≠_ªadl
(
úq_b™ks
[
b™k
].
ba£_ªg
 + 
IRQ_MIR_REG_OFFSET
);

88 
l
 |1 << 
	`IRQ_BIT
(
úq
);

89 
	`om≠_wrôñ
(
l
, 
úq_b™ks
[
b™k
].
ba£_ªg
 + 
IRQ_MIR_REG_OFFSET
);

90 
	}
}

92 
	$om≠_unmask_úq
(
úq
)

94 
b™k
 = 
	`IRQ_BANK
(
úq
);

95 
u32
 
l
;

97 
l
 = 
	`om≠_ªadl
(
úq_b™ks
[
b™k
].
ba£_ªg
 + 
IRQ_MIR_REG_OFFSET
);

98 
l
 &~(1 << 
	`IRQ_BIT
(
úq
));

99 
	`om≠_wrôñ
(
l
, 
úq_b™ks
[
b™k
].
ba£_ªg
 + 
IRQ_MIR_REG_OFFSET
);

100 
	}
}

102 
	$om≠_mask_ack_úq
(
úq
)

104 
	`om≠_mask_úq
(
úq
);

105 
	`om≠_ack_úq
(
úq
);

106 
	}
}

108 
	$om≠_wake_úq
(
úq
, 
íabÀ
)

110 
b™k
 = 
	`IRQ_BANK
(
úq
);

112 i‡(
íabÀ
)

113 
úq_b™ks
[
b™k
].
wake_íabÀ
 |
	`IRQ_BIT
(
úq
);

115 
úq_b™ks
[
b™k
].
wake_íabÀ
 &~
	`IRQ_BIT
(
úq
);

118 
	}
}

128 
	$om≠_úq_£t_cfg
(
úq
, 
fiq
, 
¥i‹ôy
, 
åiggî
)

130 sig√d 
b™k
;

131 
vÆ
, 
off£t
;

133 
b™k
 = 
	`IRQ_BANK
(
úq
);

135 
fiq
 = 
b™k
 ? 0 : (fiq & 0x1);

136 
vÆ
 = 
fiq
 | ((
¥i‹ôy
 & 0x1fË<< 2Ë| ((
åiggî
 & 0x1) << 1);

137 
off£t
 = 
IRQ_ILR0_REG_OFFSET
 + 
	`IRQ_BIT
(
úq
) * 0x4;

138 
	`úq_b™k_wrôñ
(
vÆ
, 
b™k
, 
off£t
);

139 
	}
}

141 #ifde‡
CONFIG_ARCH_OMAP730


142 
om≠_úq_b™k
 
	gom≠730_úq_b™ks
[] = {

143 { .
ba£_ªg
 = 
OMAP_IH1_BASE
, .
	gåiggî_m≠
 = 0xb3f8e22f },

144 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
, .
	gåiggî_m≠
 = 0xfdb9c1f2 },

145 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
 + 0x100, .
	gåiggî_m≠
 = 0x800040f3 },

149 #ifde‡
CONFIG_ARCH_OMAP15XX


150 
om≠_úq_b™k
 
	gom≠1510_úq_b™ks
[] = {

151 { .
ba£_ªg
 = 
OMAP_IH1_BASE
, .
	gåiggî_m≠
 = 0xb3febfff },

152 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
, .
	gåiggî_m≠
 = 0xffbfffed },

154 
om≠_úq_b™k
 
	gom≠310_úq_b™ks
[] = {

155 { .
ba£_ªg
 = 
OMAP_IH1_BASE
, .
	gåiggî_m≠
 = 0xb3faefc3 },

156 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
, .
	gåiggî_m≠
 = 0x65b3c061 },

160 #i‡
deföed
(
CONFIG_ARCH_OMAP16XX
)

162 
om≠_úq_b™k
 
	gom≠1610_úq_b™ks
[] = {

163 { .
ba£_ªg
 = 
OMAP_IH1_BASE
, .
	gåiggî_m≠
 = 0xb3fefe8f },

164 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
, .
	gåiggî_m≠
 = 0xfdb7c1fd },

165 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
 + 0x100, .
	gåiggî_m≠
 = 0xffffb7ff },

166 { .
	gba£_ªg
 = 
OMAP_IH2_BASE
 + 0x200, .
	gåiggî_m≠
 = 0xffffffff },

170 
úq_chù
 
	gom≠_úq_chù
 = {

171 .
«me
 = "MPU",

172 .
	gack
 = 
om≠_mask_ack_úq
,

173 .
	gmask
 = 
om≠_mask_úq
,

174 .
	gunmask
 = 
om≠_unmask_úq
,

175 .
	g£t_wake
 = 
om≠_wake_úq
,

178 
__öô
 
	$om≠_öô_úq
()

180 
i
, 
j
;

182 #ifde‡
CONFIG_ARCH_OMAP730


183 i‡(
	`˝u_is_om≠730
()) {

184 
úq_b™ks
 = 
om≠730_úq_b™ks
;

185 
úq_b™k_cou¡
 = 
	`ARRAY_SIZE
(
om≠730_úq_b™ks
);

188 #ifde‡
CONFIG_ARCH_OMAP15XX


189 i‡(
	`˝u_is_om≠1510
()) {

190 
úq_b™ks
 = 
om≠1510_úq_b™ks
;

191 
úq_b™k_cou¡
 = 
	`ARRAY_SIZE
(
om≠1510_úq_b™ks
);

193 i‡(
	`˝u_is_om≠310
()) {

194 
úq_b™ks
 = 
om≠310_úq_b™ks
;

195 
úq_b™k_cou¡
 = 
	`ARRAY_SIZE
(
om≠310_úq_b™ks
);

198 #i‡
	`deföed
(
CONFIG_ARCH_OMAP16XX
)

199 i‡(
	`˝u_is_om≠16xx
()) {

200 
úq_b™ks
 = 
om≠1610_úq_b™ks
;

201 
úq_b™k_cou¡
 = 
	`ARRAY_SIZE
(
om≠1610_úq_b™ks
);

204 
	`¥ötk
("Total of %i interrupts in %i interrupt banks\n",

205 
úq_b™k_cou¡
 * 32, irq_bank_count);

208 
i
 = 0; i < 
úq_b™k_cou¡
; i++) {

209 
	`úq_b™k_wrôñ
(~0x0, 
i
, 
IRQ_MIR_REG_OFFSET
);

210 
	`úq_b™k_wrôñ
(0x0, 
i
, 
IRQ_ITR_REG_OFFSET
);

214 
	`úq_b™k_wrôñ
(0x03, 0, 
IRQ_CONTROL_REG_OFFSET
);

215 
	`úq_b™k_wrôñ
(0x03, 1, 
IRQ_CONTROL_REG_OFFSET
);

218 i‡(
	`˝u_is_om≠730
()) {

219 
	`úq_b™k_wrôñ
(0x0, 0, 
IRQ_GMR_REG_OFFSET
);

223 
i
 = 0; i < 
úq_b™k_cou¡
; i++) {

224 
j
 = 
i
 * 32; j < (i + 1) * 32; j++) {

225 
úq_åiggî
;

227 
úq_åiggî
 = 
úq_b™ks
[
i
].
åiggî_m≠
 >> 
	`IRQ_BIT
(
j
);

228 
	`om≠_úq_£t_cfg
(
j
, 0, 0, 
úq_åiggî
);

230 
	`£t_úq_chù
(
j
, &
om≠_úq_chù
);

231 
	`£t_úq_h™dÀr
(
j
, 
h™dÀ_Àvñ_úq
);

232 
	`£t_úq_Êags
(
j
, 
IRQF_VALID
);

238 i‡(
	`˝u_is_om≠730
())

239 
	`om≠_unmask_úq
(
INT_730_IH2_IRQ
);

240 i‡(
	`˝u_is_om≠15xx
())

241 
	`om≠_unmask_úq
(
INT_1510_IH2_IRQ
);

242 i‡(
	`˝u_is_om≠16xx
())

243 
	`om≠_unmask_úq
(
INT_1610_IH2_IRQ
);

244 
	}
}

	@arch/arm/mach-omap1/leds-h2p2-debug.c

12 
	~<löux/öô.h
>

13 
	~<löux/kî√l_°©.h
>

14 
	~<löux/sched.h
>

16 
	~<asm/io.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/Àds.h
>

19 
	~<asm/sy°em.h
>

20 
	~<asm/mach-ty≥s.h
>

22 
	~<asm/¨ch/Âga.h
>

23 
	~<asm/¨ch/gpio.h
>

25 
	~"Àds.h
"

28 
	#GPIO_LED_RED
 3

	)

29 
	#GPIO_LED_GREEN
 
	`OMAP_MPUIO
(4)

	)

32 
	#LED_STATE_ENABLED
 0x01

	)

33 
	#LED_STATE_CLAIMED
 0x02

	)

34 
	#LED_TIMER_ON
 0x04

	)

36 
	#GPIO_IDLE
 
GPIO_LED_GREEN


	)

37 
	#GPIO_TIMER
 
GPIO_LED_RED


	)

40 
	$h2p2_dbg_Àds_evít
(
Àd_evít_t
 
evt
)

42 
Êags
;

44 
h2p2_dbg_Âga
 
__iomem
 *
Âga
;

45 
u16
 
Àd_°©e
, 
hw_Àd_°©e
;

47 
	`loˇl_úq_ßve
(
Êags
);

49 i‡(!(
Àd_°©e
 & 
LED_STATE_ENABLED
Ë&& 
evt
 !
Àd_°¨t
)

50 
d⁄e
;

52 
evt
) {

53 
Àd_°¨t
:

54 i‡(!
Âga
)

55 
Âga
 = 
	`i‹em≠
(
H2P2_DBG_FPGA_START
,

56 
H2P2_DBG_FPGA_SIZE
);

57 i‡(
Âga
) {

58 
Àd_°©e
 |
LED_STATE_ENABLED
;

59 
	`__øw_wrôew
(~0, &
Âga
->
Àds
);

63 
Àd_°›
:

64 
Àd_hÆãd
:

67 i‡(! 
	`machöe_is_om≠_≥r£us2
()) {

68 
	`om≠_£t_gpio_d©aout
(
GPIO_TIMER
, 0);

69 
	`om≠_£t_gpio_d©aout
(
GPIO_IDLE
, 0);

72 
	`__øw_wrôew
(~0, &
Âga
->
Àds
);

73 
Àd_°©e
 &~
LED_STATE_ENABLED
;

74 i‡(
evt
 =
Àd_hÆãd
) {

75 
	`iounm≠
(
Âga
);

76 
Âga
 = 
NULL
;

79 
d⁄e
;

81 
Àd_˛aim
:

82 
Àd_°©e
 |
LED_STATE_CLAIMED
;

83 
hw_Àd_°©e
 = 0;

86 
Àd_ªÀa£
:

87 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

90 #ifde‡
CONFIG_LEDS_TIMER


91 
Àd_timî
:

92 
Àd_°©e
 ^
LED_TIMER_ON
;

94 i‡(
	`machöe_is_om≠_≥r£us2
())

95 
hw_Àd_°©e
 ^
H2P2_DBG_FPGA_P2_LED_TIMER
;

97 
	`om≠_£t_gpio_d©aout
(
GPIO_TIMER
, 
Àd_°©e
 & 
LED_TIMER_ON
);

98 
d⁄e
;

104 #ifde‡
CONFIG_LEDS_CPU


105 
Àd_idÀ_°¨t
:

106 i‡(
	`machöe_is_om≠_≥r£us2
())

107 
hw_Àd_°©e
 |
H2P2_DBG_FPGA_P2_LED_IDLE
;

109 
	`om≠_£t_gpio_d©aout
(
GPIO_IDLE
, 1);

110 
d⁄e
;

115 
Àd_idÀ_íd
:

116 i‡(
	`machöe_is_om≠_≥r£us2
())

117 
hw_Àd_°©e
 &~
H2P2_DBG_FPGA_P2_LED_IDLE
;

119 
	`om≠_£t_gpio_d©aout
(
GPIO_IDLE
, 0);

120 
d⁄e
;

126 
Àd_gªí_⁄
:

127 
hw_Àd_°©e
 |
H2P2_DBG_FPGA_LED_GREEN
;

129 
Àd_gªí_off
:

130 
hw_Àd_°©e
 &~
H2P2_DBG_FPGA_LED_GREEN
;

133 
Àd_ambî_⁄
:

134 
hw_Àd_°©e
 |
H2P2_DBG_FPGA_LED_AMBER
;

136 
Àd_ambî_off
:

137 
hw_Àd_°©e
 &~
H2P2_DBG_FPGA_LED_AMBER
;

140 
Àd_ªd_⁄
:

141 
hw_Àd_°©e
 |
H2P2_DBG_FPGA_LED_RED
;

143 
Àd_ªd_off
:

144 
hw_Àd_°©e
 &~
H2P2_DBG_FPGA_LED_RED
;

147 
Àd_blue_⁄
:

148 
hw_Àd_°©e
 |
H2P2_DBG_FPGA_LED_BLUE
;

150 
Àd_blue_off
:

151 
hw_Àd_°©e
 &~
H2P2_DBG_FPGA_LED_BLUE
;

162 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

163 
	`__øw_wrôew
(~
hw_Àd_°©e
, &
Âga
->
Àds
);

165 
d⁄e
:

166 
	`loˇl_úq_ª°‹e
(
Êags
);

167 
	}
}

	@arch/arm/mach-omap1/leds-innovator.c

4 
	~<löux/öô.h
>

6 
	~<asm/h¨dw¨e.h
>

7 
	~<asm/Àds.h
>

8 
	~<asm/sy°em.h
>

10 
	~"Àds.h
"

13 
	#LED_STATE_ENABLED
 1

	)

14 
	#LED_STATE_CLAIMED
 2

	)

16 
	gÀd_°©e
;

17 
	ghw_Àd_°©e
;

19 
	$önov©‹_Àds_evít
(
Àd_evít_t
 
evt
)

21 
Êags
;

23 
	`loˇl_úq_ßve
(
Êags
);

25 
evt
) {

26 
Àd_°¨t
:

27 
hw_Àd_°©e
 = 0;

28 
Àd_°©e
 = 
LED_STATE_ENABLED
;

31 
Àd_°›
:

32 
Àd_°©e
 &~
LED_STATE_ENABLED
;

33 
hw_Àd_°©e
 = 0;

36 
Àd_˛aim
:

37 
Àd_°©e
 |
LED_STATE_CLAIMED
;

38 
hw_Àd_°©e
 = 0;

41 
Àd_ªÀa£
:

42 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

43 
hw_Àd_°©e
 = 0;

46 #ifde‡
CONFIG_LEDS_TIMER


47 
Àd_timî
:

48 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

49 
hw_Àd_°©e
 ^= 0;

53 #ifde‡
CONFIG_LEDS_CPU


54 
Àd_idÀ_°¨t
:

55 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

56 
hw_Àd_°©e
 |= 0;

59 
Àd_idÀ_íd
:

60 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

61 
hw_Àd_°©e
 &= ~0;

65 
Àd_hÆãd
:

68 
Àd_gªí_⁄
:

69 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

70 
hw_Àd_°©e
 &= ~0;

73 
Àd_gªí_off
:

74 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

75 
hw_Àd_°©e
 |= 0;

78 
Àd_ambî_⁄
:

81 
Àd_ambî_off
:

84 
Àd_ªd_⁄
:

85 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

86 
hw_Àd_°©e
 &= ~0;

89 
Àd_ªd_off
:

90 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

91 
hw_Àd_°©e
 |= 0;

98 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

101 
	`loˇl_úq_ª°‹e
(
Êags
);

102 
	}
}

	@arch/arm/mach-omap1/leds-osk.c

6 
	~<löux/öô.h
>

7 
	~<löux/w‹kqueue.h
>

9 
	~<asm/h¨dw¨e.h
>

10 
	~<asm/Àds.h
>

11 
	~<asm/sy°em.h
>

13 
	~<asm/¨ch/gpio.h
>

14 
	~<asm/¨ch/çs65010.h
>

16 
	~"Àds.h
"

19 
	#LED_STATE_ENABLED
 (1 << 0)

	)

20 
	#LED_STATE_CLAIMED
 (1 << 1)

	)

21 
u8
 
	gÀd_°©e
;

23 
	#GREEN_LED
 (1 << 0Ë

	)

24 
	#AMBER_LED
 (1 << 1Ë

	)

25 
	#RED_LED
 (1 << 2Ë

	)

26 
	#TIMER_LED
 (1 << 3Ë

	)

27 
	#IDLE_LED
 (1 << 4Ë

	)

28 
u8
 
	ghw_Àd_°©e
;

34 
	#TPS_LEDS
 (
GREEN_LED
 | 
RED_LED
 | 
AMBER_LED
)

	)

36 
u8
 
	gçs_Àds_ch™ge
;

38 
	$çs_w‹k
(
w‹k_°ru˘
 *
unu£d
)

41 
u8
 
Àds
;

43 
	`loˇl_úq_dißbÀ
();

44 
Àds
 = 
çs_Àds_ch™ge
;

45 
çs_Àds_ch™ge
 = 0;

46 
	`loˇl_úq_íabÀ
();

48 i‡(!
Àds
)

52 i‡(
Àds
 & 
GREEN_LED
)

53 
	`çs65010_£t_Àd
(
LED1
, !!(
hw_Àd_°©e
 & 
GREEN_LED
));

54 i‡(
Àds
 & 
AMBER_LED
)

55 
	`çs65010_£t_Àd
(
LED2
, !!(
hw_Àd_°©e
 & 
AMBER_LED
));

58 i‡(
Àds
 & 
RED_LED
)

59 
	`çs65010_£t_gpio_out_vÆue
(
GPIO2
,

60 !(
hw_Àd_°©e
 & 
RED_LED
));

62 
	}
}

64 
DECLARE_WORK
(
w‹k
, 
çs_w‹k
);

66 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


73 
	#GPIO_LED_RED
 3

	)

74 
	#GPIO_LED_GREEN
 
	`OMAP_MPUIO
(4)

	)

76 
	$mi°øl_£éed
()

78 
ªd
 = 0;

79 
gªí
 = 0;

81 i‡(
hw_Àd_°©e
 & 
TIMER_LED
)

82 
ªd
 = 1;

83 i‡(
hw_Àd_°©e
 & 
IDLE_LED
)

84 
gªí
 = 1;

87 
	`om≠_£t_gpio_d©aout
(
GPIO_LED_GREEN
, 
gªí
);

88 
	`om≠_£t_gpio_d©aout
(
GPIO_LED_RED
, 
ªd
);

89 
	}
}

93 
	$osk_Àds_evít
(
Àd_evít_t
 
evt
)

95 
Êags
;

96 
u16
 
Àds
;

98 
	`loˇl_úq_ßve
(
Êags
);

100 i‡(!(
Àd_°©e
 & 
LED_STATE_ENABLED
Ë&& 
evt
 !
Àd_°¨t
)

101 
d⁄e
;

103 
Àds
 = 
hw_Àd_°©e
;

104 
evt
) {

105 
Àd_°¨t
:

106 
Àd_°©e
 |
LED_STATE_ENABLED
;

107 
hw_Àd_°©e
 = 0;

108 
Àds
 = ~0;

111 
Àd_hÆãd
:

112 
Àd_°›
:

113 
Àd_°©e
 &~
LED_STATE_ENABLED
;

114 
hw_Àd_°©e
 = 0;

118 
Àd_˛aim
:

119 
Àd_°©e
 |
LED_STATE_CLAIMED
;

120 
hw_Àd_°©e
 = 0;

121 
Àds
 = ~0;

124 
Àd_ªÀa£
:

125 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

126 
hw_Àd_°©e
 = 0;

129 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


131 
Àd_timî
:

132 
hw_Àd_°©e
 ^
TIMER_LED
;

133 
	`mi°øl_£éed
();

136 
Àd_idÀ_°¨t
:

137 
hw_Àd_°©e
 |
IDLE_LED
;

138 
	`mi°øl_£éed
();

141 
Àd_idÀ_íd
:

142 
hw_Àd_°©e
 &~
IDLE_LED
;

143 
	`mi°øl_£éed
();

151 
Àd_gªí_⁄
:

152 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

153 
hw_Àd_°©e
 |
GREEN_LED
;

155 
Àd_gªí_off
:

156 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

157 
hw_Àd_°©e
 &~
GREEN_LED
;

161 
Àd_ambî_⁄
:

162 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

163 
hw_Àd_°©e
 |
AMBER_LED
;

165 
Àd_ambî_off
:

166 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

167 
hw_Àd_°©e
 &~
AMBER_LED
;

171 
Àd_ªd_⁄
:

172 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

173 
hw_Àd_°©e
 |
RED_LED
;

175 
Àd_ªd_off
:

176 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

177 
hw_Àd_°©e
 &~
RED_LED
;

184 
Àds
 ^
hw_Àd_°©e
;

185 
Àds
 &
TPS_LEDS
;

186 i‡(
Àds
 && (
Àd_°©e
 & 
LED_STATE_CLAIMED
)) {

187 
çs_Àds_ch™ge
 |
Àds
;

188 
	`scheduÀ_w‹k
(&
w‹k
);

191 
d⁄e
:

192 
	`loˇl_úq_ª°‹e
(
Êags
);

193 
	}
}

	@arch/arm/mach-omap1/leds.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/öô.h
>

9 
	~<asm/Àds.h
>

10 
	~<asm/mach-ty≥s.h
>

12 
	~<asm/¨ch/gpio.h
>

13 
	~<asm/¨ch/mux.h
>

15 
	~"Àds.h
"

17 
__öô


18 
	$om≠_Àds_öô
()

20 i‡(
	`machöe_is_om≠_önov©‹
())

21 
Àds_evít
 = 
önov©‹_Àds_evít
;

23 i‡(
	`machöe_is_om≠_h2
()

24 || 
	`machöe_is_om≠_h3
()

25 || 
	`machöe_is_om≠_≥r£us2
())

26 
Àds_evít
 = 
h2p2_dbg_Àds_evít
;

28 i‡(
	`machöe_is_om≠_osk
())

29 
Àds_evít
 = 
osk_Àds_evít
;

34 i‡(
	`machöe_is_om≠_h2
()

35 || 
	`machöe_is_om≠_h3
()

36 #ifdef 
CONFIG_OMAP_OSK_MISTRAL


37 || 
	`machöe_is_om≠_osk
()

49 
	`om≠_cfg_ªg
(
P18_1610_GPIO3
);

50 i‡(
	`om≠_ªque°_gpio
(3) == 0)

51 
	`om≠_£t_gpio_dúe˘i⁄
(3, 0);

53 
	`¥ötk
(
KERN_WARNING
 "LED: can't get GPIO3/red?\n");

55 
	`om≠_cfg_ªg
(
MPUIO4
);

56 i‡(
	`om≠_ªque°_gpio
(
	`OMAP_MPUIO
(4)) == 0)

57 
	`om≠_£t_gpio_dúe˘i⁄
(
	`OMAP_MPUIO
(4), 0);

59 
	`¥ötk
(
KERN_WARNING
 "LED: can't get MPUIO4/green?\n");

62 
	`Àds_evít
(
Àd_°¨t
);

64 
	}
}

66 
__öôˇŒ
(
om≠_Àds_öô
);

	@arch/arm/mach-omap1/leds.h

1 
önov©‹_Àds_evít
(
Àd_evít_t
 
evt
);

2 
h2p2_dbg_Àds_evít
(
Àd_evít_t
 
evt
);

3 
osk_Àds_evít
(
Àd_evít_t
 
evt
);

	@arch/arm/mach-omap1/mailbox.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/ªsour˚.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

16 
	~<asm/¨ch/maûbox.h
>

17 
	~<asm/¨ch/úqs.h
>

18 
	~<asm/io.h
>

20 
	#MAILBOX_ARM2DSP1
 0x00

	)

21 
	#MAILBOX_ARM2DSP1b
 0x04

	)

22 
	#MAILBOX_DSP2ARM1
 0x08

	)

23 
	#MAILBOX_DSP2ARM1b
 0x0c

	)

24 
	#MAILBOX_DSP2ARM2
 0x10

	)

25 
	#MAILBOX_DSP2ARM2b
 0x14

	)

26 
	#MAILBOX_ARM2DSP1_Fœg
 0x18

	)

27 
	#MAILBOX_DSP2ARM1_Fœg
 0x1c

	)

28 
	#MAILBOX_DSP2ARM2_Fœg
 0x20

	)

30 
	gmbox_ba£
;

32 
	som≠_mbox1_fifo
 {

33 
	mcmd
;

34 
	md©a
;

35 
	mÊag
;

38 
	som≠_mbox1_¥iv
 {

39 
om≠_mbox1_fifo
 
	mtx_fifo
;

40 
om≠_mbox1_fifo
 
	mrx_fifo
;

43 
ölöe
 
	$mbox_ªad_ªg
(
ªg
)

45  
	`__øw_ªadw
(
mbox_ba£
 + 
ªg
);

46 
	}
}

48 
ölöe
 
	$mbox_wrôe_ªg
(
vÆ
, 
ªg
)

50 
	`__øw_wrôew
(
vÆ
, 
mbox_ba£
 + 
ªg
);

51 
	}
}

54 
ölöe
 
mbox_msg_t
 
	$om≠1_mbox_fifo_ªad
(
om≠_mbox
 *
mbox
)

56 
om≠_mbox1_fifo
 *
fifo
 =

57 &((
om≠_mbox1_¥iv
 *)
mbox
->
¥iv
)->
rx_fifo
;

58 
mbox_msg_t
 
msg
;

60 
msg
 = 
	`mbox_ªad_ªg
(
fifo
->
d©a
);

61 
msg
 |((
mbox_msg_t
Ë
	`mbox_ªad_ªg
(
fifo
->
cmd
)) << 16;

63  
msg
;

64 
	}
}

66 
ölöe
 

67 
	$om≠1_mbox_fifo_wrôe
(
om≠_mbox
 *
mbox
, 
mbox_msg_t
 
msg
)

69 
om≠_mbox1_fifo
 *
fifo
 =

70 &((
om≠_mbox1_¥iv
 *)
mbox
->
¥iv
)->
tx_fifo
;

72 
	`mbox_wrôe_ªg
(
msg
 & 0xffff, 
fifo
->
d©a
);

73 
	`mbox_wrôe_ªg
(
msg
 >> 16, 
fifo
->
cmd
);

74 
	}
}

76 
ölöe
 
	$om≠1_mbox_fifo_em±y
(
om≠_mbox
 *
mbox
)

79 
	}
}

81 
ölöe
 
	$om≠1_mbox_fifo_fuŒ
(
om≠_mbox
 *
mbox
)

83 
om≠_mbox1_fifo
 *
fifo
 =

84 &((
om≠_mbox1_¥iv
 *)
mbox
->
¥iv
)->
rx_fifo
;

86  (
	`mbox_ªad_ªg
(
fifo
->
Êag
));

87 
	}
}

90 
ölöe
 

91 
	$om≠1_mbox_íabÀ_úq
(
om≠_mbox
 *
mbox
, 
om≠_mbox_ty≥_t
 
úq
)

93 i‡(
úq
 =
IRQ_RX
)

94 
	`íabÀ_úq
(
mbox
->
úq
);

95 
	}
}

97 
ölöe
 

98 
	$om≠1_mbox_dißbÀ_úq
(
om≠_mbox
 *
mbox
, 
om≠_mbox_ty≥_t
 
úq
)

100 i‡(
úq
 =
IRQ_RX
)

101 
	`dißbÀ_úq
(
mbox
->
úq
);

102 
	}
}

104 
ölöe
 

105 
	$om≠1_mbox_is_úq
(
om≠_mbox
 *
mbox
, 
om≠_mbox_ty≥_t
 
úq
)

107 i‡(
úq
 =
IRQ_TX
)

110 
	}
}

112 
om≠_mbox_›s
 
	gom≠1_mbox_›s
 = {

113 .
ty≥
 = 
OMAP_MBOX_TYPE1
,

114 .
	gfifo_ªad
 = 
om≠1_mbox_fifo_ªad
,

115 .
	gfifo_wrôe
 = 
om≠1_mbox_fifo_wrôe
,

116 .
	gfifo_em±y
 = 
om≠1_mbox_fifo_em±y
,

117 .
	gfifo_fuŒ
 = 
om≠1_mbox_fifo_fuŒ
,

118 .
	gíabÀ_úq
 = 
om≠1_mbox_íabÀ_úq
,

119 .
	gdißbÀ_úq
 = 
om≠1_mbox_dißbÀ_úq
,

120 .
	gis_úq
 = 
om≠1_mbox_is_úq
,

126 
om≠_mbox1_¥iv
 
	gom≠1_mbox_d•_¥iv
 = {

127 .
tx_fifo
 = {

128 .
cmd
 = 
MAILBOX_ARM2DSP1b
,

129 .
	gd©a
 = 
MAILBOX_ARM2DSP1
,

130 .
	gÊag
 = 
MAILBOX_ARM2DSP1_Fœg
,

132 .
	grx_fifo
 = {

133 .
cmd
 = 
MAILBOX_DSP2ARM1b
,

134 .
	gd©a
 = 
MAILBOX_DSP2ARM1
,

135 .
	gÊag
 = 
MAILBOX_DSP2ARM1_Fœg
,

139 
om≠_mbox
 
	gmbox_d•_öfo
 = {

140 .
«me
 = "dsp",

141 .
	g›s
 = &
om≠1_mbox_›s
,

142 .
	g¥iv
 = &
om≠1_mbox_d•_¥iv
,

144 
EXPORT_SYMBOL
(
mbox_d•_öfo
);

146 
__öô
 
	$om≠1_mbox_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

148 
ªsour˚
 *
ªs
;

149 
ªt
 = 0;

151 i‡(
pdev
->
num_ªsour˚s
 != 2) {

152 
	`dev_îr
(&
pdev
->
dev
, "invalidÇumber ofÑesources: %d\n",

153 
pdev
->
num_ªsour˚s
);

154  -
ENODEV
;

158 
ªs
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_MEM
, 0);

159 i‡(
	`u∆ikñy
(!
ªs
)) {

160 
	`dev_îr
(&
pdev
->
dev
, "invalid memÑesource\n");

161  -
ENODEV
;

163 
mbox_ba£
 = 
ªs
->
°¨t
;

166 
ªs
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_IRQ
, 0);

167 i‡(
	`u∆ikñy
(!
ªs
)) {

168 
	`dev_îr
(&
pdev
->
dev
, "invalid irqÑesource\n");

169  -
ENODEV
;

171 
mbox_d•_öfo
.
úq
 = 
ªs
->
°¨t
;

173 
ªt
 = 
	`om≠_mbox_ªgi°î
(&
mbox_d•_öfo
);

175  
ªt
;

176 
	}
}

178 
	$om≠1_mbox_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

180 
	`om≠_mbox_uƒegi°î
(&
mbox_d•_öfo
);

183 
	}
}

185 
∂©f‹m_drivî
 
	gom≠1_mbox_drivî
 = {

186 .
¥obe
 = 
om≠1_mbox_¥obe
,

187 .
	gªmove
 = 
om≠1_mbox_ªmove
,

188 .
	gdrivî
 = {

189 .
«me
 = "mailbox",

193 
__öô
 
	$om≠1_mbox_öô
()

195  
	`∂©f‹m_drivî_ªgi°î
(&
om≠1_mbox_drivî
);

196 
	}
}

198 
__exô
 
	$om≠1_mbox_exô
()

200 
	`∂©f‹m_drivî_uƒegi°î
(&
om≠1_mbox_drivî
);

201 
	}
}

203 
moduÀ_öô
(
om≠1_mbox_öô
);

204 
moduÀ_exô
(
om≠1_mbox_exô
);

206 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-omap1/mux.c

25 
	~<löux/moduÀ.h
>

26 
	~<löux/öô.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/io.h
>

29 
	~<löux/•ölock.h
>

31 
	~<asm/¨ch/mux.h
>

33 #ifde‡
CONFIG_OMAP_MUX


35 #ifde‡
CONFIG_ARCH_OMAP730


36 
pö_c⁄fig
 
__öôd©a_‹_moduÀ
 
	gom≠730_pös
[] = {

37 
MUX_CFG_730
("E2_730_KBR0", 12, 21, 0, 20, 1, 0)

38 
MUX_CFG_730
("J7_730_KBR1", 12, 25, 0, 24, 1, 0)

39 
MUX_CFG_730
("E1_730_KBR2", 12, 29, 0, 28, 1, 0)

40 
MUX_CFG_730
("F3_730_KBR3", 13, 1, 0, 0, 1, 0)

41 
MUX_CFG_730
("D2_730_KBR4", 13, 5, 0, 4, 1, 0)

42 
MUX_CFG_730
("C2_730_KBC0", 13, 9, 0, 8, 1, 0)

43 
MUX_CFG_730
("D3_730_KBC1", 13, 13, 0, 12, 1, 0)

44 
MUX_CFG_730
("E4_730_KBC2", 13, 17, 0, 16, 1, 0)

45 
MUX_CFG_730
("F4_730_KBC3", 13, 21, 0, 20, 1, 0)

46 
MUX_CFG_730
("E3_730_KBC4", 13, 25, 0, 24, 1, 0)

48 
MUX_CFG_730
("AA17_730_USB_DM", 2, 21, 0, 20, 0, 0)

49 
MUX_CFG_730
("W16_730_USB_PU_EN", 2, 25, 0, 24, 0, 0)

50 
MUX_CFG_730
("W17_730_USB_VBUSI", 2, 29, 0, 28, 0, 0)

54 #i‡
deföed
(
CONFIG_ARCH_OMAP15XX
Ë|| deföed(
CONFIG_ARCH_OMAP16XX
)

55 
pö_c⁄fig
 
__öôd©a_‹_moduÀ
 
	gom≠1xxx_pös
[] = {

60 
MUX_CFG
("UART1_TX", 9, 21, 1, 2, 3, 0, 
NA
, 0, 0)

61 
MUX_CFG
("UART1_RTS", 9, 12, 1, 2, 0, 0, 
NA
, 0, 0)

64 
MUX_CFG
("UART2_TX", 
C
, 27, 1, 3, 3, 0, 
NA
, 0, 0)

65 
MUX_CFG
("UART2_RX", 
C
, 18, 0, 3, 1, 1, 
NA
, 0, 0)

66 
MUX_CFG
("UART2_CTS", 
C
, 21, 0, 3, 1, 1, 
NA
, 0, 0)

67 
MUX_CFG
("UART2_RTS", 
C
, 24, 1, 3, 2, 0, 
NA
, 0, 0)

70 
MUX_CFG
("UART3_TX", 6, 0, 1, 0, 30, 0, 
NA
, 0, 0)

71 
MUX_CFG
("UART3_RX", 6, 3, 0, 0, 31, 1, 
NA
, 0, 0)

72 
MUX_CFG
("UART3_CTS", 5, 12, 2, 0, 24, 0, 
NA
, 0, 0)

73 
MUX_CFG
("UART3_RTS", 5, 15, 2, 0, 25, 0, 
NA
, 0, 0)

74 
MUX_CFG
("UART3_CLKREQ", 9, 27, 0, 2, 5, 0, 
NA
, 0, 0)

75 
MUX_CFG
("UART3_BCLK", 
A
, 0, 0, 2, 6, 0, 
NA
, 0, 0)

76 
MUX_CFG
("Y15_1610_UART3_RTS", 
A
, 0, 1, 2, 6, 0, 
NA
, 0, 0)

79 
MUX_CFG
("PWT", 6, 0, 2, 0, 30, 0, 
NA
, 0, 0)

80 
MUX_CFG
("PWL", 6, 3, 1, 0, 31, 1, 
NA
, 0, 0)

83 
MUX_CFG
("R18_USB_VBUS", 7, 9, 2, 1, 11, 0, 
NA
, 0, 1)

84 
MUX_CFG
("R18_1510_USB_GPIO0", 7, 9, 0, 1, 11, 1, 
NA
, 0, 1)

86 
MUX_CFG
("W4_USB_PUEN", 
D
, 3, 3, 3, 5, 1, 
NA
, 0, 1)

87 
MUX_CFG
("W4_USB_CLKO", 
D
, 3, 1, 3, 5, 0, 
NA
, 0, 1)

88 
MUX_CFG
("W4_USB_HIGHZ", 
D
, 3, 4, 3, 5, 0, 3, 0, 1)

89 
MUX_CFG
("W4_GPIO58", 
D
, 3, 7, 3, 5, 0, 3, 0, 1)

92 
MUX_CFG
("USB1_SUSP", 8, 27, 2, 1, 27, 0, 
NA
, 0, 1)

93 
MUX_CFG
("USB1_SE0", 9, 0, 2, 1, 28, 0, 
NA
, 0, 1)

94 
MUX_CFG
("W13_1610_USB1_SE0", 9, 0, 4, 1, 28, 0, 
NA
, 0, 1)

95 
MUX_CFG
("USB1_TXEN", 9, 3, 2, 1, 29, 0, 
NA
, 0, 1)

96 
MUX_CFG
("USB1_TXD", 9, 24, 1, 2, 4, 0, 
NA
, 0, 1)

97 
MUX_CFG
("USB1_VP", 
A
, 3, 1, 2, 7, 0, 
NA
, 0, 1)

98 
MUX_CFG
("USB1_VM", 
A
, 6, 1, 2, 8, 0, 
NA
, 0, 1)

99 
MUX_CFG
("USB1_RCV", 
A
, 9, 1, 2, 9, 0, 
NA
, 0, 1)

100 
MUX_CFG
("USB1_SPEED", 
A
, 12, 2, 2, 10, 0, 
NA
, 0, 1)

101 
MUX_CFG
("R13_1610_USB1_SPEED", 
A
, 12, 5, 2, 10, 0, 
NA
, 0, 1)

102 
MUX_CFG
("R13_1710_USB1_SEO", 
A
, 12, 5, 2, 10, 0, 
NA
, 0, 1)

105 
MUX_CFG
("USB2_SUSP", 
B
, 3, 1, 2, 17, 0, 
NA
, 0, 1)

106 
MUX_CFG
("USB2_VP", 
B
, 6, 1, 2, 18, 0, 
NA
, 0, 1)

107 
MUX_CFG
("USB2_TXEN", 
B
, 9, 1, 2, 19, 0, 
NA
, 0, 1)

108 
MUX_CFG
("USB2_VM", 
C
, 18, 1, 3, 0, 0, 
NA
, 0, 1)

109 
MUX_CFG
("USB2_RCV", 
C
, 21, 1, 3, 1, 0, 
NA
, 0, 1)

110 
MUX_CFG
("USB2_SE0", 
C
, 24, 2, 3, 2, 0, 
NA
, 0, 1)

111 
MUX_CFG
("USB2_TXD", 
C
, 27, 2, 3, 3, 0, 
NA
, 0, 1)

114 
MUX_CFG
("R18_1510_GPIO0", 7, 9, 0, 1, 11, 1, 0, 0, 1)

115 
MUX_CFG
("R19_1510_GPIO1", 7, 6, 0, 1, 10, 1, 0, 0, 1)

116 
MUX_CFG
("M14_1510_GPIO2", 7, 3, 0, 1, 9, 1, 0, 0, 1)

119 
MUX_CFG
("P18_1610_GPIO3", 7, 0, 0, 1, 8, 0, 
NA
, 0, 1)

120 
MUX_CFG
("Y15_1610_GPIO17", 
A
, 0, 7, 2, 6, 0, 
NA
, 0, 1)

123 
MUX_CFG
("R18_1710_GPIO0", 7, 9, 0, 1, 11, 1, 1, 1, 1)

124 
MUX_CFG
("V2_1710_GPIO10", 
F
, 27, 1, 4, 3, 1, 4, 1, 1)

125 
MUX_CFG
("N21_1710_GPIO14", 6, 9, 0, 1, 1, 1, 1, 1, 1)

126 
MUX_CFG
("W15_1710_GPIO40", 9, 27, 7, 2, 5, 1, 2, 1, 1)

129 
MUX_CFG
("MPUIO2", 7, 18, 0, 1, 14, 1, 
NA
, 0, 1)

130 
MUX_CFG
("N15_1610_MPUIO2", 7, 18, 0, 1, 14, 1, 1, 0, 1)

131 
MUX_CFG
("MPUIO4", 7, 15, 0, 1, 13, 1, 
NA
, 0, 1)

132 
MUX_CFG
("MPUIO5", 7, 12, 0, 1, 12, 1, 
NA
, 0, 1)

134 
MUX_CFG
("T20_1610_MPUIO5", 7, 12, 0, 1, 12, 0, 3, 0, 1)

135 
MUX_CFG
("W11_1610_MPUIO6", 10, 15, 2, 3, 8, 0, 3, 0, 1)

136 
MUX_CFG
("V10_1610_MPUIO7", 
A
, 24, 2, 2, 14, 0, 2, 0, 1)

137 
MUX_CFG
("W11_1610_MPUIO9", 10, 15, 1, 3, 8, 0, 3, 0, 1)

138 
MUX_CFG
("V10_1610_MPUIO10", 
A
, 24, 1, 2, 14, 0, 2, 0, 1)

139 
MUX_CFG
("W10_1610_MPUIO11", 
A
, 18, 2, 2, 11, 0, 2, 0, 1)

140 
MUX_CFG
("E20_1610_MPUIO13", 3, 21, 1, 0, 7, 0, 0, 0, 1)

141 
MUX_CFG
("U20_1610_MPUIO14", 9, 6, 6, 0, 30, 0, 0, 0, 1)

142 
MUX_CFG
("E19_1610_MPUIO15", 3, 18, 1, 0, 6, 0, 0, 0, 1)

145 
MUX_CFG
("MCBSP2_CLKR", 
C
, 6, 0, 2, 27, 1, 
NA
, 0, 1)

146 
MUX_CFG
("MCBSP2_CLKX", 
C
, 9, 0, 2, 29, 1, 
NA
, 0, 1)

147 
MUX_CFG
("MCBSP2_DR", 
C
, 0, 0, 2, 26, 1, 
NA
, 0, 1)

148 
MUX_CFG
("MCBSP2_DX", 
C
, 15, 0, 2, 31, 1, 
NA
, 0, 1)

149 
MUX_CFG
("MCBSP2_FSR", 
C
, 12, 0, 2, 30, 1, 
NA
, 0, 1)

150 
MUX_CFG
("MCBSP2_FSX", 
C
, 3, 0, 2, 27, 1, 
NA
, 0, 1)

153 
MUX_CFG
("MCBSP3_CLKX", 9, 3, 1, 1, 29, 0, 
NA
, 0, 1)

156 
MUX_CFG
("BALLOUT_V8_ARMIO3", 
B
, 18, 0, 2, 25, 1, 
NA
, 0, 1)

157 
MUX_CFG
("N20_HDQ", 6, 18, 1, 1, 4, 0, 1, 4, 0)

160 
MUX_CFG
("W8_1610_MMC2_DAT0", 
B
, 21, 6, 2, 23, 1, 2, 1, 1)

161 
MUX_CFG
("V8_1610_MMC2_DAT1", 
B
, 27, 6, 2, 25, 1, 2, 1, 1)

162 
MUX_CFG
("W15_1610_MMC2_DAT2", 9, 12, 6, 2, 5, 1, 2, 1, 1)

163 
MUX_CFG
("R10_1610_MMC2_DAT3", 
B
, 18, 6, 2, 22, 1, 2, 1, 1)

164 
MUX_CFG
("Y10_1610_MMC2_CLK", 
B
, 3, 6, 2, 17, 0, 2, 0, 1)

165 
MUX_CFG
("Y8_1610_MMC2_CMD", 
B
, 24, 6, 2, 24, 1, 2, 1, 1)

166 
MUX_CFG
("V9_1610_MMC2_CMDDIR", 
B
, 12, 6, 2, 20, 0, 2, 1, 1)

167 
MUX_CFG
("V5_1610_MMC2_DATDIR0", 
B
, 15, 6, 2, 21, 0, 2, 1, 1)

168 
MUX_CFG
("W19_1610_MMC2_DATDIR1", 8, 15, 6, 1, 23, 0, 1, 1, 1)

169 
MUX_CFG
("R18_1610_MMC2_CLKIN", 7, 9, 6, 1, 11, 0, 1, 11, 1)

172 
MUX_CFG
("M19_1610_ETM_PSTAT0", 5, 27, 1, 0, 29, 0, 0, 0, 1)

173 
MUX_CFG
("L15_1610_ETM_PSTAT1", 5, 24, 1, 0, 28, 0, 0, 0, 1)

174 
MUX_CFG
("L18_1610_ETM_PSTAT2", 5, 21, 1, 0, 27, 0, 0, 0, 1)

175 
MUX_CFG
("L19_1610_ETM_D0", 5, 18, 1, 0, 26, 0, 0, 0, 1)

176 
MUX_CFG
("J19_1610_ETM_D6", 5, 0, 1, 0, 20, 0, 0, 0, 1)

177 
MUX_CFG
("J18_1610_ETM_D7", 5, 27, 1, 0, 19, 0, 0, 0, 1)

180 
MUX_CFG
("P20_1610_GPIO4", 6, 27, 0, 1, 7, 0, 1, 1, 1)

181 
MUX_CFG
("V9_1610_GPIO7", 
B
, 12, 1, 2, 20, 0, 2, 1, 1)

182 
MUX_CFG
("W8_1610_GPIO9", 
B
, 21, 0, 2, 23, 0, 2, 1, 1)

183 
MUX_CFG
("N20_1610_GPIO11", 6, 18, 0, 1, 4, 0, 1, 1, 1)

184 
MUX_CFG
("N19_1610_GPIO13", 6, 12, 0, 1, 2, 0, 1, 1, 1)

185 
MUX_CFG
("P10_1610_GPIO22", 
C
, 0, 7, 2, 26, 0, 2, 1, 1)

186 
MUX_CFG
("V5_1610_GPIO24", 
B
, 15, 7, 2, 21, 0, 2, 1, 1)

187 
MUX_CFG
("AA20_1610_GPIO_41", 9, 9, 7, 1, 31, 0, 1, 1, 1)

188 
MUX_CFG
("W19_1610_GPIO48", 8, 15, 7, 1, 23, 1, 1, 0, 1)

189 
MUX_CFG
("M7_1610_GPIO62", 10, 0, 0, 4, 24, 0, 4, 0, 1)

190 
MUX_CFG
("V14_16XX_GPIO37", 9, 18, 7, 2, 2, 0, 2, 2, 0)

191 
MUX_CFG
("R9_16XX_GPIO18", 
C
, 18, 7, 3, 0, 0, 3, 0, 0)

192 
MUX_CFG
("L14_16XX_GPIO49", 6, 3, 7, 0, 31, 0, 0, 31, 0)

195 
MUX_CFG
("V19_1610_UWIRE_SCLK", 8, 6, 0, 1, 20, 0, 1, 1, 1)

196 
MUX_CFG
("U18_1610_UWIRE_SDI", 8, 0, 0, 1, 18, 0, 1, 1, 1)

197 
MUX_CFG
("W21_1610_UWIRE_SDO", 8, 3, 0, 1, 19, 0, 1, 1, 1)

198 
MUX_CFG
("N14_1610_UWIRE_CS0", 8, 9, 1, 1, 21, 0, 1, 1, 1)

199 
MUX_CFG
("P15_1610_UWIRE_CS3", 8, 12, 1, 1, 22, 0, 1, 1, 1)

200 
MUX_CFG
("N15_1610_UWIRE_CS1", 7, 18, 2, 1, 14, 0, 
NA
, 0, 1)

203 
MUX_CFG
("U19_1610_SPIF_SCK", 7, 21, 6, 1, 15, 0, 1, 1, 1)

204 
MUX_CFG
("U18_1610_SPIF_DIN", 8, 0, 6, 1, 18, 1, 1, 0, 1)

205 
MUX_CFG
("P20_1610_SPIF_DIN", 6, 27, 4, 1, 7, 1, 1, 0, 1)

206 
MUX_CFG
("W21_1610_SPIF_DOUT", 8, 3, 6, 1, 19, 0, 1, 0, 1)

207 
MUX_CFG
("R18_1610_SPIF_DOUT", 7, 9, 3, 1, 11, 0, 1, 0, 1)

208 
MUX_CFG
("N14_1610_SPIF_CS0", 8, 9, 6, 1, 21, 0, 1, 1, 1)

209 
MUX_CFG
("N15_1610_SPIF_CS1", 7, 18, 6, 1, 14, 0, 1, 1, 1)

210 
MUX_CFG
("T19_1610_SPIF_CS2", 7, 15, 4, 1, 13, 0, 1, 1, 1)

211 
MUX_CFG
("P15_1610_SPIF_CS3", 8, 12, 3, 1, 22, 0, 1, 1, 1)

214 
MUX_CFG
("L3_1610_FLASH_CS2B_OE",10, 6, 1, 
NA
, 0, 0, NA, 0, 1)

215 
MUX_CFG
("M8_1610_FLASH_CS2B_WE",10, 3, 1, 
NA
, 0, 0, NA, 0, 1)

218 
MUX_CFG
("MMC_CMD", 
A
, 27, 0, 2, 15, 1, 2, 1, 1)

219 
MUX_CFG
("MMC_DAT1", 
A
, 24, 0, 2, 14, 1, 2, 1, 1)

220 
MUX_CFG
("MMC_DAT2", 
A
, 18, 0, 2, 12, 1, 2, 1, 1)

221 
MUX_CFG
("MMC_DAT0", 
B
, 0, 0, 2, 16, 1, 2, 1, 1)

222 
MUX_CFG
("MMC_CLK", 
A
, 21, 0, 
NA
, 0, 0, NA, 0, 1)

223 
MUX_CFG
("MMC_DAT3", 10, 15, 0, 3, 8, 1, 3, 1, 1)

224 
MUX_CFG
("M15_1710_MMC_CLKI", 6, 21, 2, 0, 0, 0, 
NA
, 0, 1)

225 
MUX_CFG
("P19_1710_MMC_CMDDIR", 6, 24, 6, 0, 0, 0, 
NA
, 0, 1)

226 
MUX_CFG
("P20_1710_MMC_DATDIR0", 6, 27, 5, 0, 0, 0, 
NA
, 0, 1)

229 
MUX_CFG
("W9_USB0_TXEN", 
B
, 9, 5, 2, 19, 0, 2, 0, 1)

230 
MUX_CFG
("AA9_USB0_VP", 
B
, 6, 5, 2, 18, 0, 2, 0, 1)

231 
MUX_CFG
("Y5_USB0_RCV", 
C
, 21, 5, 3, 1, 0, 1, 0, 1)

232 
MUX_CFG
("R9_USB0_VM", 
C
, 18, 5, 3, 0, 0, 3, 0, 1)

233 
MUX_CFG
("V6_USB0_TXD", 
C
, 27, 5, 3, 3, 0, 3, 0, 1)

234 
MUX_CFG
("W5_USB0_SE0", 
C
, 24, 5, 3, 2, 0, 3, 0, 1)

235 
MUX_CFG
("V9_USB0_SPEED", 
B
, 12, 5, 2, 20, 0, 2, 0, 1)

236 
MUX_CFG
("Y10_USB0_SUSP", 
B
, 3, 5, 2, 17, 0, 2, 0, 1)

239 
MUX_CFG
("W9_USB2_TXEN", 
B
, 9, 1, 
NA
, 0, 0, NA, 0, 1)

240 
MUX_CFG
("AA9_USB2_VP", 
B
, 6, 1, 
NA
, 0, 0, NA, 0, 1)

241 
MUX_CFG
("Y5_USB2_RCV", 
C
, 21, 1, 
NA
, 0, 0, NA, 0, 1)

242 
MUX_CFG
("R9_USB2_VM", 
C
, 18, 1, 
NA
, 0, 0, NA, 0, 1)

243 
MUX_CFG
("V6_USB2_TXD", 
C
, 27, 2, 
NA
, 0, 0, NA, 0, 1)

244 
MUX_CFG
("W5_USB2_SE0", 
C
, 24, 2, 
NA
, 0, 0, NA, 0, 1)

247 
MUX_CFG
("R13_1610_UART1_TX", 
A
, 12, 6, 2, 10, 0, 2, 10, 1)

248 
MUX_CFG
("V14_16XX_UART1_RX", 9, 18, 0, 2, 2, 0, 2, 2, 1)

249 
MUX_CFG
("R14_1610_UART1_CTS", 9, 15, 0, 2, 1, 0, 2, 1, 1)

250 
MUX_CFG
("AA15_1610_UART1_RTS", 9, 12, 1, 2, 0, 0, 2, 0, 1)

251 
MUX_CFG
("R9_16XX_UART2_RX", 
C
, 18, 0, 3, 0, 0, 3, 0, 1)

252 
MUX_CFG
("L14_16XX_UART3_RX", 6, 3, 0, 0, 31, 0, 0, 31, 1)

255 
MUX_CFG
("I2C_SCL", 7, 24, 0, 
NA
, 0, 0, NA, 0, 0)

256 
MUX_CFG
("I2C_SDA", 7, 27, 0, 
NA
, 0, 0, NA, 0, 0)

259 
MUX_CFG
("F18_1610_KBC0", 3, 15, 0, 0, 5, 1, 0, 0, 0)

260 
MUX_CFG
("D20_1610_KBC1", 3, 12, 0, 0, 4, 1, 0, 0, 0)

261 
MUX_CFG
("D19_1610_KBC2", 3, 9, 0, 0, 3, 1, 0, 0, 0)

262 
MUX_CFG
("E18_1610_KBC3", 3, 6, 0, 0, 2, 1, 0, 0, 0)

263 
MUX_CFG
("C21_1610_KBC4", 3, 3, 0, 0, 1, 1, 0, 0, 0)

264 
MUX_CFG
("G18_1610_KBR0", 4, 0, 0, 0, 10, 1, 0, 1, 0)

265 
MUX_CFG
("F19_1610_KBR1", 3, 27, 0, 0, 9, 1, 0, 1, 0)

266 
MUX_CFG
("H14_1610_KBR2", 3, 24, 0, 0, 8, 1, 0, 1, 0)

267 
MUX_CFG
("E20_1610_KBR3", 3, 21, 0, 0, 7, 1, 0, 1, 0)

268 
MUX_CFG
("E19_1610_KBR4", 3, 18, 0, 0, 6, 1, 0, 1, 0)

269 
MUX_CFG
("N19_1610_KBR5", 6, 12, 1, 1, 2, 1, 1, 1, 0)

272 
MUX_CFG
("T20_1610_LOW_PWR", 7, 12, 1, 
NA
, 0, 0, NA, 0, 0)

275 
MUX_CFG
("V5_1710_MCLK_ON", 
B
, 15, 0, 
NA
, 0, 0, NA, 0, 0)

276 
MUX_CFG
("V5_1710_MCLK_OFF", 
B
, 15, 6, 
NA
, 0, 0, NA, 0, 0)

277 
MUX_CFG
("R10_1610_MCLK_ON", 
B
, 18, 0, 
NA
, 22, 0, NA, 1, 0)

278 
MUX_CFG
("R10_1610_MCLK_OFF", 
B
, 18, 6, 2, 22, 1, 2, 1, 1)

281 
MUX_CFG
("P11_1610_CF_CD2", 
A
, 27, 3, 2, 15, 1, 2, 1, 1)

282 
MUX_CFG
("R11_1610_CF_IOIS16", 
B
, 0, 3, 2, 16, 1, 2, 1, 1)

283 
MUX_CFG
("V10_1610_CF_IREQ", 
A
, 24, 3, 2, 14, 0, 2, 0, 1)

284 
MUX_CFG
("W10_1610_CF_RESET", 
A
, 18, 3, 2, 12, 1, 2, 1, 1)

285 
MUX_CFG
("W11_1610_CF_CD1", 10, 15, 3, 3, 8, 1, 3, 1, 1)

289 
__öô
 
	$om≠1_mux_öô
()

292 #ifde‡
CONFIG_ARCH_OMAP730


293 
	`om≠_mux_ªgi°î
(
om≠730_pös
, 
	`ARRAY_SIZE
(omap730_pins));

296 #i‡
	`deföed
(
CONFIG_ARCH_OMAP15XX
Ë|| deföed(
CONFIG_ARCH_OMAP16XX
)

297 
	`om≠_mux_ªgi°î
(
om≠1xxx_pös
, 
	`ARRAY_SIZE
(omap1xxx_pins));

301 
	}
}

	@arch/arm/mach-omap1/pm.c

38 
	~<löux/pm.h
>

39 
	~<löux/sched.h
>

40 
	~<löux/¥oc_fs.h
>

41 
	~<löux/pm.h
>

42 
	~<löux/öãºu±.h
>

43 
	~<löux/sysfs.h
>

44 
	~<löux/moduÀ.h
>

46 
	~<asm/io.h
>

47 
	~<asm/úq.h
>

48 
	~<asm/©omic.h
>

49 
	~<asm/mach/time.h
>

50 
	~<asm/mach/úq.h
>

51 
	~<asm/mach-ty≥s.h
>

53 
	~<asm/¨ch/˝u.h
>

54 
	~<asm/¨ch/úqs.h
>

55 
	~<asm/¨ch/˛ock.h
>

56 
	~<asm/¨ch/§am.h
>

57 
	~<asm/¨ch/tc.h
>

58 
	~<asm/¨ch/pm.h
>

59 
	~<asm/¨ch/mux.h
>

60 
	~<asm/¨ch/çs65010.h
>

61 
	~<asm/¨ch/dma.h
>

62 
	~<asm/¨ch/d•_comm⁄.h
>

63 
	~<asm/¨ch/dmtimî.h
>

65 
	g¨m_¶ìp_ßve
[
ARM_SLEEP_SAVE_SIZE
];

66 
	gd•_¶ìp_ßve
[
DSP_SLEEP_SAVE_SIZE
];

67 
	guÕd_¶ìp_ßve
[
ULPD_SLEEP_SAVE_SIZE
];

68 
	gmpui730_¶ìp_ßve
[
MPUI730_SLEEP_SAVE_SIZE
];

69 
	gmpui1510_¶ìp_ßve
[
MPUI1510_SLEEP_SAVE_SIZE
];

70 
	gmpui1610_¶ìp_ßve
[
MPUI1610_SLEEP_SAVE_SIZE
];

72 
	gíabÀ_dyn_¶ìp
 = 1;

74 
ssize_t
 
	$om≠_pm_¶ìp_whûe_idÀ_show
(
k£t
 *k£t, *
buf
)

76  
	`•rötf
(
buf
, "%hu\n", 
íabÀ_dyn_¶ìp
);

77 
	}
}

79 
ssize_t
 
	$om≠_pm_¶ìp_whûe_idÀ_°‹e
(
k£t
 *kset,

80 c⁄° * 
buf
,

81 
size_t
 
n
)

83 
vÆue
;

84 i‡(
	`ssˇnf
(
buf
, "%hu", &
vÆue
) != 1 ||

85 (
vÆue
 != 0 && value != 1)) {

86 
	`¥ötk
(
KERN_ERR
 "idle_sleep_store: Invalid value\n");

87  -
EINVAL
;

89 
íabÀ_dyn_¶ìp
 = 
vÆue
;

90  
n
;

91 
	}
}

93 
subsys_©åibuã
 
	g¶ìp_whûe_idÀ_©å
 = {

94 .
©å
 = {

95 .
«me
 = 
__°rögify
(
¶ìp_whûe_idÀ
),

96 .
	gmode
 = 0644,

98 .
	gshow
 = 
om≠_pm_¶ìp_whûe_idÀ_show
,

99 .
	g°‹e
 = 
om≠_pm_¶ìp_whûe_idÀ_°‹e
,

102 
k£t
 
powî_subsys
;

103 (*
om≠_§am_idÀ
)(Ë
NULL
;

104 (*
om≠_§am_su•íd
)(
r0
, 
r1
Ë
NULL
;

112 
	$om≠_pm_idÀ
()

114 
__u32
 
¨m_idÀ˘1_mask
;

115 
__u32
 
u£_idÀ˘1
 = 
¨m_idÀ˘1_mask
;

116 #i‚de‡
CONFIG_OMAP_MPU_TIMER


117 
do_¶ìp
;

120 
	`loˇl_úq_dißbÀ
();

121 
	`loˇl_fiq_dißbÀ
();

122 i‡(
	`√ed_ªsched
()) {

123 
	`loˇl_fiq_íabÀ
();

124 
	`loˇl_úq_íabÀ
();

133 
	`timî_dyn_ª¥ogøm
();

135 #ifde‡
CONFIG_OMAP_MPU_TIMER


136 #w¨nög 
E«bÀ
 32
kHz
 
OS
 
timî
 
ö
 
‹dî
 
to
 
Ælow
 
¶ìp
 
°©es
 i¿
idÀ


137 
u£_idÀ˘1
 = use_idlect1 & ~(1 << 9);

140 
do_¶ìp
 = 0;

141 
íabÀ_dyn_¶ìp
) {

143 #ifde‡
CONFIG_CBUS_TAHVO_USB


144 
vbus_a˘ive
;

146 i‡(
vbus_a˘ive
)

149 
do_¶ìp
 = 1;

153 #ifde‡
CONFIG_OMAP_DM_TIMER


154 
u£_idÀ˘1
 = 
	`om≠_dm_timî_modify_idÀ˘_mask
(use_idlect1);

157 i‡(
	`om≠_dma_ru¬ög
()) {

158 
u£_idÀ˘1
 &= ~(1 << 6);

159 i‡(
	`om≠_lcd_dma_ext_ru¬ög
())

160 
u£_idÀ˘1
 &= ~(1 << 12);

166 i‡((
u£_idÀ˘1
 !~0Ë|| !
do_¶ìp
) {

168 
__u32
 
ßved_idÀ˘1
 = 
	`om≠_ªadl
(
ARM_IDLECT1
);

169 i‡(
	`˝u_is_om≠15xx
())

170 
u£_idÀ˘1
 &
OMAP1510_BIG_SLEEP_REQUEST
;

172 
u£_idÀ˘1
 &
OMAP1610_IDLECT1_SLEEP_VAL
;

173 
	`om≠_wrôñ
(
u£_idÀ˘1
, 
ARM_IDLECT1
);

174 
__asm__
 volatile ("mcrÖ15, 0,Ñ0, c7, c0, 4");

175 
	`om≠_wrôñ
(
ßved_idÀ˘1
, 
ARM_IDLECT1
);

177 
	`loˇl_fiq_íabÀ
();

178 
	`loˇl_úq_íabÀ
();

181 
	`om≠_§am_su•íd
(
	`om≠_ªadl
(
ARM_IDLECT1
),

182 
	`om≠_ªadl
(
ARM_IDLECT2
));

185 
	`loˇl_fiq_íabÀ
();

186 
	`loˇl_úq_íabÀ
();

187 
	}
}

194 
	$om≠_pm_wakeup_£tup
()

196 
u32
 
Àvñ1_wake
 = 0;

197 
u32
 
Àvñ2_wake
 = 
	`OMAP_IRQ_BIT
(
INT_UART2
);

205 i‡(
	`˝u_is_om≠730
())

206 
Àvñ1_wake
 = 
	`OMAP_IRQ_BIT
(
INT_730_GPIO_BANK1
) |

207 
	`OMAP_IRQ_BIT
(
INT_730_IH2_IRQ
);

208 i‡(
	`˝u_is_om≠15xx
())

209 
Àvñ1_wake
 = 
	`OMAP_IRQ_BIT
(
INT_GPIO_BANK1
) |

210 
	`OMAP_IRQ_BIT
(
INT_1510_IH2_IRQ
);

211 i‡(
	`˝u_is_om≠16xx
())

212 
Àvñ1_wake
 = 
	`OMAP_IRQ_BIT
(
INT_GPIO_BANK1
) |

213 
	`OMAP_IRQ_BIT
(
INT_1610_IH2_IRQ
);

215 
	`om≠_wrôñ
(~
Àvñ1_wake
, 
OMAP_IH1_MIR
);

217 i‡(
	`˝u_is_om≠730
()) {

218 
	`om≠_wrôñ
(~
Àvñ2_wake
, 
OMAP_IH2_0_MIR
);

219 
	`om≠_wrôñ
(~(
	`OMAP_IRQ_BIT
(
INT_730_WAKE_UP_REQ
) |

220 
	`OMAP_IRQ_BIT
(
INT_730_MPUIO_KEYPAD
)),

221 
OMAP_IH2_1_MIR
);

222 } i‡(
	`˝u_is_om≠15xx
()) {

223 
Àvñ2_wake
 |
	`OMAP_IRQ_BIT
(
INT_KEYBOARD
);

224 
	`om≠_wrôñ
(~
Àvñ2_wake
, 
OMAP_IH2_MIR
);

225 } i‡(
	`˝u_is_om≠16xx
()) {

226 
Àvñ2_wake
 |
	`OMAP_IRQ_BIT
(
INT_KEYBOARD
);

227 
	`om≠_wrôñ
(~
Àvñ2_wake
, 
OMAP_IH2_0_MIR
);

230 
	`om≠_wrôñ
(~
	`OMAP_IRQ_BIT
(
INT_1610_WAKE_UP_REQ
),

231 
OMAP_IH2_1_MIR
);

232 
	`om≠_wrôñ
(~0x0, 
OMAP_IH2_2_MIR
);

233 
	`om≠_wrôñ
(~0x0, 
OMAP_IH2_3_MIR
);

237 
	`om≠_wrôñ
(1, 
OMAP_IH2_CONTROL
);

238 
	`om≠_wrôñ
(1, 
OMAP_IH1_CONTROL
);

239 
	}
}

241 
	#EN_DSPCK
 13

	)

242 
	#EN_APICK
 6

	)

243 
	#DSP_EN
 1

	)

245 
	$om≠_pm_su•íd
()

247 
¨g0
 = 0, 
¨g1
 = 0;

249 
	`¥ötk
("PM: OMAP%x i†åyögÅÿíã∏dì∞¶ìp...\n", 
sy°em_ªv
);

251 
	`om≠_£rül_wake_åiggî
(1);

253 i‡(
	`machöe_is_om≠_osk
()) {

255 
	`çs65010_£t_Àd
(
LED1
, 
OFF
);

258 i‡(!
	`˝u_is_om≠15xx
())

259 
	`om≠_wrôew
(0xffff, 
ULPD_SOFT_DISABLE_REQ_REG
);

265 
	`loˇl_úq_dißbÀ
();

266 
	`loˇl_fiq_dißbÀ
();

279 i‡(
	`˝u_is_om≠730
()) {

280 
	`MPUI730_SAVE
(
OMAP_IH1_MIR
);

281 
	`MPUI730_SAVE
(
OMAP_IH2_0_MIR
);

282 
	`MPUI730_SAVE
(
OMAP_IH2_1_MIR
);

283 
	`MPUI730_SAVE
(
MPUI_CTRL
);

284 
	`MPUI730_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

285 
	`MPUI730_SAVE
(
MPUI_DSP_API_CONFIG
);

286 
	`MPUI730_SAVE
(
EMIFS_CONFIG
);

287 
	`MPUI730_SAVE
(
EMIFF_SDRAM_CONFIG
);

289 } i‡(
	`˝u_is_om≠15xx
()) {

290 
	`MPUI1510_SAVE
(
OMAP_IH1_MIR
);

291 
	`MPUI1510_SAVE
(
OMAP_IH2_MIR
);

292 
	`MPUI1510_SAVE
(
MPUI_CTRL
);

293 
	`MPUI1510_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

294 
	`MPUI1510_SAVE
(
MPUI_DSP_API_CONFIG
);

295 
	`MPUI1510_SAVE
(
EMIFS_CONFIG
);

296 
	`MPUI1510_SAVE
(
EMIFF_SDRAM_CONFIG
);

297 } i‡(
	`˝u_is_om≠16xx
()) {

298 
	`MPUI1610_SAVE
(
OMAP_IH1_MIR
);

299 
	`MPUI1610_SAVE
(
OMAP_IH2_0_MIR
);

300 
	`MPUI1610_SAVE
(
OMAP_IH2_1_MIR
);

301 
	`MPUI1610_SAVE
(
OMAP_IH2_2_MIR
);

302 
	`MPUI1610_SAVE
(
OMAP_IH2_3_MIR
);

303 
	`MPUI1610_SAVE
(
MPUI_CTRL
);

304 
	`MPUI1610_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

305 
	`MPUI1610_SAVE
(
MPUI_DSP_API_CONFIG
);

306 
	`MPUI1610_SAVE
(
EMIFS_CONFIG
);

307 
	`MPUI1610_SAVE
(
EMIFF_SDRAM_CONFIG
);

310 
	`ARM_SAVE
(
ARM_CKCTL
);

311 
	`ARM_SAVE
(
ARM_IDLECT1
);

312 
	`ARM_SAVE
(
ARM_IDLECT2
);

313 i‡(!(
	`˝u_is_om≠15xx
()))

314 
	`ARM_SAVE
(
ARM_IDLECT3
);

315 
	`ARM_SAVE
(
ARM_EWUPCT
);

316 
	`ARM_SAVE
(
ARM_RSTCT1
);

317 
	`ARM_SAVE
(
ARM_RSTCT2
);

318 
	`ARM_SAVE
(
ARM_SYSST
);

319 
	`ULPD_SAVE
(
ULPD_CLOCK_CTRL
);

320 
	`ULPD_SAVE
(
ULPD_STATUS_REQ
);

329 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_RSTCT1
Ë& ~(1 << 
DSP_EN
), ARM_RSTCT1);

332 i‡(!
	`˝u_is_om≠730
())

333 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_CKCTL
Ë& ~(1 << 
EN_DSPCK
), ARM_CKCTL);

336 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_IDLECT2
Ë| 1 << 
EN_APICK
, ARM_IDLECT2);

339 
	`DSP_SAVE
(
DSP_IDLECT2
);

342 
	`__øw_wrôew
(0, 
DSP_IDLECT2
);

348 
	`om≠_pm_wakeup_£tup
();

355 
	`om≠_wrôñ
(0x00F5, 
OMAP_WDT_TIMER_MODE
);

356 
	`om≠_wrôñ
(0x00A0, 
OMAP_WDT_TIMER_MODE
);

370 
¨g0
 = 
¨m_¶ìp_ßve
[
ARM_SLEEP_SAVE_ARM_IDLECT1
];

371 
¨g1
 = 
¨m_¶ìp_ßve
[
ARM_SLEEP_SAVE_ARM_IDLECT2
];

379 
	`om≠_§am_su•íd
(
¨g0
, 
¨g1
);

390 
	`om≠_wrôew
(
	`om≠_ªadw
(
ARM_IDLECT2
Ë| 1 << 
EN_APICK
, ARM_IDLECT2);

393 
	`DSP_RESTORE
(
DSP_IDLECT2
);

399 i‡(!(
	`˝u_is_om≠15xx
()))

400 
	`ARM_RESTORE
(
ARM_IDLECT3
);

401 
	`ARM_RESTORE
(
ARM_CKCTL
);

402 
	`ARM_RESTORE
(
ARM_EWUPCT
);

403 
	`ARM_RESTORE
(
ARM_RSTCT1
);

404 
	`ARM_RESTORE
(
ARM_RSTCT2
);

405 
	`ARM_RESTORE
(
ARM_SYSST
);

406 
	`ULPD_RESTORE
(
ULPD_CLOCK_CTRL
);

407 
	`ULPD_RESTORE
(
ULPD_STATUS_REQ
);

409 i‡(
	`˝u_is_om≠730
()) {

410 
	`MPUI730_RESTORE
(
EMIFS_CONFIG
);

411 
	`MPUI730_RESTORE
(
EMIFF_SDRAM_CONFIG
);

412 
	`MPUI730_RESTORE
(
OMAP_IH1_MIR
);

413 
	`MPUI730_RESTORE
(
OMAP_IH2_0_MIR
);

414 
	`MPUI730_RESTORE
(
OMAP_IH2_1_MIR
);

415 } i‡(
	`˝u_is_om≠15xx
()) {

416 
	`MPUI1510_RESTORE
(
MPUI_CTRL
);

417 
	`MPUI1510_RESTORE
(
MPUI_DSP_BOOT_CONFIG
);

418 
	`MPUI1510_RESTORE
(
MPUI_DSP_API_CONFIG
);

419 
	`MPUI1510_RESTORE
(
EMIFS_CONFIG
);

420 
	`MPUI1510_RESTORE
(
EMIFF_SDRAM_CONFIG
);

421 
	`MPUI1510_RESTORE
(
OMAP_IH1_MIR
);

422 
	`MPUI1510_RESTORE
(
OMAP_IH2_MIR
);

423 } i‡(
	`˝u_is_om≠16xx
()) {

424 
	`MPUI1610_RESTORE
(
MPUI_CTRL
);

425 
	`MPUI1610_RESTORE
(
MPUI_DSP_BOOT_CONFIG
);

426 
	`MPUI1610_RESTORE
(
MPUI_DSP_API_CONFIG
);

427 
	`MPUI1610_RESTORE
(
EMIFS_CONFIG
);

428 
	`MPUI1610_RESTORE
(
EMIFF_SDRAM_CONFIG
);

430 
	`MPUI1610_RESTORE
(
OMAP_IH1_MIR
);

431 
	`MPUI1610_RESTORE
(
OMAP_IH2_0_MIR
);

432 
	`MPUI1610_RESTORE
(
OMAP_IH2_1_MIR
);

433 
	`MPUI1610_RESTORE
(
OMAP_IH2_2_MIR
);

434 
	`MPUI1610_RESTORE
(
OMAP_IH2_3_MIR
);

437 i‡(!
	`˝u_is_om≠15xx
())

438 
	`om≠_wrôew
(0, 
ULPD_SOFT_DISABLE_REQ_REG
);

444 
	`loˇl_úq_íabÀ
();

445 
	`loˇl_fiq_íabÀ
();

447 
	`om≠_£rül_wake_åiggî
(0);

449 
	`¥ötk
("PM: OMAP%x i†ª-°¨tög from dì∞¶ìp...\n", 
sy°em_ªv
);

451 i‡(
	`machöe_is_om≠_osk
()) {

453 
	`çs65010_£t_Àd
(
LED1
, 
BLINK
);

455 
	}
}

457 #i‡
deföed
(
DEBUG
Ë&& deföed(
CONFIG_PROC_FS
)

458 
	gg_ªad_com∂ëed
;

463 
	$om≠_pm_ªad_¥oc
(

464 *
∑ge_buf„r
,

465 **
my_fú°_byã
,

466 
off_t
 
vútuÆ_°¨t
,

467 
Àngth
,

468 *
eof
,

469 *
d©a
)

471 
my_buf„r_off£t
 = 0;

472 * c⁄° 
my_ba£
 = 
∑ge_buf„r
;

474 
	`ARM_SAVE
(
ARM_CKCTL
);

475 
	`ARM_SAVE
(
ARM_IDLECT1
);

476 
	`ARM_SAVE
(
ARM_IDLECT2
);

477 i‡(!(
	`˝u_is_om≠15xx
()))

478 
	`ARM_SAVE
(
ARM_IDLECT3
);

479 
	`ARM_SAVE
(
ARM_EWUPCT
);

480 
	`ARM_SAVE
(
ARM_RSTCT1
);

481 
	`ARM_SAVE
(
ARM_RSTCT2
);

482 
	`ARM_SAVE
(
ARM_SYSST
);

484 
	`ULPD_SAVE
(
ULPD_IT_STATUS
);

485 
	`ULPD_SAVE
(
ULPD_CLOCK_CTRL
);

486 
	`ULPD_SAVE
(
ULPD_SOFT_REQ
);

487 
	`ULPD_SAVE
(
ULPD_STATUS_REQ
);

488 
	`ULPD_SAVE
(
ULPD_DPLL_CTRL
);

489 
	`ULPD_SAVE
(
ULPD_POWER_CTRL
);

491 i‡(
	`˝u_is_om≠730
()) {

492 
	`MPUI730_SAVE
(
MPUI_CTRL
);

493 
	`MPUI730_SAVE
(
MPUI_DSP_STATUS
);

494 
	`MPUI730_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

495 
	`MPUI730_SAVE
(
MPUI_DSP_API_CONFIG
);

496 
	`MPUI730_SAVE
(
EMIFF_SDRAM_CONFIG
);

497 
	`MPUI730_SAVE
(
EMIFS_CONFIG
);

498 } i‡(
	`˝u_is_om≠15xx
()) {

499 
	`MPUI1510_SAVE
(
MPUI_CTRL
);

500 
	`MPUI1510_SAVE
(
MPUI_DSP_STATUS
);

501 
	`MPUI1510_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

502 
	`MPUI1510_SAVE
(
MPUI_DSP_API_CONFIG
);

503 
	`MPUI1510_SAVE
(
EMIFF_SDRAM_CONFIG
);

504 
	`MPUI1510_SAVE
(
EMIFS_CONFIG
);

505 } i‡(
	`˝u_is_om≠16xx
()) {

506 
	`MPUI1610_SAVE
(
MPUI_CTRL
);

507 
	`MPUI1610_SAVE
(
MPUI_DSP_STATUS
);

508 
	`MPUI1610_SAVE
(
MPUI_DSP_BOOT_CONFIG
);

509 
	`MPUI1610_SAVE
(
MPUI_DSP_API_CONFIG
);

510 
	`MPUI1610_SAVE
(
EMIFF_SDRAM_CONFIG
);

511 
	`MPUI1610_SAVE
(
EMIFS_CONFIG
);

514 i‡(
vútuÆ_°¨t
 == 0) {

515 
g_ªad_com∂ëed
 = 0;

517 
my_buf„r_off£t
 +
	`•rötf
(
my_ba£
 + my_buffer_offset,

532 
	`ARM_SHOW
(
ARM_CKCTL
),

533 
	`ARM_SHOW
(
ARM_IDLECT1
),

534 
	`ARM_SHOW
(
ARM_IDLECT2
),

535 
	`ARM_SHOW
(
ARM_IDLECT3
),

536 
	`ARM_SHOW
(
ARM_EWUPCT
),

537 
	`ARM_SHOW
(
ARM_RSTCT1
),

538 
	`ARM_SHOW
(
ARM_RSTCT2
),

539 
	`ARM_SHOW
(
ARM_SYSST
),

540 
	`ULPD_SHOW
(
ULPD_IT_STATUS
),

541 
	`ULPD_SHOW
(
ULPD_CLOCK_CTRL
),

542 
	`ULPD_SHOW
(
ULPD_SOFT_REQ
),

543 
	`ULPD_SHOW
(
ULPD_DPLL_CTRL
),

544 
	`ULPD_SHOW
(
ULPD_STATUS_REQ
),

545 
	`ULPD_SHOW
(
ULPD_POWER_CTRL
));

547 i‡(
	`˝u_is_om≠730
()) {

548 
my_buf„r_off£t
 +
	`•rötf
(
my_ba£
 + my_buffer_offset,

555 
	`MPUI730_SHOW
(
MPUI_CTRL
),

556 
	`MPUI730_SHOW
(
MPUI_DSP_STATUS
),

557 
	`MPUI730_SHOW
(
MPUI_DSP_BOOT_CONFIG
),

558 
	`MPUI730_SHOW
(
MPUI_DSP_API_CONFIG
),

559 
	`MPUI730_SHOW
(
EMIFF_SDRAM_CONFIG
),

560 
	`MPUI730_SHOW
(
EMIFS_CONFIG
));

561 } i‡(
	`˝u_is_om≠15xx
()) {

562 
my_buf„r_off£t
 +
	`•rötf
(
my_ba£
 + my_buffer_offset,

569 
	`MPUI1510_SHOW
(
MPUI_CTRL
),

570 
	`MPUI1510_SHOW
(
MPUI_DSP_STATUS
),

571 
	`MPUI1510_SHOW
(
MPUI_DSP_BOOT_CONFIG
),

572 
	`MPUI1510_SHOW
(
MPUI_DSP_API_CONFIG
),

573 
	`MPUI1510_SHOW
(
EMIFF_SDRAM_CONFIG
),

574 
	`MPUI1510_SHOW
(
EMIFS_CONFIG
));

575 } i‡(
	`˝u_is_om≠16xx
()) {

576 
my_buf„r_off£t
 +
	`•rötf
(
my_ba£
 + my_buffer_offset,

583 
	`MPUI1610_SHOW
(
MPUI_CTRL
),

584 
	`MPUI1610_SHOW
(
MPUI_DSP_STATUS
),

585 
	`MPUI1610_SHOW
(
MPUI_DSP_BOOT_CONFIG
),

586 
	`MPUI1610_SHOW
(
MPUI_DSP_API_CONFIG
),

587 
	`MPUI1610_SHOW
(
EMIFF_SDRAM_CONFIG
),

588 
	`MPUI1610_SHOW
(
EMIFS_CONFIG
));

591 
g_ªad_com∂ëed
++;

592 } i‡(
g_ªad_com∂ëed
 >= 1) {

593 *
eof
 = 1;

596 
g_ªad_com∂ëed
++;

598 *
my_fú°_byã
 = 
∑ge_buf„r
;

599  
my_buf„r_off£t
;

600 
	}
}

602 
	$om≠_pm_öô_¥oc
()

604 
¥oc_dú_íåy
 *
íåy
;

606 
íåy
 = 
	`¸óã_¥oc_ªad_íåy
("driver/omap_pm",

607 
S_IWUSR
 | 
S_IRUGO
, 
NULL
,

608 
om≠_pm_ªad_¥oc
, 
NULL
);

609 
	}
}

613 (*
ßved_idÀ
)(Ë
NULL
;

620 
	$om≠_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
)

622 
îr‹
 = 0;

625 
ßved_idÀ
 = 
pm_idÀ
;

626 
pm_idÀ
 = 
NULL
;

628 
°©e
)

630 
PM_SUSPEND_STANDBY
:

631 
PM_SUSPEND_MEM
:

634  -
EINVAL
;

637  
îr‹
;

638 
	}
}

647 
	$om≠_pm_íãr
(
su•íd_°©e_t
 
°©e
)

649 
°©e
)

651 
PM_SUSPEND_STANDBY
:

652 
PM_SUSPEND_MEM
:

653 
	`om≠_pm_su•íd
();

656  -
EINVAL
;

660 
	}
}

671 
	$om≠_pm_föish
(
su•íd_°©e_t
 
°©e
)

673 
pm_idÀ
 = 
ßved_idÀ
;

675 
	}
}

678 
úqªtu∫_t
 
	$om≠_wakeup_öãºu±
(
úq
, *
dev
)

680  
IRQ_HANDLED
;

681 
	}
}

683 
úqa˘i⁄
 
	gom≠_wakeup_úq
 = {

684 .
«me
 = "peripheral wakeup",

685 .
	gÊags
 = 
IRQF_DISABLED
,

686 .
	gh™dÀr
 = 
om≠_wakeup_öãºu±


691 
pm_›s
 
	gom≠_pm_›s
 ={

692 .
¥ï¨e
 = 
om≠_pm_¥ï¨e
,

693 .
	gíãr
 = 
om≠_pm_íãr
,

694 .
	gföish
 = 
om≠_pm_föish
,

695 .
	gvÆid
 = 
pm_vÆid_⁄ly_mem
,

698 
__öô
 
	$om≠_pm_öô
()

700 
îr‹
;

702 
	`¥ötk
("Power Management for TI OMAP.\n");

709 i‡(
	`˝u_is_om≠730
()) {

710 
om≠_§am_idÀ
 = 
	`om≠_§am_push
(
om≠730_idÀ_lo›_su•íd
,

711 
om≠730_idÀ_lo›_su•íd_sz
);

712 
om≠_§am_su•íd
 = 
	`om≠_§am_push
(
om≠730_˝u_su•íd
,

713 
om≠730_˝u_su•íd_sz
);

714 } i‡(
	`˝u_is_om≠15xx
()) {

715 
om≠_§am_idÀ
 = 
	`om≠_§am_push
(
om≠1510_idÀ_lo›_su•íd
,

716 
om≠1510_idÀ_lo›_su•íd_sz
);

717 
om≠_§am_su•íd
 = 
	`om≠_§am_push
(
om≠1510_˝u_su•íd
,

718 
om≠1510_˝u_su•íd_sz
);

719 } i‡(
	`˝u_is_om≠16xx
()) {

720 
om≠_§am_idÀ
 = 
	`om≠_§am_push
(
om≠1610_idÀ_lo›_su•íd
,

721 
om≠1610_idÀ_lo›_su•íd_sz
);

722 
om≠_§am_su•íd
 = 
	`om≠_§am_push
(
om≠1610_˝u_su•íd
,

723 
om≠1610_˝u_su•íd_sz
);

726 i‡(
om≠_§am_idÀ
 =
NULL
 || 
om≠_§am_su•íd
 == NULL) {

727 
	`¥ötk
(
KERN_ERR
 "PMÇot initialized: Missing SRAM support\n");

728  -
ENODEV
;

731 
pm_idÀ
 = 
om≠_pm_idÀ
;

733 i‡(
	`˝u_is_om≠730
())

734 
	`£tup_úq
(
INT_730_WAKE_UP_REQ
, &
om≠_wakeup_úq
);

735 i‡(
	`˝u_is_om≠16xx
())

736 
	`£tup_úq
(
INT_1610_WAKE_UP_REQ
, &
om≠_wakeup_úq
);

741 
	`om≠_wrôew
(
ULPD_SETUP_ANALOG_CELL_3_VAL
, 
ULPD_SETUP_ANALOG_CELL_3
);

744 
	`om≠_wrôew
(
ULPD_POWER_CTRL_REG_VAL
, 
ULPD_POWER_CTRL
);

747 i‡(
	`˝u_is_om≠730
())

748 
	`om≠_wrôñ
(
OMAP730_IDLECT3_VAL
, 
OMAP730_IDLECT3
);

749 i‡(
	`˝u_is_om≠16xx
())

750 
	`om≠_wrôñ
(
OMAP1610_IDLECT3_VAL
, 
OMAP1610_IDLECT3
);

752 
	`pm_£t_›s
(&
om≠_pm_›s
);

754 #i‡
	`deföed
(
DEBUG
Ë&& deföed(
CONFIG_PROC_FS
)

755 
	`om≠_pm_öô_¥oc
();

758 
îr‹
 = 
	`subsys_¸óã_fûe
(&
powî_subsys
, &
¶ìp_whûe_idÀ_©å
);

759 i‡(
îr‹
)

760 
	`¥ötk
(
KERN_ERR
 "subsys_¸óã_fûêÁûed: %d\n", 
îr‹
);

762 i‡(
	`˝u_is_om≠16xx
()) {

764 
	`om≠_cfg_ªg
(
T20_1610_LOW_PWR
);

768 
	}
}

769 
__öôˇŒ
(
om≠_pm_öô
);

	@arch/arm/mach-omap1/serial.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/úq.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/£rül.h
>

17 
	~<löux/ây.h
>

18 
	~<löux/£rül_8250.h
>

19 
	~<löux/£rül_ªg.h
>

20 
	~<löux/˛k.h
>

22 
	~<asm/io.h
>

23 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/¨ch/bﬂrd.h
>

26 
	~<asm/¨ch/mux.h
>

27 
	~<asm/¨ch/gpio.h
>

28 
	~<asm/¨ch/Âga.h
>

29 #ifde‡
CONFIG_PM


30 
	~<asm/¨ch/pm.h
>

33 
˛k
 * 
	gu¨t1_ck
;

34 
˛k
 * 
	gu¨t2_ck
;

35 
˛k
 * 
	gu¨t3_ck
;

37 
ölöe
 
	$om≠_£rül_ö
(
∂©_£rül8250_p‹t
 *
up
,

38 
off£t
)

40 
off£t
 <<
up
->
ªgshi·
;

41  ()
	`__øw_ªadb
(
up
->
memba£
 + 
off£t
);

42 
	}
}

44 
ölöe
 
	$om≠_£rül_ouç
(
∂©_£rül8250_p‹t
 *
p
, 
off£t
,

45 
vÆue
)

47 
off£t
 <<
p
->
ªgshi·
;

48 
	`__øw_wrôeb
(
vÆue
, 
p
->
memba£
 + 
off£t
);

49 
	}
}

56 
__öô
 
	$om≠_£rül_ª£t
(
∂©_£rül8250_p‹t
 *
p
)

58 
	`om≠_£rül_ouç
(
p
, 
UART_OMAP_MDR1
, 0x07);

59 
	`om≠_£rül_ouç
(
p
, 
UART_OMAP_SCR
, 0x08);

60 
	`om≠_£rül_ouç
(
p
, 
UART_OMAP_MDR1
, 0x00);

62 i‡(!
	`˝u_is_om≠15xx
()) {

63 
	`om≠_£rül_ouç
(
p
, 
UART_OMAP_SYSC
, 0x01);

64 !(
	`om≠_£rül_ö
(
p
, 
UART_OMAP_SYSC
) & 0x01));

66 
	}
}

68 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

70 .
memba£
 = (*)
IO_ADDRESS
(
OMAP_UART1_BASE
),

71 .
	gm≠ba£
 = ()
OMAP_UART1_BASE
,

72 .
	gúq
 = 
INT_UART1
,

73 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

74 .
	giŸy≥
 = 
UPIO_MEM
,

75 .
	gªgshi·
 = 2,

76 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

79 .
	gmemba£
 = (*)
IO_ADDRESS
(
OMAP_UART2_BASE
),

80 .
	gm≠ba£
 = ()
OMAP_UART2_BASE
,

81 .
	gúq
 = 
INT_UART2
,

82 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

83 .
	giŸy≥
 = 
UPIO_MEM
,

84 .
	gªgshi·
 = 2,

85 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

88 .
	gmemba£
 = (*)
IO_ADDRESS
(
OMAP_UART3_BASE
),

89 .
	gm≠ba£
 = ()
OMAP_UART3_BASE
,

90 .
	gúq
 = 
INT_UART3
,

91 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

92 .
	giŸy≥
 = 
UPIO_MEM
,

93 .
	gªgshi·
 = 2,

94 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

99 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

100 .
«me
 = "serial8250",

101 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

102 .
	gdev
 = {

103 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

112 
__öô
 
	$om≠_£rül_öô
()

114 
i
;

115 c⁄° 
om≠_u¨t_c⁄fig
 *
öfo
;

117 i‡(
	`˝u_is_om≠730
()) {

118 
£rül_∂©f‹m_d©a
[0].
ªgshi·
 = 0;

119 
£rül_∂©f‹m_d©a
[1].
ªgshi·
 = 0;

120 
£rül_∂©f‹m_d©a
[0].
úq
 = 
INT_730_UART_MODEM_1
;

121 
£rül_∂©f‹m_d©a
[1].
úq
 = 
INT_730_UART_MODEM_IRDA_2
;

124 i‡(
	`˝u_is_om≠15xx
()) {

125 
£rül_∂©f‹m_d©a
[0].
u¨t˛k
 = 
OMAP1510_BASE_BAUD
 * 16;

126 
£rül_∂©f‹m_d©a
[1].
u¨t˛k
 = 
OMAP1510_BASE_BAUD
 * 16;

127 
£rül_∂©f‹m_d©a
[2].
u¨t˛k
 = 
OMAP1510_BASE_BAUD
 * 16;

130 
öfo
 = 
	`om≠_gë_c⁄fig
(
OMAP_TAG_UART
, 
om≠_u¨t_c⁄fig
);

131 i‡(
öfo
 =
NULL
)

134 
i
 = 0; i < 
OMAP_MAX_NR_PORTS
; i++) {

135 
ªg
;

137 i‡(!((1 << 
i
Ë& 
öfo
->
íabÀd_u¨ts
)) {

138 
£rül_∂©f‹m_d©a
[
i
].
memba£
 = 
NULL
;

139 
£rül_∂©f‹m_d©a
[
i
].
m≠ba£
 = 0;

143 
i
) {

145 
u¨t1_ck
 = 
	`˛k_gë
(
NULL
, "uart1_ck");

146 i‡(
	`IS_ERR
(
u¨t1_ck
))

147 
	`¥ötk
("CouldÇot get uart1_ck\n");

149 
	`˛k_íabÀ
(
u¨t1_ck
);

150 i‡(
	`˝u_is_om≠15xx
())

151 
	`˛k_£t_øã
(
u¨t1_ck
, 12000000);

153 i‡(
	`˝u_is_om≠15xx
()) {

154 
	`om≠_cfg_ªg
(
UART1_TX
);

155 
	`om≠_cfg_ªg
(
UART1_RTS
);

156 i‡(
	`machöe_is_om≠_önov©‹
()) {

157 
ªg
 = 
	`Âga_ªad
(
OMAP1510_FPGA_POWER
);

158 
ªg
 |
OMAP1510_FPGA_PCR_COM1_EN
;

159 
	`Âga_wrôe
(
ªg
, 
OMAP1510_FPGA_POWER
);

160 
	`udñay
(10);

165 
u¨t2_ck
 = 
	`˛k_gë
(
NULL
, "uart2_ck");

166 i‡(
	`IS_ERR
(
u¨t2_ck
))

167 
	`¥ötk
("CouldÇot get uart2_ck\n");

169 
	`˛k_íabÀ
(
u¨t2_ck
);

170 i‡(
	`˝u_is_om≠15xx
())

171 
	`˛k_£t_øã
(
u¨t2_ck
, 12000000);

173 
	`˛k_£t_øã
(
u¨t2_ck
, 48000000);

175 i‡(
	`˝u_is_om≠15xx
()) {

176 
	`om≠_cfg_ªg
(
UART2_TX
);

177 
	`om≠_cfg_ªg
(
UART2_RTS
);

178 i‡(
	`machöe_is_om≠_önov©‹
()) {

179 
ªg
 = 
	`Âga_ªad
(
OMAP1510_FPGA_POWER
);

180 
ªg
 |
OMAP1510_FPGA_PCR_COM2_EN
;

181 
	`Âga_wrôe
(
ªg
, 
OMAP1510_FPGA_POWER
);

182 
	`udñay
(10);

187 
u¨t3_ck
 = 
	`˛k_gë
(
NULL
, "uart3_ck");

188 i‡(
	`IS_ERR
(
u¨t3_ck
))

189 
	`¥ötk
("CouldÇot get uart3_ck\n");

191 
	`˛k_íabÀ
(
u¨t3_ck
);

192 i‡(
	`˝u_is_om≠15xx
())

193 
	`˛k_£t_øã
(
u¨t3_ck
, 12000000);

195 i‡(
	`˝u_is_om≠15xx
()) {

196 
	`om≠_cfg_ªg
(
UART3_TX
);

197 
	`om≠_cfg_ªg
(
UART3_RX
);

201 
	`om≠_£rül_ª£t
(&
£rül_∂©f‹m_d©a
[
i
]);

203 
	}
}

205 #ifde‡
CONFIG_OMAP_SERIAL_WAKE


207 
úqªtu∫_t
 
	$om≠_£rül_wake_öãºu±
(
úq
, *
dev_id
)

210  
IRQ_HANDLED
;

211 
	}
}

218 
	$om≠_£rül_wake_åiggî
(
íabÀ
)

220 i‡(!
	`˝u_is_om≠16xx
())

223 i‡(
u¨t1_ck
 !
NULL
) {

224 i‡(
íabÀ
)

225 
	`om≠_cfg_ªg
(
V14_16XX_GPIO37
);

227 
	`om≠_cfg_ªg
(
V14_16XX_UART1_RX
);

229 i‡(
u¨t2_ck
 !
NULL
) {

230 i‡(
íabÀ
)

231 
	`om≠_cfg_ªg
(
R9_16XX_GPIO18
);

233 
	`om≠_cfg_ªg
(
R9_16XX_UART2_RX
);

235 i‡(
u¨t3_ck
 !
NULL
) {

236 i‡(
íabÀ
)

237 
	`om≠_cfg_ªg
(
L14_16XX_GPIO49
);

239 
	`om≠_cfg_ªg
(
L14_16XX_UART3_RX
);

241 
	}
}

243 
__öô
 
	$om≠_£rül_£t_p‹t_wakeup
(
gpio_ƒ
)

245 
ªt
;

247 
ªt
 = 
	`om≠_ªque°_gpio
(
gpio_ƒ
);

248 i‡(
ªt
 < 0) {

249 
	`¥ötk
(
KERN_ERR
 "CouldÇotÑequest UART wake GPIO: %i\n",

250 
gpio_ƒ
);

253 
	`om≠_£t_gpio_dúe˘i⁄
(
gpio_ƒ
, 1);

254 
ªt
 = 
	`ªque°_úq
(
	`OMAP_GPIO_IRQ
(
gpio_ƒ
), &
om≠_£rül_wake_öãºu±
,

255 
IRQF_TRIGGER_RISING
, "£rü»wakeup", 
NULL
);

256 i‡(
ªt
) {

257 
	`om≠_‰ì_gpio
(
gpio_ƒ
);

258 
	`¥ötk
(
KERN_ERR
 "No interrupt for UART wake GPIO: %i\n",

259 
gpio_ƒ
);

262 
	`íabÀ_úq_wake
(
	`OMAP_GPIO_IRQ
(
gpio_ƒ
));

263 
	}
}

265 
__öô
 
	$om≠_£rül_wakeup_öô
()

267 i‡(!
	`˝u_is_om≠16xx
())

270 i‡(
u¨t1_ck
 !
NULL
)

271 
	`om≠_£rül_£t_p‹t_wakeup
(37);

272 i‡(
u¨t2_ck
 !
NULL
)

273 
	`om≠_£rül_£t_p‹t_wakeup
(18);

274 i‡(
u¨t3_ck
 !
NULL
)

275 
	`om≠_£rül_£t_p‹t_wakeup
(49);

278 
	}
}

279 
œã_öôˇŒ
(
om≠_£rül_wakeup_öô
);

283 
__öô
 
	$om≠_öô
()

285  
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

286 
	}
}

287 
¨ch_öôˇŒ
(
om≠_öô
);

	@arch/arm/mach-omap1/time.c

36 
	~<löux/kî√l.h
>

37 
	~<löux/öô.h
>

38 
	~<löux/dñay.h
>

39 
	~<löux/öãºu±.h
>

40 
	~<löux/sched.h
>

41 
	~<löux/•ölock.h
>

42 
	~<löux/˛k.h
>

43 
	~<löux/îr.h
>

44 
	~<löux/˛ocksour˚.h
>

45 
	~<löux/˛ockchùs.h
>

47 
	~<asm/sy°em.h
>

48 
	~<asm/h¨dw¨e.h
>

49 
	~<asm/io.h
>

50 
	~<asm/Àds.h
>

51 
	~<asm/úq.h
>

52 
	~<asm/mach/úq.h
>

53 
	~<asm/mach/time.h
>

56 
	#OMAP_MPU_TIMER_BASE
 
OMAP_MPU_TIMER1_BASE


	)

57 
	#OMAP_MPU_TIMER_OFFSET
 0x100

	)

76 
	gcyc2ns_sˇÀ
;

77 
	#CYC2NS_SCALE_FACTOR
 10

	)

79 
ölöe
 
	$£t_cyc2ns_sˇÀ
(
˝u_khz
)

81 
cyc2ns_sˇÀ
 = (1000000 << 
CYC2NS_SCALE_FACTOR
)/
˝u_khz
;

82 
	}
}

84 
ölöe
 
	$cy˛es_2_ns
(
cyc
)

86  (
cyc
 * 
cyc2ns_sˇÀ
Ë>> 
CYC2NS_SCALE_FACTOR
;

87 
	}
}

91 
u32
 
	m˙é
;

92 
u32
 
	mlﬂd_tim
;

93 
u32
 
	mªad_tim
;

94 } 
	tom≠_mpu_timî_ªgs_t
;

96 
	#om≠_mpu_timî_ba£
(
n
) \

97 ((vﬁ©ûê
om≠_mpu_timî_ªgs_t
*)
	`IO_ADDRESS
(
OMAP_MPU_TIMER_BASE
 + \

98 (
n
)*
OMAP_MPU_TIMER_OFFSET
))

	)

100 
ölöe
 
	$om≠_mpu_timî_ªad
(
ƒ
)

102 vﬁ©ûê
om≠_mpu_timî_ªgs_t
* 
timî
 = 
	`om≠_mpu_timî_ba£
(
ƒ
);

103  
timî
->
ªad_tim
;

104 
	}
}

106 
ölöe
 
	$om≠_mpu_£t_aut‹e£t
(
ƒ
)

108 vﬁ©ûê
om≠_mpu_timî_ªgs_t
* 
timî
 = 
	`om≠_mpu_timî_ba£
(
ƒ
);

110 
timî
->
˙é
 =Åimî->˙é | 
MPU_TIMER_AR
;

111 
	}
}

113 
ölöe
 
	$om≠_mpu_ªmove_aut‹e£t
(
ƒ
)

115 vﬁ©ûê
om≠_mpu_timî_ªgs_t
* 
timî
 = 
	`om≠_mpu_timî_ba£
(
ƒ
);

117 
timî
->
˙é
 =Åimî->˙é & ~
MPU_TIMER_AR
;

118 
	}
}

120 
ölöe
 
	$om≠_mpu_timî_°¨t
(
ƒ
, 
lﬂd_vÆ
,

121 
aut‹e£t
)

123 vﬁ©ûê
om≠_mpu_timî_ªgs_t
* 
timî
 = 
	`om≠_mpu_timî_ba£
(
ƒ
);

124 
timîÊags
 = (
MPU_TIMER_CLOCK_ENABLE
 | 
MPU_TIMER_ST
);

126 i‡(
aut‹e£t
Ë
timîÊags
 |
MPU_TIMER_AR
;

128 
timî
->
˙é
 = 
MPU_TIMER_CLOCK_ENABLE
;

129 
	`udñay
(1);

130 
timî
->
lﬂd_tim
 = 
lﬂd_vÆ
;

131 
	`udñay
(1);

132 
timî
->
˙é
 = 
timîÊags
;

133 
	}
}

140 
	$om≠_mpu_£t_√xt_evít
(
cy˛es
,

141 
˛ock_evít_devi˚
 *
evt
)

143 
	`om≠_mpu_timî_°¨t
(0, 
cy˛es
, 0);

145 
	}
}

147 
	$om≠_mpu_£t_mode
(
˛ock_evít_mode
 
mode
,

148 
˛ock_evít_devi˚
 *
evt
)

150 
mode
) {

151 
CLOCK_EVT_MODE_PERIODIC
:

152 
	`om≠_mpu_£t_aut‹e£t
(0);

154 
CLOCK_EVT_MODE_ONESHOT
:

155 
	`om≠_mpu_ªmove_aut‹e£t
(0);

157 
CLOCK_EVT_MODE_UNUSED
:

158 
CLOCK_EVT_MODE_SHUTDOWN
:

161 
	}
}

163 
˛ock_evít_devi˚
 
	g˛ockevít_mpu_timî1
 = {

164 .
«me
 = "mpu_timer1",

165 .
	g„©uªs
 = 
CLOCK_EVT_FEAT_PERIODIC
, 
	gCLOCK_EVT_FEAT_ONESHOT
,

166 .
	gshi·
 = 32,

167 .
	g£t_√xt_evít
 = 
om≠_mpu_£t_√xt_evít
,

168 .
	g£t_mode
 = 
om≠_mpu_£t_mode
,

171 
úqªtu∫_t
 
	$om≠_mpu_timî1_öãºu±
(
úq
, *
dev_id
)

173 
˛ock_evít_devi˚
 *
evt
 = &
˛ockevít_mpu_timî1
;

175 
evt
->
	`evít_h™dÀr
(evt);

177  
IRQ_HANDLED
;

178 
	}
}

180 
úqa˘i⁄
 
	gom≠_mpu_timî1_úq
 = {

181 .
«me
 = "mpu_timer1",

182 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

183 .
	gh™dÀr
 = 
om≠_mpu_timî1_öãºu±
,

186 
__öô
 
	$om≠_öô_mpu_timî
(
øã
)

188 
	`£t_cyc2ns_sˇÀ
(
øã
 / 1000);

190 
	`£tup_úq
(
INT_TIMER1
, &
om≠_mpu_timî1_úq
);

191 
	`om≠_mpu_timî_°¨t
(0, (
øã
 / 
HZ
) - 1, 1);

193 
˛ockevít_mpu_timî1
.
mu…
 = 
	`div_sc
(
øã
, 
NSEC_PER_SEC
,

194 
˛ockevít_mpu_timî1
.
shi·
);

195 
˛ockevít_mpu_timî1
.
max_dñè_ns
 =

196 
	`˛ockevít_dñè2ns
(-1, &
˛ockevít_mpu_timî1
);

197 
˛ockevít_mpu_timî1
.
mö_dñè_ns
 =

198 
	`˛ockevít_dñè2ns
(1, &
˛ockevít_mpu_timî1
);

200 
˛ockevít_mpu_timî1
.
˝umask
 = 
	`˝umask_of_˝u
(0);

201 
	`˛ockevíts_ªgi°î_devi˚
(&
˛ockevít_mpu_timî1
);

202 
	}
}

211 
	gom≠_mpu_timî2_ovîÊows
;

213 
úqªtu∫_t
 
	$om≠_mpu_timî2_öãºu±
(
úq
, *
dev_id
)

215 
om≠_mpu_timî2_ovîÊows
++;

216  
IRQ_HANDLED
;

217 
	}
}

219 
úqa˘i⁄
 
	gom≠_mpu_timî2_úq
 = {

220 .
«me
 = "mpu_timer2",

221 .
	gÊags
 = 
IRQF_DISABLED
,

222 .
	gh™dÀr
 = 
om≠_mpu_timî2_öãºu±
,

225 
cy˛e_t
 
	$mpu_ªad
()

227  ~
	`om≠_mpu_timî_ªad
(1);

228 
	}
}

230 
˛ocksour˚
 
	g˛ocksour˚_mpu
 = {

231 .
«me
 = "mpu_timer2",

232 .
	gøtög
 = 300,

233 .
	gªad
 = 
mpu_ªad
,

234 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

235 .
	gshi·
 = 24,

236 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

239 
__öô
 
	$om≠_öô_˛ocksour˚
(
øã
)

241 
îr
[] 
__öôd©a
 = 
KERN_ERR


244 
˛ocksour˚_mpu
.
mu…


245 
	`˛ocksour˚_khz2mu…
(
øã
/1000, 
˛ocksour˚_mpu
.
shi·
);

247 
	`£tup_úq
(
INT_TIMER2
, &
om≠_mpu_timî2_úq
);

248 
	`om≠_mpu_timî_°¨t
(1, ~0, 1);

250 i‡(
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_mpu
))

251 
	`¥ötk
(
îr
, 
˛ocksour˚_mpu
.
«me
);

252 
	}
}

258 
	$sched_˛ock
()

260 
ticks
 = 0 - 
	`om≠_mpu_timî_ªad
(1);

261 
ticks64
;

263 
ticks64
 = 
om≠_mpu_timî2_ovîÊows
;

264 
ticks64
 <<= 32;

265 
ticks64
 |
ticks
;

267  
	`cy˛es_2_ns
(
ticks64
);

268 
	}
}

275 
__öô
 
	$om≠_timî_öô
()

277 
˛k
 *
ck_ªf
 = 
	`˛k_gë
(
NULL
, "ck_ref");

278 
øã
;

280 
	`BUG_ON
(
	`IS_ERR
(
ck_ªf
));

282 
øã
 = 
	`˛k_gë_øã
(
ck_ªf
);

283 
	`˛k_put
(
ck_ªf
);

286 
øã
 /= 2;

288 
	`om≠_öô_mpu_timî
(
øã
);

289 
	`om≠_öô_˛ocksour˚
(
øã
);

290 
	}
}

292 
sys_timî
 
	gom≠_timî
 = {

293 .
öô
 = 
om≠_timî_öô
,

	@arch/arm/mach-omap2/board-apollon.c

19 
	~<löux/kî√l.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/∂©f‹m_devi˚.h
>

22 
	~<löux/mtd/mtd.h
>

23 
	~<löux/mtd/∑πôi⁄s.h
>

24 
	~<löux/mtd/⁄í™d.h
>

25 
	~<löux/úq.h
>

26 
	~<löux/öãºu±.h
>

27 
	~<löux/dñay.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/mach/¨ch.h
>

32 
	~<asm/mach/Êash.h
>

34 
	~<asm/¨ch/gpio.h
>

35 
	~<asm/¨ch/mux.h
>

36 
	~<asm/¨ch/usb.h
>

37 
	~<asm/¨ch/bﬂrd.h
>

38 
	~<asm/¨ch/comm⁄.h
>

39 
	~"¥cm-ªgs.h
"

42 
	#LED0_GPIO13
 13

	)

43 
	#LED1_GPIO14
 14

	)

44 
	#LED2_GPIO15
 15

	)

45 
	#SW_ENTER_GPIO16
 16

	)

46 
	#SW_UP_GPIO17
 17

	)

47 
	#SW_DOWN_GPIO58
 58

	)

49 
mtd_∑πôi⁄
 
	g≠ﬁl⁄_∑πôi⁄s
[] = {

51 .
«me
 = "X-Loader + U-Boot",

52 .
	goff£t
 = 0,

53 .
	gsize
 = 
SZ_128K
,

54 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

57 .
	g«me
 = "params",

58 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

59 .
	gsize
 = 
SZ_128K
,

62 .
	g«me
 = "kernel",

63 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

64 .
	gsize
 = 
SZ_2M
,

67 .
	g«me
 = "rootfs",

68 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

69 .
	gsize
 = 
SZ_16M
,

72 .
	g«me
 = "filesystem00",

73 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

74 .
	gsize
 = 
SZ_32M
,

77 .
	g«me
 = "filesystem01",

78 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

79 .
	gsize
 = 
MTDPART_SIZ_FULL
,

83 
Êash_∂©f‹m_d©a
 
	g≠ﬁl⁄_Êash_d©a
 = {

84 .
∑πs
 = 
≠ﬁl⁄_∑πôi⁄s
,

85 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
≠ﬁl⁄_∑πôi⁄s
),

88 
ªsour˚
 
	g≠ﬁl⁄_Êash_ªsour˚
 = {

89 .
°¨t
 = 
APOLLON_CS0_BASE
,

90 .
	gíd
 = 
APOLLON_CS0_BASE
 + 
SZ_128K
,

91 .
	gÊags
 = 
IORESOURCE_MEM
,

94 
∂©f‹m_devi˚
 
	g≠ﬁl⁄_⁄í™d_devi˚
 = {

95 .
«me
 = "onenand",

96 .
	gid
 = -1,

97 .
	gdev
 = {

98 .
∂©f‹m_d©a
 = &
≠ﬁl⁄_Êash_d©a
,

100 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(&
≠ﬁl⁄_Êash_ªsour˚
),

101 .
	gªsour˚
 = &
≠ﬁl⁄_Êash_ªsour˚
,

104 
ªsour˚
 
	g≠ﬁl⁄_smc91x_ªsour˚s
[] = {

106 .
°¨t
 = 
APOLLON_ETHR_START
,

107 .
	gíd
 = 
APOLLON_ETHR_START
 + 0xf,

108 .
	gÊags
 = 
IORESOURCE_MEM
,

111 .
°¨t
 = 
OMAP_GPIO_IRQ
(
APOLLON_ETHR_GPIO_IRQ
),

112 .
	gíd
 = 
OMAP_GPIO_IRQ
(
APOLLON_ETHR_GPIO_IRQ
),

113 .
	gÊags
 = 
IORESOURCE_IRQ
,

117 
∂©f‹m_devi˚
 
	g≠ﬁl⁄_smc91x_devi˚
 = {

118 .
«me
 = "smc91x",

119 .
	gid
 = -1,

120 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
≠ﬁl⁄_smc91x_ªsour˚s
),

121 .
	gªsour˚
 = 
≠ﬁl⁄_smc91x_ªsour˚s
,

124 
∂©f‹m_devi˚
 
	g≠ﬁl⁄_lcd_devi˚
 = {

125 .
«me
 = "apollon_lcd",

126 .
	gid
 = -1,

129 
∂©f‹m_devi˚
 *
	g≠ﬁl⁄_devi˚s
[] 
	g__öôd©a
 = {

130 &
≠ﬁl⁄_⁄í™d_devi˚
,

131 &
≠ﬁl⁄_smc91x_devi˚
,

132 &
≠ﬁl⁄_lcd_devi˚
,

135 
ölöe
 
__öô
 
	$≠ﬁl⁄_öô_smc91x
()

138 
GPMC_CONFIG1_1
 = 0x00011203;

139 
GPMC_CONFIG2_1
 = 0x001f1f01;

140 
GPMC_CONFIG3_1
 = 0x00080803;

141 
GPMC_CONFIG4_1
 = 0x1c091c09;

142 
GPMC_CONFIG5_1
 = 0x041f1f1f;

143 
GPMC_CONFIG6_1
 = 0x000004c4;

144 
GPMC_CONFIG7_1
 = 0x00000f40 | (
APOLLON_CS1_BASE
 >> 24);

145 
	`udñay
(100);

147 
	`om≠_cfg_ªg
(
W4__24XX_GPIO74
);

148 i‡(
	`om≠_ªque°_gpio
(
APOLLON_ETHR_GPIO_IRQ
) < 0) {

149 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest GPIO%d for smc91x IRQ\n",

150 
APOLLON_ETHR_GPIO_IRQ
);

153 
	`om≠_£t_gpio_dúe˘i⁄
(
APOLLON_ETHR_GPIO_IRQ
, 1);

154 
	}
}

156 
__öô
 
	$om≠_≠ﬁl⁄_öô_úq
()

158 
	`om≠2_öô_comm⁄_hw
();

159 
	`om≠_öô_úq
();

160 
	`om≠_gpio_öô
();

161 
	`≠ﬁl⁄_öô_smc91x
();

162 
	}
}

164 
om≠_u¨t_c⁄fig
 
≠ﬁl⁄_u¨t_c⁄fig
 
	g__öôd©a
 = {

165 .
íabÀd_u¨ts
 = (1 << 0) | (0 << 1) | (0 << 2),

168 
om≠_mmc_c⁄fig
 
≠ﬁl⁄_mmc_c⁄fig
 
	g__öôd©a
 = {

169 .
mmc
 [0] = {

170 .
íabÀd
 = 1,

171 .
	gwúe4
 = 1,

172 .
	gwp_pö
 = -1,

173 .
	gpowî_pö
 = -1,

174 .
	gswôch_pö
 = -1,

178 
om≠_lcd_c⁄fig
 
≠ﬁl⁄_lcd_c⁄fig
 
	g__öôd©a
 = {

179 .
˘æ_«me
 = "internal",

182 
om≠_bﬂrd_c⁄fig_kî√l
 
	g≠ﬁl⁄_c⁄fig
[] = {

183 { 
OMAP_TAG_UART
, &
≠ﬁl⁄_u¨t_c⁄fig
 },

184 { 
OMAP_TAG_MMC
, &
≠ﬁl⁄_mmc_c⁄fig
 },

185 { 
OMAP_TAG_LCD
, &
≠ﬁl⁄_lcd_c⁄fig
 },

188 
__öô
 
	$≠ﬁl⁄_Àd_öô
()

191 
	`om≠_cfg_ªg
(
AA10_242X_GPIO13
);

192 
	`om≠_ªque°_gpio
(
LED0_GPIO13
);

193 
	`om≠_£t_gpio_dúe˘i⁄
(
LED0_GPIO13
, 0);

194 
	`om≠_£t_gpio_d©aout
(
LED0_GPIO13
, 0);

196 
	`om≠_cfg_ªg
(
AA6_242X_GPIO14
);

197 
	`om≠_ªque°_gpio
(
LED1_GPIO14
);

198 
	`om≠_£t_gpio_dúe˘i⁄
(
LED1_GPIO14
, 0);

199 
	`om≠_£t_gpio_d©aout
(
LED1_GPIO14
, 0);

201 
	`om≠_cfg_ªg
(
AA4_242X_GPIO15
);

202 
	`om≠_ªque°_gpio
(
LED2_GPIO15
);

203 
	`om≠_£t_gpio_dúe˘i⁄
(
LED2_GPIO15
, 0);

204 
	`om≠_£t_gpio_d©aout
(
LED2_GPIO15
, 0);

205 
	}
}

207 
úqªtu∫_t
 
	$≠ﬁl⁄_sw_öãºu±
(
úq
, *
ign‹ed
)

209 
Àd0
, 
Àd1
, 
Àd2
;

211 i‡(
úq
 =
	`OMAP_GPIO_IRQ
(
SW_ENTER_GPIO16
))

212 
	`om≠_£t_gpio_d©aout
(
LED0_GPIO13
, 
Àd0
 ^= 1);

213 i‡(
úq
 =
	`OMAP_GPIO_IRQ
(
SW_UP_GPIO17
))

214 
	`om≠_£t_gpio_d©aout
(
LED1_GPIO14
, 
Àd1
 ^= 1);

215 i‡(
úq
 =
	`OMAP_GPIO_IRQ
(
SW_DOWN_GPIO58
))

216 
	`om≠_£t_gpio_d©aout
(
LED2_GPIO15
, 
Àd2
 ^= 1);

218  
IRQ_HANDLED
;

219 
	}
}

221 
__öô
 
	$≠ﬁl⁄_sw_öô
()

224 
	`om≠_cfg_ªg
(
Y11_242X_GPIO16
);

225 
	`om≠_ªque°_gpio
(
SW_ENTER_GPIO16
);

226 
	`om≠_£t_gpio_dúe˘i⁄
(
SW_ENTER_GPIO16
, 1);

228 
	`om≠_cfg_ªg
(
AA12_242X_GPIO17
);

229 
	`om≠_ªque°_gpio
(
SW_UP_GPIO17
);

230 
	`om≠_£t_gpio_dúe˘i⁄
(
SW_UP_GPIO17
, 1);

232 
	`om≠_cfg_ªg
(
AA8_242X_GPIO58
);

233 
	`om≠_ªque°_gpio
(
SW_DOWN_GPIO58
);

234 
	`om≠_£t_gpio_dúe˘i⁄
(
SW_DOWN_GPIO58
, 1);

236 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(
SW_ENTER_GPIO16
), 
IRQT_RISING
);

237 i‡(
	`ªque°_úq
(
	`OMAP_GPIO_IRQ
(
SW_ENTER_GPIO16
), &
≠ﬁl⁄_sw_öãºu±
,

238 
IRQF_SHARED
, "enter sw",

239 &
≠ﬁl⁄_sw_öãºu±
))

241 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(
SW_UP_GPIO17
), 
IRQT_RISING
);

242 i‡(
	`ªque°_úq
(
	`OMAP_GPIO_IRQ
(
SW_UP_GPIO17
), &
≠ﬁl⁄_sw_öãºu±
,

243 
IRQF_SHARED
, "up sw",

244 &
≠ﬁl⁄_sw_öãºu±
))

246 
	`£t_úq_ty≥
(
	`OMAP_GPIO_IRQ
(
SW_DOWN_GPIO58
), 
IRQT_RISING
);

247 i‡(
	`ªque°_úq
(
	`OMAP_GPIO_IRQ
(
SW_DOWN_GPIO58
), &
≠ﬁl⁄_sw_öãºu±
,

248 
IRQF_SHARED
, "down sw",

249 &
≠ﬁl⁄_sw_öãºu±
))

251 
	}
}

253 
__öô
 
	$om≠_≠ﬁl⁄_öô
()

255 
	`≠ﬁl⁄_Àd_öô
();

256 
	`≠ﬁl⁄_sw_öô
();

259 
	`om≠_cfg_ªg
(
W19_24XX_SYS_NIRQ
);

262 
CONTROL_DEVCONF
 |= (1 << 24);

269 
	`∂©f‹m_add_devi˚s
(
≠ﬁl⁄_devi˚s
, 
	`ARRAY_SIZE
(apollon_devices));

270 
om≠_bﬂrd_c⁄fig
 = 
≠ﬁl⁄_c⁄fig
;

271 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
≠ﬁl⁄_c⁄fig
);

272 
	`om≠_£rül_öô
();

273 
	}
}

275 
__öô
 
	$om≠_≠ﬁl⁄_m≠_io
()

277 
	`om≠2_m≠_comm⁄_io
();

278 
	}
}

280 
MACHINE_START
(
OMAP_APOLLON
, "OMAP24xx Apollon")

282 .
	gphys_io
 = 0x48000000,

283 .
	gio_pg_off°
 = ((0xd8000000) >> 18) & 0xfffc,

284 .
	gboŸ_∑øms
 = 0x80000100,

285 .
	gm≠_io
 = 
om≠_≠ﬁl⁄_m≠_io
,

286 .
	göô_úq
 = 
om≠_≠ﬁl⁄_öô_úq
,

287 .
	göô_machöe
 = 
om≠_≠ﬁl⁄_öô
,

288 .
	gtimî
 = &
om≠_timî
,

289 
	gMACHINE_END


	@arch/arm/mach-omap2/board-generic.c

19 
	~<löux/kî√l.h
>

20 
	~<löux/öô.h
>

21 
	~<löux/devi˚.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/m≠.h
>

28 
	~<asm/¨ch/gpio.h
>

29 
	~<asm/¨ch/mux.h
>

30 
	~<asm/¨ch/usb.h
>

31 
	~<asm/¨ch/bﬂrd.h
>

32 
	~<asm/¨ch/comm⁄.h
>

34 
__öô
 
	$om≠_gíîic_öô_úq
()

36 
	`om≠2_öô_comm⁄_hw
();

37 
	`om≠_öô_úq
();

38 
	}
}

40 
om≠_u¨t_c⁄fig
 
gíîic_u¨t_c⁄fig
 
	g__öôd©a
 = {

41 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

44 
om≠_mmc_c⁄fig
 
gíîic_mmc_c⁄fig
 
	g__öôd©a
 = {

45 .
mmc
 [0] = {

46 .
íabÀd
 = 0,

47 .
	gwúe4
 = 0,

48 .
	gwp_pö
 = -1,

49 .
	gpowî_pö
 = -1,

50 .
	gswôch_pö
 = -1,

54 
om≠_bﬂrd_c⁄fig_kî√l
 
	ggíîic_c⁄fig
[] = {

55 { 
OMAP_TAG_UART
, &
gíîic_u¨t_c⁄fig
 },

56 { 
OMAP_TAG_MMC
, &
gíîic_mmc_c⁄fig
 },

59 
__öô
 
	$om≠_gíîic_öô
()

61 
om≠_bﬂrd_c⁄fig
 = 
gíîic_c⁄fig
;

62 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
gíîic_c⁄fig
);

63 
	`om≠_£rül_öô
();

64 
	}
}

66 
__öô
 
	$om≠_gíîic_m≠_io
()

68 
	`om≠2_m≠_comm⁄_io
();

69 
	}
}

71 
MACHINE_START
(
OMAP_GENERIC
, "Generic OMAP24xx")

73 .
	gphys_io
 = 0x48000000,

74 .
	gio_pg_off°
 = ((0xd8000000) >> 18) & 0xfffc,

75 .
	gboŸ_∑øms
 = 0x80000100,

76 .
	gm≠_io
 = 
om≠_gíîic_m≠_io
,

77 .
	göô_úq
 = 
om≠_gíîic_öô_úq
,

78 .
	göô_machöe
 = 
om≠_gíîic_öô
,

79 .
	gtimî
 = &
om≠_timî
,

80 
	gMACHINE_END


	@arch/arm/mach-omap2/board-h4.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<löux/mtd/mtd.h
>

18 
	~<löux/mtd/∑πôi⁄s.h
>

19 
	~<löux/dñay.h
>

20 
	~<löux/w‹kqueue.h
>

21 
	~<löux/öput.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/mach/¨ch.h
>

26 
	~<asm/mach/m≠.h
>

27 
	~<asm/mach/Êash.h
>

29 
	~<asm/¨ch/gpio.h
>

30 
	~<asm/¨ch/gpi€x∑ndî.h
>

31 
	~<asm/¨ch/mux.h
>

32 
	~<asm/¨ch/usb.h
>

33 
	~<asm/¨ch/úda.h
>

34 
	~<asm/¨ch/bﬂrd.h
>

35 
	~<asm/¨ch/comm⁄.h
>

36 
	~<asm/¨ch/key∑d.h
>

37 
	~<asm/¨ch/míñaus.h
>

38 
	~<asm/¨ch/dma.h
>

39 
	~"¥cm-ªgs.h
"

41 
	~<asm/io.h
>

43 
	grow_gpios
[6] = { 88, 89, 124, 11, 6, 96 };

44 
	gcﬁ_gpios
[7] = { 90, 91, 100, 36, 12, 97, 98 };

46 
	gh4_keym≠
[] = {

47 
KEY
(0, 0, 
KEY_LEFT
),

48 
KEY
(0, 1, 
KEY_RIGHT
),

49 
KEY
(0, 2, 
KEY_A
),

50 
KEY
(0, 3, 
KEY_B
),

51 
KEY
(0, 4, 
KEY_C
),

52 
KEY
(1, 0, 
KEY_DOWN
),

53 
KEY
(1, 1, 
KEY_UP
),

54 
KEY
(1, 2, 
KEY_E
),

55 
KEY
(1, 3, 
KEY_F
),

56 
KEY
(1, 4, 
KEY_G
),

57 
KEY
(2, 0, 
KEY_ENTER
),

58 
KEY
(2, 1, 
KEY_I
),

59 
KEY
(2, 2, 
KEY_J
),

60 
KEY
(2, 3, 
KEY_K
),

61 
KEY
(2, 4, 
KEY_3
),

62 
KEY
(3, 0, 
KEY_M
),

63 
KEY
(3, 1, 
KEY_N
),

64 
KEY
(3, 2, 
KEY_O
),

65 
KEY
(3, 3, 
KEY_P
),

66 
KEY
(3, 4, 
KEY_Q
),

67 
KEY
(4, 0, 
KEY_R
),

68 
KEY
(4, 1, 
KEY_4
),

69 
KEY
(4, 2, 
KEY_T
),

70 
KEY
(4, 3, 
KEY_U
),

71 
KEY
(4, 4, 
KEY_ENTER
),

72 
KEY
(5, 0, 
KEY_V
),

73 
KEY
(5, 1, 
KEY_W
),

74 
KEY
(5, 2, 
KEY_L
),

75 
KEY
(5, 3, 
KEY_S
),

76 
KEY
(5, 4, 
KEY_ENTER
),

80 
mtd_∑πôi⁄
 
	gh4_∑πôi⁄s
[] = {

83 .
«me
 = "bootloader",

84 .
	goff£t
 = 0,

85 .
	gsize
 = 
SZ_128K
,

86 .
	gmask_Êags
 = 
MTD_WRITEABLE
,

90 .
	g«me
 = "params",

91 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

92 .
	gsize
 = 
SZ_128K
,

93 .
	gmask_Êags
 = 0,

97 .
	g«me
 = "kernel",

98 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

99 .
	gsize
 = 
SZ_2M
,

100 .
	gmask_Êags
 = 0

104 .
	g«me
 = "filesystem",

105 .
	goff£t
 = 
MTDPART_OFS_APPEND
,

106 .
	gsize
 = 
MTDPART_SIZ_FULL
,

107 .
	gmask_Êags
 = 0

111 
Êash_∂©f‹m_d©a
 
	gh4_Êash_d©a
 = {

112 .
m≠_«me
 = "cfi_probe",

113 .
	gwidth
 = 2,

114 .
	g∑πs
 = 
h4_∑πôi⁄s
,

115 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
h4_∑πôi⁄s
),

118 
ªsour˚
 
	gh4_Êash_ªsour˚
 = {

119 .
°¨t
 = 
H4_CS0_BASE
,

120 .
	gíd
 = 
H4_CS0_BASE
 + 
SZ_64M
 - 1,

121 .
	gÊags
 = 
IORESOURCE_MEM
,

124 
∂©f‹m_devi˚
 
	gh4_Êash_devi˚
 = {

125 .
«me
 = "omapflash",

126 .
	gid
 = 0,

127 .
	gdev
 = {

128 .
∂©f‹m_d©a
 = &
h4_Êash_d©a
,

130 .
	gnum_ªsour˚s
 = 1,

131 .
	gªsour˚
 = &
h4_Êash_ªsour˚
,

134 
ªsour˚
 
	gh4_smc91x_ªsour˚s
[] = {

136 .
°¨t
 = 
OMAP24XX_ETHR_START
,

137 .
	gíd
 = 
OMAP24XX_ETHR_START
 + 0xf,

138 .
	gÊags
 = 
IORESOURCE_MEM
,

141 .
°¨t
 = 
OMAP_GPIO_IRQ
(
OMAP24XX_ETHR_GPIO_IRQ
),

142 .
	gíd
 = 
OMAP_GPIO_IRQ
(
OMAP24XX_ETHR_GPIO_IRQ
),

143 .
	gÊags
 = 
IORESOURCE_IRQ
,

147 
∂©f‹m_devi˚
 
	gh4_smc91x_devi˚
 = {

148 .
«me
 = "smc91x",

149 .
	gid
 = -1,

150 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h4_smc91x_ªsour˚s
),

151 .
	gªsour˚
 = 
h4_smc91x_ªsour˚s
,

156 
	$h4_£À˘_úda
(
devi˚
 *
dev
, 
°©e
)

158 
ex∑
;

159 
îr
 = 0;

161 i‡((
îr
 = 
	`ªad_gpio_ex∑
(&
ex∑
, 0x21))) {

162 
	`¥ötk
(
KERN_ERR
 "ErrorÑeading from I/OÉxpander\n");

163  
îr
;

167 i‡(
°©e
 & 
IR_SEL
) {

168 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
 | 0x01, 0x21))) {

169 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/OÉxpander\n");

170  
îr
;

173 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
 & ~0x01, 0x21))) {

174 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/OÉxpander\n");

175  
îr
;

178  
îr
;

179 
	}
}

181 
	$£t_å™s_mode
(
w‹k_°ru˘
 *
w‹k
)

183 
om≠_úda_c⁄fig
 *
úda_c⁄fig
 =

184 
	`c⁄èöî_of
(
w‹k
, 
om≠_úda_c⁄fig
, 
gpio_ex∑
.work);

185 
mode
 = 
úda_c⁄fig
->mode;

186 
ex∑
;

187 
îr
 = 0;

189 i‡((
îr
 = 
	`ªad_gpio_ex∑
(&
ex∑
, 0x20)) != 0) {

190 
	`¥ötk
(
KERN_ERR
 "ErrorÑeading from I/OÉxpander\n");

193 
ex∑
 &= ~0x01;

195 i‡(!(
mode
 & 
IR_SIRMODE
)) {

196 
ex∑
 |= 0x01;

199 i‡((
îr
 = 
	`wrôe_gpio_ex∑
(
ex∑
, 0x20)) != 0) {

200 
	`¥ötk
(
KERN_ERR
 "Error writingÅo I/OÉxpander\n");

202 
	}
}

204 
	$h4_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

206 
om≠_úda_c⁄fig
 *
úda_c⁄fig
 = 
dev
->
∂©f‹m_d©a
;

208 
úda_c⁄fig
->
mode
 = mode;

209 
	`ˇn˚l_dñayed_w‹k
(&
úda_c⁄fig
->
gpio_ex∑
);

210 
	`PREPARE_DELAYED_WORK
(&
úda_c⁄fig
->
gpio_ex∑
, 
£t_å™s_mode
);

211 
	`scheduÀ_dñayed_w‹k
(&
úda_c⁄fig
->
gpio_ex∑
, 0);

214 
	}
}

216 
om≠_úda_c⁄fig
 
	gh4_úda_d©a
 = {

217 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_MIRMODE
 | 
IR_FIRMODE
,

218 .
	gå™s˚ivî_mode
 = 
h4_å™s˚ivî_mode
,

219 .
	g£À˘_úda
 = 
h4_£À˘_úda
,

220 .
	grx_ch™√l
 = 
OMAP24XX_DMA_UART3_RX
,

221 .
	gtx_ch™√l
 = 
OMAP24XX_DMA_UART3_TX
,

222 .
	gde°_°¨t
 = 
OMAP_UART3_BASE
,

223 .
	g§c_°¨t
 = 
OMAP_UART3_BASE
,

224 .
	gtx_åiggî
 = 
OMAP24XX_DMA_UART3_TX
,

225 .
	grx_åiggî
 = 
OMAP24XX_DMA_UART3_RX
,

228 
ªsour˚
 
	gh4_úda_ªsour˚s
[] = {

230 .
°¨t
 = 
INT_24XX_UART3_IRQ
,

231 .
	gíd
 = 
INT_24XX_UART3_IRQ
,

232 .
	gÊags
 = 
IORESOURCE_IRQ
,

236 
∂©f‹m_devi˚
 
	gh4_úda_devi˚
 = {

237 .
«me
 = "omapirda",

238 .
	gid
 = -1,

239 .
	gdev
 = {

240 .
∂©f‹m_d©a
 = &
h4_úda_d©a
,

242 .
	gnum_ªsour˚s
 = 1,

243 .
	gªsour˚
 = 
h4_úda_ªsour˚s
,

246 
om≠_kp_∂©f‹m_d©a
 
	gh4_kp_d©a
 = {

247 .
rows
 = 6,

248 .
	gcﬁs
 = 7,

249 .
	gkeym≠
 = 
h4_keym≠
,

250 .
	gkeym≠size
 = 
ARRAY_SIZE
(
h4_keym≠
),

251 .
	gªp
 = 1,

252 .
	grow_gpios
 = 
row_gpios
,

253 .
	gcﬁ_gpios
 = 
cﬁ_gpios
,

256 
∂©f‹m_devi˚
 
	gh4_kp_devi˚
 = {

257 .
«me
 = "omap-keypad",

258 .
	gid
 = -1,

259 .
	gdev
 = {

260 .
∂©f‹m_d©a
 = &
h4_kp_d©a
,

264 
∂©f‹m_devi˚
 
	gh4_lcd_devi˚
 = {

265 .
«me
 = "lcd_h4",

266 .
	gid
 = -1,

269 
ªsour˚
 
	gh4_Àd_ªsour˚s
[] = {

271 .
Êags
 = 
IORESOURCE_MEM
,

275 
∂©f‹m_devi˚
 
	gh4_Àd_devi˚
 = {

276 .
«me
 = "omap_dbg_led",

277 .
	gid
 = -1,

278 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
h4_Àd_ªsour˚s
),

279 .
	gªsour˚
 = 
h4_Àd_ªsour˚s
,

282 
∂©f‹m_devi˚
 *
	gh4_devi˚s
[] 
	g__öôd©a
 = {

283 &
h4_smc91x_devi˚
,

284 &
h4_Êash_devi˚
,

285 &
h4_úda_devi˚
,

286 &
h4_kp_devi˚
,

287 &
h4_lcd_devi˚
,

288 &
h4_Àd_devi˚
,

291 
ölöe
 
__öô
 
	$h4_öô_smc91x
()

294 
GPMC_CONFIG1_1
 = 0x00011200;

295 
GPMC_CONFIG2_1
 = 0x001f1f01;

296 
GPMC_CONFIG3_1
 = 0x00080803;

297 
GPMC_CONFIG4_1
 = 0x1c091c09;

298 
GPMC_CONFIG5_1
 = 0x041f1f1f;

299 
GPMC_CONFIG6_1
 = 0x000004c4;

300 
GPMC_CONFIG7_1
 = 0x00000f40 | (0x08000000 >> 24);

301 
	`udñay
(100);

303 
	`om≠_cfg_ªg
(
M15_24XX_GPIO92
);

304 i‡(
	`om≠_ªque°_gpio
(
OMAP24XX_ETHR_GPIO_IRQ
) < 0) {

305 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑequest GPIO%d for smc91x IRQ\n",

306 
OMAP24XX_ETHR_GPIO_IRQ
);

309 
	`om≠_£t_gpio_dúe˘i⁄
(
OMAP24XX_ETHR_GPIO_IRQ
, 1);

310 
	}
}

312 
__öô
 
	$om≠_h4_öô_úq
()

314 
	`om≠2_öô_comm⁄_hw
();

315 
	`om≠_öô_úq
();

316 
	`om≠_gpio_öô
();

317 
	`h4_öô_smc91x
();

318 
	}
}

320 
om≠_u¨t_c⁄fig
 
h4_u¨t_c⁄fig
 
	g__öôd©a
 = {

321 .
íabÀd_u¨ts
 = ((1 << 0) | (1 << 1) | (1 << 2)),

324 
om≠_mmc_c⁄fig
 
h4_mmc_c⁄fig
 
	g__öôd©a
 = {

325 .
mmc
 [0] = {

326 .
íabÀd
 = 1,

327 .
	gwúe4
 = 1,

328 .
	gwp_pö
 = -1,

329 .
	gpowî_pö
 = -1,

330 .
	gswôch_pö
 = -1,

334 
om≠_lcd_c⁄fig
 
h4_lcd_c⁄fig
 
	g__öôd©a
 = {

335 .
˘æ_«me
 = "internal",

338 
om≠_bﬂrd_c⁄fig_kî√l
 
	gh4_c⁄fig
[] = {

339 { 
OMAP_TAG_UART
, &
h4_u¨t_c⁄fig
 },

340 { 
OMAP_TAG_MMC
, &
h4_mmc_c⁄fig
 },

341 { 
OMAP_TAG_LCD
, &
h4_lcd_c⁄fig
 },

344 
__öô
 
	$om≠_h4_öô
()

351 #i‡
	`deföed
(
CONFIG_OMAP_IR
Ë|| deföed(
CONFIG_OMAP_IR_MODULE
)

352 
	`om≠_cfg_ªg
(
K15_24XX_UART3_TX
);

353 
	`om≠_cfg_ªg
(
K14_24XX_UART3_RX
);

356 #i‡
	`deföed
(
CONFIG_KEYBOARD_OMAP
Ë|| deföed(
CONFIG_KEYBOARD_OMAP_MODULE
)

357 i‡(
	`om≠_has_míñaus
()) {

358 
row_gpios
[5] = 0;

359 
cﬁ_gpios
[2] = 15;

360 
cﬁ_gpios
[6] = 18;

364 
	`∂©f‹m_add_devi˚s
(
h4_devi˚s
, 
	`ARRAY_SIZE
(h4_devices));

365 
om≠_bﬂrd_c⁄fig
 = 
h4_c⁄fig
;

366 
om≠_bﬂrd_c⁄fig_size
 = 
	`ARRAY_SIZE
(
h4_c⁄fig
);

367 
	`om≠_£rül_öô
();

368 
	}
}

370 
__öô
 
	$om≠_h4_m≠_io
()

372 
	`om≠2_m≠_comm⁄_io
();

373 
	}
}

375 
MACHINE_START
(
OMAP_H4
, "OMAP2420 H4 board")

377 .
	gphys_io
 = 0x48000000,

378 .
	gio_pg_off°
 = ((0xd8000000) >> 18) & 0xfffc,

379 .
	gboŸ_∑øms
 = 0x80000100,

380 .
	gm≠_io
 = 
om≠_h4_m≠_io
,

381 .
	göô_úq
 = 
om≠_h4_öô_úq
,

382 .
	göô_machöe
 = 
om≠_h4_öô
,

383 .
	gtimî
 = &
om≠_timî
,

384 
	gMACHINE_END


	@arch/arm/mach-omap2/clock.c

18 
	~<löux/moduÀ.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/devi˚.h
>

21 
	~<löux/li°.h
>

22 
	~<löux/î∫o.h
>

23 
	~<löux/dñay.h
>

24 
	~<löux/˛k.h
>

26 
	~<asm/io.h
>

28 
	~<asm/¨ch/˛ock.h
>

29 
	~<asm/¨ch/§am.h
>

30 
	~<asm/div64.h
>

32 
	~"¥cm-ªgs.h
"

33 
	~"mem‹y.h
"

34 
	~"˛ock.h
"

36 #unde‡
DEBUG


40 
¥cm_c⁄fig
 *
	gcuº_¥cm_£t
;

41 
u32
 
	gcuº_≥rf_Àvñ
 = 
PRCM_FULL_SPEED
;

42 
˛k
 *
	gv˛k
;

43 
˛k
 *
	gs˛k
;

50 
	$om≠2_sys_˛k_ªˇlc
(
˛k
 * clk)

52 
u32
 
div
 = 
PRCM_CLKSRC_CTRL
;

53 
div
 &= (1 << 7) | (1 << 6);

54 
div
 >>
˛k
->
øã_off£t
;

55 
˛k
->
øã
 = (˛k->
∑ª¡
->øã / 
div
);

56 
	`¥›ag©e_øã
(
˛k
);

57 
	}
}

59 
u32
 
	$om≠2_gë_d∂l_øã
(
˛k
 * 
t˛k
)

61 
d∂l_˛k
;

62 
d∂l_mu…
, 
d∂l_div
, 
amu…
;

64 
d∂l_mu…
 = (
CM_CLKSEL1_PLL
 >> 12) & 0x03ff;

65 
d∂l_div
 = (
CM_CLKSEL1_PLL
 >> 8) & 0x0f;

66 
d∂l_˛k
 = ()
t˛k
->
∑ª¡
->
øã
 * 
d∂l_mu…
;

67 
	`do_div
(
d∂l_˛k
, 
d∂l_div
 + 1);

68 
amu…
 = 
CM_CLKSEL2_PLL
 & 0x3;

69 
d∂l_˛k
 *
amu…
;

71  
d∂l_˛k
;

72 
	}
}

74 
	$om≠2_fﬁlow∑ª¡_ªˇlc
(
˛k
 *clk)

76 
	`fﬁlow∑ª¡_ªˇlc
(
˛k
);

77 
	}
}

79 
	$om≠2_¥›ag©e_øã
(
˛k
 * clk)

81 i‡(!(
˛k
->
Êags
 & 
RATE_FIXED
))

82 
˛k
->
øã
 = clk->
∑ª¡
->rate;

84 
	`¥›ag©e_øã
(
˛k
);

85 
	}
}

87 
	$om≠2_£t_osc_ck
(
íabÀ
)

89 i‡(
íabÀ
)

90 
PRCM_CLKSRC_CTRL
 &= ~(0x3 << 3);

92 
PRCM_CLKSRC_CTRL
 |= 0x3 << 3;

93 
	}
}

96 
	$om≠2_˛k_fixed_íabÀ
(
˛k
 *clk)

98 
u32
 
cvÆ
, 
i
=0;

100 i‡(
˛k
->
íabÀ_bô
 == 0xff)

103 
cvÆ
 = 
CM_CLKEN_PLL
;

105 i‡((
cvÆ
 & (0x3 << 
˛k
->
íabÀ_bô
)) == (0x3 << clk->enable_bit))

108 
cvÆ
 &~(0x3 << 
˛k
->
íabÀ_bô
);

109 
cvÆ
 |(0x3 << 
˛k
->
íabÀ_bô
);

110 
CM_CLKEN_PLL
 = 
cvÆ
;

112 i‡(
˛k
 =&
≠Œ96_ck
)

113 
cvÆ
 = (1 << 8);

114 i‡(
˛k
 =&
≠Œ54_ck
)

115 
cvÆ
 = (1 << 6);

117 !(
CM_IDLEST_CKGEN
 & 
cvÆ
)) {

118 ++
i
;

119 
	`udñay
(1);

120 i‡(
i
 == 100000) {

121 
	`¥ötk
(
KERN_ERR
 "Clock %†didn'àlock\n", 
˛k
->
«me
);

125 
	}
}

127 
	$om≠2_˛k_waô_ªady
(
˛k
 *clk)

129 
ªg
, 
Ÿhî_ªg
, 
°_ªg
;

130 
u32
 
bô
;

131 
i
;

133 
ªg
 = (Ë
˛k
->
íabÀ_ªg
;

134 i‡(
ªg
 =(Ë&
CM_FCLKEN1_CORE
 ||

135 
ªg
 =(Ë&
CM_FCLKEN2_CORE
)

136 
Ÿhî_ªg
 = (
ªg
 & ~0xf0) | 0x10;

137 i‡(
ªg
 =(Ë&
CM_ICLKEN1_CORE
 ||

138 
ªg
 =(Ë&
CM_ICLKEN2_CORE
)

139 
Ÿhî_ªg
 = (
ªg
 & ~0xf0) | 0x00;

144 i‡((
ªg
 & 0x0f) == 0) {

145 i‡(
˛k
->
íabÀ_bô
 <= 1 || clk->enable_bit == 31)

151 
bô
 = 1 << 
˛k
->
íabÀ_bô
;

152 i‡(!(
	`__øw_ªadl
(
Ÿhî_ªg
Ë& 
bô
))

154 
°_ªg
 = (
Ÿhî_ªg
 & ~0xf0) | 0x20;

155 
i
 = 0;

156 !(
	`__øw_ªadl
(
°_ªg
Ë& 
bô
)) {

157 
i
++;

158 i‡(
i
 == 100000) {

159 
	`¥ötk
(
KERN_ERR
 "Timeouàíablög clock %s\n", 
˛k
->
«me
);

163 i‡(
i
)

164 
	`¥_debug
("Clock %†°abÀá·î %dÜo›s\n", 
˛k
->
«me
, 
i
);

165 
	}
}

170 
	$_om≠2_˛k_íabÀ
(
˛k
 * clk)

172 
u32
 
ªgvÆ32
;

174 i‡(
˛k
->
Êags
 & 
ALWAYS_ENABLED
)

177 i‡(
	`u∆ikñy
(
˛k
 =&
osc_ck
)) {

178 
	`om≠2_£t_osc_ck
(1);

182 i‡(
	`u∆ikñy
(
˛k
->
íabÀ_ªg
 == 0)) {

183 
	`¥ötk
(
KERN_ERR
 "clock.c: Enable for %s withoutÉnable code\n",

184 
˛k
->
«me
);

188 i‡(
˛k
->
íabÀ_ªg
 =(
__iomem
 *)&
CM_CLKEN_PLL
) {

189 
	`om≠2_˛k_fixed_íabÀ
(
˛k
);

193 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

194 
ªgvÆ32
 |(1 << 
˛k
->
íabÀ_bô
);

195 
	`__øw_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

196 
	`wmb
();

198 
	`om≠2_˛k_waô_ªady
(
˛k
);

201 
	}
}

204 
	$om≠2_˛k_fixed_dißbÀ
(
˛k
 *clk)

206 
u32
 
cvÆ
;

208 if(
˛k
->
íabÀ_bô
 == 0xff)

211 
cvÆ
 = 
CM_CLKEN_PLL
;

212 
cvÆ
 &~(0x3 << 
˛k
->
íabÀ_bô
);

213 
CM_CLKEN_PLL
 = 
cvÆ
;

214 
	}
}

217 
	$_om≠2_˛k_dißbÀ
(
˛k
 *clk)

219 
u32
 
ªgvÆ32
;

221 i‡(
	`u∆ikñy
(
˛k
 =&
osc_ck
)) {

222 
	`om≠2_£t_osc_ck
(0);

226 i‡(
˛k
->
íabÀ_ªg
 == 0)

229 i‡(
˛k
->
íabÀ_ªg
 =(
__iomem
 *)&
CM_CLKEN_PLL
) {

230 
	`om≠2_˛k_fixed_dißbÀ
(
˛k
);

234 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

235 
ªgvÆ32
 &~(1 << 
˛k
->
íabÀ_bô
);

236 
	`__øw_wrôñ
(
ªgvÆ32
, 
˛k
->
íabÀ_ªg
);

237 
	`wmb
();

238 
	}
}

240 
	$om≠2_˛k_íabÀ
(
˛k
 *clk)

242 
ªt
 = 0;

244 i‡(
˛k
->
u£cou¡
++ == 0) {

245 i‡(
	`likñy
((
u32
)
˛k
->
∑ª¡
))

246 
ªt
 = 
	`om≠2_˛k_íabÀ
(
˛k
->
∑ª¡
);

248 i‡(
	`u∆ikñy
(
ªt
 != 0)) {

249 
˛k
->
u£cou¡
--;

250  
ªt
;

253 
ªt
 = 
	`_om≠2_˛k_íabÀ
(
˛k
);

255 i‡(
	`u∆ikñy
(
ªt
 !0Ë&& 
˛k
->
∑ª¡
) {

256 
	`om≠2_˛k_dißbÀ
(
˛k
->
∑ª¡
);

257 
˛k
->
u£cou¡
--;

261  
ªt
;

262 
	}
}

264 
	$om≠2_˛k_dißbÀ
(
˛k
 *clk)

266 i‡(
˛k
->
u£cou¡
 > 0 && !(--clk->usecount)) {

267 
	`_om≠2_˛k_dißbÀ
(
˛k
);

268 i‡(
	`likñy
((
u32
)
˛k
->
∑ª¡
))

269 
	`om≠2_˛k_dißbÀ
(
˛k
->
∑ª¡
);

271 
	}
}

277 
u32
 
	$om≠2_d∂l_round_øã
(
èrgë_øã
)

279 
u32
 
high
, 
low
;

281 i‡((
CM_CLKSEL2_PLL
 & 0x3) == 1) {

282 
high
 = 
cuº_¥cm_£t
->
d∂l_•ìd
 * 2;

283 
low
 = 
cuº_¥cm_£t
->
d∂l_•ìd
;

285 
high
 = 
cuº_¥cm_£t
->
d∂l_•ìd
;

286 
low
 = 
cuº_¥cm_£t
->
d∂l_•ìd
 / 2;

289 #ifde‡
DOWN_VARIABLE_DPLL


290 i‡(
èrgë_øã
 > 
high
)

291  
high
;

293  
èrgë_øã
;

295 i‡(
èrgë_øã
 > 
low
)

296  
high
;

298  
low
;

301 
	}
}

307 
	$om≠2_˛k£l_ªˇlc
(
˛k
 * clk)

309 
u32
 
fixed
 = 0, 
div
 = 0;

311 i‡(
˛k
 =&
d∂l_ck
) {

312 
˛k
->
øã
 = 
	`om≠2_gë_d∂l_øã
(clk);

313 
fixed
 = 1;

314 
div
 = 0;

317 i‡(
˛k
 =&
iva1_mpu_öt_ifck
) {

318 
div
 = 2;

319 
fixed
 = 1;

322 i‡((
˛k
 =&
dss1_fck
Ë&& ((
CM_CLKSEL1_CORE
 & (0x1f << 8)) == 0)) {

323 
˛k
->
øã
 = 
sys_ck
.rate;

327 i‡(!
fixed
) {

328 
div
 = 
	`om≠2_˛k£l_gë_divis‹
(
˛k
);

329 i‡(
div
 == 0)

333 i‡(
div
 != 0) {

334 i‡(
	`u∆ikñy
(
˛k
->
øã
 =˛k->
∑ª¡
->øã / 
div
))

336 
˛k
->
øã
 = clk->
∑ª¡
->øã / 
div
;

339 i‡(
	`u∆ikñy
(
˛k
->
Êags
 & 
RATE_PROPAGATES
))

340 
	`¥›ag©e_øã
(
˛k
);

341 
	}
}

347 
ölöe
 
u32
 
	$om≠2_dividî_‰om_èbÀ
(
u32
 
size
, u32 *
div_¨øy
,

348 
u32
 
§c_øã
, u32 
tgt_øã
)

350 
i
, 
ã°_øã
;

352 i‡(
div_¨øy
 =
NULL
)

355 
i
=0; i < 
size
; i++) {

356 
ã°_øã
 = 
§c_øã
 / *
div_¨øy
;

357 i‡(
ã°_øã
 <
tgt_øã
)

358  *
div_¨øy
;

359 ++
div_¨øy
;

363 
	}
}

371 
u32
 
	$om≠2_˛k£l_round_øã
(
˛k
 *
t˛k
, 
u32
 
èrgë_øã
,

372 
u32
 *
√w_div
)

374 
u32
 
gfx_div
[] = {2, 3, 4};

375 
u32
 
sys˛kout_div
[] = {1, 2, 4, 8, 16};

376 
u32
 
dss1_div
[] = {1, 2, 3, 4, 5, 6, 8, 9, 12, 16};

377 
u32
 
vy q_div
[] = {1, 2, 3, 4, 6, 8, 9, 12, 16, 18};

378 
u32
 
be°_div
 = ~0, 
asize
 = 0;

379 
u32
 *
div_¨øy
 = 
NULL
;

381 
t˛k
->
Êags
 & 
SRC_RATE_SEL_MASK
) {

382 
CM_GFX_SEL1
:

383 
asize
 = 3;

384 
div_¨øy
 = 
gfx_div
;

386 
CM_PLL_SEL1
:

387  
	`om≠2_d∂l_round_øã
(
èrgë_øã
);

388 
CM_SYSCLKOUT_SEL1
:

389 
asize
 = 5;

390 
div_¨øy
 = 
sys˛kout_div
;

392 
CM_CORE_SEL1
:

393 if(
t˛k
 =&
dss1_fck
){

394 if(
t˛k
->
∑ª¡
 =&
c‹e_ck
){

395 
asize
 = 10;

396 
div_¨øy
 = 
dss1_div
;

398 *
√w_div
 = 0;

399 (
t˛k
->
∑ª¡
->
øã
);

401 } if((
t˛k
 =&
vlynq_fck
Ë&& 
	`˝u_is_om≠2420
()){

402 if(
t˛k
->
∑ª¡
 =&
c‹e_ck
){

403 
asize
 = 10;

404 
div_¨øy
 = 
vy q_div
;

406 *
√w_div
 = 0;

407 (
t˛k
->
∑ª¡
->
øã
);

413 
be°_div
 = 
	`om≠2_dividî_‰om_èbÀ
(
asize
, 
div_¨øy
,

414 
t˛k
->
∑ª¡
->
øã
, 
èrgë_øã
);

415 i‡(
be°_div
 == ~0){

416 *
√w_div
 = 1;

417  
be°_div
;

420 *
√w_div
 = 
be°_div
;

421  (
t˛k
->
∑ª¡
->
øã
 / 
be°_div
);

422 
	}
}

425 
	$om≠2_˛k_round_øã
(
˛k
 *˛k, 
øã
)

427 
u32
 
√w_div
 = 0;

428 
vÆid_øã
;

430 i‡(
˛k
->
Êags
 & 
RATE_FIXED
)

431  
˛k
->
øã
;

433 i‡(
˛k
->
Êags
 & 
RATE_CKCTL
) {

434 
vÆid_øã
 = 
	`om≠2_˛k£l_round_øã
(
˛k
, 
øã
, &
√w_div
);

435  
vÆid_øã
;

438 i‡(
˛k
->
round_øã
 != 0)

439  
˛k
->
	`round_øã
(˛k, 
øã
);

441  
˛k
->
øã
;

442 
	}
}

448 
u32
 
	$om≠2_dŒ_f‹˚_√eded
()

450 
u32
 
dŒ_°©e
 = 
SDRC_DLLA_CTRL
;

452 i‡((
dŒ_°©e
 & (1 << 2)) == (1 << 2))

456 
	}
}

458 
u32
 
	$om≠2_ª¥ogøm_sdrc
(
u32
 
Àvñ
, u32 
f‹˚
)

460 
u32
 
¶ow_dŒ_˘æ
, 
Á°_dŒ_˘æ
, 
m_ty≥
;

461 
u32
 
¥ev
 = 
cuº_≥rf_Àvñ
, 
Êags
;

463 i‡((
cuº_≥rf_Àvñ
 =
Àvñ
Ë&& !
f‹˚
)

464  
¥ev
;

466 
m_ty≥
 = 
	`om≠2_mem‹y_gë_ty≥
();

467 
¶ow_dŒ_˘æ
 = 
	`om≠2_mem‹y_gë_¶ow_dŒ_˘æ
();

468 
Á°_dŒ_˘æ
 = 
	`om≠2_mem‹y_gë_Á°_dŒ_˘æ
();

470 i‡(
Àvñ
 =
PRCM_HALF_SPEED
) {

471 
	`loˇl_úq_ßve
(
Êags
);

472 
PRCM_VOLTSETUP
 = 0xffff;

473 
	`om≠2_§am_ª¥ogøm_sdrc
(
PRCM_HALF_SPEED
,

474 
¶ow_dŒ_˘æ
, 
m_ty≥
);

475 
cuº_≥rf_Àvñ
 = 
PRCM_HALF_SPEED
;

476 
	`loˇl_úq_ª°‹e
(
Êags
);

478 i‡(
Àvñ
 =
PRCM_FULL_SPEED
) {

479 
	`loˇl_úq_ßve
(
Êags
);

480 
PRCM_VOLTSETUP
 = 0xffff;

481 
	`om≠2_§am_ª¥ogøm_sdrc
(
PRCM_FULL_SPEED
,

482 
Á°_dŒ_˘æ
, 
m_ty≥
);

483 
cuº_≥rf_Àvñ
 = 
PRCM_FULL_SPEED
;

484 
	`loˇl_úq_ª°‹e
(
Êags
);

487  
¥ev
;

488 
	}
}

490 
	$om≠2_ª¥ogøm_d∂l
(
˛k
 * clk, 
øã
)

492 
u32
 
Êags
, 
cur_øã
, 
low
, 
mu…
, 
div
, 
vÆid_øã
, 
d⁄e_øã
;

493 
u32
 
by∑ss
 = 0;

494 
¥cm_c⁄fig
 
tmp£t
;

495 
ªt
 = -
EINVAL
;

497 
	`loˇl_úq_ßve
(
Êags
);

498 
cur_øã
 = 
	`om≠2_gë_d∂l_øã
(&
d∂l_ck
);

499 
mu…
 = 
CM_CLKSEL2_PLL
 & 0x3;

501 i‡((
øã
 =(
cur_øã
 / 2)Ë&& (
mu…
 == 2)) {

502 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_HALF_SPEED
, 1);

503 } i‡((
øã
 =(
cur_øã
 * 2)Ë&& (
mu…
 == 1)) {

504 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_FULL_SPEED
, 1);

505 } i‡(
øã
 !
cur_øã
) {

506 
vÆid_øã
 = 
	`om≠2_d∂l_round_øã
(
øã
);

507 i‡(
vÆid_øã
 !
øã
)

508 
d∂l_exô
;

510 i‡((
CM_CLKSEL2_PLL
 & 0x3) == 1)

511 
low
 = 
cuº_¥cm_£t
->
d∂l_•ìd
;

513 
low
 = 
cuº_¥cm_£t
->
d∂l_•ìd
 / 2;

515 
tmp£t
.
cm_˛k£l1_∂l
 = 
CM_CLKSEL1_PLL
;

516 
tmp£t
.
cm_˛k£l1_∂l
 &= ~(0x3FFF << 8);

517 
div
 = ((
cuº_¥cm_£t
->
xèl_•ìd
 / 1000000) - 1);

518 
tmp£t
.
cm_˛k£l2_∂l
 = 
CM_CLKSEL2_PLL
;

519 
tmp£t
.
cm_˛k£l2_∂l
 &= ~0x3;

520 i‡(
øã
 > 
low
) {

521 
tmp£t
.
cm_˛k£l2_∂l
 |= 0x2;

522 
mu…
 = ((
øã
 / 2) / 1000000);

523 
d⁄e_øã
 = 
PRCM_FULL_SPEED
;

525 
tmp£t
.
cm_˛k£l2_∂l
 |= 0x1;

526 
mu…
 = (
øã
 / 1000000);

527 
d⁄e_øã
 = 
PRCM_HALF_SPEED
;

529 
tmp£t
.
cm_˛k£l1_∂l
 |((
div
 << 8Ë| (
mu…
 << 12));

532 
tmp£t
.
ba£_sdrc_r‰
 = 
V24XX_SDRC_RFR_CTRL_BYPASS
;

534 i‡(
øã
 =
cuº_¥cm_£t
->
xèl_•ìd
)

535 
by∑ss
 = 1;

537 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_FULL_SPEED
, 1);

540 
	`om≠2_£t_¥cm
(
tmp£t
.
cm_˛k£l1_∂l
,Åmp£t.
ba£_sdrc_r‰
,

541 
by∑ss
);

544 
	`om≠2_öô_mem‹y_∑øms
(
	`om≠2_dŒ_f‹˚_√eded
());

545 
	`om≠2_ª¥ogøm_sdrc
(
d⁄e_øã
, 0);

547 
	`om≠2_˛k£l_ªˇlc
(&
d∂l_ck
);

548 
ªt
 = 0;

550 
d∂l_exô
:

551 
	`loˇl_úq_ª°‹e
(
Êags
);

552 (
ªt
);

553 
	}
}

556 
	$om≠2_mpu_ªˇlc
(
˛k
 * clk)

558 
˛k
->
øã
 = 
cuº_¥cm_£t
->
mpu_•ìd
;

559 
	}
}

568 
	$om≠2_round_to_èbÀ_øã
(
˛k
 * clk, 
øã
)

570 
¥cm_c⁄fig
 * 
±r
;

571 
highe°_øã
;

573 i‡(
˛k
 !&
vút_¥cm_£t
)

574  -
EINVAL
;

576 
highe°_øã
 = -
EINVAL
;

578 
±r
 = 
øã_èbÀ
;Öå->
mpu_•ìd
;Ötr++) {

579 i‡(
±r
->
xèl_•ìd
 !
sys_ck
.
øã
)

582 
highe°_øã
 = 
±r
->
mpu_•ìd
;

585 i‡(
±r
->
mpu_•ìd
 <
øã
)

588  
highe°_øã
;

589 
	}
}

594 
u32
 
	$om≠2_˛k£l_to_divis‹
(
u32
 
div_£l
, u32 
fõld_vÆ
)

596 
u32
 
i
;

597 
u32
 
˛kout_¨øy
[] = {1, 2, 4, 8, 16};

599 i‡((
div_£l
 & 
SRC_RATE_SEL_MASK
Ë=
CM_SYSCLKOUT_SEL1
) {

600 
i
 = 0; i < 5; i++) {

601 i‡(
fõld_vÆ
 =
i
)

602  
˛kout_¨øy
[
i
];

606  
fõld_vÆ
;

607 
	}
}

613 
u32
 
	$om≠2_gë_˛k£l
(
u32
 *
div_£l
, u32 *
fõld_mask
,

614 
˛k
 *clk)

616 
ªt
 = ~0;

617 
u32
 
ªg_vÆ
, 
div_off
;

618 
u32
 
div_addr
 = 0;

619 
u32
 
mask
 = ~0;

621 
div_off
 = 
˛k
->
øã_off£t
;

623 (*
div_£l
 & 
SRC_RATE_SEL_MASK
)) {

624 
CM_MPU_SEL1
:

625 
div_addr
 = (
u32
)&
CM_CLKSEL_MPU
;

626 
mask
 = 0x1f;

628 
CM_DSP_SEL1
:

629 
div_addr
 = (
u32
)&
CM_CLKSEL_DSP
;

630 i‡(
	`˝u_is_om≠2420
()) {

631 i‡((
div_off
 == 0) || (div_off == 8))

632 
mask
 = 0x1f;

633 i‡(
div_off
 == 5)

634 
mask
 = 0x3;

635 } i‡(
	`˝u_is_om≠2430
()) {

636 i‡(
div_off
 == 0)

637 
mask
 = 0x1f;

638 i‡(
div_off
 == 5)

639 
mask
 = 0x3;

642 
CM_GFX_SEL1
:

643 
div_addr
 = (
u32
)&
CM_CLKSEL_GFX
;

644 i‡(
div_off
 == 0)

645 
mask
 = 0x7;

647 
CM_MODEM_SEL1
:

648 
div_addr
 = (
u32
)&
CM_CLKSEL_MDM
;

649 i‡(
div_off
 == 0)

650 
mask
 = 0xf;

652 
CM_SYSCLKOUT_SEL1
:

653 
div_addr
 = (
u32
)&
PRCM_CLKOUT_CTRL
;

654 i‡((
div_off
 == 3) || (div_off = 11))

655 
mask
= 0x3;

657 
CM_CORE_SEL1
:

658 
div_addr
 = (
u32
)&
CM_CLKSEL1_CORE
;

659 
div_off
) {

664 
mask
 = 0x1f; ;

666 
mask
 = 0x3; ;

668 
mask
 = 0x1; ;

670 
mask
 = 0x7; ;

674 *
fõld_mask
 = 
mask
;

676 i‡(
	`u∆ikñy
(
mask
 == ~0))

677 
div_addr
 = 0;

679 *
div_£l
 = 
div_addr
;

681 i‡(
	`u∆ikñy
(
div_addr
 == 0))

682  
ªt
;

685 
ªg_vÆ
 = 
	`__øw_ªadl
((
__iomem
 *)
div_addr
Ë& (
mask
 << 
div_off
);

688 
ªg_vÆ
 >>
div_off
;

690  
ªg_vÆ
;

691 
	}
}

697 
u32
 
	$om≠2_˛k£l_gë_divis‹
(
˛k
 *clk)

699 
ªt
 = 0;

700 
u32
 
div
, 
div_£l
, 
div_off
, 
fõld_mask
, 
fõld_vÆ
;

703 
div_£l
 = (
SRC_RATE_SEL_MASK
 & 
˛k
->
Êags
);

705 
div_off
 = 
˛k
->
øã_off£t
;

706 
fõld_vÆ
 = 
	`om≠2_gë_˛k£l
(&
div_£l
, &
fõld_mask
, 
˛k
);

707 i‡(
div_£l
 == 0)

708  
ªt
;

710 
div_£l
 = (
SRC_RATE_SEL_MASK
 & 
˛k
->
Êags
);

711 
div
 = 
	`om≠2_˛k£l_to_divis‹
(
div_£l
, 
fõld_vÆ
);

713  
div
;

714 
	}
}

717 
	$om≠2_˛k_£t_øã
(
˛k
 *˛k, 
øã
)

720 
ªt
 = -
EINVAL
;

721 
__iomem
 * 
ªg
;

722 
u32
 
div_£l
, 
div_off
, 
fõld_mask
, 
fõld_vÆ
, 
ªg_vÆ
, 
vÆidøã
;

723 
u32
 
√w_div
 = 0;

725 i‡(!(
˛k
->
Êags
 & 
CONFIG_PARTICIPANT
Ë&& (˛k->Êag†& 
RATE_CKCTL
)) {

726 i‡(
˛k
 =&
d∂l_ck
)

727  
	`om≠2_ª¥ogøm_d∂l
(
˛k
, 
øã
);

730 
div_£l
 = (
SRC_RATE_SEL_MASK
 & 
˛k
->
Êags
);

731 
div_off
 = 
˛k
->
øã_off£t
;

733 
vÆidøã
 = 
	`om≠2_˛k£l_round_øã
(
˛k
, 
øã
, &
√w_div
);

734 i‡(
vÆidøã
 !
øã
)

735 (
ªt
);

737 
fõld_vÆ
 = 
	`om≠2_gë_˛k£l
(&
div_£l
, &
fõld_mask
, 
˛k
);

738 i‡(
div_£l
 == 0)

739  
ªt
;

741 i‡(
˛k
->
Êags
 & 
CM_SYSCLKOUT_SEL1
) {

742 
√w_div
) {

744 
fõld_vÆ
 = 4;

747 
fõld_vÆ
 = 3;

750 
fõld_vÆ
 = 2;

753 
fõld_vÆ
 = 1;

756 
fõld_vÆ
 = 0;

760 
fõld_vÆ
 = 
√w_div
;

762 
ªg
 = (
__iomem
 *)
div_£l
;

764 
ªg_vÆ
 = 
	`__øw_ªadl
(
ªg
);

765 
ªg_vÆ
 &~(
fõld_mask
 << 
div_off
);

766 
ªg_vÆ
 |(
fõld_vÆ
 << 
div_off
);

767 
	`__øw_wrôñ
(
ªg_vÆ
, 
ªg
);

768 
	`wmb
();

769 
˛k
->
øã
 = clk->
∑ª¡
->øã / 
fõld_vÆ
;

771 i‡(
˛k
->
Êags
 & 
DELAYED_APP
) {

772 
	`__øw_wrôñ
(0x1, (
__iomem
 *)&
PRCM_CLKCFG_CTRL
);

773 
	`wmb
();

775 
ªt
 = 0;

776 } i‡(
˛k
->
£t_øã
 != 0)

777 
ªt
 = 
˛k
->
	`£t_øã
(˛k, 
øã
);

779 i‡(
	`u∆ikñy
(
ªt
 =0 && (
˛k
->
Êags
 & 
RATE_PROPAGATES
)))

780 
	`¥›ag©e_øã
(
˛k
);

782  
ªt
;

783 
	}
}

786 
u32
 
	$om≠2_gë_§c_fõld
(
u32
 *
ty≥_to_addr
, u32 
ªg_off£t
,

787 
˛k
 *
§c_˛k
, 
u32
 *
fõld_mask
)

789 
u32
 
vÆ
 = ~0, 
§c_ªg_addr
 = 0, 
mask
 = 0;

792 (*
ty≥_to_addr
 & 
SRC_RATE_SEL_MASK
)) {

793 
CM_CORE_SEL1
:

794 
§c_ªg_addr
 = (
u32
)&
CM_CLKSEL1_CORE
;

795 i‡(
ªg_off£t
 == 13) {

796 
mask
 = 0x1;

797 i‡(
§c_˛k
 =&
sys_ck
)

798 
vÆ
 = 0;

799 i‡(
§c_˛k
 =&
func_48m_ck
)

800 
vÆ
 = 1;

801 } i‡(
ªg_off£t
 == 8) {

802 
mask
 = 0x1f;

803 i‡(
§c_˛k
 =&
sys_ck
)

804 
vÆ
 = 0;

805 i‡(
§c_˛k
 =&
c‹e_ck
)

806 
vÆ
 = 0x10;

807 } i‡((
ªg_off£t
 =15Ë&& 
	`˝u_is_om≠2420
()){

808 
mask
 = 0x1F;

809 if(
§c_˛k
 =&
func_96m_ck
)

810 
vÆ
 = 0;

811 i‡(
§c_˛k
 =&
c‹e_ck
)

812 
vÆ
 = 0x10;

815 
CM_CORE_SEL2
:

816 
§c_ªg_addr
 = (
u32
)&
CM_CLKSEL2_CORE
;

817 
mask
 = 0x3;

818 i‡(
§c_˛k
 =&
func_32k_ck
)

819 
vÆ
 = 0x0;

820 i‡(
§c_˛k
 =&
sys_ck
)

821 
vÆ
 = 0x1;

822 i‡(
§c_˛k
 =&
Æt_ck
)

823 
vÆ
 = 0x2;

825 
CM_WKUP_SEL1
:

826 
§c_ªg_addr
 = (
u32
)&
CM_CLKSEL_WKUP
;

827 
mask
 = 0x3;

828 i‡(
§c_˛k
 =&
func_32k_ck
)

829 
vÆ
 = 0x0;

830 i‡(
§c_˛k
 =&
sys_ck
)

831 
vÆ
 = 0x1;

832 i‡(
§c_˛k
 =&
Æt_ck
)

833 
vÆ
 = 0x2;

835 
CM_PLL_SEL1
:

836 
§c_ªg_addr
 = (
u32
)&
CM_CLKSEL1_PLL
;

837 
mask
 = 0x1;

838 i‡(
ªg_off£t
 == 0x3) {

839 i‡(
§c_˛k
 =&
≠Œ96_ck
)

840 
vÆ
 = 0;

841 i‡(
§c_˛k
 =&
Æt_ck
)

842 
vÆ
 = 1;

844 i‡(
ªg_off£t
 == 0x5) {

845 i‡(
§c_˛k
 =&
≠Œ54_ck
)

846 
vÆ
 = 0;

847 i‡(
§c_˛k
 =&
Æt_ck
)

848 
vÆ
 = 1;

851 
CM_PLL_SEL2
:

852 
§c_ªg_addr
 = (
u32
)&
CM_CLKSEL2_PLL
;

853 
mask
 = 0x3;

854 i‡(
§c_˛k
 =&
func_32k_ck
)

855 
vÆ
 = 0x0;

856 i‡(
§c_˛k
 =&
d∂l_ck
)

857 
vÆ
 = 0x2;

859 
CM_SYSCLKOUT_SEL1
:

860 
§c_ªg_addr
 = (
u32
)&
PRCM_CLKOUT_CTRL
;

861 
mask
 = 0x3;

862 i‡(
§c_˛k
 =&
d∂l_ck
)

863 
vÆ
 = 0;

864 i‡(
§c_˛k
 =&
sys_ck
)

865 
vÆ
 = 1;

866 i‡(
§c_˛k
 =&
func_96m_ck
)

867 
vÆ
 = 2;

868 i‡(
§c_˛k
 =&
func_54m_ck
)

869 
vÆ
 = 3;

873 i‡(
vÆ
 == ~0)

874 *
ty≥_to_addr
 = 0;

876 *
ty≥_to_addr
 = 
§c_ªg_addr
;

877 *
fõld_mask
 = 
mask
;

879  
vÆ
;

880 
	}
}

882 
	$om≠2_˛k_£t_∑ª¡
(
˛k
 *˛k, ˛k *
√w_∑ª¡
)

884 
__iomem
 * 
ªg
;

885 
u32
 
§c_£l
, 
§c_off
, 
fõld_vÆ
, 
fõld_mask
, 
ªg_vÆ
, 
øã
;

886 
ªt
 = -
EINVAL
;

888 i‡(
	`u∆ikñy
(
˛k
->
Êags
 & 
CONFIG_PARTICIPANT
))

889  
ªt
;

891 i‡(
˛k
->
Êags
 & 
SRC_SEL_MASK
) {

892 
§c_£l
 = (
SRC_RATE_SEL_MASK
 & 
˛k
->
Êags
);

893 
§c_off
 = 
˛k
->
§c_off£t
;

895 i‡(
§c_£l
 == 0)

896 
£t_∑ª¡_îr‹
;

898 
fõld_vÆ
 = 
	`om≠2_gë_§c_fõld
(&
§c_£l
, 
§c_off
, 
√w_∑ª¡
,

899 &
fõld_mask
);

901 
ªg
 = (
__iomem
 *)
§c_£l
;

903 i‡(
˛k
->
u£cou¡
 > 0)

904 
	`_om≠2_˛k_dißbÀ
(
˛k
);

907 
ªg_vÆ
 = 
	`__øw_ªadl
(
ªg
Ë& ~(
fõld_mask
 << 
§c_off
);

908 
ªg_vÆ
 |(
fõld_vÆ
 << 
§c_off
);

909 
	`__øw_wrôñ
(
ªg_vÆ
, 
ªg
);

910 
	`wmb
();

912 i‡(
˛k
->
Êags
 & 
DELAYED_APP
) {

913 
	`__øw_wrôñ
(0x1, (
__iomem
 *)&
PRCM_CLKCFG_CTRL
);

914 
	`wmb
();

916 i‡(
˛k
->
u£cou¡
 > 0)

917 
	`_om≠2_˛k_íabÀ
(
˛k
);

919 
˛k
->
∑ª¡
 = 
√w_∑ª¡
;

922 i‡((
√w_∑ª¡
 =&
c‹e_ck
Ë&& (
˛k
 =&
dss1_fck
))

923 
˛k
->
øã
 = 
√w_∑ª¡
->rate / 0x10;

925 
˛k
->
øã
 = 
√w_∑ª¡
->rate;

927 i‡(
	`u∆ikñy
(
˛k
->
Êags
 & 
RATE_PROPAGATES
))

928 
	`¥›ag©e_øã
(
˛k
);

932 
˛k
->
∑ª¡
 = 
√w_∑ª¡
;

933 
øã
 = 
√w_∑ª¡
->rate;

934 
	`om≠2_˛k_£t_øã
(
˛k
, 
øã
);

935 
ªt
 = 0;

938 
£t_∑ª¡_îr‹
:

939  
ªt
;

940 
	}
}

943 
	$om≠2_£À˘_èbÀ_øã
(
˛k
 * clk, 
øã
)

945 
u32
 
Êags
, 
cur_øã
, 
d⁄e_øã
, 
by∑ss
 = 0;

946 
u8
 
˝u_mask
 = 0;

947 
¥cm_c⁄fig
 *
¥cm
;

948 
found_•ìd
 = 0;

950 i‡(
˛k
 !&
vút_¥cm_£t
)

951  -
EINVAL
;

954 i‡(
	`˝u_is_om≠2420
())

955 
˝u_mask
 = 
RATE_IN_242X
;

956 i‡(
	`˝u_is_om≠2430
())

957 
˝u_mask
 = 
RATE_IN_243X
;

959 
¥cm
 = 
øã_èbÀ
;Örcm->
mpu_•ìd
;Örcm++) {

960 i‡(!(
¥cm
->
Êags
 & 
˝u_mask
))

963 i‡(
¥cm
->
xèl_•ìd
 !
sys_ck
.
øã
)

966 i‡(
¥cm
->
mpu_•ìd
 <
øã
) {

967 
found_•ìd
 = 
¥cm
->
mpu_•ìd
;

972 i‡(!
found_•ìd
) {

973 
	`¥ötk
(
KERN_INFO
 "CouldÇot set MPUÑateÅo %luMHz\n",

974 
øã
 / 1000000);

975  -
EINVAL
;

978 
cuº_¥cm_£t
 = 
¥cm
;

979 
cur_øã
 = 
	`om≠2_gë_d∂l_øã
(&
d∂l_ck
);

981 i‡(
¥cm
->
d∂l_•ìd
 =
cur_øã
 / 2) {

982 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_HALF_SPEED
, 1);

983 } i‡(
¥cm
->
d∂l_•ìd
 =
cur_øã
 * 2) {

984 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_FULL_SPEED
, 1);

985 } i‡(
¥cm
->
d∂l_•ìd
 !
cur_øã
) {

986 
	`loˇl_úq_ßve
(
Êags
);

988 i‡(
¥cm
->
d∂l_•ìd
 =¥cm->
xèl_•ìd
)

989 
by∑ss
 = 1;

991 i‡((
¥cm
->
cm_˛k£l2_∂l
 & 0x3) == 2)

992 
d⁄e_øã
 = 
PRCM_FULL_SPEED
;

994 
d⁄e_øã
 = 
PRCM_HALF_SPEED
;

997 
CM_CLKSEL_MPU
 = 
¥cm
->
cm_˛k£l_mpu
;

1000 
CM_CLKSEL_DSP
 = 
¥cm
->
cm_˛k£l_d•
;

1002 
CM_CLKSEL_GFX
 = 
¥cm
->
cm_˛k£l_gfx
;

1005 
CM_CLKSEL1_CORE
 = 
¥cm
->
cm_˛k£l1_c‹e
;

1006 i‡(
	`˝u_is_om≠2430
())

1007 
CM_CLKSEL_MDM
 = 
¥cm
->
cm_˛k£l_mdm
;

1010 
	`om≠2_ª¥ogøm_sdrc
(
PRCM_FULL_SPEED
, 1);

1012 
	`om≠2_£t_¥cm
(
¥cm
->
cm_˛k£l1_∂l
,Örcm->
ba£_sdrc_r‰
,

1013 
by∑ss
);

1015 
	`om≠2_öô_mem‹y_∑øms
(
	`om≠2_dŒ_f‹˚_√eded
());

1016 
	`om≠2_ª¥ogøm_sdrc
(
d⁄e_øã
, 0);

1018 
	`loˇl_úq_ª°‹e
(
Êags
);

1020 
	`om≠2_˛k£l_ªˇlc
(&
d∂l_ck
);

1023 
	}
}

1029 #ifde‡
CONFIG_OMAP_RESET_CLOCKS


1030 
__öô
 
	$om≠2_˛k_dißbÀ_unu£d
(
˛k
 *clk)

1032 
u32
 
ªgvÆ32
;

1034 
ªgvÆ32
 = 
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
);

1035 i‡((
ªgvÆ32
 & (1 << 
˛k
->
íabÀ_bô
)) == 0)

1038 
	`¥ötk
(
KERN_INFO
 "Dißblög unu£d clock \"%s\"\n", 
˛k
->
«me
);

1039 
	`_om≠2_˛k_dißbÀ
(
˛k
);

1040 
	}
}

1042 
	#om≠2_˛k_dißbÀ_unu£d
 
NULL


	)

1045 
˛k_fun˘i⁄s
 
	gom≠2_˛k_fun˘i⁄s
 = {

1046 .
˛k_íabÀ
 = 
om≠2_˛k_íabÀ
,

1047 .
	g˛k_dißbÀ
 = 
om≠2_˛k_dißbÀ
,

1048 .
	g˛k_round_øã
 = 
om≠2_˛k_round_øã
,

1049 .
	g˛k_£t_øã
 = 
om≠2_˛k_£t_øã
,

1050 .
	g˛k_£t_∑ª¡
 = 
om≠2_˛k_£t_∑ª¡
,

1051 .
	g˛k_dißbÀ_unu£d
 = 
om≠2_˛k_dißbÀ_unu£d
,

1054 
__öô
 
	$om≠2_gë_¸y°Æ_øã
(
˛k
 *
osc
, ˛k *
sys
)

1056 
u32
 
div
, 
≠Œs
, 
s˛k
 = 13000000;

1058 
≠Œs
 = 
CM_CLKSEL1_PLL
;

1059 
≠Œs
 &= ((1 << 23) | (1 << 24) | (1 << 25));

1060 
≠Œs
 >>= 23;

1062 i‡(
≠Œs
 == 0)

1063 
s˛k
 = 19200000;

1064 i‡(
≠Œs
 == 2)

1065 
s˛k
 = 13000000;

1066 i‡(
≠Œs
 == 3)

1067 
s˛k
 = 12000000;

1069 
div
 = 
PRCM_CLKSRC_CTRL
;

1070 
div
 &= ((1 << 7) | (1 << 6));

1071 
div
 >>
sys
->
øã_off£t
;

1073 
osc
->
øã
 = 
s˛k
 * 
div
;

1074 
sys
->
øã
 = 
s˛k
;

1075 
	}
}

1080 
	$om≠2_˛k_¥ï¨e_f‹_ªboŸ
()

1082 
u32
 
øã
;

1084 i‡(
v˛k
 =
NULL
 || 
s˛k
 == NULL)

1087 
øã
 = 
	`˛k_gë_øã
(
s˛k
);

1088 
	`˛k_£t_øã
(
v˛k
, 
øã
);

1089 
	}
}

1095 
__öô
 
	$om≠2_˛k_¨ch_öô
()

1097 i‡(!
mpuøã
)

1098  -
EINVAL
;

1100 i‡(
	`om≠2_£À˘_èbÀ_øã
(&
vút_¥cm_£t
, 
mpuøã
))

1101 
	`¥ötk
(
KERN_ERR
 "CouldÇot find matching MPUÑate\n");

1103 
	`¥›ag©e_øã
(&
osc_ck
);

1104 
	`¥›ag©e_øã
(&
func_32k_ck
);

1106 
	`¥ötk
(
KERN_INFO
 "SwitchedÅoÇew clockingÑate (Crystal/DPLL/MPU): "

1108 (
sys_ck
.
øã
 / 1000000), (sys_ck.rate / 100000) % 10,

1109 (
d∂l_ck
.
øã
 / 1000000), (
mpu_ck
.rate / 1000000)) ;

1112 
	}
}

1113 
¨ch_öôˇŒ
(
om≠2_˛k_¨ch_öô
);

1115 
__öô
 
	$om≠2_˛k_öô
()

1117 
¥cm_c⁄fig
 *
¥cm
;

1118 
˛k
 ** 
˛kp
;

1119 
u32
 
˛køã
;

1121 
	`˛k_öô
(&
om≠2_˛k_fun˘i⁄s
);

1122 
	`om≠2_gë_¸y°Æ_øã
(&
osc_ck
, &
sys_ck
);

1124 
˛kp
 = 
⁄chù_˛ks
; clk∞< onchù_˛k†+ 
	`ARRAY_SIZE
(onchip_clks);

1125 
˛kp
++) {

1127 i‡((*
˛kp
)->
Êags
 & 
CLOCK_IN_OMAP242X
 && 
	`˝u_is_om≠2420
()) {

1128 
	`˛k_ªgi°î
(*
˛kp
);

1132 i‡((*
˛kp
)->
Êags
 & 
CLOCK_IN_OMAP243X
 && 
	`˝u_is_om≠2430
()) {

1133 
	`˛k_ªgi°î
(*
˛kp
);

1139 
˛køã
 = 
	`om≠2_gë_d∂l_øã
(&
d∂l_ck
);

1140 
¥cm
 = 
øã_èbÀ
;Örcm->
mpu_•ìd
;Örcm++) {

1141 i‡(
¥cm
->
xèl_•ìd
 !
sys_ck
.
øã
)

1143 i‡(
¥cm
->
d∂l_•ìd
 <
˛køã
)

1146 
cuº_¥cm_£t
 = 
¥cm
;

1148 
	`¥›ag©e_øã
(&
osc_ck
);

1149 
	`¥›ag©e_øã
(&
func_32k_ck
);

1151 
	`¥ötk
(
KERN_INFO
 "ClockingÑate (Crystal/DPLL/MPU): "

1153 (
sys_ck
.
øã
 / 1000000), (sys_ck.rate / 100000) % 10,

1154 (
d∂l_ck
.
øã
 / 1000000), (
mpu_ck
.rate / 1000000)) ;

1160 
	`˛k_íabÀ
(&
sync_32k_ick
);

1161 
	`˛k_íabÀ
(&
om≠˘æ_ick
);

1165 
	`˛k_íabÀ
(&
≠Œ96_ck
);

1166 
	`˛k_íabÀ
(&
≠Œ54_ck
);

1168 i‡(
	`˝u_is_om≠2430
())

1169 
	`˛k_íabÀ
(&
sdrc_ick
);

1172 
v˛k
 = 
	`˛k_gë
(
NULL
, "virt_prcm_set");

1173 
s˛k
 = 
	`˛k_gë
(
NULL
, "sys_ck");

1176 
	}
}

1178 
__öô
 
	$om≠2_dißbÀ_≠Œs
()

1180 
	`˛k_dißbÀ
(&
≠Œ96_ck
);

1181 
	`˛k_dißbÀ
(&
≠Œ54_ck
);

1184 
	}
}

1185 
œã_öôˇŒ
(
om≠2_dißbÀ_≠Œs
);

	@arch/arm/mach-omap2/clock.h

17 #i‚de‡
__ARCH_ARM_MACH_OMAP2_CLOCK_H


18 
	#__ARCH_ARM_MACH_OMAP2_CLOCK_H


	)

20 
om≠2_sys_˛k_ªˇlc
(
˛k
 * clk);

21 
om≠2_˛k£l_ªˇlc
(
˛k
 * clk);

22 
om≠2_fﬁlow∑ª¡_ªˇlc
(
˛k
 * clk);

23 
om≠2_¥›ag©e_øã
(
˛k
 * clk);

24 
om≠2_mpu_ªˇlc
(
˛k
 * clk);

25 
om≠2_£À˘_èbÀ_øã
(
˛k
 * clk, 
øã
);

26 
om≠2_round_to_èbÀ_øã
(
˛k
 * clk, 
øã
);

27 
om≠2_˛k_dißbÀ
(
˛k
 *clk);

28 
om≠2_sys_˛k_ªˇlc
(
˛k
 * clk);

29 
u32
 
om≠2_˛k£l_to_divis‹
(u32 
div_£l
, u32 
fõld_vÆ
);

30 
u32
 
om≠2_˛k£l_gë_divis‹
(
˛k
 *clk);

33 
	#RATE_IN_242X
 (1 << 0)

	)

34 
	#RATE_IN_243X
 (1 << 1)

	)

40 
	s¥cm_c⁄fig
 {

41 
	mxèl_•ìd
;

42 
	md∂l_•ìd
;

43 
	mmpu_•ìd
;

44 
	mcm_˛k£l_mpu
;

45 
	mcm_˛k£l_d•
;

46 
	mcm_˛k£l_gfx
;

47 
	mcm_˛k£l1_c‹e
;

48 
	mcm_˛k£l1_∂l
;

49 
	mcm_˛k£l2_∂l
;

50 
	mcm_˛k£l_mdm
;

51 
	mba£_sdrc_r‰
;

52 
	mÊags
;

56 
	#SRC_SEL_MASK
 (
CM_CORE_SEL1
 | 
CM_CORE_SEL2
 | 
CM_WKUP_SEL1
 | \

57 
CM_PLL_SEL1
 | 
CM_PLL_SEL2
 | 
CM_SYSCLKOUT_SEL1
)

	)

60 
	#SRC_RATE_SEL_MASK
 (
CM_MPU_SEL1
 | 
CM_DSP_SEL1
 | 
CM_GFX_SEL1
 | \

61 
CM_MODEM_SEL1
 | 
CM_CORE_SEL1
 | 
CM_CORE_SEL2
 | \

62 
CM_WKUP_SEL1
 | 
CM_PLL_SEL1
 | 
CM_PLL_SEL2
 | \

63 
CM_SYSCLKOUT_SEL1
)

	)

80 
	#RX_CLKSEL_DSS1
 (0x10 << 8)

	)

81 
	#RX_CLKSEL_DSS2
 (0x0 << 13)

	)

82 
	#RX_CLKSEL_SSI
 (0x5 << 20)

	)

89 
	#R1_CLKSEL_L3
 (4 << 0)

	)

90 
	#R1_CLKSEL_L4
 (2 << 5)

	)

91 
	#R1_CLKSEL_USB
 (4 << 25)

	)

92 
	#R1_CM_CLKSEL1_CORE_VAL
 
R1_CLKSEL_USB
 | 
RX_CLKSEL_SSI
 | \

93 
RX_CLKSEL_DSS2
 | 
RX_CLKSEL_DSS1
 | \

94 
R1_CLKSEL_L4
 | 
R1_CLKSEL_L3


	)

95 
	#R1_CLKSEL_MPU
 (2 << 0)

	)

96 
	#R1_CM_CLKSEL_MPU_VAL
 
R1_CLKSEL_MPU


	)

97 
	#R1_CLKSEL_DSP
 (2 << 0)

	)

98 
	#R1_CLKSEL_DSP_IF
 (2 << 5)

	)

99 
	#R1_CM_CLKSEL_DSP_VAL
 
R1_CLKSEL_DSP
 | 
R1_CLKSEL_DSP_IF


	)

100 
	#R1_CLKSEL_GFX
 (2 << 0)

	)

101 
	#R1_CM_CLKSEL_GFX_VAL
 
R1_CLKSEL_GFX


	)

102 
	#R1_CLKSEL_MDM
 (4 << 0)

	)

103 
	#R1_CM_CLKSEL_MDM_VAL
 
R1_CLKSEL_MDM


	)

106 
	#R2_CLKSEL_L3
 (6 << 0)

	)

107 
	#R2_CLKSEL_L4
 (2 << 5)

	)

108 
	#R2_CLKSEL_USB
 (2 << 25)

	)

109 
	#R2_CM_CLKSEL1_CORE_VAL
 
R2_CLKSEL_USB
 | 
RX_CLKSEL_SSI
 | \

110 
RX_CLKSEL_DSS2
 | 
RX_CLKSEL_DSS1
 | \

111 
R2_CLKSEL_L4
 | 
R2_CLKSEL_L3


	)

112 
	#R2_CLKSEL_MPU
 (2 << 0)

	)

113 
	#R2_CM_CLKSEL_MPU_VAL
 
R2_CLKSEL_MPU


	)

114 
	#R2_CLKSEL_DSP
 (2 << 0)

	)

115 
	#R2_CLKSEL_DSP_IF
 (3 << 5)

	)

116 
	#R2_CM_CLKSEL_DSP_VAL
 
R2_CLKSEL_DSP
 | 
R2_CLKSEL_DSP_IF


	)

117 
	#R2_CLKSEL_GFX
 (2 << 0)

	)

118 
	#R2_CM_CLKSEL_GFX_VAL
 
R2_CLKSEL_GFX


	)

119 
	#R2_CLKSEL_MDM
 (6 << 0)

	)

120 
	#R2_CM_CLKSEL_MDM_VAL
 
R2_CLKSEL_MDM


	)

123 
	#RB_CLKSEL_L3
 (1 << 0)

	)

124 
	#RB_CLKSEL_L4
 (1 << 5)

	)

125 
	#RB_CLKSEL_USB
 (1 << 25)

	)

126 
	#RB_CM_CLKSEL1_CORE_VAL
 
RB_CLKSEL_USB
 | 
RX_CLKSEL_SSI
 | \

127 
RX_CLKSEL_DSS2
 | 
RX_CLKSEL_DSS1
 | \

128 
RB_CLKSEL_L4
 | 
RB_CLKSEL_L3


	)

129 
	#RB_CLKSEL_MPU
 (1 << 0)

	)

130 
	#RB_CM_CLKSEL_MPU_VAL
 
RB_CLKSEL_MPU


	)

131 
	#RB_CLKSEL_DSP
 (1 << 0)

	)

132 
	#RB_CLKSEL_DSP_IF
 (1 << 5)

	)

133 
	#RB_CM_CLKSEL_DSP_VAL
 
RB_CLKSEL_DSP
 | 
RB_CLKSEL_DSP_IF


	)

134 
	#RB_CLKSEL_GFX
 (1 << 0)

	)

135 
	#RB_CM_CLKSEL_GFX_VAL
 
RB_CLKSEL_GFX


	)

136 
	#RB_CLKSEL_MDM
 (1 << 0)

	)

137 
	#RB_CM_CLKSEL_MDM_VAL
 
RB_CLKSEL_MDM


	)

140 
	#RXX_CLKSEL_VLYNQ
 (0x12 << 15)

	)

141 
	#RXX_CLKSEL_SSI
 (0x8 << 20)

	)

144 
	#RIII_CLKSEL_L3
 (4 << 0Ë

	)

145 
	#RIII_CLKSEL_L4
 (2 << 5Ë

	)

146 
	#RIII_CLKSEL_USB
 (4 << 25Ë

	)

147 
	#RIII_CM_CLKSEL1_CORE_VAL
 
RIII_CLKSEL_USB
 | 
RXX_CLKSEL_SSI
 | \

148 
RXX_CLKSEL_VLYNQ
 | 
RX_CLKSEL_DSS2
 | \

149 
RX_CLKSEL_DSS1
 | 
RIII_CLKSEL_L4
 | \

150 
RIII_CLKSEL_L3


	)

151 
	#RIII_CLKSEL_MPU
 (2 << 0Ë

	)

152 
	#RIII_CM_CLKSEL_MPU_VAL
 
RIII_CLKSEL_MPU


	)

153 
	#RIII_CLKSEL_DSP
 (3 << 0Ë

	)

154 
	#RIII_CLKSEL_DSP_IF
 (2 << 5Ë

	)

155 
	#RIII_SYNC_DSP
 (1 << 7Ë

	)

156 
	#RIII_CLKSEL_IVA
 (6 << 8Ë

	)

157 
	#RIII_SYNC_IVA
 (1 << 13Ë

	)

158 
	#RIII_CM_CLKSEL_DSP_VAL
 
RIII_SYNC_IVA
 | 
RIII_CLKSEL_IVA
 | \

159 
RIII_SYNC_DSP
 | 
RIII_CLKSEL_DSP_IF
 | \

160 
RIII_CLKSEL_DSP


	)

161 
	#RIII_CLKSEL_GFX
 (2 << 0Ë

	)

162 
	#RIII_CM_CLKSEL_GFX_VAL
 
RIII_CLKSEL_GFX


	)

165 
	#RII_CLKSEL_L3
 (6 << 0Ë

	)

166 
	#RII_CLKSEL_L4
 (2 << 5Ë

	)

167 
	#RII_CLKSEL_USB
 (2 << 25Ë

	)

168 
	#RII_CM_CLKSEL1_CORE_VAL
 
RII_CLKSEL_USB
 | \

169 
RXX_CLKSEL_SSI
 | 
RXX_CLKSEL_VLYNQ
 | \

170 
RX_CLKSEL_DSS2
 | 
RX_CLKSEL_DSS1
 | \

171 
RII_CLKSEL_L4
 | 
RII_CLKSEL_L3


	)

172 
	#RII_CLKSEL_MPU
 (2 << 0Ë

	)

173 
	#RII_CM_CLKSEL_MPU_VAL
 
RII_CLKSEL_MPU


	)

174 
	#RII_CLKSEL_DSP
 (3 << 0Ë

	)

175 
	#RII_CLKSEL_DSP_IF
 (2 << 5Ë

	)

176 
	#RII_SYNC_DSP
 (0 << 7Ë

	)

177 
	#RII_CLKSEL_IVA
 (6 << 8Ë

	)

178 
	#RII_SYNC_IVA
 (0 << 13Ë

	)

179 
	#RII_CM_CLKSEL_DSP_VAL
 
RII_SYNC_IVA
 | 
RII_CLKSEL_IVA
 | \

180 
RII_SYNC_DSP
 | 
RII_CLKSEL_DSP_IF
 | \

181 
RII_CLKSEL_DSP


	)

182 
	#RII_CLKSEL_GFX
 (2 << 0Ë

	)

183 
	#RII_CM_CLKSEL_GFX_VAL
 
RII_CLKSEL_GFX


	)

186 
	#RVII_CLKSEL_L3
 (1 << 0)

	)

187 
	#RVII_CLKSEL_L4
 (1 << 5)

	)

188 
	#RVII_CLKSEL_DSS1
 (1 << 8)

	)

189 
	#RVII_CLKSEL_DSS2
 (0 << 13)

	)

190 
	#RVII_CLKSEL_VLYNQ
 (1 << 15)

	)

191 
	#RVII_CLKSEL_SSI
 (1 << 20)

	)

192 
	#RVII_CLKSEL_USB
 (1 << 25)

	)

194 
	#RVII_CM_CLKSEL1_CORE_VAL
 
RVII_CLKSEL_USB
 | 
RVII_CLKSEL_SSI
 | \

195 
RVII_CLKSEL_VLYNQ
 | 
RVII_CLKSEL_DSS2
 | \

196 
RVII_CLKSEL_DSS1
 | 
RVII_CLKSEL_L4
 | 
RVII_CLKSEL_L3


	)

198 
	#RVII_CLKSEL_MPU
 (1 << 0Ë

	)

199 
	#RVII_CM_CLKSEL_MPU_VAL
 
RVII_CLKSEL_MPU


	)

201 
	#RVII_CLKSEL_DSP
 (1 << 0)

	)

202 
	#RVII_CLKSEL_DSP_IF
 (1 << 5)

	)

203 
	#RVII_SYNC_DSP
 (0 << 7)

	)

204 
	#RVII_CLKSEL_IVA
 (1 << 8)

	)

205 
	#RVII_SYNC_IVA
 (0 << 13)

	)

206 
	#RVII_CM_CLKSEL_DSP_VAL
 
RVII_SYNC_IVA
 | 
RVII_CLKSEL_IVA
 | 
RVII_SYNC_DSP
 | \

207 
RVII_CLKSEL_DSP_IF
 | 
RVII_CLKSEL_DSP


	)

209 
	#RVII_CLKSEL_GFX
 (1 << 0)

	)

210 
	#RVII_CM_CLKSEL_GFX_VAL
 
RVII_CLKSEL_GFX


	)

219 
	#MX_48M_SRC
 (0 << 3)

	)

220 
	#MX_54M_SRC
 (0 << 5)

	)

221 
	#MX_APLLS_CLIKIN_12
 (3 << 23)

	)

222 
	#MX_APLLS_CLIKIN_13
 (2 << 23)

	)

223 
	#MX_APLLS_CLIKIN_19_2
 (0 << 23)

	)

230 
	#M5A_DPLL_MULT_12
 (133 << 12)

	)

231 
	#M5A_DPLL_DIV_12
 (5 << 8)

	)

232 
	#M5A_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

233 
M5A_DPLL_DIV_12
 | 
M5A_DPLL_MULT_12
 | \

234 
MX_APLLS_CLIKIN_12


	)

235 
	#M5A_DPLL_MULT_13
 (266 << 12)

	)

236 
	#M5A_DPLL_DIV_13
 (12 << 8)

	)

237 
	#M5A_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

238 
M5A_DPLL_DIV_13
 | 
M5A_DPLL_MULT_13
 | \

239 
MX_APLLS_CLIKIN_13


	)

240 
	#M5A_DPLL_MULT_19
 (180 << 12)

	)

241 
	#M5A_DPLL_DIV_19
 (12 << 8)

	)

242 
	#M5A_CM_CLKSEL1_PLL_19_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

243 
M5A_DPLL_DIV_19
 | 
M5A_DPLL_MULT_19
 | \

244 
MX_APLLS_CLIKIN_19_2


	)

246 
	#M5B_DPLL_MULT_12
 (50 << 12)

	)

247 
	#M5B_DPLL_DIV_12
 (2 << 8)

	)

248 
	#M5B_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

249 
M5B_DPLL_DIV_12
 | 
M5B_DPLL_MULT_12
 | \

250 
MX_APLLS_CLIKIN_12


	)

251 
	#M5B_DPLL_MULT_13
 (200 << 12)

	)

252 
	#M5B_DPLL_DIV_13
 (12 << 8)

	)

254 
	#M5B_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

255 
M5B_DPLL_DIV_13
 | 
M5B_DPLL_MULT_13
 | \

256 
MX_APLLS_CLIKIN_13


	)

257 
	#M5B_DPLL_MULT_19
 (125 << 12)

	)

258 
	#M5B_DPLL_DIV_19
 (31 << 8)

	)

259 
	#M5B_CM_CLKSEL1_PLL_19_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

260 
M5B_DPLL_DIV_19
 | 
M5B_DPLL_MULT_19
 | \

261 
MX_APLLS_CLIKIN_19_2


	)

266 
	#M3_DPLL_MULT_12
 (55 << 12)

	)

267 
	#M3_DPLL_DIV_12
 (1 << 8)

	)

268 
	#M3_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

269 
M3_DPLL_DIV_12
 | 
M3_DPLL_MULT_12
 | \

270 
MX_APLLS_CLIKIN_12


	)

271 
	#M3_DPLL_MULT_13
 (330 << 12)

	)

272 
	#M3_DPLL_DIV_13
 (12 << 8)

	)

273 
	#M3_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

274 
M3_DPLL_DIV_13
 | 
M3_DPLL_MULT_13
 | \

275 
MX_APLLS_CLIKIN_13


	)

276 
	#M3_DPLL_MULT_19
 (275 << 12)

	)

277 
	#M3_DPLL_DIV_19
 (15 << 8)

	)

278 
	#M3_CM_CLKSEL1_PLL_19_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

279 
M3_DPLL_DIV_19
 | 
M3_DPLL_MULT_19
 | \

280 
MX_APLLS_CLIKIN_19_2


	)

282 
	#MB_DPLL_MULT
 (1 << 12)

	)

283 
	#MB_DPLL_DIV
 (0 << 8)

	)

284 
	#MB_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | 
MB_DPLL_DIV
 |\

285 
MB_DPLL_MULT
 | 
MX_APLLS_CLIKIN_12


	)

287 
	#MB_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | 
MB_DPLL_DIV
 |\

288 
MB_DPLL_MULT
 | 
MX_APLLS_CLIKIN_13


	)

290 
	#MB_CM_CLKSEL1_PLL_19_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | 
MB_DPLL_DIV
 |\

291 
MB_DPLL_MULT
 | 
MX_APLLS_CLIKIN_19


	)

307 
	#MII_DPLL_MULT_12
 (50 << 12)

	)

308 
	#MII_DPLL_DIV_12
 (1 << 8)

	)

309 
	#MII_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

310 
MII_DPLL_DIV_12
 | 
MII_DPLL_MULT_12
 | \

311 
MX_APLLS_CLIKIN_12


	)

312 
	#MII_DPLL_MULT_13
 (300 << 12)

	)

313 
	#MII_DPLL_DIV_13
 (12 << 8)

	)

314 
	#MII_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

315 
MII_DPLL_DIV_13
 | 
MII_DPLL_MULT_13
 | \

316 
MX_APLLS_CLIKIN_13


	)

319 
	#MIII_DPLL_MULT_12
 (133 << 12)

	)

320 
	#MIII_DPLL_DIV_12
 (5 << 8)

	)

321 
	#MIII_CM_CLKSEL1_PLL_12_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

322 
MIII_DPLL_DIV_12
 | 
MIII_DPLL_MULT_12
 | \

323 
MX_APLLS_CLIKIN_12


	)

324 
	#MIII_DPLL_MULT_13
 (266 << 12)

	)

325 
	#MIII_DPLL_DIV_13
 (12 << 8)

	)

326 
	#MIII_CM_CLKSEL1_PLL_13_VAL
 
MX_48M_SRC
 | 
MX_54M_SRC
 | \

327 
MIII_DPLL_DIV_13
 | 
MIII_DPLL_MULT_13
 | \

328 
MX_APLLS_CLIKIN_13


	)

331 
	#MVII_CM_CLKSEL1_PLL_12_VAL
 
MB_CM_CLKSEL1_PLL_12_VAL


	)

332 
	#MVII_CM_CLKSEL1_PLL_13_VAL
 
MB_CM_CLKSEL1_PLL_13_VAL


	)

335 
	#MX_CLKSEL2_PLL_2x_VAL
 (2 << 0)

	)

336 
	#MX_CLKSEL2_PLL_1x_VAL
 (1 << 0)

	)

355 
	#V24XX_SDRC_RFR_CTRL_133MHz
 (0x0003de00 | 1)

	)

356 
	#V24XX_SDRC_RFR_CTRL_100MHz
 (0x0002da01 | 1)

	)

357 
	#V24XX_SDRC_RFR_CTRL_110MHz
 (0x0002da01 | 1Ë

	)

358 
	#V24XX_SDRC_RFR_CTRL_BYPASS
 (0x00005000 | 1Ë

	)

361 
	#S12M
 12000000

	)

362 
	#S13M
 13000000

	)

363 
	#S19M
 19200000

	)

364 
	#S26M
 26000000

	)

365 
	#S100M
 100000000

	)

366 
	#S133M
 133000000

	)

367 
	#S150M
 150000000

	)

368 
	#S165M
 165000000

	)

369 
	#S200M
 200000000

	)

370 
	#S266M
 266000000

	)

371 
	#S300M
 300000000

	)

372 
	#S330M
 330000000

	)

373 
	#S400M
 400000000

	)

374 
	#S532M
 532000000

	)

375 
	#S600M
 600000000

	)

376 
	#S660M
 660000000

	)

396 
¥cm_c⁄fig
 
	gøã_èbÀ
[] = {

398 {
S12M
, 
S600M
, 
S300M
, 
RII_CM_CLKSEL_MPU_VAL
,

399 
RII_CM_CLKSEL_DSP_VAL
, 
RII_CM_CLKSEL_GFX_VAL
,

400 
RII_CM_CLKSEL1_CORE_VAL
, 
MII_CM_CLKSEL1_PLL_12_VAL
,

401 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_100MHz
,

402 
RATE_IN_242X
},

404 {
S13M
, 
S600M
, 
S300M
, 
RII_CM_CLKSEL_MPU_VAL
,

405 
RII_CM_CLKSEL_DSP_VAL
, 
RII_CM_CLKSEL_GFX_VAL
,

406 
RII_CM_CLKSEL1_CORE_VAL
, 
MII_CM_CLKSEL1_PLL_13_VAL
,

407 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_100MHz
,

408 
RATE_IN_242X
},

411 {
S12M
, 
S532M
, 
S266M
, 
RIII_CM_CLKSEL_MPU_VAL
,

412 
RIII_CM_CLKSEL_DSP_VAL
, 
RIII_CM_CLKSEL_GFX_VAL
,

413 
RIII_CM_CLKSEL1_CORE_VAL
, 
MIII_CM_CLKSEL1_PLL_12_VAL
,

414 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_133MHz
,

415 
RATE_IN_242X
},

417 {
S13M
, 
S532M
, 
S266M
, 
RIII_CM_CLKSEL_MPU_VAL
,

418 
RIII_CM_CLKSEL_DSP_VAL
, 
RIII_CM_CLKSEL_GFX_VAL
,

419 
RIII_CM_CLKSEL1_CORE_VAL
, 
MIII_CM_CLKSEL1_PLL_13_VAL
,

420 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_133MHz
,

421 
RATE_IN_242X
},

424 {
S12M
, 
S300M
, 
S150M
, 
RII_CM_CLKSEL_MPU_VAL
,

425 
RII_CM_CLKSEL_DSP_VAL
, 
RII_CM_CLKSEL_GFX_VAL
,

426 
RII_CM_CLKSEL1_CORE_VAL
, 
MII_CM_CLKSEL1_PLL_12_VAL
,

427 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_100MHz
,

428 
RATE_IN_242X
},

430 {
S13M
, 
S300M
, 
S150M
, 
RII_CM_CLKSEL_MPU_VAL
,

431 
RII_CM_CLKSEL_DSP_VAL
, 
RII_CM_CLKSEL_GFX_VAL
,

432 
RII_CM_CLKSEL1_CORE_VAL
, 
MII_CM_CLKSEL1_PLL_13_VAL
,

433 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_100MHz
,

434 
RATE_IN_242X
},

437 {
S12M
, 
S266M
, 
S133M
, 
RIII_CM_CLKSEL_MPU_VAL
,

438 
RIII_CM_CLKSEL_DSP_VAL
, 
RIII_CM_CLKSEL_GFX_VAL
,

439 
RIII_CM_CLKSEL1_CORE_VAL
, 
MIII_CM_CLKSEL1_PLL_12_VAL
,

440 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_133MHz
,

441 
RATE_IN_242X
},

443 {
S13M
, 
S266M
, 
S133M
, 
RIII_CM_CLKSEL_MPU_VAL
,

444 
RIII_CM_CLKSEL_DSP_VAL
, 
RIII_CM_CLKSEL_GFX_VAL
,

445 
RIII_CM_CLKSEL1_CORE_VAL
, 
MIII_CM_CLKSEL1_PLL_13_VAL
,

446 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_133MHz
,

447 
RATE_IN_242X
},

450 {
S12M
, S12M, S12M, 
RVII_CM_CLKSEL_MPU_VAL
,

451 
RVII_CM_CLKSEL_DSP_VAL
, 
RVII_CM_CLKSEL_GFX_VAL
,

452 
RVII_CM_CLKSEL1_CORE_VAL
, 
MVII_CM_CLKSEL1_PLL_12_VAL
,

453 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_BYPASS
,

454 
RATE_IN_242X
},

457 {
S13M
, S13M, S13M, 
RVII_CM_CLKSEL_MPU_VAL
,

458 
RVII_CM_CLKSEL_DSP_VAL
, 
RVII_CM_CLKSEL_GFX_VAL
,

459 
RVII_CM_CLKSEL1_CORE_VAL
, 
MVII_CM_CLKSEL1_PLL_13_VAL
,

460 
MX_CLKSEL2_PLL_2x_VAL
, 0, 
V24XX_SDRC_RFR_CTRL_BYPASS
,

461 
RATE_IN_242X
},

464 {
S13M
, 
S660M
, 
S330M
, 
R2_CM_CLKSEL_MPU_VAL
,

465 
R2_CM_CLKSEL_DSP_VAL
, 
R2_CM_CLKSEL_GFX_VAL
,

466 
R2_CM_CLKSEL1_CORE_VAL
, 
M3_CM_CLKSEL1_PLL_13_VAL
,

467 
MX_CLKSEL2_PLL_2x_VAL
, 
R2_CM_CLKSEL_MDM_VAL
,

468 
V24XX_SDRC_RFR_CTRL_110MHz
,

469 
RATE_IN_243X
},

472 {
S13M
, 
S532M
, 
S266M
, 
R1_CM_CLKSEL_MPU_VAL
,

473 
R1_CM_CLKSEL_DSP_VAL
, 
R1_CM_CLKSEL_GFX_VAL
,

474 
R1_CM_CLKSEL1_CORE_VAL
, 
M5A_CM_CLKSEL1_PLL_13_VAL
,

475 
MX_CLKSEL2_PLL_2x_VAL
, 
R1_CM_CLKSEL_MDM_VAL
,

476 
V24XX_SDRC_RFR_CTRL_133MHz
,

477 
RATE_IN_243X
},

480 {
S13M
, 
S400M
, 
S200M
, 
R1_CM_CLKSEL_MPU_VAL
,

481 
R1_CM_CLKSEL_DSP_VAL
, 
R1_CM_CLKSEL_GFX_VAL
,

482 
R1_CM_CLKSEL1_CORE_VAL
, 
M5B_CM_CLKSEL1_PLL_13_VAL
,

483 
MX_CLKSEL2_PLL_2x_VAL
, 
R1_CM_CLKSEL_MDM_VAL
,

484 
V24XX_SDRC_RFR_CTRL_100MHz
,

485 
RATE_IN_243X
},

488 {
S13M
, 
S330M
, 
S165M
, 
R2_CM_CLKSEL_MPU_VAL
,

489 
R2_CM_CLKSEL_DSP_VAL
, 
R2_CM_CLKSEL_GFX_VAL
,

490 
R2_CM_CLKSEL1_CORE_VAL
, 
M3_CM_CLKSEL1_PLL_13_VAL
,

491 
MX_CLKSEL2_PLL_1x_VAL
, 
R2_CM_CLKSEL_MDM_VAL
,

492 
V24XX_SDRC_RFR_CTRL_110MHz
,

493 
RATE_IN_243X
},

496 {
S13M
, 
S266M
, 
S133M
, 
R1_CM_CLKSEL_MPU_VAL
,

497 
R1_CM_CLKSEL_DSP_VAL
, 
R1_CM_CLKSEL_GFX_VAL
,

498 
R1_CM_CLKSEL1_CORE_VAL
, 
M5A_CM_CLKSEL1_PLL_13_VAL
,

499 
MX_CLKSEL2_PLL_1x_VAL
, 
R1_CM_CLKSEL_MDM_VAL
,

500 
V24XX_SDRC_RFR_CTRL_133MHz
,

501 
RATE_IN_243X
},

504 {
S13M
, 
S200M
, 
S100M
, 
R1_CM_CLKSEL_MPU_VAL
,

505 
R1_CM_CLKSEL_DSP_VAL
, 
R1_CM_CLKSEL_GFX_VAL
,

506 
R1_CM_CLKSEL1_CORE_VAL
, 
M5B_CM_CLKSEL1_PLL_13_VAL
,

507 
MX_CLKSEL2_PLL_1x_VAL
, 
R1_CM_CLKSEL_MDM_VAL
,

508 
V24XX_SDRC_RFR_CTRL_100MHz
,

509 
RATE_IN_243X
},

512 {
S13M
, S13M, S13M, 
RB_CM_CLKSEL_MPU_VAL
,

513 
RB_CM_CLKSEL_DSP_VAL
, 
RB_CM_CLKSEL_GFX_VAL
,

514 
RB_CM_CLKSEL1_CORE_VAL
, 
MB_CM_CLKSEL1_PLL_13_VAL
,

515 
MX_CLKSEL2_PLL_2x_VAL
, 
RB_CM_CLKSEL_MDM_VAL
,

516 
V24XX_SDRC_RFR_CTRL_BYPASS
,

517 
RATE_IN_243X
},

520 {
S12M
, S12M, S12M, 
RB_CM_CLKSEL_MPU_VAL
,

521 
RB_CM_CLKSEL_DSP_VAL
, 
RB_CM_CLKSEL_GFX_VAL
,

522 
RB_CM_CLKSEL1_CORE_VAL
, 
MB_CM_CLKSEL1_PLL_12_VAL
,

523 
MX_CLKSEL2_PLL_2x_VAL
, 
RB_CM_CLKSEL_MDM_VAL
,

524 
V24XX_SDRC_RFR_CTRL_BYPASS
,

525 
RATE_IN_243X
},

551 
˛k
 
	gfunc_32k_ck
 = {

552 .
«me
 = "func_32k_ck",

553 .
	gøã
 = 32000,

554 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

555 
RATE_FIXED
 | 
ALWAYS_ENABLED
,

559 
˛k
 
	gosc_ck
 = {

560 .
«me
 = "osc_ck",

561 .
	gøã
 = 26000000,

562 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

563 
RATE_FIXED
 | 
RATE_PROPAGATES
,

567 
˛k
 
	gsys_ck
 = {

568 .
«me
 = "sys_ck",

569 .
	g∑ª¡
 = &
osc_ck
,

570 .
	gøã
 = 13000000,

571 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

572 
RATE_FIXED
 | 
ALWAYS_ENABLED
 | 
RATE_PROPAGATES
,

573 .
	gøã_off£t
 = 6,

574 .
	gªˇlc
 = &
om≠2_sys_˛k_ªˇlc
,

577 
˛k
 
	gÆt_ck
 = {

578 .
«me
 = "alt_ck",

579 .
	gøã
 = 54000000,

580 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

581 
RATE_FIXED
 | 
ALWAYS_ENABLED
 | 
RATE_PROPAGATES
,

582 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

590 
˛k
 
	gd∂l_ck
 = {

591 .
«me
 = "dpll_ck",

592 .
	g∑ª¡
 = &
sys_ck
,

593 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

594 
RATE_PROPAGATES
 | 
RATE_CKCTL
 | 
CM_PLL_SEL1
,

595 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

598 
˛k
 
	g≠Œ96_ck
 = {

599 .
«me
 = "apll96_ck",

600 .
	g∑ª¡
 = &
sys_ck
,

601 .
	gøã
 = 96000000,

602 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 |
CLOCK_IN_OMAP243X
 |

603 
RATE_FIXED
 | 
RATE_PROPAGATES
,

604 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

605 .
	gíabÀ_bô
 = 0x2,

606 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

609 
˛k
 
	g≠Œ54_ck
 = {

610 .
«me
 = "apll54_ck",

611 .
	g∑ª¡
 = &
sys_ck
,

612 .
	gøã
 = 54000000,

613 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

614 
RATE_FIXED
 | 
RATE_PROPAGATES
,

615 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

616 .
	gíabÀ_bô
 = 0x6,

617 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

623 
˛k
 
	gfunc_54m_ck
 = {

624 .
«me
 = "func_54m_ck",

625 .
	g∑ª¡
 = &
≠Œ54_ck
,

626 .
	gøã
 = 54000000,

627 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

628 
RATE_FIXED
 | 
CM_PLL_SEL1
 | 
RATE_PROPAGATES
,

629 .
	g§c_off£t
 = 5,

630 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

631 .
	gíabÀ_bô
 = 0xff,

632 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

635 
˛k
 
	gc‹e_ck
 = {

636 .
«me
 = "core_ck",

637 .
	g∑ª¡
 = &
d∂l_ck
,

638 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

639 
ALWAYS_ENABLED
 | 
RATE_PROPAGATES
,

640 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

643 
˛k
 
	g¶ìp_ck
 = {

644 .
«me
 = "sleep_ck",

645 .
	g∑ª¡
 = &
func_32k_ck
,

646 .
	gøã
 = 32000,

647 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

648 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

651 
˛k
 
	gfunc_96m_ck
 = {

652 .
«me
 = "func_96m_ck",

653 .
	g∑ª¡
 = &
≠Œ96_ck
,

654 .
	gøã
 = 96000000,

655 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

656 
RATE_FIXED
 | 
RATE_PROPAGATES
,

657 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

658 .
	gíabÀ_bô
 = 0xff,

659 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

662 
˛k
 
	gfunc_48m_ck
 = {

663 .
«me
 = "func_48m_ck",

664 .
	g∑ª¡
 = &
≠Œ96_ck
,

665 .
	gøã
 = 48000000,

666 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

667 
RATE_FIXED
 | 
CM_PLL_SEL1
 | 
RATE_PROPAGATES
,

668 .
	g§c_off£t
 = 3,

669 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

670 .
	gíabÀ_bô
 = 0xff,

671 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

674 
˛k
 
	gfunc_12m_ck
 = {

675 .
«me
 = "func_12m_ck",

676 .
	g∑ª¡
 = &
func_48m_ck
,

677 .
	gøã
 = 12000000,

678 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

679 
RATE_FIXED
 | 
RATE_PROPAGATES
,

680 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

681 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_CLKEN_PLL
,

682 .
	gíabÀ_bô
 = 0xff,

686 
˛k
 
	gwdt1_osc_ck
 = {

687 .
«me
 = "ck_wdt1_osc",

688 .
	g∑ª¡
 = &
osc_ck
,

689 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

690 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

693 
˛k
 
	gsys_˛kout
 = {

694 .
«me
 = "sys_clkout",

695 .
	g∑ª¡
 = &
func_54m_ck
,

696 .
	gøã
 = 54000000,

697 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

698 
CM_SYSCLKOUT_SEL1
 | 
RATE_CKCTL
,

699 .
	g§c_off£t
 = 0,

700 .
	gíabÀ_ªg
 = (
__iomem
 *)&
PRCM_CLKOUT_CTRL
,

701 .
	gíabÀ_bô
 = 7,

702 .
	gøã_off£t
 = 3,

703 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

707 
˛k
 
	gsys_˛kout2
 = {

708 .
«me
 = "sys_clkout2",

709 .
	g∑ª¡
 = &
func_54m_ck
,

710 .
	gøã
 = 54000000,

711 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

712 
CM_SYSCLKOUT_SEL1
 | 
RATE_CKCTL
,

713 .
	g§c_off£t
 = 8,

714 .
	gíabÀ_ªg
 = (
__iomem
 *)&
PRCM_CLKOUT_CTRL
,

715 .
	gíabÀ_bô
 = 15,

716 .
	gøã_off£t
 = 11,

717 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

720 
˛k
 
	gemul_ck
 = {

721 .
«me
 = "emul_ck",

722 .
	g∑ª¡
 = &
func_54m_ck
,

723 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

724 .
	gíabÀ_ªg
 = (
__iomem
 *)&
PRCM_CLKEMUL_CTRL
,

725 .
	gíabÀ_bô
 = 0,

726 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

740 
˛k
 
	gmpu_ck
 = {

741 .
«me
 = "mpu_ck",

742 .
	g∑ª¡
 = &
c‹e_ck
,

743 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
 |

744 
ALWAYS_ENABLED
 | 
CM_MPU_SEL1
 | 
DELAYED_APP
 |

745 
CONFIG_PARTICIPANT
 | 
RATE_PROPAGATES
,

746 .
	gøã_off£t
 = 0,

747 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

756 
˛k
 
	giva2_1_fck
 = {

757 .
«me
 = "iva2_1_fck",

758 .
	g∑ª¡
 = &
c‹e_ck
,

759 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
 | 
CM_DSP_SEL1
 |

760 
DELAYED_APP
 | 
RATE_PROPAGATES
 |

761 
CONFIG_PARTICIPANT
,

762 .
	gøã_off£t
 = 0,

763 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_DSP
,

764 .
	gíabÀ_bô
 = 0,

765 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

768 
˛k
 
	giva2_1_ick
 = {

769 .
«me
 = "iva2_1_ick",

770 .
	g∑ª¡
 = &
iva2_1_fck
,

771 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
 | 
CM_DSP_SEL1
 |

772 
DELAYED_APP
 | 
CONFIG_PARTICIPANT
,

773 .
	gøã_off£t
 = 5,

774 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

783 
˛k
 
	gd•_fck
 = {

784 .
«me
 = "dsp_fck",

785 .
	g∑ª¡
 = &
c‹e_ck
,

786 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
RATE_CKCTL
 | 
CM_DSP_SEL1
 |

787 
DELAYED_APP
 | 
CONFIG_PARTICIPANT
 | 
RATE_PROPAGATES
,

788 .
	gøã_off£t
 = 0,

789 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_DSP
,

790 .
	gíabÀ_bô
 = 0,

791 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

794 
˛k
 
	gd•_ick
 = {

795 .
«me
 = "dsp_ick",

796 .
	g∑ª¡
 = &
d•_fck
,

797 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
RATE_CKCTL
 | 
CM_DSP_SEL1
 |

798 
DELAYED_APP
 | 
CONFIG_PARTICIPANT
,

799 .
	gøã_off£t
 = 5,

800 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_DSP
,

801 .
	gíabÀ_bô
 = 1,

802 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

805 
˛k
 
	giva1_ifck
 = {

806 .
«me
 = "iva1_ifck",

807 .
	g∑ª¡
 = &
c‹e_ck
,

808 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CM_DSP_SEL1
 | 
RATE_CKCTL
 |

809 
CONFIG_PARTICIPANT
 | 
RATE_PROPAGATES
 | 
DELAYED_APP
,

810 .
	gøã_off£t
= 8,

811 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_DSP
,

812 .
	gíabÀ_bô
 = 10,

813 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

817 
˛k
 
	giva1_mpu_öt_ifck
 = {

818 .
«me
 = "iva1_mpu_int_ifck",

819 .
	g∑ª¡
 = &
iva1_ifck
,

820 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
RATE_CKCTL
 | 
CM_DSP_SEL1
,

821 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_DSP
,

822 .
	gíabÀ_bô
 = 8,

823 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

845 
˛k
 
	gc‹e_l3_ck
 = {

846 .
«me
 = "core_l3_ck",

847 .
	g∑ª¡
 = &
c‹e_ck
,

848 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

849 
RATE_CKCTL
 | 
ALWAYS_ENABLED
 | 
CM_CORE_SEL1
 |

850 
DELAYED_APP
 | 
CONFIG_PARTICIPANT
 |

851 
RATE_PROPAGATES
,

852 .
	gøã_off£t
 = 0,

853 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

856 
˛k
 
	gusb_l4_ick
 = {

857 .
«me
 = "usb_l4_ick",

858 .
	g∑ª¡
 = &
c‹e_l3_ck
,

859 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

860 
RATE_CKCTL
 | 
CM_CORE_SEL1
 | 
DELAYED_APP
 |

861 
CONFIG_PARTICIPANT
,

862 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

863 .
	gíabÀ_bô
 = 0,

864 .
	gøã_off£t
 = 25,

865 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

876 
˛k
 
	gssi_s§_s°_fck
 = {

877 .
«me
 = "ssi_fck",

878 .
	g∑ª¡
 = &
c‹e_ck
,

879 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

880 
RATE_CKCTL
 | 
CM_CORE_SEL1
 | 
DELAYED_APP
,

881 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

882 .
	gíabÀ_bô
 = 1,

883 .
	gøã_off£t
 = 20,

884 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

898 
˛k
 
	ggfx_3d_fck
 = {

899 .
«me
 = "gfx_3d_fck",

900 .
	g∑ª¡
 = &
c‹e_l3_ck
,

901 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

902 
RATE_CKCTL
 | 
CM_GFX_SEL1
,

903 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_GFX
,

904 .
	gíabÀ_bô
 = 2,

905 .
	gøã_off£t
= 0,

906 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

909 
˛k
 
	ggfx_2d_fck
 = {

910 .
«me
 = "gfx_2d_fck",

911 .
	g∑ª¡
 = &
c‹e_l3_ck
,

912 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

913 
RATE_CKCTL
 | 
CM_GFX_SEL1
,

914 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_GFX
,

915 .
	gíabÀ_bô
 = 1,

916 .
	gøã_off£t
= 0,

917 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

920 
˛k
 
	ggfx_ick
 = {

921 .
«me
 = "gfx_ick",

922 .
	g∑ª¡
 = &
c‹e_l3_ck
,

923 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

924 
RATE_CKCTL
,

925 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_GFX
,

926 .
	gíabÀ_bô
 = 0,

927 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

936 
˛k
 
	gmdm_ick
 = {

937 .
«me
 = "mdm_ick",

938 .
	g∑ª¡
 = &
c‹e_ck
,

939 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
 | 
CM_MODEM_SEL1
 |

940 
DELAYED_APP
 | 
CONFIG_PARTICIPANT
,

941 .
	gøã_off£t
 = 0,

942 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_MDM
,

943 .
	gíabÀ_bô
 = 0,

944 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

947 
˛k
 
	gmdm_osc_ck
 = {

948 .
«me
 = "mdm_osc_ck",

949 .
	gøã
 = 26000000,

950 .
	g∑ª¡
 = &
osc_ck
,

951 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
RATE_FIXED
,

952 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_MDM
,

953 .
	gíabÀ_bô
 = 1,

954 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

964 
˛k
 
	gl4_ck
 = {

965 .
«me
 = "l4_ck",

966 .
	g∑ª¡
 = &
c‹e_l3_ck
,

967 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

968 
RATE_CKCTL
 | 
ALWAYS_ENABLED
 | 
CM_CORE_SEL1
 |

969 
DELAYED_APP
 | 
RATE_PROPAGATES
,

970 .
	gøã_off£t
 = 5,

971 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

974 
˛k
 
	gssi_l4_ick
 = {

975 .
«me
 = "ssi_l4_ick",

976 .
	g∑ª¡
 = &
l4_ck
,

977 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
,

978 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

979 .
	gíabÀ_bô
 = 1,

980 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

991 
˛k
 
	gdss_ick
 = {

992 .
«me
 = "dss_ick",

993 .
	g∑ª¡
 = &
l4_ck
,

994 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 | 
RATE_CKCTL
,

995 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

996 .
	gíabÀ_bô
 = 0,

997 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1000 
˛k
 
	gdss1_fck
 = {

1001 .
«me
 = "dss1_fck",

1002 .
	g∑ª¡
 = &
c‹e_ck
,

1003 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1004 
RATE_CKCTL
 | 
CM_CORE_SEL1
 | 
DELAYED_APP
,

1005 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1006 .
	gíabÀ_bô
 = 0,

1007 .
	gøã_off£t
 = 8,

1008 .
	g§c_off£t
 = 8,

1009 .
	gªˇlc
 = &
om≠2_˛k£l_ªˇlc
,

1012 
˛k
 
	gdss2_fck
 = {

1013 .
«me
 = "dss2_fck",

1014 .
	g∑ª¡
 = &
sys_ck
,

1015 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1016 
RATE_CKCTL
 | 
CM_CORE_SEL1
 | 
RATE_FIXED
 |

1017 
DELAYED_APP
,

1018 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1019 .
	gíabÀ_bô
 = 1,

1020 .
	g§c_off£t
 = 13,

1021 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1024 
˛k
 
	gdss_54m_fck
 = {

1025 .
«me
 = "dss_54m_fck",

1026 .
	g∑ª¡
 = &
func_54m_ck
,

1027 .
	gøã
 = 54000000,

1028 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1029 
RATE_FIXED
 | 
RATE_PROPAGATES
,

1030 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1031 .
	gíabÀ_bô
 = 2,

1032 .
	gªˇlc
 = &
om≠2_¥›ag©e_øã
,

1041 
˛k
 
	gg±1_ick
 = {

1042 .
«me
 = "gpt1_ick",

1043 .
	g∑ª¡
 = &
l4_ck
,

1044 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1045 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1046 .
	gíabÀ_bô
 = 0,

1047 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1050 
˛k
 
	gg±1_fck
 = {

1051 .
«me
 = "gpt1_fck",

1052 .
	g∑ª¡
 = &
func_32k_ck
,

1053 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1054 
CM_WKUP_SEL1
,

1055 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_WKUP
,

1056 .
	gíabÀ_bô
 = 0,

1057 .
	g§c_off£t
 = 0,

1058 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1061 
˛k
 
	gg±2_ick
 = {

1062 .
«me
 = "gpt2_ick",

1063 .
	g∑ª¡
 = &
l4_ck
,

1064 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1065 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1066 .
	gíabÀ_bô
 = 4,

1067 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1070 
˛k
 
	gg±2_fck
 = {

1071 .
«me
 = "gpt2_fck",

1072 .
	g∑ª¡
 = &
func_32k_ck
,

1073 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1074 
CM_CORE_SEL2
,

1075 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1076 .
	gíabÀ_bô
 = 4,

1077 .
	g§c_off£t
 = 2,

1078 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1081 
˛k
 
	gg±3_ick
 = {

1082 .
«me
 = "gpt3_ick",

1083 .
	g∑ª¡
 = &
l4_ck
,

1084 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1085 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1086 .
	gíabÀ_bô
 = 5,

1087 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1090 
˛k
 
	gg±3_fck
 = {

1091 .
«me
 = "gpt3_fck",

1092 .
	g∑ª¡
 = &
func_32k_ck
,

1093 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1094 
CM_CORE_SEL2
,

1095 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1096 .
	gíabÀ_bô
 = 5,

1097 .
	g§c_off£t
 = 4,

1098 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1101 
˛k
 
	gg±4_ick
 = {

1102 .
«me
 = "gpt4_ick",

1103 .
	g∑ª¡
 = &
l4_ck
,

1104 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1105 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1106 .
	gíabÀ_bô
 = 6,

1107 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1110 
˛k
 
	gg±4_fck
 = {

1111 .
«me
 = "gpt4_fck",

1112 .
	g∑ª¡
 = &
func_32k_ck
,

1113 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1114 
CM_CORE_SEL2
,

1115 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1116 .
	gíabÀ_bô
 = 6,

1117 .
	g§c_off£t
 = 6,

1118 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1121 
˛k
 
	gg±5_ick
 = {

1122 .
«me
 = "gpt5_ick",

1123 .
	g∑ª¡
 = &
l4_ck
,

1124 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1125 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1126 .
	gíabÀ_bô
 = 7,

1127 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1130 
˛k
 
	gg±5_fck
 = {

1131 .
«me
 = "gpt5_fck",

1132 .
	g∑ª¡
 = &
func_32k_ck
,

1133 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1134 
CM_CORE_SEL2
,

1135 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1136 .
	gíabÀ_bô
 = 7,

1137 .
	g§c_off£t
 = 8,

1138 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1141 
˛k
 
	gg±6_ick
 = {

1142 .
«me
 = "gpt6_ick",

1143 .
	g∑ª¡
 = &
l4_ck
,

1144 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1145 .
	gíabÀ_bô
 = 8,

1146 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1147 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1150 
˛k
 
	gg±6_fck
 = {

1151 .
«me
 = "gpt6_fck",

1152 .
	g∑ª¡
 = &
func_32k_ck
,

1153 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1154 
CM_CORE_SEL2
,

1155 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1156 .
	gíabÀ_bô
 = 8,

1157 .
	g§c_off£t
 = 10,

1158 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1161 
˛k
 
	gg±7_ick
 = {

1162 .
«me
 = "gpt7_ick",

1163 .
	g∑ª¡
 = &
l4_ck
,

1164 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1165 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1166 .
	gíabÀ_bô
 = 9,

1167 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1170 
˛k
 
	gg±7_fck
 = {

1171 .
«me
 = "gpt7_fck",

1172 .
	g∑ª¡
 = &
func_32k_ck
,

1173 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1174 
CM_CORE_SEL2
,

1175 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1176 .
	gíabÀ_bô
 = 9,

1177 .
	g§c_off£t
 = 12,

1178 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1181 
˛k
 
	gg±8_ick
 = {

1182 .
«me
 = "gpt8_ick",

1183 .
	g∑ª¡
 = &
l4_ck
,

1184 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1185 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1186 .
	gíabÀ_bô
 = 10,

1187 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1190 
˛k
 
	gg±8_fck
 = {

1191 .
«me
 = "gpt8_fck",

1192 .
	g∑ª¡
 = &
func_32k_ck
,

1193 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1194 
CM_CORE_SEL2
,

1195 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1196 .
	gíabÀ_bô
 = 10,

1197 .
	g§c_off£t
 = 14,

1198 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1201 
˛k
 
	gg±9_ick
 = {

1202 .
«me
 = "gpt9_ick",

1203 .
	g∑ª¡
 = &
l4_ck
,

1204 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1205 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1206 .
	gíabÀ_bô
 = 11,

1207 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1210 
˛k
 
	gg±9_fck
 = {

1211 .
«me
 = "gpt9_fck",

1212 .
	g∑ª¡
 = &
func_32k_ck
,

1213 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1214 
CM_CORE_SEL2
,

1215 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1216 .
	gíabÀ_bô
 = 11,

1217 .
	g§c_off£t
 = 16,

1218 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1221 
˛k
 
	gg±10_ick
 = {

1222 .
«me
 = "gpt10_ick",

1223 .
	g∑ª¡
 = &
l4_ck
,

1224 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1225 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1226 .
	gíabÀ_bô
 = 12,

1227 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1230 
˛k
 
	gg±10_fck
 = {

1231 .
«me
 = "gpt10_fck",

1232 .
	g∑ª¡
 = &
func_32k_ck
,

1233 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1234 
CM_CORE_SEL2
,

1235 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1236 .
	gíabÀ_bô
 = 12,

1237 .
	g§c_off£t
 = 18,

1238 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1241 
˛k
 
	gg±11_ick
 = {

1242 .
«me
 = "gpt11_ick",

1243 .
	g∑ª¡
 = &
l4_ck
,

1244 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1245 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1246 .
	gíabÀ_bô
 = 13,

1247 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1250 
˛k
 
	gg±11_fck
 = {

1251 .
«me
 = "gpt11_fck",

1252 .
	g∑ª¡
 = &
func_32k_ck
,

1253 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1254 
CM_CORE_SEL2
,

1255 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1256 .
	gíabÀ_bô
 = 13,

1257 .
	g§c_off£t
 = 20,

1258 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1261 
˛k
 
	gg±12_ick
 = {

1262 .
«me
 = "gpt12_ick",

1263 .
	g∑ª¡
 = &
l4_ck
,

1264 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1265 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1266 .
	gíabÀ_bô
 = 14,

1267 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1270 
˛k
 
	gg±12_fck
 = {

1271 .
«me
 = "gpt12_fck",

1272 .
	g∑ª¡
 = &
func_32k_ck
,

1273 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1274 
CM_CORE_SEL2
,

1275 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1276 .
	gíabÀ_bô
 = 14,

1277 .
	g§c_off£t
 = 22,

1278 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1281 
˛k
 
	gmcb•1_ick
 = {

1282 .
«me
 = "mcbsp1_ick",

1283 .
	g∑ª¡
 = &
l4_ck
,

1284 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1285 .
	gíabÀ_bô
 = 15,

1286 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1287 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1290 
˛k
 
	gmcb•1_fck
 = {

1291 .
«me
 = "mcbsp1_fck",

1292 .
	g∑ª¡
 = &
func_96m_ck
,

1293 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1294 .
	gíabÀ_bô
 = 15,

1295 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1296 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1299 
˛k
 
	gmcb•2_ick
 = {

1300 .
«me
 = "mcbsp2_ick",

1301 .
	g∑ª¡
 = &
l4_ck
,

1302 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1303 .
	gíabÀ_bô
 = 16,

1304 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1305 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1308 
˛k
 
	gmcb•2_fck
 = {

1309 .
«me
 = "mcbsp2_fck",

1310 .
	g∑ª¡
 = &
func_96m_ck
,

1311 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1312 .
	gíabÀ_bô
 = 16,

1313 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1314 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1317 
˛k
 
	gmcb•3_ick
 = {

1318 .
«me
 = "mcbsp3_ick",

1319 .
	g∑ª¡
 = &
l4_ck
,

1320 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1321 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1322 .
	gíabÀ_bô
 = 3,

1323 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1326 
˛k
 
	gmcb•3_fck
 = {

1327 .
«me
 = "mcbsp3_fck",

1328 .
	g∑ª¡
 = &
func_96m_ck
,

1329 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1330 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1331 .
	gíabÀ_bô
 = 3,

1332 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1335 
˛k
 
	gmcb•4_ick
 = {

1336 .
«me
 = "mcbsp4_ick",

1337 .
	g∑ª¡
 = &
l4_ck
,

1338 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1339 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1340 .
	gíabÀ_bô
 = 4,

1341 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1344 
˛k
 
	gmcb•4_fck
 = {

1345 .
«me
 = "mcbsp4_fck",

1346 .
	g∑ª¡
 = &
func_96m_ck
,

1347 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1348 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1349 .
	gíabÀ_bô
 = 4,

1350 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1353 
˛k
 
	gmcb•5_ick
 = {

1354 .
«me
 = "mcbsp5_ick",

1355 .
	g∑ª¡
 = &
l4_ck
,

1356 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1357 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1358 .
	gíabÀ_bô
 = 5,

1359 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1362 
˛k
 
	gmcb•5_fck
 = {

1363 .
«me
 = "mcbsp5_fck",

1364 .
	g∑ª¡
 = &
func_96m_ck
,

1365 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1366 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1367 .
	gíabÀ_bô
 = 5,

1368 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1371 
˛k
 
	gmc•i1_ick
 = {

1372 .
«me
 = "mcspi_ick",

1373 .
	gid
 = 1,

1374 .
	g∑ª¡
 = &
l4_ck
,

1375 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1376 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1377 .
	gíabÀ_bô
 = 17,

1378 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1381 
˛k
 
	gmc•i1_fck
 = {

1382 .
«me
 = "mcspi_fck",

1383 .
	gid
 = 1,

1384 .
	g∑ª¡
 = &
func_48m_ck
,

1385 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1386 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1387 .
	gíabÀ_bô
 = 17,

1388 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1391 
˛k
 
	gmc•i2_ick
 = {

1392 .
«me
 = "mcspi_ick",

1393 .
	gid
 = 2,

1394 .
	g∑ª¡
 = &
l4_ck
,

1395 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1396 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1397 .
	gíabÀ_bô
 = 18,

1398 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1401 
˛k
 
	gmc•i2_fck
 = {

1402 .
«me
 = "mcspi_fck",

1403 .
	gid
 = 2,

1404 .
	g∑ª¡
 = &
func_48m_ck
,

1405 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1406 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1407 .
	gíabÀ_bô
 = 18,

1408 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1411 
˛k
 
	gmc•i3_ick
 = {

1412 .
«me
 = "mcspi_ick",

1413 .
	gid
 = 3,

1414 .
	g∑ª¡
 = &
l4_ck
,

1415 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1416 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1417 .
	gíabÀ_bô
 = 9,

1418 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1421 
˛k
 
	gmc•i3_fck
 = {

1422 .
«me
 = "mcspi_fck",

1423 .
	gid
 = 3,

1424 .
	g∑ª¡
 = &
func_48m_ck
,

1425 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1426 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1427 .
	gíabÀ_bô
 = 9,

1428 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1431 
˛k
 
	gu¨t1_ick
 = {

1432 .
«me
 = "uart1_ick",

1433 .
	g∑ª¡
 = &
l4_ck
,

1434 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1435 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1436 .
	gíabÀ_bô
 = 21,

1437 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1440 
˛k
 
	gu¨t1_fck
 = {

1441 .
«me
 = "uart1_fck",

1442 .
	g∑ª¡
 = &
func_48m_ck
,

1443 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1444 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1445 .
	gíabÀ_bô
 = 21,

1446 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1449 
˛k
 
	gu¨t2_ick
 = {

1450 .
«me
 = "uart2_ick",

1451 .
	g∑ª¡
 = &
l4_ck
,

1452 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1453 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1454 .
	gíabÀ_bô
 = 22,

1455 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1458 
˛k
 
	gu¨t2_fck
 = {

1459 .
«me
 = "uart2_fck",

1460 .
	g∑ª¡
 = &
func_48m_ck
,

1461 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1462 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1463 .
	gíabÀ_bô
 = 22,

1464 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1467 
˛k
 
	gu¨t3_ick
 = {

1468 .
«me
 = "uart3_ick",

1469 .
	g∑ª¡
 = &
l4_ck
,

1470 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1471 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1472 .
	gíabÀ_bô
 = 2,

1473 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1476 
˛k
 
	gu¨t3_fck
 = {

1477 .
«me
 = "uart3_fck",

1478 .
	g∑ª¡
 = &
func_48m_ck
,

1479 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1480 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1481 .
	gíabÀ_bô
 = 2,

1482 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1485 
˛k
 
	ggpios_ick
 = {

1486 .
«me
 = "gpios_ick",

1487 .
	g∑ª¡
 = &
l4_ck
,

1488 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1489 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1490 .
	gíabÀ_bô
 = 2,

1491 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1494 
˛k
 
	ggpios_fck
 = {

1495 .
«me
 = "gpios_fck",

1496 .
	g∑ª¡
 = &
func_32k_ck
,

1497 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1498 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_WKUP
,

1499 .
	gíabÀ_bô
 = 2,

1500 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1503 
˛k
 
	gmpu_wdt_ick
 = {

1504 .
«me
 = "mpu_wdt_ick",

1505 .
	g∑ª¡
 = &
l4_ck
,

1506 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1507 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1508 .
	gíabÀ_bô
 = 3,

1509 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1512 
˛k
 
	gmpu_wdt_fck
 = {

1513 .
«me
 = "mpu_wdt_fck",

1514 .
	g∑ª¡
 = &
func_32k_ck
,

1515 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1516 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN_WKUP
,

1517 .
	gíabÀ_bô
 = 3,

1518 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1521 
˛k
 
	gsync_32k_ick
 = {

1522 .
«me
 = "sync_32k_ick",

1523 .
	g∑ª¡
 = &
l4_ck
,

1524 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1525 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1526 .
	gíabÀ_bô
 = 1,

1527 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1529 
˛k
 
	gwdt1_ick
 = {

1530 .
«me
 = "wdt1_ick",

1531 .
	g∑ª¡
 = &
l4_ck
,

1532 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1533 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1534 .
	gíabÀ_bô
 = 4,

1535 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1537 
˛k
 
	gom≠˘æ_ick
 = {

1538 .
«me
 = "omapctrl_ick",

1539 .
	g∑ª¡
 = &
l4_ck
,

1540 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1541 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1542 .
	gíabÀ_bô
 = 5,

1543 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1545 
˛k
 
	gi¸_ick
 = {

1546 .
«me
 = "icr_ick",

1547 .
	g∑ª¡
 = &
l4_ck
,

1548 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1549 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN_WKUP
,

1550 .
	gíabÀ_bô
 = 6,

1551 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1554 
˛k
 
	gˇm_ick
 = {

1555 .
«me
 = "cam_ick",

1556 .
	g∑ª¡
 = &
l4_ck
,

1557 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1558 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1559 .
	gíabÀ_bô
 = 31,

1560 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1563 
˛k
 
	gˇm_fck
 = {

1564 .
«me
 = "cam_fck",

1565 .
	g∑ª¡
 = &
func_96m_ck
,

1566 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1567 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1568 .
	gíabÀ_bô
 = 31,

1569 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1572 
˛k
 
	gmaûboxes_ick
 = {

1573 .
«me
 = "mailboxes_ick",

1574 .
	g∑ª¡
 = &
l4_ck
,

1575 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1576 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1577 .
	gíabÀ_bô
 = 30,

1578 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1581 
˛k
 
	gwdt4_ick
 = {

1582 .
«me
 = "wdt4_ick",

1583 .
	g∑ª¡
 = &
l4_ck
,

1584 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1585 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1586 .
	gíabÀ_bô
 = 29,

1587 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1590 
˛k
 
	gwdt4_fck
 = {

1591 .
«me
 = "wdt4_fck",

1592 .
	g∑ª¡
 = &
func_32k_ck
,

1593 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1594 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1595 .
	gíabÀ_bô
 = 29,

1596 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1599 
˛k
 
	gwdt3_ick
 = {

1600 .
«me
 = "wdt3_ick",

1601 .
	g∑ª¡
 = &
l4_ck
,

1602 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1603 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1604 .
	gíabÀ_bô
 = 28,

1605 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1608 
˛k
 
	gwdt3_fck
 = {

1609 .
«me
 = "wdt3_fck",

1610 .
	g∑ª¡
 = &
func_32k_ck
,

1611 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1612 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1613 .
	gíabÀ_bô
 = 28,

1614 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1617 
˛k
 
	gm•ro_ick
 = {

1618 .
«me
 = "mspro_ick",

1619 .
	g∑ª¡
 = &
l4_ck
,

1620 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1621 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1622 .
	gíabÀ_bô
 = 27,

1623 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1626 
˛k
 
	gm•ro_fck
 = {

1627 .
«me
 = "mspro_fck",

1628 .
	g∑ª¡
 = &
func_96m_ck
,

1629 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1630 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1631 .
	gíabÀ_bô
 = 27,

1632 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1635 
˛k
 
	gmmc_ick
 = {

1636 .
«me
 = "mmc_ick",

1637 .
	g∑ª¡
 = &
l4_ck
,

1638 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1639 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1640 .
	gíabÀ_bô
 = 26,

1641 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1644 
˛k
 
	gmmc_fck
 = {

1645 .
«me
 = "mmc_fck",

1646 .
	g∑ª¡
 = &
func_96m_ck
,

1647 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1648 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1649 .
	gíabÀ_bô
 = 26,

1650 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1653 
˛k
 
	gÁc_ick
 = {

1654 .
«me
 = "fac_ick",

1655 .
	g∑ª¡
 = &
l4_ck
,

1656 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1657 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1658 .
	gíabÀ_bô
 = 25,

1659 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1662 
˛k
 
	gÁc_fck
 = {

1663 .
«me
 = "fac_fck",

1664 .
	g∑ª¡
 = &
func_12m_ck
,

1665 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1666 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1667 .
	gíabÀ_bô
 = 25,

1668 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1671 
˛k
 
	góc_ick
 = {

1672 .
«me
 = "eac_ick",

1673 .
	g∑ª¡
 = &
l4_ck
,

1674 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1675 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1676 .
	gíabÀ_bô
 = 24,

1677 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1680 
˛k
 
	góc_fck
 = {

1681 .
«me
 = "eac_fck",

1682 .
	g∑ª¡
 = &
func_96m_ck
,

1683 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1684 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1685 .
	gíabÀ_bô
 = 24,

1686 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1689 
˛k
 
	ghdq_ick
 = {

1690 .
«me
 = "hdq_ick",

1691 .
	g∑ª¡
 = &
l4_ck
,

1692 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1693 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1694 .
	gíabÀ_bô
 = 23,

1695 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1698 
˛k
 
	ghdq_fck
 = {

1699 .
«me
 = "hdq_fck",

1700 .
	g∑ª¡
 = &
func_12m_ck
,

1701 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1702 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1703 .
	gíabÀ_bô
 = 23,

1704 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1707 
˛k
 
	gi2c2_ick
 = {

1708 .
«me
 = "i2c_ick",

1709 .
	gid
 = 2,

1710 .
	g∑ª¡
 = &
l4_ck
,

1711 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1712 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1713 .
	gíabÀ_bô
 = 20,

1714 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1717 
˛k
 
	gi2c2_fck
 = {

1718 .
«me
 = "i2c_fck",

1719 .
	gid
 = 2,

1720 .
	g∑ª¡
 = &
func_12m_ck
,

1721 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1722 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1723 .
	gíabÀ_bô
 = 20,

1724 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1727 
˛k
 
	gi2chs2_fck
 = {

1728 .
«me
 = "i2chs2_fck",

1729 .
	g∑ª¡
 = &
func_96m_ck
,

1730 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1731 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1732 .
	gíabÀ_bô
 = 20,

1733 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1736 
˛k
 
	gi2c1_ick
 = {

1737 .
«me
 = "i2c_ick",

1738 .
	gid
 = 1,

1739 .
	g∑ª¡
 = &
l4_ck
,

1740 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1741 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1742 .
	gíabÀ_bô
 = 19,

1743 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1746 
˛k
 
	gi2c1_fck
 = {

1747 .
«me
 = "i2c_fck",

1748 .
	gid
 = 1,

1749 .
	g∑ª¡
 = &
func_12m_ck
,

1750 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
,

1751 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1752 .
	gíabÀ_bô
 = 19,

1753 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1756 
˛k
 
	gi2chs1_fck
 = {

1757 .
«me
 = "i2chs1_fck",

1758 .
	g∑ª¡
 = &
func_96m_ck
,

1759 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1760 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1761 .
	gíabÀ_bô
 = 19,

1762 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1765 
˛k
 
	gvlynq_ick
 = {

1766 .
«me
 = "vlynq_ick",

1767 .
	g∑ª¡
 = &
c‹e_l3_ck
,

1768 .
	gÊags
 = 
CLOCK_IN_OMAP242X
,

1769 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN1_CORE
,

1770 .
	gíabÀ_bô
 = 3,

1771 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1774 
˛k
 
	gvlynq_fck
 = {

1775 .
«me
 = "vlynq_fck",

1776 .
	g∑ª¡
 = &
func_96m_ck
,

1777 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
RATE_CKCTL
 | 
CM_CORE_SEL1
 | 
DELAYED_APP
,

1778 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN1_CORE
,

1779 .
	gíabÀ_bô
 = 3,

1780 .
	g§c_off£t
 = 15,

1781 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1784 
˛k
 
	gsdrc_ick
 = {

1785 .
«me
 = "sdrc_ick",

1786 .
	g∑ª¡
 = &
l4_ck
,

1787 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1788 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN3_CORE
,

1789 .
	gíabÀ_bô
 = 2,

1790 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1793 
˛k
 
	gdes_ick
 = {

1794 .
«me
 = "des_ick",

1795 .
	g∑ª¡
 = &
l4_ck
,

1796 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1797 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN4_CORE
,

1798 .
	gíabÀ_bô
 = 0,

1799 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1802 
˛k
 
	gsha_ick
 = {

1803 .
«me
 = "sha_ick",

1804 .
	g∑ª¡
 = &
l4_ck
,

1805 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1806 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN4_CORE
,

1807 .
	gíabÀ_bô
 = 1,

1808 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1811 
˛k
 
	g∫g_ick
 = {

1812 .
«me
 = "rng_ick",

1813 .
	g∑ª¡
 = &
l4_ck
,

1814 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1815 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN4_CORE
,

1816 .
	gíabÀ_bô
 = 2,

1817 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1820 
˛k
 
	g´s_ick
 = {

1821 .
«me
 = "aes_ick",

1822 .
	g∑ª¡
 = &
l4_ck
,

1823 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1824 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN4_CORE
,

1825 .
	gíabÀ_bô
 = 3,

1826 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1829 
˛k
 
	gpka_ick
 = {

1830 .
«me
 = "pka_ick",

1831 .
	g∑ª¡
 = &
l4_ck
,

1832 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1833 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN4_CORE
,

1834 .
	gíabÀ_bô
 = 4,

1835 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1838 
˛k
 
	gusb_fck
 = {

1839 .
«me
 = "usb_fck",

1840 .
	g∑ª¡
 = &
func_48m_ck
,

1841 .
	gÊags
 = 
CLOCK_IN_OMAP243X
 | 
CLOCK_IN_OMAP242X
,

1842 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1843 .
	gíabÀ_bô
 = 0,

1844 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1847 
˛k
 
	gusbhs_ick
 = {

1848 .
«me
 = "usbhs_ick",

1849 .
	g∑ª¡
 = &
c‹e_l3_ck
,

1850 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1851 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1852 .
	gíabÀ_bô
 = 6,

1853 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1856 
˛k
 
	gmmchs1_ick
 = {

1857 .
«me
 = "mmchs1_ick",

1858 .
	g∑ª¡
 = &
l4_ck
,

1859 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1860 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1861 .
	gíabÀ_bô
 = 7,

1862 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1865 
˛k
 
	gmmchs1_fck
 = {

1866 .
«me
 = "mmchs1_fck",

1867 .
	g∑ª¡
 = &
func_96m_ck
,

1868 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1869 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1870 .
	gíabÀ_bô
 = 7,

1871 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1874 
˛k
 
	gmmchs2_ick
 = {

1875 .
«me
 = "mmchs2_ick",

1876 .
	g∑ª¡
 = &
l4_ck
,

1877 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1878 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1879 .
	gíabÀ_bô
 = 8,

1880 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1883 
˛k
 
	gmmchs2_fck
 = {

1884 .
«me
 = "mmchs2_fck",

1885 .
	g∑ª¡
 = &
func_96m_ck
,

1886 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1887 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1888 .
	gíabÀ_bô
 = 8,

1889 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1892 
˛k
 
	ggpio5_ick
 = {

1893 .
«me
 = "gpio5_ick",

1894 .
	g∑ª¡
 = &
l4_ck
,

1895 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1896 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1897 .
	gíabÀ_bô
 = 10,

1898 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1901 
˛k
 
	ggpio5_fck
 = {

1902 .
«me
 = "gpio5_fck",

1903 .
	g∑ª¡
 = &
func_32k_ck
,

1904 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1905 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1906 .
	gíabÀ_bô
 = 10,

1907 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1910 
˛k
 
	gmdm_ötc_ick
 = {

1911 .
«me
 = "mdm_intc_ick",

1912 .
	g∑ª¡
 = &
l4_ck
,

1913 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1914 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_ICLKEN2_CORE
,

1915 .
	gíabÀ_bô
 = 11,

1916 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1919 
˛k
 
	gmmchsdb1_fck
 = {

1920 .
«me
 = "mmchsdb1_fck",

1921 .
	g∑ª¡
 = &
func_32k_ck
,

1922 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1923 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1924 .
	gíabÀ_bô
 = 16,

1925 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1928 
˛k
 
	gmmchsdb2_fck
 = {

1929 .
«me
 = "mmchsdb2_fck",

1930 .
	g∑ª¡
 = &
func_32k_ck
,

1931 .
	gÊags
 = 
CLOCK_IN_OMAP243X
,

1932 .
	gíabÀ_ªg
 = (
__iomem
 *)&
CM_FCLKEN2_CORE
,

1933 .
	gíabÀ_bô
 = 17,

1934 .
	gªˇlc
 = &
om≠2_fﬁlow∑ª¡_ªˇlc
,

1951 
˛k
 
	gvút_¥cm_£t
 = {

1952 .
«me
 = "virt_prcm_set",

1953 .
	gÊags
 = 
CLOCK_IN_OMAP242X
 | 
CLOCK_IN_OMAP243X
 |

1954 
VIRTUAL_CLOCK
 | 
ALWAYS_ENABLED
 | 
DELAYED_APP
,

1955 .
	g∑ª¡
 = &
mpu_ck
,

1956 .
	gªˇlc
 = &
om≠2_mpu_ªˇlc
,

1957 .
	g£t_øã
 = &
om≠2_£À˘_èbÀ_øã
,

1958 .
	ground_øã
 = &
om≠2_round_to_èbÀ_øã
,

1961 
˛k
 *
	g⁄chù_˛ks
[] = {

1963 &
func_32k_ck
,

1964 &
osc_ck
,

1965 &
sys_ck
,

1966 &
Æt_ck
,

1968 &
d∂l_ck
,

1969 &
≠Œ96_ck
,

1970 &
≠Œ54_ck
,

1972 &
func_54m_ck
,

1973 &
c‹e_ck
,

1974 &
¶ìp_ck
,

1975 &
func_96m_ck
,

1976 &
func_48m_ck
,

1977 &
func_12m_ck
,

1978 &
wdt1_osc_ck
,

1979 &
sys_˛kout
,

1980 &
sys_˛kout2
,

1981 &
emul_ck
,

1983 &
mpu_ck
,

1985 &
iva2_1_fck
,

1986 &
iva2_1_ick
,

1987 &
d•_ick
,

1988 &
d•_fck
,

1989 &
iva1_ifck
,

1990 &
iva1_mpu_öt_ifck
,

1992 &
gfx_3d_fck
,

1993 &
gfx_2d_fck
,

1994 &
gfx_ick
,

1996 &
mdm_ick
,

1997 &
mdm_osc_ck
,

1999 &
dss_ick
,

2000 &
dss1_fck
,

2001 &
dss2_fck
,

2002 &
dss_54m_fck
,

2004 &
c‹e_l3_ck
,

2005 &
ssi_s§_s°_fck
,

2006 &
usb_l4_ick
,

2008 &
l4_ck
,

2009 &
ssi_l4_ick
,

2011 &
vút_¥cm_£t
,

2013 &
g±1_ick
,

2014 &
g±1_fck
,

2015 &
g±2_ick
,

2016 &
g±2_fck
,

2017 &
g±3_ick
,

2018 &
g±3_fck
,

2019 &
g±4_ick
,

2020 &
g±4_fck
,

2021 &
g±5_ick
,

2022 &
g±5_fck
,

2023 &
g±6_ick
,

2024 &
g±6_fck
,

2025 &
g±7_ick
,

2026 &
g±7_fck
,

2027 &
g±8_ick
,

2028 &
g±8_fck
,

2029 &
g±9_ick
,

2030 &
g±9_fck
,

2031 &
g±10_ick
,

2032 &
g±10_fck
,

2033 &
g±11_ick
,

2034 &
g±11_fck
,

2035 &
g±12_ick
,

2036 &
g±12_fck
,

2037 &
mcb•1_ick
,

2038 &
mcb•1_fck
,

2039 &
mcb•2_ick
,

2040 &
mcb•2_fck
,

2041 &
mcb•3_ick
,

2042 &
mcb•3_fck
,

2043 &
mcb•4_ick
,

2044 &
mcb•4_fck
,

2045 &
mcb•5_ick
,

2046 &
mcb•5_fck
,

2047 &
mc•i1_ick
,

2048 &
mc•i1_fck
,

2049 &
mc•i2_ick
,

2050 &
mc•i2_fck
,

2051 &
mc•i3_ick
,

2052 &
mc•i3_fck
,

2053 &
u¨t1_ick
,

2054 &
u¨t1_fck
,

2055 &
u¨t2_ick
,

2056 &
u¨t2_fck
,

2057 &
u¨t3_ick
,

2058 &
u¨t3_fck
,

2059 &
gpios_ick
,

2060 &
gpios_fck
,

2061 &
mpu_wdt_ick
,

2062 &
mpu_wdt_fck
,

2063 &
sync_32k_ick
,

2064 &
wdt1_ick
,

2065 &
om≠˘æ_ick
,

2066 &
i¸_ick
,

2067 &
ˇm_fck
,

2068 &
ˇm_ick
,

2069 &
maûboxes_ick
,

2070 &
wdt4_ick
,

2071 &
wdt4_fck
,

2072 &
wdt3_ick
,

2073 &
wdt3_fck
,

2074 &
m•ro_ick
,

2075 &
m•ro_fck
,

2076 &
mmc_ick
,

2077 &
mmc_fck
,

2078 &
Ác_ick
,

2079 &
Ác_fck
,

2080 &
óc_ick
,

2081 &
óc_fck
,

2082 &
hdq_ick
,

2083 &
hdq_fck
,

2084 &
i2c1_ick
,

2085 &
i2c1_fck
,

2086 &
i2chs1_fck
,

2087 &
i2c2_ick
,

2088 &
i2c2_fck
,

2089 &
i2chs2_fck
,

2090 &
vlynq_ick
,

2091 &
vlynq_fck
,

2092 &
sdrc_ick
,

2093 &
des_ick
,

2094 &
sha_ick
,

2095 &
∫g_ick
,

2096 &
´s_ick
,

2097 &
pka_ick
,

2098 &
usb_fck
,

2099 &
usbhs_ick
,

2100 &
mmchs1_ick
,

2101 &
mmchs1_fck
,

2102 &
mmchs2_ick
,

2103 &
mmchs2_fck
,

2104 &
gpio5_ick
,

2105 &
gpio5_fck
,

2106 &
mdm_ötc_ick
,

2107 &
mmchsdb1_fck
,

2108 &
mmchsdb2_fck
,

	@arch/arm/mach-omap2/devices.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/io.h
>

19 
	~<asm/mach-ty≥s.h
>

20 
	~<asm/mach/m≠.h
>

22 
	~<asm/¨ch/tc.h
>

23 
	~<asm/¨ch/bﬂrd.h
>

24 
	~<asm/¨ch/mux.h
>

25 
	~<asm/¨ch/gpio.h
>

27 #if 
deföed
(
CONFIG_I2C_OMAP
Ë|| deföed(
CONFIG_I2C_OMAP_MODULE
)

29 
	#OMAP2_I2C_BASE2
 0x48072000

	)

30 
	#OMAP2_I2C_INT2
 57

	)

32 
ªsour˚
 
	gi2c_ªsour˚s2
[] = {

34 .
°¨t
 = 
OMAP2_I2C_BASE2
,

35 .
	gíd
 = 
OMAP2_I2C_BASE2
 + 0x3f,

36 .
	gÊags
 = 
IORESOURCE_MEM
,

39 .
	g°¨t
 = 
OMAP2_I2C_INT2
,

40 .
	gÊags
 = 
IORESOURCE_IRQ
,

44 
∂©f‹m_devi˚
 
	gom≠_i2c_devi˚2
 = {

45 .
«me
 = "i2c_omap",

46 .
	gid
 = 2,

47 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
i2c_ªsour˚s2
),

48 .
	gªsour˚
 = 
i2c_ªsour˚s2
,

52 
	$om≠_öô_i2c
()

55 i‡(
	`machöe_is_om≠_h4
())

58 
	`om≠_cfg_ªg
(
J15_24XX_I2C2_SCL
);

59 
	`om≠_cfg_ªg
(
H19_24XX_I2C2_SDA
);

60 (Ë
	`∂©f‹m_devi˚_ªgi°î
(&
om≠_i2c_devi˚2
);

61 
	}
}

65 
	$om≠_öô_i2c
(Ë{
	}
}

69 #i‡
deföed
(
CONFIG_OMAP_DSP
Ë|| deföed(
CONFIG_OMAP_DSP_MODULE
)

70 
	#OMAP2_MBOX_BASE
 
	`IO_ADDRESS
(
OMAP24XX_MAILBOX_BASE
)

	)

72 
ªsour˚
 
	gmbox_ªsour˚s
[] = {

74 .
°¨t
 = 
OMAP2_MBOX_BASE
,

75 .
	gíd
 = 
OMAP2_MBOX_BASE
 + 0x11f,

76 .
	gÊags
 = 
IORESOURCE_MEM
,

79 .
	g°¨t
 = 
INT_24XX_MAIL_U0_MPU
,

80 .
	gÊags
 = 
IORESOURCE_IRQ
,

83 .
	g°¨t
 = 
INT_24XX_MAIL_U3_MPU
,

84 .
	gÊags
 = 
IORESOURCE_IRQ
,

88 
∂©f‹m_devi˚
 
	gmbox_devi˚
 = {

89 .
«me
 = "mailbox",

90 .
	gid
 = -1,

91 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
mbox_ªsour˚s
),

92 .
	gªsour˚
 = 
mbox_ªsour˚s
,

95 
ölöe
 
	$om≠_öô_mbox
()

97 
	`∂©f‹m_devi˚_ªgi°î
(&
mbox_devi˚
);

98 
	}
}

100 
ölöe
 
	$om≠_öô_mbox
(Ë{ 
	}
}

103 #i‡
deföed
(
CONFIG_OMAP_STI
)

105 
	#OMAP2_STI_BASE
 
	`IO_ADDRESS
(0x48068000)

	)

106 
	#OMAP2_STI_CHANNEL_BASE
 0x54000000

	)

107 
	#OMAP2_STI_IRQ
 4

	)

109 
ªsour˚
 
	g°i_ªsour˚s
[] = {

111 .
°¨t
 = 
OMAP2_STI_BASE
,

112 .
	gíd
 = 
OMAP2_STI_BASE
 + 0x7ff,

113 .
	gÊags
 = 
IORESOURCE_MEM
,

116 .
	g°¨t
 = 
OMAP2_STI_CHANNEL_BASE
,

117 .
	gíd
 = 
OMAP2_STI_CHANNEL_BASE
 + 
SZ_64K
 - 1,

118 .
	gÊags
 = 
IORESOURCE_MEM
,

121 .
	g°¨t
 = 
OMAP2_STI_IRQ
,

122 .
	gÊags
 = 
IORESOURCE_IRQ
,

126 
∂©f‹m_devi˚
 
	g°i_devi˚
 = {

127 .
«me
 = "sti",

128 .
	gid
 = -1,

129 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
°i_ªsour˚s
),

130 .
	gªsour˚
 = 
°i_ªsour˚s
,

133 
ölöe
 
	$om≠_öô_°i
()

135 
	`∂©f‹m_devi˚_ªgi°î
(&
°i_devi˚
);

136 
	}
}

138 
ölöe
 
	$om≠_öô_°i
(Ë{
	}
}

141 #i‡
deföed
(
CONFIG_SPI_OMAP24XX
)

143 
	~<asm/¨ch/mc•i.h
>

145 
	#OMAP2_MCSPI1_BASE
 0x48098000

	)

146 
	#OMAP2_MCSPI2_BASE
 0x4809a000

	)

148 
om≠2_mc•i_∂©f‹m_c⁄fig
 
	gom≠2_mc•i1_c⁄fig
 = {

149 .
num_cs
 = 4,

152 
ªsour˚
 
	gom≠2_mc•i1_ªsour˚s
[] = {

154 .
°¨t
 = 
OMAP2_MCSPI1_BASE
,

155 .
	gíd
 = 
OMAP2_MCSPI1_BASE
 + 0xff,

156 .
	gÊags
 = 
IORESOURCE_MEM
,

160 
∂©f‹m_devi˚
 
	gom≠2_mc•i1
 = {

161 .
«me
 = "omap2_mcspi",

162 .
	gid
 = 1,

163 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
om≠2_mc•i1_ªsour˚s
),

164 .
	gªsour˚
 = 
om≠2_mc•i1_ªsour˚s
,

165 .
	gdev
 = {

166 .
∂©f‹m_d©a
 = &
om≠2_mc•i1_c⁄fig
,

170 
om≠2_mc•i_∂©f‹m_c⁄fig
 
	gom≠2_mc•i2_c⁄fig
 = {

171 .
num_cs
 = 2,

174 
ªsour˚
 
	gom≠2_mc•i2_ªsour˚s
[] = {

176 .
°¨t
 = 
OMAP2_MCSPI2_BASE
,

177 .
	gíd
 = 
OMAP2_MCSPI2_BASE
 + 0xff,

178 .
	gÊags
 = 
IORESOURCE_MEM
,

182 
∂©f‹m_devi˚
 
	gom≠2_mc•i2
 = {

183 .
«me
 = "omap2_mcspi",

184 .
	gid
 = 2,

185 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
om≠2_mc•i2_ªsour˚s
),

186 .
	gªsour˚
 = 
om≠2_mc•i2_ªsour˚s
,

187 .
	gdev
 = {

188 .
∂©f‹m_d©a
 = &
om≠2_mc•i2_c⁄fig
,

192 
	$om≠_öô_mc•i
()

194 
	`∂©f‹m_devi˚_ªgi°î
(&
om≠2_mc•i1
);

195 
	`∂©f‹m_devi˚_ªgi°î
(&
om≠2_mc•i2
);

196 
	}
}

199 
ölöe
 
	$om≠_öô_mc•i
(Ë{
	}
}

204 
__öô
 
	$om≠2_öô_devi˚s
()

209 
	`om≠_öô_i2c
();

210 
	`om≠_öô_mbox
();

211 
	`om≠_öô_mc•i
();

212 
	`om≠_öô_°i
();

215 
	}
}

216 
¨ch_öôˇŒ
(
om≠2_öô_devi˚s
);

	@arch/arm/mach-omap2/gpmc.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/îr.h
>

15 
	~<löux/˛k.h
>

16 
	~<löux/i›‹t.h
>

17 
	~<löux/•ölock.h
>

19 
	~<asm/io.h
>

20 
	~<asm/mach-ty≥s.h
>

21 
	~<asm/¨ch/gpmc.h
>

23 #unde‡
DEBUG


25 
	#GPMC_BASE
 0x6800a000

	)

26 
	#GPMC_REVISION
 0x00

	)

27 
	#GPMC_SYSCONFIG
 0x10

	)

28 
	#GPMC_SYSSTATUS
 0x14

	)

29 
	#GPMC_IRQSTATUS
 0x18

	)

30 
	#GPMC_IRQENABLE
 0x1c

	)

31 
	#GPMC_TIMEOUT_CONTROL
 0x40

	)

32 
	#GPMC_ERR_ADDRESS
 0x44

	)

33 
	#GPMC_ERR_TYPE
 0x48

	)

34 
	#GPMC_CONFIG
 0x50

	)

35 
	#GPMC_STATUS
 0x54

	)

36 
	#GPMC_PREFETCH_CONFIG1
 0x1e0

	)

37 
	#GPMC_PREFETCH_CONFIG2
 0x1e4

	)

38 
	#GPMC_PREFETCH_CONTROL
 0x1e8

	)

39 
	#GPMC_PREFETCH_STATUS
 0x1f0

	)

40 
	#GPMC_ECC_CONFIG
 0x1f4

	)

41 
	#GPMC_ECC_CONTROL
 0x1f8

	)

42 
	#GPMC_ECC_SIZE_CONFIG
 0x1fc

	)

44 
	#GPMC_CS0
 0x60

	)

45 
	#GPMC_CS_SIZE
 0x30

	)

47 
	#GPMC_CS_NUM
 8

	)

48 
	#GPMC_MEM_START
 0x00000000

	)

49 
	#GPMC_MEM_END
 0x3FFFFFFF

	)

50 
	#BOOT_ROM_SPACE
 0x100000

	)

52 
	#GPMC_CHUNK_SHIFT
 24

	)

53 
	#GPMC_SECTION_SHIFT
 28

	)

55 
ªsour˚
 
	ggpmc_mem_roŸ
;

56 
ªsour˚
 
	ggpmc_cs_mem
[
GPMC_CS_NUM
];

57 
DEFINE_SPINLOCK
(
gpmc_mem_lock
);

58 
	ggpmc_cs_m≠
;

60 
__iomem
 *
	ggpmc_ba£
 =

61 (
__iomem
 *Ë
IO_ADDRESS
(
GPMC_BASE
);

62 
__iomem
 *
	ggpmc_cs_ba£
 =

63 (
__iomem
 *Ë
IO_ADDRESS
(
GPMC_BASE
Ë+ 
GPMC_CS0
;

65 
˛k
 *
	ggpmc_l3_˛k
;

67 
	$gpmc_wrôe_ªg
(
idx
, 
u32
 
vÆ
)

69 
	`__øw_wrôñ
(
vÆ
, 
gpmc_ba£
 + 
idx
);

70 
	}
}

72 
u32
 
	$gpmc_ªad_ªg
(
idx
)

74  
	`__øw_ªadl
(
gpmc_ba£
 + 
idx
);

75 
	}
}

77 
	$gpmc_cs_wrôe_ªg
(
cs
, 
idx
, 
u32
 
vÆ
)

79 
__iomem
 *
ªg_addr
;

81 
ªg_addr
 = 
gpmc_cs_ba£
 + (
cs
 * 
GPMC_CS_SIZE
Ë+ 
idx
;

82 
	`__øw_wrôñ
(
vÆ
, 
ªg_addr
);

83 
	}
}

85 
u32
 
	$gpmc_cs_ªad_ªg
(
cs
, 
idx
)

87  
	`__øw_ªadl
(
gpmc_cs_ba£
 + (
cs
 * 
GPMC_CS_SIZE
Ë+ 
idx
);

88 
	}
}

91 
	$gpmc_gë_f˛k_≥riod
()

94  1000000000 / ((
	`˛k_gë_øã
(
gpmc_l3_˛k
)) / 1000);

95 
	}
}

97 
	$gpmc_ns_to_ticks
(
time_ns
)

99 
tick_ps
;

102 
tick_ps
 = 
	`gpmc_gë_f˛k_≥riod
();

104  (
time_ns
 * 1000 + 
tick_ps
 - 1) /Åick_ps;

105 
	}
}

107 #ifde‡
DEBUG


108 
	$£t_gpmc_timög_ªg
(
cs
, 
ªg
, 
°_bô
, 
íd_bô
,

109 
time
, c⁄° *
«me
)

111 
	$£t_gpmc_timög_ªg
(
cs
, 
ªg
, 
°_bô
, 
íd_bô
,

112 
time
)

115 
u32
 
l
;

116 
ticks
, 
mask
, 
ƒ_bôs
;

118 i‡(
time
 == 0)

119 
ticks
 = 0;

121 
ticks
 = 
	`gpmc_ns_to_ticks
(
time
);

122 
ƒ_bôs
 = 
íd_bô
 - 
°_bô
 + 1;

123 i‡(
ticks
 >1 << 
ƒ_bôs
)

126 
mask
 = (1 << 
ƒ_bôs
) - 1;

127 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
ªg
);

128 #ifde‡
DEBUG


129 
	`¥ötk
(
KERN_INFO
 "GPMC CS%d: %-10s: %dÅicks, %3luÇs (was %iÅicks)\n",

130 
cs
, 
«me
, 
ticks
, 
	`gpmc_gë_f˛k_≥riod
() *Åicks / 1000,

131 (
l
 >> 
°_bô
Ë& 
mask
);

133 
l
 &~(
mask
 << 
°_bô
);

134 
l
 |
ticks
 << 
°_bô
;

135 
	`gpmc_cs_wrôe_ªg
(
cs
, 
ªg
, 
l
);

138 
	}
}

140 #ifde‡
DEBUG


141 
	#GPMC_SET_ONE
(
ªg
, 
°
, 
íd
, 
fõld
) \

142 i‡(
	`£t_gpmc_timög_ªg
(
cs
, (
ªg
), (
°
), (
íd
), \

143 
t
->
fõld
, #field) < 0) \

144  -1

	)

146 
	#GPMC_SET_ONE
(
ªg
, 
°
, 
íd
, 
fõld
) \

147 i‡(
	`£t_gpmc_timög_ªg
(
cs
, (
ªg
), (
°
), (
íd
), 
t
->
fõld
) < 0) \

148  -1

	)

151 
	$gpmc_cs_ˇlc_dividî
(
cs
, 
sync_˛k
)

153 
div
;

154 
u32
 
l
;

156 
l
 = 
sync_˛k
 * 1000 + (
	`gpmc_gë_f˛k_≥riod
() - 1);

157 
div
 = 
l
 / 
	`gpmc_gë_f˛k_≥riod
();

158 i‡(
div
 > 4)

160 i‡(
div
 < 0)

161 
div
 = 1;

163  
div
;

164 
	}
}

166 
	$gpmc_cs_£t_timögs
(
cs
, c⁄° 
gpmc_timögs
 *
t
)

168 
div
;

169 
u32
 
l
;

171 
div
 = 
	`gpmc_cs_ˇlc_dividî
(
cs
, 
t
->
sync_˛k
);

172 i‡(
div
 < 0)

175 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG2
, 0, 3, 
cs_⁄
);

176 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG2
, 8, 12, 
cs_rd_off
);

177 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG2
, 16, 20, 
cs_wr_off
);

179 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG3
, 0, 3, 
adv_⁄
);

180 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG3
, 8, 12, 
adv_rd_off
);

181 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG3
, 16, 20, 
adv_wr_off
);

183 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG4
, 0, 3, 
€_⁄
);

184 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG4
, 8, 12, 
€_off
);

185 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG4
, 16, 19, 
we_⁄
);

186 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG4
, 24, 28, 
we_off
);

188 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG5
, 0, 4, 
rd_cy˛e
);

189 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG5
, 8, 12, 
wr_cy˛e
);

190 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG5
, 16, 20, 
ac˚ss
);

192 
	`GPMC_SET_ONE
(
GPMC_CS_CONFIG5
, 24, 27, 
∑ge_bur°_ac˚ss
);

194 #ifde‡
DEBUG


195 
	`¥ötk
(
KERN_INFO
 "GPMC CS%d CLKÖeriod is %lu (div %d)\n",

196 
cs
, 
	`gpmc_gë_f˛k_≥riod
(), 
div
);

199 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
GPMC_CS_CONFIG1
);

200 
l
 &= ~0x03;

201 
l
 |(
div
 - 1);

204 
	}
}

206 
	$gpmc_cs_íabÀ_mem
(
cs
, 
u32
 
ba£
, u32 
size
)

208 
u32
 
l
;

209 
u32
 
mask
;

211 
mask
 = (1 << 
GPMC_SECTION_SHIFT
Ë- 
size
;

212 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
GPMC_CS_CONFIG7
);

213 
l
 &= ~0x3f;

214 
l
 = (
ba£
 >> 
GPMC_CHUNK_SHIFT
) & 0x3f;

215 
l
 &= ~(0x0f << 8);

216 
l
 |((
mask
 >> 
GPMC_CHUNK_SHIFT
) & 0x0f) << 8;

217 
l
 |= 1 << 6;

218 
	`gpmc_cs_wrôe_ªg
(
cs
, 
GPMC_CS_CONFIG7
, 
l
);

219 
	}
}

221 
	$gpmc_cs_dißbÀ_mem
(
cs
)

223 
u32
 
l
;

225 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
GPMC_CS_CONFIG7
);

226 
l
 &= ~(1 << 6);

227 
	`gpmc_cs_wrôe_ªg
(
cs
, 
GPMC_CS_CONFIG7
, 
l
);

228 
	}
}

230 
	$gpmc_cs_gë_memc⁄f
(
cs
, 
u32
 *
ba£
, u32 *
size
)

232 
u32
 
l
;

233 
u32
 
mask
;

235 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
GPMC_CS_CONFIG7
);

236 *
ba£
 = (
l
 & 0x3fË<< 
GPMC_CHUNK_SHIFT
;

237 
mask
 = (
l
 >> 8) & 0x0f;

238 *
size
 = (1 << 
GPMC_SECTION_SHIFT
Ë- (
mask
 << 
GPMC_CHUNK_SHIFT
);

239 
	}
}

241 
	$gpmc_cs_mem_íabÀd
(
cs
)

243 
u32
 
l
;

245 
l
 = 
	`gpmc_cs_ªad_ªg
(
cs
, 
GPMC_CS_CONFIG7
);

246  
l
 & (1 << 6);

247 
	}
}

249 
	$gpmc_cs_£t_ª£rved
(
cs
, 
ª£rved
)

251 i‡(
cs
 > 
GPMC_CS_NUM
)

252  -
ENODEV
;

254 
gpmc_cs_m≠
 &~(1 << 
cs
);

255 
gpmc_cs_m≠
 |(
ª£rved
 ? 1 : 0Ë<< 
cs
;

258 
	}
}

260 
	$gpmc_cs_ª£rved
(
cs
)

262 i‡(
cs
 > 
GPMC_CS_NUM
)

263  -
ENODEV
;

265  
gpmc_cs_m≠
 & (1 << 
cs
);

266 
	}
}

268 
	$gpmc_mem_Æign
(
size
)

270 
‹dî
;

272 
size
 = (sizê- 1Ë>> (
GPMC_CHUNK_SHIFT
 - 1);

273 
‹dî
 = 
GPMC_CHUNK_SHIFT
 - 1;

275 
size
 >>= 1;

276 
‹dî
++;

277 } 
size
);

278 
size
 = 1 << 
‹dî
;

279  
size
;

280 
	}
}

282 
	$gpmc_cs_ö£π_mem
(
cs
, 
ba£
, 
size
)

284 
ªsour˚
 *
ªs
 = &
gpmc_cs_mem
[
cs
];

285 
r
;

287 
size
 = 
	`gpmc_mem_Æign
(size);

288 
	`•ö_lock
(&
gpmc_mem_lock
);

289 
ªs
->
°¨t
 = 
ba£
;

290 
ªs
->
íd
 = 
ba£
 + 
size
 - 1;

291 
r
 = 
	`ªque°_ªsour˚
(&
gpmc_mem_roŸ
, 
ªs
);

292 
	`•ö_u∆ock
(&
gpmc_mem_lock
);

294  
r
;

295 
	}
}

297 
	$gpmc_cs_ªque°
(
cs
, 
size
, *
ba£
)

299 
ªsour˚
 *
ªs
 = &
gpmc_cs_mem
[
cs
];

300 
r
 = -1;

302 i‡(
cs
 > 
GPMC_CS_NUM
)

303  -
ENODEV
;

305 
size
 = 
	`gpmc_mem_Æign
(size);

306 i‡(
size
 > (1 << 
GPMC_SECTION_SHIFT
))

307  -
ENOMEM
;

309 
	`•ö_lock
(&
gpmc_mem_lock
);

310 i‡(
	`gpmc_cs_ª£rved
(
cs
)) {

311 
r
 = -
EBUSY
;

312 
out
;

314 i‡(
	`gpmc_cs_mem_íabÀd
(
cs
))

315 
r
 = 
	`adju°_ªsour˚
(
ªs
,Ñes->
°¨t
 & ~(
size
 - 1), size);

316 i‡(
r
 < 0)

317 
r
 = 
	`Æloˇã_ªsour˚
(&
gpmc_mem_roŸ
, 
ªs
, 
size
, 0, ~0,

318 
size
, 
NULL
, NULL);

319 i‡(
r
 < 0)

320 
out
;

322 
	`gpmc_cs_íabÀ_mem
(
cs
, 
ªs
->
°¨t
,Ñes->
íd
 -Ñes->start + 1);

323 *
ba£
 = 
ªs
->
°¨t
;

324 
	`gpmc_cs_£t_ª£rved
(
cs
, 1);

325 
out
:

326 
	`•ö_u∆ock
(&
gpmc_mem_lock
);

327  
r
;

328 
	}
}

330 
	$gpmc_cs_‰ì
(
cs
)

332 
	`•ö_lock
(&
gpmc_mem_lock
);

333 i‡(
cs
 >
GPMC_CS_NUM
 || !
	`gpmc_cs_ª£rved
(cs)) {

334 
	`¥ötk
(
KERN_ERR
 "TryögÅÿ‰ìÇ⁄-ª£rved GPMC CS%d\n", 
cs
);

335 
	`BUG
();

336 
	`•ö_u∆ock
(&
gpmc_mem_lock
);

339 
	`gpmc_cs_dißbÀ_mem
(
cs
);

340 
	`ªÀa£_ªsour˚
(&
gpmc_cs_mem
[
cs
]);

341 
	`gpmc_cs_£t_ª£rved
(
cs
, 0);

342 
	`•ö_u∆ock
(&
gpmc_mem_lock
);

343 
	}
}

345 
__öô
 
	$gpmc_mem_öô
()

347 
cs
;

348 
boŸ_rom_•a˚
 = 0;

353 
boŸ_rom_•a˚
 = 
BOOT_ROM_SPACE
;

355 i‡(
	`machöe_is_om≠_≠ﬁl⁄
())

356 
boŸ_rom_•a˚
 = 0;

357 
gpmc_mem_roŸ
.
°¨t
 = 
GPMC_MEM_START
 + 
boŸ_rom_•a˚
;

358 
gpmc_mem_roŸ
.
íd
 = 
GPMC_MEM_END
;

361 
cs
 = 0; c†< 
GPMC_CS_NUM
; cs++) {

362 
u32
 
ba£
, 
size
;

364 i‡(!
	`gpmc_cs_mem_íabÀd
(
cs
))

366 
	`gpmc_cs_gë_memc⁄f
(
cs
, &
ba£
, &
size
);

367 i‡(
	`gpmc_cs_ö£π_mem
(
cs
, 
ba£
, 
size
) < 0)

368 
	`BUG
();

370 
	}
}

372 
__öô
 
	$gpmc_öô
()

374 
u32
 
l
;

376 
gpmc_l3_˛k
 = 
	`˛k_gë
(
NULL
, "core_l3_ck");

377 
	`BUG_ON
(
	`IS_ERR
(
gpmc_l3_˛k
));

379 
l
 = 
	`gpmc_ªad_ªg
(
GPMC_REVISION
);

380 
	`¥ötk
(
KERN_INFO
 "GPMCÑevisi⁄ %d.%d\n", (
l
 >> 4) & 0x0f,Ü & 0x0f);

382 
l
 = 
	`gpmc_ªad_ªg
(
GPMC_SYSCONFIG
);

383 
l
 &= 0x03 << 3;

384 
l
 |= (0x02 << 3) | (1 << 0);

385 
	`gpmc_wrôe_ªg
(
GPMC_SYSCONFIG
, 
l
);

387 
	`gpmc_mem_öô
();

388 
	}
}

	@arch/arm/mach-omap2/id.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/io.h
>

20 
	#OMAP24XX_TAP_BASE
 
	`io_p2v
(0x48014000)

	)

22 
	#OMAP_TAP_IDCODE
 0x0204

	)

23 
	#OMAP_TAP_PROD_ID
 0x0208

	)

25 
	#OMAP_TAP_DIE_ID_0
 0x0218

	)

26 
	#OMAP_TAP_DIE_ID_1
 0x021C

	)

27 
	#OMAP_TAP_DIE_ID_2
 0x0220

	)

28 
	#OMAP_TAP_DIE_ID_3
 0x0224

	)

37 
	som≠_id
 {

38 
u16
 
	mhawkeye
;

39 
u8
 
	mdev
;

40 
u32
 
	mty≥
;

44 
om≠_id
 
	gom≠_ids
[] 
	g__öôd©a
 = {

45 { .
hawkeye
 = 0xb5d9, .
	gdev
 = 0x0, .
	gty≥
 = 0x24200000 },

46 { .
	ghawkeye
 = 0xb5d9, .
	gdev
 = 0x1, .
	gty≥
 = 0x24201000 },

47 { .
	ghawkeye
 = 0xb5d9, .
	gdev
 = 0x2, .
	gty≥
 = 0x24202000 },

48 { .
	ghawkeye
 = 0xb5d9, .
	gdev
 = 0x4, .
	gty≥
 = 0x24220000 },

49 { .
	ghawkeye
 = 0xb5d9, .
	gdev
 = 0x8, .
	gty≥
 = 0x24230000 },

50 { .
	ghawkeye
 = 0xb68a, .
	gdev
 = 0x0, .
	gty≥
 = 0x24300000 },

53 
u32
 
__öô
 
	$ªad_èp_ªg
(
ªg
)

55  
	`__øw_ªadl
(
OMAP24XX_TAP_BASE
 + 
ªg
);

56 
	}
}

58 
__öô
 
	$om≠2_check_ªvisi⁄
()

60 
i
, 
j
;

61 
u32
 
idcode
;

62 
u32
 
¥od_id
;

63 
u16
 
hawkeye
;

64 
u8
 
dev_ty≥
;

65 
u8
 
ªv
;

67 
idcode
 = 
	`ªad_èp_ªg
(
OMAP_TAP_IDCODE
);

68 
¥od_id
 = 
	`ªad_èp_ªg
(
OMAP_TAP_PROD_ID
);

69 
hawkeye
 = (
idcode
 >> 12) & 0xffff;

70 
ªv
 = (
idcode
 >> 28) & 0x0f;

71 
dev_ty≥
 = (
¥od_id
 >> 16) & 0x0f;

73 #ifde‡
DEBUG


74 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_IDCODE 0x%08x REV %i HAWKEYE 0x%04x MANF %03x\n",

75 
idcode
, 
ªv
, 
hawkeye
, (idcode >> 1) & 0x7ff);

76 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_DIE_ID_0: 0x%08x\n",

77 
	`ªad_èp_ªg
(
OMAP_TAP_DIE_ID_0
));

78 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_DIE_ID_1: 0x%08x DEV_REV: %i\n",

79 
	`ªad_èp_ªg
(
OMAP_TAP_DIE_ID_1
),

80 (
	`ªad_èp_ªg
(
OMAP_TAP_DIE_ID_1
) >> 28) & 0xf);

81 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_DIE_ID_2: 0x%08x\n",

82 
	`ªad_èp_ªg
(
OMAP_TAP_DIE_ID_2
));

83 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_DIE_ID_3: 0x%08x\n",

84 
	`ªad_èp_ªg
(
OMAP_TAP_DIE_ID_3
));

85 
	`¥ötk
(
KERN_DEBUG
 "OMAP_TAP_PROD_ID_0: 0x%08x DEV_TYPE: %i\n",

86 
¥od_id
, 
dev_ty≥
);

90 
i
 = 0; i < 
	`ARRAY_SIZE
(
om≠_ids
); i++) {

91 i‡(
hawkeye
 =
om≠_ids
[
i
].hawkeye)

95 i‡(
i
 =
	`ARRAY_SIZE
(
om≠_ids
)) {

96 
	`¥ötk
(
KERN_ERR
 "Unknown OMAP CPU id\n");

100 
j
 = 
i
; j < 
	`ARRAY_SIZE
(
om≠_ids
); j++) {

101 i‡(
dev_ty≥
 =
om≠_ids
[
j
].
dev
)

105 i‡(
j
 =
	`ARRAY_SIZE
(
om≠_ids
)) {

106 
	`¥ötk
(
KERN_ERR
 "Unknown OMAP deviceÅype. "

108 
om≠_ids
[
i
].
ty≥
 >> 16);

109 
j
 = 
i
;

111 
sy°em_ªv
 = 
om≠_ids
[
j
].
ty≥
;

113 
sy°em_ªv
 |
ªv
 << 8;

116 
sy°em_ªv
 |= 0x24;

118 
	`¥_öfo
("OMAP%04x", 
sy°em_ªv
 >> 16);

119 i‡((
sy°em_ªv
 >> 8) & 0x0f)

120 
	`¥ötk
("%x", (
sy°em_ªv
 >> 8) & 0x0f);

121 
	`¥ötk
("\n");

122 
	}
}

	@arch/arm/mach-omap2/io.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

18 
	~<asm/éb.h
>

19 
	~<asm/io.h
>

21 
	~<asm/mach/m≠.h
>

23 
	~<asm/¨ch/mux.h
>

24 
	~<asm/¨ch/om≠fb.h
>

26 
om≠_§am_öô
();

27 
om≠2_˛k_öô
();

28 
om≠2_check_ªvisi⁄
();

29 
gpmc_öô
();

30 
om≠fb_ª£rve_sdøm
();

36 
m≠_desc
 
	gom≠2_io_desc
[] 
	g__öôd©a
 = {

38 .
vútuÆ
 = 
L3_24XX_VIRT
,

39 .
	gp‚
 = 
__phys_to_p‚
(
L3_24XX_PHYS
),

40 .
	gÀngth
 = 
L3_24XX_SIZE
,

41 .
	gty≥
 = 
MT_DEVICE


44 .
	gvútuÆ
 = 
DSP_MEM_24XX_VIRT
,

45 .
	gp‚
 = 
__phys_to_p‚
(
DSP_MEM_24XX_PHYS
),

46 .
	gÀngth
 = 
DSP_MEM_24XX_SIZE
,

47 .
	gty≥
 = 
MT_DEVICE


50 .
	gvútuÆ
 = 
DSP_IPI_24XX_VIRT
,

51 .
	gp‚
 = 
__phys_to_p‚
(
DSP_IPI_24XX_PHYS
),

52 .
	gÀngth
 = 
DSP_IPI_24XX_SIZE
,

53 .
	gty≥
 = 
MT_DEVICE


56 .
	gvútuÆ
 = 
DSP_MMU_24XX_VIRT
,

57 .
	gp‚
 = 
__phys_to_p‚
(
DSP_MMU_24XX_PHYS
),

58 .
	gÀngth
 = 
DSP_MMU_24XX_SIZE
,

59 .
	gty≥
 = 
MT_DEVICE


63 
__öô
 
	$om≠2_m≠_comm⁄_io
()

65 
	`iŸabÀ_öô
(
om≠2_io_desc
, 
	`ARRAY_SIZE
(omap2_io_desc));

71 
	`loˇl_Êush_éb_Æl
();

72 
	`Êush_ˇche_Æl
();

74 
	`om≠2_check_ªvisi⁄
();

75 
	`om≠_§am_öô
();

76 
	`om≠fb_ª£rve_sdøm
();

77 
	}
}

79 
__öô
 
	$om≠2_öô_comm⁄_hw
()

81 
	`om≠2_mux_öô
();

82 
	`om≠2_˛k_öô
();

83 
	`gpmc_öô
();

84 
	}
}

	@arch/arm/mach-omap2/irq.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/mach/úq.h
>

18 
	~<asm/úq.h
>

19 
	~<asm/io.h
>

21 
	#INTC_REVISION
 0x0000

	)

22 
	#INTC_SYSCONFIG
 0x0010

	)

23 
	#INTC_SYSSTATUS
 0x0014

	)

24 
	#INTC_CONTROL
 0x0048

	)

25 
	#INTC_MIR_CLEAR0
 0x0088

	)

26 
	#INTC_MIR_SET0
 0x008c

	)

34 
	som≠_úq_b™k
 {

35 
	mba£_ªg
;

36 
	mƒ_úqs
;

37 } 
__©åibuã__
 ((
Æig√d
(4))Ë
	gúq_b™ks
[] = {

40 .
ba£_ªg
 = 
OMAP24XX_IC_BASE
,

41 .
	gƒ_úqs
 = 96,

48 
	$om≠_ack_úq
(
úq
)

50 
	`om≠_wrôñ
(0x1, 
úq_b™ks
[0].
ba£_ªg
 + 
INTC_CONTROL
);

51 
	}
}

53 
	$om≠_mask_úq
(
úq
)

55 
off£t
 = (
úq
 >> 5) << 5;

57 i‡(
úq
 >= 64) {

58 
úq
 %= 64;

59 } i‡(
úq
 >= 32) {

60 
úq
 %= 32;

63 
	`om≠_wrôñ
(1 << 
úq
, 
úq_b™ks
[0].
ba£_ªg
 + 
INTC_MIR_SET0
 + 
off£t
);

64 
	}
}

66 
	$om≠_unmask_úq
(
úq
)

68 
off£t
 = (
úq
 >> 5) << 5;

70 i‡(
úq
 >= 64) {

71 
úq
 %= 64;

72 } i‡(
úq
 >= 32) {

73 
úq
 %= 32;

76 
	`om≠_wrôñ
(1 << 
úq
, 
úq_b™ks
[0].
ba£_ªg
 + 
INTC_MIR_CLEAR0
 + 
off£t
);

77 
	}
}

79 
	$om≠_mask_ack_úq
(
úq
)

81 
	`om≠_mask_úq
(
úq
);

82 
	`om≠_ack_úq
(
úq
);

83 
	}
}

85 
úq_chù
 
	gom≠_úq_chù
 = {

86 .
«me
 = "INTC",

87 .
	gack
 = 
om≠_mask_ack_úq
,

88 .
	gmask
 = 
om≠_mask_úq
,

89 .
	gunmask
 = 
om≠_unmask_úq
,

92 
__öô
 
	$om≠_úq_b™k_öô_⁄e
(
om≠_úq_b™k
 *
b™k
)

94 
tmp
;

96 
tmp
 = 
	`om≠_ªadl
(
b™k
->
ba£_ªg
 + 
INTC_REVISION
) & 0xff;

97 
	`¥ötk
(
KERN_INFO
 "IRQ: Foundán INTCát 0x%08lx "

99 
b™k
->
ba£_ªg
, 
tmp
 >> 4,Åm∞& 0xf, b™k->
ƒ_úqs
);

101 
tmp
 = 
	`om≠_ªadl
(
b™k
->
ba£_ªg
 + 
INTC_SYSCONFIG
);

102 
tmp
 |= 1 << 1;

103 
	`om≠_wrôñ
(
tmp
, 
b™k
->
ba£_ªg
 + 
INTC_SYSCONFIG
);

105 !(
	`om≠_ªadl
(
b™k
->
ba£_ªg
 + 
INTC_SYSSTATUS
) & 0x1))

107 
	}
}

109 
__öô
 
	$om≠_öô_úq
()

111 
ƒ_úqs
 = 0;

112 
ƒ_b™ks
 = 0;

113 
i
;

115 
i
 = 0; i < 
	`ARRAY_SIZE
(
úq_b™ks
); i++) {

116 
om≠_úq_b™k
 *
b™k
 = 
úq_b™ks
 + 
i
;

119 i‡(!
b™k
->
ba£_ªg
)

122 
	`om≠_úq_b™k_öô_⁄e
(
b™k
);

124 
ƒ_úqs
 +
b™k
->nr_irqs;

125 
ƒ_b™ks
++;

128 
	`¥ötk
(
KERN_INFO
 "Total of %ld interrupts on %dáctive controller%s\n",

129 
ƒ_úqs
, 
ƒ_b™ks
,Çr_banks > 1 ? "s" : "");

131 
i
 = 0; i < 
ƒ_úqs
; i++) {

132 
	`£t_úq_chù
(
i
, &
om≠_úq_chù
);

133 
	`£t_úq_h™dÀr
(
i
, 
h™dÀ_Àvñ_úq
);

134 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

136 
	}
}

	@arch/arm/mach-omap2/mailbox.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/˛k.h
>

15 
	~<löux/îr.h
>

16 
	~<löux/∂©f‹m_devi˚.h
>

17 
	~<asm/¨ch/maûbox.h
>

18 
	~<asm/¨ch/úqs.h
>

19 
	~<asm/io.h
>

21 
	#MAILBOX_REVISION
 0x00

	)

22 
	#MAILBOX_SYSCONFIG
 0x10

	)

23 
	#MAILBOX_SYSSTATUS
 0x14

	)

24 
	#MAILBOX_MESSAGE_0
 0x40

	)

25 
	#MAILBOX_MESSAGE_1
 0x44

	)

26 
	#MAILBOX_MESSAGE_2
 0x48

	)

27 
	#MAILBOX_MESSAGE_3
 0x4c

	)

28 
	#MAILBOX_MESSAGE_4
 0x50

	)

29 
	#MAILBOX_MESSAGE_5
 0x54

	)

30 
	#MAILBOX_FIFOSTATUS_0
 0x80

	)

31 
	#MAILBOX_FIFOSTATUS_1
 0x84

	)

32 
	#MAILBOX_FIFOSTATUS_2
 0x88

	)

33 
	#MAILBOX_FIFOSTATUS_3
 0x8c

	)

34 
	#MAILBOX_FIFOSTATUS_4
 0x90

	)

35 
	#MAILBOX_FIFOSTATUS_5
 0x94

	)

36 
	#MAILBOX_MSGSTATUS_0
 0xc0

	)

37 
	#MAILBOX_MSGSTATUS_1
 0xc4

	)

38 
	#MAILBOX_MSGSTATUS_2
 0xc8

	)

39 
	#MAILBOX_MSGSTATUS_3
 0xcc

	)

40 
	#MAILBOX_MSGSTATUS_4
 0xd0

	)

41 
	#MAILBOX_MSGSTATUS_5
 0xd4

	)

42 
	#MAILBOX_IRQSTATUS_0
 0x100

	)

43 
	#MAILBOX_IRQENABLE_0
 0x104

	)

44 
	#MAILBOX_IRQSTATUS_1
 0x108

	)

45 
	#MAILBOX_IRQENABLE_1
 0x10c

	)

46 
	#MAILBOX_IRQSTATUS_2
 0x110

	)

47 
	#MAILBOX_IRQENABLE_2
 0x114

	)

48 
	#MAILBOX_IRQSTATUS_3
 0x118

	)

49 
	#MAILBOX_IRQENABLE_3
 0x11c

	)

51 
	gmbox_ba£
;

53 
	#MAILBOX_IRQ_NOTFULL
(
n
Ë(1 << (2 * (nË+ 1))

	)

54 
	#MAILBOX_IRQ_NEWMSG
(
n
Ë(1 << (2 * (n)))

	)

56 
	som≠_mbox2_fifo
 {

57 
	mmsg
;

58 
	mfifo_°©
;

59 
	mmsg_°©
;

62 
	som≠_mbox2_¥iv
 {

63 
om≠_mbox2_fifo
 
	mtx_fifo
;

64 
om≠_mbox2_fifo
 
	mrx_fifo
;

65 
	múqíabÀ
;

66 
	múq°©us
;

67 
u32
 
	m√wmsg_bô
;

68 
u32
 
	mnŸfuŒ_bô
;

71 
˛k
 *
	gmbox_ick_h™dÀ
;

73 
ölöe
 
	$mbox_ªad_ªg
(
ªg
)

75  
	`__øw_ªadl
(
mbox_ba£
 + 
ªg
);

76 
	}
}

78 
ölöe
 
	$mbox_wrôe_ªg
(
vÆ
, 
ªg
)

80 
	`__øw_wrôñ
(
vÆ
, 
mbox_ba£
 + 
ªg
);

81 
	}
}

84 
ölöe
 
	$om≠2_mbox_°¨tup
(
om≠_mbox
 *
mbox
)

86 
l
;

88 
mbox_ick_h™dÀ
 = 
	`˛k_gë
(
NULL
, "mailboxes_ick");

89 i‡(
	`IS_ERR
(
mbox_ick_h™dÀ
)) {

90 
	`¥ötk
("CouldÇot get mailboxes_ick\n");

91  -
ENODEV
;

93 
	`˛k_íabÀ
(
mbox_ick_h™dÀ
);

96 
l
 = 
	`mbox_ªad_ªg
(
MAILBOX_SYSCONFIG
);

97 
l
 |= 0x00000011;

98 
	`mbox_wrôe_ªg
(
l
, 
MAILBOX_SYSCONFIG
);

101 
	}
}

103 
ölöe
 
	$om≠2_mbox_shutdown
(
om≠_mbox
 *
mbox
)

105 
	`˛k_dißbÀ
(
mbox_ick_h™dÀ
);

106 
	`˛k_put
(
mbox_ick_h™dÀ
);

107 
	}
}

110 
ölöe
 
mbox_msg_t
 
	$om≠2_mbox_fifo_ªad
(
om≠_mbox
 *
mbox
)

112 
om≠_mbox2_fifo
 *
fifo
 =

113 &((
om≠_mbox2_¥iv
 *)
mbox
->
¥iv
)->
rx_fifo
;

114  (
mbox_msg_t
Ë
	`mbox_ªad_ªg
(
fifo
->
msg
);

115 
	}
}

117 
ölöe
 
	$om≠2_mbox_fifo_wrôe
(
om≠_mbox
 *
mbox
, 
mbox_msg_t
 
msg
)

119 
om≠_mbox2_fifo
 *
fifo
 =

120 &((
om≠_mbox2_¥iv
 *)
mbox
->
¥iv
)->
tx_fifo
;

121 
	`mbox_wrôe_ªg
(
msg
, 
fifo
->msg);

122 
	}
}

124 
ölöe
 
	$om≠2_mbox_fifo_em±y
(
om≠_mbox
 *
mbox
)

126 
om≠_mbox2_fifo
 *
fifo
 =

127 &((
om≠_mbox2_¥iv
 *)
mbox
->
¥iv
)->
rx_fifo
;

128  (
	`mbox_ªad_ªg
(
fifo
->
msg_°©
) == 0);

129 
	}
}

131 
ölöe
 
	$om≠2_mbox_fifo_fuŒ
(
om≠_mbox
 *
mbox
)

133 
om≠_mbox2_fifo
 *
fifo
 =

134 &((
om≠_mbox2_¥iv
 *)
mbox
->
¥iv
)->
tx_fifo
;

135  (
	`mbox_ªad_ªg
(
fifo
->
fifo_°©
));

136 
	}
}

139 
ölöe
 
	$om≠2_mbox_íabÀ_úq
(
om≠_mbox
 *
mbox
,

140 
om≠_mbox_ty≥_t
 
úq
)

142 
om≠_mbox2_¥iv
 *
p
 = (om≠_mbox2_¥iv *)
mbox
->
¥iv
;

143 
u32
 
l
, 
bô
 = (
úq
 =
IRQ_TX
Ë? 
p
->
nŸfuŒ_bô
 :Ö->
√wmsg_bô
;

145 
l
 = 
	`mbox_ªad_ªg
(
p
->
úqíabÀ
);

146 
l
 |
bô
;

147 
	`mbox_wrôe_ªg
(
l
, 
p
->
úqíabÀ
);

148 
	}
}

150 
ölöe
 
	$om≠2_mbox_dißbÀ_úq
(
om≠_mbox
 *
mbox
,

151 
om≠_mbox_ty≥_t
 
úq
)

153 
om≠_mbox2_¥iv
 *
p
 = (om≠_mbox2_¥iv *)
mbox
->
¥iv
;

154 
u32
 
l
, 
bô
 = (
úq
 =
IRQ_TX
Ë? 
p
->
nŸfuŒ_bô
 :Ö->
√wmsg_bô
;

156 
l
 = 
	`mbox_ªad_ªg
(
p
->
úqíabÀ
);

157 
l
 &~
bô
;

158 
	`mbox_wrôe_ªg
(
l
, 
p
->
úqíabÀ
);

159 
	}
}

161 
ölöe
 
	$om≠2_mbox_ack_úq
(
om≠_mbox
 *
mbox
,

162 
om≠_mbox_ty≥_t
 
úq
)

164 
om≠_mbox2_¥iv
 *
p
 = (om≠_mbox2_¥iv *)
mbox
->
¥iv
;

165 
u32
 
bô
 = (
úq
 =
IRQ_TX
Ë? 
p
->
nŸfuŒ_bô
 :Ö->
√wmsg_bô
;

167 
	`mbox_wrôe_ªg
(
bô
, 
p
->
úq°©us
);

168 
	}
}

170 
ölöe
 
	$om≠2_mbox_is_úq
(
om≠_mbox
 *
mbox
,

171 
om≠_mbox_ty≥_t
 
úq
)

173 
om≠_mbox2_¥iv
 *
p
 = (om≠_mbox2_¥iv *)
mbox
->
¥iv
;

174 
u32
 
bô
 = (
úq
 =
IRQ_TX
Ë? 
p
->
nŸfuŒ_bô
 :Ö->
√wmsg_bô
;

175 
u32
 
íabÀ
 = 
	`mbox_ªad_ªg
(
p
->
úqíabÀ
);

176 
u32
 
°©us
 = 
	`mbox_ªad_ªg
(
p
->
úq°©us
);

178  (
íabÀ
 & 
°©us
 & 
bô
);

179 
	}
}

181 
om≠_mbox_›s
 
	gom≠2_mbox_›s
 = {

182 .
ty≥
 = 
OMAP_MBOX_TYPE2
,

183 .
	g°¨tup
 = 
om≠2_mbox_°¨tup
,

184 .
	gshutdown
 = 
om≠2_mbox_shutdown
,

185 .
	gfifo_ªad
 = 
om≠2_mbox_fifo_ªad
,

186 .
	gfifo_wrôe
 = 
om≠2_mbox_fifo_wrôe
,

187 .
	gfifo_em±y
 = 
om≠2_mbox_fifo_em±y
,

188 .
	gfifo_fuŒ
 = 
om≠2_mbox_fifo_fuŒ
,

189 .
	gíabÀ_úq
 = 
om≠2_mbox_íabÀ_úq
,

190 .
	gdißbÀ_úq
 = 
om≠2_mbox_dißbÀ_úq
,

191 .
	gack_úq
 = 
om≠2_mbox_ack_úq
,

192 .
	gis_úq
 = 
om≠2_mbox_is_úq
,

205 
om≠_mbox2_¥iv
 
	gom≠2_mbox_d•_¥iv
 = {

206 .
tx_fifo
 = {

207 .
msg
 = 
MAILBOX_MESSAGE_0
,

208 .
	gfifo_°©
 = 
MAILBOX_FIFOSTATUS_0
,

210 .
	grx_fifo
 = {

211 .
msg
 = 
MAILBOX_MESSAGE_1
,

212 .
	gmsg_°©
 = 
MAILBOX_MSGSTATUS_1
,

214 .
	gúqíabÀ
 = 
MAILBOX_IRQENABLE_0
,

215 .
	gúq°©us
 = 
MAILBOX_IRQSTATUS_0
,

216 .
	gnŸfuŒ_bô
 = 
MAILBOX_IRQ_NOTFULL
(0),

217 .
	g√wmsg_bô
 = 
MAILBOX_IRQ_NEWMSG
(1),

220 
om≠_mbox
 
	gmbox_d•_öfo
 = {

221 .
«me
 = "dsp",

222 .
	g›s
 = &
om≠2_mbox_›s
,

223 .
	g¥iv
 = &
om≠2_mbox_d•_¥iv
,

225 
EXPORT_SYMBOL
(
mbox_d•_öfo
);

228 
om≠_mbox2_¥iv
 
	gom≠2_mbox_iva_¥iv
 = {

229 .
tx_fifo
 = {

230 .
msg
 = 
MAILBOX_MESSAGE_2
,

231 .
	gfifo_°©
 = 
MAILBOX_FIFOSTATUS_2
,

233 .
	grx_fifo
 = {

234 .
msg
 = 
MAILBOX_MESSAGE_3
,

235 .
	gmsg_°©
 = 
MAILBOX_MSGSTATUS_3
,

237 .
	gúqíabÀ
 = 
MAILBOX_IRQENABLE_3
,

238 .
	gúq°©us
 = 
MAILBOX_IRQSTATUS_3
,

239 .
	gnŸfuŒ_bô
 = 
MAILBOX_IRQ_NOTFULL
(2),

240 .
	g√wmsg_bô
 = 
MAILBOX_IRQ_NEWMSG
(3),

243 
om≠_mbox
 
	gmbox_iva_öfo
 = {

244 .
«me
 = "iva",

245 .
	g›s
 = &
om≠2_mbox_›s
,

246 .
	g¥iv
 = &
om≠2_mbox_iva_¥iv
,

249 
__öô
 
	$om≠2_mbox_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

251 
ªsour˚
 *
ªs
;

252 
ªt
 = 0;

254 i‡(
pdev
->
num_ªsour˚s
 != 3) {

255 
	`dev_îr
(&
pdev
->
dev
, "invalidÇumber ofÑesources: %d\n",

256 
pdev
->
num_ªsour˚s
);

257  -
ENODEV
;

261 
ªs
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_MEM
, 0);

262 i‡(
	`u∆ikñy
(!
ªs
)) {

263 
	`dev_îr
(&
pdev
->
dev
, "invalid memÑesource\n");

264  -
ENODEV
;

266 
mbox_ba£
 = 
ªs
->
°¨t
;

269 
ªs
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_IRQ
, 0);

270 i‡(
	`u∆ikñy
(!
ªs
)) {

271 
	`dev_îr
(&
pdev
->
dev
, "invalid irqÑesource\n");

272  -
ENODEV
;

274 
mbox_d•_öfo
.
úq
 = 
ªs
->
°¨t
;

276 
ªt
 = 
	`om≠_mbox_ªgi°î
(&
mbox_d•_öfo
);

279 
ªs
 = 
	`∂©f‹m_gë_ªsour˚
(
pdev
, 
IORESOURCE_IRQ
, 1);

280 i‡(
	`u∆ikñy
(!
ªs
)) {

281 
	`dev_îr
(&
pdev
->
dev
, "invalid irqÑesource\n");

282  -
ENODEV
;

284 
mbox_iva_öfo
.
úq
 = 
ªs
->
°¨t
;

286 
ªt
 = 
	`om≠_mbox_ªgi°î
(&
mbox_iva_öfo
);

288  
ªt
;

289 
	}
}

291 
	$om≠2_mbox_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

293 
	`om≠_mbox_uƒegi°î
(&
mbox_d•_öfo
);

295 
	}
}

297 
∂©f‹m_drivî
 
	gom≠2_mbox_drivî
 = {

298 .
¥obe
 = 
om≠2_mbox_¥obe
,

299 .
	gªmove
 = 
om≠2_mbox_ªmove
,

300 .
	gdrivî
 = {

301 .
«me
 = "mailbox",

305 
__öô
 
	$om≠2_mbox_öô
()

307  
	`∂©f‹m_drivî_ªgi°î
(&
om≠2_mbox_drivî
);

308 
	}
}

310 
__exô
 
	$om≠2_mbox_exô
()

312 
	`∂©f‹m_drivî_uƒegi°î
(&
om≠2_mbox_drivî
);

313 
	}
}

315 
moduÀ_öô
(
om≠2_mbox_öô
);

316 
moduÀ_exô
(
om≠2_mbox_exô
);

318 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-omap2/memory.c

17 
	~<löux/moduÀ.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/devi˚.h
>

20 
	~<löux/li°.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/˛k.h
>

25 
	~<asm/io.h
>

27 
	~<asm/¨ch/˛ock.h
>

28 
	~<asm/¨ch/§am.h
>

30 
	~"¥cm-ªgs.h
"

31 
	~"mem‹y.h
"

33 
mem‹y_timögs
 
	gmem_timögs
;

35 
u32
 
	$om≠2_mem‹y_gë_¶ow_dŒ_˘æ
()

37  
mem_timögs
.
¶ow_dŒ_˘æ
;

38 
	}
}

40 
u32
 
	$om≠2_mem‹y_gë_Á°_dŒ_˘æ
()

42  
mem_timögs
.
Á°_dŒ_˘æ
;

43 
	}
}

45 
u32
 
	$om≠2_mem‹y_gë_ty≥
()

47  
mem_timögs
.
m_ty≥
;

48 
	}
}

50 
	$om≠2_öô_mem‹y_∑øms
(
u32
 
f‹˚_lock_to_u∆ock_mode
)

52 
dŒ_˙t
;

53 
u32
 
Á°_dŒ
 = 0;

55 
mem_timögs
.
m_ty≥
 = !((
SDRC_MR_0
 & 0x3) == 0x1);

60 i‡(
	`˝u_is_om≠2422
())

61 
mem_timögs
.
ba£_cs
 = 1;

63 
mem_timögs
.
ba£_cs
 = 0;

65 i‡(
mem_timögs
.
m_ty≥
 !
M_DDR
)

69 i‡(((
mem_timögs
.
Á°_dŒ_˘æ
 & (1 << 2)Ë=
M_LOCK_CTRL
))

70 
mem_timögs
.
dŒ_mode
 = 
M_UNLOCK
;

72 
mem_timögs
.
dŒ_mode
 = 
M_LOCK
;

74 i‡(
mem_timögs
.
ba£_cs
 == 0) {

75 
Á°_dŒ
 = 
SDRC_DLLA_CTRL
;

76 
dŒ_˙t
 = 
SDRC_DLLA_STATUS
 & 0xff00;

78 
Á°_dŒ
 = 
SDRC_DLLB_CTRL
;

79 
dŒ_˙t
 = 
SDRC_DLLB_STATUS
 & 0xff00;

81 i‡(
f‹˚_lock_to_u∆ock_mode
) {

82 
Á°_dŒ
 &= ~0xff00;

83 
Á°_dŒ
 |
dŒ_˙t
;

86 
mem_timögs
.
Á°_dŒ_˘æ
 = (
Á°_dŒ
 | (3 << 8));

89 
	`om≠2_§am_ddr_öô
(&
mem_timögs
.
¶ow_dŒ_˘æ
,

90 
mem_timögs
.
Á°_dŒ_˘æ
,

91 
mem_timögs
.
ba£_cs
,

92 
f‹˚_lock_to_u∆ock_mode
);

93 
mem_timögs
.
¶ow_dŒ_˘æ
 &= 0xff00;

96 
mem_timögs
.
¶ow_dŒ_˘æ
 |=

97 ((
mem_timögs
.
Á°_dŒ_˘æ
 & 0xF) | (1 << 2));

100 
mem_timögs
.
¶ow_dŒ_˘æ
 |= ((1 << 1) | (3 << 8));

101 
	}
}

	@arch/arm/mach-omap2/memory.h

18 
	#M_DDR
 1

	)

19 
	#M_LOCK_CTRL
 (1 << 2)

	)

20 
	#M_UNLOCK
 0

	)

21 
	#M_LOCK
 1

	)

23 
	smem‹y_timögs
 {

24 
u32
 
	mm_ty≥
;

25 
u32
 
	mdŒ_mode
;

26 
u32
 
	m¶ow_dŒ_˘æ
;

27 
u32
 
	mÁ°_dŒ_˘æ
;

28 
u32
 
	mba£_cs
;

31 
om≠2_öô_mem‹y_∑øms
(
u32
 
f‹˚_lock_to_u∆ock_mode
);

32 
u32
 
om≠2_mem‹y_gë_¶ow_dŒ_˘æ
();

33 
u32
 
om≠2_mem‹y_gë_Á°_dŒ_˘æ
();

34 
u32
 
om≠2_mem‹y_gë_ty≥
();

	@arch/arm/mach-omap2/mux.c

25 
	~<löux/moduÀ.h
>

26 
	~<löux/öô.h
>

27 
	~<asm/sy°em.h
>

28 
	~<asm/io.h
>

29 
	~<löux/•ölock.h
>

31 
	~<asm/¨ch/mux.h
>

33 #ifde‡
CONFIG_OMAP_MUX


37 
pö_c⁄fig
 
__öôd©a_‹_moduÀ
 
	gom≠24xx_pös
[] = {

44 
MUX_CFG_24XX
("M19_24XX_I2C1_SCL", 0x111, 0, 0, 0, 1)

45 
MUX_CFG_24XX
("L15_24XX_I2C1_SDA", 0x112, 0, 0, 0, 1)

46 
MUX_CFG_24XX
("J15_24XX_I2C2_SCL", 0x113, 0, 0, 1, 1)

47 
MUX_CFG_24XX
("H19_24XX_I2C2_SDA", 0x114, 0, 0, 0, 1)

50 
MUX_CFG_24XX
("W19_24XX_SYS_NIRQ", 0x12c, 0, 1, 1, 1)

53 
MUX_CFG_24XX
("W14_24XX_SYS_CLKOUT", 0x137, 0, 1, 1, 1)

56 
MUX_CFG_24XX
("E2_GPMC_NCS2", 0x08e, 0, 1, 1, 1)

57 
MUX_CFG_24XX
("L2_GPMC_NCS7", 0x093, 0, 1, 1, 1)

58 
MUX_CFG_24XX
("L3_GPMC_WAIT0", 0x09a, 0, 1, 1, 1)

59 
MUX_CFG_24XX
("N7_GPMC_WAIT1", 0x09b, 0, 1, 1, 1)

60 
MUX_CFG_24XX
("M1_GPMC_WAIT2", 0x09c, 0, 1, 1, 1)

61 
MUX_CFG_24XX
("P1_GPMC_WAIT3", 0x09d, 0, 1, 1, 1)

64 
MUX_CFG_24XX
("Y15_24XX_MCBSP2_CLKX", 0x124, 1, 1, 0, 1)

65 
MUX_CFG_24XX
("R14_24XX_MCBSP2_FSX", 0x125, 1, 1, 0, 1)

66 
MUX_CFG_24XX
("W15_24XX_MCBSP2_DR", 0x126, 1, 1, 0, 1)

67 
MUX_CFG_24XX
("V15_24XX_MCBSP2_DX", 0x127, 1, 1, 0, 1)

70 
MUX_CFG_24XX
("M21_242X_GPIO11", 0x0c9, 3, 1, 1, 1)

71 
MUX_CFG_24XX
("P21_242X_GPIO12", 0x0ca, 3, 0, 0, 1)

72 
MUX_CFG_24XX
("AA10_242X_GPIO13", 0x0e5, 3, 0, 0, 1)

73 
MUX_CFG_24XX
("AA6_242X_GPIO14", 0x0e6, 3, 0, 0, 1)

74 
MUX_CFG_24XX
("AA4_242X_GPIO15", 0x0e7, 3, 0, 0, 1)

75 
MUX_CFG_24XX
("Y11_242X_GPIO16", 0x0e8, 3, 0, 0, 1)

76 
MUX_CFG_24XX
("AA12_242X_GPIO17", 0x0e9, 3, 0, 0, 1)

77 
MUX_CFG_24XX
("AA8_242X_GPIO58", 0x0ea, 3, 0, 0, 1)

78 
MUX_CFG_24XX
("Y20_24XX_GPIO60", 0x12c, 3, 0, 0, 1)

79 
MUX_CFG_24XX
("W4__24XX_GPIO74", 0x0f2, 3, 0, 0, 1)

80 
MUX_CFG_24XX
("M15_24XX_GPIO92", 0x10a, 3, 0, 0, 1)

81 
MUX_CFG_24XX
("J15_24XX_GPIO99", 0x113, 3, 1, 1, 1)

82 
MUX_CFG_24XX
("V14_24XX_GPIO117", 0x128, 3, 1, 0, 1)

83 
MUX_CFG_24XX
("P14_24XX_GPIO125", 0x140, 3, 1, 1, 1)

86 
MUX_CFG_24XX
("V4_242X_GPIO49", 0xd3, 3, 0, 0, 1)

87 
MUX_CFG_24XX
("W2_242X_GPIO50", 0xd4, 3, 0, 0, 1)

88 
MUX_CFG_24XX
("U4_242X_GPIO51", 0xd5, 3, 0, 0, 1)

89 
MUX_CFG_24XX
("V3_242X_GPIO52", 0xd6, 3, 0, 0, 1)

90 
MUX_CFG_24XX
("V2_242X_GPIO53", 0xd7, 3, 0, 0, 1)

91 
MUX_CFG_24XX
("V6_242X_GPIO53", 0xcf, 3, 0, 0, 1)

92 
MUX_CFG_24XX
("T4_242X_GPIO54", 0xd8, 3, 0, 0, 1)

93 
MUX_CFG_24XX
("Y4_242X_GPIO54", 0xd0, 3, 0, 0, 1)

94 
MUX_CFG_24XX
("T3_242X_GPIO55", 0xd9, 3, 0, 0, 1)

95 
MUX_CFG_24XX
("U2_242X_GPIO56", 0xda, 3, 0, 0, 1)

98 
MUX_CFG_24XX
("AA10_242X_DMAREQ0", 0x0e5, 2, 0, 0, 1)

99 
MUX_CFG_24XX
("AA6_242X_DMAREQ1", 0x0e6, 2, 0, 0, 1)

100 
MUX_CFG_24XX
("E4_242X_DMAREQ2", 0x074, 2, 0, 0, 1)

101 
MUX_CFG_24XX
("G4_242X_DMAREQ3", 0x073, 2, 0, 0, 1)

102 
MUX_CFG_24XX
("D3_242X_DMAREQ4", 0x072, 2, 0, 0, 1)

103 
MUX_CFG_24XX
("E3_242X_DMAREQ5", 0x071, 2, 0, 0, 1)

106 
MUX_CFG_24XX
("P20_24XX_TSC_IRQ", 0x108, 0, 0, 0, 1)

109 
MUX_CFG_24XX
("K15_24XX_UART3_TX", 0x118, 0, 0, 0, 1)

110 
MUX_CFG_24XX
("K14_24XX_UART3_RX", 0x119, 0, 0, 0, 1)

113 
MUX_CFG_24XX
("G19_24XX_MMC_CLKO", 0x0f3, 0, 0, 0, 1)

114 
MUX_CFG_24XX
("H18_24XX_MMC_CMD", 0x0f4, 0, 0, 0, 1)

115 
MUX_CFG_24XX
("F20_24XX_MMC_DAT0", 0x0f5, 0, 0, 0, 1)

116 
MUX_CFG_24XX
("H14_24XX_MMC_DAT1", 0x0f6, 0, 0, 0, 1)

117 
MUX_CFG_24XX
("E19_24XX_MMC_DAT2", 0x0f7, 0, 0, 0, 1)

118 
MUX_CFG_24XX
("D19_24XX_MMC_DAT3", 0x0f8, 0, 0, 0, 1)

119 
MUX_CFG_24XX
("F19_24XX_MMC_DAT_DIR0", 0x0f9, 0, 0, 0, 1)

120 
MUX_CFG_24XX
("E20_24XX_MMC_DAT_DIR1", 0x0fa, 0, 0, 0, 1)

121 
MUX_CFG_24XX
("F18_24XX_MMC_DAT_DIR2", 0x0fb, 0, 0, 0, 1)

122 
MUX_CFG_24XX
("E18_24XX_MMC_DAT_DIR3", 0x0fc, 0, 0, 0, 1)

123 
MUX_CFG_24XX
("G18_24XX_MMC_CMD_DIR", 0x0fd, 0, 0, 0, 1)

124 
MUX_CFG_24XX
("H15_24XX_MMC_CLKI", 0x0fe, 0, 0, 0, 1)

127 
MUX_CFG_24XX
("J20_24XX_USB0_PUEN", 0x11d, 0, 0, 0, 1)

128 
MUX_CFG_24XX
("J19_24XX_USB0_VP", 0x11e, 0, 0, 0, 1)

129 
MUX_CFG_24XX
("K20_24XX_USB0_VM", 0x11f, 0, 0, 0, 1)

130 
MUX_CFG_24XX
("J18_24XX_USB0_RCV", 0x120, 0, 0, 0, 1)

131 
MUX_CFG_24XX
("K19_24XX_USB0_TXEN", 0x121, 0, 0, 0, 1)

132 
MUX_CFG_24XX
("J14_24XX_USB0_SE0", 0x122, 0, 0, 0, 1)

133 
MUX_CFG_24XX
("K18_24XX_USB0_DAT", 0x123, 0, 0, 0, 1)

135 
MUX_CFG_24XX
("N14_24XX_USB1_SE0", 0x0ed, 2, 0, 0, 1)

136 
MUX_CFG_24XX
("W12_24XX_USB1_SE0", 0x0dd, 3, 0, 0, 1)

137 
MUX_CFG_24XX
("P15_24XX_USB1_DAT", 0x0ee, 2, 0, 0, 1)

138 
MUX_CFG_24XX
("R13_24XX_USB1_DAT", 0x0e0, 3, 0, 0, 1)

139 
MUX_CFG_24XX
("W20_24XX_USB1_TXEN", 0x0ec, 2, 0, 0, 1)

140 
MUX_CFG_24XX
("P13_24XX_USB1_TXEN", 0x0df, 3, 0, 0, 1)

141 
MUX_CFG_24XX
("V19_24XX_USB1_RCV", 0x0eb, 2, 0, 0, 1)

142 
MUX_CFG_24XX
("V12_24XX_USB1_RCV", 0x0de, 3, 0, 0, 1)

144 
MUX_CFG_24XX
("AA10_24XX_USB2_SE0", 0x0e5, 2, 0, 0, 1)

145 
MUX_CFG_24XX
("Y11_24XX_USB2_DAT", 0x0e8, 2, 0, 0, 1)

146 
MUX_CFG_24XX
("AA12_24XX_USB2_TXEN", 0x0e9, 2, 0, 0, 1)

147 
MUX_CFG_24XX
("AA6_24XX_USB2_RCV", 0x0e6, 2, 0, 0, 1)

148 
MUX_CFG_24XX
("AA4_24XX_USB2_TLLSE0", 0x0e7, 2, 0, 0, 1)

151 
MUX_CFG_24XX
("T19_24XX_KBR0", 0x106, 3, 1, 1, 1)

152 
MUX_CFG_24XX
("R19_24XX_KBR1", 0x107, 3, 1, 1, 1)

153 
MUX_CFG_24XX
("V18_24XX_KBR2", 0x139, 3, 1, 1, 1)

154 
MUX_CFG_24XX
("M21_24XX_KBR3", 0xc9, 3, 1, 1, 1)

155 
MUX_CFG_24XX
("E5__24XX_KBR4", 0x138, 3, 1, 1, 1)

156 
MUX_CFG_24XX
("M18_24XX_KBR5", 0x10e, 3, 1, 1, 1)

157 
MUX_CFG_24XX
("R20_24XX_KBC0", 0x108, 3, 0, 0, 1)

158 
MUX_CFG_24XX
("M14_24XX_KBC1", 0x109, 3, 0, 0, 1)

159 
MUX_CFG_24XX
("H19_24XX_KBC2", 0x114, 3, 0, 0, 1)

160 
MUX_CFG_24XX
("V17_24XX_KBC3", 0x135, 3, 0, 0, 1)

161 
MUX_CFG_24XX
("P21_24XX_KBC4", 0xca, 3, 0, 0, 1)

162 
MUX_CFG_24XX
("L14_24XX_KBC5", 0x10f, 3, 0, 0, 1)

163 
MUX_CFG_24XX
("N19_24XX_KBC6", 0x110, 3, 0, 0, 1)

166 
MUX_CFG_24XX
("B3__24XX_KBR5", 0x30, 3, 1, 1, 1)

167 
MUX_CFG_24XX
("AA4_24XX_KBC2", 0xe7, 3, 0, 0, 1)

168 
MUX_CFG_24XX
("B13_24XX_KBC6", 0x110, 3, 0, 0, 1)

172 
__öô
 
	$om≠2_mux_öô
()

174 
	`om≠_mux_ªgi°î
(
om≠24xx_pös
, 
	`ARRAY_SIZE
(omap24xx_pins));

176 
	}
}

	@arch/arm/mach-omap2/pm-domain.c

18 
	~<löux/moduÀ.h
>

19 
	~<löux/öô.h
>

20 
	~<löux/˛k.h
>

22 
	~<asm/io.h
>

24 
	~"¥cm-ªgs.h
"

27 
	#PM_MPU_OFFSET
 0x100

	)

28 
	#PM_CORE_OFFSET
 0x200

	)

29 
	#PM_GFX_OFFSET
 0x300

	)

30 
	#PM_WKUP_OFFSET
 0x400

	)

31 
	#PM_PLL_OFFSET
 0x500

	)

32 
	#PM_DSP_OFFSET
 0x800

	)

33 
	#PM_MDM_OFFSET
 0xc00

	)

36 
	#PM_WKDEP_OFFSET
 0xc8

	)

37 
	#EN_MDM
 (1 << 5)

	)

38 
	#EN_WKUP
 (1 << 4)

	)

39 
	#EN_GFX
 (1 << 3)

	)

40 
	#EN_DSP
 (1 << 2)

	)

41 
	#EN_MPU
 (1 << 1)

	)

42 
	#EN_CORE
 (1 << 0)

	)

45 
	#PM_PWSTCTRL_OFFSET
 0xe0

	)

46 
	#FORCESTATE
 (1 << 18Ë

	)

47 
	#MEM4RETSTATE
 (1 << 6)

	)

48 
	#MEM3RETSTATE
 (1 << 5)

	)

49 
	#MEM2RETSTATE
 (1 << 4)

	)

50 
	#MEM1RETSTATE
 (1 << 3)

	)

51 
	#LOGICRETSTATE
 (1 << 2Ë

	)

52 
	#POWERSTATE_OFF
 0x3

	)

53 
	#POWERSTATE_RETENTION
 0x1

	)

54 
	#POWERSTATE_ON
 0x0

	)

57 
	#PM_PWSTST_OFFSET
 0xe4

	)

60 
	#CM_CLKSTCTRL_OFFSET
 0x48

	)

61 
	#AUTOSTAT_MPU
 (1 << 0Ë

	)

62 
	#AUTOSTAT_DSS
 (1 << 2Ë

	)

63 
	#AUTOSTAT_L4
 (1 << 1Ë

	)

64 
	#AUTOSTAT_L3
 (1 << 0Ë

	)

65 
	#AUTOSTAT_GFX
 (1 << 0Ë

	)

66 
	#AUTOSTAT_IVA
 (1 << 8Ë

	)

67 
	#AUTOSTAT_DSP
 (1 << 0Ë

	)

68 
	#AUTOSTAT_MDM
 (1 << 0Ë

	)

71 
	#CM_AUTOIDLE1_OFFSET
 0x30

	)

72 
	#CM_AUTOIDLE2_OFFSET
 0x34

	)

73 
	#CM_AUTOIDLE3_OFFSET
 0x38

	)

74 
	#CM_AUTOIDLE4_OFFSET
 0x3¯

	)

75 
	#AUTO_54M
(
x
Ë(((xË& 0x3Ë<< 6)

	)

76 
	#AUTO_96M
(
x
Ë(((xË& 0x3Ë<< 2)

	)

77 
	#AUTO_DPLL
(
x
Ë(((xË& 0x3Ë<< 0)

	)

78 
	#AUTO_STOPPED
 0x3

	)

79 
	#AUTO_BYPASS_FAST
 0x2

	)

80 
	#AUTO_BYPASS_LOW_POWER
 0x1

	)

81 
	#AUTO_DISABLED
 0x0

	)

84 
	#AUTO_EXTVOLT
 (1 << 15)

	)

85 
	#FORCE_EXTVOLT
 (1 << 14)

	)

86 
	#SETOFF_LEVEL
(
x
Ë(((xË& 0x3Ë<< 12)

	)

87 
	#MEMRETCTRL
 (1 << 8)

	)

88 
	#SETRET_LEVEL
(
x
Ë(((xË& 0x3Ë<< 6)

	)

89 
	#VOLT_LEVEL
(
x
Ë(((xË& 0x3Ë<< 0)

	)

91 
	#OMAP24XX_PRCM_VBASE
 
	`IO_ADDRESS
(
OMAP24XX_PRCM_BASE
)

	)

92 
	#¥cm_ªadl
(
r
Ë
	`__øw_ªadl
(
OMAP24XX_PRCM_VBASE
 + (r))

	)

93 
	#¥cm_wrôñ
(
v
, 
r
Ë
	`__øw_wrôñ
((v), 
OMAP24XX_PRCM_VBASE
 + (r))

	)

95 
u32
 
	$pmdomaö_gë_wakeup_dïídícõs
(
domaö_off£t
)

97  
	`¥cm_ªadl
(
domaö_off£t
 + 
PM_WKDEP_OFFSET
);

98 
	}
}

100 
	$pmdomaö_£t_wakeup_dïídícõs
(
u32
 
°©e
, 
domaö_off£t
)

102 
	`¥cm_wrôñ
(
°©e
, 
domaö_off£t
 + 
PM_WKDEP_OFFSET
);

103 
	}
}

105 
u32
 
	$pmdomaö_gë_powî°©e
(
domaö_off£t
)

107  
	`¥cm_ªadl
(
domaö_off£t
 + 
PM_PWSTCTRL_OFFSET
);

108 
	}
}

110 
	$pmdomaö_£t_powî°©e
(
u32
 
°©e
, 
domaö_off£t
)

112 
	`¥cm_wrôñ
(
°©e
, 
domaö_off£t
 + 
PM_PWSTCTRL_OFFSET
);

113 
	}
}

115 
u32
 
	$pmdomaö_gë_˛ock_autoc⁄åﬁ
(
domaö_off£t
)

117  
	`¥cm_ªadl
(
domaö_off£t
 + 
CM_CLKSTCTRL_OFFSET
);

118 
	}
}

120 
	$pmdomaö_£t_˛ock_autoc⁄åﬁ
(
u32
 
°©e
, 
domaö_off£t
)

122 
	`¥cm_wrôñ
(
°©e
, 
domaö_off£t
 + 
CM_CLKSTCTRL_OFFSET
);

123 
	}
}

125 
u32
 
	$pmdomaö_gë_˛ock_autoidÀ1
(
domaö_off£t
)

127  
	`¥cm_ªadl
(
domaö_off£t
 + 
CM_AUTOIDLE1_OFFSET
);

128 
	}
}

131 
u32
 
	$pmdomaö_gë_˛ock_autoidÀ2
(
domaö_off£t
)

133  
	`¥cm_ªadl
(
domaö_off£t
 + 
CM_AUTOIDLE2_OFFSET
);

134 
	}
}

137 
u32
 
	$pmdomaö_gë_˛ock_autoidÀ3
(
domaö_off£t
)

139  
	`¥cm_ªadl
(
domaö_off£t
 + 
CM_AUTOIDLE3_OFFSET
);

140 
	}
}

143 
u32
 
	$pmdomaö_gë_˛ock_autoidÀ4
(
domaö_off£t
)

145  
	`¥cm_ªadl
(
domaö_off£t
 + 
CM_AUTOIDLE4_OFFSET
);

146 
	}
}

148 
	$pmdomaö_£t_˛ock_autoidÀ1
(
u32
 
°©e
, 
domaö_off£t
)

150 
	`¥cm_wrôñ
(
°©e
, 
CM_AUTOIDLE1_OFFSET
 + 
domaö_off£t
);

151 
	}
}

154 
	$pmdomaö_£t_˛ock_autoidÀ2
(
u32
 
°©e
, 
domaö_off£t
)

156 
	`¥cm_wrôñ
(
°©e
, 
CM_AUTOIDLE2_OFFSET
 + 
domaö_off£t
);

157 
	}
}

160 
	$pmdomaö_£t_˛ock_autoidÀ3
(
u32
 
°©e
, 
domaö_off£t
)

162 
	`¥cm_wrôñ
(
°©e
, 
CM_AUTOIDLE3_OFFSET
 + 
domaö_off£t
);

163 
	}
}

166 
	$pmdomaö_£t_˛ock_autoidÀ4
(
u32
 
°©e
, 
domaö_off£t
)

168 
	`¥cm_wrôñ
(
°©e
, 
CM_AUTOIDLE4_OFFSET
 + 
domaö_off£t
);

169 
	}
}

174 
	$pmdomaö_£t_autoidÀ
()

176 
u32
 
vÆ
;

179 
	`pmdomaö_£t_˛ock_autoidÀ1
(
	`AUTO_54M
(
AUTO_STOPPED
) |

180 
	`AUTO_96M
(
AUTO_STOPPED
) |

181 
	`AUTO_DPLL
(
AUTO_STOPPED
), 
PM_PLL_OFFSET
);

186 
PRCM_CLKSRC_CTRL
 |= (0x3 << 3);

189 
PRCM_CLKSSETUP
 = 0x00ff;

192 
PRCM_VOLTSETUP
 = 0;

193 
vÆ
 = 
PRCM_VOLTCTRL
;

194 
vÆ
 &~(
	`SETOFF_LEVEL
(0x3Ë| 
	`VOLT_LEVEL
(0x3));

195 
vÆ
 |
	`SETOFF_LEVEL
(1Ë| 
	`VOLT_LEVEL
(1Ë| 
AUTO_EXTVOLT
;

196 
PRCM_VOLTCTRL
 = 
vÆ
;

199 
PRCM_CLKEMUL_CTRL
 = 0x0;

202 
vÆ
 = 
	`pmdomaö_gë_powî°©e
(
PM_CORE_OFFSET
);

203 i‡(
	`˝u_is_om≠2420
()) {

204 
vÆ
 &= ~(0x7 << 3);

205 
vÆ
 |(
MEM3RETSTATE
 | 
MEM2RETSTATE
 | 
MEM1RETSTATE
);

207 
vÆ
 &= ~(0xf << 3);

208 
vÆ
 |(
MEM4RETSTATE
 | 
MEM3RETSTATE
 | 
MEM2RETSTATE
 |

209 
MEM1RETSTATE
);

211 
	`pmdomaö_£t_powî°©e
(
vÆ
, 
PM_CORE_OFFSET
);

214 
vÆ
 = 
SMS_SYSCONFIG
;

215 
vÆ
 &= ~(0x3 << 3);

216 
vÆ
 |= (0x2 << 3) | (1 << 0);

217 
SMS_SYSCONFIG
 |
vÆ
;

219 
vÆ
 = 
SDRC_SYSCONFIG
;

220 
vÆ
 &= ~(0x3 << 3);

221 
vÆ
 |= (0x2 << 3);

222 
SDRC_SYSCONFIG
 = 
vÆ
;

227 
vÆ
 = 
GPMC_SYSCONFIG
;

228 
vÆ
 &= ~(0x3 << 3);

229 
vÆ
 |= (0x2 << 3) | (1 << 0);

230 
GPMC_SYSCONFIG
 = 
vÆ
;

232 
	`pmdomaö_£t_powî°©e
(
LOGICRETSTATE
 | 
POWERSTATE_RETENTION
,

233 
PM_MPU_OFFSET
);

234 
	`pmdomaö_£t_powî°©e
(
POWERSTATE_RETENTION
, 
PM_CORE_OFFSET
);

235 i‡(!
	`˝u_is_om≠2420
())

236 
	`pmdomaö_£t_powî°©e
(
POWERSTATE_RETENTION
, 
PM_MDM_OFFSET
);

239 
	`pmdomaö_£t_powî°©e
(
FORCESTATE
 | 
POWERSTATE_OFF
, 
PM_DSP_OFFSET
);

240 
	`pmdomaö_£t_powî°©e
(
FORCESTATE
 | 
POWERSTATE_OFF
, 
PM_GFX_OFFSET
);

244 
	`f‹˚_°™dby_usb
();

245 i‡(
	`˝u_is_om≠2430
())

246 
	`f‹˚_hsmmc
();

247 
	`sdøm_£lf_ª‰esh_⁄_idÀ_ªq
(1);

253 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_MPU
, 
PM_MPU_OFFSET
);

254 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_GFX
, 
PM_GFX_OFFSET
);

255 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_DSS
 | 
AUTOSTAT_L4
 | 
AUTOSTAT_L3
,

256 
PM_CORE_OFFSET
);

257 i‡(
	`˝u_is_om≠2420
())

258 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_IVA
 | 
AUTOSTAT_DSP
,

259 
PM_DSP_OFFSET
);

261 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_DSP
, 
PM_DSP_OFFSET
);

262 
	`pmdomaö_£t_˛ock_autoc⁄åﬁ
(
AUTOSTAT_MDM
, 
PM_MDM_OFFSET
);

266 
	`pmdomaö_£t_˛ock_autoidÀ1
(0x2, 
PM_DSP_OFFSET
);

267 i‡(
	`˝u_is_om≠2420
()) {

268 
	`pmdomaö_£t_˛ock_autoidÀ1
(0xfffffff9, 
PM_CORE_OFFSET
);

269 
	`pmdomaö_£t_˛ock_autoidÀ2
(0x7, 
PM_CORE_OFFSET
);

270 
	`pmdomaö_£t_˛ock_autoidÀ1
(0x3f, 
PM_WKUP_OFFSET
);

272 
	`pmdomaö_£t_˛ock_autoidÀ1
(0xófffff1, 
PM_CORE_OFFSET
);

273 
	`pmdomaö_£t_˛ock_autoidÀ2
(0xfff, 
PM_CORE_OFFSET
);

274 
	`pmdomaö_£t_˛ock_autoidÀ1
(0x7f, 
PM_WKUP_OFFSET
);

275 
	`pmdomaö_£t_˛ock_autoidÀ1
(0x3, 
PM_MDM_OFFSET
);

277 
	`pmdomaö_£t_˛ock_autoidÀ3
(0x7, 
PM_CORE_OFFSET
);

278 
	`pmdomaö_£t_˛ock_autoidÀ4
(0x1f, 
PM_CORE_OFFSET
);

279 
	}
}

286 
__öô
 
	$pmdomaö_öô
()

289 
	`pmdomaö_£t_wakeup_dïídícõs
(
EN_WKUP
 | 
EN_CORE
, 
PM_MPU_OFFSET
);

290 
	`pmdomaö_£t_wakeup_dïídícõs
(0, 
PM_DSP_OFFSET
);

291 
	`pmdomaö_£t_wakeup_dïídícõs
(0, 
PM_GFX_OFFSET
);

292 
	`pmdomaö_£t_wakeup_dïídícõs
(
EN_WKUP
 | 
EN_MPU
, 
PM_CORE_OFFSET
);

293 i‡(
	`˝u_is_om≠2430
())

294 
	`pmdomaö_£t_wakeup_dïídícõs
(0, 
PM_MDM_OFFSET
);

297 
	`pmdomaö_£t_powî°©e
(
POWERSTATE_OFF
 | 
FORCESTATE
, 
PM_DSP_OFFSET
);

298 
	`pmdomaö_£t_powî°©e
(
POWERSTATE_OFF
 | 
FORCESTATE
, 
PM_GFX_OFFSET
);

299 
	}
}

	@arch/arm/mach-omap2/pm.c

19 
	~<löux/pm.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/¥oc_fs.h
>

22 
	~<löux/pm.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/sysfs.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/dñay.h
>

28 
	~<asm/io.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/©omic.h
>

31 
	~<asm/mach/time.h
>

32 
	~<asm/mach/úq.h
>

33 
	~<asm/mach-ty≥s.h
>

35 
	~<asm/¨ch/úqs.h
>

36 
	~<asm/¨ch/˛ock.h
>

37 
	~<asm/¨ch/§am.h
>

38 
	~<asm/¨ch/pm.h
>

40 
	~"¥cm-ªgs.h
"

42 
˛k
 *
	gv˛k
;

43 (*
om≠2_§am_idÀ
)();

44 (*
om≠2_§am_su•íd
)(
dŒ˘æ
, 
˝u_ªv
);

45 (*
ßved_idÀ
)();

47 
__öô
 
	`pmdomaö_öô
();

48 
	`pmdomaö_£t_autoidÀ
();

50 
om≠24xx_¶ìp_ßve
[
OMAP24XX_SLEEP_SAVE_SIZE
];

52 
	$om≠2_pm_idÀ
()

54 
	`loˇl_úq_dißbÀ
();

55 
	`loˇl_fiq_dißbÀ
();

56 i‡(
	`√ed_ªsched
()) {

57 
	`loˇl_fiq_íabÀ
();

58 
	`loˇl_úq_íabÀ
();

67 
	`timî_dyn_ª¥ogøm
();

69 
	`om≠2_§am_idÀ
();

70 
	`loˇl_fiq_íabÀ
();

71 
	`loˇl_úq_íabÀ
();

72 
	}
}

74 
	$om≠2_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
)

76 
îr‹
 = 0;

79 
ßved_idÀ
 = 
pm_idÀ
;

80 
pm_idÀ
 = 
NULL
;

82 
°©e
)

84 
PM_SUSPEND_STANDBY
:

85 
PM_SUSPEND_MEM
:

88 
PM_SUSPEND_DISK
:

89  -
ENOTSUPP
;

92  -
EINVAL
;

95  
îr‹
;

96 
	}
}

98 
	#INT0_WAKE_MASK
 (
	`OMAP_IRQ_BIT
(
INT_24XX_GPIO_BANK1
) | \

99 
	`OMAP_IRQ_BIT
(
INT_24XX_GPIO_BANK2
) | \

100 
	`OMAP_IRQ_BIT
(
INT_24XX_GPIO_BANK3
))

	)

102 
	#INT1_WAKE_MASK
 (
	`OMAP_IRQ_BIT
(
INT_24XX_GPIO_BANK4
))

	)

104 
	#INT2_WAKE_MASK
 (
	`OMAP_IRQ_BIT
(
INT_24XX_UART1_IRQ
) | \

105 
	`OMAP_IRQ_BIT
(
INT_24XX_UART2_IRQ
) | \

106 
	`OMAP_IRQ_BIT
(
INT_24XX_UART3_IRQ
))

	)

108 
	#¥eg
(
ªg
Ë
	`¥ötk
("%s\t(0x%p):\t0x%08x\n", #ªg, &ªg,Ñeg);

	)

110 
	$om≠2_pm_debug
(* 
desc
)

112 
	`¥ötk
("%s:\n", 
desc
);

114 
	`¥eg
(
CM_CLKSTCTRL_MPU
);

115 
	`¥eg
(
CM_CLKSTCTRL_CORE
);

116 
	`¥eg
(
CM_CLKSTCTRL_GFX
);

117 
	`¥eg
(
CM_CLKSTCTRL_DSP
);

118 
	`¥eg
(
CM_CLKSTCTRL_MDM
);

120 
	`¥eg
(
PM_PWSTCTRL_MPU
);

121 
	`¥eg
(
PM_PWSTCTRL_CORE
);

122 
	`¥eg
(
PM_PWSTCTRL_GFX
);

123 
	`¥eg
(
PM_PWSTCTRL_DSP
);

124 
	`¥eg
(
PM_PWSTCTRL_MDM
);

126 
	`¥eg
(
PM_PWSTST_MPU
);

127 
	`¥eg
(
PM_PWSTST_CORE
);

128 
	`¥eg
(
PM_PWSTST_GFX
);

129 
	`¥eg
(
PM_PWSTST_DSP
);

130 
	`¥eg
(
PM_PWSTST_MDM
);

132 
	`¥eg
(
CM_AUTOIDLE1_CORE
);

133 
	`¥eg
(
CM_AUTOIDLE2_CORE
);

134 
	`¥eg
(
CM_AUTOIDLE3_CORE
);

135 
	`¥eg
(
CM_AUTOIDLE4_CORE
);

136 
	`¥eg
(
CM_AUTOIDLE_WKUP
);

137 
	`¥eg
(
CM_AUTOIDLE_PLL
);

138 
	`¥eg
(
CM_AUTOIDLE_DSP
);

139 
	`¥eg
(
CM_AUTOIDLE_MDM
);

141 
	`¥eg
(
CM_ICLKEN1_CORE
);

142 
	`¥eg
(
CM_ICLKEN2_CORE
);

143 
	`¥eg
(
CM_ICLKEN3_CORE
);

144 
	`¥eg
(
CM_ICLKEN4_CORE
);

145 
	`¥eg
(
CM_ICLKEN_GFX
);

146 
	`¥eg
(
CM_ICLKEN_WKUP
);

147 
	`¥eg
(
CM_ICLKEN_DSP
);

148 
	`¥eg
(
CM_ICLKEN_MDM
);

150 
	`¥eg
(
CM_IDLEST1_CORE
);

151 
	`¥eg
(
CM_IDLEST2_CORE
);

152 
	`¥eg
(
CM_IDLEST3_CORE
);

153 
	`¥eg
(
CM_IDLEST4_CORE
);

154 
	`¥eg
(
CM_IDLEST_GFX
);

155 
	`¥eg
(
CM_IDLEST_WKUP
);

156 
	`¥eg
(
CM_IDLEST_CKGEN
);

157 
	`¥eg
(
CM_IDLEST_DSP
);

158 
	`¥eg
(
CM_IDLEST_MDM
);

160 
	`¥eg
(
RM_RSTST_MPU
);

161 
	`¥eg
(
RM_RSTST_GFX
);

162 
	`¥eg
(
RM_RSTST_WKUP
);

163 
	`¥eg
(
RM_RSTST_DSP
);

164 
	`¥eg
(
RM_RSTST_MDM
);

166 
	`¥eg
(
PM_WKDEP_MPU
);

167 
	`¥eg
(
PM_WKDEP_CORE
);

168 
	`¥eg
(
PM_WKDEP_GFX
);

169 
	`¥eg
(
PM_WKDEP_DSP
);

170 
	`¥eg
(
PM_WKDEP_MDM
);

172 
	`¥eg
(
CM_FCLKEN_WKUP
);

173 
	`¥eg
(
CM_ICLKEN_WKUP
);

174 
	`¥eg
(
CM_IDLEST_WKUP
);

175 
	`¥eg
(
CM_AUTOIDLE_WKUP
);

176 
	`¥eg
(
CM_CLKSEL_WKUP
);

178 
	`¥eg
(
PM_WKEN_WKUP
);

179 
	`¥eg
(
PM_WKST_WKUP
);

180 
	}
}

182 
ölöe
 
	$om≠2_pm_ßve_ªgi°îs
()

185 
	`OMAP24XX_SAVE
(
INTC_MIR0
);

186 
	`OMAP24XX_SAVE
(
INTC_MIR1
);

187 
	`OMAP24XX_SAVE
(
INTC_MIR2
);

190 
	`OMAP24XX_SAVE
(
CM_CLKSTCTRL_MPU
);

191 
	`OMAP24XX_SAVE
(
CM_CLKSTCTRL_CORE
);

192 
	`OMAP24XX_SAVE
(
CM_CLKSTCTRL_GFX
);

193 
	`OMAP24XX_SAVE
(
CM_CLKSTCTRL_DSP
);

194 
	`OMAP24XX_SAVE
(
CM_CLKSTCTRL_MDM
);

197 
	`OMAP24XX_SAVE
(
PM_PWSTCTRL_MPU
);

198 
	`OMAP24XX_SAVE
(
PM_PWSTCTRL_CORE
);

199 
	`OMAP24XX_SAVE
(
PM_PWSTCTRL_GFX
);

200 
	`OMAP24XX_SAVE
(
PM_PWSTCTRL_DSP
);

201 
	`OMAP24XX_SAVE
(
PM_PWSTCTRL_MDM
);

204 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE1_CORE
);

205 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE2_CORE
);

206 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE3_CORE
);

207 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE4_CORE
);

208 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE_WKUP
);

209 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE_PLL
);

210 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE_DSP
);

211 
	`OMAP24XX_SAVE
(
CM_AUTOIDLE_MDM
);

214 
	`OMAP24XX_SAVE
(
CM_IDLEST1_CORE
);

215 
	`OMAP24XX_SAVE
(
CM_IDLEST2_CORE
);

216 
	`OMAP24XX_SAVE
(
CM_IDLEST3_CORE
);

217 
	`OMAP24XX_SAVE
(
CM_IDLEST4_CORE
);

218 
	`OMAP24XX_SAVE
(
CM_IDLEST_GFX
);

219 
	`OMAP24XX_SAVE
(
CM_IDLEST_WKUP
);

220 
	`OMAP24XX_SAVE
(
CM_IDLEST_CKGEN
);

221 
	`OMAP24XX_SAVE
(
CM_IDLEST_DSP
);

222 
	`OMAP24XX_SAVE
(
CM_IDLEST_MDM
);

225 
	`OMAP24XX_SAVE
(
CM_FCLKEN1_CORE
);

226 
	`OMAP24XX_SAVE
(
CM_FCLKEN2_CORE
);

227 
	`OMAP24XX_SAVE
(
CM_ICLKEN1_CORE
);

228 
	`OMAP24XX_SAVE
(
CM_ICLKEN2_CORE
);

229 
	`OMAP24XX_SAVE
(
CM_ICLKEN3_CORE
);

230 
	`OMAP24XX_SAVE
(
CM_ICLKEN4_CORE
);

231 
	}
}

233 
ölöe
 
	$om≠2_pm_ª°‹e_ªgi°îs
()

236 
	`OMAP24XX_RESTORE
(
CM_CLKSTCTRL_MPU
);

237 
	`OMAP24XX_RESTORE
(
CM_CLKSTCTRL_CORE
);

238 
	`OMAP24XX_RESTORE
(
CM_CLKSTCTRL_GFX
);

239 
	`OMAP24XX_RESTORE
(
CM_CLKSTCTRL_DSP
);

240 
	`OMAP24XX_RESTORE
(
CM_CLKSTCTRL_MDM
);

243 
	`OMAP24XX_RESTORE
(
PM_PWSTCTRL_MPU
);

244 
	`OMAP24XX_RESTORE
(
PM_PWSTCTRL_CORE
);

245 
	`OMAP24XX_RESTORE
(
PM_PWSTCTRL_GFX
);

246 
	`OMAP24XX_RESTORE
(
PM_PWSTCTRL_DSP
);

247 
	`OMAP24XX_RESTORE
(
PM_PWSTCTRL_MDM
);

250 
	`OMAP24XX_RESTORE
(
CM_IDLEST1_CORE
);

251 
	`OMAP24XX_RESTORE
(
CM_IDLEST2_CORE
);

252 
	`OMAP24XX_RESTORE
(
CM_IDLEST3_CORE
);

253 
	`OMAP24XX_RESTORE
(
CM_IDLEST4_CORE
);

254 
	`OMAP24XX_RESTORE
(
CM_IDLEST_GFX
);

255 
	`OMAP24XX_RESTORE
(
CM_IDLEST_WKUP
);

256 
	`OMAP24XX_RESTORE
(
CM_IDLEST_CKGEN
);

257 
	`OMAP24XX_RESTORE
(
CM_IDLEST_DSP
);

258 
	`OMAP24XX_RESTORE
(
CM_IDLEST_MDM
);

261 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE1_CORE
);

262 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE2_CORE
);

263 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE3_CORE
);

264 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE4_CORE
);

265 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE_WKUP
);

266 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE_PLL
);

267 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE_DSP
);

268 
	`OMAP24XX_RESTORE
(
CM_AUTOIDLE_MDM
);

271 
	`OMAP24XX_RESTORE
(
CM_FCLKEN1_CORE
);

272 
	`OMAP24XX_RESTORE
(
CM_FCLKEN2_CORE
);

273 
	`OMAP24XX_RESTORE
(
CM_ICLKEN1_CORE
);

274 
	`OMAP24XX_RESTORE
(
CM_ICLKEN2_CORE
);

275 
	`OMAP24XX_RESTORE
(
CM_ICLKEN3_CORE
);

276 
	`OMAP24XX_RESTORE
(
CM_ICLKEN4_CORE
);

281 
	`OMAP24XX_RESTORE
(
INTC_MIR0
);

282 
	`OMAP24XX_RESTORE
(
INTC_MIR1
);

283 
	`OMAP24XX_RESTORE
(
INTC_MIR2
);

284 
	}
}

286 
	$om≠2_pm_su•íd
()

288 
¥o˚ss‹_ty≥
 = 0;

291 i‡(
	`˝u_is_om≠2420
())

292 
¥o˚ss‹_ty≥
 = 0x21;

294 i‡(!
¥o˚ss‹_ty≥
)

295  -
ENOTSUPP
;

297 
	`loˇl_úq_dißbÀ
();

298 
	`loˇl_fiq_dißbÀ
();

300 
	`om≠2_pm_ßve_ªgi°îs
();

303 
INTC_MIR_SET0
 = 0xfffffff‡& ~
INT0_WAKE_MASK
;

304 
INTC_MIR_SET1
 = 0xfffffff‡& ~
INT1_WAKE_MASK
;

305 
INTC_MIR_SET2
 = 0xfffffff‡& ~
INT2_WAKE_MASK
;

307 
	`pmdomaö_£t_autoidÀ
();

310 
PM_WKST1_CORE
 = 0;

311 
PM_WKST2_CORE
 = 0;

312 
PM_WKST_WKUP
 = 0;

315 
PM_WKEN1_CORE
 = (1 << 22) | (1 << 21);

316 
PM_WKEN2_CORE
 = (1 << 2);

317 
PM_WKEN_WKUP
 = (1 << 2) | (1 << 0);

321 
CM_FCLKEN1_CORE
 = 0;

322 
CM_FCLKEN2_CORE
 = 0;

323 
CM_ICLKEN1_CORE
 = 0;

324 
CM_ICLKEN3_CORE
 = 0;

325 
CM_ICLKEN4_CORE
 = 0;

327 
	`om≠2_pm_debug
("Status before suspend");

330 
	`mdñay
(200);

335 
	`om≠2_§am_su•íd
(
SDRC_DLLA_CTRL
, 
¥o˚ss‹_ty≥
);

338 
	`om≠2_pm_ª°‹e_ªgi°îs
();

340 
	`loˇl_fiq_íabÀ
();

341 
	`loˇl_úq_íabÀ
();

344 
	}
}

346 
	$om≠2_pm_íãr
(
su•íd_°©e_t
 
°©e
)

348 
ªt
 = 0;

350 
°©e
)

352 
PM_SUSPEND_STANDBY
:

353 
PM_SUSPEND_MEM
:

354 
ªt
 = 
	`om≠2_pm_su•íd
();

356 
PM_SUSPEND_DISK
:

357 
ªt
 = -
ENOTSUPP
;

360 
ªt
 = -
EINVAL
;

363  
ªt
;

364 
	}
}

366 
	$om≠2_pm_föish
(
su•íd_°©e_t
 
°©e
)

368 
pm_idÀ
 = 
ßved_idÀ
;

370 
	}
}

372 
pm_›s
 
	gom≠_pm_›s
 = {

373 .
¥ï¨e
 = 
om≠2_pm_¥ï¨e
,

374 .
	gíãr
 = 
om≠2_pm_íãr
,

375 .
	gföish
 = 
om≠2_pm_föish
,

376 .
	gvÆid
 = 
pm_vÆid_⁄ly_mem
,

379 
__öô
 
	$om≠2_pm_öô
()

381 
	`¥ötk
("Power Management for TI OMAP.\n");

383 
v˛k
 = 
	`˛k_gë
(
NULL
, "virt_prcm_set");

384 i‡(
	`IS_ERR
(
v˛k
)) {

385 
	`¥ötk
(
KERN_ERR
 "CouldÇot get PM vclk\n");

386  -
ENODEV
;

394 
om≠2_§am_idÀ
 = 
	`om≠_§am_push
(
om≠24xx_idÀ_lo›_su•íd
,

395 
om≠24xx_idÀ_lo›_su•íd_sz
);

397 
om≠2_§am_su•íd
 = 
	`om≠_§am_push
(
om≠24xx_˝u_su•íd
,

398 
om≠24xx_˝u_su•íd_sz
);

400 
	`pm_£t_›s
(&
om≠_pm_›s
);

401 
pm_idÀ
 = 
om≠2_pm_idÀ
;

403 
	`pmdomaö_öô
();

406 
	}
}

408 
__öôˇŒ
(
om≠2_pm_öô
);

	@arch/arm/mach-omap2/prcm-regs.h

23 #i‚de‡
__ARCH_ARM_MACH_OMAP2_PRCM_H


24 
	#__ARCH_ARM_MACH_OMAP2_PRCM_H


	)

27 
	#PRCM_HALF_SPEED
 1

	)

28 
	#PRCM_FULL_SPEED
 2

	)

30 #i‚de‡
__ASSEMBLER__


32 
	#PRCM_REG32
(
off£t
Ë
	`__REG32
(
OMAP24XX_PRCM_BASE
 + (off£t))

	)

34 
	#PRCM_REVISION
 
	`PRCM_REG32
(0x000)

	)

35 
	#PRCM_SYSCONFIG
 
	`PRCM_REG32
(0x010)

	)

36 
	#PRCM_IRQSTATUS_MPU
 
	`PRCM_REG32
(0x018)

	)

37 
	#PRCM_IRQENABLE_MPU
 
	`PRCM_REG32
(0x01C)

	)

38 
	#PRCM_VOLTCTRL
 
	`PRCM_REG32
(0x050)

	)

39 
	#PRCM_VOLTST
 
	`PRCM_REG32
(0x054)

	)

40 
	#PRCM_CLKSRC_CTRL
 
	`PRCM_REG32
(0x060)

	)

41 
	#PRCM_CLKOUT_CTRL
 
	`PRCM_REG32
(0x070)

	)

42 
	#PRCM_CLKEMUL_CTRL
 
	`PRCM_REG32
(0x078)

	)

43 
	#PRCM_CLKCFG_CTRL
 
	`PRCM_REG32
(0x080)

	)

44 
	#PRCM_CLKCFG_STATUS
 
	`PRCM_REG32
(0x084)

	)

45 
	#PRCM_VOLTSETUP
 
	`PRCM_REG32
(0x090)

	)

46 
	#PRCM_CLKSSETUP
 
	`PRCM_REG32
(0x094)

	)

47 
	#PRCM_POLCTRL
 
	`PRCM_REG32
(0x098)

	)

50 
	#GENERAL_PURPOSE1
 
	`PRCM_REG32
(0x0B0)

	)

51 
	#GENERAL_PURPOSE2
 
	`PRCM_REG32
(0x0B4)

	)

52 
	#GENERAL_PURPOSE3
 
	`PRCM_REG32
(0x0B8)

	)

53 
	#GENERAL_PURPOSE4
 
	`PRCM_REG32
(0x0BC)

	)

54 
	#GENERAL_PURPOSE5
 
	`PRCM_REG32
(0x0C0)

	)

55 
	#GENERAL_PURPOSE6
 
	`PRCM_REG32
(0x0C4)

	)

56 
	#GENERAL_PURPOSE7
 
	`PRCM_REG32
(0x0C8)

	)

57 
	#GENERAL_PURPOSE8
 
	`PRCM_REG32
(0x0CC)

	)

58 
	#GENERAL_PURPOSE9
 
	`PRCM_REG32
(0x0D0)

	)

59 
	#GENERAL_PURPOSE10
 
	`PRCM_REG32
(0x0D4)

	)

60 
	#GENERAL_PURPOSE11
 
	`PRCM_REG32
(0x0D8)

	)

61 
	#GENERAL_PURPOSE12
 
	`PRCM_REG32
(0x0DC)

	)

62 
	#GENERAL_PURPOSE13
 
	`PRCM_REG32
(0x0E0)

	)

63 
	#GENERAL_PURPOSE14
 
	`PRCM_REG32
(0x0E4)

	)

64 
	#GENERAL_PURPOSE15
 
	`PRCM_REG32
(0x0E8)

	)

65 
	#GENERAL_PURPOSE16
 
	`PRCM_REG32
(0x0EC)

	)

66 
	#GENERAL_PURPOSE17
 
	`PRCM_REG32
(0x0F0)

	)

67 
	#GENERAL_PURPOSE18
 
	`PRCM_REG32
(0x0F4)

	)

68 
	#GENERAL_PURPOSE19
 
	`PRCM_REG32
(0x0F8)

	)

69 
	#GENERAL_PURPOSE20
 
	`PRCM_REG32
(0x0FC)

	)

72 
	#CM_CLKSEL_MPU
 
	`PRCM_REG32
(0x140)

	)

73 
	#CM_CLKSTCTRL_MPU
 
	`PRCM_REG32
(0x148)

	)

74 
	#RM_RSTST_MPU
 
	`PRCM_REG32
(0x158)

	)

75 
	#PM_WKDEP_MPU
 
	`PRCM_REG32
(0x1C8)

	)

76 
	#PM_EVGENCTRL_MPU
 
	`PRCM_REG32
(0x1D4)

	)

77 
	#PM_EVEGENONTIM_MPU
 
	`PRCM_REG32
(0x1D8)

	)

78 
	#PM_EVEGENOFFTIM_MPU
 
	`PRCM_REG32
(0x1DC)

	)

79 
	#PM_PWSTCTRL_MPU
 
	`PRCM_REG32
(0x1E0)

	)

80 
	#PM_PWSTST_MPU
 
	`PRCM_REG32
(0x1E4)

	)

83 
	#CM_FCLKEN1_CORE
 
	`PRCM_REG32
(0x200)

	)

84 
	#CM_FCLKEN2_CORE
 
	`PRCM_REG32
(0x204)

	)

85 
	#CM_FCLKEN3_CORE
 
	`PRCM_REG32
(0x208)

	)

86 
	#CM_ICLKEN1_CORE
 
	`PRCM_REG32
(0x210)

	)

87 
	#CM_ICLKEN2_CORE
 
	`PRCM_REG32
(0x214)

	)

88 
	#CM_ICLKEN3_CORE
 
	`PRCM_REG32
(0x218)

	)

89 
	#CM_ICLKEN4_CORE
 
	`PRCM_REG32
(0x21C)

	)

90 
	#CM_IDLEST1_CORE
 
	`PRCM_REG32
(0x220)

	)

91 
	#CM_IDLEST2_CORE
 
	`PRCM_REG32
(0x224)

	)

92 
	#CM_IDLEST3_CORE
 
	`PRCM_REG32
(0x228)

	)

93 
	#CM_IDLEST4_CORE
 
	`PRCM_REG32
(0x22C)

	)

94 
	#CM_AUTOIDLE1_CORE
 
	`PRCM_REG32
(0x230)

	)

95 
	#CM_AUTOIDLE2_CORE
 
	`PRCM_REG32
(0x234)

	)

96 
	#CM_AUTOIDLE3_CORE
 
	`PRCM_REG32
(0x238)

	)

97 
	#CM_AUTOIDLE4_CORE
 
	`PRCM_REG32
(0x23C)

	)

98 
	#CM_CLKSEL1_CORE
 
	`PRCM_REG32
(0x240)

	)

99 
	#CM_CLKSEL2_CORE
 
	`PRCM_REG32
(0x244)

	)

100 
	#CM_CLKSTCTRL_CORE
 
	`PRCM_REG32
(0x248)

	)

101 
	#PM_WKEN1_CORE
 
	`PRCM_REG32
(0x2A0)

	)

102 
	#PM_WKEN2_CORE
 
	`PRCM_REG32
(0x2A4)

	)

103 
	#PM_WKST1_CORE
 
	`PRCM_REG32
(0x2B0)

	)

104 
	#PM_WKST2_CORE
 
	`PRCM_REG32
(0x2B4)

	)

105 
	#PM_WKDEP_CORE
 
	`PRCM_REG32
(0x2C8)

	)

106 
	#PM_PWSTCTRL_CORE
 
	`PRCM_REG32
(0x2E0)

	)

107 
	#PM_PWSTST_CORE
 
	`PRCM_REG32
(0x2E4)

	)

110 
	#CM_FCLKEN_GFX
 
	`PRCM_REG32
(0x300)

	)

111 
	#CM_ICLKEN_GFX
 
	`PRCM_REG32
(0x310)

	)

112 
	#CM_IDLEST_GFX
 
	`PRCM_REG32
(0x320)

	)

113 
	#CM_CLKSEL_GFX
 
	`PRCM_REG32
(0x340)

	)

114 
	#CM_CLKSTCTRL_GFX
 
	`PRCM_REG32
(0x348)

	)

115 
	#RM_RSTCTRL_GFX
 
	`PRCM_REG32
(0x350)

	)

116 
	#RM_RSTST_GFX
 
	`PRCM_REG32
(0x358)

	)

117 
	#PM_WKDEP_GFX
 
	`PRCM_REG32
(0x3C8)

	)

118 
	#PM_PWSTCTRL_GFX
 
	`PRCM_REG32
(0x3E0)

	)

119 
	#PM_PWSTST_GFX
 
	`PRCM_REG32
(0x3E4)

	)

122 
	#CM_FCLKEN_WKUP
 
	`PRCM_REG32
(0x400)

	)

123 
	#CM_ICLKEN_WKUP
 
	`PRCM_REG32
(0x410)

	)

124 
	#CM_IDLEST_WKUP
 
	`PRCM_REG32
(0x420)

	)

125 
	#CM_AUTOIDLE_WKUP
 
	`PRCM_REG32
(0x430)

	)

126 
	#CM_CLKSEL_WKUP
 
	`PRCM_REG32
(0x440)

	)

127 
	#RM_RSTCTRL_WKUP
 
	`PRCM_REG32
(0x450)

	)

128 
	#RM_RSTTIME_WKUP
 
	`PRCM_REG32
(0x454)

	)

129 
	#RM_RSTST_WKUP
 
	`PRCM_REG32
(0x458)

	)

130 
	#PM_WKEN_WKUP
 
	`PRCM_REG32
(0x4A0)

	)

131 
	#PM_WKST_WKUP
 
	`PRCM_REG32
(0x4B0)

	)

134 
	#CM_CLKEN_PLL
 
	`PRCM_REG32
(0x500)

	)

135 
	#CM_IDLEST_CKGEN
 
	`PRCM_REG32
(0x520)

	)

136 
	#CM_AUTOIDLE_PLL
 
	`PRCM_REG32
(0x530)

	)

137 
	#CM_CLKSEL1_PLL
 
	`PRCM_REG32
(0x540)

	)

138 
	#CM_CLKSEL2_PLL
 
	`PRCM_REG32
(0x544)

	)

141 
	#CM_FCLKEN_DSP
 
	`PRCM_REG32
(0x800)

	)

142 
	#CM_ICLKEN_DSP
 
	`PRCM_REG32
(0x810)

	)

143 
	#CM_IDLEST_DSP
 
	`PRCM_REG32
(0x820)

	)

144 
	#CM_AUTOIDLE_DSP
 
	`PRCM_REG32
(0x830)

	)

145 
	#CM_CLKSEL_DSP
 
	`PRCM_REG32
(0x840)

	)

146 
	#CM_CLKSTCTRL_DSP
 
	`PRCM_REG32
(0x848)

	)

147 
	#RM_RSTCTRL_DSP
 
	`PRCM_REG32
(0x850)

	)

148 
	#RM_RSTST_DSP
 
	`PRCM_REG32
(0x858)

	)

149 
	#PM_WKEN_DSP
 
	`PRCM_REG32
(0x8A0)

	)

150 
	#PM_WKDEP_DSP
 
	`PRCM_REG32
(0x8C8)

	)

151 
	#PM_PWSTCTRL_DSP
 
	`PRCM_REG32
(0x8E0)

	)

152 
	#PM_PWSTST_DSP
 
	`PRCM_REG32
(0x8E4)

	)

153 
	#PRCM_IRQSTATUS_DSP
 
	`PRCM_REG32
(0x8F0)

	)

154 
	#PRCM_IRQENABLE_DSP
 
	`PRCM_REG32
(0x8F4)

	)

157 
	#PRCM_IRQSTATUS_IVA
 
	`PRCM_REG32
(0x8F8)

	)

158 
	#PRCM_IRQENABLE_IVA
 
	`PRCM_REG32
(0x8FC)

	)

161 
	#CM_FCLKEN_MDM
 
	`PRCM_REG32
(0xC00)

	)

162 
	#CM_ICLKEN_MDM
 
	`PRCM_REG32
(0xC10)

	)

163 
	#CM_IDLEST_MDM
 
	`PRCM_REG32
(0xC20)

	)

164 
	#CM_AUTOIDLE_MDM
 
	`PRCM_REG32
(0xC30)

	)

165 
	#CM_CLKSEL_MDM
 
	`PRCM_REG32
(0xC40)

	)

166 
	#CM_CLKSTCTRL_MDM
 
	`PRCM_REG32
(0xC48)

	)

167 
	#RM_RSTCTRL_MDM
 
	`PRCM_REG32
(0xC50)

	)

168 
	#RM_RSTST_MDM
 
	`PRCM_REG32
(0xC58)

	)

169 
	#PM_WKEN_MDM
 
	`PRCM_REG32
(0xCA0)

	)

170 
	#PM_WKST_MDM
 
	`PRCM_REG32
(0xCB0)

	)

171 
	#PM_WKDEP_MDM
 
	`PRCM_REG32
(0xCC8)

	)

172 
	#PM_PWSTCTRL_MDM
 
	`PRCM_REG32
(0xCE0)

	)

173 
	#PM_PWSTST_MDM
 
	`PRCM_REG32
(0xCE4)

	)

175 
	#OMAP24XX_L4_IO_BASE
 0x48000000

	)

177 
	#DISP_BASE
 (
OMAP24XX_L4_IO_BASE
 + 0x50000)

	)

178 
	#DISP_REG32
(
off£t
Ë
	`__REG32
(
DISP_BASE
 + (off£t))

	)

180 
	#OMAP24XX_GPMC_BASE
 (
L3_24XX_BASE
 + 0xa000)

	)

181 
	#GPMC_REG32
(
off£t
Ë
	`__REG32
(
OMAP24XX_GPMC_BASE
 + (off£t))

	)

184 
	#GPT1_BASE
 (0x48028000)

	)

185 
	#GPT1_REG32
(
off£t
Ë
	`__REG32
(
GPT1_BASE
 + (off£t))

	)

188 
	#DISPC_SYSCONFIG
 
	`DISP_REG32
(0x410)

	)

189 
	#SPI_BASE
 (
OMAP24XX_L4_IO_BASE
 + 0x98000)

	)

190 
	#MCSPI1_SYSCONFIG
 
	`__REG32
(
SPI_BASE
 + 0x10)

	)

191 
	#MCSPI2_SYSCONFIG
 
	`__REG32
(
SPI_BASE
 + 0x2000 + 0x10)

	)

192 
	#MCSPI3_SYSCONFIG
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0xb8010)

	)

194 
	#CAMERA_MMU_SYSCONFIG
 
	`__REG32
(
DISP_BASE
 + 0x2C10)

	)

195 
	#CAMERA_DMA_SYSCONFIG
 
	`__REG32
(
DISP_BASE
 + 0x282C)

	)

196 
	#SYSTEM_DMA_SYSCONFIG
 
	`__REG32
(
DISP_BASE
 + 0x602C)

	)

197 
	#GPMC_SYSCONFIG
 
	`GPMC_REG32
(0x010)

	)

198 
	#MAILBOXES_SYSCONFIG
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0x94010)

	)

199 
	#UART1_SYSCONFIG
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0x6A054)

	)

200 
	#UART2_SYSCONFIG
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0x6C054)

	)

201 
	#UART3_SYSCONFIG
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0x6E054)

	)

202 
	#SDRC_SYSCONFIG
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x10)

	)

203 
	#OMAP24XX_SMS_BASE
 (
L3_24XX_BASE
 + 0x8000)

	)

204 
	#SMS_SYSCONFIG
 
	`__REG32
(
OMAP24XX_SMS_BASE
 + 0x10)

	)

205 
	#SSI_SYSCONFIG
 
	`__REG32
(
DISP_BASE
 + 0x8010)

	)

208 
	#OMAP24XX_GPT2
 (
OMAP24XX_L4_IO_BASE
 + 0x2A000)

	)

209 
	#OMAP24XX_GPT3
 (
OMAP24XX_L4_IO_BASE
 + 0x78000)

	)

210 
	#OMAP24XX_GPT4
 (
OMAP24XX_L4_IO_BASE
 + 0x7A000)

	)

211 
	#OMAP24XX_GPT5
 (
OMAP24XX_L4_IO_BASE
 + 0x7C000)

	)

212 
	#OMAP24XX_GPT6
 (
OMAP24XX_L4_IO_BASE
 + 0x7E000)

	)

213 
	#OMAP24XX_GPT7
 (
OMAP24XX_L4_IO_BASE
 + 0x80000)

	)

214 
	#OMAP24XX_GPT8
 (
OMAP24XX_L4_IO_BASE
 + 0x82000)

	)

215 
	#OMAP24XX_GPT9
 (
OMAP24XX_L4_IO_BASE
 + 0x84000)

	)

216 
	#OMAP24XX_GPT10
 (
OMAP24XX_L4_IO_BASE
 + 0x86000)

	)

217 
	#OMAP24XX_GPT11
 (
OMAP24XX_L4_IO_BASE
 + 0x88000)

	)

218 
	#OMAP24XX_GPT12
 (
OMAP24XX_L4_IO_BASE
 + 0x8A000)

	)

221 
	#GPTIMER1_SYSCONFIG
 
	`GPT1_REG32
(0x010)

	)

222 
	#GPTIMER2_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT2
 + 0x10)

	)

223 
	#GPTIMER3_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT3
 + 0x10)

	)

224 
	#GPTIMER4_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT4
 + 0x10)

	)

225 
	#GPTIMER5_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT5
 + 0x10)

	)

226 
	#GPTIMER6_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT6
 + 0x10)

	)

227 
	#GPTIMER7_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT7
 + 0x10)

	)

228 
	#GPTIMER8_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT8
 + 0x10)

	)

229 
	#GPTIMER9_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT9
 + 0x10)

	)

230 
	#GPTIMER10_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT10
 + 0x10)

	)

231 
	#GPTIMER11_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT11
 + 0x10)

	)

232 
	#GPTIMER12_SYSCONFIG
 
	`__REG32
(
OMAP24XX_GPT12
 + 0x10)

	)

235 
	#OMAP24XX_GPIO_BASE
 0x48018000

	)

236 
	#GPIOX_BASE
(
X
Ë(
OMAP24XX_GPIO_BASE
 + (0x2000 * ((XË- 1)))

	)

238 
	#GPIO1_SYSCONFIG
 
	`__REG32
((
	`GPIOX_BASE
(1Ë+ 0x10))

	)

239 
	#GPIO2_SYSCONFIG
 
	`__REG32
((
	`GPIOX_BASE
(2Ë+ 0x10))

	)

240 
	#GPIO3_SYSCONFIG
 
	`__REG32
((
	`GPIOX_BASE
(3Ë+ 0x10))

	)

241 
	#GPIO4_SYSCONFIG
 
	`__REG32
((
	`GPIOX_BASE
(4Ë+ 0x10))

	)

243 #i‡
deföed
(
CONFIG_ARCH_OMAP243X
)

244 
	#GPIO5_SYSCONFIG
 
	`__REG32
((
OMAP24XX_GPIO5_BASE
 + 0x10))

	)

248 
	#GPTIMER1_TISTAT
 
	`GPT1_REG32
(0x014)

	)

249 
	#GPTIMER1_TISR
 
	`GPT1_REG32
(0x018)

	)

250 
	#GPTIMER1_TIER
 
	`GPT1_REG32
(0x01C)

	)

251 
	#GPTIMER1_TWER
 
	`GPT1_REG32
(0x020)

	)

252 
	#GPTIMER1_TCLR
 
	`GPT1_REG32
(0x024)

	)

253 
	#GPTIMER1_TCRR
 
	`GPT1_REG32
(0x028)

	)

254 
	#GPTIMER1_TLDR
 
	`GPT1_REG32
(0x02C)

	)

255 
	#GPTIMER1_TTGR
 
	`GPT1_REG32
(0x030)

	)

256 
	#GPTIMER1_TWPS
 
	`GPT1_REG32
(0x034)

	)

257 
	#GPTIMER1_TMAR
 
	`GPT1_REG32
(0x038)

	)

258 
	#GPTIMER1_TCAR1
 
	`GPT1_REG32
(0x03C)

	)

259 
	#GPTIMER1_TSICR
 
	`GPT1_REG32
(0x040)

	)

260 
	#GPTIMER1_TCAR2
 
	`GPT1_REG32
(0x044)

	)

263 
	#GPTIMER3_TISR
 
	`__REG32
(
OMAP24XX_L4_IO_BASE
 + 0x78018)

	)

266 
	#SDRC_DLLA_CTRL
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x060)

	)

267 
	#SDRC_DLLA_STATUS
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x064)

	)

268 
	#SDRC_DLLB_CTRL
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x068)

	)

269 
	#SDRC_DLLB_STATUS
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x06C)

	)

270 
	#SDRC_POWER
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x070)

	)

271 
	#SDRC_MR_0
 
	`__REG32
(
OMAP24XX_SDRC_BASE
 + 0x084)

	)

274 
	#GPIO1_BASE
 
	`GPIOX_BASE
(1)

	)

275 
	#GPIO1_REG32
(
off£t
Ë
	`__REG32
(
GPIO1_BASE
 + (off£t))

	)

276 
	#GPIO1_IRQENABLE1
 
	`GPIO1_REG32
(0x01C)

	)

277 
	#GPIO1_IRQSTATUS1
 
	`GPIO1_REG32
(0x018)

	)

278 
	#GPIO1_IRQENABLE2
 
	`GPIO1_REG32
(0x02C)

	)

279 
	#GPIO1_IRQSTATUS2
 
	`GPIO1_REG32
(0x028)

	)

280 
	#GPIO1_WAKEUPENABLE
 
	`GPIO1_REG32
(0x020)

	)

281 
	#GPIO1_RISINGDETECT
 
	`GPIO1_REG32
(0x048)

	)

282 
	#GPIO1_DATAIN
 
	`GPIO1_REG32
(0x038)

	)

283 
	#GPIO1_OE
 
	`GPIO1_REG32
(0x034)

	)

284 
	#GPIO1_DATAOUT
 
	`GPIO1_REG32
(0x03C)

	)

287 
	#GPIO2_BASE
 
	`GPIOX_BASE
(2)

	)

288 
	#GPIO2_REG32
(
off£t
Ë
	`__REG32
(
GPIO2_BASE
 + (off£t))

	)

289 
	#GPIO2_IRQENABLE1
 
	`GPIO2_REG32
(0x01C)

	)

290 
	#GPIO2_IRQSTATUS1
 
	`GPIO2_REG32
(0x018)

	)

291 
	#GPIO2_IRQENABLE2
 
	`GPIO2_REG32
(0x02C)

	)

292 
	#GPIO2_IRQSTATUS2
 
	`GPIO2_REG32
(0x028)

	)

293 
	#GPIO2_WAKEUPENABLE
 
	`GPIO2_REG32
(0x020)

	)

294 
	#GPIO2_RISINGDETECT
 
	`GPIO2_REG32
(0x048)

	)

295 
	#GPIO2_DATAIN
 
	`GPIO2_REG32
(0x038)

	)

296 
	#GPIO2_OE
 
	`GPIO2_REG32
(0x034)

	)

297 
	#GPIO2_DATAOUT
 
	`GPIO2_REG32
(0x03C)

	)

298 
	#GPIO2_DEBOUNCENABLE
 
	`GPIO2_REG32
(0x050)

	)

299 
	#GPIO2_DEBOUNCINGTIME
 
	`GPIO2_REG32
(0x054)

	)

302 
	#GPIO3_BASE
 
	`GPIOX_BASE
(3)

	)

303 
	#GPIO3_REG32
(
off£t
Ë
	`__REG32
(
GPIO3_BASE
 + (off£t))

	)

304 
	#GPIO3_IRQENABLE1
 
	`GPIO3_REG32
(0x01C)

	)

305 
	#GPIO3_IRQSTATUS1
 
	`GPIO3_REG32
(0x018)

	)

306 
	#GPIO3_IRQENABLE2
 
	`GPIO3_REG32
(0x02C)

	)

307 
	#GPIO3_IRQSTATUS2
 
	`GPIO3_REG32
(0x028)

	)

308 
	#GPIO3_WAKEUPENABLE
 
	`GPIO3_REG32
(0x020)

	)

309 
	#GPIO3_RISINGDETECT
 
	`GPIO3_REG32
(0x048)

	)

310 
	#GPIO3_FALLINGDETECT
 
	`GPIO3_REG32
(0x04C)

	)

311 
	#GPIO3_DATAIN
 
	`GPIO3_REG32
(0x038)

	)

312 
	#GPIO3_OE
 
	`GPIO3_REG32
(0x034)

	)

313 
	#GPIO3_DATAOUT
 
	`GPIO3_REG32
(0x03C)

	)

314 
	#GPIO3_DEBOUNCENABLE
 
	`GPIO3_REG32
(0x050)

	)

315 
	#GPIO3_DEBOUNCINGTIME
 
	`GPIO3_REG32
(0x054)

	)

316 
	#GPIO3_DEBOUNCENABLE
 
	`GPIO3_REG32
(0x050)

	)

317 
	#GPIO3_DEBOUNCINGTIME
 
	`GPIO3_REG32
(0x054)

	)

320 
	#GPIO4_BASE
 
	`GPIOX_BASE
(4)

	)

321 
	#GPIO4_REG32
(
off£t
Ë
	`__REG32
(
GPIO4_BASE
 + (off£t))

	)

322 
	#GPIO4_IRQENABLE1
 
	`GPIO4_REG32
(0x01C)

	)

323 
	#GPIO4_IRQSTATUS1
 
	`GPIO4_REG32
(0x018)

	)

324 
	#GPIO4_IRQENABLE2
 
	`GPIO4_REG32
(0x02C)

	)

325 
	#GPIO4_IRQSTATUS2
 
	`GPIO4_REG32
(0x028)

	)

326 
	#GPIO4_WAKEUPENABLE
 
	`GPIO4_REG32
(0x020)

	)

327 
	#GPIO4_RISINGDETECT
 
	`GPIO4_REG32
(0x048)

	)

328 
	#GPIO4_FALLINGDETECT
 
	`GPIO4_REG32
(0x04C)

	)

329 
	#GPIO4_DATAIN
 
	`GPIO4_REG32
(0x038)

	)

330 
	#GPIO4_OE
 
	`GPIO4_REG32
(0x034)

	)

331 
	#GPIO4_DATAOUT
 
	`GPIO4_REG32
(0x03C)

	)

332 
	#GPIO4_DEBOUNCENABLE
 
	`GPIO4_REG32
(0x050)

	)

333 
	#GPIO4_DEBOUNCINGTIME
 
	`GPIO4_REG32
(0x054)

	)

335 #i‡
deföed
(
CONFIG_ARCH_OMAP243X
)

337 
	#GPIO5_REG32
(
off£t
Ë
	`__REG32
((
OMAP24XX_GPIO5_BASE
 + (off£t)))

	)

338 
	#GPIO5_IRQENABLE1
 
	`GPIO5_REG32
(0x01C)

	)

339 
	#GPIO5_IRQSTATUS1
 
	`GPIO5_REG32
(0x018)

	)

340 
	#GPIO5_IRQENABLE2
 
	`GPIO5_REG32
(0x02C)

	)

341 
	#GPIO5_IRQSTATUS2
 
	`GPIO5_REG32
(0x028)

	)

342 
	#GPIO5_WAKEUPENABLE
 
	`GPIO5_REG32
(0x020)

	)

343 
	#GPIO5_RISINGDETECT
 
	`GPIO5_REG32
(0x048)

	)

344 
	#GPIO5_FALLINGDETECT
 
	`GPIO5_REG32
(0x04C)

	)

345 
	#GPIO5_DATAIN
 
	`GPIO5_REG32
(0x038)

	)

346 
	#GPIO5_OE
 
	`GPIO5_REG32
(0x034)

	)

347 
	#GPIO5_DATAOUT
 
	`GPIO5_REG32
(0x03C)

	)

348 
	#GPIO5_DEBOUNCENABLE
 
	`GPIO5_REG32
(0x050)

	)

349 
	#GPIO5_DEBOUNCINGTIME
 
	`GPIO5_REG32
(0x054)

	)

353 
	#OMAP24XX_CTRL_BASE
 (
L4_24XX_BASE
)

	)

354 
	#CONTROL_REG32
(
off£t
Ë
	`__REG32
(
OMAP24XX_CTRL_BASE
 + (off£t))

	)

356 
	#CONTROL_PADCONF_SPI1_NCS2
 
	`CONTROL_REG32
(0x104)

	)

357 
	#CONTROL_PADCONF_SYS_XTALOUT
 
	`CONTROL_REG32
(0x134)

	)

358 
	#CONTROL_PADCONF_UART1_RX
 
	`CONTROL_REG32
(0x0C8)

	)

359 
	#CONTROL_PADCONF_MCBSP1_DX
 
	`CONTROL_REG32
(0x10C)

	)

360 
	#CONTROL_PADCONF_GPMC_NCS4
 
	`CONTROL_REG32
(0x090)

	)

361 
	#CONTROL_PADCONF_DSS_D5
 
	`CONTROL_REG32
(0x0B8)

	)

362 
	#CONTROL_PADCONF_DSS_D9
 
	`CONTROL_REG32
(0x0BCË

	)

363 
	#CONTROL_PADCONF_DSS_D13
 
	`CONTROL_REG32
(0x0C0)

	)

364 
	#CONTROL_PADCONF_DSS_VSYNC
 
	`CONTROL_REG32
(0x0CC)

	)

365 
	#CONTROL_PADCONF_SYS_NIRQW0
 
	`CONTROL_REG32
(0x0BCË

	)

366 
	#CONTROL_PADCONF_SSI1_FLAG_TX
 
	`CONTROL_REG32
(0x108Ë

	)

369 
	#CONTROL_DEVCONF
 
	`CONTROL_REG32
(0x274)

	)

370 
	#CONTROL_DEVCONF1
 
	`CONTROL_REG32
(0x2E8)

	)

373 
	#INTC_BASE
 ((
L4_24XX_BASE
Ë+ 0x„000)

	)

374 
	#INTC_REG32
(
off£t
Ë
	`__REG32
(
INTC_BASE
 + (off£t))

	)

376 
	#INTC1_U_BASE
 
	`INTC_REG32
(0x000)

	)

377 
	#INTC_MIR0
 
	`INTC_REG32
(0x084)

	)

378 
	#INTC_MIR_SET0
 
	`INTC_REG32
(0x08C)

	)

379 
	#INTC_MIR_CLEAR0
 
	`INTC_REG32
(0x088)

	)

380 
	#INTC_ISR_CLEAR0
 
	`INTC_REG32
(0x094)

	)

381 
	#INTC_MIR1
 
	`INTC_REG32
(0x0A4)

	)

382 
	#INTC_MIR_SET1
 
	`INTC_REG32
(0x0AC)

	)

383 
	#INTC_MIR_CLEAR1
 
	`INTC_REG32
(0x0A8)

	)

384 
	#INTC_ISR_CLEAR1
 
	`INTC_REG32
(0x0B4)

	)

385 
	#INTC_MIR2
 
	`INTC_REG32
(0x0C4)

	)

386 
	#INTC_MIR_SET2
 
	`INTC_REG32
(0x0CC)

	)

387 
	#INTC_MIR_CLEAR2
 
	`INTC_REG32
(0x0C8)

	)

388 
	#INTC_ISR_CLEAR2
 
	`INTC_REG32
(0x0D4)

	)

389 
	#INTC_SIR_IRQ
 
	`INTC_REG32
(0x040)

	)

390 
	#INTC_CONTROL
 
	`INTC_REG32
(0x048)

	)

391 
	#INTC_ILR11
 
	`INTC_REG32
(0x12CË

	)

392 
	#INTC_ILR30
 
	`INTC_REG32
(0x178)

	)

393 
	#INTC_ILR31
 
	`INTC_REG32
(0x17C)

	)

394 
	#INTC_ILR32
 
	`INTC_REG32
(0x180)

	)

395 
	#INTC_ILR37
 
	`INTC_REG32
(0x194Ë

	)

396 
	#INTC_SYSCONFIG
 
	`INTC_REG32
(0x010Ë

	)

399 
	#RAMFW_BASE
 (0x68005000)

	)

400 
	#RAMFW_REG32
(
off£t
Ë
	`__REG32
(
RAMFW_BASE
 + (off£t))

	)

402 
	#RAMFW_REQINFOPERM0
 
	`RAMFW_REG32
(0x048)

	)

403 
	#RAMFW_READPERM0
 
	`RAMFW_REG32
(0x050)

	)

404 
	#RAMFW_WRITEPERM0
 
	`RAMFW_REG32
(0x058)

	)

410 
	#GPMC_CONFIG1_0
 
	`GPMC_REG32
(0x060)

	)

411 
	#GPMC_CONFIG2_0
 
	`GPMC_REG32
(0x064)

	)

412 
	#GPMC_CONFIG3_0
 
	`GPMC_REG32
(0x068)

	)

413 
	#GPMC_CONFIG4_0
 
	`GPMC_REG32
(0x06C)

	)

414 
	#GPMC_CONFIG5_0
 
	`GPMC_REG32
(0x070)

	)

415 
	#GPMC_CONFIG6_0
 
	`GPMC_REG32
(0x074)

	)

416 
	#GPMC_CONFIG7_0
 
	`GPMC_REG32
(0x078)

	)

419 
	#GPMC_CONFIG1_1
 
	`GPMC_REG32
(0x090)

	)

420 
	#GPMC_CONFIG2_1
 
	`GPMC_REG32
(0x094)

	)

421 
	#GPMC_CONFIG3_1
 
	`GPMC_REG32
(0x098)

	)

422 
	#GPMC_CONFIG4_1
 
	`GPMC_REG32
(0x09C)

	)

423 
	#GPMC_CONFIG5_1
 
	`GPMC_REG32
(0x0a0)

	)

424 
	#GPMC_CONFIG6_1
 
	`GPMC_REG32
(0x0a4)

	)

425 
	#GPMC_CONFIG7_1
 
	`GPMC_REG32
(0x0a8)

	)

428 
	#GPMC_CONFIG1_3
 
	`GPMC_REG32
(0x0F0)

	)

429 
	#GPMC_CONFIG2_3
 
	`GPMC_REG32
(0x0F4)

	)

430 
	#GPMC_CONFIG3_3
 
	`GPMC_REG32
(0x0F8)

	)

431 
	#GPMC_CONFIG4_3
 
	`GPMC_REG32
(0x0FC)

	)

432 
	#GPMC_CONFIG5_3
 
	`GPMC_REG32
(0x100)

	)

433 
	#GPMC_CONFIG6_3
 
	`GPMC_REG32
(0x104)

	)

434 
	#GPMC_CONFIG7_3
 
	`GPMC_REG32
(0x108)

	)

437 
	#DSS_CONTROL
 
	`DISP_REG32
(0x040)

	)

438 
	#DISPC_CONTROL
 
	`DISP_REG32
(0x440)

	)

439 
	#DISPC_SYSSTATUS
 
	`DISP_REG32
(0x414)

	)

440 
	#DISPC_IRQSTATUS
 
	`DISP_REG32
(0x418)

	)

441 
	#DISPC_IRQENABLE
 
	`DISP_REG32
(0x41C)

	)

442 
	#DISPC_CONFIG
 
	`DISP_REG32
(0x444)

	)

443 
	#DISPC_DEFAULT_COLOR0
 
	`DISP_REG32
(0x44C)

	)

444 
	#DISPC_DEFAULT_COLOR1
 
	`DISP_REG32
(0x450)

	)

445 
	#DISPC_TRANS_COLOR0
 
	`DISP_REG32
(0x454)

	)

446 
	#DISPC_TRANS_COLOR1
 
	`DISP_REG32
(0x458)

	)

447 
	#DISPC_LINE_NUMBER
 
	`DISP_REG32
(0x460)

	)

448 
	#DISPC_TIMING_H
 
	`DISP_REG32
(0x464)

	)

449 
	#DISPC_TIMING_V
 
	`DISP_REG32
(0x468)

	)

450 
	#DISPC_POL_FREQ
 
	`DISP_REG32
(0x46C)

	)

451 
	#DISPC_DIVISOR
 
	`DISP_REG32
(0x470)

	)

452 
	#DISPC_SIZE_DIG
 
	`DISP_REG32
(0x478)

	)

453 
	#DISPC_SIZE_LCD
 
	`DISP_REG32
(0x47C)

	)

454 
	#DISPC_GFX_BA0
 
	`DISP_REG32
(0x480)

	)

455 
	#DISPC_GFX_BA1
 
	`DISP_REG32
(0x484)

	)

456 
	#DISPC_GFX_POSITION
 
	`DISP_REG32
(0x488)

	)

457 
	#DISPC_GFX_SIZE
 
	`DISP_REG32
(0x48C)

	)

458 
	#DISPC_GFX_ATTRIBUTES
 
	`DISP_REG32
(0x4A0)

	)

459 
	#DISPC_GFX_FIFO_THRESHOLD
 
	`DISP_REG32
(0x4A4)

	)

460 
	#DISPC_GFX_ROW_INC
 
	`DISP_REG32
(0x4AC)

	)

461 
	#DISPC_GFX_PIXEL_INC
 
	`DISP_REG32
(0x4B0)

	)

462 
	#DISPC_GFX_WINDOW_SKIP
 
	`DISP_REG32
(0x4B4)

	)

463 
	#DISPC_GFX_TABLE_BA
 
	`DISP_REG32
(0x4B8)

	)

464 
	#DISPC_DATA_CYCLE1
 
	`DISP_REG32
(0x5D4)

	)

465 
	#DISPC_DATA_CYCLE2
 
	`DISP_REG32
(0x5D8)

	)

466 
	#DISPC_DATA_CYCLE3
 
	`DISP_REG32
(0x5DC)

	)

469 
	#HSUSB_CTRL
 
	`__REG8
(0x480AC001)

	)

470 
	#USBOTG_POWER
 
	`__REG32
(0x480AC000)

	)

473 
	#MMCHS1_SYSCONFIG
 
	`__REG32
(0x4809C010)

	)

474 
	#MMCHS2_SYSCONFIG
 
	`__REG32
(0x480b4010)

	)

	@arch/arm/mach-omap2/prcm.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/˛k.h
>

20 
	~"¥cm-ªgs.h
"

22 
om≠2_˛k_¥ï¨e_f‹_ªboŸ
();

24 
u32
 
	$om≠_¥cm_gë_ª£t_sour˚s
()

26  
RM_RSTST_WKUP
 & 0x7f;

27 
	}
}

28 
EXPORT_SYMBOL
(
om≠_¥cm_gë_ª£t_sour˚s
);

31 
	$om≠_¥cm_¨ch_ª£t
(
mode
)

33 
	`om≠2_˛k_¥ï¨e_f‹_ªboŸ
();

34 
RM_RSTCTRL_WKUP
 |= 2;

35 
	}
}

	@arch/arm/mach-omap2/serial.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/£rül_8250.h
>

18 
	~<löux/£rül_ªg.h
>

19 
	~<löux/˛k.h
>

21 
	~<asm/io.h
>

23 
	~<asm/¨ch/comm⁄.h
>

24 
	~<asm/¨ch/bﬂrd.h
>

26 
˛k
 * 
	gu¨t1_ick
 = 
NULL
;

27 
˛k
 * 
	gu¨t1_fck
 = 
NULL
;

28 
˛k
 * 
	gu¨t2_ick
 = 
NULL
;

29 
˛k
 * 
	gu¨t2_fck
 = 
NULL
;

30 
˛k
 * 
	gu¨t3_ick
 = 
NULL
;

31 
˛k
 * 
	gu¨t3_fck
 = 
NULL
;

33 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

35 .
memba£
 = (*)
IO_ADDRESS
(
OMAP_UART1_BASE
),

36 .
	gm≠ba£
 = ()
OMAP_UART1_BASE
,

37 .
	gúq
 = 72,

38 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

39 .
	giŸy≥
 = 
UPIO_MEM
,

40 .
	gªgshi·
 = 2,

41 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

43 .
	gmemba£
 = (*)
IO_ADDRESS
(
OMAP_UART2_BASE
),

44 .
	gm≠ba£
 = ()
OMAP_UART2_BASE
,

45 .
	gúq
 = 73,

46 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

47 .
	giŸy≥
 = 
UPIO_MEM
,

48 .
	gªgshi·
 = 2,

49 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

51 .
	gmemba£
 = (*)
IO_ADDRESS
(
OMAP_UART3_BASE
),

52 .
	gm≠ba£
 = ()
OMAP_UART3_BASE
,

53 .
	gúq
 = 74,

54 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

55 .
	giŸy≥
 = 
UPIO_MEM
,

56 .
	gªgshi·
 = 2,

57 .
	gu¨t˛k
 = 
OMAP16XX_BASE_BAUD
 * 16,

59 .
	gÊags
 = 0

63 
ölöe
 
	$£rül_ªad_ªg
(
∂©_£rül8250_p‹t
 *
up
,

64 
off£t
)

66 
off£t
 <<
up
->
ªgshi·
;

67  ()
	`__øw_ªadb
(
up
->
memba£
 + 
off£t
);

68 
	}
}

70 
ölöe
 
	$£rül_wrôe_ªg
(
∂©_£rül8250_p‹t
 *
p
, 
off£t
,

71 
vÆue
)

73 
off£t
 <<
p
->
ªgshi·
;

74 
	`__øw_wrôeb
(
vÆue
, ()(
p
->
memba£
 + 
off£t
));

75 
	}
}

82 
ölöe
 
__öô
 
	$om≠_£rül_ª£t
(
∂©_£rül8250_p‹t
 *
p
)

84 
	`£rül_wrôe_ªg
(
p
, 
UART_OMAP_MDR1
, 0x07);

85 
	`£rül_wrôe_ªg
(
p
, 
UART_OMAP_SCR
, 0x08);

86 
	`£rül_wrôe_ªg
(
p
, 
UART_OMAP_MDR1
, 0x00);

87 
	`£rül_wrôe_ªg
(
p
, 
UART_OMAP_SYSC
, 0x01);

88 
	}
}

90 
__öô
 
	$om≠_£rül_öô
()

92 
i
;

93 c⁄° 
om≠_u¨t_c⁄fig
 *
öfo
;

101 
öfo
 = 
	`om≠_gë_c⁄fig
(
OMAP_TAG_UART
,

102 
om≠_u¨t_c⁄fig
);

104 i‡(
öfo
 =
NULL
)

107 
i
 = 0; i < 
OMAP_MAX_NR_PORTS
; i++) {

108 
∂©_£rül8250_p‹t
 *
p
 = 
£rül_∂©f‹m_d©a
 + 
i
;

110 i‡(!(
öfo
->
íabÀd_u¨ts
 & (1 << 
i
))) {

111 
p
->
memba£
 = 0;

112 
p
->
m≠ba£
 = 0;

116 
i
) {

118 
u¨t1_ick
 = 
	`˛k_gë
(
NULL
, "uart1_ick");

119 i‡(
	`IS_ERR
(
u¨t1_ick
))

120 
	`¥ötk
("CouldÇot get uart1_ick\n");

122 
	`˛k_íabÀ
(
u¨t1_ick
);

125 
u¨t1_fck
 = 
	`˛k_gë
(
NULL
, "uart1_fck");

126 i‡(
	`IS_ERR
(
u¨t1_fck
))

127 
	`¥ötk
("CouldÇot get uart1_fck\n");

129 
	`˛k_íabÀ
(
u¨t1_fck
);

133 
u¨t2_ick
 = 
	`˛k_gë
(
NULL
, "uart2_ick");

134 i‡(
	`IS_ERR
(
u¨t2_ick
))

135 
	`¥ötk
("CouldÇot get uart2_ick\n");

137 
	`˛k_íabÀ
(
u¨t2_ick
);

140 
u¨t2_fck
 = 
	`˛k_gë
(
NULL
, "uart2_fck");

141 i‡(
	`IS_ERR
(
u¨t2_fck
))

142 
	`¥ötk
("CouldÇot get uart2_fck\n");

144 
	`˛k_íabÀ
(
u¨t2_fck
);

148 
u¨t3_ick
 = 
	`˛k_gë
(
NULL
, "uart3_ick");

149 i‡(
	`IS_ERR
(
u¨t3_ick
))

150 
	`¥ötk
("CouldÇot get uart3_ick\n");

152 
	`˛k_íabÀ
(
u¨t3_ick
);

155 
u¨t3_fck
 = 
	`˛k_gë
(
NULL
, "uart3_fck");

156 i‡(
	`IS_ERR
(
u¨t3_fck
))

157 
	`¥ötk
("CouldÇot get uart3_fck\n");

159 
	`˛k_íabÀ
(
u¨t3_fck
);

164 
	`om≠_£rül_ª£t
(
p
);

166 
	}
}

168 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

169 .
«me
 = "serial8250",

170 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

171 .
	gdev
 = {

172 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

176 
__öô
 
	$om≠_öô
()

178  
	`∂©f‹m_devi˚_ªgi°î
(&
£rül_devi˚
);

179 
	}
}

180 
¨ch_öôˇŒ
(
om≠_öô
);

	@arch/arm/mach-omap2/timer-gp.c

21 
	~<löux/öô.h
>

22 
	~<löux/time.h
>

23 
	~<löux/öãºu±.h
>

24 
	~<löux/îr.h
>

25 
	~<löux/˛k.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/úq.h
>

29 
	~<asm/mach/time.h
>

30 
	~<asm/¨ch/dmtimî.h
>

32 
om≠_dm_timî
 *
	gg±imî
;

34 
ölöe
 
	$om≠2_gp_timî_°¨t
(
lﬂd_vÆ
)

36 
	`om≠_dm_timî_£t_lﬂd
(
g±imî
, 1, 0xfffffff‡- 
lﬂd_vÆ
);

37 
	`om≠_dm_timî_£t_öt_íabÀ
(
g±imî
, 
OMAP_TIMER_INT_OVERFLOW
);

38 
	`om≠_dm_timî_°¨t
(
g±imî
);

39 
	}
}

41 
úqªtu∫_t
 
	$om≠2_gp_timî_öãºu±
(
úq
, *
dev_id
)

43 
	`wrôe_£qlock
(&
xtime_lock
);

45 
	`om≠_dm_timî_wrôe_°©us
(
g±imî
, 
OMAP_TIMER_INT_OVERFLOW
);

46 
	`timî_tick
();

48 
	`wrôe_£qu∆ock
(&
xtime_lock
);

50  
IRQ_HANDLED
;

51 
	}
}

53 
úqa˘i⁄
 
	gom≠2_gp_timî_úq
 = {

54 .
«me
 = "gpÅimer",

55 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

56 .
	gh™dÀr
 = 
om≠2_gp_timî_öãºu±
,

59 
__öô
 
	$om≠2_gp_timî_öô
()

61 
u32
 
tick_≥riod
;

63 
	`om≠_dm_timî_öô
();

64 
g±imî
 = 
	`om≠_dm_timî_ªque°_•ecific
(1);

65 
	`BUG_ON
(
g±imî
 =
NULL
);

67 
	`om≠_dm_timî_£t_sour˚
(
g±imî
, 
OMAP_TIMER_SRC_SYS_CLK
);

68 
tick_≥riod
 = 
	`˛k_gë_øã
(
	`om≠_dm_timî_gë_f˛k
(
g±imî
)Ë/ 
HZ
;

69 
tick_≥riod
 -= 1;

71 
	`£tup_úq
(
	`om≠_dm_timî_gë_úq
(
g±imî
), &
om≠2_gp_timî_úq
);

72 
	`om≠2_gp_timî_°¨t
(
tick_≥riod
);

73 
	}
}

75 
sys_timî
 
	gom≠_timî
 = {

76 .
öô
 = 
om≠2_gp_timî_öô
,

	@arch/arm/mach-pnx4008/clock.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/li°.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/devi˚.h
>

21 
	~<löux/îr.h
>

22 
	~<löux/dñay.h
>

24 
	~<asm/£m≠h‹e.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/io.h
>

28 
	~<asm/¨ch/˛ock.h
>

29 
	~"˛ock.h
"

32 
˛k
 
	g≥r_ck
;

33 
˛k
 
	gh˛k_ck
;

34 
˛k
 
	gck_1MHz
;

35 
˛k
 
	gck_13MHz
;

36 
˛k
 
	gck_∂l1
;

37 
loˇl_£t_øã
(
˛k
 *˛k, 
u32
 
øã
);

39 
ölöe
 
	$˛ock_lock
()

41 
	`loˇl_úq_dißbÀ
();

42 
	}
}

44 
ölöe
 
	$˛ock_u∆ock
()

46 
	`loˇl_úq_íabÀ
();

47 
	}
}

49 
	$¥›ag©e_øã
(
˛k
 *clk)

51 
˛k
 *
tmp_˛k
;

53 
tmp_˛k
 = 
˛k
;

54 
tmp_˛k
->
¥›ag©e_√xt
) {

55 
tmp_˛k
 =Åmp_˛k->
¥›ag©e_√xt
;

56 
	`loˇl_£t_øã
(
tmp_˛k
,Åmp_˛k->
u£r_øã
);

58 
	}
}

60 
ölöe
 
	$˛k_ªg_dißbÀ
(
˛k
 *clk)

62 i‡(
˛k
->
íabÀ_ªg
)

63 
	`__øw_wrôñ
(
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
) &

64 ~(1 << 
˛k
->
íabÀ_shi·
), clk->
íabÀ_ªg
);

65 
	}
}

67 
ölöe
 
	$˛k_ªg_íabÀ
(
˛k
 *clk)

69 i‡(
˛k
->
íabÀ_ªg
)

70 
	`__øw_wrôñ
(
	`__øw_ªadl
(
˛k
->
íabÀ_ªg
) |

71 (1 << 
˛k
->
íabÀ_shi·
), clk->
íabÀ_ªg
);

72 
	}
}

74 
ölöe
 
	$˛k_ªg_dißbÀ1
(
˛k
 *clk)

76 i‡(
˛k
->
íabÀ_ªg1
)

77 
	`__øw_wrôñ
(
	`__øw_ªadl
(
˛k
->
íabÀ_ªg1
) &

78 ~(1 << 
˛k
->
íabÀ_shi·1
), clk->
íabÀ_ªg1
);

79 
	}
}

81 
ölöe
 
	$˛k_ªg_íabÀ1
(
˛k
 *clk)

83 i‡(
˛k
->
íabÀ_ªg1
)

84 
	`__øw_wrôñ
(
	`__øw_ªadl
(
˛k
->
íabÀ_ªg1
) |

85 (1 << 
˛k
->
íabÀ_shi·1
), clk->
íabÀ_ªg1
);

86 
	}
}

88 
	$˛k_waô_f‹_∂l_lock
(
˛k
 *clk)

90 
i
;

91 
i
 = 0;

92 
i
++ < 0xFFF && !(
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
) & 1)) ;

94 i‡(!(
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
) & 1)) {

95 
	`¥ötk
(
KERN_ERR


97 
˛k
->
«me
, 
	`__øw_ªadl
(˛k->
sˇÀ_ªg
));

101 
	}
}

103 
	$swôch_to_dúty_13mhz
(
˛k
 *clk)

105 
i
;

106 
ªt
;

107 
u32
 
tmp_ªg
;

109 
ªt
 = 0;

111 i‡(!
˛k
->
øã
)

112 
	`˛k_ªg_íabÀ1
(
˛k
);

114 
tmp_ªg
 = 
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
);

116 i‡(!(
tmp_ªg
 & 1)) {

117 
tmp_ªg
 |= (1 << 1);

118 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
∑ª¡_swôch_ªg
);

119 
i
 = 0;

120 
i
++ < 0xFFF && !(
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
) & 1)) ;

122 i‡(!(
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
) & 1)) {

123 
	`¥ötk
(
KERN_ERR


125 
˛k
->
«me
, 
	`__øw_ªadl
(˛k->
∑ª¡_swôch_ªg
));

126 
ªt
 = -1;

130 i‡(!
˛k
->
øã
)

131 
	`˛k_ªg_dißbÀ1
(
˛k
);

133  
ªt
;

134 
	}
}

136 
	$swôch_to_˛ón_13mhz
(
˛k
 *clk)

138 
i
;

139 
ªt
;

140 
u32
 
tmp_ªg
;

142 
ªt
 = 0;

144 i‡(!
˛k
->
øã
)

145 
	`˛k_ªg_íabÀ1
(
˛k
);

147 
tmp_ªg
 = 
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
);

149 i‡(
tmp_ªg
 & 1) {

150 
tmp_ªg
 &= ~(1 << 1);

151 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
∑ª¡_swôch_ªg
);

152 
i
 = 0;

153 
i
++ < 0xFFF && (
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
) & 1)) ;

155 i‡(
	`__øw_ªadl
(
˛k
->
∑ª¡_swôch_ªg
) & 1) {

156 
	`¥ötk
(
KERN_ERR


158 
˛k
->
«me
, 
	`__øw_ªadl
(˛k->
∑ª¡_swôch_ªg
));

159 
ªt
 = -1;

163 i‡(!
˛k
->
øã
)

164 
	`˛k_ªg_dißbÀ1
(
˛k
);

166  
ªt
;

167 
	}
}

169 
	$£t_13MHz_∑ª¡
(
˛k
 *˛k, ˛k *
∑ª¡
)

171 
ªt
 = -
EINVAL
;

173 i‡(
∑ª¡
 =&
ck_13MHz
)

174 
ªt
 = 
	`swôch_to_˛ón_13mhz
(
˛k
);

175 i‡(
∑ª¡
 =&
ck_∂l1
)

176 
ªt
 = 
	`swôch_to_dúty_13mhz
(
˛k
);

178  
ªt
;

179 
	}
}

181 
	#PLL160_MIN_FCCO
 156000

	)

182 
	#PLL160_MAX_FCCO
 320000

	)

194 
	$∂l160_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

196 
u32
 
tmp_ªg
, 
tmp_m
, 
tmp_2p
, 
i
;

197 
u32
 
∑ª¡_øã
;

198 
ªt
 = -
EINVAL
;

200 
∑ª¡_øã
 = 
˛k
->
∑ª¡
->
øã
;

202 i‡(!
∑ª¡_øã
)

203 
out
;

206 
	`˛k_ªg_dißbÀ
(
˛k
);

209 
	`˛k_ªg_dißbÀ1
(
˛k
);

211 
tmp_ªg
 = 
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
);

212 
tmp_ªg
 &= ~0x1ffff;

213 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
sˇÀ_ªg
);

215 
øã
 -øã % 
∑ª¡_øã
;

217 i‡(
øã
 > 
PLL160_MAX_FCCO
)

218 
øã
 = 
PLL160_MAX_FCCO
;

220 i‡(!
øã
) {

221 
˛k
->
øã
 = 0;

222 
ªt
 = 0;

223 
out
;

226 
	`˛k_ªg_íabÀ1
(
˛k
);

227 
tmp_ªg
 = 
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
);

229 i‡(
øã
 =
∑ª¡_øã
) {

231 
tmp_ªg
 |= ((1 << 14) | (1 << 15));

232 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
sˇÀ_ªg
);

233 
˛k
->
øã
 = 
∑ª¡_øã
;

234 
	`˛k_ªg_íabÀ
(
˛k
);

235 
ªt
 = 0;

236 
out
;

239 
i
 = 0;

240 
tmp_2p
 = 1;Åmp_2p < 16;Åmp_2p <<= 1) {

241 i‡(
øã
 * 
tmp_2p
 >
PLL160_MIN_FCCO
)

243 
i
++;

246 i‡(
tmp_2p
 > 1)

247 
tmp_ªg
 |((
i
 - 1) << 11);

249 
tmp_ªg
 |= (1 << 14);

251 
tmp_m
 = 
øã
 * 
tmp_2p
;

252 
tmp_m
 /
∑ª¡_øã
;

254 
tmp_ªg
 |(
tmp_m
 - 1) << 1;

255 
tmp_ªg
 |= (1 << 16);

256 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
sˇÀ_ªg
);

258 i‡(
	`˛k_waô_f‹_∂l_lock
(
˛k
) < 0) {

259 
	`˛k_ªg_dißbÀ
(
˛k
);

260 
	`˛k_ªg_dißbÀ1
(
˛k
);

262 
tmp_ªg
 = 
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
);

263 
tmp_ªg
 &= ~0x1ffff;

264 
	`__øw_wrôñ
(
tmp_ªg
, 
˛k
->
sˇÀ_ªg
);

265 
˛k
->
øã
 = 0;

266 
ªt
 = -
EFAULT
;

267 
out
;

270 
˛k
->
øã
 = (
tmp_m
 * 
∑ª¡_øã
Ë/ 
tmp_2p
;

272 i‡(
˛k
->
Êags
 & 
RATE_PROPAGATES
)

273 
	`¥›ag©e_øã
(
˛k
);

275 
	`˛k_ªg_íabÀ
(
˛k
);

276 
ªt
 = 0;

278 
out
:

279  
ªt
;

280 
	}
}

283 
	$≥r_˛k_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

285 
u32
 
tmp
;

287 
tmp
 = 
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
);

288 
tmp
 &= ~(0x1f << 2);

289 
tmp
 |((
˛k
->
∑ª¡
->
øã
 / clk->rate) - 1) << 2;

290 
	`__øw_wrôñ
(
tmp
, 
˛k
->
sˇÀ_ªg
);

291 
˛k
->
øã
 =Ñate;

293 
	}
}

296 
	$h˛k_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

298 
u32
 
tmp
;

299 
tmp
 = 
	`__øw_ªadl
(
˛k
->
sˇÀ_ªg
);

300 
tmp
 =Åmp & ~0x3;

301 
øã
) {

305 
tmp
 |= 1;

308 
tmp
 |= 2;

312 
	`__øw_wrôñ
(
tmp
, 
˛k
->
sˇÀ_ªg
);

313 
˛k
->
øã
 =Ñate;

315 
	}
}

317 
u32
 
	$h˛k_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

319 
øã
) {

322  
øã
;

325 
	}
}

327 
u32
 
	$≥r_˛k_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

329  
CLK_RATE_13MHZ
;

330 
	}
}

332 
	$⁄_off_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

334 i‡(
øã
) {

335 
	`˛k_ªg_íabÀ
(
˛k
);

336 
˛k
->
øã
 = 1;

338 
	`˛k_ªg_dißbÀ
(
˛k
);

339 
˛k
->
øã
 = 0;

342 
	}
}

344 
	$⁄_off_öv_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

346 i‡(
øã
) {

347 
	`˛k_ªg_dißbÀ
(
˛k
);

348 
˛k
->
øã
 = 1;

350 
	`˛k_ªg_íabÀ
(
˛k
);

351 
˛k
->
øã
 = 0;

354 
	}
}

356 
u32
 
	$⁄_off_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

358  (
øã
 ? 1 : 0);

359 
	}
}

361 
u32
 
	$∂l4_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

363 i‡(
øã
 > 
CLK_RATE_208MHZ
)

364 
øã
 = 
CLK_RATE_208MHZ
;

365 i‡(
øã
 =
CLK_RATE_208MHZ
 && 
h˛k_ck
.
u£r_øã
 == 1)

366 
øã
 = 
CLK_RATE_208MHZ
 - 
CLK_RATE_13MHZ
;

367  (
øã
 - (øã % (
h˛k_ck
.
u£r_øã
 * 
CLK_RATE_13MHZ
)));

368 
	}
}

370 
u32
 
	$∂l3_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

372 i‡(
øã
 > 
CLK_RATE_208MHZ
)

373 
øã
 = 
CLK_RATE_208MHZ
;

374  (
øã
 -Ñ©ê% 
CLK_RATE_13MHZ
);

375 
	}
}

377 
u32
 
	$∂l5_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

379  (
øã
 ? 
CLK_RATE_48MHZ
 : 0);

380 
	}
}

382 
u32
 
	$ck_13MHz_round_øã
(
˛k
 *˛k, 
u32
 
øã
)

384  (
øã
 ? 
CLK_RATE_13MHZ
 : 0);

385 
	}
}

387 
	$ck_13MHz_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

389 i‡(
øã
) {

390 
	`˛k_ªg_dißbÀ
(
˛k
);

391 
	`udñay
(500);

392 
˛k
->
øã
 = 
CLK_RATE_13MHZ
;

393 
ck_1MHz
.
øã
 = 
CLK_RATE_1MHZ
;

395 
	`˛k_ªg_íabÀ
(
˛k
);

396 
˛k
->
øã
 = 0;

397 
ck_1MHz
.
øã
 = 0;

400 
	}
}

402 
	$∂l1_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

405 i‡(
øã
) {

406 
	`˛k_ªg_dißbÀ
(
˛k
);

407 i‡(!
	`˛k_waô_f‹_∂l_lock
(
˛k
)) {

408 
˛k
->
øã
 = 
CLK_RATE_13MHZ
;

410 
	`˛k_ªg_íabÀ
(
˛k
);

411 
˛k
->
øã
 = 0;

415 
	`˛k_ªg_íabÀ
(
˛k
);

416 
˛k
->
øã
 = 0;

420 
	}
}

424 
˛k
 
	gosc_13MHz
 = {

425 .
«me
 = "osc_13MHz",

426 .
	gÊags
 = 
FIXED_RATE
,

427 .
	gøã
 = 
CLK_RATE_13MHZ
,

430 
˛k
 
	gck_13MHz
 = {

431 .
«me
 = "ck_13MHz",

432 .
	g∑ª¡
 = &
osc_13MHz
,

433 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

434 .
	ground_øã
 = &
ck_13MHz_round_øã
,

435 .
	g£t_øã
 = &
ck_13MHz_£t_øã
,

436 .
	gíabÀ_ªg
 = 
OSC13CTRL_REG
,

437 .
	gíabÀ_shi·
 = 0,

438 .
	gøã
 = 
CLK_RATE_13MHZ
,

441 
˛k
 
	gosc_32KHz
 = {

442 .
«me
 = "osc_32KHz",

443 .
	gÊags
 = 
FIXED_RATE
,

444 .
	gøã
 = 
CLK_RATE_32KHZ
,

448 
˛k
 
	gck_1MHz
 = {

449 .
«me
 = "ck_1MHz",

450 .
	gÊags
 = 
FIXED_RATE
 | 
PARENT_SET_RATE
,

451 .
	g∑ª¡
 = &
ck_13MHz
,

455 
˛k
 
	gck_∂l1
 = {

456 .
«me
 = "ck_pll1",

457 .
	g∑ª¡
 = &
osc_32KHz
,

458 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

459 .
	ground_øã
 = &
ck_13MHz_round_øã
,

460 .
	g£t_øã
 = &
∂l1_£t_øã
,

461 .
	gíabÀ_ªg
 = 
PLLCTRL_REG
,

462 .
	gíabÀ_shi·
 = 1,

463 .
	gsˇÀ_ªg
 = 
PLLCTRL_REG
,

464 .
	gøã
 = 
CLK_RATE_13MHZ
,

468 
˛k
 
	gck_∂l4
 = {

469 .
«me
 = "ck_pll4",

470 .
	g∑ª¡
 = &
ck_∂l1
,

471 .
	gÊags
 = 
RATE_PROPAGATES
 | 
NEEDS_INITIALIZATION
,

472 .
	g¥›ag©e_√xt
 = &
≥r_ck
,

473 .
	ground_øã
 = &
∂l4_round_øã
,

474 .
	g£t_øã
 = &
∂l160_£t_øã
,

475 .
	gøã
 = 
CLK_RATE_208MHZ
,

476 .
	gsˇÀ_ªg
 = 
HCLKPLLCTRL_REG
,

477 .
	gíabÀ_ªg
 = 
PWRCTRL_REG
,

478 .
	gíabÀ_shi·
 = 2,

479 .
	g∑ª¡_swôch_ªg
 = 
SYSCLKCTRL_REG
,

480 .
	g£t_∑ª¡
 = &
£t_13MHz_∑ª¡
,

484 
˛k
 
	gck_∂l5
 = {

485 .
«me
 = "ck_pll5",

486 .
	g∑ª¡
 = &
ck_1MHz
,

487 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

488 .
	ground_øã
 = &
∂l5_round_øã
,

489 .
	g£t_øã
 = &
∂l160_£t_øã
,

490 .
	gsˇÀ_ªg
 = 
USBCTRL_REG
,

491 .
	gíabÀ_ªg
 = 
USBCTRL_REG
,

492 .
	gíabÀ_shi·
 = 18,

493 .
	gíabÀ_ªg1
 = 
USBCTRL_REG
,

494 .
	gíabÀ_shi·1
 = 17,

498 
˛k
 
	gck_∂l3
 = {

499 .
«me
 = "ck_pll3",

500 .
	g∑ª¡
 = &
ck_∂l1
,

501 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

502 .
	ground_øã
 = &
∂l3_round_øã
,

503 .
	g£t_øã
 = &
∂l160_£t_øã
,

504 .
	gsˇÀ_ªg
 = 
DSPPLLCTRL_REG
,

505 .
	gíabÀ_ªg
 = 
DSPCLKCTRL_REG
,

506 .
	gíabÀ_shi·
 = 3,

507 .
	gíabÀ_ªg1
 = 
DSPCLKCTRL_REG
,

508 .
	gíabÀ_shi·1
 = 2,

509 .
	g∑ª¡_swôch_ªg
 = 
DSPCLKCTRL_REG
,

510 .
	g£t_∑ª¡
 = &
£t_13MHz_∑ª¡
,

513 
˛k
 
	gh˛k_ck
 = {

514 .
«me
 = "hclk_ck",

515 .
	g∑ª¡
 = &
ck_∂l4
,

516 .
	gÊags
 = 
PARENT_SET_RATE
,

517 .
	g£t_øã
 = &
h˛k_£t_øã
,

518 .
	ground_øã
 = &
h˛k_round_øã
,

519 .
	gsˇÀ_ªg
 = 
HCLKDIVCTRL_REG
,

520 .
	gøã
 = 2,

521 .
	gu£r_øã
 = 2,

524 
˛k
 
	g≥r_ck
 = {

525 .
«me
 = "per_ck",

526 .
	g∑ª¡
 = &
ck_∂l4
,

527 .
	gÊags
 = 
FIXED_RATE
,

528 .
	g¥›ag©e_√xt
 = &
h˛k_ck
,

529 .
	g£t_øã
 = &
≥r_˛k_£t_øã
,

530 .
	ground_øã
 = &
≥r_˛k_round_øã
,

531 .
	gsˇÀ_ªg
 = 
HCLKDIVCTRL_REG
,

532 .
	gøã
 = 
CLK_RATE_13MHZ
,

533 .
	gu£r_øã
 = 
CLK_RATE_13MHZ
,

536 
˛k
 
	gm2h˛k_ck
 = {

537 .
«me
 = "m2hclk_ck",

538 .
	g∑ª¡
 = &
h˛k_ck
,

539 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

540 .
	ground_øã
 = &
⁄_off_round_øã
,

541 .
	g£t_øã
 = &
⁄_off_öv_£t_øã
,

542 .
	gøã
 = 1,

543 .
	gíabÀ_shi·
 = 6,

544 .
	gíabÀ_ªg
 = 
PWRCTRL_REG
,

547 
˛k
 
	gvÂ9_ck
 = {

548 .
«me
 = "vfp9_ck",

549 .
	g∑ª¡
 = &
ck_∂l4
,

550 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

551 .
	ground_øã
 = &
⁄_off_round_øã
,

552 .
	g£t_øã
 = &
⁄_off_£t_øã
,

553 .
	gøã
 = 1,

554 .
	gíabÀ_shi·
 = 4,

555 .
	gíabÀ_ªg
 = 
VFP9CLKCTRL_REG
,

558 
˛k
 
	gkeysˇn_ck
 = {

559 .
«me
 = "keyscan_ck",

560 .
	g∑ª¡
 = &
osc_32KHz
,

561 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

562 .
	ground_øã
 = &
⁄_off_round_øã
,

563 .
	g£t_øã
 = &
⁄_off_£t_øã
,

564 .
	gíabÀ_shi·
 = 0,

565 .
	gíabÀ_ªg
 = 
KEYCLKCTRL_REG
,

568 
˛k
 
	gtouch_ck
 = {

569 .
«me
 = "touch_ck",

570 .
	g∑ª¡
 = &
osc_32KHz
,

571 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

572 .
	ground_øã
 = &
⁄_off_round_øã
,

573 .
	g£t_øã
 = &
⁄_off_£t_øã
,

574 .
	gíabÀ_shi·
 = 0,

575 .
	gíabÀ_ªg
 = 
TSCLKCTRL_REG
,

578 
˛k
 
	gpwm1_ck
 = {

579 .
«me
 = "pwm1_ck",

580 .
	g∑ª¡
 = &
osc_32KHz
,

581 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

582 .
	ground_øã
 = &
⁄_off_round_øã
,

583 .
	g£t_øã
 = &
⁄_off_£t_øã
,

584 .
	gíabÀ_shi·
 = 0,

585 .
	gíabÀ_ªg
 = 
PWMCLKCTRL_REG
,

588 
˛k
 
	gpwm2_ck
 = {

589 .
«me
 = "pwm2_ck",

590 .
	g∑ª¡
 = &
osc_32KHz
,

591 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

592 .
	ground_øã
 = &
⁄_off_round_øã
,

593 .
	g£t_øã
 = &
⁄_off_£t_øã
,

594 .
	gíabÀ_shi·
 = 2,

595 .
	gíabÀ_ªg
 = 
PWMCLKCTRL_REG
,

598 
˛k
 
	gj≥g_ck
 = {

599 .
«me
 = "jpeg_ck",

600 .
	g∑ª¡
 = &
h˛k_ck
,

601 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

602 .
	ground_øã
 = &
⁄_off_round_øã
,

603 .
	g£t_øã
 = &
⁄_off_£t_øã
,

604 .
	gíabÀ_shi·
 = 0,

605 .
	gíabÀ_ªg
 = 
JPEGCLKCTRL_REG
,

608 
˛k
 
	gms_ck
 = {

609 .
«me
 = "ms_ck",

610 .
	g∑ª¡
 = &
ck_∂l4
,

611 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

612 .
	ground_øã
 = &
⁄_off_round_øã
,

613 .
	g£t_øã
 = &
⁄_off_£t_øã
,

614 .
	gíabÀ_shi·
 = 5,

615 .
	gíabÀ_ªg
 = 
MSCTRL_REG
,

618 
˛k
 
	gdum_ck
 = {

619 .
«me
 = "dum_ck",

620 .
	g∑ª¡
 = &
h˛k_ck
,

621 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

622 .
	ground_øã
 = &
⁄_off_round_øã
,

623 .
	g£t_øã
 = &
⁄_off_£t_øã
,

624 .
	gíabÀ_shi·
 = 0,

625 .
	gíabÀ_ªg
 = 
DUMCLKCTRL_REG
,

628 
˛k
 
	gÊash_ck
 = {

629 .
«me
 = "flash_ck",

630 .
	g∑ª¡
 = &
h˛k_ck
,

631 .
	ground_øã
 = &
⁄_off_round_øã
,

632 .
	g£t_øã
 = &
⁄_off_£t_øã
,

633 .
	gíabÀ_shi·
 = 1,

634 .
	gíabÀ_ªg
 = 
FLASHCLKCTRL_REG
,

637 
˛k
 
	gi2c0_ck
 = {

638 .
«me
 = "i2c0_ck",

639 .
	g∑ª¡
 = &
≥r_ck
,

640 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

641 .
	ground_øã
 = &
⁄_off_round_øã
,

642 .
	g£t_øã
 = &
⁄_off_£t_øã
,

643 .
	gíabÀ_shi·
 = 0,

644 .
	gíabÀ_ªg
 = 
I2CCLKCTRL_REG
,

647 
˛k
 
	gi2c1_ck
 = {

648 .
«me
 = "i2c1_ck",

649 .
	g∑ª¡
 = &
≥r_ck
,

650 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

651 .
	ground_øã
 = &
⁄_off_round_øã
,

652 .
	g£t_øã
 = &
⁄_off_£t_øã
,

653 .
	gíabÀ_shi·
 = 1,

654 .
	gíabÀ_ªg
 = 
I2CCLKCTRL_REG
,

657 
˛k
 
	gi2c2_ck
 = {

658 .
«me
 = "i2c2_ck",

659 .
	g∑ª¡
 = &
≥r_ck
,

660 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

661 .
	ground_øã
 = &
⁄_off_round_øã
,

662 .
	g£t_øã
 = &
⁄_off_£t_øã
,

663 .
	gíabÀ_shi·
 = 2,

664 .
	gíabÀ_ªg
 = 
USB_OTG_CLKCTRL_REG
,

667 
˛k
 
	g•i0_ck
 = {

668 .
«me
 = "spi0_ck",

669 .
	g∑ª¡
 = &
h˛k_ck
,

670 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

671 .
	ground_øã
 = &
⁄_off_round_øã
,

672 .
	g£t_øã
 = &
⁄_off_£t_øã
,

673 .
	gíabÀ_shi·
 = 0,

674 .
	gíabÀ_ªg
 = 
SPICTRL_REG
,

677 
˛k
 
	g•i1_ck
 = {

678 .
«me
 = "spi1_ck",

679 .
	g∑ª¡
 = &
h˛k_ck
,

680 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

681 .
	ground_øã
 = &
⁄_off_round_øã
,

682 .
	g£t_øã
 = &
⁄_off_£t_øã
,

683 .
	gíabÀ_shi·
 = 4,

684 .
	gíabÀ_ªg
 = 
SPICTRL_REG
,

687 
˛k
 
	gdma_ck
 = {

688 .
«me
 = "dma_ck",

689 .
	g∑ª¡
 = &
h˛k_ck
,

690 .
	ground_øã
 = &
⁄_off_round_øã
,

691 .
	g£t_øã
 = &
⁄_off_£t_øã
,

692 .
	gíabÀ_shi·
 = 0,

693 .
	gíabÀ_ªg
 = 
DMACLKCTRL_REG
,

696 
˛k
 
	gu¨t3_ck
 = {

697 .
«me
 = "uart3_ck",

698 .
	g∑ª¡
 = &
≥r_ck
,

699 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

700 .
	ground_øã
 = &
⁄_off_round_øã
,

701 .
	g£t_øã
 = &
⁄_off_£t_øã
,

702 .
	gøã
 = 1,

703 .
	gíabÀ_shi·
 = 0,

704 .
	gíabÀ_ªg
 = 
UARTCLKCTRL_REG
,

707 
˛k
 
	gu¨t4_ck
 = {

708 .
«me
 = "uart4_ck",

709 .
	g∑ª¡
 = &
≥r_ck
,

710 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

711 .
	ground_øã
 = &
⁄_off_round_øã
,

712 .
	g£t_øã
 = &
⁄_off_£t_øã
,

713 .
	gíabÀ_shi·
 = 1,

714 .
	gíabÀ_ªg
 = 
UARTCLKCTRL_REG
,

717 
˛k
 
	gu¨t5_ck
 = {

718 .
«me
 = "uart5_ck",

719 .
	g∑ª¡
 = &
≥r_ck
,

720 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

721 .
	ground_øã
 = &
⁄_off_round_øã
,

722 .
	g£t_øã
 = &
⁄_off_£t_øã
,

723 .
	gøã
 = 1,

724 .
	gíabÀ_shi·
 = 2,

725 .
	gíabÀ_ªg
 = 
UARTCLKCTRL_REG
,

728 
˛k
 
	gu¨t6_ck
 = {

729 .
«me
 = "uart6_ck",

730 .
	g∑ª¡
 = &
≥r_ck
,

731 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

732 .
	ground_øã
 = &
⁄_off_round_øã
,

733 .
	g£t_øã
 = &
⁄_off_£t_øã
,

734 .
	gíabÀ_shi·
 = 3,

735 .
	gíabÀ_ªg
 = 
UARTCLKCTRL_REG
,

738 
˛k
 
	gwdt_ck
 = {

739 .
«me
 = "wdt_ck",

740 .
	g∑ª¡
 = &
≥r_ck
,

741 .
	gÊags
 = 
NEEDS_INITIALIZATION
,

742 .
	ground_øã
 = &
⁄_off_round_øã
,

743 .
	g£t_øã
 = &
⁄_off_£t_øã
,

744 .
	gíabÀ_shi·
 = 0,

745 .
	gíabÀ_ªg
 = 
TIMCLKCTRL_REG
,

751 
˛k
 *
	g⁄chù_˛ks
[] = {

752 &
ck_13MHz
,

753 &
ck_∂l1
,

754 &
ck_∂l4
,

755 &
ck_∂l5
,

756 &
ck_∂l3
,

757 &
vÂ9_ck
,

758 &
m2h˛k_ck
,

759 &
h˛k_ck
,

760 &
dma_ck
,

761 &
Êash_ck
,

762 &
dum_ck
,

763 &
keysˇn_ck
,

764 &
pwm1_ck
,

765 &
pwm2_ck
,

766 &
j≥g_ck
,

767 &
ms_ck
,

768 &
touch_ck
,

769 &
i2c0_ck
,

770 &
i2c1_ck
,

771 &
i2c2_ck
,

772 &
•i0_ck
,

773 &
•i1_ck
,

774 &
u¨t3_ck
,

775 &
u¨t4_ck
,

776 &
u¨t5_ck
,

777 &
u¨t6_ck
,

778 &
wdt_ck
,

781 
	$loˇl_˛k_íabÀ
(
˛k
 *clk)

783 
ªt
 = 0;

785 i‡(!(
˛k
->
Êags
 & 
FIXED_RATE
Ë&& !˛k->
øã
 && clk->
£t_øã


786 && 
˛k
->
u£r_øã
)

787 
ªt
 = 
˛k
->
	`£t_øã
(˛k, clk->
u£r_øã
);

788  
ªt
;

789 
	}
}

791 
	$loˇl_˛k_dißbÀ
(
˛k
 *clk)

793 i‡(!(
˛k
->
Êags
 & 
FIXED_RATE
Ë&& clk->
øã
 && clk->
£t_øã
)

794 
˛k
->
	`£t_øã
(clk, 0);

795 
	}
}

797 
	$loˇl_˛k_unu£
(
˛k
 *clk)

799 i‡(
˛k
->
u£cou¡
 > 0 && !(--clk->usecount)) {

800 
	`loˇl_˛k_dißbÀ
(
˛k
);

801 i‡(
˛k
->
∑ª¡
)

802 
	`loˇl_˛k_unu£
(
˛k
->
∑ª¡
);

804 
	}
}

806 
	$loˇl_˛k_u£
(
˛k
 *clk)

808 
ªt
 = 0;

809 i‡(
˛k
->
u£cou¡
++ == 0) {

810 i‡(
˛k
->
∑ª¡
)

811 
ªt
 = 
	`loˇl_˛k_u£
(
˛k
->
∑ª¡
);

813 i‡(
ªt
 != 0) {

814 
˛k
->
u£cou¡
--;

815 
out
;

818 
ªt
 = 
	`loˇl_˛k_íabÀ
(
˛k
);

820 i‡(
ªt
 !0 && 
˛k
->
∑ª¡
) {

821 
	`loˇl_˛k_unu£
(
˛k
->
∑ª¡
);

822 
˛k
->
u£cou¡
--;

825 
out
:

826  
ªt
;

827 
	}
}

829 
	$loˇl_£t_øã
(
˛k
 *˛k, 
u32
 
øã
)

831 
ªt
 = -
EINVAL
;

832 i‡(
˛k
->
£t_øã
) {

834 i‡(
˛k
->
u£r_øã
 =˛k->
øã
 && clk->
∑ª¡
->rate) {

836 
˛k
->
u£r_øã
 = clk->
	`round_øã
(˛k, 
øã
);

837 
ªt
 = 
˛k
->
	`£t_øã
(˛k, clk->
u£r_øã
);

839 
˛k
->
u£r_øã
 = clk->
	`round_øã
(˛k, 
øã
);

840 
ªt
 = 0;

842  
ªt
;

843 
	}
}

845 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

847 
ªt
 = -
EINVAL
;

849 i‡(
˛k
->
Êags
 & 
FIXED_RATE
)

850 
out
;

852 
	`˛ock_lock
();

853 i‡((
˛k
->
Êags
 & 
PARENT_SET_RATE
Ë&& clk->
∑ª¡
) {

855 
˛k
->
u£r_øã
 = clk->
	`round_øã
(˛k, 
øã
);

859 
ªt
 = 
	`loˇl_£t_øã
(
˛k
, 
øã
);

861 
ªt
 = 0;

862 
	`˛ock_u∆ock
();

864 
out
:

865  
ªt
;

866 
	}
}

868 
EXPORT_SYMBOL
(
˛k_£t_øã
);

870 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

872 
˛k
 *˛k = 
	`ERR_PTR
(-
ENOENT
);

873 
˛k
 **
˛kp
;

875 
	`˛ock_lock
();

876 
˛kp
 = 
⁄chù_˛ks
; clk∞< onchù_˛k†+ 
	`ARRAY_SIZE
(onchip_clks);

877 
˛kp
++) {

878 i‡(
	`°rcmp
(
id
, (*
˛kp
)->
«me
) == 0

879 && 
	`åy_moduÀ_gë
((*
˛kp
)->
ow√r
)) {

880 
˛k
 = (*
˛kp
);

884 
	`˛ock_u∆ock
();

886  
˛k
;

887 
	}
}

888 
EXPORT_SYMBOL
(
˛k_gë
);

890 
	$˛k_put
(
˛k
 *clk)

892 
	`˛ock_lock
();

893 i‡(
˛k
 && !
	`IS_ERR
(clk))

894 
	`moduÀ_put
(
˛k
->
ow√r
);

895 
	`˛ock_u∆ock
();

896 
	}
}

897 
EXPORT_SYMBOL
(
˛k_put
);

899 
	$˛k_gë_øã
(
˛k
 *clk)

901 
ªt
;

902 
	`˛ock_lock
();

903 
ªt
 = 
˛k
->
øã
;

904 
	`˛ock_u∆ock
();

905  
ªt
;

906 
	}
}

907 
EXPORT_SYMBOL
(
˛k_gë_øã
);

909 
	$˛k_íabÀ
(
˛k
 *clk)

911 
ªt
 = 0;

913 
	`˛ock_lock
();

914 
ªt
 = 
	`loˇl_˛k_u£
(
˛k
);

915 
	`˛ock_u∆ock
();

916  
ªt
;

917 
	}
}

919 
EXPORT_SYMBOL
(
˛k_íabÀ
);

921 
	$˛k_dißbÀ
(
˛k
 *clk)

923 
	`˛ock_lock
();

924 
	`loˇl_˛k_unu£
(
˛k
);

925 
	`˛ock_u∆ock
();

926 
	}
}

928 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

930 
	$˛k_round_øã
(
˛k
 *˛k, 
øã
)

932 
ªt
;

933 
	`˛ock_lock
();

934 i‡(
˛k
->
round_øã
)

935 
ªt
 = 
˛k
->
	`round_øã
(˛k, 
øã
);

937 
ªt
 = 
˛k
->
øã
;

938 
	`˛ock_u∆ock
();

939  
ªt
;

940 
	}
}

942 
EXPORT_SYMBOL
(
˛k_round_øã
);

944 
	$˛k_£t_∑ª¡
(
˛k
 *˛k, ˛k *
∑ª¡
)

946 
ªt
 = -
ENODEV
;

947 i‡(!
˛k
->
£t_∑ª¡
)

948 
out
;

950 
	`˛ock_lock
();

951 
ªt
 = 
˛k
->
	`£t_∑ª¡
(˛k, 
∑ª¡
);

952 i‡(!
ªt
)

953 
˛k
->
∑ª¡
 =Öarent;

954 
	`˛ock_u∆ock
();

956 
out
:

957  
ªt
;

958 
	}
}

960 
EXPORT_SYMBOL
(
˛k_£t_∑ª¡
);

962 
__öô
 
	$˛k_öô
()

964 
˛k
 **
˛kp
;

967 
	`__øw_wrôñ
(0xff, 
AUTOCLK_CTRL
);

969 
˛kp
 = 
⁄chù_˛ks
; clk∞< onchù_˛k†+ 
	`ARRAY_SIZE
(onchip_clks);

970 
˛kp
++) {

971 i‡(((*
˛kp
)->
Êags
 & 
NEEDS_INITIALIZATION
)

972 && ((*
˛kp
)->
£t_øã
)) {

973 (*
˛kp
)->
u£r_øã
 = (*˛kp)->
øã
;

974 
	`loˇl_£t_øã
((*
˛kp
), (*˛kp)->
u£r_øã
);

975 i‡((*
˛kp
)->
£t_∑ª¡
)

976 (*
˛kp
)->
	`£t_∑ª¡
((*˛kp), (*˛kp)->
∑ª¡
);

978 
	`¥_debug
("%s: clock %s,Ñate %ld\n",

979 
__FUNCTION__
, (*
˛kp
)->
«me
, (*˛kp)->
øã
);

982 
	`loˇl_˛k_u£
(&
ck_∂l4
);

985 i‡(
ck_13MHz
.
u£cou¡
 == 0)

986 
	`loˇl_˛k_dißbÀ
(&
ck_13MHz
);

989 
	`__øw_wrôeb
(0xff, 
AUTOCLK_CTRL
);

992 
	}
}

994 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-pnx4008/clock.h

13 #i‚de‡
__ARCH_ARM_PNX4008_CLOCK_H__


14 
	#__ARCH_ARM_PNX4008_CLOCK_H__


	)

16 
	s˛k
 {

17 
li°_hód
 
	mnode
;

18 
moduÀ
 *
	mow√r
;

19 c⁄° *
	m«me
;

20 
˛k
 *
	m∑ª¡
;

21 
˛k
 *
	m¥›ag©e_√xt
;

22 
u32
 
	møã
;

23 
u32
 
	mu£r_øã
;

24 
s8
 
	mu£cou¡
;

25 
u32
 
	mÊags
;

26 
u32
 
	msˇÀ_ªg
;

27 
u8
 
	míabÀ_shi·
;

28 
u32
 
	míabÀ_ªg
;

29 
u8
 
	míabÀ_shi·1
;

30 
u32
 
	míabÀ_ªg1
;

31 
u32
 
	m∑ª¡_swôch_ªg
;

32 
u32
(*
round_øã
Ë(
	m˛k
 *, 
	mu32
);

33 (*
	m£t_øã
Ë(
	m˛k
 *, 
	mu32
);

34 (*
	m£t_∑ª¡
Ë(
˛k
 * 
	m˛k
, ˛k * 
	m∑ª¡
);

38 
	#RATE_PROPAGATES
 (1<<0)

	)

39 
	#NEEDS_INITIALIZATION
 (1<<1)

	)

40 
	#PARENT_SET_RATE
 (1<<2)

	)

41 
	#FIXED_RATE
 (1<<3)

	)

	@arch/arm/mach-pnx4008/core.c

18 
	~<löux/kî√l.h
>

19 
	~<löux/ty≥s.h
>

20 
	~<löux/mm.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/£rül_8250.h
>

26 
	~<löux/devi˚.h
>

27 
	~<löux/•i/•i.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/io.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/mach-ty≥s.h
>

33 
	~<asm/pgèbÀ.h
>

34 
	~<asm/∑ge.h
>

35 
	~<asm/sy°em.h
>

37 
	~<asm/mach/¨ch.h
>

38 
	~<asm/mach/m≠.h
>

39 
	~<asm/mach/time.h
>

41 
	~<asm/¨ch/úq.h
>

42 
	~<asm/¨ch/˛ock.h
>

43 
	~<asm/¨ch/dma.h
>

45 
ªsour˚
 
	g•ùnx_0_ªsour˚s
[] = {

47 .
°¨t
 = 
PNX4008_SPI1_BASE
,

48 .
	gíd
 = 
PNX4008_SPI1_BASE
 + 
SZ_4K
,

49 .
	gÊags
 = 
IORESOURCE_MEM
,

51 .
	g°¨t
 = 
PER_SPI1_REC_XMIT
,

52 .
	gÊags
 = 
IORESOURCE_DMA
,

54 .
	g°¨t
 = 
SPI1_INT
,

55 .
	gÊags
 = 
IORESOURCE_IRQ
,

57 .
	gÊags
 = 0,

61 
ªsour˚
 
	g•ùnx_1_ªsour˚s
[] = {

63 .
°¨t
 = 
PNX4008_SPI2_BASE
,

64 .
	gíd
 = 
PNX4008_SPI2_BASE
 + 
SZ_4K
,

65 .
	gÊags
 = 
IORESOURCE_MEM
,

67 .
	g°¨t
 = 
PER_SPI2_REC_XMIT
,

68 .
	gÊags
 = 
IORESOURCE_DMA
,

70 .
	g°¨t
 = 
SPI2_INT
,

71 .
	gÊags
 = 
IORESOURCE_IRQ
,

73 .
	gÊags
 = 0,

77 
•i_bﬂrd_öfo
 
	g•i_bﬂrd_öfo
[] 
	g__öôd©a
 = {

79 .
modÆüs
 = "m25p80",

80 .
	gmax_•ìd_hz
 = 1000000,

81 .
	gbus_num
 = 1,

82 .
	gchù_£À˘
 = 0,

86 
∂©f‹m_devi˚
 
	g•ùnx_1
 = {

87 .
«me
 = "spipnx",

88 .
	gid
 = 1,

89 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•ùnx_0_ªsour˚s
),

90 .
	gªsour˚
 = 
•ùnx_0_ªsour˚s
,

91 .
	gdev
 = {

92 .
cohîít_dma_mask
 = 0xFFFFFFFF,

96 
∂©f‹m_devi˚
 
	g•ùnx_2
 = {

97 .
«me
 = "spipnx",

98 .
	gid
 = 2,

99 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•ùnx_1_ªsour˚s
),

100 .
	gªsour˚
 = 
•ùnx_1_ªsour˚s
,

101 .
	gdev
 = {

102 .
cohîít_dma_mask
 = 0xFFFFFFFF,

106 
∂©_£rül8250_p‹t
 
	g∂©f‹m_£rül_p‹ts
[] = {

108 .
memba£
 = (*)
__iomem
(
IO_ADDRESS
(
PNX4008_UART5_BASE
)),

109 .
	gm≠ba£
 = ()
PNX4008_UART5_BASE
,

110 .
	gúq
 = 
IIR5_INT
,

111 .
	gu¨t˛k
 = 
PNX4008_UART_CLK
,

112 .
	gªgshi·
 = 2,

113 .
	giŸy≥
 = 
UPIO_MEM
,

114 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_BUGGY_UART
 | 
UPF_SKIP_TEST
,

117 .
	gmemba£
 = (*)
__iomem
(
IO_ADDRESS
(
PNX4008_UART3_BASE
)),

118 .
	gm≠ba£
 = ()
PNX4008_UART3_BASE
,

119 .
	gúq
 = 
IIR3_INT
,

120 .
	gu¨t˛k
 = 
PNX4008_UART_CLK
,

121 .
	gªgshi·
 = 2,

122 .
	giŸy≥
 = 
UPIO_MEM
,

123 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_BUGGY_UART
 | 
UPF_SKIP_TEST
,

128 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

129 .
«me
 = "serial8250",

130 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

131 .
	gdev
 = {

132 .
∂©f‹m_d©a
 = &
∂©f‹m_£rül_p‹ts
,

136 
∂©f‹m_devi˚
 
	g«nd_Êash_devi˚
 = {

137 .
«me
 = "pnx4008-flash",

138 .
	gid
 = -1,

139 .
	gdev
 = {

140 .
cohîít_dma_mask
 = 0xFFFFFFFF,

145 
u64
 
	gohci_dmamask
 = ~(
u32
) 0;

147 
ªsour˚
 
	gohci_ªsour˚s
[] = {

149 .
°¨t
 = 
IO_ADDRESS
(
PNX4008_USB_CONFIG_BASE
),

150 .
	gíd
 = 
IO_ADDRESS
(
PNX4008_USB_CONFIG_BASE
 + 0x100),

151 .
	gÊags
 = 
IORESOURCE_MEM
,

153 .
	g°¨t
 = 
USB_HOST_INT
,

154 .
	gÊags
 = 
IORESOURCE_IRQ
,

158 
∂©f‹m_devi˚
 
	gohci_devi˚
 = {

159 .
«me
 = "pnx4008-usb-ohci",

160 .
	gid
 = -1,

161 .
	gdev
 = {

162 .
dma_mask
 = &
ohci_dmamask
,

163 .
	gcohîít_dma_mask
 = 0xffffffff,

165 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ohci_ªsour˚s
),

166 .
	gªsour˚
 = 
ohci_ªsour˚s
,

169 
∂©f‹m_devi˚
 
	gsdum_devi˚
 = {

170 .
«me
 = "pnx4008-sdum",

171 .
	gid
 = 0,

172 .
	gdev
 = {

173 .
cohîít_dma_mask
 = 0xffffffff,

177 
∂©f‹m_devi˚
 
	grgbfb_devi˚
 = {

178 .
«me
 = "pnx4008-rgbfb",

179 .
	gid
 = 0,

180 .
	gdev
 = {

181 .
cohîít_dma_mask
 = 0xffffffff,

185 
ªsour˚
 
	gw©chdog_ªsour˚s
[] = {

187 .
°¨t
 = 
PNX4008_WDOG_BASE
,

188 .
	gíd
 = 
PNX4008_WDOG_BASE
 + 
SZ_4K
 - 1,

189 .
	gÊags
 = 
IORESOURCE_MEM
,

193 
∂©f‹m_devi˚
 
	gw©chdog_devi˚
 = {

194 .
«me
 = "pnx4008-watchdog",

195 .
	gid
 = -1,

196 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
w©chdog_ªsour˚s
),

197 .
	gªsour˚
 = 
w©chdog_ªsour˚s
,

200 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

201 &
•ùnx_1
,

202 &
•ùnx_2
,

203 &
£rül_devi˚
,

204 &
ohci_devi˚
,

205 &
«nd_Êash_devi˚
,

206 &
sdum_devi˚
,

207 &
rgbfb_devi˚
,

208 &
w©chdog_devi˚
,

212 
≤x4008_u¨t_öô
();

214 
__öô
 
	$≤x4008_öô
()

218 
	`__øw_wrôñ
(0, 
	`START_INT_ER_REG
(
SE_PIN_BASE_INT
));

219 
	`__øw_wrôñ
(0, 
	`START_INT_ER_REG
(
SE_INT_BASE_INT
));

220 
	`__øw_wrôñ
(0xffffffff, 
	`START_INT_RSR_REG
(
SE_PIN_BASE_INT
));

221 
	`__øw_wrôñ
(0xffffffff, 
	`START_INT_RSR_REG
(
SE_INT_BASE_INT
));

223 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

224 
	`•i_ªgi°î_bﬂrd_öfo
(
•i_bﬂrd_öfo
, 
	`ARRAY_SIZE
(spi_board_info));

226 
	`≤x4008_u¨t_öô
();

227 
	}
}

229 
m≠_desc
 
	g≤x4008_io_desc
[] 
	g__öôd©a
 = {

231 .
vútuÆ
 = 
IO_ADDRESS
(
PNX4008_IRAM_BASE
),

232 .
	gp‚
 = 
__phys_to_p‚
(
PNX4008_IRAM_BASE
),

233 .
	gÀngth
 = 
SZ_64K
,

234 .
	gty≥
 = 
MT_DEVICE
,

236 .
	gvútuÆ
 = 
IO_ADDRESS
(
PNX4008_NDF_FLASH_BASE
),

237 .
	gp‚
 = 
__phys_to_p‚
(
PNX4008_NDF_FLASH_BASE
),

238 .
	gÀngth
 = 
SZ_1M
 - 
SZ_128K
,

239 .
	gty≥
 = 
MT_DEVICE
,

241 .
	gvútuÆ
 = 
IO_ADDRESS
(
PNX4008_JPEG_CONFIG_BASE
),

242 .
	gp‚
 = 
__phys_to_p‚
(
PNX4008_JPEG_CONFIG_BASE
),

243 .
	gÀngth
 = 
SZ_128K
 * 3,

244 .
	gty≥
 = 
MT_DEVICE
,

246 .
	gvútuÆ
 = 
IO_ADDRESS
(
PNX4008_DMA_CONFIG_BASE
),

247 .
	gp‚
 = 
__phys_to_p‚
(
PNX4008_DMA_CONFIG_BASE
),

248 .
	gÀngth
 = 
SZ_1M
,

249 .
	gty≥
 = 
MT_DEVICE
,

251 .
	gvútuÆ
 = 
IO_ADDRESS
(
PNX4008_AHB2FAB_BASE
),

252 .
	gp‚
 = 
__phys_to_p‚
(
PNX4008_AHB2FAB_BASE
),

253 .
	gÀngth
 = 
SZ_1M
,

254 .
	gty≥
 = 
MT_DEVICE
,

258 
__öô
 
	$≤x4008_m≠_io
()

260 
	`iŸabÀ_öô
(
≤x4008_io_desc
, 
	`ARRAY_SIZE
(pnx4008_io_desc));

261 
	}
}

263 
sys_timî
 
≤x4008_timî
;

265 
MACHINE_START
(
PNX4008
, "Philips PNX4008")

267 .
	gphys_io
 = 0x40090000,

268 .
	gio_pg_off°
 = (0xf4090000 >> 18) & 0xfffc,

269 .
	gboŸ_∑øms
 = 0x80000100,

270 .
	gm≠_io
 = 
≤x4008_m≠_io
,

271 .
	göô_úq
 = 
≤x4008_öô_úq
,

272 .
	göô_machöe
 = 
≤x4008_öô
,

273 .
	gtimî
 = &
≤x4008_timî
,

274 
	gMACHINE_END


	@arch/arm/mach-pnx4008/dma.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/îr.h
>

22 
	~<löux/dma-m≠pög.h
>

23 
	~<löux/˛k.h
>

25 
	~<asm/sy°em.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/dma.h
>

28 
	~<asm/dma-m≠pög.h
>

29 
	~<asm/io.h
>

30 
	~<asm/mach/dma.h
>

31 
	~<asm/¨ch/˛ock.h
>

33 
	sdma_ch™√l
 {

34 *
	m«me
;

35 (*
	múq_h™dÀr
) (, , *);

36 *
	md©a
;

37 
≤x4008_dma_Œ
 *
	mŒ
;

38 
u32
 
	mŒ_dma
;

39 *
	mèrgë_addr
;

40 
	mèrgë_id
;

41 } 
	gdma_ch™√ls
[
MAX_DMA_CHANNELS
];

43 
	sŒ_poﬁ
 {

44 *
	mvaddr
;

45 *
	mcur
;

46 
dma_addr_t
 
	mdma_addr
;

47 
	mcou¡
;

48 } 
	gŒ_poﬁ
;

50 
DEFINE_SPINLOCK
(
Œ_lock
);

52 
≤x4008_dma_Œ
 *
	$≤x4008_Æloc_Œ_íåy
(
dma_addr_t
 * 
Œ_dma
)

54 
≤x4008_dma_Œ
 *
Œ
 = 
NULL
;

55 
Êags
;

57 
	`•ö_lock_úqßve
(&
Œ_lock
, 
Êags
);

58 i‡(
Œ_poﬁ
.
cou¡
 > 4) {

59 
Œ
 = *(
≤x4008_dma_Œ
 **Ë
Œ_poﬁ
.
cur
;

60 *
Œ_dma
 = 
Œ_poﬁ
.
dma_addr
 + ((*)
Œ
 -Ül_poﬁ.
vaddr
);

61 *(**)
Œ_poﬁ
.
cur
 = **(***)ll_pool.cur;

62 
	`mem£t
(
Œ
, 0, (*ll));

63 
Œ_poﬁ
.
cou¡
--;

65 
	`•ö_u∆ock_úqª°‹e
(&
Œ_lock
, 
Êags
);

67  
Œ
;

68 
	}
}

70 
EXPORT_SYMBOL_GPL
(
≤x4008_Æloc_Œ_íåy
);

72 
	$≤x4008_‰ì_Œ_íåy
(
≤x4008_dma_Œ
 * 
Œ
, 
dma_addr_t
 
Œ_dma
)

74 
Êags
;

76 i‡(
Œ
) {

77 i‡(()(()
Œ
 - ()
Œ_poﬁ
.
vaddr
) > 0x4000) {

78 
	`¥ötk
(
KERN_ERR
 "TryingÅo freeÉntryÇotállocated by DMA\n");

79 
	`BUG
();

82 i‡(
Œ
->
Êags
 & 
DMA_BUFFER_ALLOCATED
)

83 
Œ
->
	`‰ì
÷l->
Æloc_d©a
);

85 
	`•ö_lock_úqßve
(&
Œ_lock
, 
Êags
);

86 *(*)
Œ
 = *(*)
Œ_poﬁ
.
cur
;

87 *(*)
Œ_poﬁ
.
cur
 = ()
Œ
;

88 
Œ_poﬁ
.
cou¡
++;

89 
	`•ö_u∆ock_úqª°‹e
(&
Œ_lock
, 
Êags
);

91 
	}
}

93 
EXPORT_SYMBOL_GPL
(
≤x4008_‰ì_Œ_íåy
);

95 
	$≤x4008_‰ì_Œ
(
u32
 
Œ_dma
, 
≤x4008_dma_Œ
 * 
Œ
)

97 
≤x4008_dma_Œ
 *
±r
;

98 
u32
 
dma
;

100 
Œ
) {

101 
dma
 = 
Œ
->
√xt_dma
;

102 
±r
 = 
Œ
->
√xt
;

103 
	`≤x4008_‰ì_Œ_íåy
(
Œ
, 
Œ_dma
);

105 
Œ_dma
 = 
dma
;

106 
Œ
 = 
±r
;

108 
	}
}

110 
EXPORT_SYMBOL_GPL
(
≤x4008_‰ì_Œ
);

112 
	gdma_ch™√ls_ªque°ed
 = 0;

114 
ölöe
 
	$dma_ö¸emít_ußge
()

116 i‡(!
dma_ch™√ls_ªque°ed
++) {

117 
˛k
 *˛k = 
	`˛k_gë
(0, "dma_ck");

118 i‡(!
	`IS_ERR
(
˛k
)) {

119 
	`˛k_£t_øã
(
˛k
, 1);

120 
	`˛k_put
(
˛k
);

122 
	`≤x4008_c⁄fig_dma
(-1, -1, 1);

124 
	}
}

125 
ölöe
 
	$dma_de¸emít_ußge
()

127 i‡(!--
dma_ch™√ls_ªque°ed
) {

128 
˛k
 *˛k = 
	`˛k_gë
(0, "dma_ck");

129 i‡(!
	`IS_ERR
(
˛k
)) {

130 
	`˛k_£t_øã
(
˛k
, 0);

131 
	`˛k_put
(
˛k
);

133 
	`≤x4008_c⁄fig_dma
(-1, -1, 0);

136 
	}
}

138 
DEFINE_SPINLOCK
(
dma_lock
);

140 
ölöe
 
	$≤x4008_dma_lock
()

142 
	`•ö_lock_úq
(&
dma_lock
);

143 
	}
}

145 
ölöe
 
	$≤x4008_dma_u∆ock
()

147 
	`•ö_u∆ock_úq
(&
dma_lock
);

148 
	}
}

150 
	#VALID_CHANNEL
(
c
Ë(((cË>0Ë&& ((cË< 
MAX_DMA_CHANNELS
))

	)

152 
≤x4008_ªque°_ch™√l
(*
«me
, 
ch
,

153 (*
úq_h™dÀr
Ë(, , *), *
d©a
)

155 
i
, 
found
 = 0;

158 i‡(!
«me
 || (
ch
 !-1 && !
	`VALID_CHANNEL
(ch)))

159  -
EINVAL
;

161 
	`≤x4008_dma_lock
();

164 
i
 = 
MAX_DMA_CHANNELS
 - 1; i >= 0; i--) {

165 i‡(!
dma_ch™√ls
[
i
].
«me
 && (
ch
 == -1 || ch == i)) {

166 
found
 = 1;

171 i‡(
found
) {

172 
	`dma_ö¸emít_ußge
();

173 
dma_ch™√ls
[
i
].
«me
 =Çame;

174 
dma_ch™√ls
[
i
].
úq_h™dÀr
 = irq_handler;

175 
dma_ch™√ls
[
i
].
d©a
 = data;

176 
dma_ch™√ls
[
i
].
Œ
 = 
NULL
;

177 
dma_ch™√ls
[
i
].
Œ_dma
 = 0;

179 
	`¥ötk
(
KERN_WARNING
 "No moreávailable DMA channels for %s\n",

180 
«me
);

181 
i
 = -
ENODEV
;

184 
	`≤x4008_dma_u∆ock
();

185  
i
;

186 
	}
}

188 
EXPORT_SYMBOL_GPL
(
≤x4008_ªque°_ch™√l
);

190 
	$≤x4008_‰ì_ch™√l
(
ch
)

192 i‡(!
dma_ch™√ls
[
ch
].
«me
) {

193 
	`¥ötk
(
KERN_CRIT


195 
__FUNCTION__
, 
ch
);

199 
	`≤x4008_dma_lock
();

200 
	`≤x4008_‰ì_Œ
(
dma_ch™√ls
[
ch
].
Œ_dma
, dma_ch™√ls[ch].
Œ
);

201 
dma_ch™√ls
[
ch
].
Œ
 = 
NULL
;

202 
	`dma_de¸emít_ußge
();

204 
dma_ch™√ls
[
ch
].
«me
 = 
NULL
;

205 
	`≤x4008_dma_u∆ock
();

206 
	}
}

208 
EXPORT_SYMBOL_GPL
(
≤x4008_‰ì_ch™√l
);

210 
	$≤x4008_c⁄fig_dma
(
ahb_m1_be
, 
ahb_m2_be
, 
íabÀ
)

212 
dma_cfg
 = 
	`__øw_ªadl
(
DMAC_CONFIG
);

214 
ahb_m1_be
) {

216 
dma_cfg
 &= ~(1 << 1);

219 
dma_cfg
 |= (1 << 1);

225 
ahb_m2_be
) {

227 
dma_cfg
 &= ~(1 << 2);

230 
dma_cfg
 |= (1 << 2);

236 
íabÀ
) {

238 
dma_cfg
 &= ~(1 << 0);

241 
dma_cfg
 |= (1 << 0);

247 
	`≤x4008_dma_lock
();

248 
	`__øw_wrôñ
(
dma_cfg
, 
DMAC_CONFIG
);

249 
	`≤x4008_dma_u∆ock
();

252 
	}
}

254 
EXPORT_SYMBOL_GPL
(
≤x4008_c⁄fig_dma
);

256 
	$≤x4008_dma_∑ck_c⁄åﬁ
(c⁄° 
≤x4008_dma_ch_˘æ
 * 
ch_˘æ
,

257 *
˘æ
)

259 
i
 = 0, 
dbsize
, 
sbsize
, 
îr
 = 0;

261 i‡(!
˘æ
 || !
ch_˘æ
) {

262 
îr
 = -
EINVAL
;

263 
out
;

266 *
˘æ
 = 0;

268 
ch_˘æ
->
tc_mask
) {

272 *
˘æ
 |= (1 << 31);

276 
îr
 = -
EINVAL
;

277 
out
;

280 
ch_˘æ
->
ˇchóbÀ
) {

284 *
˘æ
 |= (1 << 30);

288 
îr
 = -
EINVAL
;

289 
out
;

291 
ch_˘æ
->
buf„øbÀ
) {

295 *
˘æ
 |= (1 << 29);

299 
îr
 = -
EINVAL
;

300 
out
;

302 
ch_˘æ
->
¥iv_mode
) {

306 *
˘æ
 |= (1 << 28);

310 
îr
 = -
EINVAL
;

311 
out
;

313 
ch_˘æ
->
di
) {

317 *
˘æ
 |= (1 << 27);

321 
îr
 = -
EINVAL
;

322 
out
;

324 
ch_˘æ
->
si
) {

328 *
˘æ
 |= (1 << 26);

332 
îr
 = -
EINVAL
;

333 
out
;

335 
ch_˘æ
->
de°_ahb1
) {

339 *
˘æ
 |= (1 << 25);

343 
îr
 = -
EINVAL
;

344 
out
;

346 
ch_˘æ
->
§c_ahb1
) {

350 *
˘æ
 |= (1 << 24);

354 
îr
 = -
EINVAL
;

355 
out
;

357 
ch_˘æ
->
dwidth
) {

358 
WIDTH_BYTE
:

359 *
˘æ
 &= ~(7 << 21);

361 
WIDTH_HWORD
:

362 *
˘æ
 &= ~(7 << 21);

363 *
˘æ
 |= (1 << 21);

365 
WIDTH_WORD
:

366 *
˘æ
 &= ~(7 << 21);

367 *
˘æ
 |= (2 << 21);

371 
îr
 = -
EINVAL
;

372 
out
;

374 
ch_˘æ
->
swidth
) {

375 
WIDTH_BYTE
:

376 *
˘æ
 &= ~(7 << 18);

378 
WIDTH_HWORD
:

379 *
˘æ
 &= ~(7 << 18);

380 *
˘æ
 |= (1 << 18);

382 
WIDTH_WORD
:

383 *
˘æ
 &= ~(7 << 18);

384 *
˘æ
 |= (2 << 18);

388 
îr
 = -
EINVAL
;

389 
out
;

391 
dbsize
 = 
ch_˘æ
->dbsize;

392 !(
dbsize
 & 1)) {

393 
i
++;

394 
dbsize
 >>= 1;

396 i‡(
ch_˘æ
->
dbsize
 !1 || 
i
 > 8 || i == 1) {

397 
îr
 = -
EINVAL
;

398 
out
;

399 } i‡(
i
 > 1)

400 
i
--;

401 *
˘æ
 &= ~(7 << 15);

402 *
˘æ
 |(
i
 << 15);

404 
sbsize
 = 
ch_˘æ
->sbsize;

405 !(
sbsize
 & 1)) {

406 
i
++;

407 
sbsize
 >>= 1;

409 i‡(
ch_˘æ
->
sbsize
 !1 || 
i
 > 8 || i == 1) {

410 
îr
 = -
EINVAL
;

411 
out
;

412 } i‡(
i
 > 1)

413 
i
--;

414 *
˘æ
 &= ~(7 << 12);

415 *
˘æ
 |(
i
 << 12);

417 i‡(
ch_˘æ
->
å_size
 > 0x7ff) {

418 
îr
 = -
E2BIG
;

419 
out
;

421 *
˘æ
 &= ~0x7ff;

422 *
˘æ
 |
ch_˘æ
->
å_size
 & 0x7ff;

424 
out
:

425  
îr
;

426 
	}
}

428 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_∑ck_c⁄åﬁ
);

430 
	$≤x4008_dma_∑r£_c⁄åﬁ
(
˘æ
,

431 
≤x4008_dma_ch_˘æ
 * 
ch_˘æ
)

433 
îr
 = 0;

435 i‡(!
ch_˘æ
) {

436 
îr
 = -
EINVAL
;

437 
out
;

440 
ch_˘æ
->
å_size
 = 
˘æ
 & 0x7ff;

441 
˘æ
 >>= 12;

443 
ch_˘æ
->
sbsize
 = 1 << (
˘æ
 & 7);

444 i‡(
ch_˘æ
->
sbsize
 > 1)

445 
ch_˘æ
->
sbsize
 <<= 1;

446 
˘æ
 >>= 3;

448 
ch_˘æ
->
dbsize
 = 1 << (
˘æ
 & 7);

449 i‡(
ch_˘æ
->
dbsize
 > 1)

450 
ch_˘æ
->
dbsize
 <<= 1;

451 
˘æ
 >>= 3;

453 
˘æ
 & 7) {

455 
ch_˘æ
->
swidth
 = 
WIDTH_BYTE
;

458 
ch_˘æ
->
swidth
 = 
WIDTH_HWORD
;

461 
ch_˘æ
->
swidth
 = 
WIDTH_WORD
;

464 
îr
 = -
EINVAL
;

465 
out
;

467 
˘æ
 >>= 3;

469 
˘æ
 & 7) {

471 
ch_˘æ
->
dwidth
 = 
WIDTH_BYTE
;

474 
ch_˘æ
->
dwidth
 = 
WIDTH_HWORD
;

477 
ch_˘æ
->
dwidth
 = 
WIDTH_WORD
;

480 
îr
 = -
EINVAL
;

481 
out
;

483 
˘æ
 >>= 3;

485 
ch_˘æ
->
§c_ahb1
 = 
˘æ
 & 1;

486 
˘æ
 >>= 1;

488 
ch_˘æ
->
de°_ahb1
 = 
˘æ
 & 1;

489 
˘æ
 >>= 1;

491 
ch_˘æ
->
si
 = 
˘æ
 & 1;

492 
˘æ
 >>= 1;

494 
ch_˘æ
->
di
 = 
˘æ
 & 1;

495 
˘æ
 >>= 1;

497 
ch_˘æ
->
¥iv_mode
 = 
˘æ
 & 1;

498 
˘æ
 >>= 1;

500 
ch_˘æ
->
buf„øbÀ
 = 
˘æ
 & 1;

501 
˘æ
 >>= 1;

503 
ch_˘æ
->
ˇchóbÀ
 = 
˘æ
 & 1;

504 
˘æ
 >>= 1;

506 
ch_˘æ
->
tc_mask
 = 
˘æ
 & 1;

508 
out
:

509  
îr
;

510 
	}
}

512 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_∑r£_c⁄åﬁ
);

514 
	$≤x4008_dma_∑ck_c⁄fig
(c⁄° 
≤x4008_dma_ch_c⁄fig
 * 
ch_cfg
,

515 *
cfg
)

517 
îr
 = 0;

519 i‡(!
cfg
 || !
ch_cfg
) {

520 
îr
 = -
EINVAL
;

521 
out
;

524 *
cfg
 = 0;

526 
ch_cfg
->
hÆt
) {

530 *
cfg
 |= (1 << 18);

534 
îr
 = -
EINVAL
;

535 
out
;

537 
ch_cfg
->
a˘ive
) {

541 *
cfg
 |= (1 << 17);

545 
îr
 = -
EINVAL
;

546 
out
;

548 
ch_cfg
->
lock
) {

552 *
cfg
 |= (1 << 16);

556 
îr
 = -
EINVAL
;

557 
out
;

559 
ch_cfg
->
ôc
) {

563 *
cfg
 |= (1 << 15);

567 
îr
 = -
EINVAL
;

568 
out
;

570 
ch_cfg
->
õ
) {

574 *
cfg
 |= (1 << 14);

578 
îr
 = -
EINVAL
;

579 
out
;

581 
ch_cfg
->
Êow_˙ål
) {

582 
FC_MEM2MEM_DMA
:

583 *
cfg
 &= ~(7 << 11);

585 
FC_MEM2PER_DMA
:

586 *
cfg
 &= ~(7 << 11);

587 *
cfg
 |= (1 << 11);

589 
FC_PER2MEM_DMA
:

590 *
cfg
 &= ~(7 << 11);

591 *
cfg
 |= (2 << 11);

593 
FC_PER2PER_DMA
:

594 *
cfg
 &= ~(7 << 11);

595 *
cfg
 |= (3 << 11);

597 
FC_PER2PER_DPER
:

598 *
cfg
 &= ~(7 << 11);

599 *
cfg
 |= (4 << 11);

601 
FC_MEM2PER_PER
:

602 *
cfg
 &= ~(7 << 11);

603 *
cfg
 |= (5 << 11);

605 
FC_PER2MEM_PER
:

606 *
cfg
 &= ~(7 << 11);

607 *
cfg
 |= (6 << 11);

609 
FC_PER2PER_SPER
:

610 *
cfg
 |= (7 << 11);

614 
îr
 = -
EINVAL
;

615 
out
;

617 *
cfg
 &= ~(0x1f << 6);

618 *
cfg
 |((
ch_cfg
->
de°_≥r
 & 0x1f) << 6);

620 *
cfg
 &= ~(0x1f << 1);

621 *
cfg
 |((
ch_cfg
->
§c_≥r
 & 0x1f) << 1);

623 
out
:

624  
îr
;

625 
	}
}

627 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_∑ck_c⁄fig
);

629 
	$≤x4008_dma_∑r£_c⁄fig
(
cfg
,

630 
≤x4008_dma_ch_c⁄fig
 * 
ch_cfg
)

632 
îr
 = 0;

634 i‡(!
ch_cfg
) {

635 
îr
 = -
EINVAL
;

636 
out
;

639 
cfg
 >>= 1;

641 
ch_cfg
->
§c_≥r
 = 
cfg
 & 0x1f;

642 
cfg
 >>= 5;

644 
ch_cfg
->
de°_≥r
 = 
cfg
 & 0x1f;

645 
cfg
 >>= 5;

647 
cfg
 & 7) {

649 
ch_cfg
->
Êow_˙ål
 = 
FC_MEM2MEM_DMA
;

652 
ch_cfg
->
Êow_˙ål
 = 
FC_MEM2PER_DMA
;

655 
ch_cfg
->
Êow_˙ål
 = 
FC_PER2MEM_DMA
;

658 
ch_cfg
->
Êow_˙ål
 = 
FC_PER2PER_DMA
;

661 
ch_cfg
->
Êow_˙ål
 = 
FC_PER2PER_DPER
;

664 
ch_cfg
->
Êow_˙ål
 = 
FC_MEM2PER_PER
;

667 
ch_cfg
->
Êow_˙ål
 = 
FC_PER2MEM_PER
;

670 
ch_cfg
->
Êow_˙ål
 = 
FC_PER2PER_SPER
;

672 
cfg
 >>= 3;

674 
ch_cfg
->
õ
 = 
cfg
 & 1;

675 
cfg
 >>= 1;

677 
ch_cfg
->
ôc
 = 
cfg
 & 1;

678 
cfg
 >>= 1;

680 
ch_cfg
->
lock
 = 
cfg
 & 1;

681 
cfg
 >>= 1;

683 
ch_cfg
->
a˘ive
 = 
cfg
 & 1;

684 
cfg
 >>= 1;

686 
ch_cfg
->
hÆt
 = 
cfg
 & 1;

688 
out
:

689  
îr
;

690 
	}
}

692 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_∑r£_c⁄fig
);

694 
	$≤x4008_dma_•lô_hód_íåy
(
≤x4008_dma_c⁄fig
 * 
c⁄fig
,

695 
≤x4008_dma_ch_˘æ
 * 
˘æ
)

697 
√w_Àn
 = 
˘æ
->
å_size
, 
num_íåõs
 = 0;

698 
ﬁd_Àn
 = 
√w_Àn
;

699 
§c_width
, 
de°_width
, 
cou¡
 = 1;

701 
˘æ
->
swidth
) {

702 
WIDTH_BYTE
:

703 
§c_width
 = 1;

705 
WIDTH_HWORD
:

706 
§c_width
 = 2;

708 
WIDTH_WORD
:

709 
§c_width
 = 4;

715 
˘æ
->
dwidth
) {

716 
WIDTH_BYTE
:

717 
de°_width
 = 1;

719 
WIDTH_HWORD
:

720 
de°_width
 = 2;

722 
WIDTH_WORD
:

723 
de°_width
 = 4;

729 
√w_Àn
 > 0x7FF) {

730 
num_íåõs
++;

731 
√w_Àn
 = (
˘æ
->
å_size
 + 
num_íåõs
) / (num_entries + 1);

733 i‡(
num_íåõs
 != 0) {

734 
≤x4008_dma_Œ
 *
Œ
 = 
NULL
;

735 
c⁄fig
->
ch_˘æ
 &= ~0x7ff;

736 
c⁄fig
->
ch_˘æ
 |
√w_Àn
;

737 i‡(!
c⁄fig
->
is_Œ
) {

738 
c⁄fig
->
is_Œ
 = 1;

739 
num_íåõs
) {

740 i‡(!
Œ
) {

741 
c⁄fig
->
Œ
 =

742 
	`≤x4008_Æloc_Œ_íåy
(&
c⁄fig
->

743 
Œ_dma
);

744 
Œ
 = 
c⁄fig
->ll;

746 
Œ
->
√xt
 =

747 
	`≤x4008_Æloc_Œ_íåy
(&
Œ
->

748 
√xt_dma
);

749 
Œ
 =Ül->
√xt
;

752 i‡(
˘æ
->
si
)

753 
Œ
->
§c_addr
 =

754 
c⁄fig
->
§c_addr
 +

755 
§c_width
 * 
√w_Àn
 * 
cou¡
;

757 
Œ
->
§c_addr
 = 
c⁄fig
->src_addr;

758 i‡(
˘æ
->
di
)

759 
Œ
->
de°_addr
 =

760 
c⁄fig
->
de°_addr
 +

761 
de°_width
 * 
√w_Àn
 * 
cou¡
;

763 
Œ
->
de°_addr
 = 
c⁄fig
->dest_addr;

764 
Œ
->
ch_˘æ
 = 
c⁄fig
->ch_ctrl & 0x7fffffff;

765 
Œ
->
√xt_dma
 = 0;

766 
Œ
->
√xt
 = 
NULL
;

767 
num_íåõs
--;

768 
cou¡
++;

771 
≤x4008_dma_Œ
 *
Œ_ﬁd
 = 
c⁄fig
->
Œ
;

772 
Œ_dma_ﬁd
 = 
c⁄fig
->
Œ_dma
;

773 
num_íåõs
) {

774 i‡(!
Œ
) {

775 
c⁄fig
->
Œ
 =

776 
	`≤x4008_Æloc_Œ_íåy
(&
c⁄fig
->

777 
Œ_dma
);

778 
Œ
 = 
c⁄fig
->ll;

780 
Œ
->
√xt
 =

781 
	`≤x4008_Æloc_Œ_íåy
(&
Œ
->

782 
√xt_dma
);

783 
Œ
 =Ül->
√xt
;

786 i‡(
˘æ
->
si
)

787 
Œ
->
§c_addr
 =

788 
c⁄fig
->
§c_addr
 +

789 
§c_width
 * 
√w_Àn
 * 
cou¡
;

791 
Œ
->
§c_addr
 = 
c⁄fig
->src_addr;

792 i‡(
˘æ
->
di
)

793 
Œ
->
de°_addr
 =

794 
c⁄fig
->
de°_addr
 +

795 
de°_width
 * 
√w_Àn
 * 
cou¡
;

797 
Œ
->
de°_addr
 = 
c⁄fig
->dest_addr;

798 
Œ
->
ch_˘æ
 = 
c⁄fig
->ch_ctrl & 0x7fffffff;

799 
Œ
->
√xt_dma
 = 0;

800 
Œ
->
√xt
 = 
NULL
;

801 
num_íåõs
--;

802 
cou¡
++;

804 
Œ
->
√xt_dma
 = 
Œ_dma_ﬁd
;

805 
Œ
->
√xt
 = 
Œ_ﬁd
;

808 
Œ
->
ch_˘æ
 = 
c⁄fig
->ch_ctrl & (~0x7ff);

809 
Œ
->
ch_˘æ
 |
ﬁd_Àn
 - 
√w_Àn
 * (
cou¡
 - 1);

810 
c⁄fig
->
ch_˘æ
 &= 0x7fffffff;

812 
	}
}

814 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_•lô_hód_íåy
);

816 
	$≤x4008_dma_•lô_Œ_íåy
(
≤x4008_dma_Œ
 * 
cur_Œ
,

817 
≤x4008_dma_ch_˘æ
 * 
˘æ
)

819 
√w_Àn
 = 
˘æ
->
å_size
, 
num_íåõs
 = 0;

820 
ﬁd_Àn
 = 
√w_Àn
;

821 
§c_width
, 
de°_width
, 
cou¡
 = 1;

823 
˘æ
->
swidth
) {

824 
WIDTH_BYTE
:

825 
§c_width
 = 1;

827 
WIDTH_HWORD
:

828 
§c_width
 = 2;

830 
WIDTH_WORD
:

831 
§c_width
 = 4;

837 
˘æ
->
dwidth
) {

838 
WIDTH_BYTE
:

839 
de°_width
 = 1;

841 
WIDTH_HWORD
:

842 
de°_width
 = 2;

844 
WIDTH_WORD
:

845 
de°_width
 = 4;

851 
√w_Àn
 > 0x7FF) {

852 
num_íåõs
++;

853 
√w_Àn
 = (
˘æ
->
å_size
 + 
num_íåõs
) / (num_entries + 1);

855 i‡(
num_íåõs
 != 0) {

856 
≤x4008_dma_Œ
 *
Œ
 = 
NULL
;

857 
cur_Œ
->
ch_˘æ
 &= ~0x7ff;

858 
cur_Œ
->
ch_˘æ
 |
√w_Àn
;

859 i‡(!
cur_Œ
->
√xt
) {

860 
num_íåõs
) {

861 i‡(!
Œ
) {

862 
cur_Œ
->
√xt
 =

863 
	`≤x4008_Æloc_Œ_íåy
(&
cur_Œ
->

864 
√xt_dma
);

865 
Œ
 = 
cur_Œ
->
√xt
;

867 
Œ
->
√xt
 =

868 
	`≤x4008_Æloc_Œ_íåy
(&
Œ
->

869 
√xt_dma
);

870 
Œ
 =Ül->
√xt
;

873 i‡(
˘æ
->
si
)

874 
Œ
->
§c_addr
 =

875 
cur_Œ
->
§c_addr
 +

876 
§c_width
 * 
√w_Àn
 * 
cou¡
;

878 
Œ
->
§c_addr
 = 
cur_Œ
->src_addr;

879 i‡(
˘æ
->
di
)

880 
Œ
->
de°_addr
 =

881 
cur_Œ
->
de°_addr
 +

882 
de°_width
 * 
√w_Àn
 * 
cou¡
;

884 
Œ
->
de°_addr
 = 
cur_Œ
->dest_addr;

885 
Œ
->
ch_˘æ
 = 
cur_Œ
->ch_ctrl & 0x7fffffff;

886 
Œ
->
√xt_dma
 = 0;

887 
Œ
->
√xt
 = 
NULL
;

888 
num_íåõs
--;

889 
cou¡
++;

892 
≤x4008_dma_Œ
 *
Œ_ﬁd
 = 
cur_Œ
->
√xt
;

893 
Œ_dma_ﬁd
 = 
cur_Œ
->
√xt_dma
;

894 
num_íåõs
) {

895 i‡(!
Œ
) {

896 
cur_Œ
->
√xt
 =

897 
	`≤x4008_Æloc_Œ_íåy
(&
cur_Œ
->

898 
√xt_dma
);

899 
Œ
 = 
cur_Œ
->
√xt
;

901 
Œ
->
√xt
 =

902 
	`≤x4008_Æloc_Œ_íåy
(&
Œ
->

903 
√xt_dma
);

904 
Œ
 =Ül->
√xt
;

907 i‡(
˘æ
->
si
)

908 
Œ
->
§c_addr
 =

909 
cur_Œ
->
§c_addr
 +

910 
§c_width
 * 
√w_Àn
 * 
cou¡
;

912 
Œ
->
§c_addr
 = 
cur_Œ
->src_addr;

913 i‡(
˘æ
->
di
)

914 
Œ
->
de°_addr
 =

915 
cur_Œ
->
de°_addr
 +

916 
de°_width
 * 
√w_Àn
 * 
cou¡
;

918 
Œ
->
de°_addr
 = 
cur_Œ
->dest_addr;

919 
Œ
->
ch_˘æ
 = 
cur_Œ
->ch_ctrl & 0x7fffffff;

920 
Œ
->
√xt_dma
 = 0;

921 
Œ
->
√xt
 = 
NULL
;

922 
num_íåõs
--;

923 
cou¡
++;

926 
Œ
->
√xt_dma
 = 
Œ_dma_ﬁd
;

927 
Œ
->
√xt
 = 
Œ_ﬁd
;

930 
Œ
->
ch_˘æ
 = 
cur_Œ
->ch_ctrl & (~0x7ff);

931 
Œ
->
ch_˘æ
 |
ﬁd_Àn
 - 
√w_Àn
 * (
cou¡
 - 1);

932 
cur_Œ
->
ch_˘æ
 &= 0x7fffffff;

934 
	}
}

936 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_•lô_Œ_íåy
);

938 
	$≤x4008_c⁄fig_ch™√l
(
ch
, 
≤x4008_dma_c⁄fig
 * 
c⁄fig
)

940 i‡(!
	`VALID_CHANNEL
(
ch
Ë|| !
dma_ch™√ls
[ch].
«me
)

941  -
EINVAL
;

943 
	`≤x4008_dma_lock
();

944 
	`__øw_wrôñ
(
c⁄fig
->
§c_addr
, 
	`DMAC_Cx_SRC_ADDR
(
ch
));

945 
	`__øw_wrôñ
(
c⁄fig
->
de°_addr
, 
	`DMAC_Cx_DEST_ADDR
(
ch
));

947 i‡(
c⁄fig
->
is_Œ
)

948 
	`__øw_wrôñ
(
c⁄fig
->
Œ_dma
, 
	`DMAC_Cx_LLI
(
ch
));

950 
	`__øw_wrôñ
(0, 
	`DMAC_Cx_LLI
(
ch
));

952 
	`__øw_wrôñ
(
c⁄fig
->
ch_˘æ
, 
	`DMAC_Cx_CONTROL
(
ch
));

953 
	`__øw_wrôñ
(
c⁄fig
->
ch_cfg
, 
	`DMAC_Cx_CONFIG
(
ch
));

954 
	`≤x4008_dma_u∆ock
();

958 
	}
}

960 
EXPORT_SYMBOL_GPL
(
≤x4008_c⁄fig_ch™√l
);

962 
	$≤x4008_ch™√l_gë_c⁄fig
(
ch
, 
≤x4008_dma_c⁄fig
 * 
c⁄fig
)

964 i‡(!
	`VALID_CHANNEL
(
ch
Ë|| !
dma_ch™√ls
[ch].
«me
 || !
c⁄fig
)

965  -
EINVAL
;

967 
	`≤x4008_dma_lock
();

968 
c⁄fig
->
ch_cfg
 = 
	`__øw_ªadl
(
	`DMAC_Cx_CONFIG
(
ch
));

969 
c⁄fig
->
ch_˘æ
 = 
	`__øw_ªadl
(
	`DMAC_Cx_CONTROL
(
ch
));

971 
c⁄fig
->
Œ_dma
 = 
	`__øw_ªadl
(
	`DMAC_Cx_LLI
(
ch
));

972 
c⁄fig
->
is_Œ
 = c⁄fig->
Œ_dma
 ? 1 : 0;

974 
c⁄fig
->
§c_addr
 = 
	`__øw_ªadl
(
	`DMAC_Cx_SRC_ADDR
(
ch
));

975 
c⁄fig
->
de°_addr
 = 
	`__øw_ªadl
(
	`DMAC_Cx_DEST_ADDR
(
ch
));

976 
	`≤x4008_dma_u∆ock
();

979 
	}
}

981 
EXPORT_SYMBOL_GPL
(
≤x4008_ch™√l_gë_c⁄fig
);

983 
	$≤x4008_dma_ch_íabÀ
(
ch
)

985 
ch_cfg
;

987 i‡(!
	`VALID_CHANNEL
(
ch
Ë|| !
dma_ch™√ls
[ch].
«me
)

988  -
EINVAL
;

990 
	`≤x4008_dma_lock
();

991 
ch_cfg
 = 
	`__øw_ªadl
(
	`DMAC_Cx_CONFIG
(
ch
));

992 
ch_cfg
 |= 1;

993 
	`__øw_wrôñ
(
ch_cfg
, 
	`DMAC_Cx_CONFIG
(
ch
));

994 
	`≤x4008_dma_u∆ock
();

997 
	}
}

999 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_ch_íabÀ
);

1001 
	$≤x4008_dma_ch_dißbÀ
(
ch
)

1003 
ch_cfg
;

1005 i‡(!
	`VALID_CHANNEL
(
ch
Ë|| !
dma_ch™√ls
[ch].
«me
)

1006  -
EINVAL
;

1008 
	`≤x4008_dma_lock
();

1009 
ch_cfg
 = 
	`__øw_ªadl
(
	`DMAC_Cx_CONFIG
(
ch
));

1010 
ch_cfg
 &= ~1;

1011 
	`__øw_wrôñ
(
ch_cfg
, 
	`DMAC_Cx_CONFIG
(
ch
));

1012 
	`≤x4008_dma_u∆ock
();

1015 
	}
}

1017 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_ch_dißbÀ
);

1019 
	$≤x4008_dma_ch_íabÀd
(
ch
)

1021 
ch_cfg
;

1023 i‡(!
	`VALID_CHANNEL
(
ch
Ë|| !
dma_ch™√ls
[ch].
«me
)

1024  -
EINVAL
;

1026 
	`≤x4008_dma_lock
();

1027 
ch_cfg
 = 
	`__øw_ªadl
(
	`DMAC_Cx_CONFIG
(
ch
));

1028 
	`≤x4008_dma_u∆ock
();

1030  
ch_cfg
 & 1;

1031 
	}
}

1033 
EXPORT_SYMBOL_GPL
(
≤x4008_dma_ch_íabÀd
);

1035 
úqªtu∫_t
 
	$dma_úq_h™dÀr
(
úq
, *
dev_id
)

1037 
i
;

1038 
döt
 = 
	`__øw_ªadl
(
DMAC_INT_STAT
);

1039 
tcöt
 = 
	`__øw_ªadl
(
DMAC_INT_TC_STAT
);

1040 
eöt
 = 
	`__øw_ªadl
(
DMAC_INT_ERR_STAT
);

1041 
i_bô
;

1043 
i
 = 
MAX_DMA_CHANNELS
 - 1; i >= 0; i--) {

1044 
i_bô
 = 1 << 
i
;

1045 i‡(
döt
 & 
i_bô
) {

1046 
dma_ch™√l
 *
ch™√l
 = &
dma_ch™√ls
[
i
];

1048 i‡(
ch™√l
->
«me
 && ch™√l->
úq_h™dÀr
) {

1049 
ˇu£
 = 0;

1051 i‡(
eöt
 & 
i_bô
)

1052 
ˇu£
 |
DMA_ERR_INT
;

1053 i‡(
tcöt
 & 
i_bô
)

1054 
ˇu£
 |
DMA_TC_INT
;

1055 
ch™√l
->
	`úq_h™dÀr
(
i
, 
ˇu£
, ch™√l->
d©a
);

1060 
	`¥ötk
(
KERN_WARNING


1061 "•uriou†IRQ f‹ DMA ch™√»%d\n", 
i
);

1063 i‡(
tcöt
 & 
i_bô
)

1064 
	`__øw_wrôñ
(
i_bô
, 
DMAC_INT_TC_CLEAR
);

1065 i‡(
eöt
 & 
i_bô
)

1066 
	`__øw_wrôñ
(
i_bô
, 
DMAC_INT_ERR_CLEAR
);

1069  
IRQ_HANDLED
;

1070 
	}
}

1072 
__öô
 
	$≤x4008_dma_öô
()

1074 
ªt
, 
i
;

1076 
ªt
 = 
	`ªque°_úq
(
DMA_INT
, 
dma_úq_h™dÀr
, 0, "DMA", 
NULL
);

1077 i‡(
ªt
) {

1078 
	`¥ötk
(
KERN_CRIT
 "Wow! Can'tÑegister IRQ for DMA\n");

1079 
out
;

1082 
Œ_poﬁ
.
cou¡
 = 0x4000 / (
≤x4008_dma_Œ
);

1083 
Œ_poﬁ
.
cur
 =Ül_poﬁ.
vaddr
 =

1084 
	`dma_Æloc_cohîít
(
NULL
, 
Œ_poﬁ
.
cou¡
 * (
≤x4008_dma_Œ
),

1085 &
Œ_poﬁ
.
dma_addr
, 
GFP_KERNEL
);

1087 i‡(!
Œ_poﬁ
.
vaddr
) {

1088 
ªt
 = -
ENOMEM
;

1089 
	`‰ì_úq
(
DMA_INT
, 
NULL
);

1090 
out
;

1093 
i
 = 0; i < 
Œ_poﬁ
.
cou¡
 - 1; i++) {

1094 **
addr
 = 
Œ_poﬁ
.
vaddr
 + 
i
 * (
≤x4008_dma_Œ
);

1095 *
addr
 = (*Ôdd∏+ (
≤x4008_dma_Œ
);

1097 *(*)(
Œ_poﬁ
.
vaddr
 +

1098 (
Œ_poﬁ
.
cou¡
 - 1Ë* (
≤x4008_dma_Œ
)) =

1099 ()
Œ_poﬁ
.
vaddr
;

1101 
	`__øw_wrôñ
(1, 
DMAC_CONFIG
);

1103 
out
:

1104  
ªt
;

1105 
	}
}

1106 
¨ch_öôˇŒ
(
≤x4008_dma_öô
);

	@arch/arm/mach-pnx4008/gpio.c

17 
	~<löux/ty≥s.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<asm/£m≠h‹e.h
>

21 
	~<asm/io.h
>

22 
	~<asm/¨ch/∂©f‹m.h
>

23 
	~<asm/¨ch/gpio.h
>

26 
	#PIO_VA_BASE
 
	`IO_ADDRESS
(
PNX4008_PIO_BASE
)

	)

28 
	#PIO_INP_STATE
 (0x00U)

	)

29 
	#PIO_OUTP_SET
 (0x04U)

	)

30 
	#PIO_OUTP_CLR
 (0x08U)

	)

31 
	#PIO_OUTP_STATE
 (0x0CU)

	)

32 
	#PIO_DRV_SET
 (0x10U)

	)

33 
	#PIO_DRV_CLR
 (0x14U)

	)

34 
	#PIO_DRV_STATE
 (0x18U)

	)

35 
	#PIO_SDINP_STATE
 (0x1CU)

	)

36 
	#PIO_SDOUTP_SET
 (0x20U)

	)

37 
	#PIO_SDOUTP_CLR
 (0x24U)

	)

38 
	#PIO_MUX_SET
 (0x28U)

	)

39 
	#PIO_MUX_CLR
 (0x2CU)

	)

40 
	#PIO_MUX_STATE
 (0x30U)

	)

42 
ölöe
 
	$gpio_lock
()

44 
	`loˇl_úq_dißbÀ
();

45 
	}
}

47 
ölöe
 
	$gpio_u∆ock
()

49 
	`loˇl_úq_íabÀ
();

50 
	}
}

53 
ölöe
 
	$gpio_ªad_bô
(
u32
 
ªg
, 
gpio
)

55 
u32
 
bô
, 
vÆ
;

56 
ªt
 = -
EFAULT
;

58 i‡(
gpio
 < 0)

59 
out
;

61 
bô
 = 
	`GPIO_BIT
(
gpio
);

62 i‡(
bô
) {

63 
vÆ
 = 
	`__øw_ªadl
(
PIO_VA_BASE
 + 
ªg
);

64 
ªt
 = (
vÆ
 & 
bô
) ? 1 : 0;

66 
out
:

67  
ªt
;

68 
	}
}

70 
ölöe
 
	$gpio_£t_bô
(
u32
 
ªg
, 
gpio
)

72 
u32
 
bô
, 
vÆ
;

73 
ªt
 = -
EFAULT
;

75 i‡(
gpio
 < 0)

76 
out
;

78 
bô
 = 
	`GPIO_BIT
(
gpio
);

79 i‡(
bô
) {

80 
vÆ
 = 
	`__øw_ªadl
(
PIO_VA_BASE
 + 
ªg
);

81 
vÆ
 |
bô
;

82 
	`__øw_wrôñ
(
vÆ
, 
PIO_VA_BASE
 + 
ªg
);

83 
ªt
 = 0;

85 
out
:

86  
ªt
;

87 
	}
}

90 
	gac˚ss_m≠
[4];

91 
	#INP_INDEX
 0

	)

92 
	#OUTP_INDEX
 1

	)

93 
	#GPIO_INDEX
 2

	)

94 
	#MUX_INDEX
 3

	)

97 
	ggpio_to_öp_m≠
[32] = {

105 
	ggpio_to_mux_m≠
[32] = {

113 
	gouç_to_mux_m≠
[32] = {

120 
	$≤x4008_gpio_ªgi°î_pö
(
pö
)

122 
bô
 = 
	`GPIO_BIT
(
pö
);

123 
ªt
 = -
EBUSY
;

125 
	`gpio_lock
();

127 i‡(
	`GPIO_ISBID
(
pö
)) {

128 i‡(
ac˚ss_m≠
[
GPIO_INDEX
] & 
bô
)

129 
out
;

130 
ac˚ss_m≠
[
GPIO_INDEX
] |
bô
;

132 } i‡(
	`GPIO_ISRAM
(
pö
)) {

133 i‡(
ac˚ss_m≠
[
GPIO_INDEX
] & 
bô
)

134 
out
;

135 
ac˚ss_m≠
[
GPIO_INDEX
] |
bô
;

137 } i‡(
	`GPIO_ISMUX
(
pö
)) {

138 i‡(
ac˚ss_m≠
[
MUX_INDEX
] & 
bô
)

139 
out
;

140 
ac˚ss_m≠
[
MUX_INDEX
] |
bô
;

142 } i‡(
	`GPIO_ISOUT
(
pö
)) {

143 i‡(
ac˚ss_m≠
[
OUTP_INDEX
] & 
bô
)

144 
out
;

145 
ac˚ss_m≠
[
OUTP_INDEX
] |
bô
;

147 } i‡(
	`GPIO_ISIN
(
pö
)) {

148 i‡(
ac˚ss_m≠
[
INP_INDEX
] & 
bô
)

149 
out
;

150 
ac˚ss_m≠
[
INP_INDEX
] |
bô
;

152 
out
;

153 
ªt
 = 0;

155 
out
:

156 
	`gpio_u∆ock
();

157  
ªt
;

158 
	}
}

160 
EXPORT_SYMBOL
(
≤x4008_gpio_ªgi°î_pö
);

162 
	$≤x4008_gpio_uƒegi°î_pö
(
pö
)

164 
bô
 = 
	`GPIO_BIT
(
pö
);

165 
ªt
 = -
EFAULT
;

167 
	`gpio_lock
();

169 i‡(
	`GPIO_ISBID
(
pö
)) {

170 i‡(~
ac˚ss_m≠
[
GPIO_INDEX
] & 
bô
)

171 
out
;

172 
ac˚ss_m≠
[
GPIO_INDEX
] &~
bô
;

173 } i‡(
	`GPIO_ISRAM
(
pö
)) {

174 i‡(~
ac˚ss_m≠
[
GPIO_INDEX
] & 
bô
)

175 
out
;

176 
ac˚ss_m≠
[
GPIO_INDEX
] &~
bô
;

177 } i‡(
	`GPIO_ISMUX
(
pö
)) {

178 i‡(~
ac˚ss_m≠
[
MUX_INDEX
] & 
bô
)

179 
out
;

180 
ac˚ss_m≠
[
MUX_INDEX
] &~
bô
;

181 } i‡(
	`GPIO_ISOUT
(
pö
)) {

182 i‡(~
ac˚ss_m≠
[
OUTP_INDEX
] & 
bô
)

183 
out
;

184 
ac˚ss_m≠
[
OUTP_INDEX
] &~
bô
;

185 } i‡(
	`GPIO_ISIN
(
pö
)) {

186 i‡(~
ac˚ss_m≠
[
INP_INDEX
] & 
bô
)

187 
out
;

188 
ac˚ss_m≠
[
INP_INDEX
] &~
bô
;

190 
out
;

191 
ªt
 = 0;

193 
out
:

194 
	`gpio_u∆ock
();

195  
ªt
;

196 
	}
}

198 
EXPORT_SYMBOL
(
≤x4008_gpio_uƒegi°î_pö
);

200 
	$≤x4008_gpio_ªad_pö
(
pö
)

202 
ªt
 = -
EFAULT
;

203 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

204 
	`gpio_lock
();

205 i‡(
	`GPIO_ISOUT
(
pö
)) {

206 
ªt
 = 
	`gpio_ªad_bô
(
PIO_OUTP_STATE
, 
gpio
);

207 } i‡(
	`GPIO_ISRAM
(
pö
)) {

208 i‡(
	`gpio_ªad_bô
(
PIO_DRV_STATE
, 
gpio
) == 0) {

209 
ªt
 = 
	`gpio_ªad_bô
(
PIO_SDINP_STATE
, 
gpio
);

211 } i‡(
	`GPIO_ISBID
(
pö
)) {

212 
ªt
 = 
	`gpio_ªad_bô
(
PIO_DRV_STATE
, 
gpio
);

213 i‡(
ªt
 > 0)

214 
ªt
 = 
	`gpio_ªad_bô
(
PIO_OUTP_STATE
, 
gpio
);

215 i‡(
ªt
 == 0)

216 
ªt
 =

217 
	`gpio_ªad_bô
(
PIO_INP_STATE
, 
gpio_to_öp_m≠
[
gpio
]);

218 } i‡(
	`GPIO_ISIN
(
pö
)) {

219 
ªt
 = 
	`gpio_ªad_bô
(
PIO_INP_STATE
, 
gpio
);

221 
	`gpio_u∆ock
();

222  
ªt
;

223 
	}
}

225 
EXPORT_SYMBOL
(
≤x4008_gpio_ªad_pö
);

228 
	$≤x4008_gpio_wrôe_pö
(
pö
, 
ouçut
)

230 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

231 
ªt
 = -
EFAULT
;

233 
	`gpio_lock
();

234 i‡(
	`GPIO_ISOUT
(
pö
)) {

235 
	`¥ötk
( "writing '%x'Åo '%x'\n",

236 
gpio
, 
ouçut
 ? 
PIO_OUTP_SET
 : 
PIO_OUTP_CLR
 );

237 
ªt
 = 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_OUTP_SET
 : 
PIO_OUTP_CLR
, 
gpio
);

238 } i‡(
	`GPIO_ISRAM
(
pö
)) {

239 i‡(
	`gpio_ªad_bô
(
PIO_DRV_STATE
, 
gpio
) > 0)

240 
ªt
 = 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_SDOUTP_SET
 :

241 
PIO_SDOUTP_CLR
, 
gpio
);

242 } i‡(
	`GPIO_ISBID
(
pö
)) {

243 i‡(
	`gpio_ªad_bô
(
PIO_DRV_STATE
, 
gpio
) > 0)

244 
ªt
 = 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_OUTP_SET
 :

245 
PIO_OUTP_CLR
, 
gpio
);

247 
	`gpio_u∆ock
();

248  
ªt
;

249 
	}
}

251 
EXPORT_SYMBOL
(
≤x4008_gpio_wrôe_pö
);

255 
	$≤x4008_gpio_£t_pö_dúe˘i⁄
(
pö
, 
ouçut
)

257 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

258 
ªt
 = -
EFAULT
;

260 
	`gpio_lock
();

261 i‡(
	`GPIO_ISBID
(
pö
Ë|| 
	`GPIO_ISRAM
(pin)) {

262 
ªt
 = 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_DRV_SET
 : 
PIO_DRV_CLR
, 
gpio
);

264 
	`gpio_u∆ock
();

265  
ªt
;

266 
	}
}

268 
EXPORT_SYMBOL
(
≤x4008_gpio_£t_pö_dúe˘i⁄
);

271 
	$≤x4008_gpio_ªad_pö_dúe˘i⁄
(
pö
)

273 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

274 
ªt
 = -
EFAULT
;

276 
	`gpio_lock
();

277 i‡(
	`GPIO_ISBID
(
pö
Ë|| 
	`GPIO_ISRAM
(pin)) {

278 
ªt
 = 
	`gpio_ªad_bô
(
PIO_DRV_STATE
, 
gpio
);

280 
	`gpio_u∆ock
();

281  
ªt
;

282 
	}
}

284 
EXPORT_SYMBOL
(
≤x4008_gpio_ªad_pö_dúe˘i⁄
);

288 
	$≤x4008_gpio_£t_pö_mux
(
pö
, 
ouçut
)

290 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

291 
ªt
 = -
EFAULT
;

293 
	`gpio_lock
();

294 i‡(
	`GPIO_ISBID
(
pö
)) {

295 
ªt
 =

296 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_MUX_SET
 : 
PIO_MUX_CLR
,

297 
gpio_to_mux_m≠
[
gpio
]);

298 } i‡(
	`GPIO_ISOUT
(
pö
)) {

299 
ªt
 =

300 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_MUX_SET
 : 
PIO_MUX_CLR
,

301 
ouç_to_mux_m≠
[
gpio
]);

302 } i‡(
	`GPIO_ISMUX
(
pö
)) {

303 
ªt
 = 
	`gpio_£t_bô
(
ouçut
 ? 
PIO_MUX_SET
 : 
PIO_MUX_CLR
, 
gpio
);

305 
	`gpio_u∆ock
();

306  
ªt
;

307 
	}
}

309 
EXPORT_SYMBOL
(
≤x4008_gpio_£t_pö_mux
);

312 
	$≤x4008_gpio_ªad_pö_mux
(
pö
)

314 
gpio
 = 
	`GPIO_BIT_MASK
(
pö
);

315 
ªt
 = -
EFAULT
;

317 
	`gpio_lock
();

318 i‡(
	`GPIO_ISBID
(
pö
)) {

319 
ªt
 = 
	`gpio_ªad_bô
(
PIO_MUX_STATE
, 
gpio_to_mux_m≠
[
gpio
]);

320 } i‡(
	`GPIO_ISOUT
(
pö
)) {

321 
ªt
 = 
	`gpio_ªad_bô
(
PIO_MUX_STATE
, 
ouç_to_mux_m≠
[
gpio
]);

322 } i‡(
	`GPIO_ISMUX
(
pö
)) {

323 
ªt
 = 
	`gpio_ªad_bô
(
PIO_MUX_STATE
, 
gpio
);

325 
	`gpio_u∆ock
();

326  
ªt
;

327 
	}
}

329 
EXPORT_SYMBOL
(
≤x4008_gpio_ªad_pö_mux
);

	@arch/arm/mach-pnx4008/i2c.c

12 
	~<löux/˛k.h
>

13 
	~<löux/i2c.h
>

14 
	~<löux/i2c-≤x.h
>

15 
	~<löux/∂©f‹m_devi˚.h
>

16 
	~<löux/îr.h
>

17 
	~<asm/¨ch/∂©f‹m.h
>

18 
	~<asm/¨ch/i2c.h
>

20 
	$£t_˛ock_run
(
∂©f‹m_devi˚
 *
pdev
)

22 
˛k
 *clk;

23 
«me
[10];

24 
ªtvÆ
 = 0;

26 
	`¢¥ötf
(
«me
, 10, "i2c%d_ck", 
pdev
->
id
);

27 
˛k
 = 
	`˛k_gë
(&
pdev
->
dev
, 
«me
);

28 i‡(!
	`IS_ERR
(
˛k
)) {

29 
	`˛k_£t_øã
(
˛k
, 1);

30 
	`˛k_put
(
˛k
);

32 
ªtvÆ
 = -
ENOENT
;

34  
ªtvÆ
;

35 
	}
}

37 
	$£t_˛ock_°›
(
∂©f‹m_devi˚
 *
pdev
)

39 
˛k
 *clk;

40 
«me
[10];

41 
ªtvÆ
 = 0;

43 
	`¢¥ötf
(
«me
, 10, "i2c%d_ck", 
pdev
->
id
);

44 
˛k
 = 
	`˛k_gë
(&
pdev
->
dev
, 
«me
);

45 i‡(!
	`IS_ERR
(
˛k
)) {

46 
	`˛k_£t_øã
(
˛k
, 0);

47 
	`˛k_put
(
˛k
);

49 
ªtvÆ
 = -
ENOENT
;

51  
ªtvÆ
;

52 
	}
}

54 
	$i2c_≤x_su•íd
(
∂©f‹m_devi˚
 *
pdev
, 
pm_mesßge_t
 
°©e
)

56 
ªtvÆ
 = 0;

57 #ifde‡
CONFIG_PM


58 
ªtvÆ
 = 
	`£t_˛ock_run
(
pdev
);

60  
ªtvÆ
;

61 
	}
}

63 
	$i2c_≤x_ªsume
(
∂©f‹m_devi˚
 *
pdev
)

65 
ªtvÆ
 = 0;

66 #ifde‡
CONFIG_PM


67 
ªtvÆ
 = 
	`£t_˛ock_run
(
pdev
);

69  
ªtvÆ
;

70 
	}
}

72 
u32
 
	$ˇlcuœã_öput_‰eq
(
∂©f‹m_devi˚
 *
pdev
)

74  
HCLK_MHZ
;

75 
	}
}

78 
i2c_≤x_Ægo_d©a
 
	g≤x_Ægo_d©a0
 = {

79 .
ba£
 = 
PNX4008_I2C1_BASE
,

80 .
	gúq
 = 
I2C_1_INT
,

83 
i2c_≤x_Ægo_d©a
 
	g≤x_Ægo_d©a1
 = {

84 .
ba£
 = 
PNX4008_I2C2_BASE
,

85 .
	gúq
 = 
I2C_2_INT
,

88 
i2c_≤x_Ægo_d©a
 
	g≤x_Ægo_d©a2
 = {

89 .
ba£
 = (
PNX4008_USB_CONFIG_BASE
 + 0x300),

90 .
	gúq
 = 
USB_I2C_INT
,

93 
i2c_ad≠ãr
 
	g≤x_ad≠ãr0
 = {

94 .
«me
 = 
I2C_CHIP_NAME
 "0",

95 .
	gÆgo_d©a
 = &
≤x_Ægo_d©a0
,

97 
i2c_ad≠ãr
 
	g≤x_ad≠ãr1
 = {

98 .
«me
 = 
I2C_CHIP_NAME
 "1",

99 .
	gÆgo_d©a
 = &
≤x_Ægo_d©a1
,

102 
i2c_ad≠ãr
 
	g≤x_ad≠ãr2
 = {

103 .
«me
 = "USB-I2C",

104 .
	gÆgo_d©a
 = &
≤x_Ægo_d©a2
,

107 
i2c_≤x_d©a
 
	gi2c0_d©a
 = {

108 .
su•íd
 = 
i2c_≤x_su•íd
,

109 .
	gªsume
 = 
i2c_≤x_ªsume
,

110 .
	gˇlcuœã_öput_‰eq
 = 
ˇlcuœã_öput_‰eq
,

111 .
	g£t_˛ock_run
 = 
£t_˛ock_run
,

112 .
	g£t_˛ock_°›
 = 
£t_˛ock_°›
,

113 .
	gad≠ãr
 = &
≤x_ad≠ãr0
,

116 
i2c_≤x_d©a
 
	gi2c1_d©a
 = {

117 .
su•íd
 = 
i2c_≤x_su•íd
,

118 .
	gªsume
 = 
i2c_≤x_ªsume
,

119 .
	gˇlcuœã_öput_‰eq
 = 
ˇlcuœã_öput_‰eq
,

120 .
	g£t_˛ock_run
 = 
£t_˛ock_run
,

121 .
	g£t_˛ock_°›
 = 
£t_˛ock_°›
,

122 .
	gad≠ãr
 = &
≤x_ad≠ãr1
,

125 
i2c_≤x_d©a
 
	gi2c2_d©a
 = {

126 .
su•íd
 = 
i2c_≤x_su•íd
,

127 .
	gªsume
 = 
i2c_≤x_ªsume
,

128 .
	gˇlcuœã_öput_‰eq
 = 
ˇlcuœã_öput_‰eq
,

129 .
	g£t_˛ock_run
 = 
£t_˛ock_run
,

130 .
	g£t_˛ock_°›
 = 
£t_˛ock_°›
,

131 .
	gad≠ãr
 = &
≤x_ad≠ãr2
,

134 
∂©f‹m_devi˚
 
	gi2c0_devi˚
 = {

135 .
«me
 = "pnx-i2c",

136 .
	gid
 = 0,

137 .
	gdev
 = {

138 .
∂©f‹m_d©a
 = &
i2c0_d©a
,

142 
∂©f‹m_devi˚
 
	gi2c1_devi˚
 = {

143 .
«me
 = "pnx-i2c",

144 .
	gid
 = 1,

145 .
	gdev
 = {

146 .
∂©f‹m_d©a
 = &
i2c1_d©a
,

150 
∂©f‹m_devi˚
 
	gi2c2_devi˚
 = {

151 .
«me
 = "pnx-i2c",

152 .
	gid
 = 2,

153 .
	gdev
 = {

154 .
∂©f‹m_d©a
 = &
i2c2_d©a
,

158 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

159 &
i2c0_devi˚
,

160 &
i2c1_devi˚
,

161 &
i2c2_devi˚
,

164 
__öô
 
	$≤x4008_ªgi°î_i2c_devi˚s
()

166 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

167 
	}
}

	@arch/arm/mach-pnx4008/irq.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/ty≥s.h
>

19 
	~<löux/mm.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/li°.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/i›‹t.h
>

24 
	~<löux/devi˚.h
>

25 
	~<löux/úq.h
>

26 
	~<asm/h¨dw¨e.h
>

27 
	~<asm/io.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mach-ty≥s.h
>

30 
	~<asm/pgèbÀ.h
>

31 
	~<asm/∑ge.h
>

32 
	~<asm/sy°em.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/úq.h
>

35 
	~<asm/mach/m≠.h
>

36 
	~<asm/¨ch/úq.h
>

38 
u8
 
	g≤x4008_úq_ty≥
[
NR_IRQS
] = 
PNX4008_IRQ_TYPES
;

40 
	$≤x4008_mask_úq
(
úq
)

42 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ER
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_ER(irq));

43 
	}
}

45 
	$≤x4008_unmask_úq
(
úq
)

47 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ER
(
úq
)Ë| 
	`INTC_BIT
(irq), INTC_ER(irq));

48 
	}
}

50 
	$≤x4008_mask_ack_úq
(
úq
)

52 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ER
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_ER(irq));

53 
	`__øw_wrôñ
(
	`INTC_BIT
(
úq
), 
	`INTC_SR
(irq));

54 
	}
}

56 
	$≤x4008_£t_úq_ty≥
(
úq
, 
ty≥
)

58 
ty≥
) {

59 
IRQT_RISING
:

60 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ATR
(
úq
)Ë| 
	`INTC_BIT
(irq), INTC_ATR(irq));

61 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_APR
(
úq
)Ë| 
	`INTC_BIT
(irq), INTC_APR(irq));

62 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

64 
IRQT_FALLING
:

65 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ATR
(
úq
)Ë| 
	`INTC_BIT
(irq), INTC_ATR(irq));

66 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_APR
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_APR(irq));

67 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

69 
IRQT_LOW
:

70 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ATR
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_ATR(irq));

71 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_APR
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_APR(irq));

72 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

74 
IRQT_HIGH
:

75 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_ATR
(
úq
)Ë& ~
	`INTC_BIT
(irq), INTC_ATR(irq));

76 
	`__øw_wrôñ
(
	`__øw_ªadl
(
	`INTC_APR
(
úq
)Ë| 
	`INTC_BIT
(irq), INTC_APR(irq));

77 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

82 
	`¥ötk
(
KERN_ERR
 "PNX4008 IRQ: Unsuµ‹ãd irqÅy≥ %d\n", 
ty≥
);

86 
	}
}

88 
úq_chù
 
	g≤x4008_úq_chù
 = {

89 .
ack
 = 
≤x4008_mask_ack_úq
,

90 .
	gmask
 = 
≤x4008_mask_úq
,

91 .
	gunmask
 = 
≤x4008_unmask_úq
,

92 .
	g£t_ty≥
 = 
≤x4008_£t_úq_ty≥
,

95 
__öô
 
	$≤x4008_öô_úq
()

97 
i
;

100 
i
 = 0; i < 
NR_IRQS
; i++) {

101 
	`£t_úq_Êags
(
i
, 
IRQF_VALID
);

102 
	`£t_úq_chù
(
i
, &
≤x4008_úq_chù
);

103 
	`≤x4008_£t_úq_ty≥
(
i
, 
≤x4008_úq_ty≥
[i]);

107 
	`≤x4008_£t_úq_ty≥
(
SUB1_IRQ_N
, 
≤x4008_úq_ty≥
[SUB1_IRQ_N]);

108 
	`≤x4008_£t_úq_ty≥
(
SUB2_IRQ_N
, 
≤x4008_úq_ty≥
[SUB2_IRQ_N]);

109 
	`≤x4008_£t_úq_ty≥
(
SUB1_FIQ_N
, 
≤x4008_úq_ty≥
[SUB1_FIQ_N]);

110 
	`≤x4008_£t_úq_ty≥
(
SUB2_FIQ_N
, 
≤x4008_úq_ty≥
[SUB2_FIQ_N]);

113 
	`__øw_wrôñ
((1 << 
SUB2_FIQ_N
Ë| (1 << 
SUB1_FIQ_N
) |

114 (1 << 
SUB2_IRQ_N
Ë| (1 << 
SUB1_IRQ_N
),

115 
	`INTC_ER
(
MAIN_BASE_INT
));

116 
	`__øw_wrôñ
(0, 
	`INTC_ER
(
SIC1_BASE_INT
));

117 
	`__øw_wrôñ
(0, 
	`INTC_ER
(
SIC2_BASE_INT
));

118 
	}
}

	@arch/arm/mach-pnx4008/pm.c

14 
	~<löux/pm.h
>

15 
	~<löux/πc.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/¥oc_fs.h
>

18 
	~<löux/pm.h
>

19 
	~<löux/dñay.h
>

20 
	~<löux/˛k.h
>

22 
	~<asm/io.h
>

23 
	~<asm/mach-ty≥s.h
>

24 
	~<asm/ˇcheÊush.h
>

25 
	~<asm/¨ch/pm.h
>

26 
	~<asm/¨ch/˛ock.h
>

28 
	#SRAM_VA
 
	`IO_ADDRESS
(
PNX4008_IRAM_BASE
)

	)

30 *
	gßved_§am
;

32 
˛k
 *
	g∂l4_˛k
;

34 
ölöe
 
	$≤x4008_°™dby
()

36 (*
≤x4008_˝u_°™dby_±r
) ();

38 
	`loˇl_úq_dißbÀ
();

39 
	`loˇl_fiq_dißbÀ
();

41 
	`˛k_dißbÀ
(
∂l4_˛k
);

44 
	`mem˝y
(
ßved_§am
, (*)
SRAM_VA
, 
≤x4008_˝u_°™dby_sz
);

48 
	`Êush_ˇche_Æl
();

51 
	`mem˝y
((*)
SRAM_VA
, 
≤x4008_˝u_°™dby
, 
≤x4008_˝u_°™dby_sz
);

54 
≤x4008_˝u_°™dby_±r
 = (*)
SRAM_VA
;

55 
	`≤x4008_˝u_°™dby_±r
();

58 
	`mem˝y
((*)
SRAM_VA
, 
ßved_§am
, 
≤x4008_˝u_°™dby_sz
);

60 
	`˛k_íabÀ
(
∂l4_˛k
);

62 
	`loˇl_fiq_íabÀ
();

63 
	`loˇl_úq_íabÀ
();

64 
	}
}

66 
ölöe
 
	$≤x4008_su•íd
()

68 (*
≤x4008_˝u_su•íd_±r
) ();

70 
	`loˇl_úq_dißbÀ
();

71 
	`loˇl_fiq_dißbÀ
();

73 
	`˛k_dißbÀ
(
∂l4_˛k
);

75 
	`__øw_wrôñ
(0xffffffff, 
	`START_INT_RSR_REG
(
SE_PIN_BASE_INT
));

76 
	`__øw_wrôñ
(0xffffffff, 
	`START_INT_RSR_REG
(
SE_INT_BASE_INT
));

79 
	`mem˝y
(
ßved_§am
, (*)
SRAM_VA
, 
≤x4008_˝u_su•íd_sz
);

83 
	`Êush_ˇche_Æl
();

86 
	`mem˝y
((*)
SRAM_VA
, 
≤x4008_˝u_su•íd
, 
≤x4008_˝u_su•íd_sz
);

89 
≤x4008_˝u_su•íd_±r
 = (*)
SRAM_VA
;

90 
	`≤x4008_˝u_su•íd_±r
();

93 
	`mem˝y
((*)
SRAM_VA
, 
ßved_§am
, 
≤x4008_˝u_su•íd_sz
);

95 
	`˛k_íabÀ
(
∂l4_˛k
);

97 
	`loˇl_fiq_íabÀ
();

98 
	`loˇl_úq_íabÀ
();

99 
	}
}

101 
	$≤x4008_pm_íãr
(
su•íd_°©e_t
 
°©e
)

103 
°©e
) {

104 
PM_SUSPEND_STANDBY
:

105 
	`≤x4008_°™dby
();

107 
PM_SUSPEND_MEM
:

108 
	`≤x4008_su•íd
();

112 
	}
}

114 
	$≤x4008_pm_vÆid
(
su•íd_°©e_t
 
°©e
)

116  (
°©e
 =
PM_SUSPEND_STANDBY
) ||

117 (
°©e
 =
PM_SUSPEND_MEM
);

118 
	}
}

120 
pm_›s
 
	g≤x4008_pm_›s
 = {

121 .
íãr
 = 
≤x4008_pm_íãr
,

122 .
	gvÆid
 = 
≤x4008_pm_vÆid
,

125 
__öô
 
	$≤x4008_pm_öô
()

127 
u32
 
§am_size_to_Æloˇã
;

129 
∂l4_˛k
 = 
	`˛k_gë
(0, "ck_pll4");

130 i‡(
	`IS_ERR
(
∂l4_˛k
)) {

131 
	`¥ötk
(
KERN_ERR


133  
	`PTR_ERR
(
∂l4_˛k
);

136 i‡(
≤x4008_˝u_°™dby_sz
 > 
≤x4008_˝u_su•íd_sz
)

137 
§am_size_to_Æloˇã
 = 
≤x4008_˝u_°™dby_sz
;

139 
§am_size_to_Æloˇã
 = 
≤x4008_˝u_su•íd_sz
;

141 
ßved_§am
 = 
	`kmÆloc
(
§am_size_to_Æloˇã
, 
GFP_ATOMIC
);

142 i‡(!
ßved_§am
) {

143 
	`¥ötk
(
KERN_ERR


145 
	`˛k_put
(
∂l4_˛k
);

146  -
ENOMEM
;

149 
	`pm_£t_›s
(&
≤x4008_pm_›s
);

151 
	}
}

153 
œã_öôˇŒ
(
≤x4008_pm_öô
);

	@arch/arm/mach-pnx4008/serial.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/ty≥s.h
>

16 
	~<asm/io.h
>

18 
	~<asm/¨ch/∂©f‹m.h
>

19 
	~<asm/h¨dw¨e.h
>

21 
	~<löux/£rül_c‹e.h
>

22 
	~<löux/£rül_ªg.h
>

23 
	~<asm/¨ch/gpio.h
>

25 
	~<asm/¨ch/˛ock.h
>

27 
	#UART_3
 0

	)

28 
	#UART_4
 1

	)

29 
	#UART_5
 2

	)

30 
	#UART_6
 3

	)

31 
	#UART_UNKNOWN
 (-1)

	)

33 
	#UART3_BASE_VA
 
	`IO_ADDRESS
(
PNX4008_UART3_BASE
)

	)

34 
	#UART4_BASE_VA
 
	`IO_ADDRESS
(
PNX4008_UART4_BASE
)

	)

35 
	#UART5_BASE_VA
 
	`IO_ADDRESS
(
PNX4008_UART5_BASE
)

	)

36 
	#UART6_BASE_VA
 
	`IO_ADDRESS
(
PNX4008_UART6_BASE
)

	)

38 
	#UART_FCR_OFFSET
 8

	)

39 
	#UART_FIFO_SIZE
 64

	)

41 
	$≤x4008_u¨t_öô
()

43 
u32
 
tmp
;

44 
i
 = 
UART_FIFO_SIZE
;

46 
	`__øw_wrôñ
(0xC1, 
UART5_BASE_VA
 + 
UART_FCR_OFFSET
);

47 
	`__øw_wrôñ
(0xC1, 
UART3_BASE_VA
 + 
UART_FCR_OFFSET
);

50 
	`__øw_wrôñ
(0x00, 
UART5_BASE_VA
);

51 
	`__øw_wrôñ
(0x00, 
UART3_BASE_VA
);

53 
i
--) {

54 
tmp
 = 
	`__øw_ªadl
(
UART5_BASE_VA
);

55 
tmp
 = 
	`__øw_ªadl
(
UART3_BASE_VA
);

57 
	`__øw_wrôñ
(0, 
UART5_BASE_VA
 + 
UART_FCR_OFFSET
);

58 
	`__øw_wrôñ
(0, 
UART3_BASE_VA
 + 
UART_FCR_OFFSET
);

61 
	`°¨t_öt_£t_risög_edge
(
SE_U3_RX_INT
);

62 
	`°¨t_öt_ack
(
SE_U3_RX_INT
);

63 
	`°¨t_öt_umask
(
SE_U3_RX_INT
);

65 
	`°¨t_öt_£t_risög_edge
(
SE_U5_RX_INT
);

66 
	`°¨t_öt_ack
(
SE_U5_RX_INT
);

67 
	`°¨t_öt_umask
(
SE_U5_RX_INT
);

68 
	}
}

	@arch/arm/mach-pnx4008/time.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/sched.h
>

19 
	~<löux/•ölock.h
>

20 
	~<löux/moduÀ.h
>

21 
	~<löux/kÆlsyms.h
>

22 
	~<löux/time.h
>

23 
	~<löux/timex.h
>

24 
	~<löux/úq.h
>

26 
	~<asm/sy°em.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/io.h
>

29 
	~<asm/Àds.h
>

30 
	~<asm/mach/time.h
>

31 
	~<asm/î∫o.h
>

39 
	$≤x4008_gëtimeoff£t
()

41 
u32
 
ticks_to_m©ch
 =

42 
	`__øw_ªadl
(
HSTIM_MATCH0
Ë- __øw_ªadl(
HSTIM_COUNTER
);

43 
u32
 
ñ≠£d
 = 
LATCH
 - 
ticks_to_m©ch
;

44  (
ñ≠£d
 * (
tick_n£c
 / 1000)Ë/ 
LATCH
;

45 
	}
}

50 
úqªtu∫_t
 
	$≤x4008_timî_öãºu±
(
úq
, *
dev_id
)

52 i‡(
	`__øw_ªadl
(
HSTIM_INT
Ë& 
MATCH0_INT
) {

54 
	`wrôe_£qlock
(&
xtime_lock
);

57 
	`timî_tick
();

64 
	`__øw_wrôñ
(
	`__øw_ªadl
(
HSTIM_MATCH0
Ë+ 
LATCH
,

65 
HSTIM_MATCH0
);

66 
	`__øw_wrôñ
(
MATCH0_INT
, 
HSTIM_INT
);

74 (
	`__øw_ªadl
(
HSTIM_MATCH0
) -

75 
	`__øw_ªadl
(
HSTIM_COUNTER
)) < 0);

77 
	`wrôe_£qu∆ock
(&
xtime_lock
);

80  
IRQ_HANDLED
;

81 
	}
}

83 
úqa˘i⁄
 
	g≤x4008_timî_úq
 = {

84 .
«me
 = "PNX4008 Tick Timer",

85 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

86 .
	gh™dÀr
 = 
≤x4008_timî_öãºu±


92 
__öô
 
	$≤x4008_£tup_timî
()

94 
	`__øw_wrôñ
(
RESET_COUNT
, 
MSTIM_CTRL
);

95 
	`__øw_ªadl
(
MSTIM_COUNTER
)) ;

96 
	`__øw_wrôñ
(0, 
MSTIM_CTRL
);

97 
	`__øw_wrôñ
(0, 
MSTIM_MCTRL
);

99 
	`__øw_wrôñ
(
RESET_COUNT
, 
HSTIM_CTRL
);

100 
	`__øw_ªadl
(
HSTIM_COUNTER
)) ;

101 
	`__øw_wrôñ
(0, 
HSTIM_CTRL
);

102 
	`__øw_wrôñ
(0, 
HSTIM_MCTRL
);

103 
	`__øw_wrôñ
(0, 
HSTIM_CCR
);

104 
	`__øw_wrôñ
(12, 
HSTIM_PMATCH
);

105 
	`__øw_wrôñ
(
LATCH
, 
HSTIM_MATCH0
);

106 
	`__øw_wrôñ
(
MR0_INT
, 
HSTIM_MCTRL
);

108 
	`£tup_úq
(
HSTIMER_INT
, &
≤x4008_timî_úq
);

110 
	`__øw_wrôñ
(
COUNT_ENAB
 | 
DEBUG_EN
, 
HSTIM_CTRL
);

111 
	}
}

114 
	#TIMCLK_CTRL_REG
 
	`IO_ADDRESS
((
PNX4008_PWRMAN_BASE
 + 0xBC))

	)

115 
	#WATCHDOG_CLK_EN
 1

	)

116 
	#TIMER_CLK_EN
 2

	)

118 
u32
 
	gtim˛k_˘æ_ªg_ßve
;

120 
	$≤x4008_timî_su•íd
()

122 
tim˛k_˘æ_ªg_ßve
 = 
	`__øw_ªadl
(
TIMCLK_CTRL_REG
);

123 
	`__øw_wrôñ
(0, 
TIMCLK_CTRL_REG
);

124 
	}
}

126 
	$≤x4008_timî_ªsume
()

128 
	`__øw_wrôñ
(
tim˛k_˘æ_ªg_ßve
, 
TIMCLK_CTRL_REG
);

129 
	}
}

131 
sys_timî
 
	g≤x4008_timî
 = {

132 .
öô
 = 
≤x4008_£tup_timî
,

133 .
	goff£t
 = 
≤x4008_gëtimeoff£t
,

134 .
	gsu•íd
 = 
≤x4008_timî_su•íd
,

135 .
	gªsume
 = 
≤x4008_timî_ªsume
,

	@arch/arm/mach-pxa/akita-ioexp.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/i2c.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/w‹kqueue.h
>

22 
	~<asm/¨ch/akôa.h
>

25 
	#MAX7310_INPUT
 0x00

	)

26 
	#MAX7310_OUTPUT
 0x01

	)

27 
	#MAX7310_POLINV
 0x02

	)

28 
	#MAX7310_IODIR
 0x03

	)

29 
	#MAX7310_TIMEOUT
 0x04

	)

32 
	gn‹mÆ_i2c
[] = { 0x18, 
I2C_CLIENT_END
 };

35 
	gI2C_CLIENT_INSMOD
;

37 
max7310_wrôe
(
i2c_˛õ¡
 *
˛õ¡
, 
addªss
, 
d©a
);

38 
i2c_˛õ¡
 
	gmax7310_ãm∂©e
;

39 
akôa_i€xp_w‹k
(
w‹k_°ru˘
 *
¥iv©e_
);

41 
devi˚
 *
	gakôa_i€xp_devi˚
;

42 
	gi€xp_ouçut_vÆue
 = 
AKITA_IOEXP_IO_OUT
;

43 
DECLARE_WORK
(
akôa_i€xp
, 
akôa_i€xp_w‹k
);

49 
	$max7310_c⁄fig
(
devi˚
 *
dev
, 
iomode
, 
pﬁ¨ôy
)

51 
ªt
;

52 
i2c_˛õ¡
 *
˛õ¡
 = 
	`to_i2c_˛õ¡
(
dev
);

54 
ªt
 = 
	`max7310_wrôe
(
˛õ¡
, 
MAX7310_POLINV
, 
pﬁ¨ôy
);

55 i‡(
ªt
 < 0)

56  
ªt
;

57 
ªt
 = 
	`max7310_wrôe
(
˛õ¡
, 
MAX7310_IODIR
, 
iomode
);

58  
ªt
;

59 
	}
}

61 
	$max7310_£t_ouputs
(
devi˚
 *
dev
, 
ouçuts
)

63 
i2c_˛õ¡
 *
˛õ¡
 = 
	`to_i2c_˛õ¡
(
dev
);

65  
	`max7310_wrôe
(
˛õ¡
, 
MAX7310_OUTPUT
, 
ouçuts
);

66 
	}
}

71 
	$max7310_wrôe
(
i2c_˛õ¡
 *
˛õ¡
, 
addªss
, 
vÆue
)

73 
u8
 
d©a
[2];

75 
d©a
[0] = 
addªss
 & 0xff;

76 
d©a
[1] = 
vÆue
 & 0xff;

78 i‡(
	`i2c_ma°î_£nd
(
˛õ¡
, 
d©a
, 2) == 2)

81 
	}
}

83 
	$max7310_dëe˘
(
i2c_ad≠ãr
 *
ad≠ãr
, 
addªss
, 
köd
)

85 
i2c_˛õ¡
 *
√w_˛õ¡
;

86 
îr
;

88 i‡(!(
√w_˛õ¡
 = 
	`kmÆloc
((
i2c_˛õ¡
), 
GFP_KERNEL
)))

89  -
ENOMEM
;

91 
max7310_ãm∂©e
.
ad≠ãr
 =ádapter;

92 
max7310_ãm∂©e
.
addr
 = 
addªss
;

94 
	`mem˝y
(
√w_˛õ¡
, &
max7310_ãm∂©e
, (
i2c_˛õ¡
));

96 i‡((
îr
 = 
	`i2c_©èch_˛õ¡
(
√w_˛õ¡
))) {

97 
	`k‰ì
(
√w_˛õ¡
);

98  
îr
;

101 
	`max7310_c⁄fig
(&
√w_˛õ¡
->
dev
, 
AKITA_IOEXP_IO_DIR
, 0);

102 
akôa_i€xp_devi˚
 = &
√w_˛õ¡
->
dev
;

103 
	`scheduÀ_w‹k
(&
akôa_i€xp
);

106 
	}
}

108 
	$max7310_©èch_ad≠ãr
(
i2c_ad≠ãr
 *
ad≠ãr
)

110  
	`i2c_¥obe
(
ad≠ãr
, &
addr_d©a
, 
max7310_dëe˘
);

111 
	}
}

113 
	$max7310_dëach_˛õ¡
(
i2c_˛õ¡
 *
˛õ¡
)

115 
îr
;

117 
akôa_i€xp_devi˚
 = 
NULL
;

119 i‡((
îr
 = 
	`i2c_dëach_˛õ¡
(
˛õ¡
)))

120  
îr
;

122 
	`k‰ì
(
˛õ¡
);

124 
	}
}

126 
i2c_drivî
 
	gmax7310_i2c_drivî
 = {

127 .
drivî
 = {

128 .
«me
 = "akita-max7310",

130 .
	gid
 = 
I2C_DRIVERID_AKITAIOEXP
,

131 .
	g©èch_ad≠ãr
 = 
max7310_©èch_ad≠ãr
,

132 .
	gdëach_˛õ¡
 = 
max7310_dëach_˛õ¡
,

135 
i2c_˛õ¡
 
	gmax7310_ãm∂©e
 = {

136 
«me
: "akita-max7310",

137 
drivî
: &
max7310_i2c_drivî
,

140 
	$akôa_£t_i€xp
(
devi˚
 *
dev
, 
bô
)

142 
i€xp_ouçut_vÆue
 |
bô
;

144 i‡(
akôa_i€xp_devi˚
)

145 
	`scheduÀ_w‹k
(&
akôa_i€xp
);

147 
	}
}

149 
	$akôa_ª£t_i€xp
(
devi˚
 *
dev
, 
bô
)

151 
i€xp_ouçut_vÆue
 &~
bô
;

153 i‡(
akôa_i€xp_devi˚
)

154 
	`scheduÀ_w‹k
(&
akôa_i€xp
);

156 
	}
}

158 
EXPORT_SYMBOL
(
akôa_£t_i€xp
);

159 
EXPORT_SYMBOL
(
akôa_ª£t_i€xp
);

161 
	$akôa_i€xp_w‹k
(
w‹k_°ru˘
 *
¥iv©e_
)

163 i‡(
akôa_i€xp_devi˚
)

164 
	`max7310_£t_ouputs
(
akôa_i€xp_devi˚
, 
i€xp_ouçut_vÆue
);

165 
	}
}

168 #ifde‡
CONFIG_PM


169 
	$akôa_i€xp_su•íd
(
∂©f‹m_devi˚
 *
pdev
, 
pm_mesßge_t
 
°©e
)

171 
	`Êush_scheduÀd_w‹k
();

173 
	}
}

175 
	$akôa_i€xp_ªsume
(
∂©f‹m_devi˚
 *
pdev
)

177 
	`scheduÀ_w‹k
(&
akôa_i€xp
);

179 
	}
}

181 
	#akôa_i€xp_su•íd
 
NULL


	)

182 
	#akôa_i€xp_ªsume
 
NULL


	)

185 
__öô
 
	$akôa_i€xp_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

187  
	`i2c_add_drivî
(&
max7310_i2c_drivî
);

188 
	}
}

190 
	$akôa_i€xp_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

192 
	`i2c_dñ_drivî
(&
max7310_i2c_drivî
);

194 
	}
}

196 
∂©f‹m_drivî
 
	gakôa_i€xp_drivî
 = {

197 .
¥obe
 = 
akôa_i€xp_¥obe
,

198 .
	gªmove
 = 
akôa_i€xp_ªmove
,

199 .
	gsu•íd
 = 
akôa_i€xp_su•íd
,

200 .
	gªsume
 = 
akôa_i€xp_ªsume
,

201 .
	gdrivî
 = {

202 .
«me
 = "akita-ioexp",

206 
__öô
 
	$akôa_i€xp_öô
()

208  
	`∂©f‹m_drivî_ªgi°î
(&
akôa_i€xp_drivî
);

209 
	}
}

211 
__exô
 
	$akôa_i€xp_exô
()

213 
	`∂©f‹m_drivî_uƒegi°î
(&
akôa_i€xp_drivî
);

214 
	}
}

216 
MODULE_AUTHOR
("Richard Purdie <rpurdie@openedhand.com>");

217 
MODULE_DESCRIPTION
("Akita IO-Expander driver");

218 
MODULE_LICENSE
("GPL");

220 
fs_öôˇŒ
(
akôa_i€xp_öô
);

221 
moduÀ_exô
(
akôa_i€xp_exô
);

	@arch/arm/mach-pxa/clock.c

4 
	~<löux/moduÀ.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/li°.h
>

7 
	~<löux/î∫o.h
>

8 
	~<löux/îr.h
>

9 
	~<löux/°rög.h
>

10 
	~<löux/˛k.h
>

11 
	~<löux/•ölock.h
>

13 
	~<asm/¨ch/pxa-ªgs.h
>

14 
	~<asm/h¨dw¨e.h
>

15 
	~<asm/£m≠h‹e.h
>

17 
	s˛k
 {

18 
li°_hód
 
	mnode
;

19 
	møã
;

20 
moduÀ
 *
	mow√r
;

21 c⁄° *
	m«me
;

22 
	míabÀd
;

23 (*
	míabÀ
)();

24 (*
	mdißbÀ
)();

27 
LIST_HEAD
(
˛ocks
);

28 
DECLARE_MUTEX
(
˛ocks_£m
);

29 
DEFINE_SPINLOCK
(
˛ocks_lock
);

31 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

33 
˛k
 *
p
, *˛k = 
	`ERR_PTR
(-
ENOENT
);

35 
	`down
(&
˛ocks_£m
);

36 
	`li°_f‹_óch_íåy
(
p
, &
˛ocks
, 
node
) {

37 i‡(
	`°rcmp
(
id
, 
p
->
«me
Ë=0 && 
	`åy_moduÀ_gë
’->
ow√r
)) {

38 
˛k
 = 
p
;

42 
	`up
(&
˛ocks_£m
);

44  
˛k
;

45 
	}
}

46 
EXPORT_SYMBOL
(
˛k_gë
);

48 
	$˛k_put
(
˛k
 *clk)

50 
	`moduÀ_put
(
˛k
->
ow√r
);

51 
	}
}

52 
EXPORT_SYMBOL
(
˛k_put
);

54 
	$˛k_íabÀ
(
˛k
 *clk)

56 
Êags
;

58 
	`•ö_lock_úqßve
(&
˛ocks_lock
, 
Êags
);

59 i‡(
˛k
->
íabÀd
++ == 0)

60 
˛k
->
	`íabÀ
();

61 
	`•ö_u∆ock_úqª°‹e
(&
˛ocks_lock
, 
Êags
);

63 
	}
}

64 
EXPORT_SYMBOL
(
˛k_íabÀ
);

66 
	$˛k_dißbÀ
(
˛k
 *clk)

68 
Êags
;

70 
	`WARN_ON
(
˛k
->
íabÀd
 == 0);

72 
	`•ö_lock_úqßve
(&
˛ocks_lock
, 
Êags
);

73 i‡(--
˛k
->
íabÀd
 == 0)

74 
˛k
->
	`dißbÀ
();

75 
	`•ö_u∆ock_úqª°‹e
(&
˛ocks_lock
, 
Êags
);

76 
	}
}

77 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

79 
	$˛k_gë_øã
(
˛k
 *clk)

81  
˛k
->
øã
;

82 
	}
}

83 
EXPORT_SYMBOL
(
˛k_gë_øã
);

86 
	$˛k_gpio27_íabÀ
()

88 
	`pxa_gpio_mode
(
GPIO11_3_6MHz_MD
);

89 
	}
}

91 
	$˛k_gpio27_dißbÀ
()

93 
	}
}

95 
˛k
 
	g˛k_gpio27
 = {

96 .
«me
 = "GPIO27_CLK",

97 .
	gøã
 = 3686400,

98 .
	gíabÀ
 = 
˛k_gpio27_íabÀ
,

99 .
	gdißbÀ
 = 
˛k_gpio27_dißbÀ
,

102 
	$˛k_ªgi°î
(
˛k
 *clk)

104 
	`down
(&
˛ocks_£m
);

105 
	`li°_add
(&
˛k
->
node
, &
˛ocks
);

106 
	`up
(&
˛ocks_£m
);

108 
	}
}

109 
EXPORT_SYMBOL
(
˛k_ªgi°î
);

111 
	$˛k_uƒegi°î
(
˛k
 *clk)

113 
	`down
(&
˛ocks_£m
);

114 
	`li°_dñ
(&
˛k
->
node
);

115 
	`up
(&
˛ocks_£m
);

116 
	}
}

117 
EXPORT_SYMBOL
(
˛k_uƒegi°î
);

119 
__öô
 
	$˛k_öô
()

121 
	`˛k_ªgi°î
(&
˛k_gpio27
);

123 
	}
}

124 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-pxa/corgi.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/maj‹.h
>

19 
	~<löux/fs.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/mmc/ho°.h
>

22 
	~<löux/pm.h
>

24 
	~<asm/£tup.h
>

25 
	~<asm/mem‹y.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/úq.h
>

29 
	~<asm/io.h
>

30 
	~<asm/sy°em.h
>

32 
	~<asm/mach/¨ch.h
>

33 
	~<asm/mach/m≠.h
>

34 
	~<asm/mach/úq.h
>

36 
	~<asm/¨ch/pxa-ªgs.h
>

37 
	~<asm/¨ch/úda.h
>

38 
	~<asm/¨ch/mmc.h
>

39 
	~<asm/¨ch/udc.h
>

40 
	~<asm/¨ch/c‹gi.h
>

41 
	~<asm/¨ch/sh¨p¶.h
>

43 
	~<asm/mach/sh¨p¶_∑øm.h
>

44 
	~<asm/h¨dw¨e/sco›.h
>

46 
	~"gíîic.h
"

47 
	~"sh¨p¶.h
"

53 
ªsour˚
 
	gc‹gi_sco›_ªsour˚s
[] = {

55 .
°¨t
 = 0x10800000,

56 .
	gíd
 = 0x10800fff,

57 .
	gÊags
 = 
IORESOURCE_MEM
,

61 
sco›_c⁄fig
 
	gc‹gi_sco›_£tup
 = {

62 .
io_dú
 = 
CORGI_SCOOP_IO_DIR
,

63 .
	gio_out
 = 
CORGI_SCOOP_IO_OUT
,

66 
∂©f‹m_devi˚
 
	gc‹gisco›_devi˚
 = {

67 .
«me
 = "sharp-scoop",

68 .
	gid
 = -1,

69 .
	gdev
 = {

70 .
∂©f‹m_d©a
 = &
c‹gi_sco›_£tup
,

72 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
c‹gi_sco›_ªsour˚s
),

73 .
	gªsour˚
 = 
c‹gi_sco›_ªsour˚s
,

76 
	$c‹gi_pcmcü_öô
()

80 
	`GPSR
(
GPIO48_nPOE
Ë
	`GPIO_bô
(GPIO48_nPOE) |

81 
	`GPIO_bô
(
GPIO49_nPWE
Ë| GPIO_bô(
GPIO50_nPIOR
) |

82 
	`GPIO_bô
(
GPIO51_nPIOW
Ë| GPIO_bô(
GPIO52_nPCE_1
) |

83 
	`GPIO_bô
(
GPIO53_nPCE_2
);

85 
	`pxa_gpio_mode
(
GPIO48_nPOE_MD
);

86 
	`pxa_gpio_mode
(
GPIO49_nPWE_MD
);

87 
	`pxa_gpio_mode
(
GPIO50_nPIOR_MD
);

88 
	`pxa_gpio_mode
(
GPIO51_nPIOW_MD
);

89 
	`pxa_gpio_mode
(
GPIO55_nPREG_MD
);

90 
	`pxa_gpio_mode
(
GPIO56_nPWAIT_MD
);

91 
	`pxa_gpio_mode
(
GPIO57_nIOIS16_MD
);

92 
	`pxa_gpio_mode
(
GPIO52_nPCE_1_MD
);

93 
	`pxa_gpio_mode
(
GPIO53_nPCE_2_MD
);

94 
	`pxa_gpio_mode
(
GPIO54_pSKTSEL_MD
);

95 
	}
}

97 
sco›_pcmcü_dev
 
	gc‹gi_pcmcü_sco›
[] = {

99 .
dev
 = &
c‹gisco›_devi˚
.dev,

100 .
	gúq
 = 
CORGI_IRQ_GPIO_CF_IRQ
,

101 .
	gcd_úq
 = 
CORGI_IRQ_GPIO_CF_CD
,

102 .
	gcd_úq_°r
 = "PCMCIA0 CD",

106 
sco›_pcmcü_c⁄fig
 
	gc‹gi_pcmcü_c⁄fig
 = {

107 .
devs
 = &
c‹gi_pcmcü_sco›
[0],

108 .
	gnum_devs
 = 1,

109 .
	gpcmcü_öô
 = 
c‹gi_pcmcü_öô
,

112 
EXPORT_SYMBOL
(
c‹gisco›_devi˚
);

122 
∂©f‹m_devi˚
 
	gc‹gis•_devi˚
 = {

123 .
«me
 = "corgi-ssp",

124 .
	gdev
 = {

125 .
∑ª¡
 = &
c‹gisco›_devi˚
.
dev
,

127 .
	gid
 = -1,

130 
c‹gis•_machöfo
 
	gc‹gi_s•_machöfo
 = {

131 .
p‹t
 = 1,

132 .
	gcs_lcdc⁄
 = 
CORGI_GPIO_LCDCON_CS
,

133 .
	gcs_ads7846
 = 
CORGI_GPIO_ADS7846_CS
,

134 .
	gcs_max1111
 = 
CORGI_GPIO_MAX1111_CS
,

135 .
	g˛k_lcdc⁄
 = 76,

136 .
	g˛k_ads7846
 = 2,

137 .
	g˛k_max1111
 = 8,

144 
c‹gibl_machöfo
 
	gc‹gi_bl_machöfo
 = {

145 .
max_öãnsôy
 = 0x2f,

146 .
	gdeÁu…_öãnsôy
 = 0x1f,

147 .
	glimô_mask
 = 0x0b,

148 .
	g£t_bl_öãnsôy
 = 
c‹gi_bl_£t_öãnsôy
,

151 
∂©f‹m_devi˚
 
	gc‹gibl_devi˚
 = {

152 .
«me
 = "corgi-bl",

153 .
	gdev
 = {

154 .
∑ª¡
 = &
c‹gifb_devi˚
.
dev
,

155 .
	g∂©f‹m_d©a
 = &
c‹gi_bl_machöfo
,

157 .
	gid
 = -1,

164 
∂©f‹m_devi˚
 
	gc‹gikbd_devi˚
 = {

165 .
«me
 = "corgi-keyboard",

166 .
	gid
 = -1,

173 
∂©f‹m_devi˚
 
	gc‹gûed_devi˚
 = {

174 .
«me
 = "corgi-led",

175 .
	gid
 = -1,

181 
ªsour˚
 
	gc‹gôs_ªsour˚s
[] = {

183 .
°¨t
 = 
CORGI_IRQ_GPIO_TP_INT
,

184 .
	gíd
 = 
CORGI_IRQ_GPIO_TP_INT
,

185 .
	gÊags
 = 
IORESOURCE_IRQ
,

189 
c‹gôs_machöfo
 
	gc‹gi_ts_machöfo
 = {

190 .
gë_hsync_Àn
 = 
c‹gi_gë_hsync_Àn
,

191 .
	gput_hsync
 = 
c‹gi_put_hsync
,

192 .
	gwaô_hsync
 = 
c‹gi_waô_hsync
,

195 
∂©f‹m_devi˚
 
	gc‹gôs_devi˚
 = {

196 .
«me
 = "corgi-ts",

197 .
	gdev
 = {

198 .
∑ª¡
 = &
c‹gis•_devi˚
.
dev
,

199 .
	g∂©f‹m_d©a
 = &
c‹gi_ts_machöfo
,

201 .
	gid
 = -1,

202 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
c‹gôs_ªsour˚s
),

203 .
	gªsour˚
 = 
c‹gôs_ªsour˚s
,

213 
pxamci_∂©f‹m_d©a
 
	gc‹gi_mci_∂©f‹m_d©a
;

215 
	$c‹gi_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
c‹gi_dëe˘_öt
, *
d©a
)

217 
îr
;

220 
	`pxa_gpio_mode
(
GPIO6_MMCCLK_MD
);

221 
	`pxa_gpio_mode
(
GPIO8_MMCCS0_MD
);

222 
	`pxa_gpio_mode
(
CORGI_GPIO_nSD_DETECT
 | 
GPIO_IN
);

223 
	`pxa_gpio_mode
(
CORGI_GPIO_SD_PWR
 | 
GPIO_OUT
);

225 
c‹gi_mci_∂©f‹m_d©a
.
dëe˘_dñay
 = 
	`m£cs_to_jiffõs
(250);

227 
îr
 = 
	`ªque°_úq
(
CORGI_IRQ_GPIO_nSD_DETECT
, 
c‹gi_dëe˘_öt
,

228 
IRQF_DISABLED
 | 
IRQF_TRIGGER_RISING
 | 
IRQF_TRIGGER_FALLING
,

229 "MMC c¨d dëe˘", 
d©a
);

230 i‡(
îr
) {

231 
	`¥ötk
(
KERN_ERR
 "corgi_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

236 
	}
}

238 
	$c‹gi_mci_£çowî
(
devi˚
 *
dev
, 
vdd
)

240 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

242 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
)

243 
GPSR1
 = 
	`GPIO_bô
(
CORGI_GPIO_SD_PWR
);

245 
GPCR1
 = 
	`GPIO_bô
(
CORGI_GPIO_SD_PWR
);

246 
	}
}

248 
	$c‹gi_mci_gë_ro
(
devi˚
 *
dev
)

250  
	`GPLR
(
CORGI_GPIO_nSD_WP
Ë& 
	`GPIO_bô
(CORGI_GPIO_nSD_WP);

251 
	}
}

253 
	$c‹gi_mci_exô
(
devi˚
 *
dev
, *
d©a
)

255 
	`‰ì_úq
(
CORGI_IRQ_GPIO_nSD_DETECT
, 
d©a
);

256 
	}
}

258 
pxamci_∂©f‹m_d©a
 
	gc‹gi_mci_∂©f‹m_d©a
 = {

259 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

260 .
	göô
 = 
c‹gi_mci_öô
,

261 .
	ggë_ro
 = 
c‹gi_mci_gë_ro
,

262 .
	g£çowî
 = 
c‹gi_mci_£çowî
,

263 .
	gexô
 = 
c‹gi_mci_exô
,

270 
	$c‹gi_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

272 i‡(
mode
 & 
IR_OFF
)

273 
	`GPSR
(
CORGI_GPIO_IR_ON
Ë
	`GPIO_bô
(CORGI_GPIO_IR_ON);

275 
	`GPCR
(
CORGI_GPIO_IR_ON
Ë
	`GPIO_bô
(CORGI_GPIO_IR_ON);

276 
	}
}

278 
pxafi˝_∂©f‹m_d©a
 
	gc‹gi_fi˝_∂©f‹m_d©a
 = {

279 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_OFF
,

280 .
	gå™s˚ivî_mode
 = 
c‹gi_úda_å™s˚ivî_mode
,

287 
pxa2xx_udc_mach_öfo
 
udc_öfo
 
	g__öôd©a
 = {

289 .
gpio_puŒup
 = 
CORGI_GPIO_USB_PULLUP
,

293 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

294 &
c‹gisco›_devi˚
,

295 &
c‹gis•_devi˚
,

296 &
c‹gifb_devi˚
,

297 &
c‹gikbd_devi˚
,

298 &
c‹gibl_devi˚
,

299 &
c‹gôs_devi˚
,

300 &
c‹gûed_devi˚
,

303 
	$c‹gi_powîoff
()

305 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

307 i‡(!
	`machöe_is_c‹gi
())

309 
	`ª£t_sco›_gpio
(&
c‹gisco›_devi˚
.
dev
, 
CORGI_SCP_LED_GREEN
);

310 
	`¨m_machöe_ª°¨t
('h');

311 
	}
}

313 
	$c‹gi_ª°¨t
(
mode
)

315 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

317 i‡(!
	`machöe_is_c‹gi
())

319 
	`£t_sco›_gpio
(&
c‹gisco›_devi˚
.
dev
, 
CORGI_SCP_LED_GREEN
);

320 
	`¨m_machöe_ª°¨t
('h');

321 
	}
}

323 
__öô
 
	$c‹gi_öô
()

325 
pm_powî_off
 = 
c‹gi_powîoff
;

326 
¨m_pm_ª°¨t
 = 
c‹gi_ª°¨t
;

329 
PWER
 = 0x00000002;

330 
PFER
 = 0x00000000;

331 
PRER
 = 0x00000002;

332 
PGSR0
 = 0x0158C000;

333 
PGSR1
 = 0x00FF0080;

334 
PGSR2
 = 0x0001C004;

336 
PCFR
 |
PCFR_OPDE
;

338 
	`c‹gi_s•_£t_machöfo
(&
c‹gi_s•_machöfo
);

340 
	`pxa_gpio_mode
(
CORGI_GPIO_IR_ON
 | 
GPIO_OUT
);

341 
	`pxa_gpio_mode
(
CORGI_GPIO_HSYNC
 | 
GPIO_IN
);

343 
	`pxa_£t_udc_öfo
(&
udc_öfo
);

344 
	`pxa_£t_mci_öfo
(&
c‹gi_mci_∂©f‹m_d©a
);

345 
	`pxa_£t_fi˝_öfo
(&
c‹gi_fi˝_∂©f‹m_d©a
);

347 
∂©f‹m_sco›_c⁄fig
 = &
c‹gi_pcmcü_c⁄fig
;

349 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

350 
	}
}

352 
__öô
 
	$fixup_c‹gi
(
machöe_desc
 *
desc
,

353 
èg
 *
ègs
, **
cmdlöe
, 
memöfo
 *
mi
)

355 
	`sh¨p¶_ßve_∑øm
();

356 
mi
->
ƒ_b™ks
=1;

357 
mi
->
b™k
[0].
°¨t
 = 0xa0000000;

358 
mi
->
b™k
[0].
node
 = 0;

359 i‡(
	`machöe_is_c‹gi
())

360 
mi
->
b™k
[0].
size
 = (32*1024*1024);

362 
mi
->
b™k
[0].
size
 = (64*1024*1024);

363 
	}
}

365 #ifde‡
CONFIG_MACH_CORGI


366 
MACHINE_START
(
CORGI
, "SHARP Corgi")

367 .
	gphys_io
 = 0x40000000,

368 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

369 .
	gfixup
 = 
fixup_c‹gi
,

370 .
	gm≠_io
 = 
pxa_m≠_io
,

371 .
	göô_úq
 = 
pxa_öô_úq
,

372 .
	göô_machöe
 = 
c‹gi_öô
,

373 .
	gtimî
 = &
pxa_timî
,

374 
	gMACHINE_END


377 #ifde‡
CONFIG_MACH_SHEPHERD


378 
MACHINE_START
(
SHEPHERD
, "SHARP Shepherd")

379 .
	gphys_io
 = 0x40000000,

380 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

381 .
	gfixup
 = 
fixup_c‹gi
,

382 .
	gm≠_io
 = 
pxa_m≠_io
,

383 .
	göô_úq
 = 
pxa_öô_úq
,

384 .
	göô_machöe
 = 
c‹gi_öô
,

385 .
	gtimî
 = &
pxa_timî
,

386 
	gMACHINE_END


389 #ifde‡
CONFIG_MACH_HUSKY


390 
MACHINE_START
(
HUSKY
, "SHARP Husky")

391 .
	gphys_io
 = 0x40000000,

392 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

393 .
	gfixup
 = 
fixup_c‹gi
,

394 .
	gm≠_io
 = 
pxa_m≠_io
,

395 .
	göô_úq
 = 
pxa_öô_úq
,

396 .
	göô_machöe
 = 
c‹gi_öô
,

397 .
	gtimî
 = &
pxa_timî
,

398 
	gMACHINE_END


	@arch/arm/mach-pxa/corgi_lcd.c

18 
	~<löux/dñay.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/∂©f‹m_devi˚.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/°rög.h
>

23 
	~<asm/¨ch/akôa.h
>

24 
	~<asm/¨ch/c‹gi.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/¨ch/pxa-ªgs.h
>

27 
	~<asm/¨ch/sh¨p¶.h
>

28 
	~<asm/¨ch/•ôz.h
>

29 
	~<asm/h¨dw¨e/sco›.h
>

30 
	~<asm/mach/sh¨p¶_∑øm.h
>

31 
	~"gíîic.h
"

34 
	#RESCTL_ADRS
 0x00

	)

35 
	#PHACTRL_ADRS
 0x01

	)

36 
	#DUTYCTRL_ADRS
 0x02

	)

37 
	#POWERREG0_ADRS
 0x03

	)

38 
	#POWERREG1_ADRS
 0x04

	)

39 
	#GPOR3_ADRS
 0x05

	)

40 
	#PICTRL_ADRS
 0x06

	)

41 
	#POLCTRL_ADRS
 0x07

	)

44 
	#RESCTL_QVGA
 0x01

	)

45 
	#RESCTL_VGA
 0x00

	)

47 
	#POWER1_VW_ON
 0x01

	)

48 
	#POWER1_GVSS_ON
 0x02

	)

49 
	#POWER1_VDD_ON
 0x04

	)

51 
	#POWER1_VW_OFF
 0x00

	)

52 
	#POWER1_GVSS_OFF
 0x00

	)

53 
	#POWER1_VDD_OFF
 0x00

	)

55 
	#POWER0_COM_DCLK
 0x01

	)

56 
	#POWER0_COM_DOUT
 0x02

	)

57 
	#POWER0_DAC_ON
 0x04

	)

58 
	#POWER0_COM_ON
 0x08

	)

59 
	#POWER0_VCC5_ON
 0x10

	)

61 
	#POWER0_DAC_OFF
 0x00

	)

62 
	#POWER0_COM_OFF
 0x00

	)

63 
	#POWER0_VCC5_OFF
 0x00

	)

65 
	#PICTRL_INIT_STATE
 0x01

	)

66 
	#PICTRL_INIOFF
 0x02

	)

67 
	#PICTRL_POWER_DOWN
 0x04

	)

68 
	#PICTRL_COM_SIGNAL_OFF
 0x08

	)

69 
	#PICTRL_DAC_SIGNAL_OFF
 0x10

	)

71 
	#POLCTRL_SYNC_POL_FALL
 0x01

	)

72 
	#POLCTRL_EN_POL_FALL
 0x02

	)

73 
	#POLCTRL_DATA_POL_FALL
 0x04

	)

74 
	#POLCTRL_SYNC_ACT_H
 0x08

	)

75 
	#POLCTRL_EN_ACT_L
 0x10

	)

77 
	#POLCTRL_SYNC_POL_RISE
 0x00

	)

78 
	#POLCTRL_EN_POL_RISE
 0x00

	)

79 
	#POLCTRL_DATA_POL_RISE
 0x00

	)

80 
	#POLCTRL_SYNC_ACT_L
 0x00

	)

81 
	#POLCTRL_EN_ACT_H
 0x00

	)

83 
	#PHACTRL_PHASE_MANUAL
 0x01

	)

84 
	#DEFAULT_PHAD_QVGA
 (9)

	)

85 
	#DEFAULT_COMADJ
 (125)

	)

91 
	$lcdtg_s•_i2c_£nd
(
u8
 
d©a
)

93 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
d©a
);

94 
	`udñay
(10);

95 
	}
}

97 
	$lcdtg_i2c_£nd_bô
(
u8
 
d©a
)

99 
	`lcdtg_s•_i2c_£nd
(
d©a
);

100 
	`lcdtg_s•_i2c_£nd
(
d©a
 | 
POWER0_COM_DCLK
);

101 
	`lcdtg_s•_i2c_£nd
(
d©a
);

102 
	}
}

104 
	$lcdtg_i2c_£nd_°¨t
(
u8
 
ba£
)

106 
	`lcdtg_s•_i2c_£nd
(
ba£
 | 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
);

107 
	`lcdtg_s•_i2c_£nd
(
ba£
 | 
POWER0_COM_DCLK
);

108 
	`lcdtg_s•_i2c_£nd
(
ba£
);

109 
	}
}

111 
	$lcdtg_i2c_£nd_°›
(
u8
 
ba£
)

113 
	`lcdtg_s•_i2c_£nd
(
ba£
);

114 
	`lcdtg_s•_i2c_£nd
(
ba£
 | 
POWER0_COM_DCLK
);

115 
	`lcdtg_s•_i2c_£nd
(
ba£
 | 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
);

116 
	}
}

118 
	$lcdtg_i2c_£nd_byã
(
u8
 
ba£
, u8 
d©a
)

120 
i
;

121 
i
 = 0; i < 8; i++) {

122 i‡(
d©a
 & 0x80)

123 
	`lcdtg_i2c_£nd_bô
(
ba£
 | 
POWER0_COM_DOUT
);

125 
	`lcdtg_i2c_£nd_bô
(
ba£
);

126 
d©a
 <<= 1;

128 
	}
}

130 
	$lcdtg_i2c_waô_ack
(
u8
 
ba£
)

132 
	`lcdtg_i2c_£nd_bô
(
ba£
);

133 
	}
}

135 
	$lcdtg_£t_comm⁄_vﬁège
(
u8
 
ba£_d©a
, u8 
d©a
)

138 
	`lcdtg_i2c_£nd_°¨t
(
ba£_d©a
);

139 
	`lcdtg_i2c_£nd_byã
(
ba£_d©a
, 0x9c);

140 
	`lcdtg_i2c_waô_ack
(
ba£_d©a
);

141 
	`lcdtg_i2c_£nd_byã
(
ba£_d©a
, 0x00);

142 
	`lcdtg_i2c_waô_ack
(
ba£_d©a
);

143 
	`lcdtg_i2c_£nd_byã
(
ba£_d©a
, 
d©a
);

144 
	`lcdtg_i2c_waô_ack
(
ba£_d©a
);

145 
	`lcdtg_i2c_£nd_°›
(
ba£_d©a
);

146 
	}
}

149 
	$lcdtg_£t_phadadj
(
mode
)

151 
adj
;

152 
mode
) {

156 
adj
 = 
sh¨p¶_∑øm
.
phadadj
;

157 i‡(
adj
 < 0) {

158 
adj
 = 
PHACTRL_PHASE_MANUAL
;

160 
adj
 = (◊dj & 0x0fË<< 1Ë| 
PHACTRL_PHASE_MANUAL
;

167 
adj
 = (
DEFAULT_PHAD_QVGA
 << 1Ë| 
PHACTRL_PHASE_MANUAL
;

171 
	`c‹gi_s•_lcdtg_£nd
(
PHACTRL_ADRS
, 
adj
);

172 
	}
}

174 
	glcd_öôed
;

176 
	$lcdtg_hw_öô
(
mode
)

178 i‡(!
lcd_öôed
) {

179 
comadj
;

182 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 
PICTRL_POWER_DOWN
 | 
PICTRL_INIOFF
 | 
PICTRL_INIT_STATE


183 | 
PICTRL_COM_SIGNAL_OFF
 | 
PICTRL_DAC_SIGNAL_OFF
);

185 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
 | 
POWER0_DAC_OFF


186 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_OFF
);

188 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_OFF
 | 
POWER1_VDD_OFF
);

191 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_OFF
 | 
POWER1_VDD_ON
);

192 
	`mdñay
(3);

195 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
 | 
POWER0_DAC_ON


196 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_OFF
);

200 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 
PICTRL_INIT_STATE
 | 
PICTRL_COM_SIGNAL_OFF
);

203 
comadj
 = 
sh¨p¶_∑øm
.comadj;

204 i‡(
comadj
 < 0)

205 
comadj
 = 
DEFAULT_COMADJ
;

206 
	`lcdtg_£t_comm⁄_vﬁège
((
POWER0_DAC_ON
 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_OFF
), 
comadj
);

209 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
 | 
POWER0_DAC_ON
 |

210 
POWER0_COM_OFF
 | 
POWER0_VCC5_ON
);

213 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_ON
 | 
POWER1_VDD_ON
);

214 
	`mdñay
(2);

217 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 
PICTRL_INIT_STATE
);

220 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_COM_DCLK
 | 
POWER0_COM_DOUT
 | 
POWER0_DAC_ON


221 | 
POWER0_COM_ON
 | 
POWER0_VCC5_ON
);

224 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_ON
 | 
POWER1_GVSS_ON
 | 
POWER1_VDD_ON
);

227 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 0);

230 
	`lcdtg_£t_phadadj
(
mode
);

233 
	`c‹gi_s•_lcdtg_£nd
(
POLCTRL_ADRS
, 
POLCTRL_SYNC_POL_RISE
 | 
POLCTRL_EN_POL_RISE


234 | 
POLCTRL_DATA_POL_RISE
 | 
POLCTRL_SYNC_ACT_L
 | 
POLCTRL_EN_ACT_H
);

235 
	`udñay
(1000);

237 
lcd_öôed
=1;

239 
	`lcdtg_£t_phadadj
(
mode
);

242 
mode
) {

246 
	`c‹gi_s•_lcdtg_£nd
(
RESCTL_ADRS
, 
RESCTL_VGA
);

252 
	`c‹gi_s•_lcdtg_£nd
(
RESCTL_ADRS
, 
RESCTL_QVGA
);

255 
	}
}

257 
	$lcdtg_su•íd
()

260 
	`mdñay
(34);

263 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_ON
 | 
POWER1_VDD_ON
);

266 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 
PICTRL_COM_SIGNAL_OFF
);

267 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_DAC_ON
 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_ON
);

270 
	`lcdtg_£t_comm⁄_vﬁège
(
POWER0_DAC_ON
 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_ON
, 0);

273 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_OFF
 | 
POWER1_VDD_ON
);

276 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_DAC_ON
 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_OFF
);

279 
	`c‹gi_s•_lcdtg_£nd
(
PICTRL_ADRS
, 
PICTRL_INIOFF
 | 
PICTRL_DAC_SIGNAL_OFF
 |

280 
PICTRL_POWER_DOWN
 | 
PICTRL_COM_SIGNAL_OFF
);

283 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG0_ADRS
, 
POWER0_DAC_OFF
 | 
POWER0_COM_OFF
 | 
POWER0_VCC5_OFF
);

286 
	`c‹gi_s•_lcdtg_£nd
(
POWERREG1_ADRS
, 
POWER1_VW_OFF
 | 
POWER1_GVSS_OFF
 | 
POWER1_VDD_OFF
);

288 
lcd_öôed
 = 0;

289 
	}
}

295 #ifde‡
CONFIG_PXA_SHARP_C7xx


297 
	~<video/w100fb.h
>

299 
	$w100_lcdtg_su•íd
(
w100fb_∑r
 *
∑r
)

301 
	`lcdtg_su•íd
();

302 
	}
}

304 
	$w100_lcdtg_öô
(
w100fb_∑r
 *
∑r
)

306 
	`lcdtg_hw_öô
(
∑r
->
xªs
);

307 
	}
}

310 
w100_tg_öfo
 
	gc‹gi_lcdtg_öfo
 = {

311 .
ch™ge
 = 
w100_lcdtg_öô
,

312 .
	gsu•íd
 = 
w100_lcdtg_su•íd
,

313 .
	gªsume
 = 
w100_lcdtg_öô
,

316 
w100_mem_öfo
 
	gc‹gi_fb_mem
 = {

317 .
ext_˙é
 = 0x00040003,

318 .
	gsdøm_mode_ªg
 = 0x00650021,

319 .
	gext_timög_˙é
 = 0x10002a4a,

320 .
	gio_˙é
 = 0x7ff87012,

321 .
	gsize
 = 0x1fffff,

324 
w100_gí_ªgs
 
	gc‹gi_fb_ªgs
 = {

325 .
lcd_f‹m©
 = 0x00000003,

326 .
	glcdd_˙é1
 = 0x01CC0000,

327 .
	glcdd_˙é2
 = 0x0003FFFF,

328 .
	ggílcd_˙é1
 = 0x00FFFF0D,

329 .
	ggílcd_˙é2
 = 0x003F3003,

330 .
	ggílcd_˙é3
 = 0x000102aa,

333 
w100_gpio_ªgs
 
	gc‹gi_fb_gpio
 = {

334 .
öô_d©a1
 = 0x000000bf,

335 .
	göô_d©a2
 = 0x00000000,

336 .
	ggpio_dú1
 = 0x00000000,

337 .
	ggpio_€1
 = 0x03c0feff,

338 .
	ggpio_dú2
 = 0x00000000,

339 .
	ggpio_€2
 = 0x00000000,

342 
w100_mode
 
	gc‹gi_fb_modes
[] = {

344 .
xªs
 = 480,

345 .
	gyªs
 = 640,

346 .
	gÀ·_m¨gö
 = 0x56,

347 .
	gright_m¨gö
 = 0x55,

348 .
	guµî_m¨gö
 = 0x03,

349 .
	glowî_m¨gö
 = 0x00,

350 .
	g¸tc_ss
 = 0x82360056,

351 .
	g¸tc_ls
 = 0xA0280000,

352 .
	g¸tc_gs
 = 0x80280028,

353 .
	g¸tc_vpos_gs
 = 0x02830002,

354 .
	g¸tc_ªv
 = 0x00400008,

355 .
	g¸tc_d˛k
 = 0xA0000000,

356 .
	g¸tc_g˛k
 = 0x8015010F,

357 .
	g¸tc_g€
 = 0x80100110,

358 .
	g¸tc_ps1_a˘ive
 = 0x41060010,

359 .
	g∂l_‰eq
 = 75,

360 .
	gÁ°_∂l_‰eq
 = 100,

361 .
	gsys˛k_§c
 = 
CLK_SRC_PLL
,

362 .
	gsys˛k_dividî
 = 0,

363 .
	gpix˛k_§c
 = 
CLK_SRC_PLL
,

364 .
	gpix˛k_dividî
 = 2,

365 .
	gpix˛k_dividî_rŸ©ed
 = 6,

367 .
	gxªs
 = 240,

368 .
	gyªs
 = 320,

369 .
	gÀ·_m¨gö
 = 0x27,

370 .
	gright_m¨gö
 = 0x2e,

371 .
	guµî_m¨gö
 = 0x01,

372 .
	glowî_m¨gö
 = 0x00,

373 .
	g¸tc_ss
 = 0x81170027,

374 .
	g¸tc_ls
 = 0xA0140000,

375 .
	g¸tc_gs
 = 0xC0140014,

376 .
	g¸tc_vpos_gs
 = 0x00010141,

377 .
	g¸tc_ªv
 = 0x00400008,

378 .
	g¸tc_d˛k
 = 0xA0000000,

379 .
	g¸tc_g˛k
 = 0x8015010F,

380 .
	g¸tc_g€
 = 0x80100110,

381 .
	g¸tc_ps1_a˘ive
 = 0x41060010,

382 .
	g∂l_‰eq
 = 0,

383 .
	gÁ°_∂l_‰eq
 = 0,

384 .
	gsys˛k_§c
 = 
CLK_SRC_XTAL
,

385 .
	gsys˛k_dividî
 = 0,

386 .
	gpix˛k_§c
 = 
CLK_SRC_XTAL
,

387 .
	gpix˛k_dividî
 = 1,

388 .
	gpix˛k_dividî_rŸ©ed
 = 1,

393 
w100fb_mach_öfo
 
	gc‹gi_fb_öfo
 = {

394 .
tg
 = &
c‹gi_lcdtg_öfo
,

395 .
	göô_mode
 = 
INIT_MODE_ROTATED
,

396 .
	gmem
 = &
c‹gi_fb_mem
,

397 .
	gªgs
 = &
c‹gi_fb_ªgs
,

398 .
	gmodñi°
 = &
c‹gi_fb_modes
[0],

399 .
	gnum_modes
 = 2,

400 .
	ggpio
 = &
c‹gi_fb_gpio
,

401 .
	gxèl_‰eq
 = 12500000,

402 .
	gxèl_dbl
 = 0,

405 
ªsour˚
 
	gc‹gi_fb_ªsour˚s
[] = {

407 .
°¨t
 = 0x08000000,

408 .
	gíd
 = 0x08ffffff,

409 .
	gÊags
 = 
IORESOURCE_MEM
,

413 
∂©f‹m_devi˚
 
	gc‹gifb_devi˚
 = {

414 .
«me
 = "w100fb",

415 .
	gid
 = -1,

416 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
c‹gi_fb_ªsour˚s
),

417 .
	gªsour˚
 = 
c‹gi_fb_ªsour˚s
,

418 .
	gdev
 = {

419 .
∂©f‹m_d©a
 = &
c‹gi_fb_öfo
,

420 .
	g∑ª¡
 = &
c‹gis•_devi˚
.
dev
,

430 #ifde‡
CONFIG_PXA_SHARP_Cxx00


432 
	~<asm/¨ch/pxafb.h
>

434 
	$•ôz_lcd_powî
(
⁄
, 
fb_v¨_s¸ìnöfo
 *
v¨
)

436 i‡(
⁄
)

437 
	`lcdtg_hw_öô
(
v¨
->
xªs
);

439 
	`lcdtg_su•íd
();

440 
	}
}

448 (*
gë_hsync_time
)(
devi˚
 *
dev
);

450 
ölöe
 
	$sh¨p¶_waô_sync
(
gpio
)

452 (
	`GPLR
(
gpio
Ë& 
	`GPIO_bô
(gpio)) == 0);

453 (
	`GPLR
(
gpio
Ë& 
	`GPIO_bô
(gpio)) != 0);

454 
	}
}

456 #ifde‡
CONFIG_PXA_SHARP_C7xx


457 
	$c‹gi_gë_hsync_Àn
()

459 i‡(!
gë_hsync_time
)

460 
gë_hsync_time
 = 
	`symbﬁ_gë
(
w100fb_gë_hsyn˛í
);

461 i‡(!
gë_hsync_time
)

464  
	`gë_hsync_time
(&
c‹gifb_devi˚
.
dev
);

465 
	}
}

467 
	$c‹gi_put_hsync
()

469 i‡(
gë_hsync_time
)

470 
	`symbﬁ_put
(
w100fb_gë_hsyn˛í
);

471 
gë_hsync_time
 = 
NULL
;

472 
	}
}

474 
	$c‹gi_waô_hsync
()

476 
	`sh¨p¶_waô_sync
(
CORGI_GPIO_HSYNC
);

477 
	}
}

480 #ifde‡
CONFIG_PXA_SHARP_Cxx00


481 
devi˚
 *
	g•ôz_pxafb_dev
;

483 
	$is_pxafb_devi˚
(
devi˚
 * 
dev
, * 
d©a
)

485 
∂©f‹m_devi˚
 *
pdev
 = 
	`c⁄èöî_of
(
dev
, platform_device, dev);

487  (
	`°∫cmp
(
pdev
->
«me
, "pxa2xx-fb", 9) == 0);

488 
	}
}

490 
	$•ôz_gë_hsync_Àn
()

492 #ifde‡
CONFIG_FB_PXA


493 i‡(!
•ôz_pxafb_dev
) {

494 
•ôz_pxafb_dev
 = 
	`bus_föd_devi˚
(&
∂©f‹m_bus_ty≥
, 
NULL
, NULL, 
is_pxafb_devi˚
);

495 i‡(!
•ôz_pxafb_dev
)

498 i‡(!
gë_hsync_time
)

499 
gë_hsync_time
 = 
	`symbﬁ_gë
(
pxafb_gë_hsync_time
);

500 i‡(!
gë_hsync_time
)

504  
	`pxafb_gë_hsync_time
(
•ôz_pxafb_dev
);

505 
	}
}

507 
	$•ôz_put_hsync
()

509 
	`put_devi˚
(
•ôz_pxafb_dev
);

510 i‡(
gë_hsync_time
)

511 
	`symbﬁ_put
(
pxafb_gë_hsync_time
);

512 
•ôz_pxafb_dev
 = 
NULL
;

513 
gë_hsync_time
 = 
NULL
;

514 
	}
}

516 
	$•ôz_waô_hsync
()

518 
	`sh¨p¶_waô_sync
(
SPITZ_GPIO_HSYNC
);

519 
	}
}

525 #ifde‡
CONFIG_PXA_SHARP_C7xx


526 
	$c‹gi_bl_£t_öãnsôy
(
öãnsôy
)

528 i‡(
öãnsôy
 > 0x10)

529 
öãnsôy
 += 0x10;

532 
	`c‹gi_s•_blduty_£t
(
öãnsôy
 & 0x1f);

535 i‡(
öãnsôy
 & 0x0020)

536 
	`£t_sco›_gpio
(&
c‹gisco›_devi˚
.
dev
, 
CORGI_SCP_BACKLIGHT_CONT
);

538 
	`ª£t_sco›_gpio
(&
c‹gisco›_devi˚
.
dev
, 
CORGI_SCP_BACKLIGHT_CONT
);

539 
	}
}

543 #i‡
deföed
(
CONFIG_MACH_SPITZ
Ë|| deföed(
CONFIG_MACH_BORZOI
)

544 
	$•ôz_bl_£t_öãnsôy
(
öãnsôy
)

546 i‡(
öãnsôy
 > 0x10)

547 
öãnsôy
 += 0x10;

550 
	`c‹gi_s•_blduty_£t
(
öãnsôy
 & 0x1f);

553 i‡(
öãnsôy
 & 0x0020)

554 
	`ª£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_BACKLIGHT_CONT
);

556 
	`£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_BACKLIGHT_CONT
);

558 i‡(
öãnsôy
)

559 
	`£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_BACKLIGHT_ON
);

561 
	`ª£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_BACKLIGHT_ON
);

562 
	}
}

565 #ifde‡
CONFIG_MACH_AKITA


566 
	$akôa_bl_£t_öãnsôy
(
öãnsôy
)

568 i‡(
öãnsôy
 > 0x10)

569 
öãnsôy
 += 0x10;

572 
	`c‹gi_s•_blduty_£t
(
öãnsôy
 & 0x1f);

575 i‡(
öãnsôy
 & 0x0020)

576 
	`akôa_ª£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_BACKLIGHT_CONT
);

578 
	`akôa_£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_BACKLIGHT_CONT
);

580 i‡(
öãnsôy
)

581 
	`akôa_£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_BACKLIGHT_ON
);

583 
	`akôa_ª£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_BACKLIGHT_ON
);

584 
	}
}

	@arch/arm/mach-pxa/corgi_pm.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/°©.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/∂©f‹m_devi˚.h
>

19 
	~<löux/≠m-emuœti⁄.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/h¨dw¨e/sco›.h
>

26 
	~<asm/¨ch/sh¨p¶.h
>

27 
	~<asm/¨ch/c‹gi.h
>

28 
	~<asm/¨ch/pxa-ªgs.h
>

29 
	~"sh¨p¶.h
"

31 
	#SHARPSL_CHARGE_ON_VOLT
 0x99

	)

32 
	#SHARPSL_CHARGE_ON_TEMP
 0xe0

	)

33 
	#SHARPSL_CHARGE_ON_ACIN_HIGH
 0x9b

	)

34 
	#SHARPSL_CHARGE_ON_ACIN_LOW
 0x34

	)

35 
	#SHARPSL_FATAL_ACIN_VOLT
 182

	)

36 
	#SHARPSL_FATAL_NOACIN_VOLT
 170

	)

38 
	$c‹gi_ch¨gî_öô
()

40 
	`pxa_gpio_mode
(
CORGI_GPIO_ADC_TEMP_ON
 | 
GPIO_OUT
);

41 
	`pxa_gpio_mode
(
CORGI_GPIO_CHRG_ON
 | 
GPIO_OUT
);

42 
	`pxa_gpio_mode
(
CORGI_GPIO_CHRG_UKN
 | 
GPIO_OUT
);

43 
	`pxa_gpio_mode
(
CORGI_GPIO_KEY_INT
 | 
GPIO_IN
);

44 
	`sh¨p¶_pm_pxa_öô
();

45 
	}
}

47 
	$c‹gi_mósuª_ãmp
(
⁄
)

49 i‡(
⁄
)

50 
	`GPSR
(
CORGI_GPIO_ADC_TEMP_ON
Ë
	`GPIO_bô
(CORGI_GPIO_ADC_TEMP_ON);

52 
	`GPCR
(
CORGI_GPIO_ADC_TEMP_ON
Ë
	`GPIO_bô
(CORGI_GPIO_ADC_TEMP_ON);

53 
	}
}

55 
	$c‹gi_ch¨ge
(
⁄
)

57 i‡(
⁄
) {

58 i‡(
	`machöe_is_c‹gi
(Ë&& (
sh¨p¶_pm
.
Êags
 & 
SHARPSL_SUSPENDED
)) {

59 
	`GPCR
(
CORGI_GPIO_CHRG_ON
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_ON);

60 
	`GPSR
(
CORGI_GPIO_CHRG_UKN
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_UKN);

62 
	`GPSR
(
CORGI_GPIO_CHRG_ON
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_ON);

63 
	`GPCR
(
CORGI_GPIO_CHRG_UKN
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_UKN);

66 
	`GPCR
(
CORGI_GPIO_CHRG_ON
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_ON);

67 
	`GPCR
(
CORGI_GPIO_CHRG_UKN
Ë
	`GPIO_bô
(CORGI_GPIO_CHRG_UKN);

69 
	}
}

71 
	$c‹gi_disch¨ge
(
⁄
)

73 i‡(
⁄
)

74 
	`GPSR
(
CORGI_GPIO_DISCHARGE_ON
Ë
	`GPIO_bô
(CORGI_GPIO_DISCHARGE_ON);

76 
	`GPCR
(
CORGI_GPIO_DISCHARGE_ON
Ë
	`GPIO_bô
(CORGI_GPIO_DISCHARGE_ON);

77 
	}
}

79 
	$c‹gi_¥esu•íd
()

81 
i
;

82 
wakeup_mask
;

85 i‡(
	`READ_GPIO_BIT
(
CORGI_GPIO_CHRG_ON
))

86 
PGSR1
 |
	`GPIO_bô
(
CORGI_GPIO_CHRG_ON
);

88 
PGSR1
 &~
	`GPIO_bô
(
CORGI_GPIO_CHRG_ON
);

90 i‡(
	`READ_GPIO_BIT
(
CORGI_GPIO_LED_ORANGE
))

91 
PGSR0
 |
	`GPIO_bô
(
CORGI_GPIO_LED_ORANGE
);

93 
PGSR0
 &~
	`GPIO_bô
(
CORGI_GPIO_LED_ORANGE
);

95 i‡(
	`READ_GPIO_BIT
(
CORGI_GPIO_CHRG_UKN
))

96 
PGSR1
 |
	`GPIO_bô
(
CORGI_GPIO_CHRG_UKN
);

98 
PGSR1
 &~
	`GPIO_bô
(
CORGI_GPIO_CHRG_UKN
);

101 
PGSR2
 = (PGSR2 & ~
CORGI_GPIO_ALL_STROBE_BIT
Ë| 
	`CORGI_GPIO_STROBE_BIT
(0);

103 
wakeup_mask
 = 
	`GPIO_bô
(
CORGI_GPIO_KEY_INT
Ë| GPIO_bô(
CORGI_GPIO_WAKEUP
Ë| GPIO_bô(
CORGI_GPIO_AC_IN
Ë| GPIO_bô(
CORGI_GPIO_CHRG_FULL
);

105 i‡(!
	`machöe_is_c‹gi
())

106 
wakeup_mask
 |
	`GPIO_bô
(
CORGI_GPIO_MAIN_BAT_LOW
);

108 
PWER
 = 
wakeup_mask
 | 
PWER_RTC
;

109 
PRER
 = 
wakeup_mask
;

110 
PFER
 = 
wakeup_mask
;

112 
i
 = 0; i <=15; i++) {

113 i‡(
PRER
 & 
PFER
 & 
	`GPIO_bô
(
i
)) {

114 i‡(
GPLR0
 & 
	`GPIO_bô
(
i
) )

115 
PRER
 &~
	`GPIO_bô
(
i
);

117 
PFER
 &~
	`GPIO_bô
(
i
);

120 
	}
}

122 
	$c‹gi_po°su•íd
()

124 
	}
}

130 
	$c‹gi_should_wakeup
(
ªsume_⁄_Æ¨m
)

132 
is_ªsume
 = 0;

134 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "GPLR0 = %x,%x\n", 
GPLR0
, 
PEDR
);

136 i‡((
PEDR
 & 
	`GPIO_bô
(
CORGI_GPIO_AC_IN
))) {

137 i‡(
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
)) {

139 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "ac insert\n");

140 
sh¨p¶_pm
.
Êags
 |
SHARPSL_DO_OFFLINE_CHRG
;

143 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "acÑemove\n");

144 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_OFF
);

145 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

146 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_OFF
;

150 i‡((
PEDR
 & 
	`GPIO_bô
(
CORGI_GPIO_CHRG_FULL
)))

151 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "Charge full interrupt\n");

153 i‡(
PEDR
 & 
	`GPIO_bô
(
CORGI_GPIO_KEY_INT
))

154 
is_ªsume
 |
	`GPIO_bô
(
CORGI_GPIO_KEY_INT
);

156 i‡(
PEDR
 & 
	`GPIO_bô
(
CORGI_GPIO_WAKEUP
))

157 
is_ªsume
 |
	`GPIO_bô
(
CORGI_GPIO_WAKEUP
);

159 i‡(
ªsume_⁄_Æ¨m
 && (
PEDR
 & 
PWER_RTC
))

160 
is_ªsume
 |
PWER_RTC
;

162 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "is_ªsume: %x\n",
is_ªsume
);

163  
is_ªsume
;

164 
	}
}

166 
	$c‹gi_ch¨gî_wakeup
()

168  ~
GPLR0
 & ( 
	`GPIO_bô
(
CORGI_GPIO_AC_IN
Ë| GPIO_bô(
CORGI_GPIO_KEY_INT
Ë| GPIO_bô(
CORGI_GPIO_WAKEUP
) );

169 
	}
}

171 
	$c‹gùm_ªad_devd©a
(
ty≥
)

173 
ty≥
) {

174 
SHARPSL_STATUS_ACIN
:

175  ((
	`GPLR
(
CORGI_GPIO_AC_IN
Ë& 
	`GPIO_bô
(CORGI_GPIO_AC_IN)) != 0);

176 
SHARPSL_STATUS_LOCK
:

177  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
);

178 
SHARPSL_STATUS_CHRGFULL
:

179  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
);

180 
SHARPSL_STATUS_FATAL
:

181  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
);

182 
SHARPSL_ACIN_VOLT
:

183  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_ACIN_VOLT
);

184 
SHARPSL_BATT_TEMP
:

185  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_BATT_TEMP
);

186 
SHARPSL_BATT_VOLT
:

188  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_BATT_VOLT
);

190 
	}
}

192 
sh¨p¶_ch¨gî_machöfo
 
	gc‹gi_pm_machöfo
 = {

193 .
öô
 = 
c‹gi_ch¨gî_öô
,

194 .
	gexô
 = 
sh¨p¶_pm_pxa_ªmove
,

195 .
	ggpio_b©lock
 = 
CORGI_GPIO_BAT_COVER
,

196 .
	ggpio_acö
 = 
CORGI_GPIO_AC_IN
,

197 .
	ggpio_b©fuŒ
 = 
CORGI_GPIO_CHRG_FULL
,

198 .
	gdisch¨ge
 = 
c‹gi_disch¨ge
,

199 .
	gch¨ge
 = 
c‹gi_ch¨ge
,

200 .
	gmósuª_ãmp
 = 
c‹gi_mósuª_ãmp
,

201 .
	g¥esu•íd
 = 
c‹gi_¥esu•íd
,

202 .
	gpo°su•íd
 = 
c‹gi_po°su•íd
,

203 .
	gªad_devd©a
 = 
c‹gùm_ªad_devd©a
,

204 .
	gch¨gî_wakeup
 = 
c‹gi_ch¨gî_wakeup
,

205 .
	gshould_wakeup
 = 
c‹gi_should_wakeup
,

206 .
	gbacklight_limô
 = 
c‹gibl_limô_öãnsôy
,

207 .
	gch¨ge_⁄_vﬁt
 = 
SHARPSL_CHARGE_ON_VOLT
,

208 .
	gch¨ge_⁄_ãmp
 = 
SHARPSL_CHARGE_ON_TEMP
,

209 .
	gch¨ge_acö_high
 = 
SHARPSL_CHARGE_ON_ACIN_HIGH
,

210 .
	gch¨ge_acö_low
 = 
SHARPSL_CHARGE_ON_ACIN_LOW
,

211 .
	gÁèl_acö_vﬁt
 = 
SHARPSL_FATAL_ACIN_VOLT
,

212 .
	gÁèl_nﬂcö_vﬁt

SHARPSL_FATAL_NOACIN_VOLT
,

213 .
	gb©_Àvñs
 = 40,

214 .
	gb©_Àvñs_nﬂc
 = 
•ôz_b©ãry_Àvñs_nﬂc
,

215 .
	gb©_Àvñs_acö
 = 
•ôz_b©ãry_Àvñs_acö
,

216 .
	g°©us_high_acö
 = 188,

217 .
	g°©us_low_acö
 = 178,

218 .
	g°©us_high_nﬂc
 = 185,

219 .
	g°©us_low_nﬂc
 = 175,

222 
∂©f‹m_devi˚
 *
	gc‹gùm_devi˚
;

224 
__devöô
 
	$c‹gùm_öô
()

226 
ªt
;

228 
c‹gùm_devi˚
 = 
	`∂©f‹m_devi˚_Æloc
("sharpsl-pm", -1);

229 i‡(!
c‹gùm_devi˚
)

230  -
ENOMEM
;

232 i‡(!
	`machöe_is_c‹gi
())

233 
c‹gi_pm_machöfo
.
b©fuŒ_úq
 = 1;

235 
c‹gùm_devi˚
->
dev
.
∂©f‹m_d©a
 = &
c‹gi_pm_machöfo
;

236 
ªt
 = 
	`∂©f‹m_devi˚_add
(
c‹gùm_devi˚
);

238 i‡(
ªt
)

239 
	`∂©f‹m_devi˚_put
(
c‹gùm_devi˚
);

241  
ªt
;

242 
	}
}

244 
	$c‹gùm_exô
()

246 
	`∂©f‹m_devi˚_uƒegi°î
(
c‹gùm_devi˚
);

247 
	}
}

249 
moduÀ_öô
(
c‹gùm_öô
);

250 
moduÀ_exô
(
c‹gùm_exô
);

	@arch/arm/mach-pxa/corgi_ssp.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/sched.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/dñay.h
>

18 
	~<löux/∂©f‹m_devi˚.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/mach-ty≥s.h
>

22 
	~<asm/¨ch/s•.h
>

23 
	~<asm/¨ch/pxa-ªgs.h
>

24 
	~"sh¨p¶.h
"

26 
DEFINE_SPINLOCK
(
c‹gi_s•_lock
);

27 
s•_dev
 
	gc‹gi_s•_dev
;

28 
s•_°©e
 
	gc‹gi_s•_°©e
;

29 
c‹gis•_machöfo
 *
	gs•_machöfo
;

48 
	$c‹gi_s•_ads7846_putgë
(
ul⁄g
 
d©a
)

50 
Êag
;

51 
u32
 
ªt
 = 0;

53 
	`•ö_lock_úqßve
(&
c‹gi_s•_lock
, 
Êag
);

54 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

55 
	`GPCR
(
s•_machöfo
->
cs_ads7846
Ë
	`GPIO_bô
(ssp_machinfo->cs_ads7846);

57 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,
d©a
);

58 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, &
ªt
);

60 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

61 
	`GPSR
(
s•_machöfo
->
cs_ads7846
Ë
	`GPIO_bô
(ssp_machinfo->cs_ads7846);

62 
	`•ö_u∆ock_úqª°‹e
(&
c‹gi_s•_lock
, 
Êag
);

64  
ªt
;

65 
	}
}

71 
	$c‹gi_s•_ads7846_lock
()

73 
	`•ö_lock
(&
c‹gi_s•_lock
);

74 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

75 
	`GPCR
(
s•_machöfo
->
cs_ads7846
Ë
	`GPIO_bô
(ssp_machinfo->cs_ads7846);

76 
	}
}

78 
	$c‹gi_s•_ads7846_u∆ock
()

80 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

81 
	`GPSR
(
s•_machöfo
->
cs_ads7846
Ë
	`GPIO_bô
(ssp_machinfo->cs_ads7846);

82 
	`•ö_u∆ock
(&
c‹gi_s•_lock
);

83 
	}
}

85 
	$c‹gi_s•_ads7846_put
(
ul⁄g
 
d©a
)

87 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,
d©a
);

88 
	}
}

90 
	$c‹gi_s•_ads7846_gë
()

92 
u32
 
ªt
 = 0;

93 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, &
ªt
);

94  
ªt
;

95 
	}
}

97 
EXPORT_SYMBOL
(
c‹gi_s•_ads7846_putgë
);

98 
EXPORT_SYMBOL
(
c‹gi_s•_ads7846_lock
);

99 
EXPORT_SYMBOL
(
c‹gi_s•_ads7846_u∆ock
);

100 
EXPORT_SYMBOL
(
c‹gi_s•_ads7846_put
);

101 
EXPORT_SYMBOL
(
c‹gi_s•_ads7846_gë
);

107 
	$c‹gi_s•_dac_put
(
ul⁄g
 
d©a
)

109 
Êag
, 
ss¸1
 = 
SSCR1_SPH
;

110 
u32
 
tmp
;

112 
	`•ö_lock_úqßve
(&
c‹gi_s•_lock
, 
Êag
);

114 i‡(
	`machöe_is_•ôz
(Ë|| 
	`machöe_is_akôa
(Ë|| 
	`machöe_is_b‹zoi
())

115 
ss¸1
 = 0;

117 
	`s•_dißbÀ
(&
c‹gi_s•_dev
);

118 
	`s•_c⁄fig
(&
c‹gi_s•_dev
, (
SSCR0_MŸ‹ﬁa
 | (
SSCR0_DSS
 & 0x07 )), 
ss¸1
, 0, 
	`SSCR0_SîClkDiv
(
s•_machöfo
->
˛k_lcdc⁄
));

119 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

121 i‡(
s•_machöfo
->
cs_lcdc⁄
 >= 0)

122 
	`GPCR
(
s•_machöfo
->
cs_lcdc⁄
Ë
	`GPIO_bô
(ssp_machinfo->cs_lcdcon);

123 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,
d©a
);

125 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, &
tmp
);

126 i‡(
s•_machöfo
->
cs_lcdc⁄
 >= 0)

127 
	`GPSR
(
s•_machöfo
->
cs_lcdc⁄
Ë
	`GPIO_bô
(ssp_machinfo->cs_lcdcon);

129 
	`s•_dißbÀ
(&
c‹gi_s•_dev
);

130 
	`s•_c⁄fig
(&
c‹gi_s•_dev
, (
SSCR0_N©i⁄Æ
 | (
SSCR0_DSS
 & 0x0b )), 0, 0, 
	`SSCR0_SîClkDiv
(
s•_machöfo
->
˛k_ads7846
));

131 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

133 
	`•ö_u∆ock_úqª°‹e
(&
c‹gi_s•_lock
, 
Êag
);

136 
	}
}

138 
	$c‹gi_s•_lcdtg_£nd
(
u8
 
adrs
, u8 
d©a
)

140 
	`c‹gi_s•_dac_put
(((
adrs
 & 0x07Ë<< 5Ë| (
d©a
 & 0x1f));

141 
	}
}

143 
	$c‹gi_s•_blduty_£t
(
duty
)

145 
	`c‹gi_s•_lcdtg_£nd
(0x02,
duty
);

146 
	}
}

148 
EXPORT_SYMBOL
(
c‹gi_s•_lcdtg_£nd
);

149 
EXPORT_SYMBOL
(
c‹gi_s•_blduty_£t
);

154 
	$c‹gi_s•_max1111_gë
(
ul⁄g
 
d©a
)

156 
Êag
;

157 
vﬁège
 = 0, 
vﬁège1
 = 0, 
vﬁège2
 = 0;

159 
	`•ö_lock_úqßve
(&
c‹gi_s•_lock
, 
Êag
);

160 i‡(
s•_machöfo
->
cs_max1111
 >= 0)

161 
	`GPCR
(
s•_machöfo
->
cs_max1111
Ë
	`GPIO_bô
(ssp_machinfo->cs_max1111);

162 
	`s•_dißbÀ
(&
c‹gi_s•_dev
);

163 
	`s•_c⁄fig
(&
c‹gi_s•_dev
, (
SSCR0_MŸ‹ﬁa
 | (
SSCR0_DSS
 & 0x07 )), 0, 0, 
	`SSCR0_SîClkDiv
(
s•_machöfo
->
˛k_max1111
));

164 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

166 
	`udñay
(1);

169 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,
d©a
);

170 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, (
u32
*)&
vﬁège1
);

173 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,0);

174 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, (
u32
*)&
vﬁège1
);

177 
	`s•_wrôe_w‹d
(&
c‹gi_s•_dev
,0);

178 
	`s•_ªad_w‹d
(&
c‹gi_s•_dev
, (
u32
*)&
vﬁège2
);

180 
	`s•_dißbÀ
(&
c‹gi_s•_dev
);

181 
	`s•_c⁄fig
(&
c‹gi_s•_dev
, (
SSCR0_N©i⁄Æ
 | (
SSCR0_DSS
 & 0x0b )), 0, 0, 
	`SSCR0_SîClkDiv
(
s•_machöfo
->
˛k_ads7846
));

182 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

183 i‡(
s•_machöfo
->
cs_max1111
 >= 0)

184 
	`GPSR
(
s•_machöfo
->
cs_max1111
Ë
	`GPIO_bô
(ssp_machinfo->cs_max1111);

185 
	`•ö_u∆ock_úqª°‹e
(&
c‹gi_s•_lock
, 
Êag
);

187 i‡(
vﬁège1
 & 0xc0 || 
vﬁège2
 & 0x3f)

188 
vﬁège
 = -1;

190 
vﬁège
 = ((
vﬁège1
 << 2Ë& 0xfcË| ((
vﬁège2
 >> 6) & 0x03);

192  
vﬁège
;

193 
	}
}

195 
EXPORT_SYMBOL
(
c‹gi_s•_max1111_gë
);

201 
__öô
 
	$c‹gi_s•_£t_machöfo
(
c‹gis•_machöfo
 *
machöfo
)

203 
s•_machöfo
 = 
machöfo
;

204 
	}
}

206 
__öô
 
	$c‹gi_s•_¥obe
(
∂©f‹m_devi˚
 *
dev
)

208 
ªt
;

211 i‡(
s•_machöfo
->
cs_lcdc⁄
 >= 0)

212 
	`pxa_gpio_mode
(
s•_machöfo
->
cs_lcdc⁄
 | 
GPIO_OUT
 | 
GPIO_DFLT_HIGH
);

213 i‡(
s•_machöfo
->
cs_max1111
 >= 0)

214 
	`pxa_gpio_mode
(
s•_machöfo
->
cs_max1111
 | 
GPIO_OUT
 | 
GPIO_DFLT_HIGH
);

215 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

216 
	`pxa_gpio_mode
(
s•_machöfo
->
cs_ads7846
 | 
GPIO_OUT
 | 
GPIO_DFLT_HIGH
);

218 
ªt
 = 
	`s•_öô
(&
c‹gi_s•_dev
, 
s•_machöfo
->
p‹t
, 0);

220 i‡(
ªt
)

221 
	`¥ötk
(
KERN_ERR
 "UnableÅoÑegister SSP handler!\n");

223 
	`s•_dißbÀ
(&
c‹gi_s•_dev
);

224 
	`s•_c⁄fig
(&
c‹gi_s•_dev
, (
SSCR0_N©i⁄Æ
 | (
SSCR0_DSS
 & 0x0b )), 0, 0, 
	`SSCR0_SîClkDiv
(
s•_machöfo
->
˛k_ads7846
));

225 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

228  
ªt
;

229 
	}
}

231 
	$c‹gi_s•_ªmove
(
∂©f‹m_devi˚
 *
dev
)

233 
	`s•_exô
(&
c‹gi_s•_dev
);

235 
	}
}

237 
	$c‹gi_s•_su•íd
(
∂©f‹m_devi˚
 *
dev
, 
pm_mesßge_t
 
°©e
)

239 
	`s•_Êush
(&
c‹gi_s•_dev
);

240 
	`s•_ßve_°©e
(&
c‹gi_s•_dev
,&
c‹gi_s•_°©e
);

243 
	}
}

245 
	$c‹gi_s•_ªsume
(
∂©f‹m_devi˚
 *
dev
)

247 i‡(
s•_machöfo
->
cs_lcdc⁄
 >= 0)

248 
	`GPSR
(
s•_machöfo
->
cs_lcdc⁄
Ë
	`GPIO_bô
(ssp_machinfo->cs_lcdcon);

249 i‡(
s•_machöfo
->
cs_max1111
 >= 0)

250 
	`GPSR
(
s•_machöfo
->
cs_max1111
Ë
	`GPIO_bô
(ssp_machinfo->cs_max1111);

251 i‡(
s•_machöfo
->
cs_ads7846
 >= 0)

252 
	`GPSR
(
s•_machöfo
->
cs_ads7846
Ë
	`GPIO_bô
(ssp_machinfo->cs_ads7846);

253 
	`s•_ª°‹e_°©e
(&
c‹gi_s•_dev
,&
c‹gi_s•_°©e
);

254 
	`s•_íabÀ
(&
c‹gi_s•_dev
);

257 
	}
}

259 
∂©f‹m_drivî
 
	gc‹gis•_drivî
 = {

260 .
¥obe
 = 
c‹gi_s•_¥obe
,

261 .
	gªmove
 = 
c‹gi_s•_ªmove
,

262 .
	gsu•íd
 = 
c‹gi_s•_su•íd
,

263 .
	gªsume
 = 
c‹gi_s•_ªsume
,

264 .
	gdrivî
 = {

265 .
«me
 = "corgi-ssp",

269 
__öô
 
	$c‹gi_s•_öô
()

271  
	`∂©f‹m_drivî_ªgi°î
(&
c‹gis•_drivî
);

272 
	}
}

274 
¨ch_öôˇŒ
(
c‹gi_s•_öô
);

	@arch/arm/mach-pxa/dma.c

15 
	~<löux/moduÀ.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/kî√l.h
>

18 
	~<löux/öãºu±.h
>

19 
	~<löux/î∫o.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/dma.h
>

26 
	~<asm/¨ch/pxa-ªgs.h
>

28 
	sdma_ch™√l
 {

29 *
	m«me
;

30 (*
	múq_h™dÀr
)(, *);

31 *
	md©a
;

32 } 
	gdma_ch™√ls
[
PXA_DMA_CHANNELS
];

35 
pxa_ªque°_dma
 (*
«me
, 
pxa_dma_¥io
 
¥io
,

36 (*
úq_h™dÀr
)(, *),

37 *
d©a
)

39 
Êags
;

40 
i
, 
found
 = 0;

43 i‡(!
«me
 || !
úq_h™dÀr
)

44  -
EINVAL
;

46 
	`loˇl_úq_ßve
(
Êags
);

50 
	`pxa_f‹_óch_dma_¥io
 (
i
, 
¥io
) {

51 i‡(!
dma_ch™√ls
[
i
].
«me
) {

52 
found
 = 1;

57 } !
found
 && 
¥io
--);

59 i‡(
found
) {

60 
	`DCSR
(
i
Ë
DCSR_STARTINTR
|
DCSR_ENDINTR
|
DCSR_BUSERR
;

61 
dma_ch™√ls
[
i
].
«me
 =Çame;

62 
dma_ch™√ls
[
i
].
úq_h™dÀr
 = irq_handler;

63 
dma_ch™√ls
[
i
].
d©a
 = data;

65 
	`¥ötk
 (
KERN_WARNING
 "Nÿm‹êavaûabÀ DMA ch™√l†f‹ %s\n", 
«me
);

66 
i
 = -
ENODEV
;

69 
	`loˇl_úq_ª°‹e
(
Êags
);

70  
i
;

71 
	}
}

73 
	$pxa_‰ì_dma
 (
dma_ch
)

75 
Êags
;

77 i‡(!
dma_ch™√ls
[
dma_ch
].
«me
) {

78 
	`¥ötk
 (
KERN_CRIT


80 
__FUNCTION__
, 
dma_ch
);

84 
	`loˇl_úq_ßve
(
Êags
);

85 
	`DCSR
(
dma_ch
Ë
DCSR_STARTINTR
|
DCSR_ENDINTR
|
DCSR_BUSERR
;

86 
dma_ch™√ls
[
dma_ch
].
«me
 = 
NULL
;

87 
	`loˇl_úq_ª°‹e
(
Êags
);

88 
	}
}

90 
úqªtu∫_t
 
	$dma_úq_h™dÀr
(
úq
, *
dev_id
)

92 
i
, 
döt
 = 
DINT
;

94 
i
 = 0; i < 
PXA_DMA_CHANNELS
; i++) {

95 i‡(
döt
 & (1 << 
i
)) {

96 
dma_ch™√l
 *
ch™√l
 = &
dma_ch™√ls
[
i
];

97 i‡(
ch™√l
->
«me
 && ch™√l->
úq_h™dÀr
) {

98 
ch™√l
->
	`úq_h™dÀr
(
i
, ch™√l->
d©a
);

104 
	`¥ötk
 (
KERN_WARNING
 "•uriou†IRQ f‹ DMA ch™√»%d\n", 
i
);

105 
	`DCSR
(
i
Ë
DCSR_STARTINTR
|
DCSR_ENDINTR
|
DCSR_BUSERR
;

109  
IRQ_HANDLED
;

110 
	}
}

112 
__öô
 
	$pxa_dma_öô
 ()

114 
ªt
;

116 
ªt
 = 
	`ªque°_úq
 (
IRQ_DMA
, 
dma_úq_h™dÀr
, 0, "DMA", 
NULL
);

117 i‡(
ªt
)

118 
	`¥ötk
 (
KERN_CRIT
 "Wow! Can'tÑegister IRQ for DMA\n");

119  
ªt
;

120 
	}
}

122 
¨ch_öôˇŒ
(
pxa_dma_öô
);

124 
EXPORT_SYMBOL
(
pxa_ªque°_dma
);

125 
EXPORT_SYMBOL
(
pxa_‰ì_dma
);

	@arch/arm/mach-pxa/generic.c

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/∂©f‹m_devi˚.h
>

24 
	~<löux/i›‹t.h
>

25 
	~<löux/pm.h
>

26 
	~<löux/°rög.h
>

28 
	~<löux/sched.h
>

29 
	~<asm/˙t32_to_63.h
>

30 
	~<asm/div64.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/úq.h
>

34 
	~<asm/sy°em.h
>

35 
	~<asm/pgèbÀ.h
>

36 
	~<asm/mach/m≠.h
>

38 
	~<asm/¨ch/pxa-ªgs.h
>

39 
	~<asm/¨ch/gpio.h
>

40 
	~<asm/¨ch/udc.h
>

41 
	~<asm/¨ch/pxafb.h
>

42 
	~<asm/¨ch/mmc.h
>

43 
	~<asm/¨ch/úda.h
>

44 
	~<asm/¨ch/i2c.h
>

46 
	~"gíîic.h
"

57 
	$sched_˛ock
()

59 
v
 = 
	`˙t32_to_63
(
OSCR
);

62 #if 
CLOCK_TICK_RATE
 == 3686400

65 
v
 *= 78125<<1;

66 
	`do_div
(
v
, 288<<1);

67 #ñif 
CLOCK_TICK_RATE
 == 3250000

69 
v
 *= 4000;

70 
	`do_div
(
v
, 13);

71 #ñif 
CLOCK_TICK_RATE
 == 3249600

73 
v
 *= 625000;

74 
	`do_div
(
v
, 2031);

86 
vÆ
;

87 °ru˘ { 
lo
, 
hi
; };

88 } 
x
;

89 
y
;

91 
x
.
vÆ
 = 
v
;

92 
x
.
hi
 &= 0x7fffffff;

93 
y
 = ()
x
.
lo
 * 
NSEC_PER_SEC
;

94 
x
.
lo
 = 
y
;

95 
y
 = (y >> 32Ë+ ()
x
.
hi
 * 
NSEC_PER_SEC
;

96 
x
.
hi
 = 
	`do_div
(
y
, 
CLOCK_TICK_RATE
);

97 
	`do_div
(
x
.
vÆ
, 
CLOCK_TICK_RATE
);

98 
x
.
hi
 +
y
;

99 
v
 = 
x
.
vÆ
;

103  
v
;

104 
	}
}

110 
	$pxa_gpio_mode
(
gpio_mode
)

112 
Êags
;

113 
gpio
 = 
gpio_mode
 & 
GPIO_MD_MASK_NR
;

114 
‚
 = (
gpio_mode
 & 
GPIO_MD_MASK_FN
) >> 8;

115 
ga‰
;

117 i‡(
gpio
 > 
PXA_LAST_GPIO
)

118  -
EINVAL
;

120 
	`loˇl_úq_ßve
(
Êags
);

121 i‡(
gpio_mode
 & 
GPIO_DFLT_LOW
)

122 
	`GPCR
(
gpio
Ë
	`GPIO_bô
(gpio);

123 i‡(
gpio_mode
 & 
GPIO_DFLT_HIGH
)

124 
	`GPSR
(
gpio
Ë
	`GPIO_bô
(gpio);

125 i‡(
gpio_mode
 & 
GPIO_MD_MASK_DIR
)

126 
	`GPDR
(
gpio
Ë|
	`GPIO_bô
(gpio);

128 
	`GPDR
(
gpio
Ë&~
	`GPIO_bô
(gpio);

129 
ga‰
 = 
	`GAFR
(
gpio
) & ~(0x3 << (((gpio) & 0xf)*2));

130 
	`GAFR
(
gpio
Ë
ga‰
 | (
‚
 << (((gpio) & 0xf)*2));

131 
	`loˇl_úq_ª°‹e
(
Êags
);

134 
	}
}

136 
EXPORT_SYMBOL
(
pxa_gpio_mode
);

141 
	$pxa_gpio_gë_vÆue
(
gpio
)

143  
	`__gpio_gë_vÆue
(
gpio
);

144 
	}
}

146 
EXPORT_SYMBOL
(
pxa_gpio_gë_vÆue
);

151 
	$pxa_gpio_£t_vÆue
(
gpio
, 
vÆue
)

153 
	`__gpio_£t_vÆue
(
gpio
, 
vÆue
);

154 
	}
}

156 
EXPORT_SYMBOL
(
pxa_gpio_£t_vÆue
);

161 
	$pxa_£t_ckí
(
˛ock
, 
íabÀ
)

163 
Êags
;

164 
	`loˇl_úq_ßve
(
Êags
);

166 i‡(
íabÀ
)

167 
CKEN
 |(1 << 
˛ock
);

169 
CKEN
 &~(1 << 
˛ock
);

171 
	`loˇl_úq_ª°‹e
(
Êags
);

172 
	}
}

174 
EXPORT_SYMBOL
(
pxa_£t_ckí
);

184 
m≠_desc
 
	g°™d¨d_io_desc
[] 
	g__öôd©a
 = {

186 .
vútuÆ
 = 0xf2000000,

187 .
	gp‚
 = 
__phys_to_p‚
(0x40000000),

188 .
	gÀngth
 = 0x02000000,

189 .
	gty≥
 = 
MT_DEVICE


191 .
	gvútuÆ
 = 0xf4000000,

192 .
	gp‚
 = 
__phys_to_p‚
(0x44000000),

193 .
	gÀngth
 = 0x00100000,

194 .
	gty≥
 = 
MT_DEVICE


196 .
	gvútuÆ
 = 0xf6000000,

197 .
	gp‚
 = 
__phys_to_p‚
(0x48000000),

198 .
	gÀngth
 = 0x00100000,

199 .
	gty≥
 = 
MT_DEVICE


201 .
	gvútuÆ
 = 0xf8000000,

202 .
	gp‚
 = 
__phys_to_p‚
(0x4c000000),

203 .
	gÀngth
 = 0x00100000,

204 .
	gty≥
 = 
MT_DEVICE


206 .
	gvútuÆ
 = 0xfa000000,

207 .
	gp‚
 = 
__phys_to_p‚
(0x50000000),

208 .
	gÀngth
 = 0x00100000,

209 .
	gty≥
 = 
MT_DEVICE


211 .
	gvútuÆ
 = 0xfe000000,

212 .
	gp‚
 = 
__phys_to_p‚
(0x58000000),

213 .
	gÀngth
 = 0x00100000,

214 .
	gty≥
 = 
MT_DEVICE


216 .
	gvútuÆ
 = 0xff000000,

217 .
	gp‚
 = 
__phys_to_p‚
(0x00000000),

218 .
	gÀngth
 = 0x00100000,

219 .
	gty≥
 = 
MT_DEVICE


223 
__öô
 
	$pxa_m≠_io
()

225 
	`iŸabÀ_öô
(
°™d¨d_io_desc
, 
	`ARRAY_SIZE
(standard_io_desc));

226 
	`gë_˛k_‰equícy_khz
(1);

227 
	}
}

230 
ªsour˚
 
	gpxamci_ªsour˚s
[] = {

232 .
°¨t
 = 0x41100000,

233 .
	gíd
 = 0x41100fff,

234 .
	gÊags
 = 
IORESOURCE_MEM
,

237 .
°¨t
 = 
IRQ_MMC
,

238 .
	gíd
 = 
IRQ_MMC
,

239 .
	gÊags
 = 
IORESOURCE_IRQ
,

243 
u64
 
	gpxamci_dmamask
 = 0xffffffffUL;

245 
∂©f‹m_devi˚
 
	gpxamci_devi˚
 = {

246 .
«me
 = "pxa2xx-mci",

247 .
	gid
 = -1,

248 .
	gdev
 = {

249 .
dma_mask
 = &
pxamci_dmamask
,

250 .
	gcohîít_dma_mask
 = 0xffffffff,

252 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
pxamci_ªsour˚s
),

253 .
	gªsour˚
 = 
pxamci_ªsour˚s
,

256 
__öô
 
	$pxa_£t_mci_öfo
(
pxamci_∂©f‹m_d©a
 *
öfo
)

258 
pxamci_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

259 
	}
}

262 
pxa2xx_udc_mach_öfo
 
	gpxa_udc_öfo
;

264 
__öô
 
	$pxa_£t_udc_öfo
(
pxa2xx_udc_mach_öfo
 *
öfo
)

266 
	`mem˝y
(&
pxa_udc_öfo
, 
öfo
,  *info);

267 
	}
}

269 
ªsour˚
 
	gpxa2xx_udc_ªsour˚s
[] = {

271 .
°¨t
 = 0x40600000,

272 .
	gíd
 = 0x4060ffff,

273 .
	gÊags
 = 
IORESOURCE_MEM
,

276 .
°¨t
 = 
IRQ_USB
,

277 .
	gíd
 = 
IRQ_USB
,

278 .
	gÊags
 = 
IORESOURCE_IRQ
,

282 
u64
 
	gudc_dma_mask
 = ~(
u32
)0;

284 
∂©f‹m_devi˚
 
	gudc_devi˚
 = {

285 .
«me
 = "pxa2xx-udc",

286 .
	gid
 = -1,

287 .
	gªsour˚
 = 
pxa2xx_udc_ªsour˚s
,

288 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
pxa2xx_udc_ªsour˚s
),

289 .
	gdev
 = {

290 .
∂©f‹m_d©a
 = &
pxa_udc_öfo
,

291 .
	gdma_mask
 = &
udc_dma_mask
,

295 
ªsour˚
 
	gpxafb_ªsour˚s
[] = {

297 .
°¨t
 = 0x44000000,

298 .
	gíd
 = 0x4400ffff,

299 .
	gÊags
 = 
IORESOURCE_MEM
,

302 .
°¨t
 = 
IRQ_LCD
,

303 .
	gíd
 = 
IRQ_LCD
,

304 .
	gÊags
 = 
IORESOURCE_IRQ
,

308 
u64
 
	gfb_dma_mask
 = ~(u64)0;

310 
∂©f‹m_devi˚
 
	gpxafb_devi˚
 = {

311 .
«me
 = "pxa2xx-fb",

312 .
	gid
 = -1,

313 .
	gdev
 = {

314 .
dma_mask
 = &
fb_dma_mask
,

315 .
	gcohîít_dma_mask
 = 0xffffffff,

317 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
pxafb_ªsour˚s
),

318 .
	gªsour˚
 = 
pxafb_ªsour˚s
,

321 
__öô
 
	$£t_pxa_fb_öfo
(
pxafb_mach_öfo
 *
öfo
)

323 
pxafb_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

324 
	}
}

326 
__öô
 
	$£t_pxa_fb_∑ª¡
(
devi˚
 *
∑ª¡_dev
)

328 
pxafb_devi˚
.
dev
.
∑ª¡
 = 
∑ª¡_dev
;

329 
	}
}

331 
∂©f‹m_devi˚
 
	gffu¨t_devi˚
 = {

332 .
«me
 = "pxa2xx-uart",

333 .
	gid
 = 0,

335 
∂©f‹m_devi˚
 
	gbtu¨t_devi˚
 = {

336 .
«me
 = "pxa2xx-uart",

337 .
	gid
 = 1,

339 
∂©f‹m_devi˚
 
	g°u¨t_devi˚
 = {

340 .
«me
 = "pxa2xx-uart",

341 .
	gid
 = 2,

343 
∂©f‹m_devi˚
 
	ghwu¨t_devi˚
 = {

344 .
«me
 = "pxa2xx-uart",

345 .
	gid
 = 3,

348 
ªsour˚
 
	gi2c_ªsour˚s
[] = {

350 .
°¨t
 = 0x40301680,

351 .
	gíd
 = 0x403016a3,

352 .
	gÊags
 = 
IORESOURCE_MEM
,

354 .
	g°¨t
 = 
IRQ_I2C
,

355 .
	gíd
 = 
IRQ_I2C
,

356 .
	gÊags
 = 
IORESOURCE_IRQ
,

360 
∂©f‹m_devi˚
 
	gi2c_devi˚
 = {

361 .
«me
 = "pxa2xx-i2c",

362 .
	gid
 = 0,

363 .
	gªsour˚
 = 
i2c_ªsour˚s
,

364 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
i2c_ªsour˚s
),

367 #ifde‡
CONFIG_PXA27x


368 
ªsour˚
 
	gi2c_powî_ªsour˚s
[] = {

370 .
°¨t
 = 0x40f00180,

371 .
	gíd
 = 0x40f001a3,

372 .
	gÊags
 = 
IORESOURCE_MEM
,

374 .
	g°¨t
 = 
IRQ_PWRI2C
,

375 .
	gíd
 = 
IRQ_PWRI2C
,

376 .
	gÊags
 = 
IORESOURCE_IRQ
,

380 
∂©f‹m_devi˚
 
	gi2c_powî_devi˚
 = {

381 .
«me
 = "pxa2xx-i2c",

382 .
	gid
 = 1,

383 .
	gªsour˚
 = 
i2c_powî_ªsour˚s
,

384 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
i2c_ªsour˚s
),

388 
__öô
 
	$pxa_£t_i2c_öfo
(
i2c_pxa_∂©f‹m_d©a
 *
öfo
)

390 
i2c_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

391 
	}
}

393 
ªsour˚
 
	gi2s_ªsour˚s
[] = {

395 .
°¨t
 = 0x40400000,

396 .
	gíd
 = 0x40400083,

397 .
	gÊags
 = 
IORESOURCE_MEM
,

399 .
	g°¨t
 = 
IRQ_I2S
,

400 .
	gíd
 = 
IRQ_I2S
,

401 .
	gÊags
 = 
IORESOURCE_IRQ
,

405 
∂©f‹m_devi˚
 
	gi2s_devi˚
 = {

406 .
«me
 = "pxa2xx-i2s",

407 .
	gid
 = -1,

408 .
	gªsour˚
 = 
i2s_ªsour˚s
,

409 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
i2s_ªsour˚s
),

412 
u64
 
	gpxafi˝_dmamask
 = ~(
u32
)0;

414 
∂©f‹m_devi˚
 
	gpxafi˝_devi˚
 = {

415 .
«me
 = "pxa2xx-ir",

416 .
	gid
 = -1,

417 .
	gdev
 = {

418 .
dma_mask
 = &
pxafi˝_dmamask
,

419 .
	gcohîít_dma_mask
 = 0xffffffff,

423 
__öô
 
	$pxa_£t_fi˝_öfo
(
pxafi˝_∂©f‹m_d©a
 *
öfo
)

425 
pxafi˝_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

426 
	}
}

428 
∂©f‹m_devi˚
 
	gpx¨tc_devi˚
 = {

429 .
«me
 = "sa1100-rtc",

430 .
	gid
 = -1,

433 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

434 &
pxamci_devi˚
,

435 &
udc_devi˚
,

436 &
pxafb_devi˚
,

437 &
ffu¨t_devi˚
,

438 &
btu¨t_devi˚
,

439 &
°u¨t_devi˚
,

440 &
pxafi˝_devi˚
,

441 &
i2c_devi˚
,

442 #ifde‡
CONFIG_PXA27x


443 &
i2c_powî_devi˚
,

445 &
i2s_devi˚
,

446 &
px¨tc_devi˚
,

449 
__öô
 
	$pxa_öô
()

451 
˝uid
, 
ªt
;

453 
ªt
 = 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

454 i‡(
ªt
)

455  
ªt
;

458 
˝uid
 = 
	`ªad_˝uid
(
CPUID_ID
);

459 i‡(((
˝uid
 >> 4) & 0xfff) == 0x2d0 ||

460 ((
˝uid
 >> 4) & 0xfff) == 0x290)

461 
ªt
 = 
	`∂©f‹m_devi˚_ªgi°î
(&
hwu¨t_devi˚
);

463  
ªt
;

464 
	}
}

466 
subsys_öôˇŒ
(
pxa_öô
);

	@arch/arm/mach-pxa/generic.h

12 
	gsys_timî
;

14 
sys_timî
 
pxa_timî
;

15 
__öô
 
pxa_m≠_io
();

16 
__öô
 
pxa_öô_úq
();

18 
gë_˛k_‰equícy_khz
(
öfo
);

20 
	#SET_BANK
(
__ƒ
,
__°¨t
,
__size
) \

21 
mi
->
b™k
[
__ƒ
].
°¨t
 = (
__°¨t
), \

22 
mi
->
b™k
[
__ƒ
].
size
 = (
__size
), \

23 
mi
->
b™k
[
__ƒ
].
node
 = ((()(
__°¨t
Ë- 
PHYS_OFFSET
Ë>> 27)

	)

	@arch/arm/mach-pxa/idp.c

19 
	~<löux/öô.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/úq.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/fb.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/mem‹y.h
>

27 
	~<asm/mach-ty≥s.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/úq.h
>

31 
	~<asm/mach/¨ch.h
>

32 
	~<asm/mach/m≠.h
>

34 
	~<asm/¨ch/pxa-ªgs.h
>

35 
	~<asm/¨ch/idp.h
>

36 
	~<asm/¨ch/pxafb.h
>

37 
	~<asm/¨ch/bôfõld.h
>

38 
	~<asm/¨ch/mmc.h
>

40 
	~"gíîic.h
"

47 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

49 .
°¨t
 = (
IDP_ETH_PHYS
 + 0x300),

50 .
	gíd
 = (
IDP_ETH_PHYS
 + 0xfffff),

51 .
	gÊags
 = 
IORESOURCE_MEM
,

54 .
°¨t
 = 
IRQ_GPIO
(4),

55 .
	gíd
 = 
IRQ_GPIO
(4),

56 .
	gÊags
 = 
IORESOURCE_IRQ
,

60 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

61 .
«me
 = "smc91x",

62 .
	gid
 = 0,

63 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

64 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

67 
	$idp_backlight_powî
(
⁄
)

69 i‡(
⁄
) {

70 
IDP_CPLD_LCD
 |= (1<<1);

72 
IDP_CPLD_LCD
 &= ~(1<<1);

74 
	}
}

76 
	$idp_vlcd
(
⁄
)

78 i‡(
⁄
) {

79 
IDP_CPLD_LCD
 |= (1<<2);

81 
IDP_CPLD_LCD
 &= ~(1<<2);

83 
	}
}

85 
	$idp_lcd_powî
(
⁄
, 
fb_v¨_s¸ìnöfo
 *
v¨
)

87 i‡(
⁄
) {

88 
IDP_CPLD_LCD
 |= (1<<0);

90 
IDP_CPLD_LCD
 &= ~(1<<0);

99 
	`idp_vlcd
(
⁄
);

100 
	}
}

102 
pxafb_mode_öfo
 
	gsh¨p_lm8v31_mode
 = {

103 .
pix˛ock
 = 270000,

104 .
	gxªs
 = 640,

105 .
	gyªs
 = 480,

106 .
	gbµ
 = 16,

107 .
	ghsync_Àn
 = 1,

108 .
	gÀ·_m¨gö
 = 3,

109 .
	gright_m¨gö
 = 3,

110 .
	gvsync_Àn
 = 1,

111 .
	guµî_m¨gö
 = 0,

112 .
	glowî_m¨gö
 = 0,

113 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

114 .
	gcm≠_gªysˇÀ
 = 0,

117 
pxafb_mach_öfo
 
	gsh¨p_lm8v31
 = {

118 .
modes
 = &
sh¨p_lm8v31_mode
,

119 .
	gnum_modes
 = 1,

120 .
	gcm≠_övî£
 = 0,

121 .
	gcm≠_°©ic
 = 0,

122 .
	glc¸0
 = 
LCCR0_SDS
,

123 .
	glc¸3
 = 
LCCR3_PCP
 | 
LCCR3_Acb
(255),

124 .
	gpxafb_backlight_powî
 = &
idp_backlight_powî
,

125 .
	gpxafb_lcd_powî
 = &
idp_lcd_powî


128 
	$idp_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
idp_dëe˘_öt
, *
d©a
)

131 
	`pxa_gpio_mode
(
GPIO6_MMCCLK_MD
);

132 
	`pxa_gpio_mode
(
GPIO8_MMCCS0_MD
);

135 
	}
}

137 
pxamci_∂©f‹m_d©a
 
	gidp_mci_∂©f‹m_d©a
 = {

138 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

139 .
	göô
 = 
idp_mci_öô
,

142 
__öô
 
	$idp_öô
()

144 
	`¥ötk
("idp_init()\n");

146 
	`∂©f‹m_devi˚_ªgi°î
(&
smc91x_devi˚
);

148 
	`£t_pxa_fb_öfo
(&
sh¨p_lm8v31
);

149 
	`pxa_£t_mci_öfo
(&
idp_mci_∂©f‹m_d©a
);

150 
	}
}

152 
__öô
 
	$idp_öô_úq
()

155 
	`pxa_öô_úq
();

157 
	`£t_úq_ty≥
(
TOUCH_PANEL_IRQ
, 
TOUCH_PANEL_IRQ_EDGE
);

158 
	}
}

160 
m≠_desc
 
	gidp_io_desc
[] 
	g__öôd©a
 = {

162 .
vútuÆ
 = 
IDP_COREVOLT_VIRT
,

163 .
	gp‚
 = 
__phys_to_p‚
(
IDP_COREVOLT_PHYS
),

164 .
	gÀngth
 = 
IDP_COREVOLT_SIZE
,

165 .
	gty≥
 = 
MT_DEVICE


167 .
	gvútuÆ
 = 
IDP_CPLD_VIRT
,

168 .
	gp‚
 = 
__phys_to_p‚
(
IDP_CPLD_PHYS
),

169 .
	gÀngth
 = 
IDP_CPLD_SIZE
,

170 .
	gty≥
 = 
MT_DEVICE


174 
__öô
 
	$idp_m≠_io
()

176 
	`pxa_m≠_io
();

177 
	`iŸabÀ_öô
(
idp_io_desc
, 
	`ARRAY_SIZE
(idp_io_desc));

180 
	`pxa_gpio_mode
(
GPIO42_BTRXD_MD
);

181 
	`pxa_gpio_mode
(
GPIO43_BTTXD_MD
);

182 
	`pxa_gpio_mode
(
GPIO44_BTCTS_MD
);

183 
	`pxa_gpio_mode
(
GPIO45_BTRTS_MD
);

184 
	`pxa_gpio_mode
(
GPIO46_STRXD_MD
);

185 
	`pxa_gpio_mode
(
GPIO47_STTXD_MD
);

187 
	}
}

190 
MACHINE_START
(
PXA_IDP
, "Vibren PXA255 IDP")

192 .
	gphys_io
 = 0x40000000,

193 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

194 .
	gm≠_io
 = 
idp_m≠_io
,

195 .
	göô_úq
 = 
idp_öô_úq
,

196 .
	gtimî
 = &
pxa_timî
,

197 .
	göô_machöe
 = 
idp_öô
,

198 
	gMACHINE_END


	@arch/arm/mach-pxa/irq.c

15 
	~<löux/öô.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öãºu±.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/úq.h
>

21 
	~<asm/mach/úq.h
>

22 
	~<asm/¨ch/pxa-ªgs.h
>

24 
	~"gíîic.h
"

31 
	$pxa_mask_low_úq
(
úq
)

33 
ICMR
 &~(1 << (
úq
 + 
PXA_IRQ_SKIP
));

34 
	}
}

36 
	$pxa_unmask_low_úq
(
úq
)

38 
ICMR
 |(1 << (
úq
 + 
PXA_IRQ_SKIP
));

39 
	}
}

41 
	$pxa_£t_wake
(
úq
, 
⁄
)

43 
u32
 
mask
;

45 
úq
) {

46 
IRQ_RTCAÃm
:

47 
mask
 = 
PWER_RTC
;

49 #ifde‡
CONFIG_PXA27x


53  -
EINVAL
;

55 i‡(
⁄
)

56 
PWER
 |
mask
;

58 
PWER
 &~
mask
;

60 
	}
}

62 
úq_chù
 
	gpxa_öã∫Æ_chù_low
 = {

63 .
«me
 = "SC",

64 .
	gack
 = 
pxa_mask_low_úq
,

65 .
	gmask
 = 
pxa_mask_low_úq
,

66 .
	gunmask
 = 
pxa_unmask_low_úq
,

67 .
	g£t_wake
 = 
pxa_£t_wake
,

70 #i‡
PXA_INTERNAL_IRQS
 > 32

76 
	$pxa_mask_high_úq
(
úq
)

78 
ICMR2
 &~(1 << (
úq
 - 32 + 
PXA_IRQ_SKIP
));

79 
	}
}

81 
	$pxa_unmask_high_úq
(
úq
)

83 
ICMR2
 |(1 << (
úq
 - 32 + 
PXA_IRQ_SKIP
));

84 
	}
}

86 
úq_chù
 
	gpxa_öã∫Æ_chù_high
 = {

87 .
«me
 = "SC-hi",

88 .
	gack
 = 
pxa_mask_high_úq
,

89 .
	gmask
 = 
pxa_mask_high_úq
,

90 .
	gunmask
 = 
pxa_unmask_high_úq
,

98 #ifde‡
CONFIG_PXA27x


103 
	#PXA27x_GPIO_NOWAKE_MASK
 \

104 ((1 << 8Ë| (1 << 7Ë| (1 << 6Ë| (1 << 5Ë| (1 << 2))

	)

105 
	#WAKEMASK
(
gpio
) \

106 (((
gpio
) <= 15) \

107 ? ((1 << (
gpio
)Ë& ~
PXA27x_GPIO_NOWAKE_MASK
) \

108 : ((
gpio
 =35Ë? (1 << 24Ë: 0))

	)

112 
	#WAKEMASK
(
gpio
Ë(((gpioË<15Ë? (1 << (gpio)Ë: 0)

	)

121 
	gGPIO_IRQ_risög_edge
[4];

122 
	gGPIO_IRQ_ÁŒög_edge
[4];

123 
	gGPIO_IRQ_mask
[4];

125 
	$pxa_gpio_úq_ty≥
(
úq
, 
ty≥
)

127 
gpio
, 
idx
;

128 
u32
 
mask
;

130 
gpio
 = 
	`IRQ_TO_GPIO
(
úq
);

131 
idx
 = 
gpio
 >> 5;

132 
mask
 = 
	`WAKEMASK
(
gpio
);

134 i‡(
ty≥
 =
IRQT_PROBE
) {

137 i‡((
GPIO_IRQ_risög_edge
[
idx
] | 
GPIO_IRQ_ÁŒög_edge
[idx] | 
	`GPDR
(
gpio
)) &

138 
	`GPIO_bô
(
gpio
))

140 i‡(
	`GAFR
(
gpio
) & (0x3 << (((gpio) & 0xf)*2)))

142 
ty≥
 = 
__IRQT_RISEDGE
 | 
__IRQT_FALEDGE
;

147 
	`pxa_gpio_mode
(
gpio
 | 
GPIO_IN
);

149 i‡(
ty≥
 & 
__IRQT_RISEDGE
) {

151 
	`__£t_bô
 (
gpio
, 
GPIO_IRQ_risög_edge
);

152 
PRER
 |
mask
;

154 
	`__˛ór_bô
 (
gpio
, 
GPIO_IRQ_risög_edge
);

155 
PRER
 &~
mask
;

158 i‡(
ty≥
 & 
__IRQT_FALEDGE
) {

160 
	`__£t_bô
 (
gpio
, 
GPIO_IRQ_ÁŒög_edge
);

161 
PFER
 |
mask
;

163 
	`__˛ór_bô
 (
gpio
, 
GPIO_IRQ_ÁŒög_edge
);

164 
PFER
 &~
mask
;

169 
	`GRER
(
gpio
Ë
GPIO_IRQ_risög_edge
[
idx
] & 
GPIO_IRQ_mask
[idx];

170 
	`GFER
(
gpio
Ë
GPIO_IRQ_ÁŒög_edge
[
idx
] & 
GPIO_IRQ_mask
[idx];

172 
	}
}

178 
	$pxa_ack_low_gpio
(
úq
)

180 
GEDR0
 = (1 << (
úq
 - 
IRQ_GPIO0
));

181 
	}
}

183 
	$pxa_£t_gpio_wake
(
úq
, 
⁄
)

185 
gpio
 = 
	`IRQ_TO_GPIO
(
úq
);

186 
u32
 
mask
 = 
	`WAKEMASK
(
gpio
);

188 i‡(!
mask
)

189  -
EINVAL
;

191 i‡(
⁄
)

192 
PWER
 |
mask
;

194 
PWER
 &~
mask
;

196 
	}
}

199 
úq_chù
 
	gpxa_low_gpio_chù
 = {

200 .
«me
 = "GPIO-l",

201 .
	gack
 = 
pxa_ack_low_gpio
,

202 .
	gmask
 = 
pxa_mask_low_úq
,

203 .
	gunmask
 = 
pxa_unmask_low_úq
,

204 .
	g£t_ty≥
 = 
pxa_gpio_úq_ty≥
,

205 .
	g£t_wake
 = 
pxa_£t_gpio_wake
,

212 
	$pxa_gpio_demux_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

214 
mask
;

215 
lo›
;

218 
lo›
 = 0;

220 
mask
 = 
GEDR0
 & ~3;

221 i‡(
mask
) {

222 
GEDR0
 = 
mask
;

223 
úq
 = 
	`IRQ_GPIO
(2);

224 
desc
 = 
úq_desc
 + 
úq
;

225 
mask
 >>= 2;

227 i‡(
mask
 & 1)

228 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

229 
úq
++;

230 
desc
++;

231 
mask
 >>= 1;

232 } 
mask
);

233 
lo›
 = 1;

236 
mask
 = 
GEDR1
;

237 i‡(
mask
) {

238 
GEDR1
 = 
mask
;

239 
úq
 = 
	`IRQ_GPIO
(32);

240 
desc
 = 
úq_desc
 + 
úq
;

242 i‡(
mask
 & 1)

243 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

244 
úq
++;

245 
desc
++;

246 
mask
 >>= 1;

247 } 
mask
);

248 
lo›
 = 1;

251 
mask
 = 
GEDR2
;

252 i‡(
mask
) {

253 
GEDR2
 = 
mask
;

254 
úq
 = 
	`IRQ_GPIO
(64);

255 
desc
 = 
úq_desc
 + 
úq
;

257 i‡(
mask
 & 1)

258 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

259 
úq
++;

260 
desc
++;

261 
mask
 >>= 1;

262 } 
mask
);

263 
lo›
 = 1;

266 #i‡
PXA_LAST_GPIO
 >= 96

267 
mask
 = 
GEDR3
;

268 i‡(
mask
) {

269 
GEDR3
 = 
mask
;

270 
úq
 = 
	`IRQ_GPIO
(96);

271 
desc
 = 
úq_desc
 + 
úq
;

273 i‡(
mask
 & 1)

274 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

275 
úq
++;

276 
desc
++;

277 
mask
 >>= 1;

278 } 
mask
);

279 
lo›
 = 1;

282 } 
lo›
);

283 
	}
}

285 
	$pxa_ack_muxed_gpio
(
úq
)

287 
gpio
 = 
úq
 - 
	`IRQ_GPIO
(2) + 2;

288 
	`GEDR
(
gpio
Ë
	`GPIO_bô
(gpio);

289 
	}
}

291 
	$pxa_mask_muxed_gpio
(
úq
)

293 
gpio
 = 
úq
 - 
	`IRQ_GPIO
(2) + 2;

294 
	`__˛ór_bô
(
gpio
, 
GPIO_IRQ_mask
);

295 
	`GRER
(
gpio
Ë&~
	`GPIO_bô
(gpio);

296 
	`GFER
(
gpio
Ë&~
	`GPIO_bô
(gpio);

297 
	}
}

299 
	$pxa_unmask_muxed_gpio
(
úq
)

301 
gpio
 = 
úq
 - 
	`IRQ_GPIO
(2) + 2;

302 
idx
 = 
gpio
 >> 5;

303 
	`__£t_bô
(
gpio
, 
GPIO_IRQ_mask
);

304 
	`GRER
(
gpio
Ë
GPIO_IRQ_risög_edge
[
idx
] & 
GPIO_IRQ_mask
[idx];

305 
	`GFER
(
gpio
Ë
GPIO_IRQ_ÁŒög_edge
[
idx
] & 
GPIO_IRQ_mask
[idx];

306 
	}
}

308 
úq_chù
 
	gpxa_muxed_gpio_chù
 = {

309 .
«me
 = "GPIO",

310 .
	gack
 = 
pxa_ack_muxed_gpio
,

311 .
	gmask
 = 
pxa_mask_muxed_gpio
,

312 .
	gunmask
 = 
pxa_unmask_muxed_gpio
,

313 .
	g£t_ty≥
 = 
pxa_gpio_úq_ty≥
,

314 .
	g£t_wake
 = 
pxa_£t_gpio_wake
,

318 
__öô
 
	$pxa_öô_úq
()

320 
úq
;

323 
ICMR
 = 0;

326 
ICLR
 = 0;

329 
GFER0
 = 0;

330 
GFER1
 = 0;

331 
GFER2
 = 0;

332 
GRER0
 = 0;

333 
GRER1
 = 0;

334 
GRER2
 = 0;

335 
GEDR0
 = GEDR0;

336 
GEDR1
 = GEDR1;

337 
GEDR2
 = GEDR2;

339 #ifde‡
CONFIG_PXA27x


341 
ICMR2
 = 0;

342 
ICLR2
 = 0;

343 
GFER3
 = 0;

344 
GRER3
 = 0;

345 
GEDR3
 = GEDR3;

349 
ICCR
 = 1;

352 
GPIO_IRQ_mask
[0] = 3;

354 
úq
 = 
	`PXA_IRQ
(
PXA_IRQ_SKIP
); irq <= PXA_IRQ(31); irq++) {

355 
	`£t_úq_chù
(
úq
, &
pxa_öã∫Æ_chù_low
);

356 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

357 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

360 #i‡
PXA_INTERNAL_IRQS
 > 32

361 
úq
 = 
	`PXA_IRQ
(32); irq < PXA_IRQ(
PXA_INTERNAL_IRQS
); irq++) {

362 
	`£t_úq_chù
(
úq
, &
pxa_öã∫Æ_chù_high
);

363 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

364 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

368 
úq
 = 
IRQ_GPIO0
; irq <
IRQ_GPIO1
; irq++) {

369 
	`£t_úq_chù
(
úq
, &
pxa_low_gpio_chù
);

370 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

371 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

374 
úq
 = 
	`IRQ_GPIO
(2); irq <IRQ_GPIO(
PXA_LAST_GPIO
); irq++) {

375 
	`£t_úq_chù
(
úq
, &
pxa_muxed_gpio_chù
);

376 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_edge_úq
);

377 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

381 
	`£t_úq_chù
(
IRQ_GPIO_2_x
, &
pxa_öã∫Æ_chù_low
);

382 
	`£t_úq_chaöed_h™dÀr
(
IRQ_GPIO_2_x
, 
pxa_gpio_demux_h™dÀr
);

383 
	}
}

	@arch/arm/mach-pxa/leds-idp.c

15 
	~<löux/öô.h
>

17 
	~<asm/h¨dw¨e.h
>

18 
	~<asm/Àds.h
>

19 
	~<asm/sy°em.h
>

21 
	~<asm/¨ch/pxa-ªgs.h
>

22 
	~<asm/¨ch/idp.h
>

24 
	~"Àds.h
"

26 
	#LED_STATE_ENABLED
 1

	)

27 
	#LED_STATE_CLAIMED
 2

	)

29 
	gÀd_°©e
;

30 
	ghw_Àd_°©e
;

32 
	$idp_Àds_evít
(
Àd_evít_t
 
evt
)

34 
Êags
;

36 
	`loˇl_úq_ßve
(
Êags
);

38 
evt
) {

39 
Àd_°¨t
:

40 
hw_Àd_°©e
 = 
IDP_HB_LED
 | 
IDP_BUSY_LED
;

41 
Àd_°©e
 = 
LED_STATE_ENABLED
;

44 
Àd_°›
:

45 
Àd_°©e
 &~
LED_STATE_ENABLED
;

48 
Àd_˛aim
:

49 
Àd_°©e
 |
LED_STATE_CLAIMED
;

50 
hw_Àd_°©e
 = 
IDP_HB_LED
 | 
IDP_BUSY_LED
;

53 
Àd_ªÀa£
:

54 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

55 
hw_Àd_°©e
 = 
IDP_HB_LED
 | 
IDP_BUSY_LED
;

58 #ifde‡
CONFIG_LEDS_TIMER


59 
Àd_timî
:

60 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

61 
hw_Àd_°©e
 ^
IDP_HB_LED
;

65 #ifde‡
CONFIG_LEDS_CPU


66 
Àd_idÀ_°¨t
:

67 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

68 
hw_Àd_°©e
 &~
IDP_BUSY_LED
;

71 
Àd_idÀ_íd
:

72 i‡(!(
Àd_°©e
 & 
LED_STATE_CLAIMED
))

73 
hw_Àd_°©e
 |
IDP_BUSY_LED
;

77 
Àd_hÆãd
:

80 
Àd_gªí_⁄
:

81 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

82 
hw_Àd_°©e
 |
IDP_HB_LED
;

85 
Àd_gªí_off
:

86 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

87 
hw_Àd_°©e
 &~
IDP_HB_LED
;

90 
Àd_ambî_⁄
:

93 
Àd_ambî_off
:

96 
Àd_ªd_⁄
:

97 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

98 
hw_Àd_°©e
 |
IDP_BUSY_LED
;

101 
Àd_ªd_off
:

102 i‡(
Àd_°©e
 & 
LED_STATE_CLAIMED
)

103 
hw_Àd_°©e
 &~
IDP_BUSY_LED
;

110 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

111 
IDP_CPLD_LED_CONTROL
 = ( (IDP_CPLD_LED_CONTROL | 
IDP_LEDS_MASK
Ë& ~
hw_Àd_°©e
);

113 
IDP_CPLD_LED_CONTROL
 |
IDP_LEDS_MASK
;

115 
	`loˇl_úq_ª°‹e
(
Êags
);

116 
	}
}

	@arch/arm/mach-pxa/leds-lubbock.c

14 
	~<löux/öô.h
>

16 
	~<asm/h¨dw¨e.h
>

17 
	~<asm/Àds.h
>

18 
	~<asm/sy°em.h
>

19 
	~<asm/¨ch/pxa-ªgs.h
>

20 
	~<asm/¨ch/lubbock.h
>

22 
	~"Àds.h
"

31 
	#D28
 (1 << 0)

	)

32 
	#D27
 (1 << 1)

	)

33 
	#D26
 (1 << 2)

	)

34 
	#D25
 (1 << 3)

	)

35 
	#D24
 (1 << 4)

	)

36 
	#D23
 (1 << 5)

	)

37 
	#D22
 (1 << 6)

	)

38 
	#D21
 (1 << 7)

	)

40 
	#LED_STATE_ENABLED
 1

	)

41 
	#LED_STATE_CLAIMED
 2

	)

43 
	gÀd_°©e
;

44 
	ghw_Àd_°©e
;

46 
	$lubbock_Àds_evít
(
Àd_evít_t
 
evt
)

48 
Êags
;

50 
	`loˇl_úq_ßve
(
Êags
);

52 
evt
) {

53 
Àd_°¨t
:

54 
hw_Àd_°©e
 = 0;

55 
Àd_°©e
 = 
LED_STATE_ENABLED
;

58 
Àd_°›
:

59 
Àd_°©e
 &~
LED_STATE_ENABLED
;

62 
Àd_˛aim
:

63 
Àd_°©e
 |
LED_STATE_CLAIMED
;

64 
hw_Àd_°©e
 = 0;

67 
Àd_ªÀa£
:

68 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

69 
hw_Àd_°©e
 = 0;

72 #ifde‡
CONFIG_LEDS_TIMER


73 
Àd_timî
:

74 
hw_Àd_°©e
 ^
D26
;

78 #ifde‡
CONFIG_LEDS_CPU


79 
Àd_idÀ_°¨t
:

80 
hw_Àd_°©e
 &~
D27
;

83 
Àd_idÀ_íd
:

84 
hw_Àd_°©e
 |
D27
;

88 
Àd_hÆãd
:

91 
Àd_gªí_⁄
:

92 
hw_Àd_°©e
 |
D21
;

95 
Àd_gªí_off
:

96 
hw_Àd_°©e
 &~
D21
;

99 
Àd_ambî_⁄
:

100 
hw_Àd_°©e
 |
D22
;

103 
Àd_ambî_off
:

104 
hw_Àd_°©e
 &~
D22
;

107 
Àd_ªd_⁄
:

108 
hw_Àd_°©e
 |
D23
;

111 
Àd_ªd_off
:

112 
hw_Àd_°©e
 &~
D23
;

119 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

120 
LUB_DISC_BLNK_LED
 = (LUB_DISC_BLNK_LED | 0xffË& ~
hw_Àd_°©e
;

122 
LUB_DISC_BLNK_LED
 |= 0xff;

124 
	`loˇl_úq_ª°‹e
(
Êags
);

125 
	}
}

	@arch/arm/mach-pxa/leds-mainstone.c

13 
	~<löux/öô.h
>

15 
	~<asm/h¨dw¨e.h
>

16 
	~<asm/Àds.h
>

17 
	~<asm/sy°em.h
>

19 
	~<asm/¨ch/pxa-ªgs.h
>

20 
	~<asm/¨ch/maö°⁄e.h
>

22 
	~"Àds.h
"

26 
	#D28
 (1 << 0)

	)

27 
	#D27
 (1 << 1)

	)

28 
	#D26
 (1 << 2)

	)

29 
	#D25
 (1 << 3)

	)

30 
	#D24
 (1 << 4)

	)

31 
	#D23
 (1 << 5)

	)

32 
	#D22
 (1 << 6)

	)

33 
	#D21
 (1 << 7)

	)

35 
	#LED_STATE_ENABLED
 1

	)

36 
	#LED_STATE_CLAIMED
 2

	)

38 
	gÀd_°©e
;

39 
	ghw_Àd_°©e
;

41 
	$maö°⁄e_Àds_evít
(
Àd_evít_t
 
evt
)

43 
Êags
;

45 
	`loˇl_úq_ßve
(
Êags
);

47 
evt
) {

48 
Àd_°¨t
:

49 
hw_Àd_°©e
 = 0;

50 
Àd_°©e
 = 
LED_STATE_ENABLED
;

53 
Àd_°›
:

54 
Àd_°©e
 &~
LED_STATE_ENABLED
;

57 
Àd_˛aim
:

58 
Àd_°©e
 |
LED_STATE_CLAIMED
;

59 
hw_Àd_°©e
 = 0;

62 
Àd_ªÀa£
:

63 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

64 
hw_Àd_°©e
 = 0;

67 #ifde‡
CONFIG_LEDS_TIMER


68 
Àd_timî
:

69 
hw_Àd_°©e
 ^
D26
;

73 #ifde‡
CONFIG_LEDS_CPU


74 
Àd_idÀ_°¨t
:

75 
hw_Àd_°©e
 &~
D27
;

78 
Àd_idÀ_íd
:

79 
hw_Àd_°©e
 |
D27
;

83 
Àd_hÆãd
:

86 
Àd_gªí_⁄
:

87 
hw_Àd_°©e
 |
D21
;

90 
Àd_gªí_off
:

91 
hw_Àd_°©e
 &~
D21
;

94 
Àd_ambî_⁄
:

95 
hw_Àd_°©e
 |
D22
;

98 
Àd_ambî_off
:

99 
hw_Àd_°©e
 &~
D22
;

102 
Àd_ªd_⁄
:

103 
hw_Àd_°©e
 |
D23
;

106 
Àd_ªd_off
:

107 
hw_Àd_°©e
 &~
D23
;

114 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
)

115 
MST_LEDCTRL
 = (MST_LEDCTRL | 0xffË& ~
hw_Àd_°©e
;

117 
MST_LEDCTRL
 |= 0xff;

119 
	`loˇl_úq_ª°‹e
(
Êags
);

120 
	}
}

	@arch/arm/mach-pxa/leds-trizeps4.c

13 
	~<löux/öô.h
>

15 
	~<asm/h¨dw¨e.h
>

16 
	~<asm/sy°em.h
>

17 
	~<asm/ty≥s.h
>

18 
	~<asm/Àds.h
>

20 
	~<asm/¨ch/pxa-ªgs.h
>

21 
	~<asm/¨ch/åizïs4.h
>

23 
	~"Àds.h
"

25 
	#LED_STATE_ENABLED
 1

	)

26 
	#LED_STATE_CLAIMED
 2

	)

28 
	#SYS_BUSY
 0x01

	)

29 
	#HEARTBEAT
 0x02

	)

30 
	#BLINK
 0x04

	)

32 
	gÀd_°©e
;

33 
	ghw_Àd_°©e
;

35 
	$åizïs4_Àds_evít
(
Àd_evít_t
 
evt
)

37 
Êags
;

39 
	`loˇl_úq_ßve
(
Êags
);

41 
evt
) {

42 
Àd_°¨t
:

43 
hw_Àd_°©e
 = 0;

44 
	`pxa_gpio_mode
–
GPIO_SYS_BUSY_LED
 | 
GPIO_OUT
);

45 
	`pxa_gpio_mode
–
GPIO_HEARTBEAT_LED
 | 
GPIO_OUT
);

46 
Àd_°©e
 = 
LED_STATE_ENABLED
;

49 
Àd_°›
:

50 
Àd_°©e
 &~
LED_STATE_ENABLED
;

53 
Àd_˛aim
:

54 
Àd_°©e
 |
LED_STATE_CLAIMED
;

55 
hw_Àd_°©e
 = 0;

58 
Àd_ªÀa£
:

59 
Àd_°©e
 &~
LED_STATE_CLAIMED
;

60 
hw_Àd_°©e
 = 0;

63 #ifde‡
CONFIG_LEDS_TIMER


64 
Àd_timî
:

65 
hw_Àd_°©e
 ^
HEARTBEAT
;

69 #ifde‡
CONFIG_LEDS_CPU


70 
Àd_idÀ_°¨t
:

71 
hw_Àd_°©e
 &~
SYS_BUSY
;

74 
Àd_idÀ_íd
:

75 
hw_Àd_°©e
 |
SYS_BUSY
;

79 
Àd_hÆãd
:

82 
Àd_gªí_⁄
:

83 
hw_Àd_°©e
 |
BLINK
;

86 
Àd_gªí_off
:

87 
hw_Àd_°©e
 &~
BLINK
;

90 
Àd_ambî_⁄
:

93 
Àd_ambî_off
:

96 
Àd_ªd_⁄
:

99 
Àd_ªd_off
:

106 i‡(
Àd_°©e
 & 
LED_STATE_ENABLED
) {

107 
hw_Àd_°©e
) {

109 
	`GPSR
(
GPIO_SYS_BUSY_LED
Ë|
	`GPIO_bô
(GPIO_SYS_BUSY_LED);

110 
	`GPSR
(
GPIO_HEARTBEAT_LED
Ë|
	`GPIO_bô
(GPIO_HEARTBEAT_LED);

113 
	`GPCR
(
GPIO_SYS_BUSY_LED
Ë|
	`GPIO_bô
(GPIO_SYS_BUSY_LED);

114 
	`GPSR
(
GPIO_HEARTBEAT_LED
Ë|
	`GPIO_bô
(GPIO_HEARTBEAT_LED);

117 
	`GPSR
(
GPIO_SYS_BUSY_LED
Ë|
	`GPIO_bô
(GPIO_SYS_BUSY_LED);

118 
	`GPCR
(
GPIO_HEARTBEAT_LED
Ë|
	`GPIO_bô
(GPIO_HEARTBEAT_LED);

121 
	`GPCR
(
GPIO_SYS_BUSY_LED
Ë|
	`GPIO_bô
(GPIO_SYS_BUSY_LED);

122 
	`GPCR
(
GPIO_HEARTBEAT_LED
Ë|
	`GPIO_bô
(GPIO_HEARTBEAT_LED);

128 
	`GPSR
(
GPIO_SYS_BUSY_LED
Ë|
	`GPIO_bô
(GPIO_SYS_BUSY_LED);

129 
	`GPSR
(
GPIO_HEARTBEAT_LED
Ë|
	`GPIO_bô
(GPIO_HEARTBEAT_LED);

132 
	`loˇl_úq_ª°‹e
(
Êags
);

133 
	}
}

	@arch/arm/mach-pxa/leds.c

10 
	~<löux/compûî.h
>

11 
	~<löux/öô.h
>

13 
	~<asm/Àds.h
>

14 
	~<asm/mach-ty≥s.h
>

16 
	~"Àds.h
"

18 
__öô


19 
	$pxa_Àds_öô
()

21 i‡(
	`machöe_is_lubbock
())

22 
Àds_evít
 = 
lubbock_Àds_evít
;

23 i‡(
	`machöe_is_maö°⁄e
())

24 
Àds_evít
 = 
maö°⁄e_Àds_evít
;

25 i‡(
	`machöe_is_pxa_idp
())

26 
Àds_evít
 = 
idp_Àds_evít
;

27 i‡(
	`machöe_is_åizïs4
())

28 
Àds_evít
 = 
åizïs4_Àds_evít
;

30 
	`Àds_evít
(
Àd_°¨t
);

32 
	}
}

34 
c‹e_öôˇŒ
(
pxa_Àds_öô
);

	@arch/arm/mach-pxa/leds.h

10 
idp_Àds_evít
(
Àd_evít_t
 
evt
);

11 
lubbock_Àds_evít
(
Àd_evít_t
 
evt
);

12 
maö°⁄e_Àds_evít
(
Àd_evít_t
 
evt
);

13 
åizïs4_Àds_evít
(
Àd_evít_t
 
evt
);

	@arch/arm/mach-pxa/lpd270.c

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/sysdev.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/bô›s.h
>

22 
	~<löux/fb.h
>

23 
	~<löux/i›‹t.h
>

24 
	~<löux/mtd/mtd.h
>

25 
	~<löux/mtd/∑πôi⁄s.h
>

27 
	~<asm/ty≥s.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mem‹y.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/sizes.h
>

35 
	~<asm/mach/¨ch.h
>

36 
	~<asm/mach/m≠.h
>

37 
	~<asm/mach/úq.h
>

38 
	~<asm/mach/Êash.h
>

40 
	~<asm/¨ch/pxa-ªgs.h
>

41 
	~<asm/¨ch/Õd270.h
>

42 
	~<asm/¨ch/audio.h
>

43 
	~<asm/¨ch/pxafb.h
>

44 
	~<asm/¨ch/mmc.h
>

45 
	~<asm/¨ch/úda.h
>

46 
	~<asm/¨ch/ohci.h
>

48 
	~"gíîic.h
"

51 
	gÕd270_úq_íabÀd
;

53 
	$Õd270_mask_úq
(
úq
)

55 
Õd270_úq
 = 
úq
 - 
	`LPD270_IRQ
(0);

57 
	`__øw_wrôew
(~(1 << 
Õd270_úq
), 
LPD270_INT_STATUS
);

59 
Õd270_úq_íabÀd
 &~(1 << 
Õd270_úq
);

60 
	`__øw_wrôew
(
Õd270_úq_íabÀd
, 
LPD270_INT_MASK
);

61 
	}
}

63 
	$Õd270_unmask_úq
(
úq
)

65 
Õd270_úq
 = 
úq
 - 
	`LPD270_IRQ
(0);

67 
Õd270_úq_íabÀd
 |1 << 
Õd270_úq
;

68 
	`__øw_wrôew
(
Õd270_úq_íabÀd
, 
LPD270_INT_MASK
);

69 
	}
}

71 
úq_chù
 
	gÕd270_úq_chù
 = {

72 .
«me
 = "CPLD",

73 .
	gack
 = 
Õd270_mask_úq
,

74 .
	gmask
 = 
Õd270_mask_úq
,

75 .
	gunmask
 = 
Õd270_unmask_úq
,

78 
	$Õd270_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

80 
≥ndög
;

82 
≥ndög
 = 
	`__øw_ªadw
(
LPD270_INT_STATUS
Ë& 
Õd270_úq_íabÀd
;

84 
	`GEDR
(0Ë
	`GPIO_bô
(0);

85 i‡(
	`likñy
(
≥ndög
)) {

86 
úq
 = 
	`LPD270_IRQ
(0Ë+ 
	`__ffs
(
≥ndög
);

87 
desc
 = 
úq_desc
 + 
úq
;

88 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

90 
≥ndög
 = 
	`__øw_ªadw
(
LPD270_INT_STATUS
) &

91 
Õd270_úq_íabÀd
;

93 } 
≥ndög
);

94 
	}
}

96 
__öô
 
	$Õd270_öô_úq
()

98 
úq
;

100 
	`pxa_öô_úq
();

102 
	`__øw_wrôew
(0, 
LPD270_INT_MASK
);

103 
	`__øw_wrôew
(0, 
LPD270_INT_STATUS
);

106 
úq
 = 
	`LPD270_IRQ
(2); irq <= LPD270_IRQ(4); irq++) {

107 
	`£t_úq_chù
(
úq
, &
Õd270_úq_chù
);

108 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

109 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

111 
	`£t_úq_chaöed_h™dÀr
(
	`IRQ_GPIO
(0), 
Õd270_úq_h™dÀr
);

112 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(0), 
IRQT_FALLING
);

113 
	}
}

116 #ifde‡
CONFIG_PM


117 
	$Õd270_úq_ªsume
(
sys_devi˚
 *
dev
)

119 
	`__øw_wrôew
(
Õd270_úq_íabÀd
, 
LPD270_INT_MASK
);

121 
	}
}

123 
sysdev_˛ass
 
	gÕd270_úq_sys˛ass
 = {

124 
£t_k£t_«me
("cpld_irq"),

125 .
ªsume
 = 
Õd270_úq_ªsume
,

128 
sys_devi˚
 
	gÕd270_úq_devi˚
 = {

129 .
˛s
 = &
Õd270_úq_sys˛ass
,

132 
__öô
 
	$Õd270_úq_devi˚_öô
()

134 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
Õd270_úq_sys˛ass
);

135 i‡(
ªt
 == 0)

136 
ªt
 = 
	`sysdev_ªgi°î
(&
Õd270_úq_devi˚
);

137  
ªt
;

138 
	}
}

140 
devi˚_öôˇŒ
(
Õd270_úq_devi˚_öô
);

144 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

146 .
°¨t
 = 
LPD270_ETH_PHYS
,

147 .
	gíd
 = (
LPD270_ETH_PHYS
 + 0xfffff),

148 .
	gÊags
 = 
IORESOURCE_MEM
,

151 .
°¨t
 = 
LPD270_ETHERNET_IRQ
,

152 .
	gíd
 = 
LPD270_ETHERNET_IRQ
,

153 .
	gÊags
 = 
IORESOURCE_IRQ
,

157 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

158 .
«me
 = "smc91x",

159 .
	gid
 = 0,

160 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

161 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

164 
∂©f‹m_devi˚
 
	gÕd270_audio_devi˚
 = {

165 .
«me
 = "pxa2xx-ac97",

166 .
	gid
 = -1,

169 
ªsour˚
 
	gÕd270_Êash_ªsour˚s
[] = {

171 .
°¨t
 = 
PXA_CS0_PHYS
,

172 .
	gíd
 = 
PXA_CS0_PHYS
 + 
SZ_64M
 - 1,

173 .
	gÊags
 = 
IORESOURCE_MEM
,

176 .
°¨t
 = 
PXA_CS1_PHYS
,

177 .
	gíd
 = 
PXA_CS1_PHYS
 + 
SZ_64M
 - 1,

178 .
	gÊags
 = 
IORESOURCE_MEM
,

182 
mtd_∑πôi⁄
 
	gÕd270_Êash0_∑πôi⁄s
[] = {

184 .
«me
 = "Bootloader",

185 .
	gsize
 = 0x00040000,

186 .
	goff£t
 = 0,

187 .
	gmask_Êags
 = 
MTD_WRITEABLE


189 .
	g«me
 = "Kernel",

190 .
	gsize
 = 0x00400000,

191 .
	goff£t
 = 0x00040000,

193 .
	g«me
 = "Filesystem",

194 .
	gsize
 = 
MTDPART_SIZ_FULL
,

195 .
	goff£t
 = 0x00440000

199 
Êash_∂©f‹m_d©a
 
	gÕd270_Êash_d©a
[2] = {

201 .
«me
 = "processor-flash",

202 .
	gm≠_«me
 = "cfi_probe",

203 .
	g∑πs
 = 
Õd270_Êash0_∑πôi⁄s
,

204 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
Õd270_Êash0_∑πôi⁄s
),

206 .
	g«me
 = "mainboard-flash",

207 .
	gm≠_«me
 = "cfi_probe",

208 .
	g∑πs
 = 
NULL
,

209 .
	gƒ_∑πs
 = 0,

213 
∂©f‹m_devi˚
 
	gÕd270_Êash_devi˚
[2] = {

215 .
«me
 = "pxa2xx-flash",

216 .
	gid
 = 0,

217 .
	gdev
 = {

218 .
∂©f‹m_d©a
 = &
Õd270_Êash_d©a
[0],

220 .
	gªsour˚
 = &
Õd270_Êash_ªsour˚s
[0],

221 .
	gnum_ªsour˚s
 = 1,

223 .
	g«me
 = "pxa2xx-flash",

224 .
	gid
 = 1,

225 .
	gdev
 = {

226 .
∂©f‹m_d©a
 = &
Õd270_Êash_d©a
[1],

228 .
	gªsour˚
 = &
Õd270_Êash_ªsour˚s
[1],

229 .
	gnum_ªsour˚s
 = 1,

233 
	$Õd270_backlight_powî
(
⁄
)

235 i‡(
⁄
) {

236 
	`pxa_gpio_mode
(
GPIO16_PWM0_MD
);

237 
	`pxa_£t_ckí
(
CKEN_PWM0
, 1);

238 
PWM_CTRL0
 = 0;

239 
PWM_PWDUTY0
 = 0x3ff;

240 
PWM_PERVAL0
 = 0x3ff;

242 
PWM_CTRL0
 = 0;

243 
PWM_PWDUTY0
 = 0x0;

244 
PWM_PERVAL0
 = 0x3FF;

245 
	`pxa_£t_ckí
(
CKEN_PWM0
, 0);

247 
	}
}

250 
pxafb_mode_öfo
 
	gsh¨p_lq057q3dc02_mode
 = {

251 .
pix˛ock
 = 150000,

252 .
	gxªs
 = 320,

253 .
	gyªs
 = 240,

254 .
	gbµ
 = 16,

255 .
	ghsync_Àn
 = 0x14,

256 .
	gÀ·_m¨gö
 = 0x28,

257 .
	gright_m¨gö
 = 0x0a,

258 .
	gvsync_Àn
 = 0x02,

259 .
	guµî_m¨gö
 = 0x08,

260 .
	glowî_m¨gö
 = 0x14,

261 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

264 
pxafb_mach_öfo
 
	gsh¨p_lq057q3dc02
 = {

265 .
modes
 = &
sh¨p_lq057q3dc02_mode
,

266 .
	gnum_modes
 = 1,

267 .
	glc¸0
 = 0x07800080,

268 .
	glc¸3
 = 0x00400000,

269 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

273 
pxafb_mode_öfo
 
	gsh¨p_lq121s1dg31_mode
 = {

274 .
pix˛ock
 = 50000,

275 .
	gxªs
 = 800,

276 .
	gyªs
 = 600,

277 .
	gbµ
 = 16,

278 .
	ghsync_Àn
 = 0x05,

279 .
	gÀ·_m¨gö
 = 0x52,

280 .
	gright_m¨gö
 = 0x05,

281 .
	gvsync_Àn
 = 0x04,

282 .
	guµî_m¨gö
 = 0x14,

283 .
	glowî_m¨gö
 = 0x0a,

284 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

287 
pxafb_mach_öfo
 
	gsh¨p_lq121s1dg31
 = {

288 .
modes
 = &
sh¨p_lq121s1dg31_mode
,

289 .
	gnum_modes
 = 1,

290 .
	glc¸0
 = 0x07800080,

291 .
	glc¸3
 = 0x00400000,

292 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

296 
pxafb_mode_öfo
 
	gsh¨p_lq036q1da01_mode
 = {

297 .
pix˛ock
 = 150000,

298 .
	gxªs
 = 320,

299 .
	gyªs
 = 240,

300 .
	gbµ
 = 16,

301 .
	ghsync_Àn
 = 0x0e,

302 .
	gÀ·_m¨gö
 = 0x04,

303 .
	gright_m¨gö
 = 0x0a,

304 .
	gvsync_Àn
 = 0x03,

305 .
	guµî_m¨gö
 = 0x03,

306 .
	glowî_m¨gö
 = 0x03,

307 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

310 
pxafb_mach_öfo
 
	gsh¨p_lq036q1da01
 = {

311 .
modes
 = &
sh¨p_lq036q1da01_mode
,

312 .
	gnum_modes
 = 1,

313 .
	glc¸0
 = 0x07800080,

314 .
	glc¸3
 = 0x00400000,

315 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

319 
pxafb_mode_öfo
 
	gsh¨p_lq64d343_mode
 = {

320 .
pix˛ock
 = 25000,

321 .
	gxªs
 = 640,

322 .
	gyªs
 = 480,

323 .
	gbµ
 = 16,

324 .
	ghsync_Àn
 = 0x31,

325 .
	gÀ·_m¨gö
 = 0x89,

326 .
	gright_m¨gö
 = 0x19,

327 .
	gvsync_Àn
 = 0x12,

328 .
	guµî_m¨gö
 = 0x22,

329 .
	glowî_m¨gö
 = 0x00,

330 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

333 
pxafb_mach_öfo
 
	gsh¨p_lq64d343
 = {

334 .
modes
 = &
sh¨p_lq64d343_mode
,

335 .
	gnum_modes
 = 1,

336 .
	glc¸0
 = 0x07800080,

337 .
	glc¸3
 = 0x00400000,

338 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

342 
pxafb_mode_öfo
 
	gsh¨p_lq10d368_mode
 = {

343 .
pix˛ock
 = 25000,

344 .
	gxªs
 = 640,

345 .
	gyªs
 = 480,

346 .
	gbµ
 = 16,

347 .
	ghsync_Àn
 = 0x31,

348 .
	gÀ·_m¨gö
 = 0x89,

349 .
	gright_m¨gö
 = 0x19,

350 .
	gvsync_Àn
 = 0x12,

351 .
	guµî_m¨gö
 = 0x22,

352 .
	glowî_m¨gö
 = 0x00,

353 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

356 
pxafb_mach_öfo
 
	gsh¨p_lq10d368
 = {

357 .
modes
 = &
sh¨p_lq10d368_mode
,

358 .
	gnum_modes
 = 1,

359 .
	glc¸0
 = 0x07800080,

360 .
	glc¸3
 = 0x00400000,

361 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

365 
pxafb_mode_öfo
 
	gsh¨p_lq035q7db02_20_mode
 = {

366 .
pix˛ock
 = 150000,

367 .
	gxªs
 = 240,

368 .
	gyªs
 = 320,

369 .
	gbµ
 = 16,

370 .
	ghsync_Àn
 = 0x0e,

371 .
	gÀ·_m¨gö
 = 0x0a,

372 .
	gright_m¨gö
 = 0x0a,

373 .
	gvsync_Àn
 = 0x03,

374 .
	guµî_m¨gö
 = 0x05,

375 .
	glowî_m¨gö
 = 0x14,

376 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

379 
pxafb_mach_öfo
 
	gsh¨p_lq035q7db02_20
 = {

380 .
modes
 = &
sh¨p_lq035q7db02_20_mode
,

381 .
	gnum_modes
 = 1,

382 .
	glc¸0
 = 0x07800080,

383 .
	glc¸3
 = 0x00400000,

384 .
	gpxafb_backlight_powî
 = 
Õd270_backlight_powî
,

387 
pxafb_mach_öfo
 *
	gÕd270_lcd_to_u£
;

389 
__öô
 
	$Õd270_£t_lcd
(*
°r
)

391 i‡(!
	`°∫icmp
(
°r
, "lq057q3dc02", 11)) {

392 
Õd270_lcd_to_u£
 = &
sh¨p_lq057q3dc02
;

393 } i‡(!
	`°∫icmp
(
°r
, "lq121s1dg31", 11)) {

394 
Õd270_lcd_to_u£
 = &
sh¨p_lq121s1dg31
;

395 } i‡(!
	`°∫icmp
(
°r
, "lq036q1da01", 11)) {

396 
Õd270_lcd_to_u£
 = &
sh¨p_lq036q1da01
;

397 } i‡(!
	`°∫icmp
(
°r
, "lq64d343", 8)) {

398 
Õd270_lcd_to_u£
 = &
sh¨p_lq64d343
;

399 } i‡(!
	`°∫icmp
(
°r
, "lq10d368", 8)) {

400 
Õd270_lcd_to_u£
 = &
sh¨p_lq10d368
;

401 } i‡(!
	`°∫icmp
(
°r
, "lq035q7db02-20", 14)) {

402 
Õd270_lcd_to_u£
 = &
sh¨p_lq035q7db02_20
;

404 
	`¥ötk
(
KERN_INFO
 "Õd270: unknow¿lcdÖ™ñ [%s]\n", 
°r
);

408 
	}
}

410 
__£tup
("lcd=", 
Õd270_£t_lcd
);

412 
∂©f‹m_devi˚
 *
	g∂©f‹m_devi˚s
[] 
	g__öôd©a
 = {

413 &
smc91x_devi˚
,

414 &
Õd270_audio_devi˚
,

415 &
Õd270_Êash_devi˚
[0],

416 &
Õd270_Êash_devi˚
[1],

419 
	$Õd270_ohci_öô
(
devi˚
 *
dev
)

422 
	`pxa_gpio_mode
(88 | 
GPIO_ALT_FN_1_IN
);

423 
	`pxa_gpio_mode
(89 | 
GPIO_ALT_FN_2_OUT
);

427 
UHCHR
 = (UHCHR | 
UHCHR_PCPL
 | 
UHCHR_PSPL
) &

428 ~(
UHCHR_SSEP1
 | 
UHCHR_SSEP2
 | 
UHCHR_SSEP3
 | 
UHCHR_SSE
);

431 
	}
}

433 
pxaohci_∂©f‹m_d©a
 
	gÕd270_ohci_∂©f‹m_d©a
 = {

434 .
p‹t_mode
 = 
PMM_PERPORT_MODE
,

435 .
	göô
 = 
Õd270_ohci_öô
,

438 
__öô
 
	$Õd270_öô
()

440 
Õd270_Êash_d©a
[0].
width
 = (
BOOT_DEF
 & 1) ? 2 : 4;

441 
Õd270_Êash_d©a
[1].
width
 = 4;

448 
ARB_CNTRL
 = 
ARB_CORE_PARK
 | 0x234;

453 
	`pxa_gpio_mode
(
GPIO45_SYSCLK_AC97_MD
);

455 
	`∂©f‹m_add_devi˚s
(
∂©f‹m_devi˚s
, 
	`ARRAY_SIZE
(platform_devices));

457 i‡(
Õd270_lcd_to_u£
 !
NULL
)

458 
	`£t_pxa_fb_öfo
(
Õd270_lcd_to_u£
);

460 
	`pxa_£t_ohci_öfo
(&
Õd270_ohci_∂©f‹m_d©a
);

461 
	}
}

464 
m≠_desc
 
	gÕd270_io_desc
[] 
	g__öôd©a
 = {

466 .
vútuÆ
 = 
LPD270_CPLD_VIRT
,

467 .
	gp‚
 = 
__phys_to_p‚
(
LPD270_CPLD_PHYS
),

468 .
	gÀngth
 = 
LPD270_CPLD_SIZE
,

469 .
	gty≥
 = 
MT_DEVICE
,

473 
__öô
 
	$Õd270_m≠_io
()

475 
	`pxa_m≠_io
();

476 
	`iŸabÀ_öô
(
Õd270_io_desc
, 
	`ARRAY_SIZE
(lpd270_io_desc));

479 
PGSR0
 = 0x00008800;

480 
PGSR1
 = 0x00000002;

481 
PGSR2
 = 0x0001FC00;

482 
PGSR3
 = 0x00001F81;

483 
PWER
 = 0xC0000002;

484 
PRER
 = 0x00000002;

485 
PFER
 = 0x00000002;

488 
PSLR
 |= 0x00000F04;

489 
PCFR
 = 0x00000066;

490 
	}
}

492 
MACHINE_START
(
LOGICPD_PXA270
, "LogicPD PXA270 Card Engine")

494 .
	gphys_io
 = 0x40000000,

495 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

496 .
	gboŸ_∑øms
 = 0xa0000100,

497 .
	gm≠_io
 = 
Õd270_m≠_io
,

498 .
	göô_úq
 = 
Õd270_öô_úq
,

499 .
	gtimî
 = &
pxa_timî
,

500 .
	göô_machöe
 = 
Õd270_öô
,

501 
	gMACHINE_END


	@arch/arm/mach-pxa/lubbock.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/sysdev.h
>

19 
	~<löux/maj‹.h
>

20 
	~<löux/fb.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/mtd/mtd.h
>

23 
	~<löux/mtd/∑πôi⁄s.h
>

25 
	~<löux/•i/•i.h
>

26 
	~<löux/•i/ads7846.h
>

27 
	~<asm/¨ch/pxa2xx_•i.h
>

29 
	~<asm/£tup.h
>

30 
	~<asm/mem‹y.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/h¨dw¨e.h
>

33 
	~<asm/úq.h
>

34 
	~<asm/sizes.h
>

36 
	~<asm/mach/¨ch.h
>

37 
	~<asm/mach/m≠.h
>

38 
	~<asm/mach/úq.h
>

39 
	~<asm/mach/Êash.h
>

41 
	~<asm/h¨dw¨e/ß1111.h
>

43 
	~<asm/¨ch/pxa-ªgs.h
>

44 
	~<asm/¨ch/lubbock.h
>

45 
	~<asm/¨ch/udc.h
>

46 
	~<asm/¨ch/úda.h
>

47 
	~<asm/¨ch/pxafb.h
>

48 
	~<asm/¨ch/mmc.h
>

50 
	~"gíîic.h
"

53 
	#LUB_MISC_WR
 
	`__LUB_REG
(
LUBBOCK_FPGA_PHYS
 + 0x080)

	)

55 
	$lubbock_£t_misc_wr
(
mask
, 
£t
)

57 
Êags
;

59 
	`loˇl_úq_ßve
(
Êags
);

60 
LUB_MISC_WR
 = (LUB_MISC_WR & ~
mask
Ë| (
£t
 & mask);

61 
	`loˇl_úq_ª°‹e
(
Êags
);

62 
	}
}

63 
EXPORT_SYMBOL
(
lubbock_£t_misc_wr
);

65 
	glubbock_úq_íabÀd
;

67 
	$lubbock_mask_úq
(
úq
)

69 
lubbock_úq
 = (
úq
 - 
	`LUBBOCK_IRQ
(0));

70 
LUB_IRQ_MASK_EN
 = (
lubbock_úq_íabÀd
 &~(1 << 
lubbock_úq
));

71 
	}
}

73 
	$lubbock_unmask_úq
(
úq
)

75 
lubbock_úq
 = (
úq
 - 
	`LUBBOCK_IRQ
(0));

77 
LUB_IRQ_SET_CLR
 &~(1 << 
lubbock_úq
);

78 
LUB_IRQ_MASK_EN
 = (
lubbock_úq_íabÀd
 |(1 << 
lubbock_úq
));

79 
	}
}

81 
úq_chù
 
	glubbock_úq_chù
 = {

82 .
«me
 = "FPGA",

83 .
	gack
 = 
lubbock_mask_úq
,

84 .
	gmask
 = 
lubbock_mask_úq
,

85 .
	gunmask
 = 
lubbock_unmask_úq
,

88 
	$lubbock_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

90 
≥ndög
 = 
LUB_IRQ_SET_CLR
 & 
lubbock_úq_íabÀd
;

92 
	`GEDR
(0Ë
	`GPIO_bô
(0);

93 i‡(
	`likñy
(
≥ndög
)) {

94 
úq
 = 
	`LUBBOCK_IRQ
(0Ë+ 
	`__ffs
(
≥ndög
);

95 
desc
 = 
úq_desc
 + 
úq
;

96 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

98 
≥ndög
 = 
LUB_IRQ_SET_CLR
 & 
lubbock_úq_íabÀd
;

99 } 
≥ndög
);

100 
	}
}

102 
__öô
 
	$lubbock_öô_úq
()

104 
úq
;

106 
	`pxa_öô_úq
();

109 
úq
 = 
	`LUBBOCK_IRQ
(0); irq <
LUBBOCK_LAST_IRQ
; irq++) {

110 
	`£t_úq_chù
(
úq
, &
lubbock_úq_chù
);

111 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

112 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

115 
	`£t_úq_chaöed_h™dÀr
(
	`IRQ_GPIO
(0), 
lubbock_úq_h™dÀr
);

116 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(0), 
IRQT_FALLING
);

117 
	}
}

119 #ifde‡
CONFIG_PM


121 
	$lubbock_úq_ªsume
(
sys_devi˚
 *
dev
)

123 
LUB_IRQ_MASK_EN
 = 
lubbock_úq_íabÀd
;

125 
	}
}

127 
sysdev_˛ass
 
	glubbock_úq_sys˛ass
 = {

128 
£t_k£t_«me
("cpld_irq"),

129 .
ªsume
 = 
lubbock_úq_ªsume
,

132 
sys_devi˚
 
	glubbock_úq_devi˚
 = {

133 .
˛s
 = &
lubbock_úq_sys˛ass
,

136 
__öô
 
	$lubbock_úq_devi˚_öô
()

138 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
lubbock_úq_sys˛ass
);

139 i‡(
ªt
 == 0)

140 
ªt
 = 
	`sysdev_ªgi°î
(&
lubbock_úq_devi˚
);

141  
ªt
;

142 
	}
}

144 
devi˚_öôˇŒ
(
lubbock_úq_devi˚_öô
);

148 
	$lubbock_udc_is_c⁄√˘ed
()

150  (
LUB_MISC_RD
 & (1 << 9)) == 0;

151 
	}
}

153 
pxa2xx_udc_mach_öfo
 
udc_öfo
 
	g__öôd©a
 = {

154 .
udc_is_c⁄√˘ed
 = 
lubbock_udc_is_c⁄√˘ed
,

158 
∂©f‹m_devi˚
 
	glub_audio_devi˚
 = {

159 .
«me
 = "pxa2xx-ac97",

160 .
	gid
 = -1,

163 
ªsour˚
 
	gß1111_ªsour˚s
[] = {

165 .
°¨t
 = 0x10000000,

166 .
	gíd
 = 0x10001fff,

167 .
	gÊags
 = 
IORESOURCE_MEM
,

170 .
°¨t
 = 
LUBBOCK_SA1111_IRQ
,

171 .
	gíd
 = 
LUBBOCK_SA1111_IRQ
,

172 .
	gÊags
 = 
IORESOURCE_IRQ
,

176 
∂©f‹m_devi˚
 
	gß1111_devi˚
 = {

177 .
«me
 = "sa1111",

178 .
	gid
 = -1,

179 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ß1111_ªsour˚s
),

180 .
	gªsour˚
 = 
ß1111_ªsour˚s
,

183 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

185 .
«me
 = "smc91x-regs",

186 .
	g°¨t
 = 0x0c000c00,

187 .
	gíd
 = 0x0c0fffff,

188 .
	gÊags
 = 
IORESOURCE_MEM
,

191 .
°¨t
 = 
LUBBOCK_ETH_IRQ
,

192 .
	gíd
 = 
LUBBOCK_ETH_IRQ
,

193 .
	gÊags
 = 
IORESOURCE_IRQ
,

196 .
«me
 = "smc91x-attrib",

197 .
	g°¨t
 = 0x0e000000,

198 .
	gíd
 = 0x0e0fffff,

199 .
	gÊags
 = 
IORESOURCE_MEM
,

208 
ªsour˚
 
	gpxa_s•_ªsour˚s
[] = {

210 .
°¨t
 = 
__PREG
(
SSCR0_P
(1)),

211 .
	gíd
 = 
__PREG
(
SSCR0_P
(1)) + 0x14,

212 .
	gÊags
 = 
IORESOURCE_MEM
,

215 .
°¨t
 = 
IRQ_SSP
,

216 .
	gíd
 = 
IRQ_SSP
,

217 .
	gÊags
 = 
IORESOURCE_IRQ
,

221 
pxa2xx_•i_ma°î
 
	gpxa_s•_ma°î_öfo
 = {

222 .
s•_ty≥
 = 
PXA25x_SSP
,

223 .
	g˛ock_íabÀ
 = 
CKEN_SSP
,

224 .
	gnum_chù£À˘
 = 0,

227 
∂©f‹m_devi˚
 
	gpxa_s•
 = {

228 .
«me
 = "pxa2xx-spi",

229 .
	gid
 = 1,

230 .
	gªsour˚
 = 
pxa_s•_ªsour˚s
,

231 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
pxa_s•_ªsour˚s
),

232 .
	gdev
 = {

233 .
∂©f‹m_d©a
 = &
pxa_s•_ma°î_öfo
,

237 
	$lubbock_ads7846_≥ndown_°©e
()

241 
	}
}

243 
ads7846_∂©f‹m_d©a
 
	gads_öfo
 = {

244 .
modñ
 = 7846,

245 .
	gvªf_dñay_u£cs
 = 100,

246 .
	ggë_≥ndown_°©e
 = 
lubbock_ads7846_≥ndown_°©e
,

251 
	$ads7846_cs
(
u32
 
comm™d
)

253 c⁄° 
TS_nCS
 = 1 << 11;

254 
	`lubbock_£t_misc_wr
(
TS_nCS
, (
comm™d
 =
PXA2XX_CS_ASSERT
) ? 0 : TS_nCS);

255 
	}
}

257 
pxa2xx_•i_chù
 
	gads_hw
 = {

258 .
tx_thªshﬁd
 = 1,

259 .
	grx_thªshﬁd
 = 2,

260 .
	gcs_c⁄åﬁ
 = 
ads7846_cs
,

263 
•i_bﬂrd_öfo
 
	g•i_bﬂrd_öfo
[] 
	g__öôd©a
 = { {

264 .
modÆüs
 = "ads7846",

265 .
	g∂©f‹m_d©a
 = &
ads_öfo
,

266 .
	gc⁄åﬁÀr_d©a
 = &
ads_hw
,

267 .
	gúq
 = 
LUBBOCK_BB_IRQ
,

268 .
	gmax_•ìd_hz
 = 120000

270 .
	gbus_num
 = 1,

271 .
	gchù_£À˘
 = 0,

275 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

276 .
«me
 = "smc91x",

277 .
	gid
 = -1,

278 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

279 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

282 
ªsour˚
 
	gÊash_ªsour˚s
[] = {

284 .
°¨t
 = 0x00000000,

285 .
	gíd
 = 
SZ_64M
 - 1,

286 .
	gÊags
 = 
IORESOURCE_MEM
,

289 .
°¨t
 = 0x04000000,

290 .
	gíd
 = 0x04000000 + 
SZ_64M
 - 1,

291 .
	gÊags
 = 
IORESOURCE_MEM
,

295 
mtd_∑πôi⁄
 
	glubbock_∑πôi⁄s
[] = {

297 .
«me
 = "Bootloader",

298 .
	gsize
 = 0x00040000,

299 .
	goff£t
 = 0,

300 .
	gmask_Êags
 = 
MTD_WRITEABLE


302 .
	g«me
 = "Kernel",

303 .
	gsize
 = 0x00100000,

304 .
	goff£t
 = 0x00040000,

306 .
	g«me
 = "Filesystem",

307 .
	gsize
 = 
MTDPART_SIZ_FULL
,

308 .
	goff£t
 = 0x00140000

312 
Êash_∂©f‹m_d©a
 
	glubbock_Êash_d©a
[2] = {

314 .
m≠_«me
 = "cfi_probe",

315 .
	g∑πs
 = 
lubbock_∑πôi⁄s
,

316 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
lubbock_∑πôi⁄s
),

318 .
	gm≠_«me
 = "cfi_probe",

319 .
	g∑πs
 = 
NULL
,

320 .
	gƒ_∑πs
 = 0,

324 
∂©f‹m_devi˚
 
	glubbock_Êash_devi˚
[2] = {

326 .
«me
 = "pxa2xx-flash",

327 .
	gid
 = 0,

328 .
	gdev
 = {

329 .
∂©f‹m_d©a
 = &
lubbock_Êash_d©a
[0],

331 .
	gªsour˚
 = &
Êash_ªsour˚s
[0],

332 .
	gnum_ªsour˚s
 = 1,

335 .
	g«me
 = "pxa2xx-flash",

336 .
	gid
 = 1,

337 .
	gdev
 = {

338 .
∂©f‹m_d©a
 = &
lubbock_Êash_d©a
[1],

340 .
	gªsour˚
 = &
Êash_ªsour˚s
[1],

341 .
	gnum_ªsour˚s
 = 1,

345 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

346 &
ß1111_devi˚
,

347 &
lub_audio_devi˚
,

348 &
smc91x_devi˚
,

349 &
lubbock_Êash_devi˚
[0],

350 &
lubbock_Êash_devi˚
[1],

351 &
pxa_s•
,

354 
pxafb_mode_öfo
 
	gsh¨p_lm8v31_mode
 = {

355 .
pix˛ock
 = 270000,

356 .
	gxªs
 = 640,

357 .
	gyªs
 = 480,

358 .
	gbµ
 = 16,

359 .
	ghsync_Àn
 = 1,

360 .
	gÀ·_m¨gö
 = 3,

361 .
	gright_m¨gö
 = 3,

362 .
	gvsync_Àn
 = 1,

363 .
	guµî_m¨gö
 = 0,

364 .
	glowî_m¨gö
 = 0,

365 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

366 .
	gcm≠_gªysˇÀ
 = 0,

369 
pxafb_mach_öfo
 
	gsh¨p_lm8v31
 = {

370 .
modes
 = &
sh¨p_lm8v31_mode
,

371 .
	gnum_modes
 = 1,

372 .
	gcm≠_övî£
 = 0,

373 .
	gcm≠_°©ic
 = 0,

374 .
	glc¸0
 = 
LCCR0_SDS
,

375 .
	glc¸3
 = 
LCCR3_PCP
 | 
LCCR3_Acb
(255),

378 
	#MMC_POLL_RATE
 
	`m£cs_to_jiffõs
(1000)

	)

380 
lubbock_mmc_pﬁl
();

381 
úq_h™dÀr_t
 
	gmmc_dëe˘_öt
;

383 
timî_li°
 
	gmmc_timî
 = {

384 .
fun˘i⁄
 = 
lubbock_mmc_pﬁl
,

387 
	$lubbock_mmc_pﬁl
(
d©a
)

389 
Êags
;

392 
	`loˇl_úq_ßve
(
Êags
);

393 
LUB_IRQ_SET_CLR
 &= ~(1 << 0);

394 
	`loˇl_úq_ª°‹e
(
Êags
);

397 i‡(
LUB_IRQ_SET_CLR
 & (1 << 0))

398 
	`mod_timî
(&
mmc_timî
, 
jiffõs
 + 
MMC_POLL_RATE
);

400 (Ë
	`mmc_dëe˘_öt
(
LUBBOCK_SD_IRQ
, (*)
d©a
);

401 
	`íabÀ_úq
(
LUBBOCK_SD_IRQ
);

403 
	}
}

405 
úqªtu∫_t
 
	$lubbock_dëe˘_öt
(
úq
, *
d©a
)

408 
	`dißbÀ_úq
(
úq
);

409 
	`mod_timî
(&
mmc_timî
, 
jiffõs
 + 
MMC_POLL_RATE
);

411  
	`mmc_dëe˘_öt
(
úq
, 
d©a
);

412 
	}
}

414 
	$lubbock_mci_öô
(
devi˚
 *
dev
,

415 
úq_h™dÀr_t
 
dëe˘_öt
,

416 *
d©a
)

419 
	`pxa_gpio_mode
(
GPIO6_MMCCLK_MD
);

420 
	`pxa_gpio_mode
(
GPIO8_MMCCS0_MD
);

423 
mmc_dëe˘_öt
 = 
dëe˘_öt
;

424 
	`öô_timî
(&
mmc_timî
);

425 
mmc_timî
.
d©a
 = () data;

426  
	`ªque°_úq
(
LUBBOCK_SD_IRQ
, 
lubbock_dëe˘_öt
,

427 
IRQF_SAMPLE_RANDOM
, "lubbock-sd-dëe˘", 
d©a
);

428 
	}
}

430 
	$lubbock_mci_gë_ro
(
devi˚
 *
dev
)

432  (
LUB_MISC_RD
 & (1 << 2)) != 0;

433 
	}
}

435 
	$lubbock_mci_exô
(
devi˚
 *
dev
, *
d©a
)

437 
	`‰ì_úq
(
LUBBOCK_SD_IRQ
, 
d©a
);

438 
	`dñ_timî_sync
(&
mmc_timî
);

439 
	}
}

441 
pxamci_∂©f‹m_d©a
 
	glubbock_mci_∂©f‹m_d©a
 = {

442 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

443 .
	gdëe˘_dñay
 = 1,

444 .
	göô
 = 
lubbock_mci_öô
,

445 .
	ggë_ro
 = 
lubbock_mci_gë_ro
,

446 .
	gexô
 = 
lubbock_mci_exô
,

449 
	$lubbock_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

451 
Êags
;

453 
	`loˇl_úq_ßve
(
Êags
);

454 i‡(
mode
 & 
IR_SIRMODE
) {

455 
LUB_MISC_WR
 &= ~(1 << 4);

456 } i‡(
mode
 & 
IR_FIRMODE
) {

457 
LUB_MISC_WR
 |= 1 << 4;

459 
	`loˇl_úq_ª°‹e
(
Êags
);

460 
	}
}

462 
pxafi˝_∂©f‹m_d©a
 
	glubbock_fi˝_∂©f‹m_d©a
 = {

463 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_FIRMODE
,

464 .
	gå™s˚ivî_mode
 = 
lubbock_úda_å™s˚ivî_mode
,

467 
__öô
 
	$lubbock_öô
()

469 
ÊashboŸ
 = (
LUB_CONF_SWITCHES
 & 1);

471 
	`pxa_£t_udc_öfo
(&
udc_öfo
);

472 
	`£t_pxa_fb_öfo
(&
sh¨p_lm8v31
);

473 
	`pxa_£t_mci_öfo
(&
lubbock_mci_∂©f‹m_d©a
);

474 
	`pxa_£t_fi˝_öfo
(&
lubbock_fi˝_∂©f‹m_d©a
);

476 
lubbock_Êash_d©a
[0].
width
 =Üubbock_flash_data[1].width =

477 (
BOOT_DEF
 & 1) ? 2 : 4;

479 
	`¥ötk
(
KERN_NOTICE
 "Lubbock configuredÅo boot from %s (bank %d)\n",

480 
ÊashboŸ
?"Flash":"ROM", flashboot);

482 
lubbock_Êash_d©a
[
ÊashboŸ
^1].
«me
 = "application-flash";

483 
lubbock_Êash_d©a
[
ÊashboŸ
].
«me
 = "boot-rom";

484 (Ë
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

486 
	`•i_ªgi°î_bﬂrd_öfo
(
•i_bﬂrd_öfo
, 
	`ARRAY_SIZE
(spi_board_info));

487 
	}
}

489 
m≠_desc
 
	glubbock_io_desc
[] 
	g__öôd©a
 = {

491 .
vútuÆ
 = 
LUBBOCK_FPGA_VIRT
,

492 .
	gp‚
 = 
__phys_to_p‚
(
LUBBOCK_FPGA_PHYS
),

493 .
	gÀngth
 = 0x00100000,

494 .
	gty≥
 = 
MT_DEVICE


498 
__öô
 
	$lubbock_m≠_io
()

500 
	`pxa_m≠_io
();

501 
	`iŸabÀ_öô
(
lubbock_io_desc
, 
	`ARRAY_SIZE
(lubbock_io_desc));

504 
	`pxa_gpio_mode
(
GPIO23_SCLK_MD
);

505 
	`pxa_gpio_mode
(
GPIO25_STXD_MD
);

506 
	`pxa_gpio_mode
(
GPIO26_SRXD_MD
);

509 
	`pxa_gpio_mode
(
GPIO42_BTRXD_MD
);

510 
	`pxa_gpio_mode
(
GPIO43_BTTXD_MD
);

511 
	`pxa_gpio_mode
(
GPIO44_BTCTS_MD
);

512 
	`pxa_gpio_mode
(
GPIO45_BTRTS_MD
);

515 
	`pxa_gpio_mode
(
GPIO79_nCS_3_MD
);

518 
PWER
 = 0x00000002;

519 
PFER
 = 0x00000000;

520 
PRER
 = 0x00000002;

521 
PGSR0
 = 0x00008000;

522 
PGSR1
 = 0x003F0202;

523 
PGSR2
 = 0x0001C000;

524 
PCFR
 |
PCFR_OPDE
;

525 
	}
}

527 
MACHINE_START
(
LUBBOCK
, "Intel DBPXA250 Development Platform (aka Lubbock)")

529 .
	gphys_io
 = 0x40000000,

530 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

531 .
	gm≠_io
 = 
lubbock_m≠_io
,

532 .
	göô_úq
 = 
lubbock_öô_úq
,

533 .
	gtimî
 = &
pxa_timî
,

534 .
	göô_machöe
 = 
lubbock_öô
,

535 
	gMACHINE_END


	@arch/arm/mach-pxa/mainstone.c

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/sysdev.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/bô›s.h
>

22 
	~<löux/fb.h
>

23 
	~<löux/i›‹t.h
>

24 
	~<löux/mtd/mtd.h
>

25 
	~<löux/mtd/∑πôi⁄s.h
>

27 
	~<asm/ty≥s.h
>

28 
	~<asm/£tup.h
>

29 
	~<asm/mem‹y.h
>

30 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/sizes.h
>

35 
	~<asm/mach/¨ch.h
>

36 
	~<asm/mach/m≠.h
>

37 
	~<asm/mach/úq.h
>

38 
	~<asm/mach/Êash.h
>

40 
	~<asm/¨ch/pxa-ªgs.h
>

41 
	~<asm/¨ch/maö°⁄e.h
>

42 
	~<asm/¨ch/audio.h
>

43 
	~<asm/¨ch/pxafb.h
>

44 
	~<asm/¨ch/mmc.h
>

45 
	~<asm/¨ch/úda.h
>

46 
	~<asm/¨ch/ohci.h
>

48 
	~"gíîic.h
"

51 
	gmaö°⁄e_úq_íabÀd
;

53 
	$maö°⁄e_mask_úq
(
úq
)

55 
maö°⁄e_úq
 = (
úq
 - 
	`MAINSTONE_IRQ
(0));

56 
MST_INTMSKENA
 = (
maö°⁄e_úq_íabÀd
 &~(1 << 
maö°⁄e_úq
));

57 
	}
}

59 
	$maö°⁄e_unmask_úq
(
úq
)

61 
maö°⁄e_úq
 = (
úq
 - 
	`MAINSTONE_IRQ
(0));

63 
MST_INTSETCLR
 &~(1 << 
maö°⁄e_úq
);

64 
MST_INTMSKENA
 = (
maö°⁄e_úq_íabÀd
 |(1 << 
maö°⁄e_úq
));

65 
	}
}

67 
úq_chù
 
	gmaö°⁄e_úq_chù
 = {

68 .
«me
 = "FPGA",

69 .
	gack
 = 
maö°⁄e_mask_úq
,

70 .
	gmask
 = 
maö°⁄e_mask_úq
,

71 .
	gunmask
 = 
maö°⁄e_unmask_úq
,

74 
	$maö°⁄e_úq_h™dÀr
(
úq
, 
úq_desc
 *
desc
)

76 
≥ndög
 = 
MST_INTSETCLR
 & 
maö°⁄e_úq_íabÀd
;

78 
	`GEDR
(0Ë
	`GPIO_bô
(0);

79 i‡(
	`likñy
(
≥ndög
)) {

80 
úq
 = 
	`MAINSTONE_IRQ
(0Ë+ 
	`__ffs
(
≥ndög
);

81 
desc
 = 
úq_desc
 + 
úq
;

82 
	`desc_h™dÀ_úq
(
úq
, 
desc
);

84 
≥ndög
 = 
MST_INTSETCLR
 & 
maö°⁄e_úq_íabÀd
;

85 } 
≥ndög
);

86 
	}
}

88 
__öô
 
	$maö°⁄e_öô_úq
()

90 
úq
;

92 
	`pxa_öô_úq
();

95 
úq
 = 
	`MAINSTONE_IRQ
(0); irq <= MAINSTONE_IRQ(15); irq++) {

96 
	`£t_úq_chù
(
úq
, &
maö°⁄e_úq_chù
);

97 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

98 i‡(
úq
 =
	`MAINSTONE_IRQ
(10) || irq == MAINSTONE_IRQ(14))

99 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
 | 
IRQF_NOAUTOEN
);

101 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
 | 
IRQF_PROBE
);

103 
	`£t_úq_Êags
(
	`MAINSTONE_IRQ
(8), 0);

104 
	`£t_úq_Êags
(
	`MAINSTONE_IRQ
(12), 0);

106 
MST_INTMSKENA
 = 0;

107 
MST_INTSETCLR
 = 0;

109 
	`£t_úq_chaöed_h™dÀr
(
	`IRQ_GPIO
(0), 
maö°⁄e_úq_h™dÀr
);

110 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(0), 
IRQT_FALLING
);

111 
	}
}

113 #ifde‡
CONFIG_PM


115 
	$maö°⁄e_úq_ªsume
(
sys_devi˚
 *
dev
)

117 
MST_INTMSKENA
 = 
maö°⁄e_úq_íabÀd
;

119 
	}
}

121 
sysdev_˛ass
 
	gmaö°⁄e_úq_sys˛ass
 = {

122 
£t_k£t_«me
("cpld_irq"),

123 .
ªsume
 = 
maö°⁄e_úq_ªsume
,

126 
sys_devi˚
 
	gmaö°⁄e_úq_devi˚
 = {

127 .
˛s
 = &
maö°⁄e_úq_sys˛ass
,

130 
__öô
 
	$maö°⁄e_úq_devi˚_öô
()

132 
ªt
 = 
	`sysdev_˛ass_ªgi°î
(&
maö°⁄e_úq_sys˛ass
);

133 i‡(
ªt
 == 0)

134 
ªt
 = 
	`sysdev_ªgi°î
(&
maö°⁄e_úq_devi˚
);

135  
ªt
;

136 
	}
}

138 
devi˚_öôˇŒ
(
maö°⁄e_úq_devi˚_öô
);

143 
ªsour˚
 
	gsmc91x_ªsour˚s
[] = {

145 .
°¨t
 = (
MST_ETH_PHYS
 + 0x300),

146 .
	gíd
 = (
MST_ETH_PHYS
 + 0xfffff),

147 .
	gÊags
 = 
IORESOURCE_MEM
,

150 .
°¨t
 = 
MAINSTONE_IRQ
(3),

151 .
	gíd
 = 
MAINSTONE_IRQ
(3),

152 .
	gÊags
 = 
IORESOURCE_IRQ
,

156 
∂©f‹m_devi˚
 
	gsmc91x_devi˚
 = {

157 .
«me
 = "smc91x",

158 .
	gid
 = 0,

159 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
smc91x_ªsour˚s
),

160 .
	gªsour˚
 = 
smc91x_ªsour˚s
,

163 
	$m°_audio_°¨tup
(
¢d_pcm_sub°ªam
 *
sub°ªam
, *
¥iv
)

165 i‡(
sub°ªam
->
°ªam
 =
SNDRV_PCM_STREAM_PLAYBACK
)

166 
MST_MSCWR2
 &~
MST_MSCWR2_AC97_SPKROFF
;

168 
	}
}

170 
	$m°_audio_shutdown
(
¢d_pcm_sub°ªam
 *
sub°ªam
, *
¥iv
)

172 i‡(
sub°ªam
->
°ªam
 =
SNDRV_PCM_STREAM_PLAYBACK
)

173 
MST_MSCWR2
 |
MST_MSCWR2_AC97_SPKROFF
;

174 
	}
}

176 
	gm°_audio_su•íd_mask
;

178 
	$m°_audio_su•íd
(*
¥iv
)

180 
m°_audio_su•íd_mask
 = 
MST_MSCWR2
;

181 
MST_MSCWR2
 |
MST_MSCWR2_AC97_SPKROFF
;

182 
	}
}

184 
	$m°_audio_ªsume
(*
¥iv
)

186 
MST_MSCWR2
 &
m°_audio_su•íd_mask
 | ~
MST_MSCWR2_AC97_SPKROFF
;

187 
	}
}

189 
pxa2xx_audio_›s_t
 
	gm°_audio_›s
 = {

190 .
°¨tup
 = 
m°_audio_°¨tup
,

191 .
	gshutdown
 = 
m°_audio_shutdown
,

192 .
	gsu•íd
 = 
m°_audio_su•íd
,

193 .
	gªsume
 = 
m°_audio_ªsume
,

196 
∂©f‹m_devi˚
 
	gm°_audio_devi˚
 = {

197 .
«me
 = "pxa2xx-ac97",

198 .
	gid
 = -1,

199 .
	gdev
 = { .
∂©f‹m_d©a
 = &
m°_audio_›s
 },

202 
ªsour˚
 
	gÊash_ªsour˚s
[] = {

204 .
°¨t
 = 
PXA_CS0_PHYS
,

205 .
	gíd
 = 
PXA_CS0_PHYS
 + 
SZ_64M
 - 1,

206 .
	gÊags
 = 
IORESOURCE_MEM
,

209 .
°¨t
 = 
PXA_CS1_PHYS
,

210 .
	gíd
 = 
PXA_CS1_PHYS
 + 
SZ_64M
 - 1,

211 .
	gÊags
 = 
IORESOURCE_MEM
,

215 
mtd_∑πôi⁄
 
	gmaö°⁄eÊash0_∑πôi⁄s
[] = {

217 .
«me
 = "Bootloader",

218 .
	gsize
 = 0x00040000,

219 .
	goff£t
 = 0,

220 .
	gmask_Êags
 = 
MTD_WRITEABLE


222 .
	g«me
 = "Kernel",

223 .
	gsize
 = 0x00400000,

224 .
	goff£t
 = 0x00040000,

226 .
	g«me
 = "Filesystem",

227 .
	gsize
 = 
MTDPART_SIZ_FULL
,

228 .
	goff£t
 = 0x00440000

232 
Êash_∂©f‹m_d©a
 
	gm°_Êash_d©a
[2] = {

234 .
m≠_«me
 = "cfi_probe",

235 .
	g∑πs
 = 
maö°⁄eÊash0_∑πôi⁄s
,

236 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
maö°⁄eÊash0_∑πôi⁄s
),

238 .
	gm≠_«me
 = "cfi_probe",

239 .
	g∑πs
 = 
NULL
,

240 .
	gƒ_∑πs
 = 0,

244 
∂©f‹m_devi˚
 
	gm°_Êash_devi˚
[2] = {

246 .
«me
 = "pxa2xx-flash",

247 .
	gid
 = 0,

248 .
	gdev
 = {

249 .
∂©f‹m_d©a
 = &
m°_Êash_d©a
[0],

251 .
	gªsour˚
 = &
Êash_ªsour˚s
[0],

252 .
	gnum_ªsour˚s
 = 1,

255 .
	g«me
 = "pxa2xx-flash",

256 .
	gid
 = 1,

257 .
	gdev
 = {

258 .
∂©f‹m_d©a
 = &
m°_Êash_d©a
[1],

260 .
	gªsour˚
 = &
Êash_ªsour˚s
[1],

261 .
	gnum_ªsour˚s
 = 1,

265 
	$maö°⁄e_backlight_powî
(
⁄
)

267 i‡(
⁄
) {

268 
	`pxa_gpio_mode
(
GPIO16_PWM0_MD
);

269 
	`pxa_£t_ckí
(
CKEN_PWM0
, 1);

270 
PWM_CTRL0
 = 0;

271 
PWM_PWDUTY0
 = 0x3ff;

272 
PWM_PERVAL0
 = 0x3ff;

274 
PWM_CTRL0
 = 0;

275 
PWM_PWDUTY0
 = 0x0;

276 
PWM_PERVAL0
 = 0x3FF;

277 
	`pxa_£t_ckí
(
CKEN_PWM0
, 0);

279 
	}
}

281 
pxafb_mode_öfo
 
	gtoshiba_…m04c380k_mode
 = {

282 .
pix˛ock
 = 50000,

283 .
	gxªs
 = 640,

284 .
	gyªs
 = 480,

285 .
	gbµ
 = 16,

286 .
	ghsync_Àn
 = 1,

287 .
	gÀ·_m¨gö
 = 0x9f,

288 .
	gright_m¨gö
 = 1,

289 .
	gvsync_Àn
 = 44,

290 .
	guµî_m¨gö
 = 0,

291 .
	glowî_m¨gö
 = 0,

292 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
|
FB_SYNC_VERT_HIGH_ACT
,

295 
pxafb_mode_öfo
 
	gtoshiba_…m035a776c_mode
 = {

296 .
pix˛ock
 = 110000,

297 .
	gxªs
 = 240,

298 .
	gyªs
 = 320,

299 .
	gbµ
 = 16,

300 .
	ghsync_Àn
 = 4,

301 .
	gÀ·_m¨gö
 = 8,

302 .
	gright_m¨gö
 = 20,

303 .
	gvsync_Àn
 = 3,

304 .
	guµî_m¨gö
 = 1,

305 .
	glowî_m¨gö
 = 10,

306 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
|
FB_SYNC_VERT_HIGH_ACT
,

309 
pxafb_mach_öfo
 
	gmaö°⁄e_pxafb_öfo
 = {

310 .
num_modes
 = 1,

311 .
	glc¸0
 = 
LCCR0_A˘
,

312 .
	glc¸3
 = 
LCCR3_PCP
,

313 .
	gpxafb_backlight_powî
 = 
maö°⁄e_backlight_powî
,

316 
	$maö°⁄e_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
m°⁄e_dëe˘_öt
, *
d©a
)

318 
îr
;

323 
	`pxa_gpio_mode
(
GPIO32_MMCCLK_MD
);

324 
	`pxa_gpio_mode
(
GPIO112_MMCCMD_MD
);

325 
	`pxa_gpio_mode
(
GPIO92_MMCDAT0_MD
);

326 
	`pxa_gpio_mode
(
GPIO109_MMCDAT1_MD
);

327 
	`pxa_gpio_mode
(
GPIO110_MMCDAT2_MD
);

328 
	`pxa_gpio_mode
(
GPIO111_MMCDAT3_MD
);

333 
MST_MSCWR1
 &~
MST_MSCWR1_MS_SEL
;

335 
îr
 = 
	`ªque°_úq
(
MAINSTONE_MMC_IRQ
, 
m°⁄e_dëe˘_öt
, 
IRQF_DISABLED
,

336 "MMC c¨d dëe˘", 
d©a
);

337 i‡(
îr
) {

338 
	`¥ötk
(
KERN_ERR
 "mainstone_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

343 
	}
}

345 
	$maö°⁄e_mci_£çowî
(
devi˚
 *
dev
, 
vdd
)

347 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

349 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
) {

350 
	`¥ötk
(
KERN_DEBUG
 "%s: on\n", 
__FUNCTION__
);

351 
MST_MSCWR1
 |
MST_MSCWR1_MMC_ON
;

352 
MST_MSCWR1
 &~
MST_MSCWR1_MS_SEL
;

354 
	`¥ötk
(
KERN_DEBUG
 "%s: off\n", 
__FUNCTION__
);

355 
MST_MSCWR1
 &~
MST_MSCWR1_MMC_ON
;

357 
	}
}

359 
	$maö°⁄e_mci_exô
(
devi˚
 *
dev
, *
d©a
)

361 
	`‰ì_úq
(
MAINSTONE_MMC_IRQ
, 
d©a
);

362 
	}
}

364 
pxamci_∂©f‹m_d©a
 
	gmaö°⁄e_mci_∂©f‹m_d©a
 = {

365 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

366 .
	göô
 = 
maö°⁄e_mci_öô
,

367 .
	g£çowî
 = 
maö°⁄e_mci_£çowî
,

368 .
	gexô
 = 
maö°⁄e_mci_exô
,

371 
	$maö°⁄e_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

373 
Êags
;

375 
	`loˇl_úq_ßve
(
Êags
);

376 i‡(
mode
 & 
IR_SIRMODE
) {

377 
MST_MSCWR1
 &~
MST_MSCWR1_IRDA_FIR
;

378 } i‡(
mode
 & 
IR_FIRMODE
) {

379 
MST_MSCWR1
 |
MST_MSCWR1_IRDA_FIR
;

381 i‡(
mode
 & 
IR_OFF
) {

382 
MST_MSCWR1
 = (MST_MSCWR1 & ~
MST_MSCWR1_IRDA_MASK
Ë| 
MST_MSCWR1_IRDA_OFF
;

384 
MST_MSCWR1
 = (MST_MSCWR1 & ~
MST_MSCWR1_IRDA_MASK
Ë| 
MST_MSCWR1_IRDA_FULL
;

386 
	`loˇl_úq_ª°‹e
(
Êags
);

387 
	}
}

389 
pxafi˝_∂©f‹m_d©a
 
	gmaö°⁄e_fi˝_∂©f‹m_d©a
 = {

390 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_FIRMODE
 | 
IR_OFF
,

391 .
	gå™s˚ivî_mode
 = 
maö°⁄e_úda_å™s˚ivî_mode
,

394 
∂©f‹m_devi˚
 *
	g∂©f‹m_devi˚s
[] 
	g__öôd©a
 = {

395 &
smc91x_devi˚
,

396 &
m°_audio_devi˚
,

397 &
m°_Êash_devi˚
[0],

398 &
m°_Êash_devi˚
[1],

401 
	$maö°⁄e_ohci_öô
(
devi˚
 *
dev
)

404 
	`pxa_gpio_mode
–88 | 
GPIO_ALT_FN_1_IN
);

405 
	`pxa_gpio_mode
–89 | 
GPIO_ALT_FN_2_OUT
);

409 
UHCHR
 = (UHCHR | 
UHCHR_PCPL
 | 
UHCHR_PSPL
) &

410 ~(
UHCHR_SSEP1
 | 
UHCHR_SSEP2
 | 
UHCHR_SSEP3
 | 
UHCHR_SSE
);

413 
	}
}

415 
pxaohci_∂©f‹m_d©a
 
	gmaö°⁄e_ohci_∂©f‹m_d©a
 = {

416 .
p‹t_mode
 = 
PMM_PERPORT_MODE
,

417 .
	göô
 = 
maö°⁄e_ohci_öô
,

420 
__öô
 
	$maö°⁄e_öô
()

422 
SW7
 = 0;

424 
m°_Êash_d©a
[0].
width
 = (
BOOT_DEF
 & 1) ? 2 : 4;

425 
m°_Êash_d©a
[1].
width
 = 4;

428 
m°_Êash_d©a
[
SW7
].
«me
 = "processor-flash";

429 
m°_Êash_d©a
[
SW7
 ^ 1].
«me
 = "mainboard-flash";

431 
	`¥ötk
(
KERN_NOTICE
 "Mainstone configuredÅo boot from %s\n",

432 
m°_Êash_d©a
[0].
«me
);

438 
ARB_CNTRL
 = 
ARB_CORE_PARK
 | 0x234;

444 
	`pxa_gpio_mode
(
GPIO45_SYSCLK_AC97_MD
);

446 
	`∂©f‹m_add_devi˚s
(
∂©f‹m_devi˚s
, 
	`ARRAY_SIZE
(platform_devices));

451 
maö°⁄e_pxafb_öfo
.
modes
 = &
toshiba_…m04c380k_mode
;

453 
maö°⁄e_pxafb_öfo
.
modes
 = &
toshiba_…m035a776c_mode
;

455 
	`£t_pxa_fb_öfo
(&
maö°⁄e_pxafb_öfo
);

457 
	`pxa_£t_mci_öfo
(&
maö°⁄e_mci_∂©f‹m_d©a
);

458 
	`pxa_£t_fi˝_öfo
(&
maö°⁄e_fi˝_∂©f‹m_d©a
);

459 
	`pxa_£t_ohci_öfo
(&
maö°⁄e_ohci_∂©f‹m_d©a
);

460 
	}
}

463 
m≠_desc
 
	gmaö°⁄e_io_desc
[] 
	g__öôd©a
 = {

465 .
vútuÆ
 = 
MST_FPGA_VIRT
,

466 .
	gp‚
 = 
__phys_to_p‚
(
MST_FPGA_PHYS
),

467 .
	gÀngth
 = 0x00100000,

468 .
	gty≥
 = 
MT_DEVICE


472 
__öô
 
	$maö°⁄e_m≠_io
()

474 
	`pxa_m≠_io
();

475 
	`iŸabÀ_öô
(
maö°⁄e_io_desc
, 
	`ARRAY_SIZE
(mainstone_io_desc));

478 
PGSR0
 = 0x00008800;

479 
PGSR1
 = 0x00000002;

480 
PGSR2
 = 0x0001FC00;

481 
PGSR3
 = 0x00001F81;

482 
PWER
 = 0xC0000002;

483 
PRER
 = 0x00000002;

484 
PFER
 = 0x00000002;

486 
PSLR
 |= 0xF04;

487 
PCFR
 = 0x66;

489 
KPC
 &=~
KPC_ASACT
;

490 
KPC
 |=
KPC_AS
;

491 
PKWR
 = 0x000FD000;

493 
PKWR
;

494 
	}
}

496 
MACHINE_START
(
MAINSTONE
, "Intel HCDDBBVA0 Development Platform (aka Mainstone)")

498 .
	gphys_io
 = 0x40000000,

499 .
	gboŸ_∑øms
 = 0xa0000100,

500 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

501 .
	gm≠_io
 = 
maö°⁄e_m≠_io
,

502 .
	göô_úq
 = 
maö°⁄e_öô_úq
,

503 .
	gtimî
 = &
pxa_timî
,

504 .
	göô_machöe
 = 
maö°⁄e_öô
,

505 
	gMACHINE_END


	@arch/arm/mach-pxa/pm.c

13 
	~<löux/öô.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/su•íd.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/time.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/mem‹y.h
>

21 
	~<asm/sy°em.h
>

22 
	~<asm/¨ch/pm.h
>

23 
	~<asm/¨ch/pxa-ªgs.h
>

24 
	~<asm/¨ch/lubbock.h
>

25 
	~<asm/mach/time.h
>

31 #unde‡
DEBUG


33 
	#SAVE
(
x
Ë
¶ìp_ßve
[
SLEEP_SAVE_
##x] = 
	)
x

34 
	#RESTORE
(
x
Ëx = 
¶ìp_ßve
[
SLEEP_SAVE_
##x]

	)

36 
	#RESTORE_GPLEVEL
(
n
) do { \

37 
GPSR
##
n
 = 
¶ìp_ßve
[
SLEEP_SAVE_GPLR
##n]; \

38 
GPCR
##
n
 = ~
¶ìp_ßve
[
SLEEP_SAVE_GPLR
##n]; \

39 } 0)

	)

46 íum { 
	mSLEEP_SAVE_START
 = 0,

48 
	mSLEEP_SAVE_GPLR0
, 
	mSLEEP_SAVE_GPLR1
, 
	mSLEEP_SAVE_GPLR2
, 
	mSLEEP_SAVE_GPLR3
,

49 
	mSLEEP_SAVE_GPDR0
, 
	mSLEEP_SAVE_GPDR1
, 
	mSLEEP_SAVE_GPDR2
, 
	mSLEEP_SAVE_GPDR3
,

50 
	mSLEEP_SAVE_GRER0
, 
	mSLEEP_SAVE_GRER1
, 
	mSLEEP_SAVE_GRER2
, 
	mSLEEP_SAVE_GRER3
,

51 
	mSLEEP_SAVE_GFER0
, 
	mSLEEP_SAVE_GFER1
, 
	mSLEEP_SAVE_GFER2
, 
	mSLEEP_SAVE_GFER3
,

52 
	mSLEEP_SAVE_PGSR0
, 
	mSLEEP_SAVE_PGSR1
, 
	mSLEEP_SAVE_PGSR2
, 
	mSLEEP_SAVE_PGSR3
,

54 
	mSLEEP_SAVE_GAFR0_L
, 
	mSLEEP_SAVE_GAFR0_U
,

55 
	mSLEEP_SAVE_GAFR1_L
, 
	mSLEEP_SAVE_GAFR1_U
,

56 
	mSLEEP_SAVE_GAFR2_L
, 
	mSLEEP_SAVE_GAFR2_U
,

57 
	mSLEEP_SAVE_GAFR3_L
, 
	mSLEEP_SAVE_GAFR3_U
,

59 
	mSLEEP_SAVE_PSTR
,

61 
	mSLEEP_SAVE_ICMR
,

62 
	mSLEEP_SAVE_CKEN
,

64 #ifde‡
CONFIG_PXA27x


65 
	mSLEEP_SAVE_MDREFR
,

66 
	mSLEEP_SAVE_PWER
, 
	mSLEEP_SAVE_PCFR
, 
	mSLEEP_SAVE_PRER
,

67 
	mSLEEP_SAVE_PFER
, 
	mSLEEP_SAVE_PKWR
,

70 
	mSLEEP_SAVE_CKSUM
,

72 
	mSLEEP_SAVE_SIZE


76 
	$pxa_pm_íãr
(
su•íd_°©e_t
 
°©e
)

78 
¶ìp_ßve
[
SLEEP_SAVE_SIZE
];

79 
checksum
 = 0;

80 
time•ec
 
dñè
, 
πc
;

81 
i
;

82 
	`pxa_˝u_pm_íãr
(
su•íd_°©e_t
 
°©e
);

84 #ifde‡
CONFIG_IWMMXT


86 i‡(
ñf_hwˇp
 & 
HWCAP_IWMMXT
)

87 
	`iwmmxt_èsk_dißbÀ
(
NULL
);

91 
πc
.
tv_£c
 = 
RCNR
;

92 
πc
.
tv_n£c
 = 0;

93 
	`ßve_time_dñè
(&
dñè
, &
πc
);

95 
	`SAVE
(
GPLR0
); SAVE(
GPLR1
); SAVE(
GPLR2
);

96 
	`SAVE
(
GPDR0
); SAVE(
GPDR1
); SAVE(
GPDR2
);

97 
	`SAVE
(
GRER0
); SAVE(
GRER1
); SAVE(
GRER2
);

98 
	`SAVE
(
GFER0
); SAVE(
GFER1
); SAVE(
GFER2
);

99 
	`SAVE
(
PGSR0
); SAVE(
PGSR1
); SAVE(
PGSR2
);

101 
	`SAVE
(
GAFR0_L
); SAVE(
GAFR0_U
);

102 
	`SAVE
(
GAFR1_L
); SAVE(
GAFR1_U
);

103 
	`SAVE
(
GAFR2_L
); SAVE(
GAFR2_U
);

105 #ifde‡
CONFIG_PXA27x


106 
	`SAVE
(
MDREFR
);

107 
	`SAVE
(
GPLR3
); SAVE(
GPDR3
); SAVE(
GRER3
); SAVE(
GFER3
); SAVE(
PGSR3
);

108 
	`SAVE
(
GAFR3_L
); SAVE(
GAFR3_U
);

109 
	`SAVE
(
PWER
); SAVE(
PCFR
); SAVE(
PRER
);

110 
	`SAVE
(
PFER
); SAVE(
PKWR
);

113 
	`SAVE
(
ICMR
);

114 
ICMR
 = 0;

116 
	`SAVE
(
CKEN
);

117 
	`SAVE
(
PSTR
);

122 
GEDR0
 = GEDR0; 
GEDR1
 = GEDR1; 
GEDR2
 = GEDR2;

123 #ifde‡
CONFIG_PXA27x


124 
GEDR3
 = GEDR3;

128 
RCSR
 = 
RCSR_SMR
;

131 
i
 = 0; i < 
SLEEP_SAVE_SIZE
 - 1; i++)

132 
checksum
 +
¶ìp_ßve
[
i
];

133 
¶ìp_ßve
[
SLEEP_SAVE_CKSUM
] = 
checksum
;

136 
	`pxa_˝u_pm_íãr
(
°©e
);

138 
	`˝u_öô
();

141 
checksum
 = 0;

142 
i
 = 0; i < 
SLEEP_SAVE_SIZE
 - 1; i++)

143 
checksum
 +
¶ìp_ßve
[
i
];

146 i‡(
checksum
 !
¶ìp_ßve
[
SLEEP_SAVE_CKSUM
]) {

147 #ifde‡
CONFIG_ARCH_LUBBOCK


148 
LUB_HEXLED
 = 0xbadbadc5;

151 
	`pxa_˝u_pm_íãr
(
°©e
);

155 
PSPR
 = 0;

158 
	`RESTORE_GPLEVEL
(0); RESTORE_GPLEVEL(1); RESTORE_GPLEVEL(2);

159 
	`RESTORE
(
GPDR0
); RESTORE(
GPDR1
); RESTORE(
GPDR2
);

160 
	`RESTORE
(
GAFR0_L
); RESTORE(
GAFR0_U
);

161 
	`RESTORE
(
GAFR1_L
); RESTORE(
GAFR1_U
);

162 
	`RESTORE
(
GAFR2_L
); RESTORE(
GAFR2_U
);

163 
	`RESTORE
(
GRER0
); RESTORE(
GRER1
); RESTORE(
GRER2
);

164 
	`RESTORE
(
GFER0
); RESTORE(
GFER1
); RESTORE(
GFER2
);

165 
	`RESTORE
(
PGSR0
); RESTORE(
PGSR1
); RESTORE(
PGSR2
);

167 #ifde‡
CONFIG_PXA27x


168 
	`RESTORE
(
MDREFR
);

169 
	`RESTORE_GPLEVEL
(3); 
	`RESTORE
(
GPDR3
);

170 
	`RESTORE
(
GAFR3_L
); RESTORE(
GAFR3_U
);

171 
	`RESTORE
(
GRER3
); RESTORE(
GFER3
); RESTORE(
PGSR3
);

172 
	`RESTORE
(
PWER
); RESTORE(
PCFR
); RESTORE(
PRER
);

173 
	`RESTORE
(
PFER
); RESTORE(
PKWR
);

176 
PSSR
 = 
PSSR_RDH
 | 
PSSR_PH
;

178 
	`RESTORE
(
CKEN
);

180 
ICLR
 = 0;

181 
ICCR
 = 1;

182 
	`RESTORE
(
ICMR
);

184 
	`RESTORE
(
PSTR
);

187 
πc
.
tv_£c
 = 
RCNR
;

188 
	`ª°‹e_time_dñè
(&
dñè
, &
πc
);

190 #ifde‡
DEBUG


191 
	`¥ötk
(
KERN_DEBUG
 "*** made it back fromÑesume\n");

195 
	}
}

197 
EXPORT_SYMBOL_GPL
(
pxa_pm_íãr
);

199 
	$¶ìp_phys_•
(*
•
)

201  
	`vút_to_phys
(
•
);

202 
	}
}

207 
	$pxa_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
)

209 
	`pxa_˝u_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
);

211  
	`pxa_˝u_pm_¥ï¨e
(
°©e
);

212 
	}
}

214 
EXPORT_SYMBOL_GPL
(
pxa_pm_¥ï¨e
);

219 
	$pxa_pm_föish
(
su•íd_°©e_t
 
°©e
)

222 
	}
}

224 
EXPORT_SYMBOL_GPL
(
pxa_pm_föish
);

226 
pm_›s
 
	gpxa_pm_›s
 = {

227 .
¥ï¨e
 = 
pxa_pm_¥ï¨e
,

228 .
	gíãr
 = 
pxa_pm_íãr
,

229 .
	gföish
 = 
pxa_pm_föish
,

230 .
	gvÆid
 = 
pm_vÆid_⁄ly_mem
,

233 
__öô
 
	$pxa_pm_öô
()

235 
	`pm_£t_›s
(&
pxa_pm_›s
);

237 
	}
}

239 
devi˚_öôˇŒ
(
pxa_pm_öô
);

	@arch/arm/mach-pxa/poodle.c

17 
	~<löux/kî√l.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/∂©f‹m_devi˚.h
>

20 
	~<löux/fb.h
>

21 
	~<löux/pm.h
>

22 
	~<löux/dñay.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/mach-ty≥s.h
>

26 
	~<asm/úq.h
>

27 
	~<asm/£tup.h
>

28 
	~<asm/sy°em.h
>

30 
	~<asm/mach/¨ch.h
>

31 
	~<asm/mach/m≠.h
>

32 
	~<asm/mach/úq.h
>

34 
	~<asm/¨ch/pxa-ªgs.h
>

35 
	~<asm/¨ch/mmc.h
>

36 
	~<asm/¨ch/udc.h
>

37 
	~<asm/¨ch/úda.h
>

38 
	~<asm/¨ch/poodÀ.h
>

39 
	~<asm/¨ch/pxafb.h
>

40 
	~<asm/¨ch/sh¨p¶.h
>

41 
	~<asm/¨ch/s•.h
>

43 
	~<asm/h¨dw¨e/sco›.h
>

44 
	~<asm/h¨dw¨e/locomo.h
>

45 
	~<asm/mach/sh¨p¶_∑øm.h
>

47 
	~"gíîic.h
"

48 
	~"sh¨p¶.h
"

50 
ªsour˚
 
	gpoodÀ_sco›_ªsour˚s
[] = {

52 .
°¨t
 = 0x10800000,

53 .
	gíd
 = 0x10800fff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

58 
sco›_c⁄fig
 
	gpoodÀ_sco›_£tup
 = {

59 .
io_dú
 = 
POODLE_SCOOP_IO_DIR
,

60 .
	gio_out
 = 
POODLE_SCOOP_IO_OUT
,

63 
∂©f‹m_devi˚
 
	gpoodÀ_sco›_devi˚
 = {

64 .
«me
 = "sharp-scoop",

65 .
	gid
 = -1,

66 .
	gdev
 = {

67 .
∂©f‹m_d©a
 = &
poodÀ_sco›_£tup
,

69 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
poodÀ_sco›_ªsour˚s
),

70 .
	gªsour˚
 = 
poodÀ_sco›_ªsour˚s
,

73 
	$poodÀ_pcmcü_öô
()

77 
	`GPSR
(
GPIO48_nPOE
Ë
	`GPIO_bô
(GPIO48_nPOE) |

78 
	`GPIO_bô
(
GPIO49_nPWE
Ë| GPIO_bô(
GPIO50_nPIOR
) |

79 
	`GPIO_bô
(
GPIO51_nPIOW
Ë| GPIO_bô(
GPIO52_nPCE_1
) |

80 
	`GPIO_bô
(
GPIO53_nPCE_2
);

82 
	`pxa_gpio_mode
(
GPIO48_nPOE_MD
);

83 
	`pxa_gpio_mode
(
GPIO49_nPWE_MD
);

84 
	`pxa_gpio_mode
(
GPIO50_nPIOR_MD
);

85 
	`pxa_gpio_mode
(
GPIO51_nPIOW_MD
);

86 
	`pxa_gpio_mode
(
GPIO55_nPREG_MD
);

87 
	`pxa_gpio_mode
(
GPIO56_nPWAIT_MD
);

88 
	`pxa_gpio_mode
(
GPIO57_nIOIS16_MD
);

89 
	`pxa_gpio_mode
(
GPIO52_nPCE_1_MD
);

90 
	`pxa_gpio_mode
(
GPIO53_nPCE_2_MD
);

91 
	`pxa_gpio_mode
(
GPIO54_pSKTSEL_MD
);

92 
	}
}

94 
sco›_pcmcü_dev
 
	gpoodÀ_pcmcü_sco›
[] = {

96 .
dev
 = &
poodÀ_sco›_devi˚
.dev,

97 .
	gúq
 = 
POODLE_IRQ_GPIO_CF_IRQ
,

98 .
	gcd_úq
 = 
POODLE_IRQ_GPIO_CF_CD
,

99 .
	gcd_úq_°r
 = "PCMCIA0 CD",

103 
sco›_pcmcü_c⁄fig
 
	gpoodÀ_pcmcü_c⁄fig
 = {

104 .
devs
 = &
poodÀ_pcmcü_sco›
[0],

105 .
	gnum_devs
 = 1,

106 .
	gpcmcü_öô
 = 
poodÀ_pcmcü_öô
,

109 
EXPORT_SYMBOL
(
poodÀ_sco›_devi˚
);

113 
ªsour˚
 
	glocomo_ªsour˚s
[] = {

115 .
°¨t
 = 0x10000000,

116 .
	gíd
 = 0x10001fff,

117 .
	gÊags
 = 
IORESOURCE_MEM
,

120 .
°¨t
 = 
IRQ_GPIO
(10),

121 .
	gíd
 = 
IRQ_GPIO
(10),

122 .
	gÊags
 = 
IORESOURCE_IRQ
,

126 
∂©f‹m_devi˚
 
	gpoodÀ_locomo_devi˚
 = {

127 .
«me
 = "locomo",

128 .
	gid
 = 0,

129 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
locomo_ªsour˚s
),

130 .
	gªsour˚
 = 
locomo_ªsour˚s
,

133 
EXPORT_SYMBOL
(
poodÀ_locomo_devi˚
);

139 
∂©f‹m_devi˚
 
	gpoodÀ_s•_devi˚
 = {

140 .
«me
 = "corgi-ssp",

141 .
	gid
 = -1,

144 
c‹gis•_machöfo
 
	gpoodÀ_s•_machöfo
 = {

145 .
p‹t
 = 1,

146 .
	gcs_lcdc⁄
 = -1,

147 .
	gcs_ads7846
 = -1,

148 .
	gcs_max1111
 = -1,

149 .
	g˛k_lcdc⁄
 = 2,

150 .
	g˛k_ads7846
 = 36,

151 .
	g˛k_max1111
 = 2,

158 
ªsour˚
 
	gpoodÀts_ªsour˚s
[] = {

160 .
°¨t
 = 
POODLE_IRQ_GPIO_TP_INT
,

161 .
	gíd
 = 
POODLE_IRQ_GPIO_TP_INT
,

162 .
	gÊags
 = 
IORESOURCE_IRQ
,

166 
	$poodÀ_gë_hsync_Àn
()

169 
	}
}

171 
	$poodÀ_nuŒ_hsync
()

173 
	}
}

175 
c‹gôs_machöfo
 
	gpoodÀ_ts_machöfo
 = {

176 .
gë_hsync_Àn
 = 
poodÀ_gë_hsync_Àn
,

177 .
	gput_hsync
 = 
poodÀ_nuŒ_hsync
,

178 .
	gwaô_hsync
 = 
poodÀ_nuŒ_hsync
,

181 
∂©f‹m_devi˚
 
	gpoodÀ_ts_devi˚
 = {

182 .
«me
 = "corgi-ts",

183 .
	gdev
 = {

184 .
∂©f‹m_d©a
 = &
poodÀ_ts_machöfo
,

186 .
	gid
 = -1,

187 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
poodÀts_ªsour˚s
),

188 .
	gªsour˚
 = 
poodÀts_ªsour˚s
,

198 
pxamci_∂©f‹m_d©a
 
	gpoodÀ_mci_∂©f‹m_d©a
;

200 
	$poodÀ_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
poodÀ_dëe˘_öt
, *
d©a
)

202 
îr
;

205 
	`pxa_gpio_mode
(
GPIO6_MMCCLK_MD
);

206 
	`pxa_gpio_mode
(
GPIO8_MMCCS0_MD
);

207 
	`pxa_gpio_mode
(
POODLE_GPIO_nSD_DETECT
 | 
GPIO_IN
);

208 
	`pxa_gpio_mode
(
POODLE_GPIO_nSD_WP
 | 
GPIO_IN
);

209 
	`pxa_gpio_mode
(
POODLE_GPIO_SD_PWR
 | 
GPIO_OUT
);

210 
	`pxa_gpio_mode
(
POODLE_GPIO_SD_PWR1
 | 
GPIO_OUT
);

212 
poodÀ_mci_∂©f‹m_d©a
.
dëe˘_dñay
 = 
	`m£cs_to_jiffõs
(250);

214 
îr
 = 
	`ªque°_úq
(
POODLE_IRQ_GPIO_nSD_DETECT
, 
poodÀ_dëe˘_öt
,

215 
IRQF_DISABLED
 | 
IRQF_TRIGGER_RISING
 | 
IRQF_TRIGGER_FALLING
,

216 "MMC c¨d dëe˘", 
d©a
);

217 i‡(
îr
) {

218 
	`¥ötk
(
KERN_ERR
 "poodle_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

223 
	}
}

225 
	$poodÀ_mci_£çowî
(
devi˚
 *
dev
, 
vdd
)

227 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

229 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
) {

230 
	`GPSR
(
POODLE_GPIO_SD_PWR
Ë
	`GPIO_bô
(POODLE_GPIO_SD_PWR);

231 
	`mdñay
(2);

232 
	`GPSR
(
POODLE_GPIO_SD_PWR1
Ë
	`GPIO_bô
(POODLE_GPIO_SD_PWR1);

234 
	`GPCR
(
POODLE_GPIO_SD_PWR1
Ë
	`GPIO_bô
(POODLE_GPIO_SD_PWR1);

235 
	`GPCR
(
POODLE_GPIO_SD_PWR
Ë
	`GPIO_bô
(POODLE_GPIO_SD_PWR);

237 
	}
}

239 
	$poodÀ_mci_gë_ro
(
devi˚
 *
dev
)

241  
	`GPLR
(
POODLE_GPIO_nSD_WP
Ë& 
	`GPIO_bô
(POODLE_GPIO_nSD_WP);

242 
	}
}

245 
	$poodÀ_mci_exô
(
devi˚
 *
dev
, *
d©a
)

247 
	`‰ì_úq
(
POODLE_IRQ_GPIO_nSD_DETECT
, 
d©a
);

248 
	}
}

250 
pxamci_∂©f‹m_d©a
 
	gpoodÀ_mci_∂©f‹m_d©a
 = {

251 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

252 .
	göô
 = 
poodÀ_mci_öô
,

253 .
	ggë_ro
 = 
poodÀ_mci_gë_ro
,

254 .
	g£çowî
 = 
poodÀ_mci_£çowî
,

255 .
	gexô
 = 
poodÀ_mci_exô
,

262 
	$poodÀ_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

264 i‡(
mode
 & 
IR_OFF
) {

265 
	`GPSR
(
POODLE_GPIO_IR_ON
Ë
	`GPIO_bô
(POODLE_GPIO_IR_ON);

267 
	`GPCR
(
POODLE_GPIO_IR_ON
Ë
	`GPIO_bô
(POODLE_GPIO_IR_ON);

269 
	}
}

271 
pxafi˝_∂©f‹m_d©a
 
	gpoodÀ_fi˝_∂©f‹m_d©a
 = {

272 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_OFF
,

273 .
	gå™s˚ivî_mode
 = 
poodÀ_úda_å™s˚ivî_mode
,

280 
	$poodÀ_udc_comm™d
(
cmd
)

282 
cmd
) {

283 
PXA2XX_UDC_CMD_CONNECT
:

284 
	`GPSR
(
POODLE_GPIO_USB_PULLUP
Ë
	`GPIO_bô
(POODLE_GPIO_USB_PULLUP);

286 
PXA2XX_UDC_CMD_DISCONNECT
:

287 
	`GPCR
(
POODLE_GPIO_USB_PULLUP
Ë
	`GPIO_bô
(POODLE_GPIO_USB_PULLUP);

290 
	}
}

292 
pxa2xx_udc_mach_öfo
 
udc_öfo
 
	g__öôd©a
 = {

294 .
udc_comm™d
 = 
poodÀ_udc_comm™d
,

299 
pxafb_mode_öfo
 
	gpoodÀ_fb_mode
 = {

300 .
pix˛ock
 = 144700,

301 .
	gxªs
 = 320,

302 .
	gyªs
 = 240,

303 .
	gbµ
 = 16,

304 .
	ghsync_Àn
 = 7,

305 .
	gÀ·_m¨gö
 = 11,

306 .
	gright_m¨gö
 = 30,

307 .
	gvsync_Àn
 = 2,

308 .
	guµî_m¨gö
 = 2,

309 .
	glowî_m¨gö
 = 0,

310 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

313 
pxafb_mach_öfo
 
	gpoodÀ_fb_öfo
 = {

314 .
modes
 = &
poodÀ_fb_mode
,

315 .
	gnum_modes
 = 1,

316 .
	glc¸0
 = 
LCCR0_A˘
 | 
LCCR0_Sngl
 | 
LCCR0_Cﬁ‹
,

317 .
	glc¸3
 = 0,

320 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

321 &
poodÀ_locomo_devi˚
,

322 &
poodÀ_sco›_devi˚
,

323 &
poodÀ_s•_devi˚
,

324 &
poodÀ_ts_devi˚
,

327 
	$poodÀ_powîoff
()

329 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

330 
	`¨m_machöe_ª°¨t
('h');

331 
	}
}

333 
	$poodÀ_ª°¨t
(
mode
)

335 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

336 
	`¨m_machöe_ª°¨t
('h');

337 
	}
}

339 
__öô
 
	$poodÀ_öô
()

341 
ªt
 = 0;

343 
pm_powî_off
 = 
poodÀ_powîoff
;

344 
¨m_pm_ª°¨t
 = 
poodÀ_ª°¨t
;

347 
PWER
 = 0x00000002;

348 
PFER
 = 0x00000000;

349 
PRER
 = 0x00000002;

350 
PGSR0
 = 0x00008000;

351 
PGSR1
 = 0x003F0202;

352 
PGSR2
 = 0x0001C000;

353 
PCFR
 |
PCFR_OPDE
;

357 
PGSR0
 = 0x0146dd80;

358 
PGSR1
 = 0x03bf0890;

359 
PGSR2
 = 0x0001c000;

362 
GAFR0_L
 = 0x01001000;

363 
GAFR0_U
 = 0x591a8010;

364 
GAFR1_L
 = 0x900a8451;

365 
GAFR1_U
 = 0xaaa5aaaa;

366 
GAFR2_L
 = 0x8aaaaaaa;

367 
GAFR2_U
 = 0x00000002;

370 
GPDR0
 = 0xd3f0904c;

371 
GPDR1
 = 0xfcffb7d3;

372 
GPDR2
 = 0x0001ffff;

375 
GPCR0
 = 0x00000000;

376 
GPCR1
 = 0x00000000;

377 
GPCR2
 = 0x00000000;

379 
GPSR0
 = 0x00400000;

380 
GPSR1
 = 0x00000000;

381 
GPSR2
 = 0x00000000;

383 
	`£t_pxa_fb_∑ª¡
(&
poodÀ_locomo_devi˚
.
dev
);

384 
	`£t_pxa_fb_öfo
(&
poodÀ_fb_öfo
);

385 
	`pxa_gpio_mode
(
POODLE_GPIO_USB_PULLUP
 | 
GPIO_OUT
);

386 
	`pxa_gpio_mode
(
POODLE_GPIO_IR_ON
 | 
GPIO_OUT
);

387 
	`pxa_£t_udc_öfo
(&
udc_öfo
);

388 
	`pxa_£t_mci_öfo
(&
poodÀ_mci_∂©f‹m_d©a
);

389 
	`pxa_£t_fi˝_öfo
(&
poodÀ_fi˝_∂©f‹m_d©a
);

391 
∂©f‹m_sco›_c⁄fig
 = &
poodÀ_pcmcü_c⁄fig
;

393 
ªt
 = 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

394 i‡(
ªt
) {

395 
	`¥ötk
(
KERN_WARNING
 "poodle: UnableÅoÑegister LoCoMo device\n");

397 
	`c‹gi_s•_£t_machöfo
(&
poodÀ_s•_machöfo
);

398 
	}
}

400 
__öô
 
	$fixup_poodÀ
(
machöe_desc
 *
desc
,

401 
èg
 *
ègs
, **
cmdlöe
, 
memöfo
 *
mi
)

403 
	`sh¨p¶_ßve_∑øm
();

404 
mi
->
ƒ_b™ks
=1;

405 
mi
->
b™k
[0].
°¨t
 = 0xa0000000;

406 
mi
->
b™k
[0].
node
 = 0;

407 
mi
->
b™k
[0].
size
 = (32*1024*1024);

408 
	}
}

410 
MACHINE_START
(
POODLE
, "SHARP Poodle")

411 .
	gphys_io
 = 0x40000000,

412 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

413 .
	gfixup
 = 
fixup_poodÀ
,

414 .
	gm≠_io
 = 
pxa_m≠_io
,

415 .
	göô_úq
 = 
pxa_öô_úq
,

416 .
	gtimî
 = &
pxa_timî
,

417 .
	göô_machöe
 = 
poodÀ_öô
,

418 
	gMACHINE_END


	@arch/arm/mach-pxa/pxa25x.c

19 
	~<löux/moduÀ.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/öô.h
>

22 
	~<löux/pm.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/¨ch/pxa-ªgs.h
>

27 
	~"gíîic.h
"

34 
	gL_˛k_mu…
[32] = { 0, 27, 32, 36, 40, 45, 0, };

37 
	gM_˛k_mu…
[4] = { 0, 1, 2, 4 };

41 
	gN2_˛k_mu…
[8] = { 0, 0, 2, 3, 4, 0, 6, 0 };

44 
	#BASE_CLK
 3686400

	)

51 
	$gë_˛k_‰equícy_khz
(
öfo
)

53 
cc¸
, 
turbo
;

54 
l
, 
L
, 
m
, 
M
, 
n2
, 
N
;

56 
cc¸
 = 
CCCR
;

57 
	`asm
–"mrc\ç14, 0, %0, c6, c0, 0" : "Ù" (
turbo
) );

59 
l
 = 
L_˛k_mu…
[(
cc¸
 >> 0) & 0x1f];

60 
m
 = 
M_˛k_mu…
[(
cc¸
 >> 5) & 0x03];

61 
n2
 = 
N2_˛k_mu…
[(
cc¸
 >> 7) & 0x07];

63 
L
 = 
l
 * 
BASE_CLK
;

64 
M
 = 
m
 * 
L
;

65 
N
 = 
n2
 * 
M
 / 2;

67 if(
öfo
)

69 
L
 += 5000;

70 
	`¥ötk
–
KERN_INFO
 "Memory clock: %d.%02dMHz (*%d)\n",

71 
L
 / 1000000, (L % 1000000Ë/ 10000, 
l
 );

72 
M
 += 5000;

73 
	`¥ötk
–
KERN_INFO
 "Run Mode clock: %d.%02dMHz (*%d)\n",

74 
M
 / 1000000, (M % 1000000Ë/ 10000, 
m
 );

75 
N
 += 5000;

76 
	`¥ötk
–
KERN_INFO
 "Turbo Mode clock: %d.%02dMHz (*%d.%d, %sactive)\n",

77 
N
 / 1000000, (N % 1000000Ë/ 10000, 
n2
 / 2, (n2 % 2) * 5,

78 (
turbo
 & 1) ? "" : "in" );

81  (
turbo
 & 1Ë? (
N
/1000Ë: (
M
/1000);

82 
	}
}

84 
EXPORT_SYMBOL
(
gë_˛k_‰equícy_khz
);

89 
	$gë_mem˛k_‰equícy_10khz
()

91  
L_˛k_mu…
[(
CCCR
 >> 0Ë& 0x1f] * 
BASE_CLK
 / 10000;

92 
	}
}

94 
EXPORT_SYMBOL
(
gë_mem˛k_‰equícy_10khz
);

99 
	$gë_lcd˛k_‰equícy_10khz
()

101  
	`gë_mem˛k_‰equícy_10khz
();

102 
	}
}

104 
EXPORT_SYMBOL
(
gë_lcd˛k_‰equícy_10khz
);

106 #ifde‡
CONFIG_PM


108 
	$pxa_˝u_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
)

110 
°©e
) {

111 
PM_SUSPEND_MEM
:

114  -
EINVAL
;

118 
	}
}

120 
	$pxa_˝u_pm_íãr
(
su•íd_°©e_t
 
°©e
)

122 
	`pxa_˝u_su•íd
();

123 
	`pxa_˝u_ªsume
();

125 
CKEN
 = 0;

127 
°©e
) {

128 
PM_SUSPEND_MEM
:

130 
PSPR
 = 
	`vút_to_phys
(
pxa_˝u_ªsume
);

131 
	`pxa_˝u_su•íd
(
PWRMODE_SLEEP
);

134 
	}
}

	@arch/arm/mach-pxa/pxa27x.c

14 
	~<löux/moduÀ.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/pm.h
>

18 
	~<löux/∂©f‹m_devi˚.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/¨ch/pxa-ªgs.h
>

23 
	~<asm/¨ch/ohci.h
>

25 
	~"gíîic.h
"

28 
	#BASE_CLK
 13000000

	)

35 
	$gë_˛k_‰equícy_khz
–
öfo
)

37 
cc§
, 
˛kcfg
;

38 
l
, 
L
, 
m
, 
M
, 
n2
, 
N
, 
S
;

39 
cc¸_a
, 
t
, 
ht
, 
b
;

41 
cc§
 = 
CCSR
;

42 
cc¸_a
 = 
CCCR
 & (1 << 25);

45 
	`asm
–"mrc\ç14, 0, %0, c6, c0, 0" : "Ù" (
˛kcfg
) );

46 
t
 = 
˛kcfg
 & (1 << 0);

47 
ht
 = 
˛kcfg
 & (1 << 2);

48 
b
 = 
˛kcfg
 & (1 << 3);

50 
l
 = 
cc§
 & 0x1f;

51 
n2
 = (
cc§
>>7) & 0xf;

52 
m
 = (
l
 <= 10) ? 1 : (l <= 20) ? 2 : 4;

54 
L
 = 
l
 * 
BASE_CLK
;

55 
N
 = (
L
 * 
n2
) / 2;

56 
M
 = (!
cc¸_a
Ë? (
L
/
m
Ë: ((
b
) ? L : (L/2));

57 
S
 = (
b
Ë? 
L
 : (L/2);

59 i‡(
öfo
) {

60 
	`¥ötk
–
KERN_INFO
 "Run Mode clock: %d.%02dMHz (*%d)\n",

61 
L
 / 1000000, (L % 1000000Ë/ 10000, 
l
 );

62 
	`¥ötk
–
KERN_INFO
 "Turbo Mode clock: %d.%02dMHz (*%d.%d, %sactive)\n",

63 
N
 / 1000000, (N % 1000000)/10000, 
n2
 / 2, (n2 % 2)*5,

64 (
t
) ? "" : "in" );

65 
	`¥ötk
–
KERN_INFO
 "Memory clock: %d.%02dMHz (/%d)\n",

66 
M
 / 1000000, (M % 1000000Ë/ 10000, 
m
 );

67 
	`¥ötk
–
KERN_INFO
 "System bus clock: %d.%02dMHz \n",

68 
S
 / 1000000, (S % 1000000) / 10000 );

71  (
t
Ë? (
N
/1000Ë: (
L
/1000);

72 
	}
}

78 
	$gë_mem˛k_‰equícy_10khz
()

80 
cc§
, 
˛kcfg
;

81 
l
, 
L
, 
m
, 
M
;

82 
cc¸_a
, 
b
;

84 
cc§
 = 
CCSR
;

85 
cc¸_a
 = 
CCCR
 & (1 << 25);

88 
	`asm
–"mrc\ç14, 0, %0, c6, c0, 0" : "Ù" (
˛kcfg
) );

89 
b
 = 
˛kcfg
 & (1 << 3);

91 
l
 = 
cc§
 & 0x1f;

92 
m
 = (
l
 <= 10) ? 1 : (l <= 20) ? 2 : 4;

94 
L
 = 
l
 * 
BASE_CLK
;

95 
M
 = (!
cc¸_a
Ë? (
L
/
m
Ë: ((
b
) ? L : (L/2));

97  (
M
 / 10000);

98 
	}
}

103 
	$gë_lcd˛k_‰equícy_10khz
()

105 
cc§
;

106 
l
, 
L
, 
k
, 
K
;

108 
cc§
 = 
CCSR
;

110 
l
 = 
cc§
 & 0x1f;

111 
k
 = (
l
 <= 7) ? 1 : (l <= 16) ? 2 : 4;

113 
L
 = 
l
 * 
BASE_CLK
;

114 
K
 = 
L
 / 
k
;

116  (
K
 / 10000);

117 
	}
}

119 
EXPORT_SYMBOL
(
gë_˛k_‰equícy_khz
);

120 
EXPORT_SYMBOL
(
gë_mem˛k_‰equícy_10khz
);

121 
EXPORT_SYMBOL
(
gë_lcd˛k_‰equícy_10khz
);

123 #ifde‡
CONFIG_PM


125 
	$pxa_˝u_pm_¥ï¨e
(
su•íd_°©e_t
 
°©e
)

127 
°©e
) {

128 
PM_SUSPEND_MEM
:

129 
PM_SUSPEND_STANDBY
:

132  -
EINVAL
;

134 
	}
}

136 
	$pxa_˝u_pm_íãr
(
su•íd_°©e_t
 
°©e
)

138 
	`pxa_˝u_°™dby
();

139 
	`pxa_˝u_su•íd
();

140 
	`pxa_˝u_ªsume
();

142 i‡(
°©e
 =
PM_SUSPEND_STANDBY
)

143 
CKEN
 = (1 << 
CKEN_MEMC
Ë| (1 << 
CKEN_OSTIMER
Ë| (1 << 
CKEN_LCD
Ë| (1 << 
CKEN_PWM0
);

145 
CKEN
 = (1 << 
CKEN_MEMC
Ë| (1 << 
CKEN_OSTIMER
);

148 
PCFR
 &~
PCFR_FVC
;

151 
PEDR
 = 0xDF12FE1B;

153 
°©e
) {

154 
PM_SUSPEND_STANDBY
:

155 
	`pxa_˝u_°™dby
();

157 
PM_SUSPEND_MEM
:

159 
PSPR
 = 
	`vút_to_phys
(
pxa_˝u_ªsume
);

160 
	`pxa_˝u_su•íd
(
PWRMODE_SLEEP
);

163 
	}
}

171 
u64
 
	gpxa27x_dmamask
 = 0xffffffffUL;

173 
ªsour˚
 
	gpxa27x_ohci_ªsour˚s
[] = {

175 .
°¨t
 = 0x4C000000,

176 .
	gíd
 = 0x4C00ff6f,

177 .
	gÊags
 = 
IORESOURCE_MEM
,

180 .
°¨t
 = 
IRQ_USBH1
,

181 .
	gíd
 = 
IRQ_USBH1
,

182 .
	gÊags
 = 
IORESOURCE_IRQ
,

186 
∂©f‹m_devi˚
 
	gohci_devi˚
 = {

187 .
«me
 = "pxa27x-ohci",

188 .
	gid
 = -1,

189 .
	gdev
 = {

190 .
dma_mask
 = &
pxa27x_dmamask
,

191 .
	gcohîít_dma_mask
 = 0xffffffff,

193 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
pxa27x_ohci_ªsour˚s
),

194 .
	gªsour˚
 = 
pxa27x_ohci_ªsour˚s
,

197 
__öô
 
	$pxa_£t_ohci_öfo
(
pxaohci_∂©f‹m_d©a
 *
öfo
)

199 
ohci_devi˚
.
dev
.
∂©f‹m_d©a
 = 
öfo
;

200 
	}
}

202 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

203 &
ohci_devi˚
,

206 
__öô
 
	$pxa27x_öô
()

208  
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

209 
	}
}

211 
subsys_öôˇŒ
(
pxa27x_öô
);

	@arch/arm/mach-pxa/sharpsl.h

10 
	~<asm/h¨dw¨e/sh¨p¶_pm.h
>

15 
	sc‹gis•_machöfo
 {

16 
	mp‹t
;

17 
	mcs_lcdc⁄
;

18 
	mcs_ads7846
;

19 
	mcs_max1111
;

20 
	m˛k_lcdc⁄
;

21 
	m˛k_ads7846
;

22 
	m˛k_max1111
;

25 
c‹gi_s•_£t_machöfo
(
c‹gis•_machöfo
 *
machöfo
);

31 
c‹gi_bl_£t_öãnsôy
(
öãnsôy
);

32 
•ôz_bl_£t_öãnsôy
(
öãnsôy
);

33 
akôa_bl_£t_öãnsôy
(
öãnsôy
);

39 
c‹gi_gë_hsync_Àn
();

40 
•ôz_gë_hsync_Àn
();

41 
c‹gi_put_hsync
();

42 
•ôz_put_hsync
();

43 
c‹gi_waô_hsync
();

44 
•ôz_waô_hsync
();

51 
	#READ_GPIO_BIT
(
x
Ë(
	`GPLR
(xË& 
	`GPIO_bô
(x))

	)

54 
	#MAX1111_BATT_VOLT
 4u

	)

55 
	#MAX1111_BATT_TEMP
 2u

	)

56 
	#MAX1111_ACIN_VOLT
 6u

	)

58 
b©ãry_thªsh
 
•ôz_b©ãry_Àvñs_acö
[];

59 
b©ãry_thªsh
 
•ôz_b©ãry_Àvñs_nﬂc
[];

60 
sh¨p¶_pm_pxa_öô
();

61 
sh¨p¶_pm_pxa_ªmove
();

62 
sh¨p¶_pm_pxa_ªad_max1111
(
ch™√l
);

	@arch/arm/mach-pxa/sharpsl_pm.c

15 #unde‡
DEBUG


17 
	~<löux/moduÀ.h
>

18 
	~<löux/öô.h
>

19 
	~<löux/kî√l.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/úq.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/≠m-emuœti⁄.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/mach-ty≥s.h
>

27 
	~<asm/¨ch/pm.h
>

28 
	~<asm/¨ch/pxa-ªgs.h
>

29 
	~<asm/¨ch/sh¨p¶.h
>

30 
	~"sh¨p¶.h
"

32 
b©ãry_thªsh
 
	g•ôz_b©ãry_Àvñs_acö
[] = {

75 
b©ãry_thªsh
 
	g•ôz_b©ãry_Àvñs_nﬂc
[] = {

119 
	#MAXCTRL_PD0
 1u << 0

	)

120 
	#MAXCTRL_PD1
 1u << 1

	)

121 
	#MAXCTRL_SGL
 1u << 2

	)

122 
	#MAXCTRL_UNI
 1u << 3

	)

123 
	#MAXCTRL_SEL_SH
 4

	)

124 
	#MAXCTRL_STR
 1u << 7

	)

129 
	$sh¨p¶_pm_pxa_ªad_max1111
(
ch™√l
)

131 i‡(
	`machöe_is_toß
())

134  
	`c‹gi_s•_max1111_gë
((
ch™√l
 << 
MAXCTRL_SEL_SH
Ë| 
MAXCTRL_PD0
 | 
MAXCTRL_PD1


135 | 
MAXCTRL_SGL
 | 
MAXCTRL_UNI
 | 
MAXCTRL_STR
);

136 
	}
}

138 
	$sh¨p¶_pm_pxa_öô
()

140 
	`pxa_gpio_mode
(
sh¨p¶_pm
.
machöfo
->
gpio_acö
 | 
GPIO_IN
);

141 
	`pxa_gpio_mode
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
 | 
GPIO_IN
);

142 
	`pxa_gpio_mode
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
 | 
GPIO_IN
);

145 i‡(
	`ªque°_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_acö
), 
sh¨p¶_ac_i§
, 
IRQF_DISABLED
, "AC Input Detect", sharpsl_ac_isr)) {

146 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "CouldÇŸ gë irq %d.\n", 
	`IRQ_GPIO
(sh¨p¶_pm.
machöfo
->
gpio_acö
));

148 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_acö
),
IRQT_BOTHEDGE
);

150 i‡(
	`ªque°_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
), 
sh¨p¶_Áèl_i§
, 
IRQF_DISABLED
, "Battery Cover", sharpsl_fatal_isr)) {

151 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "CouldÇŸ gë irq %d.\n", 
	`IRQ_GPIO
(sh¨p¶_pm.
machöfo
->
gpio_b©lock
));

153 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
),
IRQT_FALLING
);

155 i‡(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
) {

156 i‡(
	`ªque°_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
), 
sh¨p¶_Áèl_i§
, 
IRQF_DISABLED
, "Fatal Battery", sharpsl_fatal_isr)) {

157 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "CouldÇŸ gë irq %d.\n", 
	`IRQ_GPIO
(sh¨p¶_pm.
machöfo
->
gpio_Áèl
));

159 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
),
IRQT_FALLING
);

162 i‡(
sh¨p¶_pm
.
machöfo
->
b©fuŒ_úq
)

165 i‡(
	`ªque°_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
), 
sh¨p¶_chrg_fuŒ_i§
, 
IRQF_DISABLED
, "CO", sharpsl_chrg_full_isr)) {

166 
	`dev_îr
(
sh¨p¶_pm
.
dev
, "CouldÇŸ gë irq %d.\n", 
	`IRQ_GPIO
(sh¨p¶_pm.
machöfo
->
gpio_b©fuŒ
));

168 
	`£t_úq_ty≥
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
),
IRQT_RISING
);

170 
	}
}

172 
	$sh¨p¶_pm_pxa_ªmove
()

174 
	`‰ì_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_acö
), 
sh¨p¶_ac_i§
);

175 
	`‰ì_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
), 
sh¨p¶_Áèl_i§
);

177 i‡(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
)

178 
	`‰ì_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
), 
sh¨p¶_Áèl_i§
);

180 i‡(
sh¨p¶_pm
.
machöfo
->
b©fuŒ_úq
)

181 
	`‰ì_úq
(
	`IRQ_GPIO
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
), 
sh¨p¶_chrg_fuŒ_i§
);

182 
	}
}

	@arch/arm/mach-pxa/spitz.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/dñay.h
>

19 
	~<löux/maj‹.h
>

20 
	~<löux/fs.h
>

21 
	~<löux/öãºu±.h
>

22 
	~<löux/mmc/ho°.h
>

23 
	~<löux/pm.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/mem‹y.h
>

27 
	~<asm/mach-ty≥s.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/io.h
>

31 
	~<asm/sy°em.h
>

33 
	~<asm/mach/¨ch.h
>

34 
	~<asm/mach/m≠.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/pxa-ªgs.h
>

38 
	~<asm/¨ch/úda.h
>

39 
	~<asm/¨ch/mmc.h
>

40 
	~<asm/¨ch/ohci.h
>

41 
	~<asm/¨ch/udc.h
>

42 
	~<asm/¨ch/pxafb.h
>

43 
	~<asm/¨ch/akôa.h
>

44 
	~<asm/¨ch/•ôz.h
>

45 
	~<asm/¨ch/sh¨p¶.h
>

47 
	~<asm/mach/sh¨p¶_∑øm.h
>

48 
	~<asm/h¨dw¨e/sco›.h
>

50 
	~"gíîic.h
"

51 
	~"sh¨p¶.h
"

56 
ªsour˚
 
	g•ôz_sco›_ªsour˚s
[] = {

58 .
°¨t
 = 0x10800000,

59 .
	gíd
 = 0x10800fff,

60 .
	gÊags
 = 
IORESOURCE_MEM
,

64 
sco›_c⁄fig
 
	g•ôz_sco›_£tup
 = {

65 .
io_dú
 = 
SPITZ_SCP_IO_DIR
,

66 .
	gio_out
 = 
SPITZ_SCP_IO_OUT
,

67 .
	gsu•íd_˛r
 = 
SPITZ_SCP_SUS_CLR
,

68 .
	gsu•íd_£t
 = 
SPITZ_SCP_SUS_SET
,

71 
∂©f‹m_devi˚
 
	g•ôzsco›_devi˚
 = {

72 .
«me
 = "sharp-scoop",

73 .
	gid
 = 0,

74 .
	gdev
 = {

75 .
∂©f‹m_d©a
 = &
•ôz_sco›_£tup
,

77 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•ôz_sco›_ªsour˚s
),

78 .
	gªsour˚
 = 
•ôz_sco›_ªsour˚s
,

84 
ªsour˚
 
	g•ôz_sco›2_ªsour˚s
[] = {

86 .
°¨t
 = 0x08800040,

87 .
	gíd
 = 0x08800fff,

88 .
	gÊags
 = 
IORESOURCE_MEM
,

92 
sco›_c⁄fig
 
	g•ôz_sco›2_£tup
 = {

93 .
io_dú
 = 
SPITZ_SCP2_IO_DIR
,

94 .
	gio_out
 = 
SPITZ_SCP2_IO_OUT
,

95 .
	gsu•íd_˛r
 = 
SPITZ_SCP2_SUS_CLR
,

96 .
	gsu•íd_£t
 = 
SPITZ_SCP2_SUS_SET
,

99 
∂©f‹m_devi˚
 
	g•ôzsco›2_devi˚
 = {

100 .
«me
 = "sharp-scoop",

101 .
	gid
 = 1,

102 .
	gdev
 = {

103 .
∂©f‹m_d©a
 = &
•ôz_sco›2_£tup
,

105 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•ôz_sco›2_ªsour˚s
),

106 .
	gªsour˚
 = 
•ôz_sco›2_ªsour˚s
,

109 
	#SPITZ_PWR_SD
 0x01

	)

110 
	#SPITZ_PWR_CF
 0x02

	)

113 
	$•ôz_ˇrd_pwr_˘æ
(
devi˚
, 
√w_˝r
)

115 
˝r
 = 
	`ªad_sco›_ªg
(&
•ôzsco›_devi˚
.
dev
, 
SCOOP_CPR
);

117 i‡(
√w_˝r
 & 0x0007) {

118 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_CF_POWER
);

119 i‡(!(
˝r
 & 0x0002) && !(cpr & 0x0004))

120 
	`mdñay
(5);

121 i‡(
devi˚
 =
SPITZ_PWR_CF
)

122 
˝r
 |= 0x0002;

123 i‡(
devi˚
 =
SPITZ_PWR_SD
)

124 
˝r
 |= 0x0004;

125 
	`wrôe_sco›_ªg
(&
•ôzsco›_devi˚
.
dev
, 
SCOOP_CPR
, 
˝r
 | 
√w_˝r
);

127 i‡(
devi˚
 =
SPITZ_PWR_CF
)

128 
˝r
 &= ~0x0002;

129 i‡(
devi˚
 =
SPITZ_PWR_SD
)

130 
˝r
 &= ~0x0004;

131 i‡(!(
˝r
 & 0x0002) && !(cpr & 0x0004)) {

132 
	`wrôe_sco›_ªg
(&
•ôzsco›_devi˚
.
dev
, 
SCOOP_CPR
, 0x0000);

133 
	`mdñay
(1);

134 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_CF_POWER
);

136 
	`wrôe_sco›_ªg
(&
•ôzsco›_devi˚
.
dev
, 
SCOOP_CPR
, 
˝r
 | 
√w_˝r
);

139 
	}
}

141 
	$•ôz_pcmcü_öô
()

145 
	`GPSR
(
GPIO48_nPOE
Ë
	`GPIO_bô
(GPIO48_nPOE) |

146 
	`GPIO_bô
(
GPIO49_nPWE
Ë| GPIO_bô(
GPIO50_nPIOR
) |

147 
	`GPIO_bô
(
GPIO51_nPIOW
Ë| GPIO_bô(
GPIO54_nPCE_2
);

148 
	`GPSR
(
GPIO85_nPCE_1
Ë
	`GPIO_bô
(GPIO85_nPCE_1);

150 
	`pxa_gpio_mode
(
GPIO48_nPOE_MD
);

151 
	`pxa_gpio_mode
(
GPIO49_nPWE_MD
);

152 
	`pxa_gpio_mode
(
GPIO50_nPIOR_MD
);

153 
	`pxa_gpio_mode
(
GPIO51_nPIOW_MD
);

154 
	`pxa_gpio_mode
(
GPIO55_nPREG_MD
);

155 
	`pxa_gpio_mode
(
GPIO56_nPWAIT_MD
);

156 
	`pxa_gpio_mode
(
GPIO57_nIOIS16_MD
);

157 
	`pxa_gpio_mode
(
GPIO85_nPCE_1_MD
);

158 
	`pxa_gpio_mode
(
GPIO54_nPCE_2_MD
);

159 
	`pxa_gpio_mode
(
GPIO104_pSKTSEL_MD
);

160 
	}
}

162 
	$•ôz_pcmcü_pwr
(
devi˚
 *
sco›
, 
˝r
, 
ƒ
)

165 i‡(
ƒ
 == 0)

166 
	`•ôz_ˇrd_pwr_˘æ
(
SPITZ_PWR_CF
, 
˝r
);

168 
	`wrôe_sco›_ªg
(
sco›
, 
SCOOP_CPR
, 
˝r
);

169 
	}
}

171 
sco›_pcmcü_dev
 
	g•ôz_pcmcü_sco›
[] = {

173 .
dev
 = &
•ôzsco›_devi˚
.dev,

174 .
	gúq
 = 
SPITZ_IRQ_GPIO_CF_IRQ
,

175 .
	gcd_úq
 = 
SPITZ_IRQ_GPIO_CF_CD
,

176 .
	gcd_úq_°r
 = "PCMCIA0 CD",

178 .
	gdev
 = &
•ôzsco›2_devi˚
.
dev
,

179 .
	gúq
 = 
SPITZ_IRQ_GPIO_CF2_IRQ
,

180 .
	gcd_úq
 = -1,

184 
sco›_pcmcü_c⁄fig
 
	g•ôz_pcmcü_c⁄fig
 = {

185 .
devs
 = &
•ôz_pcmcü_sco›
[0],

186 .
	gnum_devs
 = 2,

187 .
	gpcmcü_öô
 = 
•ôz_pcmcü_öô
,

188 .
	gpowî_˘æ
 = 
•ôz_pcmcü_pwr
,

191 
EXPORT_SYMBOL
(
•ôzsco›_devi˚
);

192 
EXPORT_SYMBOL
(
•ôzsco›2_devi˚
);

202 
∂©f‹m_devi˚
 
	g•ôzs•_devi˚
 = {

203 .
«me
 = "corgi-ssp",

204 .
	gdev
 = {

205 .
∑ª¡
 = &
•ôzsco›_devi˚
.
dev
,

207 .
	gid
 = -1,

210 
c‹gis•_machöfo
 
	g•ôz_s•_machöfo
 = {

211 .
p‹t
 = 2,

212 .
	gcs_lcdc⁄
 = 
SPITZ_GPIO_LCDCON_CS
,

213 .
	gcs_ads7846
 = 
SPITZ_GPIO_ADS7846_CS
,

214 .
	gcs_max1111
 = 
SPITZ_GPIO_MAX1111_CS
,

215 .
	g˛k_lcdc⁄
 = 520,

216 .
	g˛k_ads7846
 = 14,

217 .
	g˛k_max1111
 = 56,

224 
c‹gibl_machöfo
 
	g•ôz_bl_machöfo
 = {

225 .
deÁu…_öãnsôy
 = 0x1f,

226 .
	glimô_mask
 = 0x0b,

227 .
	gmax_öãnsôy
 = 0x2f,

230 
∂©f‹m_devi˚
 
	g•ôzbl_devi˚
 = {

231 .
«me
 = "corgi-bl",

232 .
	gdev
 = {

233 .
∂©f‹m_d©a
 = &
•ôz_bl_machöfo
,

235 .
	gid
 = -1,

242 
∂©f‹m_devi˚
 
	g•ôzkbd_devi˚
 = {

243 .
«me
 = "spitz-keyboard",

244 .
	gid
 = -1,

251 
∂©f‹m_devi˚
 
	g•ôzÀd_devi˚
 = {

252 .
«me
 = "spitz-led",

253 .
	gid
 = -1,

259 
ªsour˚
 
	g•ôzts_ªsour˚s
[] = {

261 .
°¨t
 = 
SPITZ_IRQ_GPIO_TP_INT
,

262 .
	gíd
 = 
SPITZ_IRQ_GPIO_TP_INT
,

263 .
	gÊags
 = 
IORESOURCE_IRQ
,

267 
c‹gôs_machöfo
 
	g•ôz_ts_machöfo
 = {

268 .
gë_hsync_Àn
 = 
•ôz_gë_hsync_Àn
,

269 .
	gput_hsync
 = 
•ôz_put_hsync
,

270 .
	gwaô_hsync
 = 
•ôz_waô_hsync
,

273 
∂©f‹m_devi˚
 
	g•ôzts_devi˚
 = {

274 .
«me
 = "corgi-ts",

275 .
	gdev
 = {

276 .
∑ª¡
 = &
•ôzs•_devi˚
.
dev
,

277 .
	g∂©f‹m_d©a
 = &
•ôz_ts_machöfo
,

279 .
	gid
 = -1,

280 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
•ôzts_ªsour˚s
),

281 .
	gªsour˚
 = 
•ôzts_ªsour˚s
,

292 
pxamci_∂©f‹m_d©a
 
	g•ôz_mci_∂©f‹m_d©a
;

294 
	$•ôz_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
•ôz_dëe˘_öt
, *
d©a
)

296 
îr
;

299 
	`pxa_gpio_mode
(
GPIO32_MMCCLK_MD
);

300 
	`pxa_gpio_mode
(
GPIO112_MMCCMD_MD
);

301 
	`pxa_gpio_mode
(
GPIO92_MMCDAT0_MD
);

302 
	`pxa_gpio_mode
(
GPIO109_MMCDAT1_MD
);

303 
	`pxa_gpio_mode
(
GPIO110_MMCDAT2_MD
);

304 
	`pxa_gpio_mode
(
GPIO111_MMCDAT3_MD
);

305 
	`pxa_gpio_mode
(
SPITZ_GPIO_nSD_DETECT
 | 
GPIO_IN
);

306 
	`pxa_gpio_mode
(
SPITZ_GPIO_nSD_WP
 | 
GPIO_IN
);

308 
•ôz_mci_∂©f‹m_d©a
.
dëe˘_dñay
 = 
	`m£cs_to_jiffõs
(250);

310 
îr
 = 
	`ªque°_úq
(
SPITZ_IRQ_GPIO_nSD_DETECT
, 
•ôz_dëe˘_öt
,

311 
IRQF_DISABLED
 | 
IRQF_TRIGGER_RISING
 | 
IRQF_TRIGGER_FALLING
,

312 "MMC c¨d dëe˘", 
d©a
);

313 i‡(
îr
) {

314 
	`¥ötk
(
KERN_ERR
 "spitz_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

319 
	}
}

321 
	$•ôz_mci_£çowî
(
devi˚
 *
dev
, 
vdd
)

323 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

325 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
)

326 
	`•ôz_ˇrd_pwr_˘æ
(
SPITZ_PWR_SD
, 0x0004);

328 
	`•ôz_ˇrd_pwr_˘æ
(
SPITZ_PWR_SD
, 0x0000);

329 
	}
}

331 
	$•ôz_mci_gë_ro
(
devi˚
 *
dev
)

333  
	`GPLR
(
SPITZ_GPIO_nSD_WP
Ë& 
	`GPIO_bô
(SPITZ_GPIO_nSD_WP);

334 
	}
}

336 
	$•ôz_mci_exô
(
devi˚
 *
dev
, *
d©a
)

338 
	`‰ì_úq
(
SPITZ_IRQ_GPIO_nSD_DETECT
, 
d©a
);

339 
	}
}

341 
pxamci_∂©f‹m_d©a
 
	g•ôz_mci_∂©f‹m_d©a
 = {

342 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

343 .
	göô
 = 
•ôz_mci_öô
,

344 .
	ggë_ro
 = 
•ôz_mci_gë_ro
,

345 .
	g£çowî
 = 
•ôz_mci_£çowî
,

346 .
	gexô
 = 
•ôz_mci_exô
,

353 
	$•ôz_ohci_öô
(
devi˚
 *
dev
)

356 
	`pxa_gpio_mode
(
SPITZ_GPIO_USB_CONNECT
 | 
GPIO_IN
);

357 
	`pxa_gpio_mode
(
SPITZ_GPIO_USB_HOST
 | 
GPIO_OUT
);

358 
	`pxa_gpio_mode
(
SPITZ_GPIO_USB_DEVICE
 | 
GPIO_IN
);

361 
UP2OCR
 = 
UP2OCR_HXS
 | 
UP2OCR_HXOE
 | 
UP2OCR_DPPDE
 | 
UP2OCR_DMPDE
;

363 
	`GPSR
(
SPITZ_GPIO_USB_HOST
Ë
	`GPIO_bô
(SPITZ_GPIO_USB_HOST);

365 
UHCHR
 = (UHCHR) &

366 ~(
UHCHR_SSEP1
 | 
UHCHR_SSEP2
 | 
UHCHR_SSEP3
 | 
UHCHR_SSE
);

368 
UHCRHDA
 |
UHCRHDA_NOCP
;

371 
	}
}

373 
pxaohci_∂©f‹m_d©a
 
	g•ôz_ohci_∂©f‹m_d©a
 = {

374 .
p‹t_mode
 = 
PMM_NPS_MODE
,

375 .
	göô
 = 
•ôz_ohci_öô
,

376 .
	gpowî_budgë
 = 150,

383 
	$•ôz_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

385 i‡(
mode
 & 
IR_OFF
)

386 
	`£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_IR_ON
);

388 
	`ª£t_sco›_gpio
(&
•ôzsco›2_devi˚
.
dev
, 
SPITZ_SCP2_IR_ON
);

389 
	}
}

391 #ifde‡
CONFIG_MACH_AKITA


392 
	$akôa_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

394 i‡(
mode
 & 
IR_OFF
)

395 
	`akôa_£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_IR_ON
);

397 
	`akôa_ª£t_i€xp
(&
akôai€xp_devi˚
.
dev
, 
AKITA_IOEXP_IR_ON
);

398 
	}
}

401 
pxafi˝_∂©f‹m_d©a
 
	g•ôz_fi˝_∂©f‹m_d©a
 = {

402 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_OFF
,

403 .
	gå™s˚ivî_mode
 = 
•ôz_úda_å™s˚ivî_mode
,

411 
pxafb_mode_öfo
 
	g•ôz_pxafb_modes
[] = {

413 .
pix˛ock
 = 19231,

414 .
	gxªs
 = 480,

415 .
	gyªs
 = 640,

416 .
	gbµ
 = 16,

417 .
	ghsync_Àn
 = 40,

418 .
	gÀ·_m¨gö
 = 46,

419 .
	gright_m¨gö
 = 125,

420 .
	gvsync_Àn
 = 3,

421 .
	guµî_m¨gö
 = 1,

422 .
	glowî_m¨gö
 = 0,

423 .
	gsync
 = 0,

425 .
	gpix˛ock
 = 134617,

426 .
	gxªs
 = 240,

427 .
	gyªs
 = 320,

428 .
	gbµ
 = 16,

429 .
	ghsync_Àn
 = 20,

430 .
	gÀ·_m¨gö
 = 20,

431 .
	gright_m¨gö
 = 46,

432 .
	gvsync_Àn
 = 2,

433 .
	guµî_m¨gö
 = 1,

434 .
	glowî_m¨gö
 = 0,

435 .
	gsync
 = 0,

439 
pxafb_mach_öfo
 
	g•ôz_pxafb_öfo
 = {

440 .
modes
 = &
•ôz_pxafb_modes
[0],

441 .
	gnum_modes
 = 2,

442 .
	gfixed_modes
 = 1,

443 .
	glc¸0
 = 
LCCR0_Cﬁ‹
 | 
LCCR0_Sngl
 | 
LCCR0_A˘
 | 
LCCR0_LDDALT
 | 
LCCR0_OUC
 | 
LCCR0_CMDIM
 | 
LCCR0_RDSTM
,

444 .
	glc¸3
 = 
LCCR3_PixRsEdg
 | 
LCCR3_OutEnH
,

445 .
	gpxafb_lcd_powî
 = 
•ôz_lcd_powî
,

449 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

450 &
•ôzsco›_devi˚
,

451 &
•ôzs•_devi˚
,

452 &
•ôzkbd_devi˚
,

453 &
•ôzts_devi˚
,

454 &
•ôzbl_devi˚
,

455 &
•ôzÀd_devi˚
,

458 
	$•ôz_powîoff
()

460 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

462 
	`pxa_gpio_mode
(
SPITZ_GPIO_ON_RESET
 | 
GPIO_OUT
);

463 
	`GPSR
(
SPITZ_GPIO_ON_RESET
Ë
	`GPIO_bô
(SPITZ_GPIO_ON_RESET);

465 
	`mdñay
(1000);

466 
	`¨m_machöe_ª°¨t
('h');

467 
	}
}

469 
	$•ôz_ª°¨t
(
mode
)

472 if((
MSC0
 & 0xffff0000) == 0x7ff00000)

473 
MSC0
 = (MSC0 & 0xffff) | 0x7ee00000;

475 
	`•ôz_powîoff
();

476 
	}
}

478 
__öô
 
	$comm⁄_öô
()

480 
pm_powî_off
 = 
•ôz_powîoff
;

481 
¨m_pm_ª°¨t
 = 
•ôz_ª°¨t
;

483 
PMCR
 = 0x00;

486 
PWER
 = 0x00000002;

487 
PFER
 = 0x00000000;

488 
PRER
 = 0x00000002;

489 
PGSR0
 = 0x0158C000;

490 
PGSR1
 = 0x00FF0080;

491 
PGSR2
 = 0x0001C004;

494 
PCFR
 |
PCFR_OPDE
;

496 
	`c‹gi_s•_£t_machöfo
(&
•ôz_s•_machöfo
);

498 
	`pxa_gpio_mode
(
SPITZ_GPIO_HSYNC
 | 
GPIO_IN
);

500 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

501 
	`pxa_£t_mci_öfo
(&
•ôz_mci_∂©f‹m_d©a
);

502 
	`pxa_£t_ohci_öfo
(&
•ôz_ohci_∂©f‹m_d©a
);

503 
	`pxa_£t_fi˝_öfo
(&
•ôz_fi˝_∂©f‹m_d©a
);

504 
	`£t_pxa_fb_∑ª¡
(&
•ôzs•_devi˚
.
dev
);

505 
	`£t_pxa_fb_öfo
(&
•ôz_pxafb_öfo
);

506 
	}
}

508 
__öô
 
	$•ôz_öô
()

510 
∂©f‹m_sco›_c⁄fig
 = &
•ôz_pcmcü_c⁄fig
;

512 
•ôz_bl_machöfo
.
£t_bl_öãnsôy
 = 
•ôz_bl_£t_öãnsôy
;

514 
	`comm⁄_öô
();

516 
	`∂©f‹m_devi˚_ªgi°î
(&
•ôzsco›2_devi˚
);

517 
	}
}

519 #ifde‡
CONFIG_MACH_AKITA


523 
∂©f‹m_devi˚
 
	gakôai€xp_devi˚
 = {

524 .
«me
 = "akita-ioexp",

525 .
	gid
 = -1,

528 
EXPORT_SYMBOL_GPL
(
akôai€xp_devi˚
);

530 
__öô
 
	$akôa_öô
()

532 
•ôz_fi˝_∂©f‹m_d©a
.
å™s˚ivî_mode
 = 
akôa_úda_å™s˚ivî_mode
;

535 
•ôz_pcmcü_c⁄fig
.
num_devs
 = 1;

536 
∂©f‹m_sco›_c⁄fig
 = &
•ôz_pcmcü_c⁄fig
;

537 
•ôz_bl_machöfo
.
£t_bl_öãnsôy
 = 
akôa_bl_£t_öãnsôy
;

539 
	`∂©f‹m_devi˚_ªgi°î
(&
akôai€xp_devi˚
);

541 
•ôzsco›_devi˚
.
dev
.
∑ª¡
 = &
akôai€xp_devi˚
.dev;

542 
	`comm⁄_öô
();

543 
	}
}

547 
__öô
 
	$fixup_•ôz
(
machöe_desc
 *
desc
,

548 
èg
 *
ègs
, **
cmdlöe
, 
memöfo
 *
mi
)

550 
	`sh¨p¶_ßve_∑øm
();

551 
mi
->
ƒ_b™ks
 = 1;

552 
mi
->
b™k
[0].
°¨t
 = 0xa0000000;

553 
mi
->
b™k
[0].
node
 = 0;

554 
mi
->
b™k
[0].
size
 = (64*1024*1024);

555 
	}
}

557 #ifde‡
CONFIG_MACH_SPITZ


558 
MACHINE_START
(
SPITZ
, "SHARP Spitz")

559 .
	gphys_io
 = 0x40000000,

560 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

561 .
	gfixup
 = 
fixup_•ôz
,

562 .
	gm≠_io
 = 
pxa_m≠_io
,

563 .
	göô_úq
 = 
pxa_öô_úq
,

564 .
	göô_machöe
 = 
•ôz_öô
,

565 .
	gtimî
 = &
pxa_timî
,

566 
	gMACHINE_END


569 #ifde‡
CONFIG_MACH_BORZOI


570 
MACHINE_START
(
BORZOI
, "SHARP Borzoi")

571 .
	gphys_io
 = 0x40000000,

572 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

573 .
	gfixup
 = 
fixup_•ôz
,

574 .
	gm≠_io
 = 
pxa_m≠_io
,

575 .
	göô_úq
 = 
pxa_öô_úq
,

576 .
	göô_machöe
 = 
•ôz_öô
,

577 .
	gtimî
 = &
pxa_timî
,

578 
	gMACHINE_END


581 #ifde‡
CONFIG_MACH_AKITA


582 
MACHINE_START
(
AKITA
, "SHARP Akita")

583 .
	gphys_io
 = 0x40000000,

584 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

585 .
	gfixup
 = 
fixup_•ôz
,

586 .
	gm≠_io
 = 
pxa_m≠_io
,

587 .
	göô_úq
 = 
pxa_öô_úq
,

588 .
	göô_machöe
 = 
akôa_öô
,

589 .
	gtimî
 = &
pxa_timî
,

590 
	gMACHINE_END


	@arch/arm/mach-pxa/spitz_pm.c

12 
	~<löux/moduÀ.h
>

13 
	~<löux/°©.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/kî√l.h
>

16 
	~<löux/dñay.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/∂©f‹m_devi˚.h
>

19 
	~<löux/≠m-emuœti⁄.h
>

21 
	~<asm/úq.h
>

22 
	~<asm/mach-ty≥s.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/h¨dw¨e/sco›.h
>

26 
	~<asm/¨ch/sh¨p¶.h
>

27 
	~<asm/¨ch/•ôz.h
>

28 
	~<asm/¨ch/pxa-ªgs.h
>

29 
	~"sh¨p¶.h
"

31 
	#SHARPSL_CHARGE_ON_VOLT
 0x99

	)

32 
	#SHARPSL_CHARGE_ON_TEMP
 0xe0

	)

33 
	#SHARPSL_CHARGE_ON_ACIN_HIGH
 0x9b

	)

34 
	#SHARPSL_CHARGE_ON_ACIN_LOW
 0x34

	)

35 
	#SHARPSL_FATAL_ACIN_VOLT
 182

	)

36 
	#SHARPSL_FATAL_NOACIN_VOLT
 170

	)

38 
	g•ôz_œ°_ac_°©us
;

40 
	$•ôz_ch¨gî_öô
()

42 
	`pxa_gpio_mode
(
SPITZ_GPIO_KEY_INT
 | 
GPIO_IN
);

43 
	`pxa_gpio_mode
(
SPITZ_GPIO_SYNC
 | 
GPIO_IN
);

44 
	`sh¨p¶_pm_pxa_öô
();

45 
	}
}

47 
	$•ôz_mósuª_ãmp
(
⁄
)

49 i‡(
⁄
)

50 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_ADC_TEMP_ON
);

52 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_ADC_TEMP_ON
);

53 
	}
}

55 
	$•ôz_ch¨ge
(
⁄
)

57 i‡(
⁄
) {

58 i‡(
sh¨p¶_pm
.
Êags
 & 
SHARPSL_SUSPENDED
) {

59 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_JK_B
);

60 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_CHRG_ON
);

62 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_JK_B
);

63 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_CHRG_ON
);

66 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_JK_B
);

67 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_CHRG_ON
);

69 
	}
}

71 
	$•ôz_disch¨ge
(
⁄
)

73 i‡(
⁄
)

74 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_JK_A
);

76 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_JK_A
);

77 
	}
}

81 
	$•ôz_disch¨ge1
(
⁄
)

83 i‡(
⁄
)

84 
	`£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_LED_GREEN
);

86 
	`ª£t_sco›_gpio
(&
•ôzsco›_devi˚
.
dev
, 
SPITZ_SCP_LED_GREEN
);

87 
	}
}

89 
	$•ôz_¥esu•íd
()

91 
•ôz_œ°_ac_°©us
 = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
);

94 
PGSR0
 = 0x00144018;

95 
PGSR1
 = 0x00EF0000;

96 i‡(
	`machöe_is_akôa
()) {

97 
PGSR2
 = 0x2121C000;

98 
PGSR3
 = 0x00600400;

100 
PGSR2
 = 0x0121C000;

101 
PGSR3
 = 0x00600000;

104 
PGSR0
 &~
SPITZ_GPIO_G0_STROBE_BIT
;

105 
PGSR1
 &~
SPITZ_GPIO_G1_STROBE_BIT
;

106 
PGSR2
 &~
SPITZ_GPIO_G2_STROBE_BIT
;

107 
PGSR3
 &~
SPITZ_GPIO_G3_STROBE_BIT
;

108 
PGSR2
 |
	`GPIO_bô
(
SPITZ_GPIO_KEY_STROBE0
);

110 
	`pxa_gpio_mode
(
GPIO18_RDY
|
GPIO_OUT
 | 
GPIO_DFLT_HIGH
);

112 
PRER
 = 
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
);

113 
PFER
 = 
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
Ë| GPIO_bô(
SPITZ_GPIO_RESET
);

114 
PWER
 = 
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
Ë| GPIO_bô(
SPITZ_GPIO_RESET
Ë| 
PWER_RTC
;

115 
PKWR
 = 
	`GPIO_bô
(
SPITZ_GPIO_SYNC
Ë| GPIO_bô(
SPITZ_GPIO_KEY_INT
Ë| GPIO_bô(
SPITZ_GPIO_RESET
);

116 
PKSR
 = 0xffffffff;

119 
PSLR
 |
PSLR_SL_ROD
;

122 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

125 
PCFR
 = 
PCFR_GPR_EN
 | 
PCFR_OPDE
;

126 
	}
}

128 
	$•ôz_po°su•íd
()

130 
	`pxa_gpio_mode
(
GPIO18_RDY_MD
);

131 
	`pxa_gpio_mode
(10 | 
GPIO_IN
);

132 
	}
}

134 
	$•ôz_should_wakeup
(
ªsume_⁄_Æ¨m
)

136 
is_ªsume
 = 0;

137 
acö
 = 
sh¨p¶_pm
.
machöfo
->
	`ªad_devd©a
(
SHARPSL_STATUS_ACIN
);

139 i‡(
•ôz_œ°_ac_°©us
 !
acö
) {

140 i‡(
acö
) {

142 
sh¨p¶_pm
.
Êags
 |
SHARPSL_DO_OFFLINE_CHRG
;

143 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "AC Inserted\n");

146 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "AC Removed\n");

147 
	`sh¨p¶_pm_Àd
(
SHARPSL_LED_OFF
);

148 
sh¨p¶_pm
.
machöfo
->
	`ch¨ge
(0);

149 
sh¨p¶_pm
.
ch¨ge_mode
 = 
CHRG_OFF
;

151 
•ôz_œ°_ac_°©us
 = 
acö
;

156 i‡(
PEDR
 & 
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
))

157 
is_ªsume
 |
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
);

159 i‡(
PKSR
 & 
	`GPIO_bô
(
SPITZ_GPIO_SYNC
))

160 
is_ªsume
 |
	`GPIO_bô
(
SPITZ_GPIO_SYNC
);

162 i‡(
ªsume_⁄_Æ¨m
 && (
PEDR
 & 
PWER_RTC
))

163 
is_ªsume
 |
PWER_RTC
;

165 
	`dev_dbg
(
sh¨p¶_pm
.
dev
, "is_ªsume: %x\n",
is_ªsume
);

166  
is_ªsume
;

167 
	}
}

169 
	$•ôz_ch¨gî_wakeup
()

171  (~
GPLR0
 & 
	`GPIO_bô
(
SPITZ_GPIO_KEY_INT
)Ë| (GPLR0 & GPIO_bô(
SPITZ_GPIO_SYNC
));

172 
	}
}

174 
	$•ôzpm_ªad_devd©a
(
ty≥
)

176 
ty≥
) {

177 
SHARPSL_STATUS_ACIN
:

178  (((~
	`GPLR
(
SPITZ_GPIO_AC_IN
)Ë& 
	`GPIO_bô
(SPITZ_GPIO_AC_IN)) != 0);

179 
SHARPSL_STATUS_LOCK
:

180  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_b©lock
);

181 
SHARPSL_STATUS_CHRGFULL
:

182  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_b©fuŒ
);

183 
SHARPSL_STATUS_FATAL
:

184  
	`READ_GPIO_BIT
(
sh¨p¶_pm
.
machöfo
->
gpio_Áèl
);

185 
SHARPSL_ACIN_VOLT
:

186  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_ACIN_VOLT
);

187 
SHARPSL_BATT_TEMP
:

188  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_BATT_TEMP
);

189 
SHARPSL_BATT_VOLT
:

191  
	`sh¨p¶_pm_pxa_ªad_max1111
(
MAX1111_BATT_VOLT
);

193 
	}
}

195 
sh¨p¶_ch¨gî_machöfo
 
	g•ôz_pm_machöfo
 = {

196 .
öô
 = 
•ôz_ch¨gî_öô
,

197 .
	gexô
 = 
sh¨p¶_pm_pxa_ªmove
,

198 .
	ggpio_b©lock
 = 
SPITZ_GPIO_BAT_COVER
,

199 .
	ggpio_acö
 = 
SPITZ_GPIO_AC_IN
,

200 .
	ggpio_b©fuŒ
 = 
SPITZ_GPIO_CHRG_FULL
,

201 .
	gb©fuŒ_úq
 = 1,

202 .
	ggpio_Áèl
 = 
SPITZ_GPIO_FATAL_BAT
,

203 .
	gdisch¨ge
 = 
•ôz_disch¨ge
,

204 .
	gdisch¨ge1
 = 
•ôz_disch¨ge1
,

205 .
	gch¨ge
 = 
•ôz_ch¨ge
,

206 .
	gmósuª_ãmp
 = 
•ôz_mósuª_ãmp
,

207 .
	g¥esu•íd
 = 
•ôz_¥esu•íd
,

208 .
	gpo°su•íd
 = 
•ôz_po°su•íd
,

209 .
	gªad_devd©a
 = 
•ôzpm_ªad_devd©a
,

210 .
	gch¨gî_wakeup
 = 
•ôz_ch¨gî_wakeup
,

211 .
	gshould_wakeup
 = 
•ôz_should_wakeup
,

212 .
	gbacklight_limô
 = 
c‹gibl_limô_öãnsôy
,

213 .
	gch¨ge_⁄_vﬁt
 = 
SHARPSL_CHARGE_ON_VOLT
,

214 .
	gch¨ge_⁄_ãmp
 = 
SHARPSL_CHARGE_ON_TEMP
,

215 .
	gch¨ge_acö_high
 = 
SHARPSL_CHARGE_ON_ACIN_HIGH
,

216 .
	gch¨ge_acö_low
 = 
SHARPSL_CHARGE_ON_ACIN_LOW
,

217 .
	gÁèl_acö_vﬁt
 = 
SHARPSL_FATAL_ACIN_VOLT
,

218 .
	gÁèl_nﬂcö_vﬁt

SHARPSL_FATAL_NOACIN_VOLT
,

219 .
	gb©_Àvñs
 = 40,

220 .
	gb©_Àvñs_nﬂc
 = 
•ôz_b©ãry_Àvñs_nﬂc
,

221 .
	gb©_Àvñs_acö
 = 
•ôz_b©ãry_Àvñs_acö
,

222 .
	g°©us_high_acö
 = 188,

223 .
	g°©us_low_acö
 = 178,

224 .
	g°©us_high_nﬂc
 = 185,

225 .
	g°©us_low_nﬂc
 = 175,

228 
∂©f‹m_devi˚
 *
	g•ôzpm_devi˚
;

230 
__devöô
 
	$•ôzpm_öô
()

232 
ªt
;

234 
•ôzpm_devi˚
 = 
	`∂©f‹m_devi˚_Æloc
("sharpsl-pm", -1);

235 i‡(!
•ôzpm_devi˚
)

236  -
ENOMEM
;

238 
•ôzpm_devi˚
->
dev
.
∂©f‹m_d©a
 = &
•ôz_pm_machöfo
;

239 
ªt
 = 
	`∂©f‹m_devi˚_add
(
•ôzpm_devi˚
);

241 i‡(
ªt
)

242 
	`∂©f‹m_devi˚_put
(
•ôzpm_devi˚
);

244  
ªt
;

245 
	}
}

247 
	$•ôzpm_exô
()

249 
	`∂©f‹m_devi˚_uƒegi°î
(
•ôzpm_devi˚
);

250 
	}
}

252 
moduÀ_öô
(
•ôzpm_öô
);

253 
moduÀ_exô
(
•ôzpm_exô
);

	@arch/arm/mach-pxa/ssp.c

26 
	~<löux/moduÀ.h
>

27 
	~<löux/kî√l.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/¶ab.h
>

30 
	~<löux/î∫o.h
>

31 
	~<löux/öãºu±.h
>

32 
	~<löux/i›‹t.h
>

33 
	~<löux/öô.h
>

34 
	~<löux/muãx.h
>

35 
	~<asm/io.h
>

36 
	~<asm/úq.h
>

37 
	~<asm/h¨dw¨e.h
>

38 
	~<asm/¨ch/s•.h
>

39 
	~<asm/¨ch/pxa-ªgs.h
>

41 
	#PXA_SSP_PORTS
 3

	)

43 
	#TIMEOUT
 100000

	)

45 
	ss•_öfo_
 {

46 
	múq
;

47 
u32
 
	m˛ock
;

53 c⁄° 
s•_öfo_
 
	gs•_öfo
[
PXA_SSP_PORTS
] = {

54 #i‡
deföed
 (
CONFIG_PXA27x
)

55 {
IRQ_SSP
, 
CKEN_SSP1
},

56 {
IRQ_SSP2
, 
CKEN_SSP2
},

57 {
IRQ_SSP3
, 
CKEN_SSP3
},

59 {
IRQ_SSP
, 
CKEN_SSP
},

60 {
IRQ_NSSP
, 
CKEN_NSSP
},

61 {
IRQ_ASSP
, 
CKEN_ASSP
},

65 
DEFINE_MUTEX
(
muãx
);

66 
	gu£_cou¡
[
PXA_SSP_PORTS
] = {0, 0, 0};

68 
úqªtu∫_t
 
	$s•_öãºu±
(
úq
, *
dev_id
)

70 
s•_dev
 *
dev
 = (s•_dev*Ë
dev_id
;

71 
°©us
 = 
	`SSSR_P
(
dev
->
p‹t
);

73 
	`SSSR_P
(
dev
->
p‹t
Ë
°©us
;

75 i‡(
°©us
 & 
SSSR_ROR
)

76 
	`¥ötk
(
KERN_WARNING
 "SSP(%d):Ñe˚ivî ovîrun\n", 
dev
->
p‹t
);

78 i‡(
°©us
 & 
SSSR_TUR
)

79 
	`¥ötk
(
KERN_WARNING
 "SSP(%d):Åønsmôã∏undîrun\n", 
dev
->
p‹t
);

81 i‡(
°©us
 & 
SSSR_BCE
)

82 
	`¥ötk
(
KERN_WARNING
 "SSP(%d): bô cou¡Éº‹\n", 
dev
->
p‹t
);

84  
IRQ_HANDLED
;

85 
	}
}

100 
	$s•_wrôe_w‹d
(
s•_dev
 *
dev
, 
u32
 
d©a
)

102 
timeout
 = 
TIMEOUT
;

104 !(
	`SSSR_P
(
dev
->
p‹t
Ë& 
SSSR_TNF
)) {

105 i‡(!--
timeout
)

106  -
ETIMEDOUT
;

107 
	`˝u_ªœx
();

110 
	`SSDR_P
(
dev
->
p‹t
Ë
d©a
;

113 
	}
}

130 
	$s•_ªad_w‹d
(
s•_dev
 *
dev
, 
u32
 *
d©a
)

132 
timeout
 = 
TIMEOUT
;

134 !(
	`SSSR_P
(
dev
->
p‹t
Ë& 
SSSR_RNE
)) {

135 i‡(!--
timeout
)

136  -
ETIMEDOUT
;

137 
	`˝u_ªœx
();

140 *
d©a
 = 
	`SSDR_P
(
dev
->
p‹t
);

142 
	}
}

152 
	$s•_Êush
(
s•_dev
 *
dev
)

154 
timeout
 = 
TIMEOUT
 * 2;

157 
	`SSSR_P
(
dev
->
p‹t
Ë& 
SSSR_RNE
) {

158 i‡(!--
timeout
)

159  -
ETIMEDOUT
;

160 (Ë
	`SSDR_P
(
dev
->
p‹t
);

162 i‡(!--
timeout
)

163  -
ETIMEDOUT
;

164 } 
	`SSSR_P
(
dev
->
p‹t
Ë& 
SSSR_BSY
);

167 
	}
}

174 
	$s•_íabÀ
(
s•_dev
 *
dev
)

176 
	`SSCR0_P
(
dev
->
p‹t
Ë|
SSCR0_SSE
;

177 
	}
}

184 
	$s•_dißbÀ
(
s•_dev
 *
dev
)

186 
	`SSCR0_P
(
dev
->
p‹t
Ë&~
SSCR0_SSE
;

187 
	}
}

195 
	$s•_ßve_°©e
(
s•_dev
 *
dev
, 
s•_°©e
 *
s•
)

197 
s•
->
¸0
 = 
	`SSCR0_P
(
dev
->
p‹t
);

198 
s•
->
¸1
 = 
	`SSCR1_P
(
dev
->
p‹t
);

199 
s•
->
to
 = 
	`SSTO_P
(
dev
->
p‹t
);

200 
s•
->
p•
 = 
	`SSPSP_P
(
dev
->
p‹t
);

202 
	`SSCR0_P
(
dev
->
p‹t
Ë&~
SSCR0_SSE
;

203 
	}
}

211 
	$s•_ª°‹e_°©e
(
s•_dev
 *
dev
, 
s•_°©e
 *
s•
)

213 
	`SSSR_P
(
dev
->
p‹t
Ë
SSSR_ROR
 | 
SSSR_TUR
 | 
SSSR_BCE
;

215 
	`SSCR0_P
(
dev
->
p‹t
Ë
s•
->
¸0
 & ~
SSCR0_SSE
;

216 
	`SSCR1_P
(
dev
->
p‹t
Ë
s•
->
¸1
;

217 
	`SSTO_P
(
dev
->
p‹t
Ë
s•
->
to
;

218 
	`SSPSP_P
(
dev
->
p‹t
Ë
s•
->
p•
;

220 
	`SSCR0_P
(
dev
->
p‹t
Ë
s•
->
¸0
;

221 
	}
}

232 
	$s•_c⁄fig
(
s•_dev
 *
dev
, 
u32
 
mode
, u32 
Êags
, u32 
p•_Êags
, u32 
•ìd
)

234 
dev
->
mode
 = mode;

235 
dev
->
Êags
 = flags;

236 
dev
->
p•_Êags
 =Ösp_flags;

237 
dev
->
•ìd
 = speed;

240 
	`SSCR0_P
(
dev
->
p‹t
Ë(dev->
•ìd
 | dev->
mode
);

241 
	`SSCR1_P
(
dev
->
p‹t
Ëdev->
Êags
;

242 
	`SSPSP_P
(
dev
->
p‹t
Ëdev->
p•_Êags
;

245 
	}
}

257 
	$s•_öô
(
s•_dev
 *
dev
, 
u32
 
p‹t
, u32 
öô_Êags
)

259 
ªt
;

261 i‡(
p‹t
 > 
PXA_SSP_PORTS
 ||Öort == 0)

262  -
ENODEV
;

264 
	`muãx_lock
(&
muãx
);

265 i‡(
u£_cou¡
[
p‹t
 - 1]) {

266 
	`muãx_u∆ock
(&
muãx
);

267  -
EBUSY
;

269 
u£_cou¡
[
p‹t
 - 1]++;

271 i‡(!
	`ªque°_mem_ªgi⁄
(
	`__PREG
(
	`SSCR0_P
(
p‹t
)), 0x2c, "SSP")) {

272 
u£_cou¡
[
p‹t
 - 1]--;

273 
	`muãx_u∆ock
(&
muãx
);

274  -
EBUSY
;

276 
dev
->
p‹t
 =Öort;

279 i‡(!(
öô_Êags
 & 
SSP_NO_IRQ
)) {

280 
ªt
 = 
	`ªque°_úq
(
s•_öfo
[
p‹t
-1].
úq
, 
s•_öãºu±
,

281 0, "SSP", 
dev
);

282 i‡(
ªt
)

283 
out_ªgi⁄
;

284 
dev
->
úq
 = 
s•_öfo
[
p‹t
-1].irq;

286 
dev
->
úq
 = 0;

289 
	`pxa_£t_ckí
(
s•_öfo
[
p‹t
-1].
˛ock
, 1);

290 
	`muãx_u∆ock
(&
muãx
);

293 
out_ªgi⁄
:

294 
	`ªÀa£_mem_ªgi⁄
(
	`__PREG
(
	`SSCR0_P
(
p‹t
)), 0x2c);

295 
u£_cou¡
[
p‹t
 - 1]--;

296 
	`muãx_u∆ock
(&
muãx
);

297  
ªt
;

298 
	}
}

305 
	$s•_exô
(
s•_dev
 *
dev
)

307 
	`muãx_lock
(&
muãx
);

308 
	`SSCR0_P
(
dev
->
p‹t
Ë&~
SSCR0_SSE
;

310 i‡(
dev
->
p‹t
 > 
PXA_SSP_PORTS
 || dev->port == 0) {

311 
	`¥ötk
(
KERN_WARNING
 "SSP:ÅriedÅo close invalidÖort\n");

315 
	`pxa_£t_ckí
(
s•_öfo
[
dev
->
p‹t
-1].
˛ock
, 0);

316 i‡(
dev
->
úq
)

317 
	`‰ì_úq
(
dev
->
úq
, dev);

318 
	`ªÀa£_mem_ªgi⁄
(
	`__PREG
(
	`SSCR0_P
(
dev
->
p‹t
)), 0x2c);

319 
u£_cou¡
[
dev
->
p‹t
 - 1]--;

320 
	`muãx_u∆ock
(&
muãx
);

321 
	}
}

323 
EXPORT_SYMBOL
(
s•_wrôe_w‹d
);

324 
EXPORT_SYMBOL
(
s•_ªad_w‹d
);

325 
EXPORT_SYMBOL
(
s•_Êush
);

326 
EXPORT_SYMBOL
(
s•_íabÀ
);

327 
EXPORT_SYMBOL
(
s•_dißbÀ
);

328 
EXPORT_SYMBOL
(
s•_ßve_°©e
);

329 
EXPORT_SYMBOL
(
s•_ª°‹e_°©e
);

330 
EXPORT_SYMBOL
(
s•_öô
);

331 
EXPORT_SYMBOL
(
s•_exô
);

332 
EXPORT_SYMBOL
(
s•_c⁄fig
);

334 
MODULE_DESCRIPTION
("PXA SSP driver");

335 
MODULE_AUTHOR
("Liam Girdwood");

336 
MODULE_LICENSE
("GPL");

	@arch/arm/mach-pxa/time.c

13 
	~<löux/kî√l.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/öãºu±.h
>

17 
	~<löux/time.h
>

18 
	~<löux/sig«l.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/˛ocksour˚.h
>

23 
	~<asm/sy°em.h
>

24 
	~<asm/h¨dw¨e.h
>

25 
	~<asm/io.h
>

26 
	~<asm/Àds.h
>

27 
	~<asm/úq.h
>

28 
	~<asm/mach/úq.h
>

29 
	~<asm/mach/time.h
>

30 
	~<asm/¨ch/pxa-ªgs.h
>

33 
ölöe
 
	$pxa_gë_πc_time
()

35  
RCNR
;

36 
	}
}

38 
	$pxa_£t_πc
()

40 
cuºít_time
 = 
xtime
.
tv_£c
;

42 i‡(
RTSR
 & 
RTSR_ALE
) {

44 
Æ¨m
 = 
RTAR
;

45 i‡(
cuºít_time
 >
Æ¨m
 &&áœrm >
RCNR
)

46  -
ERESTARTSYS
;

48 
RCNR
 = 
cuºít_time
;

50 
	}
}

52 #ifde‡
CONFIG_NO_IDLE_HZ


53 
	göôül_m©ch
;

54 
	gm©ch_po•⁄ed
;

57 
úqªtu∫_t


58 
	$pxa_timî_öãºu±
(
úq
, *
dev_id
)

60 
√xt_m©ch
;

62 
	`wrôe_£qlock
(&
xtime_lock
);

64 #ifde‡
CONFIG_NO_IDLE_HZ


65 i‡(
m©ch_po•⁄ed
) {

66 
m©ch_po•⁄ed
 = 0;

67 
OSMR0
 = 
öôül_m©ch
;

88 
	`timî_tick
();

89 
OSSR
 = 
OSSR_M0
;

90 
√xt_m©ch
 = (
OSMR0
 +
LATCH
);

91 }  (sig√d )(
√xt_m©ch
 - 
OSCR
) <= 8 );

93 
	`wrôe_£qu∆ock
(&
xtime_lock
);

95  
IRQ_HANDLED
;

96 
	}
}

98 
úqa˘i⁄
 
	gpxa_timî_úq
 = {

99 .
«me
 = "PXA Timer Tick",

100 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

101 .
	gh™dÀr
 = 
pxa_timî_öãºu±
,

104 
cy˛e_t
 
	$pxa_gë_cy˛es
()

106  
OSCR
;

107 
	}
}

109 
˛ocksour˚
 
	g˛ocksour˚_pxa
 = {

110 .
«me
 = "pxa_timer",

111 .
	gøtög
 = 200,

112 .
	gªad
 = 
pxa_gë_cy˛es
,

113 .
	gmask
 = 
CLOCKSOURCE_MASK
(32),

114 .
	gshi·
 = 20,

115 .
	gÊags
 = 
CLOCK_SOURCE_IS_CONTINUOUS
,

118 
__öô
 
	$pxa_timî_öô
()

120 
time•ec
 
tv
;

121 
Êags
;

123 
£t_πc
 = 
pxa_£t_πc
;

125 
tv
.
tv_n£c
 = 0;

126 
tv
.
tv_£c
 = 
	`pxa_gë_πc_time
();

127 
	`do_£âimeofday
(&
tv
);

129 
OIER
 = 0;

130 
OSSR
 = 0xf;

131 
	`£tup_úq
(
IRQ_OST0
, &
pxa_timî_úq
);

132 
	`loˇl_úq_ßve
(
Êags
);

133 
OIER
 = 
OIER_E0
;

134 
OSMR0
 = 
OSCR
 + 
LATCH
;

135 
	`loˇl_úq_ª°‹e
(
Êags
);

141 
˛ocksour˚_pxa
.
mu…
 =

142 
	`˛ocksour˚_hz2mu…
(
CLOCK_TICK_RATE
, 
˛ocksour˚_pxa
.
shi·
);

143 
	`˛ocksour˚_ªgi°î
(&
˛ocksour˚_pxa
);

144 
	}
}

146 #ifde‡
CONFIG_NO_IDLE_HZ


147 
	$pxa_dyn_tick_íabÀ_dißbÀ
()

151 
	}
}

153 
	$pxa_dyn_tick_ª¥ogøm
(
ticks
)

155 i‡(
ticks
 > 1) {

156 
öôül_m©ch
 = 
OSMR0
;

157 
OSMR0
 = 
öôül_m©ch
 + 
ticks
 * 
LATCH
;

158 
m©ch_po•⁄ed
 = 1;

160 
	}
}

162 
úqªtu∫_t


163 
	$pxa_dyn_tick_h™dÀr
(
úq
, *
dev_id
)

165 i‡(
m©ch_po•⁄ed
) {

166 
m©ch_po•⁄ed
 = 0;

167 
OSMR0
 = 
öôül_m©ch
;

168 i‡–(sig√d )(
öôül_m©ch
 - 
OSCR
) <= 8 )

169  
	`pxa_timî_öãºu±
(
úq
, 
dev_id
);

171  
IRQ_NONE
;

172 
	}
}

174 
dyn_tick_timî
 
	gpxa_dyn_tick
 = {

175 .
íabÀ
 = 
pxa_dyn_tick_íabÀ_dißbÀ
,

176 .
	gdißbÀ
 = 
pxa_dyn_tick_íabÀ_dißbÀ
,

177 .
	gª¥ogøm
 = 
pxa_dyn_tick_ª¥ogøm
,

178 .
	gh™dÀr
 = 
pxa_dyn_tick_h™dÀr
,

182 #ifde‡
CONFIG_PM


183 
	gosmr
[4], 
	goõr
;

185 
	$pxa_timî_su•íd
()

187 
osmr
[0] = 
OSMR0
;

188 
osmr
[1] = 
OSMR1
;

189 
osmr
[2] = 
OSMR2
;

190 
osmr
[3] = 
OSMR3
;

191 
oõr
 = 
OIER
;

192 
	}
}

194 
	$pxa_timî_ªsume
()

196 
OSMR0
 = 
osmr
[0];

197 
OSMR1
 = 
osmr
[1];

198 
OSMR2
 = 
osmr
[2];

199 
OSMR3
 = 
osmr
[3];

200 
OIER
 = 
oõr
;

205 
OSCR
 = 
OSMR0
 - 
LATCH
;

206 
	}
}

208 
	#pxa_timî_su•íd
 
NULL


	)

209 
	#pxa_timî_ªsume
 
NULL


	)

212 
sys_timî
 
	gpxa_timî
 = {

213 .
öô
 = 
pxa_timî_öô
,

214 .
	gsu•íd
 = 
pxa_timî_su•íd
,

215 .
	gªsume
 = 
pxa_timî_ªsume
,

216 #ifde‡
CONFIG_NO_IDLE_HZ


217 .
	gdyn_tick
 = &
pxa_dyn_tick
,

	@arch/arm/mach-pxa/tosa.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/maj‹.h
>

19 
	~<löux/fs.h
>

20 
	~<löux/öãºu±.h
>

21 
	~<löux/mmc/ho°.h
>

22 
	~<löux/pm.h
>

23 
	~<löux/dñay.h
>

25 
	~<asm/£tup.h
>

26 
	~<asm/mem‹y.h
>

27 
	~<asm/mach-ty≥s.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/sy°em.h
>

31 
	~<asm/¨ch/pxa-ªgs.h
>

32 
	~<asm/¨ch/úda.h
>

33 
	~<asm/¨ch/mmc.h
>

34 
	~<asm/¨ch/udc.h
>

36 
	~<asm/mach/¨ch.h
>

37 
	~<asm/mach/m≠.h
>

38 
	~<asm/mach/úq.h
>

39 
	~<asm/¨ch/toß.h
>

41 
	~<asm/h¨dw¨e/sco›.h
>

42 
	~<asm/mach/sh¨p¶_∑øm.h
>

44 
	~"gíîic.h
"

50 
ªsour˚
 
	gtoß_sco›_ªsour˚s
[] = {

52 .
°¨t
 = 
TOSA_CF_PHYS
,

53 .
	gíd
 = 
TOSA_CF_PHYS
 + 0xfff,

54 .
	gÊags
 = 
IORESOURCE_MEM
,

58 
sco›_c⁄fig
 
	gtoß_sco›_£tup
 = {

59 .
io_dú
 = 
TOSA_SCOOP_IO_DIR
,

60 .
	gio_out
 = 
TOSA_SCOOP_IO_OUT
,

64 
∂©f‹m_devi˚
 
	gtoßsco›_devi˚
 = {

65 .
«me
 = "sharp-scoop",

66 .
	gid
 = 0,

67 .
	gdev
 = {

68 .
∂©f‹m_d©a
 = &
toß_sco›_£tup
,

70 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
toß_sco›_ªsour˚s
),

71 .
	gªsour˚
 = 
toß_sco›_ªsour˚s
,

78 
ªsour˚
 
	gtoß_sco›_jc_ªsour˚s
[] = {

80 .
°¨t
 = 
TOSA_SCOOP_PHYS
 + 0x40,

81 .
	gíd
 = 
TOSA_SCOOP_PHYS
 + 0xfff,

82 .
	gÊags
 = 
IORESOURCE_MEM
,

86 
sco›_c⁄fig
 
	gtoß_sco›_jc_£tup
 = {

87 .
io_dú
 = 
TOSA_SCOOP_JC_IO_DIR
,

88 .
	gio_out
 = 
TOSA_SCOOP_JC_IO_OUT
,

91 
∂©f‹m_devi˚
 
	gtoßsco›_jc_devi˚
 = {

92 .
«me
 = "sharp-scoop",

93 .
	gid
 = 1,

94 .
	gdev
 = {

95 .
∂©f‹m_d©a
 = &
toß_sco›_jc_£tup
,

96 .
	g∑ª¡
 = &
toßsco›_devi˚
.
dev
,

98 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
toß_sco›_jc_ªsour˚s
),

99 .
	gªsour˚
 = 
toß_sco›_jc_ªsour˚s
,

105 
sco›_pcmcü_dev
 
	gtoß_pcmcü_sco›
[] = {

107 .
dev
 = &
toßsco›_devi˚
.dev,

108 .
	gúq
 = 
TOSA_IRQ_GPIO_CF_IRQ
,

109 .
	gcd_úq
 = 
TOSA_IRQ_GPIO_CF_CD
,

110 .
	gcd_úq_°r
 = "PCMCIA0 CD",

112 .
	gdev
 = &
toßsco›_jc_devi˚
.
dev
,

113 .
	gúq
 = 
TOSA_IRQ_GPIO_JC_CF_IRQ
,

114 .
	gcd_úq
 = -1,

118 
	$toß_pcmcü_öô
()

122 
	`GPSR
(
GPIO48_nPOE
Ë
	`GPIO_bô
(GPIO48_nPOE) |

123 
	`GPIO_bô
(
GPIO49_nPWE
Ë| GPIO_bô(
GPIO50_nPIOR
) |

124 
	`GPIO_bô
(
GPIO51_nPIOW
Ë| GPIO_bô(
GPIO52_nPCE_1
) |

125 
	`GPIO_bô
(
GPIO53_nPCE_2
);

127 
	`pxa_gpio_mode
(
GPIO48_nPOE_MD
);

128 
	`pxa_gpio_mode
(
GPIO49_nPWE_MD
);

129 
	`pxa_gpio_mode
(
GPIO50_nPIOR_MD
);

130 
	`pxa_gpio_mode
(
GPIO51_nPIOW_MD
);

131 
	`pxa_gpio_mode
(
GPIO55_nPREG_MD
);

132 
	`pxa_gpio_mode
(
GPIO56_nPWAIT_MD
);

133 
	`pxa_gpio_mode
(
GPIO57_nIOIS16_MD
);

134 
	`pxa_gpio_mode
(
GPIO52_nPCE_1_MD
);

135 
	`pxa_gpio_mode
(
GPIO53_nPCE_2_MD
);

136 
	`pxa_gpio_mode
(
GPIO54_pSKTSEL_MD
);

137 
	}
}

139 
sco›_pcmcü_c⁄fig
 
	gtoß_pcmcü_c⁄fig
 = {

140 .
devs
 = &
toß_pcmcü_sco›
[0],

141 .
	gnum_devs
 = 2,

142 .
	gpcmcü_öô
 = 
toß_pcmcü_öô
,

148 
	$toß_udc_comm™d
(
cmd
)

150 
cmd
) {

151 
PXA2XX_UDC_CMD_CONNECT
:

152 
	`£t_sco›_gpio
(&
toßsco›_jc_devi˚
.
dev
,
TOSA_SCOOP_JC_USB_PULLUP
);

154 
PXA2XX_UDC_CMD_DISCONNECT
:

155 
	`ª£t_sco›_gpio
(&
toßsco›_jc_devi˚
.
dev
,
TOSA_SCOOP_JC_USB_PULLUP
);

158 
	}
}

160 
	$toß_udc_is_c⁄√˘ed
()

162  ((
	`GPLR
(
TOSA_GPIO_USB_IN
Ë& 
	`GPIO_bô
(TOSA_GPIO_USB_IN)) == 0);

163 
	}
}

166 
pxa2xx_udc_mach_öfo
 
udc_öfo
 
	g__öôd©a
 = {

167 .
udc_comm™d
 = 
toß_udc_comm™d
,

168 .
	gudc_is_c⁄√˘ed
 = 
toß_udc_is_c⁄√˘ed
,

174 
pxamci_∂©f‹m_d©a
 
	gtoß_mci_∂©f‹m_d©a
;

176 
	$toß_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
toß_dëe˘_öt
, *
d©a
)

178 
îr
;

181 
	`pxa_gpio_mode
(
GPIO6_MMCCLK_MD
);

182 
	`pxa_gpio_mode
(
GPIO8_MMCCS0_MD
);

183 
	`pxa_gpio_mode
(
TOSA_GPIO_nSD_DETECT
 | 
GPIO_IN
);

185 
toß_mci_∂©f‹m_d©a
.
dëe˘_dñay
 = 
	`m£cs_to_jiffõs
(250);

187 
îr
 = 
	`ªque°_úq
(
TOSA_IRQ_GPIO_nSD_DETECT
, 
toß_dëe˘_öt
, 
IRQF_DISABLED
,

188 "MMC/SD c¨d dëe˘", 
d©a
);

189 i‡(
îr
) {

190 
	`¥ötk
(
KERN_ERR
 "tosa_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

194 
	`£t_úq_ty≥
(
TOSA_IRQ_GPIO_nSD_DETECT
, 
IRQT_BOTHEDGE
);

197 
	}
}

199 
	$toß_mci_£çowî
(
devi˚
 *
dev
, 
vdd
)

201 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

203 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
) {

204 
	`£t_sco›_gpio
(&
toßsco›_devi˚
.
dev
,
TOSA_SCOOP_PWR_ON
);

206 
	`ª£t_sco›_gpio
(&
toßsco›_devi˚
.
dev
,
TOSA_SCOOP_PWR_ON
);

208 
	}
}

210 
	$toß_mci_gë_ro
(
devi˚
 *
dev
)

212  (
	`ªad_sco›_ªg
(&
toßsco›_devi˚
.
dev
, 
SCOOP_GPWR
)&
TOSA_SCOOP_SD_WP
);

213 
	}
}

215 
	$toß_mci_exô
(
devi˚
 *
dev
, *
d©a
)

217 
	`‰ì_úq
(
TOSA_IRQ_GPIO_nSD_DETECT
, 
d©a
);

218 
	}
}

220 
pxamci_∂©f‹m_d©a
 
	gtoß_mci_∂©f‹m_d©a
 = {

221 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

222 .
	göô
 = 
toß_mci_öô
,

223 .
	ggë_ro
 = 
toß_mci_gë_ro
,

224 .
	g£çowî
 = 
toß_mci_£çowî
,

225 .
	gexô
 = 
toß_mci_exô
,

231 
	$toß_úda_å™s˚ivî_mode
(
devi˚
 *
dev
, 
mode
)

233 i‡(
mode
 & 
IR_OFF
) {

234 
	`ª£t_sco›_gpio
(&
toßsco›_devi˚
.
dev
,
TOSA_SCOOP_IR_POWERDWN
);

235 
	`pxa_gpio_mode
(
GPIO47_STTXD
|
GPIO_DFLT_LOW
);

236 
	`pxa_gpio_mode
(
GPIO47_STTXD
|
GPIO_OUT
);

238 
	`pxa_gpio_mode
(
GPIO47_STTXD_MD
);

239 
	`£t_sco›_gpio
(&
toßsco›_devi˚
.
dev
,
TOSA_SCOOP_IR_POWERDWN
);

241 
	}
}

243 
pxafi˝_∂©f‹m_d©a
 
	gtoß_fi˝_∂©f‹m_d©a
 = {

244 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_OFF
,

245 .
	gå™s˚ivî_mode
 = 
toß_úda_å™s˚ivî_mode
,

251 
∂©f‹m_devi˚
 
	gtoßkbd_devi˚
 = {

252 .
«me
 = "tosa-keyboard",

253 .
	gid
 = -1,

259 
∂©f‹m_devi˚
 
	gtoßÀd_devi˚
 = {

260 .
«me
 = "tosa-led",

261 .
	gid
 = -1,

264 
∂©f‹m_devi˚
 *
	gdevi˚s
[] 
	g__öôd©a
 = {

265 &
toßsco›_devi˚
,

266 &
toßsco›_jc_devi˚
,

267 &
toßkbd_devi˚
,

268 &
toßÀd_devi˚
,

271 
	$toß_powîoff
()

273 
RCSR
 = 
RCSR_HWR
 | 
RCSR_WDR
 | 
RCSR_SMR
 | 
RCSR_GPR
;

275 
	`pxa_gpio_mode
(
TOSA_GPIO_ON_RESET
 | 
GPIO_OUT
);

276 
	`GPSR
(
TOSA_GPIO_ON_RESET
Ë
	`GPIO_bô
(TOSA_GPIO_ON_RESET);

278 
	`mdñay
(1000);

279 
	`¨m_machöe_ª°¨t
('h');

280 
	}
}

282 
	$toß_ª°¨t
(
mode
)

285 if((
MSC0
 & 0xffff0000) == 0x7ff00000)

286 
MSC0
 = (MSC0 & 0xffff) | 0x7ee00000;

288 
	`toß_powîoff
();

289 
	}
}

291 
__öô
 
	$toß_öô
()

293 
pm_powî_off
 = 
toß_powîoff
;

294 
¨m_pm_ª°¨t
 = 
toß_ª°¨t
;

296 
	`pxa_gpio_mode
(
TOSA_GPIO_ON_RESET
 | 
GPIO_IN
);

297 
	`pxa_gpio_mode
(
TOSA_GPIO_TC6393_INT
 | 
GPIO_IN
);

298 
	`pxa_gpio_mode
(
TOSA_GPIO_USB_IN
 | 
GPIO_IN
);

301 
PWER
 = 0x00000002;

302 
PFER
 = 0x00000000;

303 
PRER
 = 0x00000002;

304 
PGSR0
 = 0x00000000;

305 
PGSR1
 = 0x00FF0002;

306 
PGSR2
 = 0x00014000;

307 
PCFR
 |
PCFR_OPDE
;

310 
PMCR
 = 0x01;

312 
	`pxa_£t_mci_öfo
(&
toß_mci_∂©f‹m_d©a
);

313 
	`pxa_£t_udc_öfo
(&
udc_öfo
);

314 
	`pxa_£t_fi˝_öfo
(&
toß_fi˝_∂©f‹m_d©a
);

315 
∂©f‹m_sco›_c⁄fig
 = &
toß_pcmcü_c⁄fig
;

317 
	`∂©f‹m_add_devi˚s
(
devi˚s
, 
	`ARRAY_SIZE
(devices));

318 
	}
}

320 
__öô
 
	$fixup_toß
(
machöe_desc
 *
desc
,

321 
èg
 *
ègs
, **
cmdlöe
, 
memöfo
 *
mi
)

323 
	`sh¨p¶_ßve_∑øm
();

324 
mi
->
ƒ_b™ks
=1;

325 
mi
->
b™k
[0].
°¨t
 = 0xa0000000;

326 
mi
->
b™k
[0].
node
 = 0;

327 
mi
->
b™k
[0].
size
 = (64*1024*1024);

328 
	}
}

330 
MACHINE_START
(
TOSA
, "SHARP Tosa")

331 .
	gphys_io
 = 0x40000000,

332 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

333 .
	gfixup
 = 
fixup_toß
,

334 .
	gm≠_io
 = 
pxa_m≠_io
,

335 .
	göô_úq
 = 
pxa_öô_úq
,

336 .
	göô_machöe
 = 
toß_öô
,

337 .
	gtimî
 = &
pxa_timî
,

338 
	gMACHINE_END


	@arch/arm/mach-pxa/trizeps4.c

15 
	~<löux/öô.h
>

16 
	~<löux/kî√l.h
>

17 
	~<löux/∂©f‹m_devi˚.h
>

18 
	~<löux/sysdev.h
>

19 
	~<löux/öãºu±.h
>

20 
	~<löux/sched.h
>

21 
	~<löux/bô›s.h
>

22 
	~<löux/fb.h
>

23 
	~<löux/i›‹t.h
>

24 
	~<löux/dñay.h
>

25 
	~<löux/£rül_8250.h
>

26 
	~<löux/mtd/mtd.h
>

27 
	~<löux/mtd/physm≠.h
>

28 
	~<löux/mtd/∑πôi⁄s.h
>

30 
	~<asm/ty≥s.h
>

31 
	~<asm/£tup.h
>

32 
	~<asm/mem‹y.h
>

33 
	~<asm/mach-ty≥s.h
>

34 
	~<asm/h¨dw¨e.h
>

35 
	~<asm/úq.h
>

36 
	~<asm/sizes.h
>

38 
	~<asm/mach/¨ch.h
>

39 
	~<asm/mach/m≠.h
>

40 
	~<asm/mach/úq.h
>

41 
	~<asm/mach/Êash.h
>

43 
	~<asm/¨ch/pxa-ªgs.h
>

44 
	~<asm/¨ch/åizïs4.h
>

45 
	~<asm/¨ch/audio.h
>

46 
	~<asm/¨ch/pxafb.h
>

47 
	~<asm/¨ch/mmc.h
>

48 
	~<asm/¨ch/úda.h
>

49 
	~<asm/¨ch/ohci.h
>

51 
	~"gíîic.h
"

56 
mtd_∑πôi⁄
 
	gåizïs4_∑πôi⁄s
[] = {

58 .
«me
 = "Bootloader",

59 .
	goff£t
 = 0x00000000,

60 .
	gsize
 = 0x00040000,

61 .
	gmask_Êags
 = 
MTD_WRITEABLE


63 .
	g«me
 = "Backup",

64 .
	goff£t
 = 0x00040000,

65 .
	gsize
 = 0x00040000,

67 .
	g«me
 = "Image",

68 .
	goff£t
 = 0x00080000,

69 .
	gsize
 = 0x01080000,

71 .
	g«me
 = "IPSM",

72 .
	goff£t
 = 0x01100000,

73 .
	gsize
 = 0x00e00000,

75 .
	g«me
 = "Registry",

76 .
	goff£t
 = 0x01f00000,

77 .
	gsize
 = 
MTDPART_SIZ_FULL
,

81 
physm≠_Êash_d©a
 
	gåizïs4_Êash_d©a
[] = {

83 .
width
 = 4,

84 .
	g∑πs
 = 
åizïs4_∑πôi⁄s
,

85 .
	gƒ_∑πs
 = 
ARRAY_SIZE
(
åizïs4_∑πôi⁄s
)

89 
ªsour˚
 
	gÊash_ªsour˚
 = {

90 .
°¨t
 = 
PXA_CS0_PHYS
,

91 .
	gíd
 = 
PXA_CS0_PHYS
 + 
SZ_32M
 - 1,

92 .
	gÊags
 = 
IORESOURCE_MEM
,

95 
∂©f‹m_devi˚
 
	gÊash_devi˚
 = {

96 .
«me
 = "physmap-flash",

97 .
	gid
 = 0,

98 .
	gdev
 = {

99 .
∂©f‹m_d©a
 = 
åizïs4_Êash_d©a
,

101 .
	gªsour˚
 = &
Êash_ªsour˚
,

102 .
	gnum_ªsour˚s
 = 1,

108 
ªsour˚
 
	gdm9000_ªsour˚s
[] = {

110 .
°¨t
 = 
TRIZEPS4_ETH_PHYS
+0x300,

111 .
	gíd
 = 
TRIZEPS4_ETH_PHYS
+0x400-1,

112 .
	gÊags
 = 
IORESOURCE_MEM
,

115 .
°¨t
 = 
TRIZEPS4_ETH_PHYS
+0x8300,

116 .
	gíd
 = 
TRIZEPS4_ETH_PHYS
+0x8400-1,

117 .
	gÊags
 = 
IORESOURCE_MEM
,

120 .
°¨t
 = 
TRIZEPS4_ETH_IRQ
,

121 .
	gíd
 = 
TRIZEPS4_ETH_IRQ
,

122 .
	gÊags
 = (
IORESOURCE_IRQ
 | 
IRQT_RISING
),

126 
∂©f‹m_devi˚
 
	gdm9000_devi˚
 = {

127 .
«me
 = "dm9000",

128 .
	gid
 = -1,

129 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
dm9000_ªsour˚s
),

130 .
	gªsour˚
 = 
dm9000_ªsour˚s
,

136 
∂©_£rül8250_p‹t
 
	gåi_£rül_p‹ts
[] = {

137 #ifde‡
CONFIG_SERIAL_PXA


145 .
memba£
 = (*)&
FFUART
,

146 .
	gúq
 = 
IRQ_FFUART
,

147 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

148 .
	giŸy≥
 = 
UPIO_MEM32
,

149 .
	gªgshi·
 = 2,

150 .
	gu¨t˛k
 = (921600*16),

153 .
memba£
 = (*)&
BTUART
,

154 .
	gúq
 = 
IRQ_BTUART
,

155 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
,

156 .
	giŸy≥
 = 
UPIO_MEM32
,

157 .
	gªgshi·
 = 2,

158 .
	gu¨t˛k
 = (921600*16),

166 
∂©f‹m_devi˚
 
	gu¨t_devi˚s
 = {

167 .
«me
 = "serial8250",

168 .
	gid
 = 0,

169 .
	gdev
 = {

170 .
∂©f‹m_d©a
 = 
åi_£rül_p‹ts
,

172 .
	gnum_ªsour˚s
 = 0,

173 .
	gªsour˚
 = 
NULL
,

179 
∂©f‹m_devi˚
 
	gac97_audio_devi˚
 = {

180 .
«me
 = "pxa2xx-ac97",

181 .
	gid
 = -1,

184 
∂©f‹m_devi˚
 * 
	gåizïs4_devi˚s
[] 
	g__öôd©a
 = {

185 &
Êash_devi˚
,

186 &
u¨t_devi˚s
,

187 &
dm9000_devi˚
,

188 &
ac97_audio_devi˚
,

191 #ifde‡
CONFIG_MACH_TRIZEPS4_CONXS


192 
	gåizïs_c⁄xs_b¸
;

195 
	$bﬂrd_pcmcü_powî
(
powî
)

197 i‡(
powî
) {

199 
åizïs_c⁄xs_b¸
 |
powî
;

200 
åizïs_c⁄xs_b¸
 |
C⁄XS_BCR_CF_RESET
;

201 
åizïs_c⁄xs_b¸
 &~(
C⁄XS_BCR_CF_BUF_EN
);

202 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

204 
	`udñay
(2000);

206 
åizïs_c⁄xs_b¸
 &~(
C⁄XS_BCR_CF_RESET
);

207 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

208 
	`udñay
(2000);

211 
åizïs_c⁄xs_b¸
 |
C⁄XS_BCR_CF_RESET
;

212 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

213 
	`udñay
(1000);

215 
åizïs_c⁄xs_b¸
 &= ~(0xf);

216 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

219 
	`¥_debug
("%s: o%†0x%x\n", 
__FUNCTION__
, 
powî
 ? "n": "ff", 
åizïs_c⁄xs_b¸
);

220 
	}
}

223 
	$bﬂrd_backlight_powî
(
⁄
)

225 i‡(
⁄
) {

226 
åizïs_c⁄xs_b¸
 |
C⁄XS_BCR_L_DISP
;

228 
åizïs_c⁄xs_b¸
 &~
C⁄XS_BCR_L_DISP
;

230 
	`¥_debug
("%s: o%†0x%x\n", 
__FUNCTION__
, 
⁄
 ? "n" : "ff", 
åizïs_c⁄xs_b¸
);

231 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

232 
	}
}

235 
	$bﬂrd_mci_powî
(
devi˚
 *
dev
, 
vdd
)

237 
pxamci_∂©f‹m_d©a
* 
p_d
 = 
dev
->
∂©f‹m_d©a
;

239 i‡(–1 << 
vdd
Ë& 
p_d
->
o¸_mask
) {

240 
	`¥_debug
("%s: on\n", 
__FUNCTION__
);

243 
	`¥_debug
("%s: off\n", 
__FUNCTION__
);

246 
	}
}

248 
	gåizïs_c⁄xs_ú¸
;

251 
	$bﬂrd_úda_mode
(
devi˚
 *
dev
, 
mode
)

253 
Êags
;

255 
	`loˇl_úq_ßve
(
Êags
);

256 i‡(
mode
 & 
IR_SIRMODE
) {

258 
åizïs_c⁄xs_ú¸
 &~
C⁄XS_IRCR_MODE
;

259 } i‡(
mode
 & 
IR_FIRMODE
) {

261 
åizïs_c⁄xs_ú¸
 |
C⁄XS_IRCR_MODE
;

263 i‡(
mode
 & 
IR_OFF
) {

264 
åizïs_c⁄xs_ú¸
 |
C⁄XS_IRCR_SD
;

266 
åizïs_c⁄xs_ú¸
 &~
C⁄XS_IRCR_SD
;

269 
	`loˇl_úq_ª°‹e
(
Êags
);

270 
	}
}

274 
	$bﬂrd_pcmcü_powî
(
powî
Ë{;
	}
}

275 
	#bﬂrd_backlight_powî
 
NULL


	)

276 
	#bﬂrd_mci_powî
 
NULL


	)

277 
	#bﬂrd_úda_mode
 
NULL


	)

280 
EXPORT_SYMBOL
(
bﬂrd_pcmcü_powî
);

282 
	$åizïs4_mci_öô
(
devi˚
 *
dev
, 
úq_h™dÀr_t
 
mci_dëe˘_öt
, *
d©a
)

284 
îr
;

286 
	`pxa_gpio_mode
(
GPIO32_MMCCLK_MD
);

287 
	`pxa_gpio_mode
(
GPIO112_MMCCMD_MD
);

288 
	`pxa_gpio_mode
(
GPIO92_MMCDAT0_MD
);

289 
	`pxa_gpio_mode
(
GPIO109_MMCDAT1_MD
);

290 
	`pxa_gpio_mode
(
GPIO110_MMCDAT2_MD
);

291 
	`pxa_gpio_mode
(
GPIO111_MMCDAT3_MD
);

293 
	`pxa_gpio_mode
(
GPIO_MMC_DET
 | 
GPIO_IN
);

295 
îr
 = 
	`ªque°_úq
(
TRIZEPS4_MMC_IRQ
, 
mci_dëe˘_öt
,

296 
IRQF_DISABLED
 | 
IRQF_TRIGGER_RISING
,

297 "MMC c¨d dëe˘", 
d©a
);

298 i‡(
îr
) {

299 
	`¥ötk
(
KERN_ERR
 "trizeps4_mci_init: MMC/SD: can'tÑequest MMC card detect IRQ\n");

303 
	}
}

305 
	$åizïs4_mci_exô
(
devi˚
 *
dev
, *
d©a
)

307 
	`‰ì_úq
(
TRIZEPS4_MMC_IRQ
, 
d©a
);

308 
	}
}

310 
pxamci_∂©f‹m_d©a
 
	gåizïs4_mci_∂©f‹m_d©a
 = {

311 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

312 .
	göô
 = 
åizïs4_mci_öô
,

313 .
	gexô
 = 
åizïs4_mci_exô
,

314 .
	g£çowî
 = 
bﬂrd_mci_powî
,

317 
pxafi˝_∂©f‹m_d©a
 
	gåizïs4_fi˝_∂©f‹m_d©a
 = {

318 .
å™s˚ivî_ˇp
 = 
IR_SIRMODE
 | 
IR_FIRMODE
 | 
IR_OFF
,

319 .
	gå™s˚ivî_mode
 = 
bﬂrd_úda_mode
,

322 
	$åizïs4_ohci_öô
(
devi˚
 *
dev
)

325 
	`pxa_gpio_mode
–88 | 
GPIO_ALT_FN_1_IN
);

326 
	`pxa_gpio_mode
–89 | 
GPIO_ALT_FN_2_OUT
);

330 
UHCHR
 = (UHCHR | 
UHCHR_PCPL
 | 
UHCHR_PSPL
) &

331 ~(
UHCHR_SSEP1
 | 
UHCHR_SSEP2
 | 
UHCHR_SSEP3
 | 
UHCHR_SSE
);

334 
	}
}

336 
	$åizïs4_ohci_exô
(
devi˚
 *
dev
)

339 
	}
}

341 
pxaohci_∂©f‹m_d©a
 
	gåizïs4_ohci_∂©f‹m_d©a
 = {

342 .
p‹t_mode
 = 
PMM_PERPORT_MODE
,

343 .
	göô
 = 
åizïs4_ohci_öô
,

344 .
	gexô
 = 
åizïs4_ohci_exô
,

347 
m≠_desc
 
	gåizïs4_io_desc
[] 
	g__öôd©a
 = {

349 .
vútuÆ
 = 
TRIZEPS4_CFSR_VIRT
,

350 .
	gp‚
 = 
__phys_to_p‚
(
TRIZEPS4_CFSR_PHYS
),

351 .
	gÀngth
 = 0x00001000,

352 .
	gty≥
 = 
MT_DEVICE


355 .
	gvútuÆ
 = 
TRIZEPS4_BOCR_VIRT
,

356 .
	gp‚
 = 
__phys_to_p‚
(
TRIZEPS4_BOCR_PHYS
),

357 .
	gÀngth
 = 0x00001000,

358 .
	gty≥
 = 
MT_DEVICE


361 .
	gvútuÆ
 = 
TRIZEPS4_IRCR_VIRT
,

362 .
	gp‚
 = 
__phys_to_p‚
(
TRIZEPS4_IRCR_PHYS
),

363 .
	gÀngth
 = 0x00001000,

364 .
	gty≥
 = 
MT_DEVICE


367 .
	gvútuÆ
 = 
TRIZEPS4_DICR_VIRT
,

368 .
	gp‚
 = 
__phys_to_p‚
(
TRIZEPS4_DICR_PHYS
),

369 .
	gÀngth
 = 0x00001000,

370 .
	gty≥
 = 
MT_DEVICE


373 .
	gvútuÆ
 = 
TRIZEPS4_UPSR_VIRT
,

374 .
	gp‚
 = 
__phys_to_p‚
(
TRIZEPS4_UPSR_PHYS
),

375 .
	gÀngth
 = 0x00001000,

376 .
	gty≥
 = 
MT_DEVICE


380 
pxafb_mode_öfo
 
	gsh¨p_lcd_mode
 = {

381 .
pix˛ock
 = 78000,

382 .
	gxªs
 = 640,

383 .
	gyªs
 = 480,

384 .
	gbµ
 = 8,

385 .
	ghsync_Àn
 = 4,

386 .
	gÀ·_m¨gö
 = 4,

387 .
	gright_m¨gö
 = 4,

388 .
	gvsync_Àn
 = 2,

389 .
	guµî_m¨gö
 = 0,

390 .
	glowî_m¨gö
 = 0,

391 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

392 .
	gcm≠_gªysˇÀ
 = 0,

395 
pxafb_mach_öfo
 
	gsh¨p_lcd
 = {

396 .
modes
 = &
sh¨p_lcd_mode
,

397 .
	gnum_modes
 = 1,

398 .
	gcm≠_övî£
 = 0,

399 .
	gcm≠_°©ic
 = 0,

400 .
	glc¸0
 = 
LCCR0_Cﬁ‹
 | 
LCCR0_Pas
 | 
LCCR0_DuÆ
,

401 .
	glc¸3
 = 0x0340ff02,

402 .
	gpxafb_backlight_powî
 = 
bﬂrd_backlight_powî
,

405 
pxafb_mode_öfo
 
	gtoshiba_lcd_mode
 = {

406 .
pix˛ock
 = 39720,

407 .
	gxªs
 = 640,

408 .
	gyªs
 = 480,

409 .
	gbµ
 = 8,

410 .
	ghsync_Àn
 = 63,

411 .
	gÀ·_m¨gö
 = 12,

412 .
	gright_m¨gö
 = 12,

413 .
	gvsync_Àn
 = 4,

414 .
	guµî_m¨gö
 = 32,

415 .
	glowî_m¨gö
 = 10,

416 .
	gsync
 = 0,

417 .
	gcm≠_gªysˇÀ
 = 0,

420 
pxafb_mach_öfo
 
	gtoshiba_lcd
 = {

421 .
modes
 = &
toshiba_lcd_mode
,

422 .
	gnum_modes
 = 1,

423 .
	gcm≠_övî£
 = 0,

424 .
	gcm≠_°©ic
 = 0,

425 .
	glc¸0
 = 
LCCR0_Cﬁ‹
 | 
LCCR0_A˘
,

426 .
	glc¸3
 = 0x03400002,

427 .
	gpxafb_backlight_powî
 = 
bﬂrd_backlight_powî
,

430 
__öô
 
	$åizïs4_öô
()

432 
	`∂©f‹m_add_devi˚s
(
åizïs4_devi˚s
, 
	`ARRAY_SIZE
(trizeps4_devices));

435 
	`£t_pxa_fb_öfo
(&
toshiba_lcd
);

437 
	`pxa_£t_mci_öfo
(&
åizïs4_mci_∂©f‹m_d©a
);

438 
	`pxa_£t_fi˝_öfo
(&
åizïs4_fi˝_∂©f‹m_d©a
);

439 
	`pxa_£t_ohci_öfo
(&
åizïs4_ohci_∂©f‹m_d©a
);

440 
	}
}

442 
__öô
 
	$åizïs4_m≠_io
()

444 
	`pxa_m≠_io
();

445 
	`iŸabÀ_öô
(
åizïs4_io_desc
, 
	`ARRAY_SIZE
(trizeps4_io_desc));

448 
	`pxa_gpio_mode
(
GPIO15_nCS_1_MD
);

451 
	`pxa_gpio_mode
(
GPIO_PIC
 | 
GPIO_IN
);

454 
	`pxa_gpio_mode
(
GPIO_UCB1400
 | 
GPIO_IN
);

457 
	`pxa_gpio_mode
(
GPIO78_nCS_2_MD
);

458 
	`pxa_gpio_mode
(
GPIO_DM9000
 | 
GPIO_IN
);

461 
	`pxa_gpio_mode
(
GPIO_PCD
 | 
GPIO_IN
);

462 
	`pxa_gpio_mode
(
GPIO_PRDY
 | 
GPIO_IN
);

465 
	`pxa_gpio_mode
(
GPIO117_I2CSCL_MD
);

466 
	`pxa_gpio_mode
(
GPIO118_I2CSDA_MD
);

469 
	`pxa_gpio_mode
(
GPIO_MMC_DET
 | 
GPIO_IN
);

472 
	`pxa_gpio_mode
(
GPIO79_nCS_3_MD
);

474 #ifde‡
CONFIG_LEDS


475 
	`pxa_gpio_mode
–
GPIO_SYS_BUSY_LED
 | 
GPIO_OUT
);

476 
	`pxa_gpio_mode
–
GPIO_HEARTBEAT_LED
 | 
GPIO_OUT
);

478 #ifde‡
CONFIG_MACH_TRIZEPS4_CONXS


479 #ifde‡
CONFIG_IDE_PXA_CF


481 
åizïs_c⁄xs_b¸
 = 0x0009;

484 
åizïs_c⁄xs_b¸
 = 0x00A0;

486 
C⁄XS_BCR
 = 
åizïs_c⁄xs_b¸
;

489 
PWER
 = 0x00000002;

490 
PFER
 = 0x00000000;

491 
PRER
 = 0x00000002;

492 
PGSR0
 = 0x0158C000;

493 
PGSR1
 = 0x00FF0080;

494 
PGSR2
 = 0x0001C004;

496 
PCFR
 |
PCFR_OPDE
;

497 
	}
}

499 
MACHINE_START
(
TRIZEPS4
, "Keith und Koep Trizeps IV module")

501 .
	gphys_io
 = 0x40000000,

502 .
	gio_pg_off°
 = (
io_p2v
(0x40000000) >> 18) & 0xfffc,

503 .
	gboŸ_∑øms
 = 
TRIZEPS4_SDRAM_BASE
 + 0x100,

504 .
	göô_machöe
 = 
åizïs4_öô
,

505 .
	gm≠_io
 = 
åizïs4_m≠_io
,

506 .
	göô_úq
 = 
pxa_öô_úq
,

507 .
	gtimî
 = &
pxa_timî
,

508 
	gMACHINE_END


	@arch/arm/mach-realview/clock.c

11 
	~<löux/moduÀ.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/li°.h
>

14 
	~<löux/î∫o.h
>

15 
	~<löux/îr.h
>

16 
	~<löux/˛k.h
>

17 
	~<löux/muãx.h
>

19 
	~<asm/£m≠h‹e.h
>

20 
	~<asm/h¨dw¨e/ic°307.h
>

22 
	~"˛ock.h
"

24 
LIST_HEAD
(
˛ocks
);

25 
DEFINE_MUTEX
(
˛ocks_muãx
);

27 
˛k
 *
	$˛k_gë
(
devi˚
 *
dev
, c⁄° *
id
)

29 
˛k
 *
p
, *˛k = 
	`ERR_PTR
(-
ENOENT
);

31 
	`muãx_lock
(&
˛ocks_muãx
);

32 
	`li°_f‹_óch_íåy
(
p
, &
˛ocks
, 
node
) {

33 i‡(
	`°rcmp
(
id
, 
p
->
«me
Ë=0 && 
	`åy_moduÀ_gë
’->
ow√r
)) {

34 
˛k
 = 
p
;

38 
	`muãx_u∆ock
(&
˛ocks_muãx
);

40  
˛k
;

41 
	}
}

42 
EXPORT_SYMBOL
(
˛k_gë
);

44 
	$˛k_put
(
˛k
 *clk)

46 
	`moduÀ_put
(
˛k
->
ow√r
);

47 
	}
}

48 
EXPORT_SYMBOL
(
˛k_put
);

50 
	$˛k_íabÀ
(
˛k
 *clk)

53 
	}
}

54 
EXPORT_SYMBOL
(
˛k_íabÀ
);

56 
	$˛k_dißbÀ
(
˛k
 *clk)

58 
	}
}

59 
EXPORT_SYMBOL
(
˛k_dißbÀ
);

61 
	$˛k_gë_øã
(
˛k
 *clk)

63  
˛k
->
øã
;

64 
	}
}

65 
EXPORT_SYMBOL
(
˛k_gë_øã
);

67 
	$˛k_round_øã
(
˛k
 *˛k, 
øã
)

69  
øã
;

70 
	}
}

71 
EXPORT_SYMBOL
(
˛k_round_øã
);

73 
	$˛k_£t_øã
(
˛k
 *˛k, 
øã
)

75 
ªt
 = -
EIO
;

77 i‡(
˛k
->
£tvco
) {

78 
ic°307_vco
 
vco
;

80 
vco
 = 
	`ic°307_khz_to_vco
(
˛k
->
∑øms
, 
øã
 / 1000);

81 
˛k
->
øã
 = 
	`ic°307_khz
(˛k->
∑øms
, 
vco
) * 1000;

83 
	`¥ötk
("Clock %s: setting VCOÑegÖarams: S=%d R=%d V=%d\n",

84 
˛k
->
«me
, 
vco
.
s
, vco.
r
, vco.
v
);

86 
˛k
->
	`£tvco
(˛k, 
vco
);

87 
ªt
 = 0;

89  
ªt
;

90 
	}
}

91 
EXPORT_SYMBOL
(
˛k_£t_øã
);

96 
˛k
 
	gkmi_˛k
 = {

97 .
«me
 = "KMIREFCLK",

98 .
	gøã
 = 24000000,

101 
˛k
 
	gu¨t_˛k
 = {

102 .
«me
 = "UARTCLK",

103 .
	gøã
 = 24000000,

106 
˛k
 
	gmmci_˛k
 = {

107 .
«me
 = "MCLK",

108 .
	gøã
 = 33000000,

111 
	$˛k_ªgi°î
(
˛k
 *clk)

113 
	`muãx_lock
(&
˛ocks_muãx
);

114 
	`li°_add
(&
˛k
->
node
, &
˛ocks
);

115 
	`muãx_u∆ock
(&
˛ocks_muãx
);

117 
	}
}

118 
EXPORT_SYMBOL
(
˛k_ªgi°î
);

120 
	$˛k_uƒegi°î
(
˛k
 *clk)

122 
	`muãx_lock
(&
˛ocks_muãx
);

123 
	`li°_dñ
(&
˛k
->
node
);

124 
	`muãx_u∆ock
(&
˛ocks_muãx
);

125 
	}
}

126 
EXPORT_SYMBOL
(
˛k_uƒegi°î
);

128 
__öô
 
	$˛k_öô
()

130 
	`˛k_ªgi°î
(&
kmi_˛k
);

131 
	`˛k_ªgi°î
(&
u¨t_˛k
);

132 
	`˛k_ªgi°î
(&
mmci_˛k
);

134 
	}
}

135 
¨ch_öôˇŒ
(
˛k_öô
);

	@arch/arm/mach-realview/clock.h

11 
	gmoduÀ
;

12 
	gic°307_∑øms
;

14 
	s˛k
 {

15 
li°_hód
 
	mnode
;

16 
	møã
;

17 
moduÀ
 *
	mow√r
;

18 c⁄° *
	m«me
;

19 c⁄° 
ic°307_∑øms
 *
	m∑øms
;

20 *
	md©a
;

21 (*
	m£tvco
)(
	m˛k
 *, 
ic°307_vco
 
	mvco
);

24 
˛k_ªgi°î
(
˛k
 *clk);

25 
˛k_uƒegi°î
(
˛k
 *clk);

	@arch/arm/mach-realview/core.c

21 
	~<löux/öô.h
>

22 
	~<löux/∂©f‹m_devi˚.h
>

23 
	~<löux/dma-m≠pög.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/amba/bus.h
>

27 
	~<löux/amba/˛cd.h
>

29 
	~<asm/sy°em.h
>

30 
	~<asm/h¨dw¨e.h
>

31 
	~<asm/io.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/Àds.h
>

34 
	~<asm/h¨dw¨e/¨m_timî.h
>

35 
	~<asm/h¨dw¨e/ic°307.h
>

37 
	~<asm/mach/¨ch.h
>

38 
	~<asm/mach/Êash.h
>

39 
	~<asm/mach/úq.h
>

40 
	~<asm/mach/time.h
>

41 
	~<asm/mach/m≠.h
>

42 
	~<asm/mach/mmc.h
>

44 
	~<asm/h¨dw¨e/gic.h
>

46 
	~"c‹e.h
"

47 
	~"˛ock.h
"

49 
	#REALVIEW_REFCOUNTER
 (
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_24MHz_OFFSET
)

	)

55 
	$sched_˛ock
()

57 
v
;

59 
v
 = ()
	`ªadl
(
REALVIEW_REFCOUNTER
) * 125;

60 
	`do_div
(
v
, 3);

62  
v
;

63 
	}
}

66 
	#REALVIEW_FLASHCTRL
 (
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_FLASH_OFFSET
)

	)

68 
	$ªÆvõw_Êash_öô
()

70 
u32
 
vÆ
;

72 
vÆ
 = 
	`__øw_ªadl
(
REALVIEW_FLASHCTRL
);

73 
vÆ
 &~
REALVIEW_FLASHPROG_FLVPPEN
;

74 
	`__øw_wrôñ
(
vÆ
, 
REALVIEW_FLASHCTRL
);

77 
	}
}

79 
	$ªÆvõw_Êash_exô
()

81 
u32
 
vÆ
;

83 
vÆ
 = 
	`__øw_ªadl
(
REALVIEW_FLASHCTRL
);

84 
vÆ
 &~
REALVIEW_FLASHPROG_FLVPPEN
;

85 
	`__øw_wrôñ
(
vÆ
, 
REALVIEW_FLASHCTRL
);

86 
	}
}

88 
	$ªÆvõw_Êash_£t_vµ
(
⁄
)

90 
u32
 
vÆ
;

92 
vÆ
 = 
	`__øw_ªadl
(
REALVIEW_FLASHCTRL
);

93 i‡(
⁄
)

94 
vÆ
 |
REALVIEW_FLASHPROG_FLVPPEN
;

96 
vÆ
 &~
REALVIEW_FLASHPROG_FLVPPEN
;

97 
	`__øw_wrôñ
(
vÆ
, 
REALVIEW_FLASHCTRL
);

98 
	}
}

100 
Êash_∂©f‹m_d©a
 
	gªÆvõw_Êash_d©a
 = {

101 .
m≠_«me
 = "cfi_probe",

102 .
	gwidth
 = 4,

103 .
	göô
 = 
ªÆvõw_Êash_öô
,

104 .
	gexô
 = 
ªÆvõw_Êash_exô
,

105 .
	g£t_vµ
 = 
ªÆvõw_Êash_£t_vµ
,

108 
ªsour˚
 
	gªÆvõw_Êash_ªsour˚
 = {

109 .
°¨t
 = 
REALVIEW_FLASH_BASE
,

110 .
	gíd
 = 
REALVIEW_FLASH_BASE
 + 
REALVIEW_FLASH_SIZE
,

111 .
	gÊags
 = 
IORESOURCE_MEM
,

114 
∂©f‹m_devi˚
 
	gªÆvõw_Êash_devi˚
 = {

115 .
«me
 = "armflash",

116 .
	gid
 = 0,

117 .
	gdev
 = {

118 .
∂©f‹m_d©a
 = &
ªÆvõw_Êash_d©a
,

120 .
	gnum_ªsour˚s
 = 1,

121 .
	gªsour˚
 = &
ªÆvõw_Êash_ªsour˚
,

124 
ªsour˚
 
	gªÆvõw_smc91x_ªsour˚s
[] = {

126 .
°¨t
 = 
REALVIEW_ETH_BASE
,

127 .
	gíd
 = 
REALVIEW_ETH_BASE
 + 
SZ_64K
 - 1,

128 .
	gÊags
 = 
IORESOURCE_MEM
,

131 .
°¨t
 = 
IRQ_ETH
,

132 .
	gíd
 = 
IRQ_ETH
,

133 .
	gÊags
 = 
IORESOURCE_IRQ
,

137 
∂©f‹m_devi˚
 
	gªÆvõw_smc91x_devi˚
 = {

138 .
«me
 = "smc91x",

139 .
	gid
 = 0,

140 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ªÆvõw_smc91x_ªsour˚s
),

141 .
	gªsour˚
 = 
ªÆvõw_smc91x_ªsour˚s
,

144 
ªsour˚
 
	gªÆvõw_i2c_ªsour˚
 = {

145 .
°¨t
 = 
REALVIEW_I2C_BASE
,

146 .
	gíd
 = 
REALVIEW_I2C_BASE
 + 
SZ_4K
 - 1,

147 .
	gÊags
 = 
IORESOURCE_MEM
,

150 
∂©f‹m_devi˚
 
	gªÆvõw_i2c_devi˚
 = {

151 .
«me
 = "versatile-i2c",

152 .
	gid
 = -1,

153 .
	gnum_ªsour˚s
 = 1,

154 .
	gªsour˚
 = &
ªÆvõw_i2c_ªsour˚
,

157 
	#REALVIEW_SYSMCI
 (
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_MCI_OFFSET
)

	)

159 
	$ªÆvõw_mmc_°©us
(
devi˚
 *
dev
)

161 
amba_devi˚
 *
adev
 = 
	`c⁄èöî_of
(
dev
, amba_device, dev);

162 
u32
 
mask
;

164 i‡(
adev
->
ªs
.
°¨t
 =
REALVIEW_MMCI0_BASE
)

165 
mask
 = 1;

167 
mask
 = 2;

169  
	`ªadl
(
REALVIEW_SYSMCI
Ë& 
mask
;

170 
	}
}

172 
mmc_∂©f‹m_d©a
 
	gªÆvõw_mmc0_∂©_d©a
 = {

173 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

174 .
	g°©us
 = 
ªÆvõw_mmc_°©us
,

177 
mmc_∂©f‹m_d©a
 
	gªÆvõw_mmc1_∂©_d©a
 = {

178 .
o¸_mask
 = 
MMC_VDD_32_33
|
MMC_VDD_33_34
,

179 .
	g°©us
 = 
ªÆvõw_mmc_°©us
,

185 c⁄° 
ic°307_∑øms
 
	gªÆvõw_oscvco_∑øms
 = {

186 .
ªf
 = 24000,

187 .
	gvco_max
 = 200000,

188 .
	gvd_mö
 = 4 + 8,

189 .
	gvd_max
 = 511 + 8,

190 .
	grd_mö
 = 1 + 2,

191 .
	grd_max
 = 127 + 2,

194 
	$ªÆvõw_oscvco_£t
(
˛k
 *˛k, 
ic°307_vco
 
vco
)

196 
__iomem
 *
sys_lock
 = 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_LOCK_OFFSET
;

197 
__iomem
 *
sys_osc
 = 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_OSC4_OFFSET
;

198 
u32
 
vÆ
;

200 
vÆ
 = 
	`ªadl
(
sys_osc
) & ~0x7ffff;

201 
vÆ
 |
vco
.
v
 | (vco.
r
 << 9Ë| (vco.
s
 << 16);

203 
	`wrôñ
(0xa05f, 
sys_lock
);

204 
	`wrôñ
(
vÆ
, 
sys_osc
);

205 
	`wrôñ
(0, 
sys_lock
);

206 
	}
}

208 
˛k
 
	gªÆvõw_˛cd_˛k
 = {

209 .
«me
 = "CLCDCLK",

210 .
	g∑øms
 = &
ªÆvõw_oscvco_∑øms
,

211 .
	g£tvco
 = 
ªÆvõw_oscvco_£t
,

217 
	#SYS_CLCD_NLCDIOON
 (1 << 2)

	)

218 
	#SYS_CLCD_VDDPOSSWITCH
 (1 << 3)

	)

219 
	#SYS_CLCD_PWR3V5SWITCH
 (1 << 4)

	)

220 
	#SYS_CLCD_ID_MASK
 (0x1‡<< 8)

	)

221 
	#SYS_CLCD_ID_SANYO_3_8
 (0x00 << 8)

	)

222 
	#SYS_CLCD_ID_UNKNOWN_8_4
 (0x01 << 8)

	)

223 
	#SYS_CLCD_ID_EPSON_2_2
 (0x02 << 8)

	)

224 
	#SYS_CLCD_ID_SANYO_2_5
 (0x07 << 8)

	)

225 
	#SYS_CLCD_ID_VGA
 (0x1‡<< 8)

	)

227 
˛cd_∑√l
 
	gvga
 = {

228 .
mode
 = {

229 .
«me
 = "VGA",

230 .
	gª‰esh
 = 60,

231 .
	gxªs
 = 640,

232 .
	gyªs
 = 480,

233 .
	gpix˛ock
 = 39721,

234 .
	gÀ·_m¨gö
 = 40,

235 .
	gright_m¨gö
 = 24,

236 .
	guµî_m¨gö
 = 32,

237 .
	glowî_m¨gö
 = 11,

238 .
	ghsync_Àn
 = 96,

239 .
	gvsync_Àn
 = 2,

240 .
	gsync
 = 0,

241 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

243 .
	gwidth
 = -1,

244 .
	gheight
 = -1,

245 .
	gtim2
 = 
TIM2_BCD
 | 
TIM2_IPC
,

246 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

247 .
	gbµ
 = 16,

250 
˛cd_∑√l
 
	gßnyo_3_8_ö
 = {

251 .
mode
 = {

252 .
«me
 = "Sanyo QVGA",

253 .
	gª‰esh
 = 116,

254 .
	gxªs
 = 320,

255 .
	gyªs
 = 240,

256 .
	gpix˛ock
 = 100000,

257 .
	gÀ·_m¨gö
 = 6,

258 .
	gright_m¨gö
 = 6,

259 .
	guµî_m¨gö
 = 5,

260 .
	glowî_m¨gö
 = 5,

261 .
	ghsync_Àn
 = 6,

262 .
	gvsync_Àn
 = 6,

263 .
	gsync
 = 0,

264 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

266 .
	gwidth
 = -1,

267 .
	gheight
 = -1,

268 .
	gtim2
 = 
TIM2_BCD
,

269 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

270 .
	gbµ
 = 16,

273 
˛cd_∑√l
 
	gßnyo_2_5_ö
 = {

274 .
mode
 = {

275 .
«me
 = "Sanyo QVGA Portrait",

276 .
	gª‰esh
 = 116,

277 .
	gxªs
 = 240,

278 .
	gyªs
 = 320,

279 .
	gpix˛ock
 = 100000,

280 .
	gÀ·_m¨gö
 = 20,

281 .
	gright_m¨gö
 = 10,

282 .
	guµî_m¨gö
 = 2,

283 .
	glowî_m¨gö
 = 2,

284 .
	ghsync_Àn
 = 10,

285 .
	gvsync_Àn
 = 2,

286 .
	gsync
 = 
FB_SYNC_HOR_HIGH_ACT
 | 
FB_SYNC_VERT_HIGH_ACT
,

287 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

289 .
	gwidth
 = -1,

290 .
	gheight
 = -1,

291 .
	gtim2
 = 
TIM2_IVS
 | 
TIM2_IHS
 | 
TIM2_IPC
,

292 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

293 .
	gbµ
 = 16,

296 
˛cd_∑√l
 
	gïs⁄_2_2_ö
 = {

297 .
mode
 = {

298 .
«me
 = "Epson QCIF",

299 .
	gª‰esh
 = 390,

300 .
	gxªs
 = 176,

301 .
	gyªs
 = 220,

302 .
	gpix˛ock
 = 62500,

303 .
	gÀ·_m¨gö
 = 3,

304 .
	gright_m¨gö
 = 2,

305 .
	guµî_m¨gö
 = 1,

306 .
	glowî_m¨gö
 = 0,

307 .
	ghsync_Àn
 = 3,

308 .
	gvsync_Àn
 = 2,

309 .
	gsync
 = 0,

310 .
	gvmode
 = 
FB_VMODE_NONINTERLACED
,

312 .
	gwidth
 = -1,

313 .
	gheight
 = -1,

314 .
	gtim2
 = 
TIM2_BCD
 | 
TIM2_IPC
,

315 .
	g˙é
 = 
CNTL_LCDTFT
 | 
CNTL_LCDVCOMP
(1),

316 .
	gbµ
 = 16,

325 
˛cd_∑√l
 *
	$ªÆvõw_˛cd_∑√l
()

327 
__iomem
 *
sys_˛cd
 = 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_CLCD_OFFSET
;

328 
˛cd_∑√l
 *
∑√l
 = &
vga
;

329 
u32
 
vÆ
;

331 
vÆ
 = 
	`ªadl
(
sys_˛cd
Ë& 
SYS_CLCD_ID_MASK
;

332 i‡(
vÆ
 =
SYS_CLCD_ID_SANYO_3_8
)

333 
∑√l
 = &
ßnyo_3_8_ö
;

334 i‡(
vÆ
 =
SYS_CLCD_ID_SANYO_2_5
)

335 
∑√l
 = &
ßnyo_2_5_ö
;

336 i‡(
vÆ
 =
SYS_CLCD_ID_EPSON_2_2
)

337 
∑√l
 = &
ïs⁄_2_2_ö
;

338 i‡(
vÆ
 =
SYS_CLCD_ID_VGA
)

339 
∑√l
 = &
vga
;

341 
	`¥ötk
(
KERN_ERR
 "CLCD: unknown LCDÖanel ID 0x%08x, using VGA\n",

342 
vÆ
);

343 
∑√l
 = &
vga
;

346  
∑√l
;

347 
	}
}

352 
	$ªÆvõw_˛cd_dißbÀ
(
˛cd_fb
 *
fb
)

354 
__iomem
 *
sys_˛cd
 = 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_CLCD_OFFSET
;

355 
u32
 
vÆ
;

357 
vÆ
 = 
	`ªadl
(
sys_˛cd
);

358 
vÆ
 &~
SYS_CLCD_NLCDIOON
 | 
SYS_CLCD_PWR3V5SWITCH
;

359 
	`wrôñ
(
vÆ
, 
sys_˛cd
);

360 
	}
}

365 
	$ªÆvõw_˛cd_íabÀ
(
˛cd_fb
 *
fb
)

367 
__iomem
 *
sys_˛cd
 = 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_CLCD_OFFSET
;

368 
u32
 
vÆ
;

373 
vÆ
 = 
	`ªadl
(
sys_˛cd
);

374 
vÆ
 |
SYS_CLCD_NLCDIOON
 | 
SYS_CLCD_PWR3V5SWITCH
;

375 
	`wrôñ
(
vÆ
, 
sys_˛cd
);

376 
	}
}

378 
	g‰amesize
 = 
SZ_1M
;

380 
	$ªÆvõw_˛cd_£tup
(
˛cd_fb
 *
fb
)

382 
dma_addr_t
 
dma
;

384 
fb
->
∑√l
 = 
	`ªÆvõw_˛cd_∑√l
();

386 
fb
->fb.
s¸ìn_ba£
 = 
	`dma_Æloc_wrôecomböe
(&fb->
dev
->dev, 
‰amesize
,

387 &
dma
, 
GFP_KERNEL
);

388 i‡(!
fb
->fb.
s¸ìn_ba£
) {

389 
	`¥ötk
(
KERN_ERR
 "CLCD: unableÅo map framebuffer\n");

390  -
ENOMEM
;

393 
fb
->fb.
fix
.
smem_°¨t
 = 
dma
;

394 
fb
->fb.
fix
.
smem_Àn
 = 
‰amesize
;

397 
	}
}

399 
	$ªÆvõw_˛cd_mm≠
(
˛cd_fb
 *
fb
, 
vm_¨ó_°ru˘
 *
vma
)

401  
	`dma_mm≠_wrôecomböe
(&
fb
->
dev
->dev, 
vma
,

402 
fb
->fb.
s¸ìn_ba£
,

403 
fb
->fb.
fix
.
smem_°¨t
,

404 
fb
->fb.
fix
.
smem_Àn
);

405 
	}
}

407 
	$ªÆvõw_˛cd_ªmove
(
˛cd_fb
 *
fb
)

409 
	`dma_‰ì_wrôecomböe
(&
fb
->
dev
->dev, fb->fb.
fix
.
smem_Àn
,

410 
fb
->fb.
s¸ìn_ba£
, fb->fb.
fix
.
smem_°¨t
);

411 
	}
}

413 
˛cd_bﬂrd
 
	g˛cd_∂©_d©a
 = {

414 .
«me
 = "RealView",

415 .
	gcheck
 = 
˛cdfb_check
,

416 .
	gdecode
 = 
˛cdfb_decode
,

417 .
	gdißbÀ
 = 
ªÆvõw_˛cd_dißbÀ
,

418 .
	gíabÀ
 = 
ªÆvõw_˛cd_íabÀ
,

419 .
	g£tup
 = 
ªÆvõw_˛cd_£tup
,

420 .
	gmm≠
 = 
ªÆvõw_˛cd_mm≠
,

421 .
	gªmove
 = 
ªÆvõw_˛cd_ªmove
,

424 #ifde‡
CONFIG_LEDS


425 
	#VA_LEDS_BASE
 (
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_SYS_LED_OFFSET
)

	)

427 
	$ªÆvõw_Àds_evít
(
Àd_evít_t
 
Àdevt
)

429 
Êags
;

430 
u32
 
vÆ
;

432 
	`loˇl_úq_ßve
(
Êags
);

433 
vÆ
 = 
	`ªadl
(
VA_LEDS_BASE
);

435 
Àdevt
) {

436 
Àd_idÀ_°¨t
:

437 
vÆ
 = vÆ & ~
REALVIEW_SYS_LED0
;

440 
Àd_idÀ_íd
:

441 
vÆ
 = vÆ | 
REALVIEW_SYS_LED0
;

444 
Àd_timî
:

445 
vÆ
 = vÆ ^ 
REALVIEW_SYS_LED1
;

448 
Àd_hÆãd
:

449 
vÆ
 = 0;

456 
	`wrôñ
(
vÆ
, 
VA_LEDS_BASE
);

457 
	`loˇl_úq_ª°‹e
(
Êags
);

458 
	}
}

464 
	#TIMER0_VA_BASE
 
	`__io_addªss
(
REALVIEW_TIMER0_1_BASE
)

	)

465 
	#TIMER1_VA_BASE
 (
	`__io_addªss
(
REALVIEW_TIMER0_1_BASE
Ë+ 0x20)

	)

466 
	#TIMER2_VA_BASE
 
	`__io_addªss
(
REALVIEW_TIMER2_3_BASE
)

	)

467 
	#TIMER3_VA_BASE
 (
	`__io_addªss
(
REALVIEW_TIMER2_3_BASE
Ë+ 0x20)

	)

472 
	#TIMER_INTERVAL
 (
TICKS_PER_uSEC
 * 
mSEC_10
)

	)

473 #i‡
TIMER_INTERVAL
 >= 0x100000

474 
	#TIMER_RELOAD
 (
TIMER_INTERVAL
 >> 8)

	)

475 
	#TIMER_DIVISOR
 (
TIMER_CTRL_DIV256
)

	)

476 
	#TICKS2USECS
(
x
Ë(256 * (xË/ 
TICKS_PER_uSEC
)

	)

477 #ñi‡
TIMER_INTERVAL
 >= 0x10000

478 
	#TIMER_RELOAD
 (
TIMER_INTERVAL
 >> 4Ë

	)

479 
	#TIMER_DIVISOR
 (
TIMER_CTRL_DIV16
)

	)

480 
	#TICKS2USECS
(
x
Ë(16 * (xË/ 
TICKS_PER_uSEC
)

	)

482 
	#TIMER_RELOAD
 (
TIMER_INTERVAL
)

	)

483 
	#TIMER_DIVISOR
 (
TIMER_CTRL_DIV1
)

	)

484 
	#TICKS2USECS
(
x
Ë((xË/ 
TICKS_PER_uSEC
)

	)

491 
	$ªÆvõw_gëtimeoff£t
()

493 
ticks1
, 
ticks2
, 
°©us
;

501 
ticks2
 = 
	`ªadl
(
TIMER0_VA_BASE
 + 
TIMER_VALUE
) & 0xffff;

503 
ticks1
 = 
ticks2
;

504 
°©us
 = 
	`__øw_ªadl
(
	`__io_addªss
(
REALVIEW_GIC_DIST_BASE
 + 
GIC_DIST_PENDING_SET
)

505 + ((
IRQ_TIMERINT0_1
 >> 5) << 2));

506 
ticks2
 = 
	`ªadl
(
TIMER0_VA_BASE
 + 
TIMER_VALUE
) & 0xffff;

507 } 
ticks2
 > 
ticks1
);

512 
ticks1
 = 
TIMER_RELOAD
 - 
ticks2
;

519 i‡(
°©us
 & 
IRQMASK_TIMERINT0_1
)

520 
ticks1
 +
TIMER_RELOAD
;

525  
	`TICKS2USECS
(
ticks1
);

526 
	}
}

531 
úqªtu∫_t
 
	$ªÆvõw_timî_öãºu±
(
úq
, *
dev_id
)

533 
	`wrôe_£qlock
(&
xtime_lock
);

536 
	`wrôñ
(1, 
TIMER0_VA_BASE
 + 
TIMER_INTCLR
);

538 
	`timî_tick
();

540 #i‡
	`deföed
(
CONFIG_SMP
Ë&& !deföed(
CONFIG_LOCAL_TIMERS
)

541 
	`smp_£nd_timî
();

542 
	`upd©e_¥o˚ss_times
(
	`u£r_mode
(
	`gë_úq_ªgs
()));

545 
	`wrôe_£qu∆ock
(&
xtime_lock
);

547  
IRQ_HANDLED
;

548 
	}
}

550 
úqa˘i⁄
 
	gªÆvõw_timî_úq
 = {

551 .
«me
 = "RealView Timer Tick",

552 .
	gÊags
 = 
IRQF_DISABLED
 | 
IRQF_TIMER
 | 
IRQF_IRQPOLL
,

553 .
	gh™dÀr
 = 
ªÆvõw_timî_öãºu±
,

559 
__öô
 
	$ªÆvõw_timî_öô
()

561 
u32
 
vÆ
;

568 
vÆ
 = 
	`ªadl
(
	`__io_addªss
(
REALVIEW_SCTL_BASE
));

569 
	`wrôñ
((
REALVIEW_TIMCLK
 << 
REALVIEW_TIMER1_EnSñ
) |

570 (
REALVIEW_TIMCLK
 << 
REALVIEW_TIMER2_EnSñ
) |

571 (
REALVIEW_TIMCLK
 << 
REALVIEW_TIMER3_EnSñ
) |

572 (
REALVIEW_TIMCLK
 << 
REALVIEW_TIMER4_EnSñ
Ë| 
vÆ
,

573 
	`__io_addªss
(
REALVIEW_SCTL_BASE
));

578 
	`wrôñ
(0, 
TIMER0_VA_BASE
 + 
TIMER_CTRL
);

579 
	`wrôñ
(0, 
TIMER1_VA_BASE
 + 
TIMER_CTRL
);

580 
	`wrôñ
(0, 
TIMER2_VA_BASE
 + 
TIMER_CTRL
);

581 
	`wrôñ
(0, 
TIMER3_VA_BASE
 + 
TIMER_CTRL
);

583 
	`wrôñ
(
TIMER_RELOAD
, 
TIMER0_VA_BASE
 + 
TIMER_LOAD
);

584 
	`wrôñ
(
TIMER_RELOAD
, 
TIMER0_VA_BASE
 + 
TIMER_VALUE
);

585 
	`wrôñ
(
TIMER_DIVISOR
 | 
TIMER_CTRL_ENABLE
 | 
TIMER_CTRL_PERIODIC
 |

586 
TIMER_CTRL_IE
, 
TIMER0_VA_BASE
 + 
TIMER_CTRL
);

591 
	`£tup_úq
(
IRQ_TIMERINT0_1
, &
ªÆvõw_timî_úq
);

592 
	}
}

594 
sys_timî
 
	gªÆvõw_timî
 = {

595 .
öô
 = 
ªÆvõw_timî_öô
,

596 .
	goff£t
 = 
ªÆvõw_gëtimeoff£t
,

	@arch/arm/mach-realview/core.h

22 #i‚de‡
__ASM_ARCH_REALVIEW_H


23 
	#__ASM_ARCH_REALVIEW_H


	)

25 
	~<löux/amba/bus.h
>

27 
	~<asm/Àds.h
>

28 
	~<asm/io.h
>

30 
sys_timî
 
ªÆvõw_timî
;

32 
	#AMBA_DEVICE
(
«me
,
busid
,
ba£
,
∂©
) \

33 
amba_devi˚
 
«me
##
_devi˚
 = { \

34 .
dev
 = { \

35 .
cohîít_dma_mask
 = ~0, \

36 .
bus_id
 = 
busid
, \

37 .
∂©f‹m_d©a
 = 
∂©
, \

39 .
ªs
 = { \

40 .
°¨t
 = 
REALVIEW_
##
ba£
##
_BASE
, \

41 .
íd
 = (
REALVIEW_
##
ba£
##
_BASE
Ë+ 
SZ_4K
 - 1,\

42 .
Êags
 = 
IORESOURCE_MEM
, \

44 .
dma_mask
 = ~0, \

45 .
úq
 = 
ba£
##
_IRQ
, \

47 }

	)

52 
	#GPIO2_IRQ
 { 
IRQ_GPIOINT2
, 
NO_IRQ
 }

	)

53 
	#GPIO2_DMA
 { 0, 0 }

	)

54 
	#GPIO3_IRQ
 { 
IRQ_GPIOINT3
, 
NO_IRQ
 }

	)

55 
	#GPIO3_DMA
 { 0, 0 }

	)

57 
	#AACI_IRQ
 { 
IRQ_AACI
, 
NO_IRQ
 }

	)

58 
	#AACI_DMA
 { 0x80, 0x81 }

	)

59 
	#MMCI0_IRQ
 { 
IRQ_MMCI0A
,
IRQ_MMCI0B
 }

	)

60 
	#MMCI0_DMA
 { 0x84, 0 }

	)

61 
	#KMI0_IRQ
 { 
IRQ_KMI0
, 
NO_IRQ
 }

	)

62 
	#KMI0_DMA
 { 0, 0 }

	)

63 
	#KMI1_IRQ
 { 
IRQ_KMI1
, 
NO_IRQ
 }

	)

64 
	#KMI1_DMA
 { 0, 0 }

	)

69 
	#SMC_IRQ
 { 
NO_IRQ
, NO_IRQ }

	)

70 
	#SMC_DMA
 { 0, 0 }

	)

71 
	#MPMC_IRQ
 { 
NO_IRQ
, NO_IRQ }

	)

72 
	#MPMC_DMA
 { 0, 0 }

	)

73 
	#CLCD_IRQ
 { 
IRQ_CLCDINT
, 
NO_IRQ
 }

	)

74 
	#CLCD_DMA
 { 0, 0 }

	)

75 
	#DMAC_IRQ
 { 
IRQ_DMAINT
, 
NO_IRQ
 }

	)

76 
	#DMAC_DMA
 { 0, 0 }

	)

81 
	#SCTL_IRQ
 { 
NO_IRQ
, NO_IRQ }

	)

82 
	#SCTL_DMA
 { 0, 0 }

	)

83 
	#WATCHDOG_IRQ
 { 
IRQ_WDOGINT
, 
NO_IRQ
 }

	)

84 
	#WATCHDOG_DMA
 { 0, 0 }

	)

85 
	#GPIO0_IRQ
 { 
IRQ_GPIOINT0
, 
NO_IRQ
 }

	)

86 
	#GPIO0_DMA
 { 0, 0 }

	)

87 
	#GPIO1_IRQ
 { 
IRQ_GPIOINT1
, 
NO_IRQ
 }

	)

88 
	#GPIO1_DMA
 { 0, 0 }

	)

89 
	#RTC_IRQ
 { 
IRQ_RTCINT
, 
NO_IRQ
 }

	)

90 
	#RTC_DMA
 { 0, 0 }

	)

95 
	#SCI_IRQ
 { 
IRQ_SCIINT
, 
NO_IRQ
 }

	)

96 
	#SCI_DMA
 { 7, 6 }

	)

97 
	#UART0_IRQ
 { 
IRQ_UARTINT0
, 
NO_IRQ
 }

	)

98 
	#UART0_DMA
 { 15, 14 }

	)

99 
	#UART1_IRQ
 { 
IRQ_UARTINT1
, 
NO_IRQ
 }

	)

100 
	#UART1_DMA
 { 13, 12 }

	)

101 
	#UART2_IRQ
 { 
IRQ_UARTINT2
, 
NO_IRQ
 }

	)

102 
	#UART2_DMA
 { 11, 10 }

	)

103 
	#UART3_IRQ
 { 
IRQ_UART3
, 
NO_IRQ
 }

	)

104 
	#UART3_DMA
 { 0x86, 0x87 }

	)

105 
	#SSP_IRQ
 { 
IRQ_SSPINT
, 
NO_IRQ
 }

	)

106 
	#SSP_DMA
 { 9, 8 }

	)

109 
∂©f‹m_devi˚
 
ªÆvõw_Êash_devi˚
;

110 
∂©f‹m_devi˚
 
ªÆvõw_smc91x_devi˚
;

111 
∂©f‹m_devi˚
 
ªÆvõw_i2c_devi˚
;

112 
mmc_∂©f‹m_d©a
 
ªÆvõw_mmc0_∂©_d©a
;

113 
mmc_∂©f‹m_d©a
 
ªÆvõw_mmc1_∂©_d©a
;

114 
˛k
 
ªÆvõw_˛cd_˛k
;

115 
˛cd_bﬂrd
 
˛cd_∂©_d©a
;

117 
ªÆvõw_Àds_evít
(
Àd_evít_t
 
Àdevt
);

	@arch/arm/mach-realview/hotplug.c

11 
	~<löux/kî√l.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/smp.h
>

14 
	~<löux/com∂ëi⁄.h
>

16 vﬁ©ûê
≥n_ªÀa£
;

18 
DECLARE_COMPLETION
(
˝u_kûÀd
);

20 
ölöe
 
	$˝u_íãr_lowpowî
()

22 
v
;

24 
asm
 volatile( "mcrÖ15, 0, %1, c7, c14, 0\n"

36 : "=&r" (
v
)

39 
	}
}

41 
ölöe
 
	$˝u_Àave_lowpowî
()

43 
v
;

45 
asm
 volatile( "mrcÖ15, 0, %0, c1, c0, 0\n"

51 : "=&r" (
v
)

54 
	}
}

56 
ölöe
 
	$∂©f‹m_do_lowpowî
(
˝u
)

67 
	`asm
(".word 0xe320f003\n"

72 i‡(
≥n_ªÀa£
 =
˝u
) {

87 #ifde‡
DEBUG


88 
	`¥ötk
("CPU%u: spuriou†wakeu∞ˇŒ\n", 
˝u
);

91 
	}
}

93 
	$∂©f‹m_˝u_kûl
(
˝u
)

95  
	`waô_f‹_com∂ëi⁄_timeout
(&
˝u_kûÀd
, 5000);

96 
	}
}

103 
	$∂©f‹m_˝u_dõ
(
˝u
)

105 #ifde‡
DEBUG


106 
this_˝u
 = 
	`h¨d_smp_¥o˚ss‹_id
();

108 i‡(
˝u
 !
this_˝u
) {

109 
	`¥ötk
(
KERN_CRIT
 "Eek!Ölatform_cpu_dieÑunning on %u, should be %u\n",

110 
this_˝u
, 
˝u
);

111 
	`BUG
();

115 
	`¥ötk
(
KERN_NOTICE
 "CPU%u: shutdown\n", 
˝u
);

116 
	`com∂ëe
(&
˝u_kûÀd
);

121 
	`˝u_íãr_lowpowî
();

122 
	`∂©f‹m_do_lowpowî
(
˝u
);

128 
	`˝u_Àave_lowpowî
();

129 
	}
}

131 
	$mach_˝u_dißbÀ
(
˝u
)

137  
˝u
 =0 ? -
EPERM
 : 0;

138 
	}
}

	@arch/arm/mach-realview/localtimer.c

11 
	~<löux/öô.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/dñay.h
>

14 
	~<löux/devi˚.h
>

15 
	~<löux/smp.h
>

16 
	~<löux/jiffõs.h
>

18 
	~<asm/mach/time.h
>

19 
	~<asm/h¨dw¨e/¨m_twd.h
>

20 
	~<asm/h¨dw¨e/gic.h
>

21 
	~<asm/h¨dw¨e.h
>

22 
	~<asm/io.h
>

23 
	~<asm/úq.h
>

25 
	#TWD_BASE
(
˝u
Ë(
	`__io_addªss
(
REALVIEW_TWD_BASE
) + \

26 ((
˝u
Ë* 
REALVIEW_TWD_SIZE
))

	)

28 
	gmpc‹e_timî_øã
;

36 
	$loˇl_timî_ack
()

38 
__iomem
 *
ba£
 = 
	`TWD_BASE
(
	`smp_¥o˚ss‹_id
());

40 i‡(
	`__øw_ªadl
(
ba£
 + 
TWD_TIMER_INTSTAT
)) {

41 
	`__øw_wrôñ
(1, 
ba£
 + 
TWD_TIMER_INTSTAT
);

46 
	}
}

48 
__˝uöô
 
	$loˇl_timî_£tup
(
˝u
)

50 
__iomem
 *
ba£
 = 
	`TWD_BASE
(
˝u
);

51 
lﬂd
, 
off£t
;

52 
u64
 
waôjiffõs
;

53 
cou¡
;

59 i‡(
mpc‹e_timî_øã
 == 0) {

60 
	`¥ötk
("CalibratingÜocalÅimer... ");

63 
waôjiffõs
 = 
	`gë_jiffõs_64
() + 1;

65 
	`gë_jiffõs_64
(Ë< 
waôjiffõs
)

66 
	`udñay
(10);

69 
waôjiffõs
 += 5;

72 
	`__øw_wrôñ
(0x1, 
ba£
 + 
TWD_TIMER_CONTROL
);

75 
	`__øw_wrôñ
(0xFFFFFFFFU, 
ba£
 + 
TWD_TIMER_COUNTER
);

77 
	`gë_jiffõs_64
(Ë< 
waôjiffõs
)

78 
	`udñay
(10);

80 
cou¡
 = 
	`__øw_ªadl
(
ba£
 + 
TWD_TIMER_COUNTER
);

82 
mpc‹e_timî_øã
 = (0xFFFFFFFFU - 
cou¡
Ë* (
HZ
 / 5);

84 
	`¥ötk
("%lu.%02luMHz.\n", 
mpc‹e_timî_øã
 / 1000000,

85 (
mpc‹e_timî_øã
 / 100000) % 100);

88 
lﬂd
 = 
mpc‹e_timî_øã
 / 
HZ
;

90 
	`__øw_wrôñ
(
lﬂd
, 
ba£
 + 
TWD_TIMER_LOAD
);

91 
	`__øw_wrôñ
(0x7, 
ba£
 + 
TWD_TIMER_CONTROL
);

98 
off£t
 = ((
mpc‹e_timî_øã
 / 
HZ
Ë/ (
NR_CPUS
 + 1)Ë* (
˝u
 + 1);

111 
lﬂd
 = (
sy°em_timî
->
	`off£t
(Ë* (
mpc‹e_timî_øã
 / 10000)) / 100;

114 
lﬂd
 = (lﬂd + 
off£t
Ë% (
mpc‹e_timî_øã
 / 
HZ
);

116 
	`__øw_wrôñ
(
lﬂd
, 
ba£
 + 
TWD_TIMER_COUNTER
);

119 
	`__øw_wrôñ
(1 << 
IRQ_LOCALTIMER
,

120 
	`__io_addªss
(
REALVIEW_GIC_DIST_BASE
Ë+ 
GIC_DIST_ENABLE_SET
);

121 
	}
}

126 
__˝uexô
 
	$loˇl_timî_°›
(
˝u
)

128 
	`__øw_wrôñ
(0, 
	`TWD_BASE
(
˝u
Ë+ 
TWD_TIMER_CONTROL
);

129 
	}
}

	@arch/arm/mach-realview/platsmp.c

11 
	~<löux/öô.h
>

12 
	~<löux/î∫o.h
>

13 
	~<löux/dñay.h
>

14 
	~<löux/devi˚.h
>

15 
	~<löux/smp.h
>

17 
	~<asm/ˇcheÊush.h
>

18 
	~<asm/h¨dw¨e/¨m_scu.h
>

19 
	~<asm/h¨dw¨e.h
>

20 
	~<asm/io.h
>

22 
ªÆvõw_£c⁄d¨y_°¨tup
();

28 vﬁ©ûê
__˝uöôd©a
 
	g≥n_ªÀa£
 = -1;

30 
__öô
 
	$gë_c‹e_cou¡
()

32 
nc‹es
;

34 
nc‹es
 = 
	`__øw_ªadl
(
	`__io_addªss
(
REALVIEW_MPCORE_SCU_BASE
Ë+ 
SCU_CONFIG
);

36  (
nc‹es
 & 0x03) + 1;

37 
	}
}

39 
DEFINE_SPINLOCK
(
boŸ_lock
);

41 
__˝uöô
 
	$∂©f‹m_£c⁄d¨y_öô
(
˝u
)

48 
	`smp_¸oss_ˇŒ_d⁄e
(
	`˝umask_of_˝u
(
˝u
));

55 
	`gic_˝u_öô
(0, 
	`__io_addªss
(
REALVIEW_GIC_CPU_BASE
));

61 
≥n_ªÀa£
 = -1;

62 
	`smp_wmb
();

67 
	`•ö_lock
(&
boŸ_lock
);

68 
	`•ö_u∆ock
(&
boŸ_lock
);

69 
	}
}

71 
__˝uöô
 
	$boŸ_£c⁄d¨y
(
˝u
, 
èsk_°ru˘
 *
idÀ
)

73 
timeout
;

79 
	`•ö_lock
(&
boŸ_lock
);

89 
≥n_ªÀa£
 = 
˝u
;

90 
	`Êush_ˇche_Æl
();

102 
	`smp_¸oss_ˇŒ
(
	`˝umask_of_˝u
(
˝u
));

104 
timeout
 = 
jiffõs
 + (1 * 
HZ
);

105 
	`time_bef‹e
(
jiffõs
, 
timeout
)) {

106 
	`smp_rmb
();

107 i‡(
≥n_ªÀa£
 == -1)

110 
	`udñay
(10);

117 
	`•ö_u∆ock
(&
boŸ_lock
);

119  
≥n_ªÀa£
 !-1 ? -
ENOSYS
 : 0;

120 
	}
}

122 
__öô
 
	$poke_mûo
()

124 
	`£c⁄d¨y_°¨tup
();

127 
≥n_ªÀa£
 = -1;

135 
	#REALVIEW_SYS_FLAGSS_OFFSET
 0x30

	)

136 
	`__øw_wrôñ
(
	`vút_to_phys
(
ªÆvõw_£c⁄d¨y_°¨tup
),

137 
	`__io_addªss
(
REALVIEW_SYS_BASE
) +

138 
REALVIEW_SYS_FLAGSS_OFFSET
);

139 
	#REALVIEW_SYS_FLAGSC_OFFSET
 0x34

	)

140 
	`__øw_wrôñ
(3,

141 
	`__io_addªss
(
REALVIEW_SYS_BASE
) +

142 
REALVIEW_SYS_FLAGSC_OFFSET
);

145 
	`mb
();

146 
	}
}

152 
__öô
 
	$smp_öô_˝us
()

154 
i
, 
nc‹es
 = 
	`gë_c‹e_cou¡
();

156 
i
 = 0; i < 
nc‹es
; i++)

157 
	`˝u_£t
(
i
, 
˝u_possibÀ_m≠
);

158 
	}
}

160 
__öô
 
	$smp_¥ï¨e_˝us
(
max_˝us
)

162 
nc‹es
 = 
	`gë_c‹e_cou¡
();

163 
˝u
 = 
	`smp_¥o˚ss‹_id
();

164 
i
;

167 i‡(
nc‹es
 == 0) {

168 
	`¥ötk
(
KERN_ERR


171 
nc‹es
 = 1;

174 i‡(
nc‹es
 > 
NR_CPUS
) {

175 
	`¥ötk
(
KERN_WARNING


178 
nc‹es
, 
NR_CPUS
);

179 
nc‹es
 = 
NR_CPUS
;

182 
	`smp_°‹e_˝u_öfo
(
˝u
);

187 i‡(
max_˝us
 > 
nc‹es
)

188 
max_˝us
 = 
nc‹es
;

193 
	`loˇl_timî_£tup
(
˝u
);

199 
i
 = 0; i < 
max_˝us
; i++)

200 
	`˝u_£t
(
i
, 
˝u_¥e£¡_m≠
);

208 i‡(
max_˝us
 > 1)

209 
	`poke_mûo
();

210 
	}
}

	@arch/arm/mach-realview/realview_eb.c

22 
	~<löux/öô.h
>

23 
	~<löux/∂©f‹m_devi˚.h
>

24 
	~<löux/sysdev.h
>

25 
	~<löux/amba/bus.h
>

27 
	~<asm/h¨dw¨e.h
>

28 
	~<asm/io.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/Àds.h
>

31 
	~<asm/mach-ty≥s.h
>

32 
	~<asm/h¨dw¨e/gic.h
>

33 
	~<asm/h¨dw¨e/ic°307.h
>

34 
	~<asm/h¨dw¨e/ˇche-l2x0.h
>

36 
	~<asm/mach/¨ch.h
>

37 
	~<asm/mach/m≠.h
>

38 
	~<asm/mach/mmc.h
>

40 
	~<asm/¨ch/úqs.h
>

42 
	~"c‹e.h
"

43 
	~"˛ock.h
"

45 
m≠_desc
 
	gªÆvõw_eb_io_desc
[] 
	g__öôd©a
 = {

47 .
vútuÆ
 = 
IO_ADDRESS
(
REALVIEW_SYS_BASE
),

48 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_SYS_BASE
),

49 .
	gÀngth
 = 
SZ_4K
,

50 .
	gty≥
 = 
MT_DEVICE
,

52 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_GIC_CPU_BASE
),

53 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_GIC_CPU_BASE
),

54 .
	gÀngth
 = 
SZ_4K
,

55 .
	gty≥
 = 
MT_DEVICE
,

57 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_GIC_DIST_BASE
),

58 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_GIC_DIST_BASE
),

59 .
	gÀngth
 = 
SZ_4K
,

60 .
	gty≥
 = 
MT_DEVICE
,

62 #ifde‡
CONFIG_REALVIEW_MPCORE


64 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_GIC1_CPU_BASE
),

65 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_GIC1_CPU_BASE
),

66 .
	gÀngth
 = 
SZ_4K
,

67 .
	gty≥
 = 
MT_DEVICE
,

69 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_GIC1_DIST_BASE
),

70 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_GIC1_DIST_BASE
),

71 .
	gÀngth
 = 
SZ_4K
,

72 .
	gty≥
 = 
MT_DEVICE
,

74 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_MPCORE_L220_BASE
),

75 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_MPCORE_L220_BASE
),

76 .
	gÀngth
 = 
SZ_8K
,

77 .
	gty≥
 = 
MT_DEVICE
,

81 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_SCTL_BASE
),

82 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_SCTL_BASE
),

83 .
	gÀngth
 = 
SZ_4K
,

84 .
	gty≥
 = 
MT_DEVICE
,

86 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_TIMER0_1_BASE
),

87 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_TIMER0_1_BASE
),

88 .
	gÀngth
 = 
SZ_4K
,

89 .
	gty≥
 = 
MT_DEVICE
,

91 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_TIMER2_3_BASE
),

92 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_TIMER2_3_BASE
),

93 .
	gÀngth
 = 
SZ_4K
,

94 .
	gty≥
 = 
MT_DEVICE
,

96 #ifde‡
CONFIG_DEBUG_LL


98 .
	gvútuÆ
 = 
IO_ADDRESS
(
REALVIEW_UART0_BASE
),

99 .
	gp‚
 = 
__phys_to_p‚
(
REALVIEW_UART0_BASE
),

100 .
	gÀngth
 = 
SZ_4K
,

101 .
	gty≥
 = 
MT_DEVICE
,

106 
__öô
 
	$ªÆvõw_eb_m≠_io
()

108 
	`iŸabÀ_öô
(
ªÆvõw_eb_io_desc
, 
	`ARRAY_SIZE
(realview_eb_io_desc));

109 
	}
}

112 
AMBA_DEVICE
(
Øci
, "Âga:04", 
AACI
, 
NULL
);

113 
AMBA_DEVICE
(
mmc0
, "Âga:05", 
MMCI0
, &
ªÆvõw_mmc0_∂©_d©a
);

114 
AMBA_DEVICE
(
kmi0
, "Âga:06", 
KMI0
, 
NULL
);

115 
AMBA_DEVICE
(
kmi1
, "Âga:07", 
KMI1
, 
NULL
);

116 
AMBA_DEVICE
(
u¨t3
, "Âga:09", 
UART3
, 
NULL
);

119 
AMBA_DEVICE
(
smc
, "dev:00", 
SMC
, 
NULL
);

120 
AMBA_DEVICE
(
˛cd
, "dev:20", 
CLCD
, &
˛cd_∂©_d©a
);

121 
AMBA_DEVICE
(
dmac
, "dev:30", 
DMAC
, 
NULL
);

122 
AMBA_DEVICE
(
s˘l
, "dev:e0", 
SCTL
, 
NULL
);

123 
AMBA_DEVICE
(
wdog
, "dev:e1", 
WATCHDOG
, 
NULL
);

124 
AMBA_DEVICE
(
gpio0
, "dev:e4", 
GPIO0
, 
NULL
);

125 
AMBA_DEVICE
(
gpio1
, "dev:e5", 
GPIO1
, 
NULL
);

126 
AMBA_DEVICE
(
gpio2
, "dev:e6", 
GPIO2
, 
NULL
);

127 
AMBA_DEVICE
(
πc
, "dev:e8", 
RTC
, 
NULL
);

128 
AMBA_DEVICE
(
sci0
, "dev:f0", 
SCI
, 
NULL
);

129 
AMBA_DEVICE
(
u¨t0
, "dev:f1", 
UART0
, 
NULL
);

130 
AMBA_DEVICE
(
u¨t1
, "dev:f2", 
UART1
, 
NULL
);

131 
AMBA_DEVICE
(
u¨t2
, "dev:f3", 
UART2
, 
NULL
);

132 
AMBA_DEVICE
(
s•0
, "dev:f4", 
SSP
, 
NULL
);

134 
amba_devi˚
 *
	gamba_devs
[] 
	g__öôd©a
 = {

135 &
dmac_devi˚
,

136 &
u¨t0_devi˚
,

137 &
u¨t1_devi˚
,

138 &
u¨t2_devi˚
,

139 &
u¨t3_devi˚
,

140 &
smc_devi˚
,

141 &
˛cd_devi˚
,

142 &
s˘l_devi˚
,

143 &
wdog_devi˚
,

144 &
gpio0_devi˚
,

145 &
gpio1_devi˚
,

146 &
gpio2_devi˚
,

147 &
πc_devi˚
,

148 &
sci0_devi˚
,

149 &
s•0_devi˚
,

150 &
Øci_devi˚
,

151 &
mmc0_devi˚
,

152 &
kmi0_devi˚
,

153 &
kmi1_devi˚
,

156 
__öô
 
	$gic_öô_úq
()

158 #ifde‡
CONFIG_REALVIEW_MPCORE


159 
∂d˘æ
;

160 
	`wrôñ
(0x0000a05f, 
	`__io_addªss
(
REALVIEW_SYS_LOCK
));

161 
∂d˘æ
 = 
	`ªadl
(
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_MPCORE_SYS_PLD_CTRL1
);

162 
∂d˘æ
 |= 0x00800000;

163 
	`wrôñ
(
∂d˘æ
, 
	`__io_addªss
(
REALVIEW_SYS_BASE
Ë+ 
REALVIEW_MPCORE_SYS_PLD_CTRL1
);

164 
	`wrôñ
(0x00000000, 
	`__io_addªss
(
REALVIEW_SYS_LOCK
));

166 
	`gic_di°_öô
(0, 
	`__io_addªss
(
REALVIEW_GIC_DIST_BASE
), 29);

167 
	`gic_˝u_öô
(0, 
	`__io_addªss
(
REALVIEW_GIC_CPU_BASE
));

168 #ifde‡
CONFIG_REALVIEW_MPCORE


169 
	`gic_di°_öô
(1, 
	`__io_addªss
(
REALVIEW_GIC1_DIST_BASE
), 64);

170 
	`gic_˝u_öô
(1, 
	`__io_addªss
(
REALVIEW_GIC1_CPU_BASE
));

171 
	`gic_ˇsˇde_úq
(1, 
IRQ_EB_IRQ1
);

173 
	}
}

175 
__öô
 
	$ªÆvõw_eb_öô
()

177 
i
;

179 #ifde‡
CONFIG_REALVIEW_MPCORE


182 
	`l2x0_öô
(
	`__io_addªss
(
REALVIEW_MPCORE_L220_BASE
), 0x00790000, 0xfe000fff);

184 
	`˛k_ªgi°î
(&
ªÆvõw_˛cd_˛k
);

186 
	`∂©f‹m_devi˚_ªgi°î
(&
ªÆvõw_Êash_devi˚
);

187 
	`∂©f‹m_devi˚_ªgi°î
(&
ªÆvõw_smc91x_devi˚
);

188 
	`∂©f‹m_devi˚_ªgi°î
(&
ªÆvõw_i2c_devi˚
);

190 
i
 = 0; i < 
	`ARRAY_SIZE
(
amba_devs
); i++) {

191 
amba_devi˚
 *
d
 = 
amba_devs
[
i
];

192 
	`amba_devi˚_ªgi°î
(
d
, &
iomem_ªsour˚
);

195 #ifde‡
CONFIG_LEDS


196 
Àds_evít
 = 
ªÆvõw_Àds_evít
;

198 
	}
}

200 
MACHINE_START
(
REALVIEW_EB
, "ARM-RealView EB")

202 .
	gphys_io
 = 
REALVIEW_UART0_BASE
,

203 .
	gio_pg_off°
 = (
IO_ADDRESS
(
REALVIEW_UART0_BASE
) >> 18) & 0xfffc,

204 .
	gboŸ_∑øms
 = 0x00000100,

205 .
	gm≠_io
 = 
ªÆvõw_eb_m≠_io
,

206 .
	göô_úq
 = 
gic_öô_úq
,

207 .
	gtimî
 = &
ªÆvõw_timî
,

208 .
	göô_machöe
 = 
ªÆvõw_eb_öô
,

209 
	gMACHINE_END


	@arch/arm/mach-rpc/dma.c

12 
	~<löux/¶ab.h
>

13 
	~<löux/mm™.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/öãºu±.h
>

16 
	~<löux/dma-m≠pög.h
>

18 
	~<asm/∑ge.h
>

19 
	~<asm/dma.h
>

20 
	~<asm/fiq.h
>

21 
	~<asm/io.h
>

22 
	~<asm/úq.h
>

23 
	~<asm/h¨dw¨e.h
>

24 
	~<asm/uac˚ss.h
>

26 
	~<asm/mach/dma.h
>

27 
	~<asm/h¨dw¨e/iomd.h
>

31 
	mdma_size_8
 = 1,

32 
	mdma_size_16
 = 2,

33 
	mdma_size_32
 = 4,

34 
	mdma_size_128
 = 16

35 } 
	tdma_size_t
;

38 
	#TRANSFER_SIZE
 2

	)

40 
	#CURA
 (0)

	)

41 
	#ENDA
 (
IOMD_IO0ENDA
 - 
IOMD_IO0CURA
)

	)

42 
	#CURB
 (
IOMD_IO0CURB
 - 
IOMD_IO0CURA
)

	)

43 
	#ENDB
 (
IOMD_IO0ENDB
 - 
IOMD_IO0CURA
)

	)

44 
	#CR
 (
IOMD_IO0CR
 - 
IOMD_IO0CURA
)

	)

45 
	#ST
 (
IOMD_IO0ST
 - 
IOMD_IO0CURA
)

	)

47 
	$iomd_gë_√xt_sg
(
sˇâîli°
 *
sg
, 
dma_t
 *
dma
)

49 
íd
, 
off£t
, 
Êags
 = 0;

51 i‡(
dma
->
sg
) {

52 
sg
->
dma_addªss
 = 
dma
->sg->dma_address;

53 
off£t
 = 
sg
->
dma_addªss
 & ~
PAGE_MASK
;

55 
íd
 = 
off£t
 + 
dma
->
sg
->
Àngth
;

57 i‡(
íd
 > 
PAGE_SIZE
)

58 
íd
 = 
PAGE_SIZE
;

60 i‡(
off£t
 + 
TRANSFER_SIZE
 >
íd
)

61 
Êags
 |
DMA_END_L
;

63 
sg
->
Àngth
 = 
íd
 - 
TRANSFER_SIZE
;

65 
dma
->
sg
->
Àngth
 -
íd
 - 
off£t
;

66 
dma
->
sg
->
dma_addªss
 +
íd
 - 
off£t
;

68 i‡(
dma
->
sg
->
Àngth
 == 0) {

69 i‡(
dma
->
sgcou¡
 > 1) {

70 
dma
->
sg
++;

71 
dma
->
sgcou¡
--;

73 
dma
->
sg
 = 
NULL
;

74 
Êags
 |
DMA_END_S
;

78 
Êags
 = 
DMA_END_S
 | 
DMA_END_L
;

79 
sg
->
dma_addªss
 = 0;

80 
sg
->
Àngth
 = 0;

83 
sg
->
Àngth
 |
Êags
;

84 
	}
}

86 
úqªtu∫_t
 
	$iomd_dma_h™dÀ
(
úq
, *
dev_id
)

88 
dma_t
 *
dma
 = (dma_à*)
dev_id
;

89 
ba£
 = 
dma
->
dma_ba£
;

92 
°©us
;

94 
°©us
 = 
	`iomd_ªadb
(
ba£
 + 
ST
);

95 i‡(!(
°©us
 & 
DMA_ST_INT
))

96  
IRQ_HANDLED
;

98 i‡((
dma
->
°©e
 ^ 
°©us
Ë& 
DMA_ST_AB
)

99 
	`iomd_gë_√xt_sg
(&
dma
->
cur_sg
, dma);

101 
°©us
 & (
DMA_ST_OFL
 | 
DMA_ST_AB
)) {

102 
DMA_ST_OFL
:

103 
DMA_ST_AB
:

104 
	`iomd_wrôñ
(
dma
->
cur_sg
.
dma_addªss
, 
ba£
 + 
CURA
);

105 
	`iomd_wrôñ
(
dma
->
cur_sg
.
Àngth
, 
ba£
 + 
ENDA
);

106 
dma
->
°©e
 = 
DMA_ST_AB
;

109 
DMA_ST_OFL
 | 
DMA_ST_AB
:

111 
	`iomd_wrôñ
(
dma
->
cur_sg
.
dma_addªss
, 
ba£
 + 
CURB
);

112 
	`iomd_wrôñ
(
dma
->
cur_sg
.
Àngth
, 
ba£
 + 
ENDB
);

113 
dma
->
°©e
 = 0;

117 i‡(
°©us
 & 
DMA_ST_OFL
 &&

118 
dma
->
cur_sg
.
Àngth
 =(
DMA_END_S
|
DMA_END_L
))

122 
dma
->
°©e
 = ~
DMA_ST_AB
;

123 
	`dißbÀ_úq
(
úq
);

125  
IRQ_HANDLED
;

126 
	}
}

128 
	$iomd_ªque°_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

130  
	`ªque°_úq
(
dma
->
dma_úq
, 
iomd_dma_h™dÀ
,

131 
IRQF_DISABLED
, 
dma
->
devi˚_id
, dma);

132 
	}
}

134 
	$iomd_‰ì_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

136 
	`‰ì_úq
(
dma
->
dma_úq
, dma);

137 
	}
}

139 
	$iomd_íabÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

141 
dma_ba£
 = 
dma
->dma_base;

142 
˘æ
 = 
TRANSFER_SIZE
 | 
DMA_CR_E
;

144 i‡(
dma
->
övÆid
) {

145 
dma
->
övÆid
 = 0;

151 i‡(!
dma
->
sg
) {

152 
dma
->
sg
 = &dma->
buf
;

153 
dma
->
sgcou¡
 = 1;

154 
dma
->
buf
.
Àngth
 = dma->
cou¡
;

155 
dma
->
buf
.
dma_addªss
 = 
	`dma_m≠_sögÀ
(
NULL
,

156 
dma
->
addr
, dma->
cou¡
,

157 
dma
->
dma_mode
 =
DMA_MODE_READ
 ?

158 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

161 
	`iomd_wrôeb
(
DMA_CR_C
, 
dma_ba£
 + 
CR
);

162 
dma
->
°©e
 = 
DMA_ST_AB
;

165 i‡(
dma
->
dma_mode
 =
DMA_MODE_READ
)

166 
˘æ
 |
DMA_CR_D
;

168 
	`iomd_wrôeb
(
˘æ
, 
dma_ba£
 + 
CR
);

169 
	`íabÀ_úq
(
dma
->
dma_úq
);

170 
	}
}

172 
	$iomd_dißbÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

174 
dma_ba£
 = 
dma
->dma_base;

175 
Êags
;

177 
	`loˇl_úq_ßve
(
Êags
);

178 i‡(
dma
->
°©e
 !~
DMA_ST_AB
)

179 
	`dißbÀ_úq
(
dma
->
dma_úq
);

180 
	`iomd_wrôeb
(0, 
dma_ba£
 + 
CR
);

181 
	`loˇl_úq_ª°‹e
(
Êags
);

182 
	}
}

184 
	$iomd_£t_dma_•ìd
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
, 
cy˛e
)

186 
t¸
, 
•ìd
;

188 i‡(
cy˛e
 < 188)

189 
•ìd
 = 3;

190 i‡(
cy˛e
 <= 250)

191 
•ìd
 = 2;

192 i‡(
cy˛e
 < 438)

193 
•ìd
 = 1;

195 
•ìd
 = 0;

197 
t¸
 = 
	`iomd_ªadb
(
IOMD_DMATCR
);

198 
•ìd
 &= 3;

200 
ch™√l
) {

201 
DMA_0
:

202 
t¸
 = (t¸ & ~0x03Ë| 
•ìd
;

205 
DMA_1
:

206 
t¸
 = (t¸ & ~0x0cË| (
•ìd
 << 2);

209 
DMA_2
:

210 
t¸
 = (t¸ & ~0x30Ë| (
•ìd
 << 4);

213 
DMA_3
:

214 
t¸
 = (t¸ & ~0xc0Ë| (
•ìd
 << 6);

221 
	`iomd_wrôeb
(
t¸
, 
IOMD_DMATCR
);

223  
•ìd
;

224 
	}
}

226 
dma_›s
 
	giomd_dma_›s
 = {

227 .
ty≥
 = "IOMD",

228 .
	gªque°
 = 
iomd_ªque°_dma
,

229 .
	g‰ì
 = 
iomd_‰ì_dma
,

230 .
	gíabÀ
 = 
iomd_íabÀ_dma
,

231 .
	gdißbÀ
 = 
iomd_dißbÀ_dma
,

232 .
	g£t•ìd
 = 
iomd_£t_dma_•ìd
,

235 
fiq_h™dÀr
 
	gfh
 = {

236 .
«me
 = "floppydma"

239 
	$Ê›py_íabÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

241 *
fiqh™dÀr_°¨t
;

242 
fiqh™dÀr_Àngth
;

243 
±_ªgs
 
ªgs
;

245 i‡(
dma
->
sg
)

246 
	`BUG
();

248 i‡(
dma
->
dma_mode
 =
DMA_MODE_READ
) {

249 
Ê›py_fiqö_°¨t
, 
Ê›py_fiqö_íd
;

250 
fiqh™dÀr_°¨t
 = &
Ê›py_fiqö_°¨t
;

251 
fiqh™dÀr_Àngth
 = &
Ê›py_fiqö_íd
 - &
Ê›py_fiqö_°¨t
;

253 
Ê›py_fiqout_°¨t
, 
Ê›py_fiqout_íd
;

254 
fiqh™dÀr_°¨t
 = &
Ê›py_fiqout_°¨t
;

255 
fiqh™dÀr_Àngth
 = &
Ê›py_fiqout_íd
 - &
Ê›py_fiqout_°¨t
;

258 
ªgs
.
ARM_r9
 = 
dma
->
cou¡
;

259 
ªgs
.
ARM_r10
 = ()
dma
->
addr
;

260 
ªgs
.
ARM_Â
 = ()
FLOPPYDMA_BASE
;

262 i‡(
	`˛aim_fiq
(&
fh
)) {

263 
	`¥ötk
("floppydma: couldn't claim FIQ.\n");

267 
	`£t_fiq_h™dÀr
(
fiqh™dÀr_°¨t
, 
fiqh™dÀr_Àngth
);

268 
	`£t_fiq_ªgs
(&
ªgs
);

269 
	`íabÀ_fiq
(
dma
->
dma_úq
);

270 
	}
}

272 
	$Ê›py_dißbÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

274 
	`dißbÀ_fiq
(
dma
->
dma_úq
);

275 
	`ªÀa£_fiq
(&
fh
);

276 
	}
}

278 
	$Ê›py_gë_ªsidue
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

280 
±_ªgs
 
ªgs
;

281 
	`gë_fiq_ªgs
(&
ªgs
);

282  
ªgs
.
ARM_r9
;

283 
	}
}

285 
dma_›s
 
	gÊ›py_dma_›s
 = {

286 .
ty≥
 = "FIQDMA",

287 .
	gíabÀ
 = 
Ê›py_íabÀ_dma
,

288 .
	gdißbÀ
 = 
Ê›py_dißbÀ_dma
,

289 .
	gªsidue
 = 
Ê›py_gë_ªsidue
,

295 
	$sound_íabÀ_dißbÀ_dma
(
dmach_t
 
ch™√l
, 
dma_t
 *
dma
)

297 
	}
}

299 
dma_›s
 
	gsound_dma_›s
 = {

300 .
ty≥
 = "VIRTUAL",

301 .
	gíabÀ
 = 
sound_íabÀ_dißbÀ_dma
,

302 .
	gdißbÀ
 = 
sound_íabÀ_dißbÀ_dma
,

305 
__öô
 
	$¨ch_dma_öô
(
dma_t
 *
dma
)

307 
	`iomd_wrôeb
(0, 
IOMD_IO0CR
);

308 
	`iomd_wrôeb
(0, 
IOMD_IO1CR
);

309 
	`iomd_wrôeb
(0, 
IOMD_IO2CR
);

310 
	`iomd_wrôeb
(0, 
IOMD_IO3CR
);

312 
	`iomd_wrôeb
(0xa0, 
IOMD_DMATCR
);

314 
dma
[
DMA_0
].
dma_ba£
 = 
IOMD_IO0CURA
;

315 
dma
[
DMA_0
].
dma_úq
 = 
IRQ_DMA0
;

316 
dma
[
DMA_0
].
d_›s
 = &
iomd_dma_›s
;

317 
dma
[
DMA_1
].
dma_ba£
 = 
IOMD_IO1CURA
;

318 
dma
[
DMA_1
].
dma_úq
 = 
IRQ_DMA1
;

319 
dma
[
DMA_1
].
d_›s
 = &
iomd_dma_›s
;

320 
dma
[
DMA_2
].
dma_ba£
 = 
IOMD_IO2CURA
;

321 
dma
[
DMA_2
].
dma_úq
 = 
IRQ_DMA2
;

322 
dma
[
DMA_2
].
d_›s
 = &
iomd_dma_›s
;

323 
dma
[
DMA_3
].
dma_ba£
 = 
IOMD_IO3CURA
;

324 
dma
[
DMA_3
].
dma_úq
 = 
IRQ_DMA3
;

325 
dma
[
DMA_3
].
d_›s
 = &
iomd_dma_›s
;

326 
dma
[
DMA_S0
].
dma_ba£
 = 
IOMD_SD0CURA
;

327 
dma
[
DMA_S0
].
dma_úq
 = 
IRQ_DMAS0
;

328 
dma
[
DMA_S0
].
d_›s
 = &
iomd_dma_›s
;

329 
dma
[
DMA_S1
].
dma_ba£
 = 
IOMD_SD1CURA
;

330 
dma
[
DMA_S1
].
dma_úq
 = 
IRQ_DMAS1
;

331 
dma
[
DMA_S1
].
d_›s
 = &
iomd_dma_›s
;

332 
dma
[
DMA_VIRTUAL_FLOPPY
].
dma_úq
 = 
FIQ_FLOPPYDATA
;

333 
dma
[
DMA_VIRTUAL_FLOPPY
].
d_›s
 = &
Ê›py_dma_›s
;

334 
dma
[
DMA_VIRTUAL_SOUND
].
d_›s
 = &
sound_dma_›s
;

340 
	`iomd_wrôeb
(
DMA_EXT_IO3
|
DMA_EXT_IO2
, 
IOMD_DMAEXT
);

341 
	}
}

	@arch/arm/mach-rpc/irq.c

1 
	~<löux/öô.h
>

2 
	~<löux/li°.h
>

4 
	~<asm/mach/úq.h
>

5 
	~<asm/h¨dw¨e/iomd.h
>

6 
	~<asm/úq.h
>

7 
	~<asm/io.h
>

9 
	$iomd_ack_úq_a
(
úq
)

11 
vÆ
, 
mask
;

13 
mask
 = 1 << 
úq
;

14 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

15 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKA
);

16 
	`iomd_wrôeb
(
mask
, 
IOMD_IRQCLRA
);

17 
	}
}

19 
	$iomd_mask_úq_a
(
úq
)

21 
vÆ
, 
mask
;

23 
mask
 = 1 << 
úq
;

24 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

25 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKA
);

26 
	}
}

28 
	$iomd_unmask_úq_a
(
úq
)

30 
vÆ
, 
mask
;

32 
mask
 = 1 << 
úq
;

33 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKA
);

34 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKA
);

35 
	}
}

37 
úq_chù
 
	giomd_a_chù
 = {

38 .
ack
 = 
iomd_ack_úq_a
,

39 .
	gmask
 = 
iomd_mask_úq_a
,

40 .
	gunmask
 = 
iomd_unmask_úq_a
,

43 
	$iomd_mask_úq_b
(
úq
)

45 
vÆ
, 
mask
;

47 
mask
 = 1 << (
úq
 & 7);

48 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKB
);

49 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_IRQMASKB
);

50 
	}
}

52 
	$iomd_unmask_úq_b
(
úq
)

54 
vÆ
, 
mask
;

56 
mask
 = 1 << (
úq
 & 7);

57 
vÆ
 = 
	`iomd_ªadb
(
IOMD_IRQMASKB
);

58 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_IRQMASKB
);

59 
	}
}

61 
úq_chù
 
	giomd_b_chù
 = {

62 .
ack
 = 
iomd_mask_úq_b
,

63 .
	gmask
 = 
iomd_mask_úq_b
,

64 .
	gunmask
 = 
iomd_unmask_úq_b
,

67 
	$iomd_mask_úq_dma
(
úq
)

69 
vÆ
, 
mask
;

71 
mask
 = 1 << (
úq
 & 7);

72 
vÆ
 = 
	`iomd_ªadb
(
IOMD_DMAMASK
);

73 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_DMAMASK
);

74 
	}
}

76 
	$iomd_unmask_úq_dma
(
úq
)

78 
vÆ
, 
mask
;

80 
mask
 = 1 << (
úq
 & 7);

81 
vÆ
 = 
	`iomd_ªadb
(
IOMD_DMAMASK
);

82 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_DMAMASK
);

83 
	}
}

85 
úq_chù
 
	giomd_dma_chù
 = {

86 .
ack
 = 
iomd_mask_úq_dma
,

87 .
	gmask
 = 
iomd_mask_úq_dma
,

88 .
	gunmask
 = 
iomd_unmask_úq_dma
,

91 
	$iomd_mask_úq_fiq
(
úq
)

93 
vÆ
, 
mask
;

95 
mask
 = 1 << (
úq
 & 7);

96 
vÆ
 = 
	`iomd_ªadb
(
IOMD_FIQMASK
);

97 
	`iomd_wrôeb
(
vÆ
 & ~
mask
, 
IOMD_FIQMASK
);

98 
	}
}

100 
	$iomd_unmask_úq_fiq
(
úq
)

102 
vÆ
, 
mask
;

104 
mask
 = 1 << (
úq
 & 7);

105 
vÆ
 = 
	`iomd_ªadb
(
IOMD_FIQMASK
);

106 
	`iomd_wrôeb
(
vÆ
 | 
mask
, 
IOMD_FIQMASK
);

107 
	}
}

109 
úq_chù
 
	giomd_fiq_chù
 = {

110 .
ack
 = 
iomd_mask_úq_fiq
,

111 .
	gmask
 = 
iomd_mask_úq_fiq
,

112 .
	gunmask
 = 
iomd_unmask_úq_fiq
,

115 
__öô
 
	$Ωc_öô_úq
()

117 
úq
, 
Êags
;

119 
	`iomd_wrôeb
(0, 
IOMD_IRQMASKA
);

120 
	`iomd_wrôeb
(0, 
IOMD_IRQMASKB
);

121 
	`iomd_wrôeb
(0, 
IOMD_FIQMASK
);

122 
	`iomd_wrôeb
(0, 
IOMD_DMAMASK
);

124 
úq
 = 0; irq < 
NR_IRQS
; irq++) {

125 
Êags
 = 
IRQF_VALID
;

127 i‡(
úq
 <= 6 || (irq >= 9 && irq <= 15))

128 
Êags
 |
IRQF_PROBE
;

130 i‡(
úq
 == 21 || (irq >= 16 && irq <= 19) ||

131 
úq
 =
IRQ_KEYBOARDTX
)

132 
Êags
 |
IRQF_NOAUTOEN
;

134 
úq
) {

136 
	`£t_úq_chù
(
úq
, &
iomd_a_chù
);

137 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

138 
	`£t_úq_Êags
(
úq
, 
Êags
);

142 
	`£t_úq_chù
(
úq
, &
iomd_b_chù
);

143 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

144 
	`£t_úq_Êags
(
úq
, 
Êags
);

148 
	`£t_úq_chù
(
úq
, &
iomd_dma_chù
);

149 
	`£t_úq_h™dÀr
(
úq
, 
h™dÀ_Àvñ_úq
);

150 
	`£t_úq_Êags
(
úq
, 
Êags
);

154 
	`£t_úq_chù
(
úq
, &
iomd_fiq_chù
);

155 
	`£t_úq_Êags
(
úq
, 
IRQF_VALID
);

160 
	`öô_FIQ
();

161 
	}
}

	@arch/arm/mach-rpc/riscpc.c

12 
	~<löux/kî√l.h
>

13 
	~<löux/ây.h
>

14 
	~<löux/dñay.h
>

15 
	~<löux/pm.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/devi˚.h
>

19 
	~<löux/£rül_8250.h
>

20 
	~<löux/∑è_∂©f‹m.h
>

22 
	~<asm/ñf.h
>

23 
	~<asm/io.h
>

24 
	~<asm/mach-ty≥s.h
>

25 
	~<asm/h¨dw¨e.h
>

26 
	~<asm/∑ge.h
>

27 
	~<asm/domaö.h
>

28 
	~<asm/£tup.h
>

30 
	~<asm/mach/m≠.h
>

31 
	~<asm/mach/¨ch.h
>

32 
	~<asm/mach/time.h
>

34 
Ωc_öô_úq
();

36 
	gvøm_size
;

37 
	gmemc_˘æ_ªg
;

38 
	gnumbî_mfm_drives
;

40 
__öô
 
	$∑r£_èg_ac‹n
(c⁄° 
èg
 *tag)

42 
memc_˘æ_ªg
 = 
èg
->
u
.
ac‹n
.
memc_c⁄åﬁ_ªg
;

43 
numbî_mfm_drives
 = 
èg
->
u
.
ac‹n
.
adfsdrives
;

45 
èg
->
u
.
ac‹n
.
vøm_∑ges
) {

47 
vøm_size
 +
PAGE_SIZE
 * 256;

49 
vøm_size
 +
PAGE_SIZE
 * 256;

54 i‡(
vøm_size
) {

55 
desc
->
video_°¨t
 = 0x02000000;

56 
desc
->
video_íd
 = 0x02000000 + 
vøm_size
;

60 
	}
}

62 
__ègèbÀ
(
ATAG_ACORN
, 
∑r£_èg_ac‹n
);

64 
m≠_desc
 
	gΩc_io_desc
[] 
	g__öôd©a
 = {

66 .
vútuÆ
 = 
SCREEN_BASE
,

67 .
	gp‚
 = 
__phys_to_p‚
(
SCREEN_START
),

68 .
	gÀngth
 = 2*1048576,

69 .
	gty≥
 = 
MT_DEVICE


71 .
	gvútuÆ
 = (
u32
)
IO_BASE
,

72 .
	gp‚
 = 
__phys_to_p‚
(
IO_START
),

73 .
	gÀngth
 = 
IO_SIZE
 ,

74 .
	gty≥
 = 
MT_DEVICE


76 .
	gvútuÆ
 = 
EASI_BASE
,

77 .
	gp‚
 = 
__phys_to_p‚
(
EASI_START
),

78 .
	gÀngth
 = 
EASI_SIZE
,

79 .
	gty≥
 = 
MT_DEVICE


83 
__öô
 
	$Ωc_m≠_io
()

85 
	`iŸabÀ_öô
(
Ωc_io_desc
, 
	`ARRAY_SIZE
(rpc_io_desc));

90 
	`outb
(0xc, 0x3f2);

95 
ñf_hwˇp
 &~
HWCAP_HALF
;

96 
	}
}

98 
ªsour˚
 
	gac‹nfb_ªsour˚s
[] = {

100 .
°¨t
 = 0x03400000,

101 .
	gíd
 = 0x035fffff,

102 .
	gÊags
 = 
IORESOURCE_MEM
,

104 .
	g°¨t
 = 
IRQ_VSYNCPULSE
,

105 .
	gíd
 = 
IRQ_VSYNCPULSE
,

106 .
	gÊags
 = 
IORESOURCE_IRQ
,

110 
∂©f‹m_devi˚
 
	gac‹nfb_devi˚
 = {

111 .
«me
 = "acornfb",

112 .
	gid
 = -1,

113 .
	gdev
 = {

114 .
cohîít_dma_mask
 = 0xffffffff,

116 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
ac‹nfb_ªsour˚s
),

117 .
	gªsour˚
 = 
ac‹nfb_ªsour˚s
,

120 
ªsour˚
 
	giomd_ªsour˚s
[] = {

122 .
°¨t
 = 0x03200000,

123 .
	gíd
 = 0x0320ffff,

124 .
	gÊags
 = 
IORESOURCE_MEM
,

128 
∂©f‹m_devi˚
 
	giomd_devi˚
 = {

129 .
«me
 = "iomd",

130 .
	gid
 = -1,

131 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
iomd_ªsour˚s
),

132 .
	gªsour˚
 = 
iomd_ªsour˚s
,

135 
∂©f‹m_devi˚
 
	gkbd_devi˚
 = {

136 .
«me
 = "kart",

137 .
	gid
 = -1,

138 .
	gdev
 = {

139 .
∑ª¡
 = &
iomd_devi˚
.
dev
,

143 
∂©_£rül8250_p‹t
 
	g£rül_∂©f‹m_d©a
[] = {

145 .
m≠ba£
 = 0x03010fe0,

146 .
	gúq
 = 10,

147 .
	gu¨t˛k
 = 1843200,

148 .
	gªgshi·
 = 2,

149 .
	giŸy≥
 = 
UPIO_MEM
,

150 .
	gÊags
 = 
UPF_BOOT_AUTOCONF
 | 
UPF_IOREMAP
 | 
UPF_SKIP_TEST
,

155 
∂©f‹m_devi˚
 
	g£rül_devi˚
 = {

156 .
«me
 = "serial8250",

157 .
	gid
 = 
PLAT8250_DEV_PLATFORM
,

158 .
	gdev
 = {

159 .
∂©f‹m_d©a
 = 
£rül_∂©f‹m_d©a
,

163 
∑è_∂©f‹m_öfo
 
	g∑è_∂©f‹m_d©a
 = {

164 .
i›‹t_shi·
 = 2,

167 
ªsour˚
 
	g∑è_ªsour˚s
[] = {

169 .
°¨t
 = 0x030107c0,

170 .
	gíd
 = 0x030107df,

171 .
	gÊags
 = 
IORESOURCE_MEM
,

174 .
°¨t
 = 0x03010fd8,

175 .
	gíd
 = 0x03010fdb,

176 .
	gÊags
 = 
IORESOURCE_MEM
,

179 .
°¨t
 = 
IRQ_HARDDISK
,

180 .
	gíd
 = 
IRQ_HARDDISK
,

181 .
	gÊags
 = 
IORESOURCE_IRQ
,

185 
∂©f‹m_devi˚
 
	g∑è_devi˚
 = {

186 .
«me
 = "pata_platform",

187 .
	gid
 = -1,

188 .
	gnum_ªsour˚s
 = 
ARRAY_SIZE
(
∑è_ªsour˚s
),

189 .
	gªsour˚
 = 
∑è_ªsour˚s
,

190 .
	gdev
 = {

191 .
∂©f‹m_d©a
 = &
∑è_∂©f‹m_d©a
,

192 .
	gcohîít_dma_mask
 = ~0,

196 
∂©f‹m_devi˚
 *
	gdevs
[] 
	g__öôd©a
 = {

197 &
iomd_devi˚
,

198 &
kbd_devi˚
,

199 &
£rül_devi˚
,

200 &
ac‹nfb_devi˚
,

201 &
∑è_devi˚
,

204 
__öô
 
	$Ωc_öô
()

206  
	`∂©f‹m_add_devi˚s
(
devs
, 
	`ARRAY_SIZE
(devs));

207 
	}
}

209 
¨ch_öôˇŒ
(
Ωc_öô
);

211 
sys_timî
 
ioc_timî
;

213 
MACHINE_START
(
RISCPC
, "Acorn-RiscPC")

215 .
	gphys_io
 = 0x03000000,

216 .
	gio_pg_off°
 = ((0xe0000000) >> 18) & 0xfffc,

217 .
	gboŸ_∑øms
 = 0x10000100,

218 .
	gª£rve_Õ0
 = 1,

219 .
	gª£rve_Õ1
 = 1,

220 .
	gm≠_io
 = 
Ωc_m≠_io
,

221 .
	göô_úq
 = 
Ωc_öô_úq
,

222 .
	gtimî
 = &
ioc_timî
,

223 
	gMACHINE_END


	@arch/arm/mach-s3c2400/gpio.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/öãºu±.h
>

26 
	~<löux/i›‹t.h
>

28 
	~<asm/h¨dw¨e.h
>

29 
	~<asm/úq.h
>

30 
	~<asm/io.h
>

32 
	~<asm/¨ch/ªgs-gpio.h
>

34 
	$s3c2400_gpio_gëúq
(
pö
)

36 i‡(
pö
 < 
S3C2410_GPE0
 ||Öö > 
S3C2400_GPE7_EINT7
)

39  (
pö
 - 
S3C2410_GPE0
Ë+ 
IRQ_EINT0
;

40 
	}
}

42 
EXPORT_SYMBOL
(
s3c2400_gpio_gëúq
);

	@arch/arm/mach-s3c2410/bast-irq.c

24 
	~<löux/öô.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/i›‹t.h
>

27 
	~<löux/sysdev.h
>

29 
	~<asm/mach-ty≥s.h
>

31 
	~<asm/h¨dw¨e.h
>

32 
	~<asm/úq.h
>

33 
	~<asm/io.h
>

35 
	~<asm/mach/úq.h
>

37 
	~<asm/¨ch/ªgs-úq.h
>

38 
	~<asm/¨ch/ba°-m≠.h
>

39 
	~<asm/¨ch/ba°-úq.h
>

41 
	~<asm/∂©-s3c24xx/úq.h
>

44 
	~<asm/debug-Œ.h
>

47 
	#úqdbf
(
x
...)

	)

48 
	#úqdbf2
(
x
...)

	)

56 
	gba°_pc104_úqmasks
[] = {

75 
	gba°_pc104_úqs
[] = { 3, 5, 7, 10 };

78 
	$ba°_pc104_mask
(
úqno
)

80 
ãmp
;

82 
ãmp
 = 
	`__øw_ªadb
(
BAST_VA_PC104_IRQMASK
);

83 
ãmp
 &~
ba°_pc104_úqmasks
[
úqno
];

84 
	`__øw_wrôeb
(
ãmp
, 
BAST_VA_PC104_IRQMASK
);

85 
	}
}

88 
	$ba°_pc104_maskack
(
úqno
)

90 
úq_desc
 *
desc
 = irq_des¯+ 
IRQ_ISA
;

92 
	`ba°_pc104_mask
(
úqno
);

93 
desc
->
chù
->
	`ack
(
IRQ_ISA
);

94 
	}
}

97 
	$ba°_pc104_unmask
(
úqno
)

99 
ãmp
;

101 
ãmp
 = 
	`__øw_ªadb
(
BAST_VA_PC104_IRQMASK
);

102 
ãmp
 |
ba°_pc104_úqmasks
[
úqno
];

103 
	`__øw_wrôeb
(
ãmp
, 
BAST_VA_PC104_IRQMASK
);

104 
	}
}

106 
úq_chù
 
	gba°_pc104_chù
 = {

107 .
mask
 = 
ba°_pc104_mask
,

108 .
	gunmask
 = 
ba°_pc104_unmask
,

109 .
	gack
 = 
ba°_pc104_maskack


113 
	$ba°_úq_pc104_demux
(
úq
,

114 
úq_desc
 *
desc
)

116 
°©
;

117 
úqno
;

118 
i
;

120 
°©
 = 
	`__øw_ªadb
(
BAST_VA_PC104_IRQREQ
) & 0xf;

122 i‡(
	`u∆ikñy
(
°©
 == 0)) {

125 
desc
 = 
úq_desc
 + 
IRQ_ISA
;

126 
desc
->
chù
->
	`ack
(
IRQ_ISA
);

130 
i
 = 0; 
°©
 != 0; i++, stat >>= 1) {

131 i‡(
°©
 & 1) {

132 
úqno
 = 
ba°_pc104_úqs
[
i
];

133 
desc
 = 
úq_desc
 + 
úqno
;

134 
	`desc_h™dÀ_úq
(
úqno
, 
desc
);

138 
	}
}

140 
__öô
 
	$ba°_úq_öô
()

142 
i
;

144 i‡(
	`machöe_is_ba°
()) {

145 
	`¥ötk
(
KERN_INFO
 "BAST PC104 IRQÑouting, (c) 2005 Simtec Electronics\n");

149 
	`__øw_wrôeb
(0x0, 
BAST_VA_PC104_IRQMASK
);

151 
	`£t_úq_chaöed_h™dÀr
(
IRQ_ISA
, 
ba°_úq_pc104_demux
);

155 
i
 = 0; i < 4; i++) {

156 
úqno
 = 
ba°_pc104_úqs
[
i
];

158 
	`£t_úq_chù
(
úqno
, &
ba°_pc104_chù
);

159 
	`£t_úq_h™dÀr
(
úqno
, 
h™dÀ_Àvñ_úq
);

160 
	`£t_úq_Êags
(
úqno
, 
IRQF_VALID
);

165 
	}
}

167 
¨ch_öôˇŒ
(
ba°_úq_öô
);

	@arch/arm/mach-s3c2410/clock.c

23 
	~<löux/öô.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/kî√l.h
>

26 
	~<löux/li°.h
>

27 
	~<löux/î∫o.h
>

28 
	~<löux/îr.h
>

29 
	~<löux/sysdev.h
>

30 
	~<löux/˛k.h
>

31 
	~<löux/muãx.h
>

32 
	~<löux/dñay.h
>

33 
	~<löux/£rül_c‹e.h
>

35 
	~<asm/mach/m≠.h
>

37 
	~<asm/h¨dw¨e.h
>

38 
	~<asm/io.h
>

40 
	~<asm/¨ch/ªgs-£rül.h
>

41 
	~<asm/¨ch/ªgs-˛ock.h
>

42 
	~<asm/¨ch/ªgs-gpio.h
>

44 
	~<asm/∂©-s3c24xx/s3c2410.h
>

45 
	~<asm/∂©-s3c24xx/˛ock.h
>

46 
	~<asm/∂©-s3c24xx/˝u.h
>

48 
	$s3c2410_˛kc⁄_íabÀ
(
˛k
 *˛k, 
íabÀ
)

50 
˛ocks
 = 
˛k
->
˘æbô
;

51 
˛kc⁄
;

53 
˛kc⁄
 = 
	`__øw_ªadl
(
S3C2410_CLKCON
);

55 i‡(
íabÀ
)

56 
˛kc⁄
 |
˛ocks
;

58 
˛kc⁄
 &~
˛ocks
;

61 
˛kc⁄
 &~(
S3C2410_CLKCON_IDLE
|
S3C2410_CLKCON_POWER
);

63 
	`__øw_wrôñ
(
˛kc⁄
, 
S3C2410_CLKCON
);

66 
	}
}

68 
	$s3c2410_u∂l_íabÀ
(
˛k
 *˛k, 
íabÀ
)

70 
˛k¶ow
 = 
	`__øw_ªadl
(
S3C2410_CLKSLOW
);

71 
‹ig
 = 
˛k¶ow
;

73 i‡(
íabÀ
)

74 
˛k¶ow
 &~
S3C2410_CLKSLOW_UCLK_OFF
;

76 
˛k¶ow
 |
S3C2410_CLKSLOW_UCLK_OFF
;

78 
	`__øw_wrôñ
(
˛k¶ow
, 
S3C2410_CLKSLOW
);

82 i‡(
íabÀ
 && (
‹ig
 & 
S3C2410_CLKSLOW_UCLK_OFF
))

83 
	`udñay
(200);

86 
	}
}

90 
˛k
 
	göô_˛ocks_dißbÀ
[] = {

92 .
«me
 = "nand",

93 .
	gid
 = -1,

94 .
	g∑ª¡
 = &
˛k_h
,

95 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

96 .
	g˘æbô
 = 
S3C2410_CLKCON_NAND
,

98 .
	g«me
 = "sdi",

99 .
	gid
 = -1,

100 .
	g∑ª¡
 = &
˛k_p
,

101 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

102 .
	g˘æbô
 = 
S3C2410_CLKCON_SDI
,

104 .
	g«me
 = "adc",

105 .
	gid
 = -1,

106 .
	g∑ª¡
 = &
˛k_p
,

107 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

108 .
	g˘æbô
 = 
S3C2410_CLKCON_ADC
,

110 .
	g«me
 = "i2c",

111 .
	gid
 = -1,

112 .
	g∑ª¡
 = &
˛k_p
,

113 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

114 .
	g˘æbô
 = 
S3C2410_CLKCON_IIC
,

116 .
	g«me
 = "iis",

117 .
	gid
 = -1,

118 .
	g∑ª¡
 = &
˛k_p
,

119 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

120 .
	g˘æbô
 = 
S3C2410_CLKCON_IIS
,

122 .
	g«me
 = "spi",

123 .
	gid
 = -1,

124 .
	g∑ª¡
 = &
˛k_p
,

125 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

126 .
	g˘æbô
 = 
S3C2410_CLKCON_SPI
,

130 
˛k
 
	göô_˛ocks
[] = {

132 .
«me
 = "lcd",

133 .
	gid
 = -1,

134 .
	g∑ª¡
 = &
˛k_h
,

135 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

136 .
	g˘æbô
 = 
S3C2410_CLKCON_LCDC
,

138 .
	g«me
 = "gpio",

139 .
	gid
 = -1,

140 .
	g∑ª¡
 = &
˛k_p
,

141 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

142 .
	g˘æbô
 = 
S3C2410_CLKCON_GPIO
,

144 .
	g«me
 = "usb-host",

145 .
	gid
 = -1,

146 .
	g∑ª¡
 = &
˛k_h
,

147 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

148 .
	g˘æbô
 = 
S3C2410_CLKCON_USBH
,

150 .
	g«me
 = "usb-device",

151 .
	gid
 = -1,

152 .
	g∑ª¡
 = &
˛k_h
,

153 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

154 .
	g˘æbô
 = 
S3C2410_CLKCON_USBD
,

156 .
	g«me
 = "timers",

157 .
	gid
 = -1,

158 .
	g∑ª¡
 = &
˛k_p
,

159 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

160 .
	g˘æbô
 = 
S3C2410_CLKCON_PWMT
,

162 .
	g«me
 = "uart",

163 .
	gid
 = 0,

164 .
	g∑ª¡
 = &
˛k_p
,

165 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

166 .
	g˘æbô
 = 
S3C2410_CLKCON_UART0
,

168 .
	g«me
 = "uart",

169 .
	gid
 = 1,

170 .
	g∑ª¡
 = &
˛k_p
,

171 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

172 .
	g˘æbô
 = 
S3C2410_CLKCON_UART1
,

174 .
	g«me
 = "uart",

175 .
	gid
 = 2,

176 .
	g∑ª¡
 = &
˛k_p
,

177 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

178 .
	g˘æbô
 = 
S3C2410_CLKCON_UART2
,

180 .
	g«me
 = "rtc",

181 .
	gid
 = -1,

182 .
	g∑ª¡
 = &
˛k_p
,

183 .
	gíabÀ
 = 
s3c2410_˛kc⁄_íabÀ
,

184 .
	g˘æbô
 = 
S3C2410_CLKCON_RTC
,

186 .
	g«me
 = "watchdog",

187 .
	gid
 = -1,

188 .
	g∑ª¡
 = &
˛k_p
,

189 .
	g˘æbô
 = 0,

191 .
	g«me
 = "usb-bus-host",

192 .
	gid
 = -1,

193 .
	g∑ª¡
 = &
˛k_usb_bus
,

195 .
	g«me
 = "usb-bus-gadget",

196 .
	gid
 = -1,

197 .
	g∑ª¡
 = &
˛k_usb_bus
,

211 
__öô
 
	$s3c2410_ba£˛k_add
()

213 
˛k¶ow
 = 
	`__øw_ªadl
(
S3C2410_CLKSLOW
);

214 
˛kc⁄
 = 
	`__øw_ªadl
(
S3C2410_CLKCON
);

215 
˛k
 *
˛kp
;

216 
˛k
 *
xèl
;

217 
ªt
;

218 
±r
;

220 
˛k_u∂l
.
íabÀ
 = 
s3c2410_u∂l_íabÀ
;

222 i‡(
	`s3c24xx_ªgi°î_˛ock
(&
˛k_usb_bus
) < 0)

223 
	`¥ötk
(
KERN_ERR
 "failedÅoÑegister usb bus clock\n");

227 
˛kp
 = 
öô_˛ocks
;

228 
±r
 = 0;Öå < 
	`ARRAY_SIZE
(
öô_˛ocks
);Öå++, 
˛kp
++) {

231 
˛kp
->
ußge
 = 
˛kc⁄
 & clkp->
˘æbô
 ? 1 : 0;

233 
ªt
 = 
	`s3c24xx_ªgi°î_˛ock
(
˛kp
);

234 i‡(
ªt
 < 0) {

235 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑegister clock %s (%d)\n",

236 
˛kp
->
«me
, 
ªt
);

252 
˛kp
 = 
öô_˛ocks_dißbÀ
;

253 
±r
 = 0;Öå < 
	`ARRAY_SIZE
(
öô_˛ocks_dißbÀ
);Öå++, 
˛kp
++) {

255 
ªt
 = 
	`s3c24xx_ªgi°î_˛ock
(
˛kp
);

256 i‡(
ªt
 < 0) {

257 
	`¥ötk
(
KERN_ERR
 "FailedÅoÑegister clock %s (%d)\n",

258 
˛kp
->
«me
, 
ªt
);

261 
	`s3c2410_˛kc⁄_íabÀ
(
˛kp
, 0);

266 
xèl
 = 
	`˛k_gë
(
NULL
, "xtal");

268 
	`¥ötk
("CLOCK: Slow mode (%ld.%ld MHz), %s, MPLL %s, UPLL %s\n",

269 
	`¥öt_mhz
(
	`˛k_gë_øã
(
xèl
) /

270 –2 * 
	`S3C2410_CLKSLOW_GET_SLOWVAL
(
˛k¶ow
))),

271 (
˛k¶ow
 & 
S3C2410_CLKSLOW_SLOW
) ? "slow" : "fast",

272 (
˛k¶ow
 & 
S3C2410_CLKSLOW_MPLL_OFF
) ? "off" : "on",

273 (
˛k¶ow
 & 
S3C2410_CLKSLOW_UCLK_OFF
) ? "off" : "on");

276 
	}
}

	@arch/arm/mach-s3c2410/dma.c

15 
	~<löux/kî√l.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/sysdev.h
>

18 
	~<löux/£rül_c‹e.h
>

20 
	~<asm/dma.h
>

21 
	~<asm/¨ch/dma.h
>

23 
	~<asm/∂©-s3c24xx/˝u.h
>

24 
	~<asm/∂©-s3c24xx/dma.h
>

26 
	~<asm/¨ch/ªgs-£rül.h
>

27 
	~<asm/¨ch/ªgs-gpio.h
>

28 
	~<asm/¨ch/ªgs-ac97.h
>

29 
	~<asm/¨ch/ªgs-mem.h
>

30 
	~<asm/¨ch/ªgs-lcd.h
>

31 
	~<asm/¨ch/ªgs-sdi.h
>

32 
	~<asm/¨ch/ªgs-iis.h
>

33 
	~<asm/¨ch/ªgs-•i.h
>

35 
s3c24xx_dma_m≠
 
__öôd©a
 
	gs3c2410_dma_m≠pögs
[] = {

36 [
DMACH_XD0
] = {

37 .
«me
 = "xdreq0",

38 .
	gch™√ls
[0] = 
S3C2410_DCON_CH0_XDREQ0
 | 
DMA_CH_VALID
,

40 [
DMACH_XD1
] = {

41 .
«me
 = "xdreq1",

42 .
	gch™√ls
[1] = 
S3C2410_DCON_CH1_XDREQ1
 | 
DMA_CH_VALID
,

44 [
DMACH_SDI
] = {

45 .
«me
 = "sdi",

46 .
	gch™√ls
[0] = 
S3C2410_DCON_CH0_SDI
 | 
DMA_CH_VALID
,

47 .
	gch™√ls
[2] = 
S3C2410_DCON_CH2_SDI
 | 
DMA_CH_VALID
,

48 .
	gch™√ls
[3] = 
S3C2410_DCON_CH3_SDI
 | 
DMA_CH_VALID
,

49 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_IIS
 + 
S3C2410_IISFIFO
,

50 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_IIS
 + 
S3C2410_IISFIFO
,

52 [
DMACH_SPI0
] = {

53 .
«me
 = "spi0",

54 .
	gch™√ls
[1] = 
S3C2410_DCON_CH1_SPI
 | 
DMA_CH_VALID
,

55 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_SPI
 + 
S3C2410_SPTDAT
,

56 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_SPI
 + 
S3C2410_SPRDAT
,

58 [
DMACH_SPI1
] = {

59 .
«me
 = "spi1",

60 .
	gch™√ls
[3] = 
S3C2410_DCON_CH3_SPI
 | 
DMA_CH_VALID
,

61 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_SPI
 + 0x20 + 
S3C2410_SPTDAT
,

62 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_SPI
 + 0x20 + 
S3C2410_SPRDAT
,

64 [
DMACH_UART0
] = {

65 .
«me
 = "uart0",

66 .
	gch™√ls
[0] = 
S3C2410_DCON_CH0_UART0
 | 
DMA_CH_VALID
,

67 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_UART0
 + 
S3C2410_UTXH
,

68 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_UART0
 + 
S3C2410_URXH
,

70 [
DMACH_UART1
] = {

71 .
«me
 = "uart1",

72 .
	gch™√ls
[1] = 
S3C2410_DCON_CH1_UART1
 | 
DMA_CH_VALID
,

73 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_UART1
 + 
S3C2410_UTXH
,

74 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_UART1
 + 
S3C2410_URXH
,

76 [
DMACH_UART2
] = {

77 .
«me
 = "uart2",

78 .
	gch™√ls
[3] = 
S3C2410_DCON_CH3_UART2
 | 
DMA_CH_VALID
,

79 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_UART2
 + 
S3C2410_UTXH
,

80 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_UART2
 + 
S3C2410_URXH
,

82 [
DMACH_TIMER
] = {

83 .
«me
 = "timer",

84 .
	gch™√ls
[0] = 
S3C2410_DCON_CH0_TIMER
 | 
DMA_CH_VALID
,

85 .
	gch™√ls
[2] = 
S3C2410_DCON_CH2_TIMER
 | 
DMA_CH_VALID
,

86 .
	gch™√ls
[3] = 
S3C2410_DCON_CH3_TIMER
 | 
DMA_CH_VALID
,

88 [
DMACH_I2S_IN
] = {

89 .
«me
 = "i2s-sdi",

90 .
	gch™√ls
[1] = 
S3C2410_DCON_CH1_I2SSDI
 | 
DMA_CH_VALID
,

91 .
	gch™√ls
[2] = 
S3C2410_DCON_CH2_I2SSDI
 | 
DMA_CH_VALID
,

92 .
	ghw_addr
.
	g‰om
 = 
S3C2410_PA_IIS
 + 
S3C2410_IISFIFO
,

94 [
DMACH_I2S_OUT
] = {

95 .
«me
 = "i2s-sdo",

96 .
	gch™√ls
[2] = 
S3C2410_DCON_CH2_I2SSDO
 | 
DMA_CH_VALID
,

97 .
	ghw_addr
.
	gto
 = 
S3C2410_PA_IIS
 + 
S3C2410_IISFIFO
,

99 [
DMACH_USB_EP1
] = {

100 .
«me
 = "usb-ep1",

101 .
	gch™√ls
[0] = 
S3C2410_DCON_CH0_USBEP1
 | 
DMA_CH_VALID
,

103 [
DMACH_USB_EP2
] = {

104 .
«me
 = "usb-ep2",

105 .
	gch™√ls
[1] = 
S3C2410_DCON_CH1_USBEP2
 | 
DMA_CH_VALID
,

107 [
DMACH_USB_EP3
] = {

108 .
«me
 = "usb-ep3",

109 .
	gch™√ls
[2] = 
S3C2410_DCON_CH2_USBEP3
 | 
DMA_CH_VALID
,

111 [
DMACH_USB_EP4
] = {

112 .
«me
 = "usb-ep4",

113 .
	gch™√ls
[3] =
S3C2410_DCON_CH3_USBEP4
 | 
DMA_CH_VALID
,

117 
	$s3c2410_dma_£À˘
(
s3c2410_dma_ch™
 *
ch™
,

118 
s3c24xx_dma_m≠
 *
m≠
)

120 
ch™
->
dc⁄
 = 
m≠
->
ch™√ls
[ch™->
numbî
] & ~
DMA_CH_VALID
;

121 
	}
}

123 
s3c24xx_dma_£À˘i⁄
 
__öôd©a
 
	gs3c2410_dma_£l
 = {

124 .
£À˘
 = 
s3c2410_dma_£À˘
,

125 .
	gdc⁄_mask
 = 7 << 24,

126 .
	gm≠
 = 
s3c2410_dma_m≠pögs
,

127 .
	gm≠_size
 = 
ARRAY_SIZE
(
s3c2410_dma_m≠pögs
),

130 
s3c24xx_dma_‹dî
 
__öôd©a
 
	gs3c2410_dma_‹dî
 = {

131 .
ch™√ls
 = {

132 [
DMACH_SDI
] = {

133 .
li°
 = {

134 [0] = 3 | 
DMA_CH_VALID
,

135 [1] = 2 | 
DMA_CH_VALID
,

136 [2] = 0 | 
DMA_CH_VALID
,

139 [
DMACH_I2S_IN
] = {

140 .
li°
 = {

141 [0] = 1 | 
DMA_CH_VALID
,

142 [1] = 2 | 
DMA_CH_VALID
,

148 
	$s3c2410_dma_add
(
sys_devi˚
 *
sysdev
)

150 
	`s3c2410_dma_öô
();

151 
	`s3c24xx_dma_‹dî_£t
(&
s3c2410_dma_‹dî
);

152  
	`s3c24xx_dma_öô_m≠
(&
s3c2410_dma_£l
);

153 
	}
}

155 #i‡
deföed
(
CONFIG_CPU_S3C2410
)

156 
sysdev_drivî
 
	gs3c2410_dma_drivî
 = {

157 .
add
 = 
s3c2410_dma_add
,

160 
__öô
 
	$s3c2410_dma_drvöô
()

162  
	`sysdev_drivî_ªgi°î
(&
s3c2410_sys˛ass
, &
s3c2410_dma_drivî
);

163 
	}
}

165 
¨ch_öôˇŒ
(
s3c2410_dma_drvöô
);

168 #i‡
deföed
(
CONFIG_CPU_S3C2442
)

170 
sysdev_drivî
 
	gs3c2442_dma_drivî
 = {

171 .
add
 = 
s3c2410_dma_add
,

174 
__öô
 
	$s3c2442_dma_drvöô
()

176  
	`sysdev_drivî_ªgi°î
(&
s3c2442_sys˛ass
, &
s3c2442_dma_drivî
);

177 
	}
}

179 
¨ch_öôˇŒ
(
s3c2442_dma_drvöô
);

	@arch/arm/mach-s3c2410/gpio.c

23 
	~<löux/kî√l.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/öãºu±.h
>

27 
	~<löux/i›‹t.h
>

29 
	~<asm/h¨dw¨e.h
>

30 
	~<asm/úq.h
>

31 
	~<asm/io.h
>

33 
	~<asm/¨ch/ªgs-gpio.h
>

35 
	$s3c2410_gpio_úqfûãr
(
pö
, 
⁄
,

36 
c⁄fig
)

38 
__iomem
 *
ªg
 = 
S3C24XX_EINFLT0
;

39 
Êags
;

40 
vÆ
;

42 i‡(
pö
 < 
S3C2410_GPG8
 ||Öö > 
S3C2410_GPG15
)

45 
c⁄fig
 &= 0xff;

47 
pö
 -
S3C2410_GPG8
;

48 
ªg
 +
pö
 & ~3;

50 
	`loˇl_úq_ßve
(
Êags
);

54 
vÆ
 = 
	`__øw_ªadl
(
ªg
);

55 
vÆ
 &~(0xf‡<< ((
pö
 & 3) * 8));

56 
vÆ
 |
c⁄fig
 << ((
pö
 & 3) * 8);

57 
	`__øw_wrôñ
(
vÆ
, 
ªg
);

61 
vÆ
 = 
	`__øw_ªadl
(
S3C24XX_EXTINT2
);

62 
vÆ
 &~(1 << ((
pö
 * 4) + 3));

63 
vÆ
 |
⁄
 << ((
pö
 * 4) + 3);

64 
	`__øw_wrôñ
(
vÆ
, 
S3C24XX_EXTINT2
);

66 
	`loˇl_úq_ª°‹e
(
Êags
);

69 
	}
}

71 
EXPORT_SYMBOL
(
s3c2410_gpio_úqfûãr
);

	@arch/arm/mach-s3c2410/h1940-bluetooth.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/∂©f‹m_devi˚.h
>

15 
	~<löux/dñay.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/˘y≥.h
>

18 
	~<löux/Àds.h
>

19 
	~<asm/¨ch/ªgs-gpio.h
>

20 
	~<asm/h¨dw¨e.h
>

21 
	~<asm/¨ch/h1940-œtch.h
>

23 
	#DRV_NAME
 "h1940-bt"

	)

25 #ifde‡
CONFIG_LEDS_H1940


26 
DEFINE_LED_TRIGGER
(
bt_Àd_åiggî
);

29 
	g°©e
;

32 
	$h1940bt_íabÀ
(
⁄
)

34 i‡(
⁄
) {

35 #ifde‡
CONFIG_LEDS_H1940


37 
	`Àd_åiggî_evít
(
bt_Àd_åiggî
, 
LED_HALF
);

41 
	`h1940_œtch_c⁄åﬁ
(0, 
H1940_LATCH_BLUETOOTH_POWER
);

43 
	`mdñay
(10);

44 
	`s3c2410_gpio_£çö
(
S3C2410_GPH1
, 1);

45 
	`mdñay
(10);

46 
	`s3c2410_gpio_£çö
(
S3C2410_GPH1
, 0);

48 
°©e
 = 1;

51 #ifde‡
CONFIG_LEDS_H1940


52 
	`Àd_åiggî_evít
(
bt_Àd_åiggî
, 0);

55 
	`s3c2410_gpio_£çö
(
S3C2410_GPH1
, 1);

56 
	`mdñay
(10);

57 
	`s3c2410_gpio_£çö
(
S3C2410_GPH1
, 0);

58 
	`mdñay
(10);

59 
	`h1940_œtch_c⁄åﬁ
(
H1940_LATCH_BLUETOOTH_POWER
, 0);

61 
°©e
 = 0;

63 
	}
}

65 
ssize_t
 
	$h1940bt_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, *
buf
)

67  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n", 
°©e
);

68 
	}
}

70 
ssize_t
 
	$h1940bt_°‹e
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
, 
size_t
 
cou¡
)

72 
√w_°©e
;

73 *
ídp
;

75 
√w_°©e
 = 
	`sim∂e_°πoul
(
buf
, &
ídp
, 0);

76 i‡(*
ídp
 && !
	`is•a˚
(*endp))

77  -
EINVAL
;

79 
	`h1940bt_íabÀ
(
√w_°©e
);

81  
cou¡
;

82 
	}
}

83 
DEVICE_ATTR
(
íabÀ
, 0644,

84 
h1940bt_show
,

85 
h1940bt_°‹e
);

87 
__öô
 
	$h1940bt_¥obe
(
∂©f‹m_devi˚
 *
pdev
)

90 
	`s3c2410_gpio_cfgpö
(
S3C2410_GPH0
, 
S3C2410_GPH0_nCTS0
);

91 
	`s3c2410_gpio_puŒup
(
S3C2410_GPH0
, 1);

92 
	`s3c2410_gpio_cfgpö
(
S3C2410_GPH1
, 
S3C2410_GPH1_OUTP
);

93 
	`s3c2410_gpio_puŒup
(
S3C2410_GPH1
, 1);

94 
	`s3c2410_gpio_cfgpö
(
S3C2410_GPH2
, 
S3C2410_GPH2_TXD0
);

95 
	`s3c2410_gpio_puŒup
(
S3C2410_GPH2
, 1);

96 
	`s3c2410_gpio_cfgpö
(
S3C2410_GPH3
, 
S3C2410_GPH3_RXD0
);

97 
	`s3c2410_gpio_puŒup
(
S3C2410_GPH3
, 1);

99 #ifde‡
CONFIG_LEDS_H1940


100 
	`Àd_åiggî_ªgi°î_sim∂e
("h1940-bluëoŸh", &
bt_Àd_åiggî
);

104 
	`h1940bt_íabÀ
(0);

106  
	`devi˚_¸óã_fûe
(&
pdev
->
dev
, &
dev_©å_íabÀ
);

107 
	}
}

109 
	$h1940bt_ªmove
(
∂©f‹m_devi˚
 *
pdev
)

111 #ifde‡
CONFIG_LEDS_H1940


112 
	`Àd_åiggî_uƒegi°î_sim∂e
(
bt_Àd_åiggî
);

115 
	}
}

118 
∂©f‹m_drivî
 
	gh1940bt_drivî
 = {

119 .
drivî
 = {

120 .
«me
 = 
DRV_NAME
,

122 .
	g¥obe
 = 
h1940bt_¥obe
,

123 .
	gªmove
 = 
h1940bt_ªmove
,

127 
__öô
 
	$h1940bt_öô
()

129  
	`∂©f‹m_drivî_ªgi°î
(&
h1940bt_dr